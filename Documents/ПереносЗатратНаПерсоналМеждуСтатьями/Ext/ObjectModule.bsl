
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Подсистема "Управление доступом".

// Процедура ЗаполнитьНаборыЗначенийДоступа по свойствам объекта заполняет наборы значений доступа
// в таблице с полями:
//    НомерНабора     - Число                                     (необязательно, если набор один),
//    ВидДоступа      - ПланВидовХарактеристикСсылка.ВидыДоступа, (обязательно),
//    ЗначениеДоступа - Неопределено, СправочникСсылка или др.    (обязательно),
//    Чтение          - Булево (необязательно, если набор для всех прав) устанавливается для одной строки набора,
//    Добавление      - Булево (необязательно, если набор для всех прав) устанавливается для одной строки набора,
//    Изменение       - Булево (необязательно, если набор для всех прав) устанавливается для одной строки набора,
//    Удаление        - Булево (необязательно, если набор для всех прав) устанавливается для одной строки набора,
//
//  Вызывается из процедуры УправлениеДоступомСлужебный.ЗаписатьНаборыЗначенийДоступа(),
// если объект зарегистрирован в "ПодпискаНаСобытие.ЗаписатьНаборыЗначенийДоступа" и
// из таких же процедур объектов, у которых наборы значений доступа зависят от наборов этого
// объекта (в этом случае объект зарегистрирован в "ПодпискаНаСобытие.ЗаписатьЗависимыеНаборыЗначенийДоступа").
//
// Параметры:
//  Таблица      - ТабличнаяЧасть,
//                 РегистрСведенийНаборЗаписей.НаборыЗначенийДоступа,
//                 ТаблицаЗначений, возвращаемая УправлениеДоступом.ТаблицаНаборыЗначенийДоступа().
//
Процедура ЗаполнитьНаборыЗначенийДоступа(Таблица) Экспорт
	
	ЗарплатаКадры.ЗаполнитьНаборыПоОрганизацииИФизическимЛицам(ЭтотОбъект, Таблица, "Организация", "ФизическиеЛица.ФизическоеЛицо");
	
КонецПроцедуры

// Подсистема "Управление доступом".

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	Отказ = Отказ ИЛИ НЕ МожноЗаполнитьЗатраты();
	
	ОбщегоНазначенияКлиентСервер.УдалитьЗначениеИзМассива(ПроверяемыеРеквизиты, "Организация");
	ОбщегоНазначенияКлиентСервер.УдалитьЗначениеИзМассива(ПроверяемыеРеквизиты, "ПериодРегистрации");
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	ПроведениеСервер.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	ДанныеДляПроведения = ДанныеДляПроведения();
	
	УчетНачисленнойЗарплаты.ЗарегистрироватьНачисленияУдержания(ЭтотОбъект.Движения, Отказ, Организация, ПериодРегистрации,
			ДанныеДляПроведения.НачисленияСотрудников, ДанныеДляПроведения.УдержанияПоСотрудникам, Неопределено, Неопределено, Перечисления.ХарактерВыплатыЗарплаты.Зарплата);
			
	Если ДанныеДляПроведения.НДФЛ <> Неопределено И ДанныеДляПроведения.НДФЛ.Количество() > 0 Тогда
		УчетНачисленнойЗарплаты.ЗарегистрироватьНДФЛ(Движения, Отказ, Организация, ПериодРегистрации,
									ДанныеДляПроведения.НДФЛ, Неопределено, Перечисления.ХарактерВыплатыЗарплаты.Зарплата);
	КонецЕсли;

	ОтражениеЗарплатыВБухучетеРасширенный.СформироватьДвиженияБухучетНачисленияУдержанияПоСотрудникам(
						Движения, Отказ, Организация, ПериодРегистрации,
						ДанныеДляПроведения.НачисленияСотрудников, ДанныеДляПроведения.УдержанияПоСотрудникам, ДанныеДляПроведения.НДФЛ,Ложь);
						
												
	Если ДанныеДляПроведения.СтраховыеВзносыПоФизическимЛицам <> Неопределено И ДанныеДляПроведения.СтраховыеВзносыПоФизическимЛицам.Количество() > 0 Тогда
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ДанныеДляПроведения.СтраховыеВзносыПоФизическимЛицам, Движения.СтраховыеВзносыПоФизическимЛицам);
		Движения.СтраховыеВзносыПоФизическимЛицам.Записывать = Истина;
	КонецЕсли;
	
	Если ДанныеДляПроведения.СведенияОДоходахНДФЛ <> Неопределено И ДанныеДляПроведения.СведенияОДоходахНДФЛ.Количество() > 0 Тогда
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ДанныеДляПроведения.СведенияОДоходахНДФЛ, Движения.СведенияОДоходахНДФЛ);
		Движения.СведенияОДоходахНДФЛ.Записывать = Истина;
	КонецЕсли;
	
	Если ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий <> Неопределено И ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий.Количество() > 0 Тогда
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий, Движения.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаОбщий);
		Движения.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаОбщий.Записывать = Истина;
	КонецЕсли;
	
	Если ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС <> Неопределено И ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС.Количество() > 0 Тогда
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС, Движения.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаФСС);
		Движения.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаФСС.Записывать = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

// Заполнение документа

Функция МожноЗаполнитьЗатраты() Экспорт
	
	ПравилаПроверки = Новый Структура;
	
	ПравилаПроверки.Вставить("Организация",			НСтр("ru='Не выбрана организация'"));
	ПравилаПроверки.Вставить("ПериодРегистрации",	НСтр("ru='Не указан месяц начисления'"));
	
	МожноЗаполнитьЗатраты = 
		ЗарплатаКадрыКлиентСервер.СвойстваЗаполнены(ЭтотОбъект, ПравилаПроверки, Истина);
		
	Возврат МожноЗаполнитьЗатраты 
	
КонецФункции

Процедура ЗаполнитьЗатраты() Экспорт
	
	Сотрудники			= СотрудникиПоШапкеДокумента();
	ЗатратыНаСотрудников= ЗатратыНаСотрудников(Сотрудники);
	
	Затраты.Очистить();
	Переносы.Очистить();
	ПоместитьЗатратыНаСотрудниковВТЧ(ЗатратыНаСотрудников);

КонецПроцедуры	

Функция СотрудникиПоШапкеДокумента()
	
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ОтложенноеПроведениеДокументов") Тогда 
		Модуль = ОбщегоНазначения.ОбщийМодуль("ОтражениеДокументовВУчетеСтраховыхВзносов");
		Модуль.ОтразитьДокументыВУчетеСтраховыхВзносов(Организация);
	КонецЕсли;
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;

	// Получаем всех работавших в организации в периоде регистрации.
	ПараметрыПолученияСотрудниковОрганизаций = КадровыйУчет.ПараметрыПолученияСотрудниковОрганизацийПоСпискуФизическихЛиц();
	ПараметрыПолученияСотрудниковОрганизаций.Организация 					= Организация;
	ПараметрыПолученияСотрудниковОрганизаций.ОтбиратьПоГоловнойОрганизации 	= Ложь;
	ПараметрыПолученияСотрудниковОрганизаций.Подразделение 					= Подразделение;
	ПараметрыПолученияСотрудниковОрганизаций.НачалоПериода 		=  НачалоМесяца(ПериодРегистрации);
	ПараметрыПолученияСотрудниковОрганизаций.ОкончаниеПериода	=  КонецМесяца(ПериодРегистрации);
	ПараметрыПолученияСотрудниковОрганизаций.РаботникиПоТрудовымДоговорам = Истина;
	ПараметрыПолученияСотрудниковОрганизаций.РаботникиПоДоговорамГПХ = Неопределено;
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПодработки") Тогда
		ПараметрыПолученияСотрудниковОрганизаций.ПодработкиРаботниковПоТрудовымДоговорам = Истина;
	КонецЕсли;	
	КадровыйУчетРасширенный.ПрименитьОтборПоФункциональнойОпцииВыполнятьРасчетЗарплатыПоПодразделениям(ПараметрыПолученияСотрудниковОрганизаций);
	
	КадровыйУчет.СоздатьВТСотрудникиОрганизации(
		МенеджерВременныхТаблиц, Истина, 
		ПараметрыПолученияСотрудниковОрганизаций, 
		"ВТСотрудникиПоМестуРаботы");
		
	// Отбираем сотрудников, у которых в бухучете встречается заданная статья финансирования	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	БухучетНачисленияУдержания.Сотрудник КАК Сотрудник
	|ИЗ
	|	РегистрНакопления.БухучетНачисленияУдержанияПоСотрудникам КАК БухучетНачисленияУдержания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСотрудникиПоМестуРаботы КАК СотрудникиПоМестуРаботы
	|		ПО БухучетНачисленияУдержания.Сотрудник = СотрудникиПоМестуРаботы.Сотрудник
	|ГДЕ
	|	БухучетНачисленияУдержания.Период = &ПериодРегистрации
	|	И &ОтборПоСтатьеФинансирования
	|	И БухучетНачисленияУдержания.ГруппаНачисленияУдержанияВыплаты = ЗНАЧЕНИЕ(Перечисление.ГруппыНачисленияУдержанияВыплаты.Начислено)
	|	И НЕ БухучетНачисленияУдержания.НеУчитыватьВРаспределенииПриОкончательномРасчете
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	СтраховыеВзносы.Сотрудник
	|ИЗ
	|	РегистрНакопления.СтраховыеВзносыПоФизическимЛицам КАК СтраховыеВзносы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСотрудникиПоМестуРаботы КАК СотрудникиПоМестуРаботы
	|		ПО СтраховыеВзносы.Сотрудник = СотрудникиПоМестуРаботы.Сотрудник
	|ГДЕ
	|	СтраховыеВзносы.Период = &ПериодРегистрации
	|	И &ОтборПоСтатьеФинансирования";
	Если ЗначениеЗаполнено(СтатьяФинансирования) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоСтатьеФинансирования", "СтатьяФинансирования = &СтатьяФинансирования");
		Запрос.УстановитьПараметр("СтатьяФинансирования", СтатьяФинансирования);
	Иначе		
		Запрос.УстановитьПараметр("ОтборПоСтатьеФинансирования", Истина);
	КонецЕсли;	
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Сотрудник");
	
КонецФункции	

Функция ЗатратыНаСотрудников(Сотрудники)
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	ЗарегистрированныеДанныеПоСотрудникам(МенеджерВременныхТаблиц, Сотрудники);
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Затраты.Сотрудник КАК Сотрудник,
	|	Затраты.Подразделение КАК Подразделение,
	|	Затраты.Начисление КАК Начисление,
	|	Затраты.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|	Затраты.СтатьяРасходов КАК СтатьяРасходов,
	|	Затраты.СтатьяФинансирования КАК СтатьяФинансирования,
	|	СУММА(0) КАК СтраховыеВзносы,
	|	СУММА(Затраты.Зарплата) КАК Зарплата
	|ИЗ
	|	(ВЫБРАТЬ
	|		Начисления.Сотрудник КАК Сотрудник,
	|		Начисления.Подразделение КАК Подразделение,
	|		Начисления.Начисление КАК Начисление,
	|		Начисления.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|		Начисления.СтатьяРасходов КАК СтатьяРасходов,
	|		Начисления.СтатьяФинансирования КАК СтатьяФинансирования,
	|		Начисления.Сумма КАК Зарплата,
	|		&НулевыеСуммы КАК СуммыИзРегистра
	|	ИЗ
	|		ВТНачисления КАК Начисления
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		СтраховыеВзносы.Сотрудник,
	|		СтраховыеВзносы.Подразделение,
	|		СтраховыеВзносы.Начисление,
	|		СтраховыеВзносы.СпособОтраженияЗарплатыВБухучете,
	|		СтраховыеВзносы.СтатьяРасходов,
	|		СтраховыеВзносы.СтатьяФинансирования,
	|		0,
	|		&СуммыИзРегистра
	|	ИЗ
	|		ВТВзносы КАК СтраховыеВзносы) КАК Затраты
	|
	|СГРУППИРОВАТЬ ПО
	|	Затраты.СтатьяФинансирования,
	|	Затраты.СтатьяРасходов,
	|	Затраты.СпособОтраженияЗарплатыВБухучете,
	|	Затраты.Подразделение,
	|	Затраты.Сотрудник,
	|	Затраты.Начисление
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Затраты.Зарплата) <> 0
	|		ИЛИ &Условие)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Сотрудник,
	|	Подразделение,
	|	СтатьяФинансирования,
	|	Начисление,
	|	СпособОтраженияЗарплатыВБухучете,
	|	СтатьяРасходов";
	
	НулевыеСуммы = СтрЗаменить(УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина, "0 КАК "), ".", "");
	СуммыИзРегистра = УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина, "СтраховыеВзносы");
	ТекстПолейВзносов = "";
	Для каждого ИмяПоля Из СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина)) Цикл
		ТекстПолейВзносов = ТекстПолейВзносов + "СУММА(Затраты." + ИмяПоля + ") КАК " + ИмяПоля + "," + Символы.ПС;
	КонецЦикла;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&НулевыеСуммы КАК СуммыИзРегистра", НулевыеСуммы);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&СуммыИзРегистра", СуммыИзРегистра);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "СУММА(0) КАК СтраховыеВзносы,", ТекстПолейВзносов);
	Условие = СтрЗаменить(УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина, "СУММА(Затраты"), ",", ") <> 0 ИЛИ ") + ") <> 0";
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Условие", Условие);
	Возврат Запрос.Выполнить();
	
КонецФункции	

Процедура ПоместитьЗатратыНаСотрудниковВТЧ(ЗатратыНаСотрудников)
	
	Выборка = ЗатратыНаСотрудников.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		СтрокаЗатрат = Затраты.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаЗатрат, Выборка);
		СтрокаЗатрат.ИдентификаторСтрокиЗатрат = Новый УникальныйИдентификатор;
		
		СтрокаЗатрат.Сумма = 0;
		Для Каждого РеквизитДетализацииЗатрат Из Документы.ПереносЗатратНаПерсоналМеждуСтатьями.РеквизитыДетализацииЗатрат() Цикл
			СтрокаЗатрат.Сумма = СтрокаЗатрат.Сумма + СтрокаЗатрат[РеквизитДетализацииЗатрат]
		КонецЦикла;	
		
	КонецЦикла	
	
КонецПроцедуры	

Процедура ДополнитьЗатраты(Сотрудники) Экспорт
	
	ЗатратыНаСотрудников= ЗатратыНаСотрудников(Сотрудники);
	ПоместитьЗатратыНаСотрудниковВТЧ(ЗатратыНаСотрудников);
	
КонецПроцедуры	

// Перенос затрат

Процедура ПеренестиЗатраты(ПереносимыеСтроки, Финансирование, Сумма) Экспорт
	
	СуммаПоложительная = (Сумма>0);
	
	ОстатокСуммы = Сумма;
	Для Каждого ПереносимаяСтрока Из ПереносимыеСтроки Цикл
		
		ПеренесеннаяСумма = 0;
		
		СтрокаЗатрат = Затраты.Найти(ПереносимаяСтрока, "ИдентификаторСтрокиЗатрат");
		Если СтрокаЗатрат <> Неопределено Тогда
			// это строка затрат
			ПеренесеннаяСумма = ПеренестиЗатратыСтрокиЗатрат(СтрокаЗатрат, Финансирование, ОстатокСуммы);
		КонецЕсли;	
		
		СтрокаПереноса = Переносы.Найти(ПереносимаяСтрока, "ИдентификаторСтрокиПереноса");
		Если СтрокаПереноса <> Неопределено Тогда
			// это строка переноса
			ПеренесеннаяСумма = ПеренестиЗатратыСтрокиПереноса(СтрокаПереноса, Финансирование, ОстатокСуммы);
		КонецЕсли;
		
		ОстатокСуммы = ОстатокСуммы - ПеренесеннаяСумма;
		Если ОстатокСуммы = 0 Тогда
			Прервать;
		КонецЕсли;	
		
	КонецЦикла;
	
	// образовавшиеся пустые переносы удаляем
	Для Каждого ПустаяСтрока Из Переносы.НайтиСтроки(Новый Структура("Сумма", 0)) Цикл
		Переносы.Удалить(ПустаяСтрока);
	КонецЦикла;
	
КонецПроцедуры	

Функция ПеренестиЗатратыСтрокиЗатрат(СтрокаЗатрат, Финансирование, Сумма)
	
	СуммаПоложительная = (Сумма>0);
	
	ПараметрыОтбораПереносов = Новый Структура;
	ПараметрыОтбораПереносов.Вставить("ИдентификаторСтрокиЗатрат", СтрокаЗатрат.ИдентификаторСтрокиЗатрат);
	ПараметрыОтбораПереносов.Вставить("СтатьяФинансирования", Финансирование.СтатьяФинансирования);
	
	ПереносыСтрокиЗатратПоСтатьеФинансирования = Переносы.НайтиСтроки(ПараметрыОтбораПереносов);
	
	Если СтрокаЗатрат.СтатьяФинансирования = Финансирование.СтатьяФинансирования Тогда
		// возврат затрат на исходную статью
		// ищем перенос этой затраты по указанной статье и уменьшаем его сумму
		Если ПереносыСтрокиЗатратПоСтатьеФинансирования.Количество() = 0 Тогда
			Возврат 0; // переносов строки затрат на указанную статью не было, "возвращать" на затраты нечего
		КонецЕсли;	
		СтрокаПереноса = ПереносыСтрокиЗатратПоСтатьеФинансирования[0];
		Если СуммаПоложительная Тогда
			ПереносимаяСумма = Мин(СтрокаЗатрат.Сумма, СтрокаПереноса.Сумма, Сумма);
		Иначе
			ПереносимаяСумма = Макс(СтрокаЗатрат.Сумма, СтрокаПереноса.Сумма, Сумма);
		КонецЕсли;
		СтрокаПереноса.Сумма = СтрокаПереноса.Сумма - ПереносимаяСумма;
	Иначе
		// перенос затрат на другую статью
		// создаем перенос этой затраты по указанной статье на заданную сумму
		Если ПереносыСтрокиЗатратПоСтатьеФинансирования.Количество() = 0 Тогда
			СтрокаПереноса = Переносы.Добавить();
			СтрокаПереноса.ИдентификаторСтрокиПереноса = Новый УникальныйИдентификатор;
			ЗаполнитьЗначенияСвойств(СтрокаПереноса, ПараметрыОтбораПереносов);
			ЗаполнитьЗначенияСвойств(СтрокаПереноса, СтрокаЗатрат, СтрСоединить(Документы.ПереносЗатратНаПерсоналМеждуСтатьями.РеквизитыФинансированияЗатрат(), ", "));
			ЗаполнитьЗначенияСвойств(СтрокаПереноса, Финансирование);
		Иначе	
			СтрокаПереноса = ПереносыСтрокиЗатратПоСтатьеФинансирования[0];
		КонецЕсли;
		Если СуммаПоложительная Тогда
			ПереносимаяСумма = Мин(СтрокаЗатрат.Сумма, Сумма);
		Иначе
			ПереносимаяСумма = Макс(СтрокаЗатрат.Сумма, Сумма);
		КонецЕсли;
		СтрокаПереноса.Сумма = СтрокаПереноса.Сумма + ПереносимаяСумма;
	КонецЕсли;	
	
	Возврат ПереносимаяСумма
	
КонецФункции

Функция ПеренестиЗатратыСтрокиПереноса(СтрокаПереноса, Финансирование, Сумма)
	
	СуммаПоложительная = (Сумма>0);
	
	СтрокаЗатрат = Затраты.Найти(СтрокаПереноса.ИдентификаторСтрокиЗатрат, "ИдентификаторСтрокиЗатрат");
	
	Если СтрокаПереноса.СтатьяФинансирования = Финансирование.СтатьяФинансирования Тогда
		// перенос на ту же самую статью - ничего делать не надо
		Возврат 0;
	ИначеЕсли СтрокаЗатрат.СтатьяФинансирования = Финансирование.СтатьяФинансирования Тогда
		// возврат затрат на исходную статью
		// уменьшаем сумму текущего переноса
		Если СуммаПоложительная Тогда
			ПереносимаяСумма = Мин(СтрокаЗатрат.Сумма, СтрокаПереноса.Сумма, Сумма);
		Иначе
			ПереносимаяСумма = Макс(СтрокаЗатрат.Сумма, СтрокаПереноса.Сумма, Сумма);
		КонецЕсли;
		СтрокаПереноса.Сумма = СтрокаПереноса.Сумма - ПереносимаяСумма;
	Иначе
		// перенос затрат на другую статью
		// создаем перенос этой затраты по указанной статье на заданную сумму
		// уменьшаем сумму текущего переноса
		
		ПараметрыОтбораПереносов = Новый Структура;
		ПараметрыОтбораПереносов.Вставить("ИдентификаторСтрокиЗатрат", СтрокаЗатрат.ИдентификаторСтрокиЗатрат);
		ПараметрыОтбораПереносов.Вставить("СтатьяФинансирования", Финансирование.СтатьяФинансирования);
	
		ПереносыСтрокиЗатратПоСтатье = Переносы.НайтиСтроки(ПараметрыОтбораПереносов);
		
		Если ПереносыСтрокиЗатратПоСтатье.Количество() = 0 Тогда
			СтрокаПереносаПоСтатье = Переносы.Добавить();
			СтрокаПереноса.ИдентификаторСтрокиПереноса = Новый УникальныйИдентификатор;
			ЗаполнитьЗначенияСвойств(СтрокаПереноса, Финансирование);
			ЗаполнитьЗначенияСвойств(СтрокаПереноса, ПараметрыОтбораПереносов);
		Иначе	
			СтрокаПереносаПоСтатье = ПереносыСтрокиЗатратПоСтатье[0];
		КонецЕсли;	
		
		Если СуммаПоложительная Тогда
			ПереносимаяСумма = Мин(СтрокаПереноса.Сумма, Сумма);
		Иначе
			ПереносимаяСумма = Макс(СтрокаПереноса.Сумма, Сумма);
		КонецЕсли;
		СтрокаПереноса.Сумма = СтрокаПереноса.Сумма - ПереносимаяСумма;
		СтрокаПереносаПоСтатье.Сумма = СтрокаПереноса.Сумма + ПереносимаяСумма;
	КонецЕсли;	
	
	Возврат ПереносимаяСумма
	
КонецФункции

// Проведение

Функция ДанныеДляПроведения()

	ДанныеДляПроведения = Новый Структура("
	|НачисленияСотрудников,
	|СтраховыеВзносыПоФизическимЛицам,
	|УдержанияПоСотрудникам,
	|НДФЛ,
	|СведенияОДоходахНДФЛ,
	|ДанныеСреднегоЗаработкаОбщий,
	|ДанныеСреднегоЗаработкаФСС");
	
	ИсправленныеСтроки = Переносы.Выгрузить(, "ИдентификаторСтрокиЗатрат");
	ИсправленныеСтроки.Свернуть("ИдентификаторСтрокиЗатрат");
	ИсправленныеСтроки = ИсправленныеСтроки.ВыгрузитьКолонку("ИдентификаторСтрокиЗатрат");
	
	Если ИсправленныеСтроки.Количество() = 0 Тогда
		Возврат ДанныеДляПроведения;
	КонецЕсли;
	
	Сотрудники = Новый Массив;
	Для каждого СтрокаТЧ Из Затраты Цикл
		Если ИсправленныеСтроки.Найти(СтрокаТЧ.ИдентификаторСтрокиЗатрат) <> Неопределено Тогда
			Если Сотрудники.Найти(СтрокаТЧ.Сотрудник) = Неопределено Тогда
				Сотрудники.Добавить(СтрокаТЧ.Сотрудник);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ПоляВзносов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина));
	// заполним таблицы НачисленияСотрудников и СтраховыеВзносыПоФизическимЛицам
	ЗаполнитьНачисленияИВзносы(ИсправленныеСтроки, ДанныеДляПроведения, Сотрудники, ПоляВзносов);
	
	ТекстОшибки = НСтр("ru = 'Проведение документа нарушит баланс распределения затрат по статьям. Возможно, данные в документе устарели, заполните документ еще раз и повторите операцию переноса затрат.'");
	Если ДанныеДляПроведения.НачисленияСотрудников.Итог("Сумма") <> 0 Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Для каждого ИмяРесурса Из ПоляВзносов Цикл
		Если ДанныеДляПроведения.СтраховыеВзносыПоФизическимЛицам.Итог(ИмяРесурса) <> 0 Тогда
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;	
	КонецЦикла;
	
	ДанныеДляПроведения.УдержанияПоСотрудникам = УдержанияПоСотрудникам(Сотрудники, ДанныеДляПроведения.НачисленияСотрудников);
	Если ДанныеДляПроведения.УдержанияПоСотрудникам <> Неопределено И ДанныеДляПроведения.УдержанияПоСотрудникам.Итог("Сумма") <> 0 Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ДанныеДляПроведения.НДФЛ = НДФЛПоСотрудникам(Сотрудники, ДанныеДляПроведения.НачисленияСотрудников);
	Если ДанныеДляПроведения.НДФЛ <> Неопределено И ДанныеДляПроведения.НДФЛ.Итог("Сумма") <> 0 Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ДанныеДляПроведения.СведенияОДоходахНДФЛ = СведенияОДоходахНДФЛ(ДанныеДляПроведения.НачисленияСотрудников);
	Если ДанныеДляПроведения.СведенияОДоходахНДФЛ <> Неопределено 
			И (ДанныеДляПроведения.СведенияОДоходахНДФЛ.Итог("СуммаДохода") <> 0 Или ДанныеДляПроведения.СведенияОДоходахНДФЛ.Итог("СуммаВычета")) Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий = УчетСреднегоЗаработка.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаПослеПереносаЗатрат(ДанныеДляПроведения.НачисленияСотрудников, Переносы.Выгрузить());
	Если ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий <> Неопределено И ДанныеДляПроведения.ДанныеСреднегоЗаработкаОбщий.Итог("Сумма") <> 0 Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС = УчетПособийСоциальногоСтрахованияРасширенный.ДанныеОНачисленияхДляРасчетаСреднегоЗаработкаПослеПереносаЗатрат(ДанныеДляПроведения.НачисленияСотрудников, Переносы.Выгрузить());
	Если ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС <> Неопределено И ДанныеДляПроведения.ДанныеСреднегоЗаработкаФСС.Итог("Сумма") <> 0 Тогда
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Возврат ДанныеДляПроведения;	

КонецФункции

Процедура ЗаполнитьНачисленияИВзносы(ИсправленныеСтроки, ДанныеДляПроведения, Сотрудники, ПоляВзносов)

	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	ЗарегистрированныеДанныеПоСотрудникам(МенеджерВременныхТаблиц, Сотрудники);
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;  

	Запрос.Текст = 
	"ВЫБРАТЬ
	|	*
	|ИЗ
	|	ВТНачисления КАК Начисления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	ВТВзносы КАК Взносы";
	Результат  = Запрос.ВыполнитьПакет();
	Начисления = Результат[0].Выгрузить();
	Взносы 	   = Результат[1].Выгрузить();
	
	НачисленияСотрудников = Начисления.СкопироватьКолонки();
	НачисленияСотрудников.Колонки.Добавить("Сторно", Новый ОписаниеТипов("Булево"));
	НачисленияСотрудников.Колонки.Добавить("ИдентификаторСтрокиЗатрат", Новый ОписаниеТипов("УникальныйИдентификатор"));
	
	СтраховыеВзносыПоФизическимЛицам = Взносы.СкопироватьКолонки();
	
	ПоляГруппировкиВзносов = Новый Массив;
	Для каждого КолонкаТЗ Из СтраховыеВзносыПоФизическимЛицам.Колонки Цикл
		Если ПоляВзносов.Найти(КолонкаТЗ.Имя) = Неопределено Тогда
			ПоляГруппировкиВзносов.Добавить(КолонкаТЗ.Имя);
		КонецЕсли;
	КонецЦикла;
	ПоляГруппировкиВзносовСтрока = СтрСоединить(ПоляГруппировкиВзносов,",");
	
	СтрокаСвойстПоиска = "Сотрудник,Подразделение,Начисление,СпособОтраженияЗарплатыВБухучете,СтатьяФинансирования";
	Если ПолучитьФункциональнуюОпцию("РаботаВБюджетномУчреждении") Тогда
		СтрокаСвойстПоиска = СтрокаСвойстПоиска +",СтатьяРасходов";
	КонецЕсли;
	ОтборЗатрат = Новый Структура(СтрокаСвойстПоиска);
	Отбор = Новый Структура("ИдентификаторСтрокиЗатрат");
	
	НачислениеУдержаниеВидОперации = ОтражениеЗарплатыВУчете.НачислениеУдержаниеВидОперации();
	ВидыОперацийБезСпособаОтражения = ОтражениеЗарплатыВБухучетеРасширенный.ВидыОперацийПоЗарплатеБезСпособаОтражения();
	СпособОтраженияЗаполняется = Новый Соответствие;
	Для каждого КлючИЗначение Из НачислениеУдержаниеВидОперации Цикл
		СпособОтраженияЗаполняется.Вставить(КлючИЗначение.Ключ, (ВидыОперацийБезСпособаОтражения.Найти(КлючИЗначение.Значение) = Неопределено));
	КонецЦикла;
	
	// начало заполнения таблиц НачисленияСотрудников и СтраховыеВзносыПоФизическимЛицам
	Для каждого ИдентификаторСтроки Из ИсправленныеСтроки Цикл
		
		Отбор.ИдентификаторСтрокиЗатрат = ИдентификаторСтроки;
		ВсегоСуммаЗатрат = 0;
		СтрокиПереноса = Переносы.НайтиСтроки(Отбор);
		Для каждого СтрокаТЧ Из СтрокиПереноса Цикл
			ВсегоСуммаЗатрат = ВсегоСуммаЗатрат + СтрокаТЧ.Сумма;
		КонецЦикла;
		
		СтрокаЗатрат = Затраты.Найти(ИдентификаторСтроки, "ИдентификаторСтрокиЗатрат");
		ЗаполнитьЗначенияСвойств(ОтборЗатрат, СтрокаЗатрат);
		СтрокиНачислений = Начисления.НайтиСтроки(ОтборЗатрат);
		СтрокиВзносов    = Взносы.НайтиСтроки(ОтборЗатрат);
		
		Если ВсегоСуммаЗатрат = СтрокаЗатрат.Сумма Тогда
			ДоляНачислений = СтрокаЗатрат.Зарплата;
		Иначе
			ДоляНачислений = Окр(СтрокаЗатрат.Зарплата * ВсегоСуммаЗатрат / СтрокаЗатрат.Сумма, 2);
		КонецЕсли;
		ДоляВзносов = ВсегоСуммаЗатрат - ДоляНачислений;
		
		Если ДоляНачислений <> 0 Тогда
			ЗаполнитьНачисленияСотрудников(НачисленияСотрудников, СтрокиНачислений, СтрокиПереноса, ДоляНачислений, СпособОтраженияЗаполняется, ИдентификаторСтроки);
		КонецЕсли;
		
		Если ДоляВзносов <> 0 Тогда
			ЗаполнитьСтраховыеВзносыПоФизическимЛицам(СтраховыеВзносыПоФизическимЛицам, СтрокиВзносов, СтрокиПереноса, ДоляВзносов, ПоляВзносов, ПоляГруппировкиВзносовСтрока, СпособОтраженияЗаполняется);
		КонецЕсли;
	
	КонецЦикла;
	
	ДанныеДляПроведения.НачисленияСотрудников = НачисленияСотрудников;
	ДанныеДляПроведения.СтраховыеВзносыПоФизическимЛицам = СтраховыеВзносыПоФизическимЛицам;

КонецПроцедуры

Процедура РаспределитьВзносы(СтраховыеВзносыПоФизическимЛицам, Взносы, БазовыеСтроки, ПоляГруппировкиВзносовСтрока, ПоляВзносовСтрока)

	ВременнаяТаблица = СтраховыеВзносыПоФизическимЛицам.СкопироватьКолонки();
	Для каждого КлючиЗначение Из Взносы Цикл
		
		ИмяПоля 	 = КлючиЗначение.Ключ;
		СуммаКолонки = КлючиЗначение.Значение;
		Если СуммаКолонки = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		КоэффициентыКолонки = Новый Массив;
		Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
			КоэффициентыКолонки.Добавить(СтрокаТЗ[ИмяПоля]);
		КонецЦикла;
		Результаты = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(СуммаКолонки, КоэффициентыКолонки);
		Если Результаты = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Индекс = 0;
		Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
			НоваяСтрока = ВременнаяТаблица.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ,,ПоляВзносовСтрока);
			НоваяСтрока[ИмяПоля] = -Результаты[Индекс];
			Индекс = Индекс +1;
		КонецЦикла;
		
	КонецЦикла;
	
	ВременнаяТаблица.Свернуть(ПоляГруппировкиВзносовСтрока, ПоляВзносовСтрока);
	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ВременнаяТаблица, СтраховыеВзносыПоФизическимЛицам);	

КонецПроцедуры

Процедура ЗаполнитьСтраховыеВзносыПоФизическимЛицам(СтраховыеВзносыПоФизическимЛицам, СтрокиВзносов, СтрокиПереноса, СуммаПереноса, ПоляВзносов, ПоляГруппировкиВзносовСтрока, СпособОтраженияЗаполняется)

	ПоляВзносовСтрока  = СтрСоединить(ПоляВзносов, ",");
	СуммаПоложительная = (СуммаПереноса>0);
	
	// массив в который помещаем строки имеющие итог по колонка того же знака, что и СуммаПереноса
	БазовыеСтроки = Новый Массив;
	
	// сумма всех колонок по всем строкам массива СтрокиВзносов
	СуммаВзносовВсего = 0;
	
	ВзносыИсходныхСтрок = Новый Соответствие;
	Для каждого ИмяПоля Из ПоляВзносов Цикл
		ВзносыИсходныхСтрок.Вставить(ИмяПоля, 0);
	КонецЦикла;
	
	КоэффициентыБазовыхСтрок = Новый Массив;
	Для каждого СтрокаТЗ Из СтрокиВзносов Цикл
		
		СуммаСтроки = 0;
		Для каждого ИмяПоля Из ПоляВзносов Цикл
			СуммаСтроки = СуммаСтроки + СтрокаТЗ[ИмяПоля];
			ВзносыИсходныхСтрок[ИмяПоля] = ВзносыИсходныхСтрок[ИмяПоля] + СтрокаТЗ[ИмяПоля];
		КонецЦикла;
		СуммаВзносовВсего = СуммаВзносовВсего + СуммаСтроки;
		
		Если СуммаПоложительная И СуммаСтроки>0 Или НЕ СуммаПоложительная И СуммаСтроки<0 Тогда
			КоэффициентыБазовыхСтрок.Добавить(СуммаСтроки);
			БазовыеСтроки.Добавить(СтрокаТЗ);
		КонецЕсли;
		
	КонецЦикла;
	
	// зарегистрируем списание затрат
	Если СуммаВзносовВсего = СуммаПереноса Тогда
		// списываем все взносы
		РаспределитьВзносы(СтраховыеВзносыПоФизическимЛицам, ВзносыИсходныхСтрок, БазовыеСтроки, ПоляГруппировкиВзносовСтрока, ПоляВзносовСтрока);
	Иначе // списывам часть взносов
		
		// распределим СуммаПереноса по видам взносов
		КоэффициентыВзносов = Новый Массив;
		Для каждого ИмяПоля Из ПоляВзносов Цикл
			КоэффициентыВзносов.Добавить(ВзносыИсходныхСтрок[ИмяПоля]);
		КонецЦикла;
		РезультатыВзносов = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(СуммаПереноса, КоэффициентыВзносов);
		Если РезультатыВзносов = Неопределено Тогда
			Возврат;
		КонецЕсли;
		Индекс = 0;
		Для каждого ИмяПоля Из ПоляВзносов Цикл
			ВзносыИсходныхСтрок[ИмяПоля] = РезультатыВзносов[Индекс];
			Индекс = Индекс +1;
		КонецЦикла;

		РаспределитьВзносы(СтраховыеВзносыПоФизическимЛицам, ВзносыИсходныхСтрок, БазовыеСтроки, ПоляГруппировкиВзносовСтрока, ПоляВзносовСтрока);
		
	КонецЕсли;

	// зарегистрируем приход затрат
	// ВзносыИсходныхСтрок содержит суммы в разрезе взносов, которые необходимо добавить
	
	ВременнаяТаблица = СтраховыеВзносыПоФизическимЛицам.СкопироватьКолонки();
	
	КоэффициентыПереноса = Новый Массив;
	Для каждого СтрокаТЗ Из СтрокиПереноса Цикл
		КоэффициентыПереноса.Добавить(СтрокаТЗ.Сумма);
	КонецЦикла;
	
	Для каждого ИмяПоля Из ПоляВзносов Цикл
	
		Сумма = ВзносыИсходныхСтрок[ИмяПоля];
		Если Сумма = 0 Тогда
			Продолжить;
		КонецЕсли;
		РезультатыКолонки = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(Сумма, КоэффициентыПереноса);
		
		ИндексСтрокиПереноса = 0;
		Для каждого СтрокаПереноса Из СтрокиПереноса Цикл
			
			НоваяСуммаКолонки = РезультатыКолонки[ИндексСтрокиПереноса];
			Результаты = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(НоваяСуммаКолонки, КоэффициентыБазовыхСтрок);
			Если Результаты = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Индекс = 0;
			Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
				НоваяСтрока = ВременнаяТаблица.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаТЗ,,ПоляВзносовСтрока);
				ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаПереноса,"СтатьяФинансирования,СтатьяРасходов,СпособОтраженияЗарплатыВБухучете");
				НоваяСтрока[ИмяПоля] = Результаты[Индекс];
			    Индекс = Индекс +1;
			КонецЦикла;
			
			ИндексСтрокиПереноса = ИндексСтрокиПереноса +1;
			
		КонецЦикла;	
			
	КонецЦикла;
	
	ВременнаяТаблица.Свернуть(ПоляГруппировкиВзносовСтрока, ПоляВзносовСтрока);
	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ВременнаяТаблица, СтраховыеВзносыПоФизическимЛицам);
	
КонецПроцедуры

Процедура ЗаполнитьНачисленияСотрудников(НачисленияСотрудников, СтрокиНачислений, СтрокиПереноса, СуммаПереноса, СпособОтраженияЗаполняется, ИдентификаторСтрокиЗатрат)
	
	СвойстваИсключения = "ДокументОснование";
	СуммаПоложительная = (СуммаПереноса>0);
	БазовыеСтроки = Новый Массив;
	
	Коэффициенты = Новый Массив;
	СуммаСтрок = 0;
	Для каждого СтрокаТЗ Из СтрокиНачислений Цикл
		// отбираем строки того же знака, что и сумма переноса
		Если СуммаПоложительная И СтрокаТЗ.Сумма>0 Или НЕ СуммаПоложительная И СтрокаТЗ.Сумма<0 Тогда
			СуммаСтрок = СуммаСтрок + СтрокаТЗ.Сумма;
			БазовыеСтроки.Добавить(СтрокаТЗ);
			Коэффициенты.Добавить(СтрокаТЗ.Сумма);
		КонецЕсли;
	КонецЦикла;
	
	// зарегистрируем списание затрат
	Если СуммаСтрок = СуммаПереноса Тогда
		
		Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
			НоваяСтрока = НачисленияСотрудников.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ,,СвойстваИсключения);
			НоваяСтрока.Сумма = - НоваяСтрока.Сумма;
			НоваяСтрока.Сторно = Истина;
			НоваяСтрока.ИдентификаторСтрокиЗатрат = ИдентификаторСтрокиЗатрат;
			НоваяСтрока.ПервичныйРегистратор = СтрокаТЗ.ПервичныйРегистраторНовойЗаписи;
		КонецЦикла;
		
	Иначе
		
		Результаты = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(СуммаПереноса, Коэффициенты);
		Если Результаты = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Индекс = 0;
		Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
			НоваяСтрока = НачисленияСотрудников.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ,,СвойстваИсключения);
			НоваяСтрока.Сумма = - Результаты[Индекс];
			НоваяСтрока.Сторно = Истина;
			НоваяСтрока.ИдентификаторСтрокиЗатрат = ИдентификаторСтрокиЗатрат;
			НоваяСтрока.ПервичныйРегистратор = СтрокаТЗ.ПервичныйРегистраторНовойЗаписи;
			Индекс = Индекс + 1;
		КонецЦикла;
		
	КонецЕсли;

	// зарегистрируем приход затрат
	СвойстваДляЗаполнения = "СтатьяФинансирования,СтатьяРасходов,СпособОтраженияЗарплатыВБухучете";
		
	КоэффициентыПереноса = Новый Массив;
	Для каждого СтрокаТЗ Из СтрокиПереноса Цикл
		КоэффициентыПереноса.Добавить(СтрокаТЗ.Сумма);
	КонецЦикла;
	РезультатыПереноса = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(СуммаПереноса, КоэффициентыПереноса);
	
	ИндексСтрокиПереноса = 0;
	Для каждого СтрокаПереноса Из СтрокиПереноса Цикл
		
		Сумма = РезультатыПереноса[ИндексСтрокиПереноса];
		
		Результаты = ЗарплатаКадрыКлиентСервер.РаспределитьПропорциональноКоэффициентам(Сумма, Коэффициенты);
		Если Результаты = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Индекс = 0;
		Для каждого СтрокаТЗ Из БазовыеСтроки Цикл
			НоваяСтрока = НачисленияСотрудников.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ,,СвойстваИсключения);
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаПереноса, СвойстваДляЗаполнения);
			Если Не СпособОтраженияЗаполняется[НоваяСтрока.Начисление] Тогда
				НоваяСтрока.СпособОтраженияЗарплатыВБухучете = Справочники.СпособыОтраженияЗарплатыВБухУчете.ПустаяСсылка();
			КонецЕсли;
			НоваяСтрока.Сумма = Результаты[Индекс];
			НоваяСтрока.ПервичныйРегистратор = СтрокаТЗ.ПервичныйРегистраторНовойЗаписи;
			Индекс = Индекс + 1;
		КонецЦикла;
		
		ИндексСтрокиПереноса = ИндексСтрокиПереноса + 1;
		
	КонецЦикла;
	
КонецПроцедуры

Функция УдержанияПоСотрудникам(Сотрудники, НачисленияСотрудников)

	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	Запрос.УстановитьПараметр("Сотрудники", Сотрудники);
	Запрос.УстановитьПараметр("ИсключаемыйРегистратор", Ссылка);
	Запрос.УстановитьПараметр("РаботаВБюджетномУчреждении", ПолучитьФункциональнуюОпцию("РаботаВБюджетномУчреждении"));
	Запрос.УстановитьПараметр("ВидыОсобыхНачисленийИУдержанийНДФЛ", ОтражениеЗарплатыВУчете.ВидыОсобыхНачисленийИУдержанийНДФЛ());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Удержания.Сотрудник КАК Сотрудник,
	|	Удержания.Подразделение КАК Подразделение,
	|	Удержания.НачислениеУдержание КАК НачислениеУдержание,
	|	Удержания.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|	ВЫБОР
	|		КОГДА &РаботаВБюджетномУчреждении
	|			ТОГДА Удержания.СтатьяРасходов
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтатьиРасходовЗарплата.ПустаяСсылка)
	|	КОНЕЦ КАК СтатьяРасходов,
	|	Удержания.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.Сумма КАК Сумма,
	|	Удержания.ГруппаНачисленияУдержанияВыплаты КАК ГруппаНачисленияУдержанияВыплаты,
	|	Удержания.ПериодДействия КАК ПериодДействия,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	Удержания.Контрагент КАК Контрагент,
	|	Удержания.ДатаНачала КАК ДатаНачала,
	|	Удержания.ДатаОкончания КАК ДатаОкончания,
	|	Удержания.ВидОперации КАК ВидОперации,
	|	Удержания.Регистратор КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Удержания.Регистратор ССЫЛКА Документ.ПереносЗатратНаПерсоналМеждуСтатьями
	|			ТОГДА Удержания.ПервичныйРегистратор
	|		ИНАЧЕ Удержания.Регистратор
	|	КОНЕЦ КАК ПервичныйРегистратор
	|ПОМЕСТИТЬ ВТЗарегистрированныеУдержания
	|ИЗ
	|	РегистрНакопления.БухучетНачисленияУдержанияПоСотрудникам КАК Удержания
	|ГДЕ
	|	Удержания.Период = &ПериодРегистрации
	|	И Удержания.Сотрудник В(&Сотрудники)
	|	И НЕ Удержания.НеУчитыватьВРаспределенииПриОкончательномРасчете
	|	И Удержания.Регистратор <> &ИсключаемыйРегистратор
	|	И Удержания.Сумма <> 0
	|	И Удержания.ГруппаНачисленияУдержанияВыплаты = ЗНАЧЕНИЕ(Перечисление.ГруппыНачисленияУдержанияВыплаты.Удержано)
	|	И НЕ Удержания.НачислениеУдержание В (&ВидыОсобыхНачисленийИУдержанийНДФЛ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Удержания.Сотрудник КАК Сотрудник,
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.НачислениеУдержание КАК ВидУдержания,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	ВЫБОР
	|		КОГДА Удержания.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоЗарплате.ВознаграждениеПлатежногоАгента)
	|			ТОГДА Удержания.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК ПлатежныйАгент,
	|	ВЫБОР
	|		КОГДА Удержания.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоЗарплате.ВознаграждениеПлатежногоАгента)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ИНАЧЕ Удержания.Контрагент
	|	КОНЕЦ КАК Получатель,
	|	Удержания.Контрагент КАК Контрагент,
	|	Удержания.ДатаНачала КАК ДатаНачала,
	|	Удержания.ДатаОкончания КАК ДатаОкончания,
	|	СУММА(Удержания.Сумма) КАК Сумма,
	|	Удержания.ПервичныйРегистратор КАК ПервичныйРегистратор
	|ИЗ
	|	ВТЗарегистрированныеУдержания КАК Удержания
	|
	|СГРУППИРОВАТЬ ПО
	|	Удержания.ДокументОснование,
	|	Удержания.ФизическоеЛицо,
	|	Удержания.Сотрудник,
	|	ВЫБОР
	|		КОГДА Удержания.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоЗарплате.ВознаграждениеПлатежногоАгента)
	|			ТОГДА Удержания.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ,
	|	Удержания.ДатаОкончания,
	|	ВЫБОР
	|		КОГДА Удержания.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоЗарплате.ВознаграждениеПлатежногоАгента)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ИНАЧЕ Удержания.Контрагент
	|	КОНЕЦ,
	|	Удержания.НачислениеУдержание,
	|	Удержания.Контрагент,
	|	Удержания.ДатаНачала,
	|	Удержания.ПервичныйРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(Удержания.Сумма) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЗарегистрированныеУдержания.Регистратор КАК Регистратор
	|ИЗ
	|	ВТЗарегистрированныеУдержания КАК ЗарегистрированныеУдержания"; 
	
	Результат = Запрос.ВыполнитьПакет();
	Если Результат[1].Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаУдержаний = ОтражениеЗарплатыВБухучетеРасширенный.НоваяТаблицаРезультатРасчетаУдержаний();
	ТаблицаУдержаний.Колонки.Добавить("Контрагент", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаУдержаний.Колонки.Добавить("ПервичныйРегистратор",Метаданные.РегистрыНакопления.БухучетНачисленияУдержанияПоСотрудникам.СтандартныеРеквизиты.Регистратор.Тип);
	Выборка = Результат[1].Выбрать();
	ИдентификаторСтроки = 1;
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаУдержаний.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		НоваяСтрока.ИдентификаторСтроки = ИдентификаторСтроки;
		ИдентификаторСтроки = ИдентификаторСтроки +1;
	КонецЦикла;
	
	РегистраторыУдержанийОбновленияБухучета = Результат[2].Выгрузить().ВыгрузитьКолонку("Регистратор");
	
	Запрос.УстановитьПараметр("НачисленияСотрудников", НачисленияСотрудников);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.Подразделение КАК Подразделение,
	|	Начисления.ДатаНачала КАК ДатаНачала,
	|	Начисления.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Начисления.СтатьяРасходов КАК СтатьяРасходов,
	|	Начисления.Сумма КАК Сумма,
	|	Начисления.Начисление КАК Начисление,
	|	Начисления.ТерриторияВыполненияРаботВОрганизации КАК Территория
	|ПОМЕСТИТЬ ВТБухучетНачисленийВыходнаяТаблица
	|ИЗ
	|	&НачисленияСотрудников КАК Начисления";
	Запрос.Выполнить();
	
	ИсходныеДанные = ОтражениеЗарплатыВБухучетеРасширенный.ОписаниеИсходныхДанныхДляОтраженияУдержанийВБухучете();
	ИсходныеДанные.МенеджерВременныхТаблиц  = МенеджерВременныхТаблиц;
	ИсходныеДанные.Организация    			= Организация;
	ИсходныеДанные.МесяцНачисления 			= ПериодРегистрации;
	ИсходныеДанные.ИмяВТБухучетНачислений 	= "ВТБухучетНачисленийВыходнаяТаблица";
	ИсходныеДанные.ОкончательныйРасчет		= Истина;
	ИсходныеДанные.ИсключаемыйРегистратор 	= Ссылка;
	ИсходныеДанные.ТаблицаУдержаний			= ТаблицаУдержаний;
	ИсходныеДанные.ТаблицаЗаймов			= ОтражениеЗарплатыВБухучетеРасширенный.НоваяТаблицаРезультатПогашениеЗаймов();
	ИсходныеДанные.РегистраторыУдержанийОбновленияБухучета = РегистраторыУдержанийОбновленияБухучета;
	ИсходныеДанные.ВидыНачисленийДополненияРасчетнойБазы = ОтражениеЗарплатыВБухучетеРасширенный.ВидыНачисленийДополненияРасчетнойБазыУдержаний();
	
	РезультатыОтраженияВБухучете = ОтражениеЗарплатыВБухучетеРасширенный.ВыполнитьОтражениеУдержанийИЗаймовВБухучете(ИсходныеДанные);
	
	БухучетУдержаний = РезультатыОтраженияВБухучете.БухучетУдержаний;
	
	Запрос.УстановитьПараметр("ТаблицаУдержаний", ТаблицаУдержаний);
	Запрос.УстановитьПараметр("БухучетУдержаний", БухучетУдержаний);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Удержания.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	Удержания.Сотрудник КАК Сотрудник,
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.ВидУдержания КАК ВидУдержания,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	Удержания.Контрагент КАК Контрагент,
	|	Удержания.ДатаНачала КАК ДатаНачала,
	|	Удержания.ДатаОкончания КАК ДатаОкончания,
	|	Удержания.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|	Удержания.Сумма КАК Сумма
	|ПОМЕСТИТЬ ВТУдержания
	|ИЗ
	|	&ТаблицаУдержаний КАК Удержания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БухучетУдержаний.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	БухучетУдержаний.Сотрудник КАК Сотрудник,
	|	БухучетУдержаний.ВидУдержания КАК ВидУдержания,
	|	БухучетУдержаний.Подразделение КАК Подразделение,
	|	БухучетУдержаний.СтатьяФинансирования КАК СтатьяФинансирования,
	|	БухучетУдержаний.СтатьяРасходов КАК СтатьяРасходов,
	|	БухучетУдержаний.Результат КАК Сумма
	|ПОМЕСТИТЬ ВТБухучетУдержаний
	|ИЗ
	|	&БухучетУдержаний КАК БухучетУдержаний
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Удержания.Сотрудник КАК Сотрудник,
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.Подразделение КАК Подразделение,
	|	Удержания.Удержание КАК Удержание,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	Удержания.Контрагент КАК Контрагент,
	|	Удержания.ДатаНачала КАК ДатаНачала,
	|	Удержания.ДатаОкончания КАК ДатаОкончания,
	|	Удержания.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Удержания.СтатьяРасходов КАК СтатьяРасходов,
	|	Удержания.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|	СУММА(Удержания.Сумма) КАК Сумма
	|ИЗ
	|	(ВЫБРАТЬ
	|		Удержания.Сотрудник КАК Сотрудник,
	|		Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|		БухучетУдержаний.Подразделение КАК Подразделение,
	|		Удержания.ВидУдержания КАК Удержание,
	|		Удержания.ДокументОснование КАК ДокументОснование,
	|		Удержания.Контрагент КАК Контрагент,
	|		Удержания.ДатаНачала КАК ДатаНачала,
	|		Удержания.ДатаОкончания КАК ДатаОкончания,
	|		Удержания.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|		БухучетУдержаний.СтатьяФинансирования КАК СтатьяФинансирования,
	|		БухучетУдержаний.СтатьяРасходов КАК СтатьяРасходов,
	|		БухучетУдержаний.Сумма КАК Сумма
	|	ИЗ
	|		ВТУдержания КАК Удержания
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБухучетУдержаний КАК БухучетУдержаний
	|			ПО Удержания.ИдентификаторСтроки = БухучетУдержаний.ИдентификаторСтроки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗарегистрированныеУдержания.Сотрудник,
	|		ЗарегистрированныеУдержания.ФизическоеЛицо,
	|		ЗарегистрированныеУдержания.Подразделение,
	|		ЗарегистрированныеУдержания.НачислениеУдержание,
	|		ЗарегистрированныеУдержания.ДокументОснование,
	|		ЗарегистрированныеУдержания.Контрагент,
	|		ЗарегистрированныеУдержания.ДатаНачала,
	|		ЗарегистрированныеУдержания.ДатаОкончания,
	|		ЗарегистрированныеУдержания.ПервичныйРегистратор,
	|		ЗарегистрированныеУдержания.СтатьяФинансирования,
	|		ЗарегистрированныеУдержания.СтатьяРасходов,
	|		-ЗарегистрированныеУдержания.Сумма
	|	ИЗ
	|		ВТЗарегистрированныеУдержания КАК ЗарегистрированныеУдержания) КАК Удержания
	|
	|СГРУППИРОВАТЬ ПО
	|	Удержания.ФизическоеЛицо,
	|	Удержания.СтатьяФинансирования,
	|	Удержания.Подразделение,
	|	Удержания.Контрагент,
	|	Удержания.ДатаНачала,
	|	Удержания.СтатьяРасходов,
	|	Удержания.Сотрудник,
	|	Удержания.ДокументОснование,
	|	Удержания.Удержание,
	|	Удержания.ДатаОкончания,
	|	Удержания.ПервичныйРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(Удержания.Сумма) <> 0";
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

Функция НДФЛПоСотрудникам(Сотрудники, НачисленияСотрудников)

	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	Запрос.УстановитьПараметр("Сотрудники", Сотрудники);
	Запрос.УстановитьПараметр("ИсключаемыйРегистратор", Ссылка);
	Запрос.УстановитьПараметр("РаботаВБюджетномУчреждении", ПолучитьФункциональнуюОпцию("РаботаВБюджетномУчреждении"));
	Запрос.УстановитьПараметр("ВидыОсобыхНачисленийИУдержанийНДФЛ", ОтражениеЗарплатыВУчете.ВидыОсобыхНачисленийИУдержанийНДФЛ(Истина));
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Удержания.Сотрудник КАК Сотрудник,
	|	Удержания.Подразделение КАК Подразделение,
	|	Удержания.НачислениеУдержание КАК НачислениеУдержание,
	|	Удержания.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|	ВЫБОР
	|		КОГДА &РаботаВБюджетномУчреждении
	|			ТОГДА Удержания.СтатьяРасходов
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтатьиРасходовЗарплата.ПустаяСсылка)
	|	КОНЕЦ КАК СтатьяРасходов,
	|	Удержания.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.Сумма КАК Сумма,
	|	Удержания.ПериодДействия КАК ПериодДействия,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	Удержания.ДатаНачала КАК ДатаНачала,
	|	Удержания.ДатаОкончания КАК ДатаОкончания,
	|	Удержания.ВидОперации КАК ВидОперации,
	|	Удержания.ТерриторияВыполненияРаботВОрганизации КАК ТерриторияВыполненияРаботВОрганизации,
	|	Удержания.ДатаПолученияДохода КАК ДатаПолученияДохода,
	|	Удержания.Регистратор КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Удержания.Регистратор ССЫЛКА Документ.ПереносЗатратНаПерсоналМеждуСтатьями
	|			ТОГДА Удержания.ПервичныйРегистратор
	|		ИНАЧЕ Удержания.Регистратор
	|	КОНЕЦ КАК ПервичныйРегистратор
	|ПОМЕСТИТЬ ВТЗарегистрированныйНДФЛ
	|ИЗ
	|	РегистрНакопления.БухучетНачисленияУдержанияПоСотрудникам КАК Удержания
	|ГДЕ
	|	Удержания.Период = &ПериодРегистрации
	|	И Удержания.Сотрудник В(&Сотрудники)
	|	И НЕ Удержания.НеУчитыватьВРаспределенииПриОкончательномРасчете
	|	И Удержания.Регистратор <> &ИсключаемыйРегистратор
	|	И Удержания.Сумма <> 0
	|	И Удержания.ГруппаНачисленияУдержанияВыплаты = ЗНАЧЕНИЕ(Перечисление.ГруппыНачисленияУдержанияВыплаты.Удержано)
	|	И Удержания.НачислениеУдержание В(&ВидыОсобыхНачисленийИУдержанийНДФЛ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|	НДФЛ.ДатаПолученияДохода КАК ДатаПолученияДохода,
	|	НДФЛ.ТерриторияВыполненияРаботВОрганизации КАК Территория,
	|	СУММА(НДФЛ.Сумма) КАК Сумма,
	|	НДФЛ.НачислениеУдержание КАК ВидУдержания,
	|	НДФЛ.ПервичныйРегистратор КАК ПервичныйРегистратор
	|ИЗ
	|	ВТЗарегистрированныйНДФЛ КАК НДФЛ
	|
	|СГРУППИРОВАТЬ ПО
	|	НДФЛ.ДатаПолученияДохода,
	|	НДФЛ.ФизическоеЛицо,
	|	НДФЛ.НачислениеУдержание,
	|	НДФЛ.ТерриторияВыполненияРаботВОрганизации,
	|	НДФЛ.ПервичныйРегистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДФЛ.Регистратор КАК Регистратор
	|ИЗ
	|	ВТЗарегистрированныйНДФЛ КАК НДФЛ"; 
	
	Результат = Запрос.ВыполнитьПакет();
	Если Результат[1].Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаНДФЛ = ОтражениеЗарплатыВБухучетеРасширенный.НоваяТаблицаРезультатРасчетаНДФЛ();
	ТаблицаНДФЛ.Колонки.Добавить("ПервичныйРегистратор",Метаданные.РегистрыНакопления.БухучетНачисленияУдержанияПоСотрудникам.СтандартныеРеквизиты.Регистратор.Тип);
	Выборка = Результат[1].Выбрать();
	ИдентификаторСтроки = 1;
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаНДФЛ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		НоваяСтрока.ИдентификаторСтроки = ИдентификаторСтроки;
		ИдентификаторСтроки = ИдентификаторСтроки +1;
	КонецЦикла;
	
	РегистраторыНДФЛОбновленияБухучета = Результат[2].Выгрузить().ВыгрузитьКолонку("Регистратор");
	
	Запрос.УстановитьПараметр("НачисленияСотрудников", НачисленияСотрудников);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.Подразделение КАК Подразделение,
	|	Начисления.ДатаНачала КАК ДатаНачала,
	|	Начисления.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Начисления.СтатьяРасходов КАК СтатьяРасходов,
	|	Начисления.Сумма КАК Сумма,
	|	Начисления.Начисление КАК Начисление,
	|	Начисления.ТерриторияВыполненияРаботВОрганизации КАК Территория
	|ПОМЕСТИТЬ ВТБухучетНачисленийВыходнаяТаблица
	|ИЗ
	|	&НачисленияСотрудников КАК Начисления";
	Запрос.Выполнить();
	
	ИсходныеДанные = ОтражениеЗарплатыВБухучетеРасширенный.ОписаниеИсходныхДанныхДляОтраженияУдержанийВБухучете();
	ИсходныеДанные.МенеджерВременныхТаблиц  = МенеджерВременныхТаблиц;
	ИсходныеДанные.Организация    			= Организация;
	ИсходныеДанные.МесяцНачисления 			= ПериодРегистрации;
	ИсходныеДанные.ИмяВТБухучетНачислений 	= "ВТБухучетНачисленийВыходнаяТаблица";
	ИсходныеДанные.ОкончательныйРасчет		= Истина;
	ИсходныеДанные.ИсключаемыйРегистратор 	= Ссылка;
	ИсходныеДанные.РезультатРасчетаНДФЛ		= ТаблицаНДФЛ;
	ИсходныеДанные.НДФЛКЗачету		 		= ОтражениеЗарплатыВБухучетеРасширенный.НоваяТаблицаКорректировкиВыплаты();
	ИсходныеДанные.НДФЛЗачтено		 		= ОтражениеЗарплатыВБухучетеРасширенный.НоваяТаблицаКорректировкиВыплаты();
	ИсходныеДанные.РегистраторыУдержанийОбновленияБухучета = РегистраторыНДФЛОбновленияБухучета;
	
	РезультатыОтраженияВБухучете = ОтражениеЗарплатыВБухучетеРасширенный.ВыполнитьОтражениеНДФЛИКорректировокВыплатыВБухучете(ИсходныеДанные);
	
	БухучетНДФЛ = РезультатыОтраженияВБухучете.БухучетНДФЛ;
	
	Запрос.УстановитьПараметр("ТаблицаНДФЛ", ТаблицаНДФЛ);
	Запрос.УстановитьПараметр("БухучетНДФЛ", БухучетНДФЛ);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДФЛ.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	НДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|	НДФЛ.ВидУдержания КАК ВидУдержания,
	|	НДФЛ.Территория КАК Территория,
	|	НДФЛ.ДатаПолученияДохода КАК ДатаПолученияДохода,
	|	НДФЛ.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|	НДФЛ.Сумма КАК Сумма
	|ПОМЕСТИТЬ ВТ_НДФЛ
	|ИЗ
	|	&ТаблицаНДФЛ КАК НДФЛ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БухучетНДФЛ.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	БухучетНДФЛ.Сотрудник КАК Сотрудник,
	|	БухучетНДФЛ.ВидУдержания КАК ВидУдержания,
	|	БухучетНДФЛ.Подразделение КАК Подразделение,
	|	БухучетНДФЛ.СтатьяФинансирования КАК СтатьяФинансирования,
	|	БухучетНДФЛ.СтатьяРасходов КАК СтатьяРасходов,
	|	БухучетНДФЛ.Результат КАК Сумма
	|ПОМЕСТИТЬ ВТБухучетНДФЛ
	|ИЗ
	|	&БухучетНДФЛ КАК БухучетНДФЛ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|	НДФЛ.ВидУдержания КАК ВидУдержания,
	|	НДФЛ.Территория КАК Подразделение,
	|	НДФЛ.ДатаПолученияДохода КАК МесяцНалоговогоПериода,
	|	НДФЛ.Сотрудник КАК Сотрудник,
	|	НДФЛ.Подразделение КАК ПодразделениеСотрудника,
	|	НДФЛ.СтатьяФинансирования КАК СтатьяФинансирования,
	|	НДФЛ.СтатьяРасходов КАК СтатьяРасходов,
	|	СУММА(НДФЛ.Сумма) КАК Сумма,
	|	НДФЛ.ПервичныйРегистратор КАК ПервичныйРегистратор
	|ИЗ
	|	(ВЫБРАТЬ
	|		БухучетНДФЛ.Сотрудник КАК Сотрудник,
	|		НДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|		БухучетНДФЛ.Подразделение КАК Подразделение,
	|		НДФЛ.ВидУдержания КАК ВидУдержания,
	|		НДФЛ.Территория КАК Территория,
	|		НДФЛ.ДатаПолученияДохода КАК ДатаПолученияДохода,
	|		НДФЛ.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|		БухучетНДФЛ.СтатьяФинансирования КАК СтатьяФинансирования,
	|		БухучетНДФЛ.СтатьяРасходов КАК СтатьяРасходов,
	|		БухучетНДФЛ.Сумма КАК Сумма
	|	ИЗ
	|		ВТ_НДФЛ КАК НДФЛ
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТБухучетНДФЛ КАК БухучетНДФЛ
	|			ПО НДФЛ.ИдентификаторСтроки = БухучетНДФЛ.ИдентификаторСтроки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДФЛ.Сотрудник,
	|		НДФЛ.ФизическоеЛицо,
	|		НДФЛ.Подразделение,
	|		НДФЛ.НачислениеУдержание,
	|		НДФЛ.ТерриторияВыполненияРаботВОрганизации,
	|		НДФЛ.ДатаПолученияДохода,
	|		НДФЛ.ПервичныйРегистратор,
	|		НДФЛ.СтатьяФинансирования,
	|		НДФЛ.СтатьяРасходов,
	|		-НДФЛ.Сумма
	|	ИЗ
	|		ВТЗарегистрированныйНДФЛ КАК НДФЛ) КАК НДФЛ
	|
	|СГРУППИРОВАТЬ ПО
	|	НДФЛ.Территория,
	|	НДФЛ.ВидУдержания,
	|	НДФЛ.ФизическоеЛицо,
	|	НДФЛ.ДатаПолученияДохода,
	|	НДФЛ.Подразделение,
	|	НДФЛ.СтатьяФинансирования,
	|	НДФЛ.СтатьяРасходов,
	|	НДФЛ.Сотрудник,
	|	НДФЛ.ПервичныйРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(НДФЛ.Сумма) <> 0";
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции

Функция СведенияОДоходахНДФЛ(НачисленияСотрудников)

	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("НачисленияСотрудников", НачисленияСотрудников);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.Подразделение КАК Подразделение,
	|	Начисления.Начисление КАК Начисление,
	|	Начисления.СтатьяРасходов КАК СтатьяРасходов,
	|	Начисления.СтатьяФинансирования КАК СтатьяФинансирования,
	|	Начисления.Сумма КАК Сумма,
	|	Начисления.ДатаНачала КАК ДатаНачала,
	|	Начисления.ТерриторияВыполненияРаботВОрганизации КАК Территория,
	|	Начисления.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВТКорректировкиНачислений
	|ИЗ
	|	&НачисленияСотрудников КАК Начисления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КорректировкиНачислений.Регистратор КАК Регистратор,
	|	КорректировкиНачислений.Сотрудник КАК Сотрудник,
	|	КорректировкиНачислений.Начисление КАК Начисление
	|ПОМЕСТИТЬ ВТДанныеДляОтбора
	|ИЗ
	|	ВТКорректировкиНачислений КАК КорректировкиНачислений
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БухучетНачислений.Сотрудник КАК Сотрудник,
	|	БухучетНачислений.ФизическоеЛицо КАК ФизическоеЛицо,
	|	БухучетНачислений.Подразделение КАК Подразделение,
	|	БухучетНачислений.Начисление КАК НачислениеУдержание,
	|	БухучетНачислений.СтатьяРасходов КАК СтатьяРасходов,
	|	БухучетНачислений.СтатьяФинансирования КАК СтатьяФинансирования,
	|	СУММА(БухучетНачислений.Сумма) КАК Сумма,
	|	БухучетНачислений.ДатаНачала КАК ДатаНачала,
	|	БухучетНачислений.Территория КАК ТерриторияВыполненияРаботВОрганизации,
	|	ЗНАЧЕНИЕ(Перечисление.ГруппыНачисленияУдержанияВыплаты.Начислено) КАК ГруппаНачисленияУдержанияВыплаты
	|ИЗ
	|	(ВЫБРАТЬ
	|		Начисления.Сотрудник КАК Сотрудник,
	|		Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|		Начисления.Подразделение КАК Подразделение,
	|		Начисления.Начисление КАК Начисление,
	|		Начисления.СтатьяРасходов КАК СтатьяРасходов,
	|		Начисления.СтатьяФинансирования КАК СтатьяФинансирования,
	|		Начисления.Сумма КАК Сумма,
	|		Начисления.ДатаНачала КАК ДатаНачала,
	|		Начисления.Территория КАК Территория
	|	ИЗ
	|		ВТКорректировкиНачислений КАК Начисления
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		БухучетНачисления.Сотрудник,
	|		БухучетНачисления.ФизическоеЛицо,
	|		БухучетНачисления.Подразделение,
	|		БухучетНачисления.НачислениеУдержание,
	|		БухучетНачисления.СтатьяРасходов,
	|		БухучетНачисления.СтатьяФинансирования,
	|		БухучетНачисления.Сумма,
	|		БухучетНачисления.ДатаНачала,
	|		БухучетНачисления.ТерриторияВыполненияРаботВОрганизации
	|	ИЗ
	|		РегистрНакопления.БухучетНачисленияУдержанияПоСотрудникам КАК БухучетНачисления
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДанныеДляОтбора КАК ДанныеДляОтбора
	|			ПО БухучетНачисления.Регистратор = ДанныеДляОтбора.Регистратор
	|				И БухучетНачисления.Сотрудник = ДанныеДляОтбора.Сотрудник
	|				И БухучетНачисления.НачислениеУдержание = ДанныеДляОтбора.Начисление) КАК БухучетНачислений
	|
	|СГРУППИРОВАТЬ ПО
	|	БухучетНачислений.Подразделение,
	|	БухучетНачислений.Начисление,
	|	БухучетНачислений.СтатьяРасходов,
	|	БухучетНачислений.ДатаНачала,
	|	БухучетНачислений.Территория,
	|	БухучетНачислений.ФизическоеЛицо,
	|	БухучетНачислений.Сотрудник,
	|	БухучетНачислений.СтатьяФинансирования
	|
	|ИМЕЮЩИЕ
	|	СУММА(БухучетНачислений.Сумма) <> 0";
	БухучетНачислений = Запрос.Выполнить().Выгрузить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	*
	|ИЗ
	|	РегистрНакопления.СведенияОДоходахНДФЛ КАК СведенияОДоходахНДФЛ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДанныеДляОтбора КАК ДанныеДляОтбора
	|		ПО СведенияОДоходахНДФЛ.Регистратор = ДанныеДляОтбора.Регистратор
	|			И СведенияОДоходахНДФЛ.Сотрудник = ДанныеДляОтбора.Сотрудник
	|			И СведенияОДоходахНДФЛ.Начисление = ДанныеДляОтбора.Начисление";
	СведенияОДоходах = Запрос.Выполнить().Выгрузить();
	
	СведенияОДоходах.Колонки.Добавить("ИдентификаторСтроки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(7, 0)));
	ИдентификаторСтроки = 1;
	Для каждого СтрокаТЗ Из СведенияОДоходах Цикл
		СтрокаТЗ.ИдентификаторСтроки = ИдентификаторСтроки;
		ИдентификаторСтроки = ИдентификаторСтроки + 1;
	КонецЦикла;
	
	НовыеСведенияОДоходах = ОтражениеЗарплатыВБухучетеРасширенный.НовыеСведенияОДоходахДополненныеСтатьейФинансирования(СведенияОДоходах, БухучетНачислений);
	Если НовыеСведенияОДоходах.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Для каждого СтрокаТЗ Из СведенияОДоходах Цикл
		НоваяСтрока = НовыеСведенияОДоходах.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ);
		НоваяСтрока.СуммаДохода = - НоваяСтрока.СуммаДохода;
		НоваяСтрока.СуммаВычета = - НоваяСтрока.СуммаВычета;
	КонецЦикла;
	
	Возврат НовыеСведенияОДоходах;

КонецФункции 

Процедура ЗарегистрированныеДанныеПоСотрудникам(МенеджерВременныхТаблиц, Сотрудники)

	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ОтложенноеПроведениеДокументов") Тогда 
		Модуль = ОбщегоНазначения.ОбщийМодуль("ОтражениеДокументовВУчетеСтраховыхВзносов");
		Модуль.ОтразитьДокументыВУчетеСтраховыхВзносов(Организация);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	Запрос.УстановитьПараметр("Сотрудники", Сотрудники);
	Запрос.УстановитьПараметр("ИсключаемыйРегистратор", Ссылка);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	БухучетНачисленияУдержания.Сотрудник КАК Сотрудник,
	|	БухучетНачисленияУдержания.Подразделение КАК Подразделение,
	|	БухучетНачисленияУдержания.НачислениеУдержание КАК Начисление,
	|	БухучетНачисленияУдержания.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|	БухучетНачисленияУдержания.СтатьяРасходов КАК СтатьяРасходов,
	|	БухучетНачисленияУдержания.СтатьяФинансирования КАК СтатьяФинансирования,
	|	БухучетНачисленияУдержания.Период КАК Период,
	|	БухучетНачисленияУдержания.Организация КАК Организация,
	|	БухучетНачисленияУдержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	СУММА(БухучетНачисленияУдержания.Сумма) КАК Сумма,
	|	БухучетНачисленияУдержания.ПериодДействия КАК ПериодДействия,
	|	БухучетНачисленияУдержания.ДокументОснование КАК ДокументОснование,
	|	БухучетНачисленияУдержания.ДатаНачала КАК ДатаНачала,
	|	БухучетНачисленияУдержания.ДатаОкончания КАК ДатаОкончания,
	|	БухучетНачисленияУдержания.ОблагаетсяЕНВД КАК ОблагаетсяЕНВД,
	|	БухучетНачисленияУдержания.ВидОперации КАК ВидОперации,
	|	БухучетНачисленияУдержания.ТерриторияВыполненияРаботВОрганизации КАК ТерриторияВыполненияРаботВОрганизации,
	|	БухучетНачисленияУдержания.Регистратор КАК Регистратор,
	|	БухучетНачисленияУдержания.ПервичныйРегистратор КАК ПервичныйРегистратор,
	|	ВЫБОР
	|		КОГДА БухучетНачисленияУдержания.Регистратор ССЫЛКА Документ.ПереносЗатратНаПерсоналМеждуСтатьями
	|			ТОГДА БухучетНачисленияУдержания.ПервичныйРегистратор
	|		ИНАЧЕ БухучетНачисленияУдержания.Регистратор
	|	КОНЕЦ КАК ПервичныйРегистраторНовойЗаписи
	|ПОМЕСТИТЬ ВТНачисления
	|ИЗ
	|	РегистрНакопления.БухучетНачисленияУдержанияПоСотрудникам КАК БухучетНачисленияУдержания
	|ГДЕ
	|	БухучетНачисленияУдержания.Период = &ПериодРегистрации
	|	И БухучетНачисленияУдержания.Сотрудник В(&Сотрудники)
	|	И БухучетНачисленияУдержания.ГруппаНачисленияУдержанияВыплаты = ЗНАЧЕНИЕ(Перечисление.ГруппыНачисленияУдержанияВыплаты.Начислено)
	|	И НЕ БухучетНачисленияУдержания.НеУчитыватьВРаспределенииПриОкончательномРасчете
	|	И БухучетНачисленияУдержания.Регистратор <> &ИсключаемыйРегистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	БухучетНачисленияУдержания.ВидОперации,
	|	БухучетНачисленияУдержания.НачислениеУдержание,
	|	БухучетНачисленияУдержания.ДатаОкончания,
	|	БухучетНачисленияУдержания.Подразделение,
	|	БухучетНачисленияУдержания.ТерриторияВыполненияРаботВОрганизации,
	|	БухучетНачисленияУдержания.ФизическоеЛицо,
	|	БухучетНачисленияУдержания.СтатьяФинансирования,
	|	БухучетНачисленияУдержания.СтатьяРасходов,
	|	БухучетНачисленияУдержания.ОблагаетсяЕНВД,
	|	БухучетНачисленияУдержания.ДокументОснование,
	|	БухучетНачисленияУдержания.ПериодДействия,
	|	БухучетНачисленияУдержания.Период,
	|	БухучетНачисленияУдержания.ДатаНачала,
	|	БухучетНачисленияУдержания.СпособОтраженияЗарплатыВБухучете,
	|	БухучетНачисленияУдержания.Организация,
	|	БухучетНачисленияУдержания.Сотрудник,
	|	БухучетНачисленияУдержания.Регистратор,
	|	БухучетНачисленияУдержания.ПервичныйРегистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(БухучетНачисленияУдержания.Сумма) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СтраховыеВзносы.Сотрудник КАК Сотрудник,
	|	СтраховыеВзносы.Подразделение КАК Подразделение,
	|	СтраховыеВзносы.Начисление КАК Начисление,
	|	СтраховыеВзносы.СпособОтраженияЗарплатыВБухучете КАК СпособОтраженияЗарплатыВБухучете,
	|	СтраховыеВзносы.СтатьяРасходов КАК СтатьяРасходов,
	|	СтраховыеВзносы.СтатьяФинансирования КАК СтатьяФинансирования,
	|	СтраховыеВзносы.Период КАК Период,
	|	СтраховыеВзносы.Организация КАК Организация,
	|	СтраховыеВзносы.ФизическоеЛицо КАК ФизическоеЛицо,
	|	СтраховыеВзносы.ОблагаетсяЕНВД КАК ОблагаетсяЕНВД,
	|	СтраховыеВзносы.ДатаНачала КАК ДатаНачала,
	|	&СуммыИзРегистра КАК СуммыИзРегистра
	|ПОМЕСТИТЬ ВТВзносы
	|ИЗ
	|	РегистрНакопления.СтраховыеВзносыПоФизическимЛицам КАК СтраховыеВзносы
	|ГДЕ
	|	СтраховыеВзносы.Период = &ПериодРегистрации
	|	И СтраховыеВзносы.Сотрудник В(&Сотрудники)
	|	И СтраховыеВзносы.Регистратор <> &ИсключаемыйРегистратор
	|	И &Условие";
	
	СуммыИзРегистра = УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина, "СтраховыеВзносы");
	Условие = СтрЗаменить(УчетСтраховыхВзносов.ОтражаемыеВУчетеВзносы(Истина, "СтраховыеВзносы"), ",", " <> 0 ИЛИ ") + " <> 0";
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&СуммыИзРегистра КАК СуммыИзРегистра", СуммыИзРегистра);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Условие", "("+Условие+")");
	
	Запрос.Выполнить();

КонецПроцедуры 


#КонецОбласти

#КонецЕсли