#Область ПрограммныйИнтерфейс

#Область ОбработчикиСобытийМодуляОбъекта

// Инициализировать документ
//
// Параметры:
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//  ДанныеЗаполнения - Структура - данные заполнения.
//
Процедура ИнициализироватьДокументМаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения = Неопределено) Экспорт
	
	ДокументОбъект.Склад         = ЗначениеНастроекПовтИсп.ПолучитьСкладПоУмолчанию(ДокументОбъект.Склад);
	ДокументОбъект.Организация   = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОбъект.Организация);
	ДокументОбъект.Ответственный = Пользователи.ТекущийПользователь();
	ДокументОбъект.Подразделение = ЗначениеНастроекПовтИсп.ПодразделениеПользователя(ДокументОбъект.Ответственный, ДокументОбъект.Подразделение);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ДокументОбъект.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = ОперацияМаркировкиПоУмолчанию(ДокументОбъект.ОперацияМаркировки);
	
КонецПроцедуры

// Обработка заполнения маркировка товаров
//
// Параметры:
//  ДанныеЗаполнения	 - Структура - данные заполнения.
//  СтандартнаяОбработка - Булево - стандартная обработка.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаЗаполненияМаркировкаТоваров(ДанныеЗаполнения, СтандартнаяОбработка, ДокументОбъект) Экспорт
	
	ТипДанныхЗаполнения = ТипЗнч(ДанныеЗаполнения);
	
	Если ТипДанныхЗаполнения = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
		
		ЗаполнитьМаркировкуТоваровПоВозвратуТоваровОтКлиента(ДанныеЗаполнения, ДокументОбъект);
		
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
		
		ЗаполнитьМаркировкуТоваровПоПоступлениюТоваровУслуг(ДанныеЗаполнения, ДокументОбъект);
		
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.УведомлениеОбИмпортеМаркированныхТоваровГИСМ") Тогда
		
		ЗаполнитьМаркировкуТоваровПоУведомлениюОбИмпортеМаркированныхТоваровГИСМ(ДанныеЗаполнения, ДокументОбъект);
		
	//++ НЕ УТ
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.ВыпускПродукции") Тогда
		
		ЗаполнитьМаркировкуТоваровПоВыпускуПродукции(ДанныеЗаполнения, ДокументОбъект);
		
	//-- НЕ УТ
	//++ НЕ УТКА
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.МаршрутныйЛистПроизводства") Тогда
		
		ЗаполнитьМаркировкуТоваровПоМаршрутномуЛистуПроизводства(ДанныеЗаполнения, ДокументОбъект);
		
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.ДвижениеПродукцииИМатериалов") Тогда
		
		ЗаполнитьМаркировкуТоваровПоДвижениюПродукцииИМатериалов(ДанныеЗаполнения, ДокументОбъект);
		
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.ПроизводствоБезЗаказа") Тогда
		
		ЗаполнитьМаркировкуТоваровПоПроизводствуБезЗаказа(ДанныеЗаполнения, ДокументОбъект);
		
	ИначеЕсли ТипДанныхЗаполнения = Тип("ДокументСсылка.ЭтапПроизводства2_2") Тогда
		
		ЗаполнитьМаркировкуТоваровПоЭтапуПроизводства2_2(ДанныеЗаполнения, ДокументОбъект);
		
	//-- НЕ УТКА
	КонецЕсли;
	
	ИнициализироватьДокументМаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения);
	
КонецПроцедуры

// Обработка проверки заполнения маркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  ПроверяемыеРеквизиты			 - Массив - массив проверяемых реквизитов.
//  МассивНепроверяемыхРеквизитов	 - Массив - массив непроверяемых реквизитов.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроверкиЗаполненияМаркировкаТоваров(Отказ, ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов, ДокументОбъект) Экспорт
	
	Перем МассивВсехРеквизитов;
	Перем МассивРеквизитовОперации;
	
	ПолучитьМассивыРеквизитовМаркировкиТоваров(
		ДокументОбъект.ОперацияМаркировки,
		МассивВсехРеквизитов,
		МассивРеквизитовОперации);
	
	ОбщегоНазначенияУТКлиентСервер.ЗаполнитьМассивНепроверяемыхРеквизитов(
		МассивВсехРеквизитов,
		МассивРеквизитовОперации,
		МассивНепроверяемыхРеквизитов);
		
	ТекущаяДеятельность = Справочники.Организации.ЗакупкаПодДеятельность(
		ДокументОбъект.Организация,
		ДокументОбъект.Склад,
		ДокументОбъект.Дата);
	
	Если Не ТекущаяДеятельность = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию Тогда
		МассивНепроверяемыхРеквизитов.Добавить("МаркировкаДляДеятельности");
	ИначеЕсли ДокументОбъект.ОперацияМаркировки <> Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции
		И ДокументОбъект.ОперацияМаркировки <> Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированныхПриИмпортеТоваров Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА КАК ЕстьНеРаспределяемые
		|ИЗ
		|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
		|ГДЕ
		|	Т.ВариантРаздельногоУчетаНДС <> &Распределение
		|	И Т.Ссылка В(&Ссылка)");
		Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.СтатьяРасходов);
		Запрос.УстановитьПараметр("Распределение", Перечисления.ВариантыРаздельногоУчетаНДС.Распределение);
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Не (Выборка.Следующий() И Выборка.ЕстьНеРаспределяемые = Истина) Тогда
			МассивНепроверяемыхРеквизитов.Добавить("МаркировкаДляДеятельности");
		КонецЕсли;
		
	КонецЕсли;
	
	// Проверка характеристик в табличной части Товары и в шапке документа.
	ПараметрыПроверки = НоменклатураСервер.ПараметрыПроверкиЗаполненияХарактеристик();
	ПараметрыПроверки.СуффиксДопРеквизита = "КиЗ";
	НоменклатураСервер.ПроверитьЗаполнениеХарактеристик(ДокументОбъект, МассивНепроверяемыхРеквизитов, Отказ);
	НоменклатураСервер.ПроверитьЗаполнениеХарактеристик(ДокументОбъект, МассивНепроверяемыхРеквизитов, Отказ, ПараметрыПроверки);
	
	Для каждого СтрТабл из ДокументОбъект.Товары Цикл
		Если СтрТабл.СтатусУказанияСерий = 0 Тогда
			ТекстСообщения = НСтр("ru = 'Для товара %Товар% не настроено указание серий на складе %Склад%.'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Товар%", НоменклатураКлиентСервер.ПредставлениеНоменклатуры(СтрТабл.Номенклатура, СтрТабл.Характеристика));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Склад%", ДокументОбъект.Склад);
			Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти("Товары", СтрТабл.НомерСтроки, "Номенклатура");
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);
		КонецЕсли;
	КонецЦикла;	
			
	// Проверка заполнения серий в т.ч. серии.
	НоменклатураСервер.ПроверитьЗаполнениеСерий(
		ДокументОбъект,
		НоменклатураСервер.ПараметрыУказанияСерий(ДокументОбъект, Документы.МаркировкаТоваровГИСМ),
		Отказ,
		МассивНепроверяемыхРеквизитов);
		
	ПланыВидовХарактеристик.СтатьиРасходов.ПроверитьЗаполнениеАналитик(
		ДокументОбъект,
		"СтатьяРасходов, АналитикаРасходов",
		МассивНепроверяемыхРеквизитов,
		Отказ);
		
	ПодразделениеОбязательно = ПолучитьФункциональнуюОпцию("ИспользоватьПроизводство")
		Или ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоПодразделениямМенеджерам");
	
	Если Не ПодразделениеОбязательно Тогда
		МассивНепроверяемыхРеквизитов.Добавить("Подразделение");
	КонецЕсли;
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьУчетЗатратПоНаправлениямДеятельности") Тогда
		МассивНепроверяемыхРеквизитов.Добавить("НаправлениеДеятельности");
	КонецЕсли;
	
КонецПроцедуры

// Перед записью маркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  РежимЗаписи						 - РежимЗаписи - Режим записи документа.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПередЗаписьюМаркировкаТоваров(Отказ, РежимЗаписи, РежимПроведения, ДокументОбъект) Экспорт
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ДокументОбъект);
	
	ПроведениеСерверУТ.УстановитьРежимПроведения(ДокументОбъект, РежимЗаписи, РежимПроведения);
	
	ДокументОбъект.ДополнительныеСвойства.Вставить("ЭтоНовый",    ДокументОбъект.ЭтоНовый());
	ДокументОбъект.ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписи);
	
	НоменклатураСервер.ОчиститьНеиспользуемыеСерии(ДокументОбъект, 
													НоменклатураСервер.ПараметрыУказанияСерий(ДокументОбъект, Документы.МаркировкаТоваровГИСМ));
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		МестаУчета = РегистрыСведений.АналитикаУчетаНоменклатуры.МестаУчета(
			Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию,
			ДокументОбъект.Склад,
			ДокументОбъект.Подразделение,
			Неопределено);
		ИменаПолей = РегистрыСведений.АналитикаУчетаНоменклатуры.ИменаПолейКоллекцииПоУмолчанию();
		ИменаПолей.Номенклатура = "НоменклатураКиЗ";
		ИменаПолей.Характеристика = "ХарактеристикаКиЗ";
		ИменаПолей.Серия = "";
		ИменаПолей.СтатусУказанияСерий = "";
		ИменаПолей.Вставить("Назначение", Новый Структура("ТекстПоля,Значение","&Назначение",ДокументОбъект.НазначениеКиЗ));
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокументОбъект.Товары, МестаУчета, ИменаПолей);
		
		ВзаиморасчетыСервер.ЗаполнитьИдентификаторыСтрокВТабличнойЧасти(ДокументОбъект.Товары);
		ЗаполнитьВидыЗапасов(ДокументОбъект, Отказ, "МаркировкаТоваровГИСМ");
		ПроверитьЗаполнитьСерииКиЗ(ДокументОбъект, Отказ);
	ИначеЕсли РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения Тогда
		Если Не ДокументОбъект.ВидыЗапасовУказаныВручную Тогда
			ДокументОбъект.ВидыЗапасов.Очистить();
		КонецЕсли;
		ДокументОбъект.СерииКиЗ.Очистить();
	КонецЕсли;
	
КонецПроцедуры

// При копировании документа маркировка товаров.
//
// Параметры:
//  ОбъектКопирования - см. описание параметра в синтаксис-помощнике к обработчику "ПриКопировании".
//  ДокументОбъект    - ДокументОбъект.МаркировкаТоваров - обрабатываемый документ.
//
Процедура ПриКопированииМаркировкаТоваров(ОбъектКопирования, ДокументОбъект) Экспорт
	
	ДокументОбъект.Основание = Неопределено;
	
	ДокументОбъект.Серии.Очистить();
	ДокументОбъект.СерииКиЗ.Очистить();
	
	УчетНДСУТ.ПроверитьКорректностьДеятельностиНДСПотребления(
		ДокументОбъект.МаркировкаДляДеятельности, 
		ДокументОбъект.Организация,
		ДокументОбъект.Дата,
		Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию);
	
	ИнициализироватьДокументМаркировкаТоваров(ДокументОбъект);
	
КонецПроцедуры

// Процедура - Обработка проведения маркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроведенияМаркировкаТоваров(Отказ, РежимПроведения, ДокументОбъект) Экспорт
	
	Ссылка = ДокументОбъект.Ссылка;
	ДополнительныеСвойства = ДокументОбъект.ДополнительныеСвойства;
	Движения =  ДокументОбъект.Движения;
	
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства, РежимПроведения);
	ИнициализироватьДанныеДокументаМаркировкаТоваров(Ссылка, ДополнительныеСвойства);
	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ДокументОбъект);
	
	ЗапасыСервер.ОтразитьСвободныеОстатки(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьОбеспечениеЗаказов(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыНаСкладах(ДополнительныеСвойства, Движения, Отказ);
	СкладыСервер.ОтразитьДвиженияСерийТоваров(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыОрганизаций(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыОрганизацийКПередаче(ДополнительныеСвойства, Движения, Отказ);
	ДоходыИРасходыСервер.ОтразитьСебестоимостьТоваров(ДополнительныеСвойства, Движения, Отказ);
	
	// Движения по оборотным регистрам управленческого учета
	УправленческийУчетПроведениеСервер.ОтразитьДвиженияНоменклатураДоходыРасходы(ДополнительныеСвойства, Движения, Отказ);
	
	//++ НЕ УТ
	РеглУчетПроведениеСервер.ЗарегистрироватьКОтражению(ДокументОбъект, ДополнительныеСвойства, Движения, Отказ);
	РеглУчетПроведениеСервер.ОтразитьПорядокОтраженияПрочихОпераций(ДополнительныеСвойства, Отказ);
	//-- НЕ УТ
	
	СформироватьСписокРегистровДляКонтроляМаркировкаТоваров(ДокументОбъект);
	
	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ДокументОбъект);
	//++ НЕ УТКА
	МеждународныйУчетПроведениеСервер.ЗарегистрироватьКОтражению(ДокументОбъект, ДополнительныеСвойства, Движения, Отказ);
	//-- НЕ УТКА
	ПроведениеСерверУТ.ВыполнитьКонтрольРезультатовПроведения(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.ЗаписатьПодчиненныеНаборамЗаписейДанные(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ДокументОбъект);
	
	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДополнительныеСвойства);
	
КонецПроцедуры

// Обработка удаления проведения маркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаУдаленияПроведенияМаркировкаТоваров(Отказ, ДокументОбъект) Экспорт
	
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(ДокументОбъект.Ссылка, ДокументОбъект.ДополнительныеСвойства);
	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ДокументОбъект);
	
	СформироватьСписокРегистровДляКонтроляМаркировкаТоваров(ДокументОбъект);
	
	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ДокументОбъект);
	ПроведениеСерверУТ.ВыполнитьКонтрольРезультатовПроведения(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.ЗаписатьПодчиненныеНаборамЗаписейДанные(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ДокументОбъект);
	
	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДокументОбъект.ДополнительныеСвойства);
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыИФункцииФормыДокумента

// Заполняет номенклатуру КиЗ в строке документа
//
// Параметры:
//  ТекущаяСтрока				 - ТекущаяСтрока - текущая строка таблицы Товары/
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  КиЗГИСМСИндивидуализацией	 - Булево - Признак получения КиЗ по GTIN или без GTIN.
//
Процедура ЗаполнитьНоменклатуруКиЗВСтроке(ТекущаяСтрока, СписокНоменклатураКиЗ, КиЗГИСМСИндивидуализацией) Экспорт
	
	GTIN = ?(КиЗГИСМСИндивидуализацией, ТекущаяСтрока.GTIN, "");
	ТаблицаРезультат = ПолучитьКизы(СписокНоменклатураКиЗ, GTIN);
	
	Если ТаблицаРезультат.Количество() = 1 Тогда
		СтрокаРезультат = ТаблицаРезультат.Получить(0);
		ТекущаяСтрока.НоменклатураКиЗ = СтрокаРезультат.НоменклатураКиЗ;
		ТекущаяСтрока.ХарактеристикаКиЗ = СтрокаРезультат.ХарактеристикаКиЗ;
		ТекущаяСтрока.ХарактеристикиКизИспользуются = СтрокаРезультат.ХарактеристикиКизИспользуются;
	ИначеЕсли ТаблицаРезультат.Количество() = 0 Тогда
		ТекущаяСтрока.НоменклатураКиЗ = Неопределено;
		ТекущаяСтрока.ХарактеристикаКиЗ = Неопределено;
		ТекущаяСтрока.ХарактеристикиКизИспользуются = Ложь;
	КонецЕсли;
	
КонецПроцедуры

// Заполняет номенклатуру КиЗ в строках документа
//
// Параметры:
//  Объект				 		 - ДокументОбъект.* - текущая строка таблицы Товары.
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  ЗаполнятьСерии				 - Булево - Признак заполнения серий в ТЧ Серии.
//
Процедура ЗаполнитьНоменклатуруКиЗВСтроках(ДокументОбъект, СписокНоменклатураКиЗ, ЗаполнятьСерии = Истина) Экспорт
	
	GTIN = ?(ДокументОбъект.КиЗГИСМСИндивидуализацией, ДокументОбъект.Товары.Выгрузить(,"GTIN").ВыгрузитьКолонку("GTIN"),"");
	ТаблицаРезультат = ПолучитьКизы(СписокНоменклатураКиЗ, GTIN);
	
	СтруктураПоиска = Новый Структура("GTIN","");
	Для каждого СтрокаТовары Из ДокументОбъект.Товары Цикл
		
		Если ДокументОбъект.КиЗГИСМСИндивидуализацией Тогда
			ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаТовары);
		КонецЕсли;
		НайденныеСтроки = ТаблицаРезультат.НайтиСтроки(СтруктураПоиска);
		Если НайденныеСтроки.Количество() = 1 Тогда
			НайденнаяСтрока = НайденныеСтроки.Получить(0);
			СтрокаТовары.НоменклатураКиЗ = НайденнаяСтрока.НоменклатураКиЗ;
			СтрокаТовары.ХарактеристикаКиЗ = НайденнаяСтрока.ХарактеристикаКиЗ;
			СтрокаТовары.ХарактеристикиКизИспользуются = НайденнаяСтрока.ХарактеристикиКизИспользуются;
		ИначеЕсли НайденныеСтроки.Количество() = 0 Тогда
			СтрокаТовары.НоменклатураКиЗ = Неопределено;
			СтрокаТовары.ХарактеристикаКиЗ = Неопределено;
			СтрокаТовары.ХарактеристикиКизИспользуются = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Если ЗаполнятьСерии Тогда
		Для каждого СтрокаСерии Из ДокументОбъект.Серии Цикл
			Если ДокументОбъект.КиЗГИСМСИндивидуализацией Тогда
				ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаСерии);
			КонецЕсли;
			НайденныеСтроки = ТаблицаРезультат.НайтиСтроки(СтруктураПоиска);
			Если НайденныеСтроки.Количество() = 1 Тогда
				НайденнаяСтрока = НайденныеСтроки.Получить(0);
				СтрокаСерии.НоменклатураКиЗ = НайденнаяСтрока.НоменклатураКиЗ;
				СтрокаСерии.ХарактеристикаКиЗ = НайденнаяСтрока.ХарактеристикаКиЗ;
			ИначеЕсли НайденныеСтроки.Количество() = 0 Тогда
				СтрокаСерии.НоменклатураКиЗ = Неопределено;
				СтрокаСерии.ХарактеристикаКиЗ = Неопределено;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

// Заполняет список КиЗ, подходящих для заполнения документ по выбранным категориям КиЗ.
//
// Параметры:
//  Объект				 		 - ДокументОбъект.* - текущая строка таблицы Товары.
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//
Процедура ПолучитьКиЗДляЗаполнения(ДокументОбъект, СписокНоменклатураКиЗ) Экспорт
	
	СписокНоменклатураКиЗ.Очистить();
	
	Если НЕ ЗначениеЗаполнено(ДокументОбъект.КиЗГИСМВид)
		И НЕ ЗначениеЗаполнено(ДокументОбъект.КиЗГИСМРазмер)
		И НЕ ЗначениеЗаполнено(ДокументОбъект.КиЗГИСМСпособВыпускаВОборот) Тогда
		
		Возврат
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК НоменклатураКиЗ
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.КиЗГИСМВид = &КиЗГИСМВид
	|	И Номенклатура.КиЗГИСМСпособВыпускаВОборот = &КиЗГИСМСпособВыпускаВОборот
	|	И Номенклатура.КиЗГИСМРазмер = &КиЗГИСМРазмер
	|	И НЕ Номенклатура.ПометкаУдаления
	|	И ВЫБОР
	|			КОГДА &КиЗГИСМСИндивидуализацией = ЛОЖЬ
	|					И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.НеИспользовать)
	|					И Номенклатура.КиЗГИСМGTIN ПОДОБНО """"
	|				ТОГДА ИСТИНА
	|			КОГДА (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
	|					ИЛИ Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
	|					ИЛИ Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
	|					ИЛИ НЕ Номенклатура.КиЗГИСМGTIN ПОДОБНО """")
	|					И &КиЗГИСМСИндивидуализацией = ИСТИНА
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("КиЗГИСМВид",                  ДокументОбъект.КиЗГИСМВид);
	Запрос.УстановитьПараметр("КиЗГИСМРазмер",               ДокументОбъект.КиЗГИСМРазмер);
	Запрос.УстановитьПараметр("КиЗГИСМСпособВыпускаВОборот", ДокументОбъект.КиЗГИСМСпособВыпускаВОборот);
	Запрос.УстановитьПараметр("КиЗГИСМСИндивидуализацией",   ДокументОбъект.КиЗГИСМСИндивидуализацией);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СписокНоменклатураКиЗ.Добавить(Выборка.НоменклатураКиЗ);
	КонецЦикла;
	
КонецПроцедуры

// Заполняет GTINВСтроках
//
// Параметры:
//  ДокументОбъект	 - ДокументОбъект. - Документ для заполнения GTIN
//
Процедура ЗаполнитьGTINВСтроках(ДокументОбъект) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Товары.Номенклатура,
	|	Товары.Характеристика
	|ПОМЕСТИТЬ ВтТовары
	|ИЗ
	|	&Товары КАК Товары;
	|
	|ВЫБРАТЬ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК GTIN
	|ИЗ
	|	ВтТовары КАК Товары
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|		ПО ШтрихкодыНоменклатуры.Номенклатура = Товары.Номенклатура
	|			И ШтрихкодыНоменклатуры.Характеристика = Товары.Характеристика");
	
	Запрос.УстановитьПараметр("Товары", ДокументОбъект.Товары.Выгрузить());
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат
	КонецЕсли;
	
	ТаблицаРезультат = Запрос.Выполнить().Выгрузить();
	СтруктураПоиска = Новый Структура("Номенклатура, Характеристика");
	МассивGTIN = Новый Массив;
	Для каждого СтрокаТовары Из ДокументОбъект.Товары Цикл
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаТовары);
		НайденныеСтроки = ТаблицаРезультат.НайтиСтроки(СтруктураПоиска);
		Если НайденныеСтроки.Количество() = 0 Тогда
			Продолжить;
		ИначеЕсли НайденныеСтроки.Количество() = 1
			И МенеджерОборудованияКлиентСервер.ПроверитьКорректностьGTIN(НайденныеСтроки[0].GTIN) Тогда
			
			СтрокаТовары.GTIN = НайденныеСтроки[0].GTIN;
			
		Иначе
			МассивGTIN.Очистить();
			Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				Если МенеджерОборудованияКлиентСервер.ПроверитьКорректностьGTIN(НайденнаяСтрока.GTIN) Тогда
					МассивGTIN.Добавить(НайденнаяСтрока.GTIN);
				КонецЕсли;
			КонецЦикла;
			Если МассивGTIN.Количество() = 1 Тогда
				СтрокаТовары.GTIN = МассивGTIN.Получить(0);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Обработчик Категория КиЗ при изменении
//
// Параметры:
//  ДокументОбъект			 - ДокументОбъект.* - обрабатываемый документ.
//  СписокНоменклатураКиЗ	 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  ЗаполнятьСерии			 - Булево - Признак заполнения серий в ТЧ Серии.
//
Процедура КатегорияКиЗПриИзменении(ДокументОбъект, СписокНоменклатураКиЗ, ЗаполнятьСерии=Истина) Экспорт
	МаркировкаТоваровГИСМУТ.ПолучитьКиЗДляЗаполнения(ДокументОбъект, СписокНоменклатураКиЗ);
	МаркировкаТоваровГИСМУТ.ЗаполнитьНоменклатуруКиЗВСтроках(ДокументОбъект, СписокНоменклатураКиЗ, ЗаполнятьСерии);
КонецПроцедуры

// Заполняет списки выбора реквизитов шапки.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма документа
//
Процедура ЗаполнитьСпискиВыбораРеквизитовШапки(Форма) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМВид
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМСпособВыпускаВОборот
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМРазмер
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ";
		
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	
	ВыборкаКиЗГИСМВид = ПакетРезультатов[0].Выбрать();
	ВыборкаКиЗГИСМСпособВыпускаВОборот = ПакетРезультатов[1].Выбрать();
	ВыборкаКиЗГИСМРазмер = ПакетРезультатов[2].Выбрать();
	
	Форма.Элементы.КиЗГИСМВид.СписокВыбора.Очистить();
	Форма.Элементы.КиЗГИСМРазмер.СписокВыбора.Очистить();
	Форма.Элементы.КиЗГИСМСпособВыпускаВОборот.СписокВыбора.Очистить();
	
	Пока ВыборкаКиЗГИСМВид.Следующий() Цикл
		Форма.Элементы.КиЗГИСМВид.СписокВыбора.Добавить(ВыборкаКиЗГИСМВид.КиЗГИСМВид);
	КонецЦикла;
	Если ВыборкаКиЗГИСМВид.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМВид = ВыборкаКиЗГИСМВид.КиЗГИСМВид;
	КонецЕсли;
	
	Пока ВыборкаКиЗГИСМРазмер.Следующий() Цикл
		Форма.Элементы.КиЗГИСМРазмер.СписокВыбора.Добавить(ВыборкаКиЗГИСМРазмер.КиЗГИСМРазмер);
	КонецЦикла;
	Если ВыборкаКиЗГИСМРазмер.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМРазмер = ВыборкаКиЗГИСМРазмер.КиЗГИСМРазмер;
	КонецЕсли;
	
	Пока ВыборкаКиЗГИСМСпособВыпускаВОборот.Следующий() Цикл
		Форма.Элементы.КиЗГИСМСпособВыпускаВОборот.СписокВыбора.Добавить(ВыборкаКиЗГИСМСпособВыпускаВОборот.КиЗГИСМСпособВыпускаВОборот);
	КонецЦикла;
	Если ВыборкаКиЗГИСМСпособВыпускаВОборот.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМСпособВыпускаВОборот = ВыборкаКиЗГИСМСпособВыпускаВОборот.КиЗГИСМСпособВыпускаВОборот;
	КонецЕсли;
	
	Форма.Элементы.ОперацияМаркировки.СписокВыбора.Очистить();
	Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции);
	Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированныхПриИмпортеТоваров);
	
	Если ВыборкаКиЗГИСМВид.Количество() > 0 И ВыборкаКиЗГИСМРазмер.Количество() > 0 И ВыборкаКиЗГИСМСпособВыпускаВОборот.Количество() > 0 Тогда
		Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.МаркировкаОстатковНа12082016);
		Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводство") Тогда
			Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции);
		КонецЕсли;
		Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.МаркировкаТоваровВозвращенныхПокупателем);
		Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.МаркировкаТоваровПринятыхНаКомиссию);
		Если ПолучитьФункциональнуюОпцию("ИспользоватьИмпортныеЗакупки") Тогда
			Форма.Элементы.ОперацияМаркировки.СписокВыбора.Добавить(Перечисления.ОперацииМаркировкиГИСМ.МаркировкаИмпортированныхТоваров);
		КонецЕсли;
	КонецЕсли;
	
	Если Форма.Элементы.ОперацияМаркировки.СписокВыбора.НайтиПоЗначению(Форма.Объект.ОперацияМаркировки) = Неопределено Тогда
		
		ВызватьИсключение НСтр("ru='Выбранная операция маркировки отличается от доступных для выбора операций маркировки'");
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункциииФормыДокумента

// Заполняет служебные реквизиты табличной части
//
// Параметры:
//  Товары	 - ТаблицаФормы - ТЧ Товары документа.
//
Процедура ЗаполнитьСлужебныеРеквизитыТабличнойЧасти(Товары) Экспорт
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются", Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	ОбработкаТабличнойЧастиСервер.ОбработатьТЧ(Товары, СтруктураДействий, Неопределено);
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются", Новый Структура("НоменклатураКиЗ", "ХарактеристикиКиЗИспользуются"));
	ОбработкаТабличнойЧастиСервер.ОбработатьТЧ(Товары, СтруктураДействий, Неопределено);
	
КонецПроцедуры

// Процедура - Обновить контроль заполнения аналитики расходов
//
// Параметры:
//  СтатьяРасходов				 - ПланВидовХарактеристикСсылка.СтатьиРасходов - Статья расходов.
//  АналитикаРасходов			 - Характеристика.СтатьиРасходов - аналитика расходов
//  АналитикаРасходовОбязательна - Булево - признак обязательности аналитики.
//
Процедура ОбновитьКонтрольЗаполненияАналитикиРасходов(СтатьяРасходов, АналитикаРасходов, АналитикаРасходовОбязательна) Экспорт
	
	СтруктураДействий = Новый Структура("ЗаполнитьПризнакАналитикаРасходовОбязательна");
	
	ДанныеОбъекта = Новый Структура;
	ДанныеОбъекта.Вставить("СтатьяРасходов", СтатьяРасходов);
	ДанныеОбъекта.Вставить("АналитикаРасходов", АналитикаРасходов);
	ДанныеОбъекта.Вставить("АналитикаРасходовОбязательна", АналитикаРасходовОбязательна);
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ДанныеОбъекта, СтруктураДействий, Неопределено);
	
	АналитикаРасходовОбязательна = ДанныеОбъекта.АналитикаРасходовОбязательна;
	
КонецПроцедуры

// Заполняет реквизит маркировка под деятельность
//
// Параметры:
//  Объект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ЗаполнитьМаркировкаПодДеятельность(Объект) Экспорт
	
	Если Справочники.Организации.РозничнаяТорговляОблагаетсяЕНВД(Объект.Организация, Объект.Склад, Объект.Дата) Тогда
		Объект.МаркировкаДляДеятельности = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД;
	Иначе
		Объект.МаркировкаДляДеятельности = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
	КонецЕсли;
	
КонецПроцедуры

// Проверяет что все статьи распределяются
//
// Параметры:
//  СтатьяРасходов				 - ПланВидовХарактеристикСсылка.СтатьиРасходов - Статья расходов.
//  ВсеСтатьиРаспределяются		 - Булево - признак распределния статей.
//  УчетНДСПоФактИспользованию	 - Булево - признак учета НДС по факт использованию.
//  ОперацияИдентификации		 - Булево - признак, что в документе выбрана операция идентификации.
//
Процедура ПроверитьЧтоВсеСтатьиРаспределяются(СтатьяРасходов, ВсеСтатьиРаспределяются, УчетНДСПоФактИспользованию, ОперацияИдентификации = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ПВХ.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РаспределениеНДС
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК ПВХ
	|ГДЕ
	|	ПВХ.Ссылка = &СтатьяРасходов";
	
	Запрос.УстановитьПараметр("СтатьяРасходов", СтатьяРасходов);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	Выборка.Следующий();
	УстановитьПривилегированныйРежим(Ложь);
	
	ВсеСтатьиРаспределяются = 
		НЕ ОперацияИдентификации
		И УчетНДСПоФактИспользованию
		И ?(ЗначениеЗаполнено(Выборка.РаспределениеНДС), Выборка.РаспределениеНДС, Ложь);
	
КонецПроцедуры

// Функция - Обновить учет НДСПо фактическому использованию
//
// Параметры:
//  Организация	 - СправочникСсылка.Организации - Организация документа.
//  Склад		 - СправочникСсылка.Склад - Склад документа.
//  Дата		 - Дата - Дата документа.
// 
// Возвращаемое значение:
//  Булево - признак учета НДС по факт использованию
//
Функция ОбновитьУчетНДСПоФактическомуИспользованию(Организация, Склад, Дата) Экспорт
	
	ТекущаяДеятельность = Справочники.Организации.ЗакупкаПодДеятельность(
		Организация,
		Склад,
		Дата);
	
	Возврат (ТекущаяДеятельность = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию);
	
КонецФункции

// Устанавливает параметры выбора статьи расходов.
//
// Параметры:
//  ЭлементСтатьяРасходов	 - ЭлементФормы - элемент формы со статьей расходов.
//
Процедура УстановитьПараметрыВыбораСтатьи(ЭлементСтатьяРасходов) Экспорт
	
	ПараметрыВыбораСтатьи = Новый Массив;
	ПараметрыВыбораСтатьи.Добавить(Новый ПараметрВыбора("ДополнитьСтатьямиРасходов", Истина));
	ПараметрыВыбораСтатьи.Добавить(Новый ПараметрВыбора("ДополнитьСтатьямиАктивовПассивов", Истина));
	ПараметрыВыбораСтатьи.Добавить(Новый ПараметрВыбора("Отбор.ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию));
	
	МассивВариантов = Новый Массив;
	МассивВариантов.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаНаправленияДеятельности);
	МассивВариантов.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаРасходыБудущихПериодов);
	МассивВариантов.Добавить(Перечисления.ВариантыРаспределенияРасходов.НеРаспределять);
	
	ПараметрыВыбораСтатьи.Добавить(Новый ПараметрВыбора("Отбор.ВариантРаспределенияРасходов", Новый ФиксированныйМассив(МассивВариантов)));
	
	ЭлементСтатьяРасходов.ПараметрыВыбора = Новый ФиксированныйМассив(ПараметрыВыбораСтатьи)
	
КонецПроцедуры

// Управляет доступностью элементов формы
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма документа.
//
Процедура УправлениеДоступностью(Форма) Экспорт
	
	ОперацияИдентификации = Форма.ОперацияИдентификации;
	
	Форма.Элементы.НаправлениеДеятельности.Видимость = НЕ ОперацияИдентификации;
	Форма.Элементы.МаркировкаДляДеятельности.Видимость = НЕ ОперацияИдентификации;
	Форма.Элементы.СтатьяРасходов.Видимость = НЕ ОперацияИдентификации;
	Форма.Элементы.АналитикаРасходов.Видимость = НЕ ОперацияИдентификации;
	
	Форма.Элементы.АналитикаРасходов.ТолькоПросмотр = Не ЗначениеЗаполнено(Форма.Объект.СтатьяРасходов);
	МаркировкаТоваровГИСМ.УправлениеДоступностью(Форма);
	
КонецПроцедуры

#КонецОбласти

#Область ПеремаркировкаТоваров

#Область ОбработчикиСобытийМодуляОбъекта

// Инициализировать документ
//
// Параметры:
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//  ДанныеЗаполнения - Структура - данные заполнения.
//
Процедура ИнициализироватьДокументПеремаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения = Неопределено) Экспорт
	
	ДокументОбъект.Склад         = ЗначениеНастроекПовтИсп.ПолучитьСкладПоУмолчанию(ДокументОбъект.Склад);
	ДокументОбъект.Организация   = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(ДокументОбъект.Организация);
	ДокументОбъект.Подразделение = ЗначениеНастроекПовтИсп.ПодразделениеПользователя(ДокументОбъект.Ответственный, ДокументОбъект.Подразделение);
	ДокументОбъект.Ответственный = Пользователи.ТекущийПользователь();
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ДокументОбъект.НаправлениеДеятельности);
	
КонецПроцедуры

// Обработка заполнения перемаркировка товаров
//
// Параметры:
//  ДанныеЗаполнения	 - Структура - данные заполнения.
//  СтандартнаяОбработка - Булево - стандартная обработка.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаЗаполненияПеремаркировкаТоваров(ДанныеЗаполнения, СтандартнаяОбработка, ДокументОбъект) Экспорт
	
	ИнициализироватьДокументПеремаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения);
	
КонецПроцедуры

// Обработка проверки заполнения перемаркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  ПроверяемыеРеквизиты			 - Массив - массив проверяемых реквизитов.
//  МассивНепроверяемыхРеквизитов	 - Массив - массив непроверяемых реквизитов.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроверкиЗаполненияПеремаркировкаТоваров(Отказ, ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов, ДокументОбъект) Экспорт
	
	ТекущаяДеятельность = Справочники.Организации.ЗакупкаПодДеятельность(
		ДокументОбъект.Организация,
		ДокументОбъект.Склад,
		ДокументОбъект.Дата);
	
	Если Не ТекущаяДеятельность = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию Тогда
		МассивНепроверяемыхРеквизитов.Добавить("МаркировкаДляДеятельности");
	Иначе
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИСТИНА КАК ЕстьНеРаспределяемые
		|ИЗ
		|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
		|ГДЕ
		|	Т.ВариантРаздельногоУчетаНДС <> &Распределение
		|	И Т.Ссылка В(&Ссылка)");
		Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.СтатьяРасходов);
		Запрос.УстановитьПараметр("Распределение", Перечисления.ВариантыРаздельногоУчетаНДС.Распределение);
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Не (Выборка.Следующий() И Выборка.ЕстьНеРаспределяемые = Истина) Тогда
			МассивНепроверяемыхРеквизитов.Добавить("МаркировкаДляДеятельности");
		КонецЕсли;
		
	КонецЕсли;
	
	// Проверка характеристик в табличной части Товары и в шапке документа.
	ПараметрыПроверки = НоменклатураСервер.ПараметрыПроверкиЗаполненияХарактеристик();
	ПараметрыПроверки.СуффиксДопРеквизита = "КиЗ";
	НоменклатураСервер.ПроверитьЗаполнениеХарактеристик(ДокументОбъект, МассивНепроверяемыхРеквизитов, Отказ);
	НоменклатураСервер.ПроверитьЗаполнениеХарактеристик(ДокументОбъект, МассивНепроверяемыхРеквизитов, Отказ, ПараметрыПроверки);
	
	Для каждого СтрТабл из ДокументОбъект.Товары Цикл
		Если СтрТабл.СтатусУказанияСерий = 0 Тогда
			ТекстСообщения = НСтр("ru = 'Для товара %Товар% не настроено указание серий на складе %Склад%.'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Товар%", НоменклатураКлиентСервер.ПредставлениеНоменклатуры(СтрТабл.Номенклатура, СтрТабл.Характеристика));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Склад%", ДокументОбъект.Склад);
			Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти("Товары", СтрТабл.НомерСтроки, "Номенклатура");
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);
		КонецЕсли;
	КонецЦикла;	
			
	// Проверка заполнения серий, в т.ч. серии.
	НоменклатураСервер.ПроверитьЗаполнениеСерий(
		ДокументОбъект,
		НоменклатураСервер.ПараметрыУказанияСерий(ДокументОбъект, Документы.ПеремаркировкаТоваровГИСМ),
		Отказ,
		МассивНепроверяемыхРеквизитов);
		
	ПланыВидовХарактеристик.СтатьиРасходов.ПроверитьЗаполнениеАналитик(
		ДокументОбъект,
		"СтатьяРасходов, АналитикаРасходов",
		МассивНепроверяемыхРеквизитов,
		Отказ);
		
	ПодразделениеОбязательно = ПолучитьФункциональнуюОпцию("ИспользоватьПроизводство")
		Или ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоПодразделениямМенеджерам");
	
	Если Не ПодразделениеОбязательно Тогда
		МассивНепроверяемыхРеквизитов.Добавить("Подразделение");
	КонецЕсли;
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьУчетЗатратПоНаправлениямДеятельности") Тогда
		МассивНепроверяемыхРеквизитов.Добавить("НаправлениеДеятельности");
	КонецЕсли;
	
КонецПроцедуры

// Перед записью перемаркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  РежимЗаписи						 - РежимЗаписи - Режим записи документа.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПередЗаписьюПеремаркировкаТоваров(Отказ, РежимЗаписи, РежимПроведения, ДокументОбъект) Экспорт
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ДокументОбъект);
	
	ПроведениеСерверУТ.УстановитьРежимПроведения(ДокументОбъект, РежимЗаписи, РежимПроведения);
	
	ДокументОбъект.ДополнительныеСвойства.Вставить("ЭтоНовый",    ДокументОбъект.ЭтоНовый());
	ДокументОбъект.ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписи);
	
	НоменклатураСервер.ОчиститьНеиспользуемыеСерии(ДокументОбъект, 
													НоменклатураСервер.ПараметрыУказанияСерий(ДокументОбъект, Документы.ПеремаркировкаТоваровГИСМ));
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		МестаУчета = РегистрыСведений.АналитикаУчетаНоменклатуры.МестаУчета(
			Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию,
			ДокументОбъект.Склад,
			ДокументОбъект.Подразделение,
			Неопределено);
		ИменаПолей = РегистрыСведений.АналитикаУчетаНоменклатуры.ИменаПолейКоллекцииПоУмолчанию();
		ИменаПолей.Номенклатура = "НоменклатураКиЗ";
		ИменаПолей.Характеристика = "ХарактеристикаКиЗ";
		ИменаПолей.Серия = "";
		ИменаПолей.СтатусУказанияСерий = "";
		ИменаПолей.Вставить("Назначение", Новый Структура("ТекстПоля,Значение","&Назначение",ДокументОбъект.НазначениеКиЗ));
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокументОбъект.Товары, МестаУчета, ИменаПолей);
		
		ВзаиморасчетыСервер.ЗаполнитьИдентификаторыСтрокВТабличнойЧасти(ДокументОбъект.Товары);
		ЗаполнитьВидыЗапасов(ДокументОбъект, Отказ, "ПеремаркировкаТоваровГИСМ");
		ПроверитьЗаполнитьСерииКиЗПеремаркировкаТоваров(ДокументОбъект, Отказ);
	ИначеЕсли РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения Тогда
		Если Не ДокументОбъект.ВидыЗапасовУказаныВручную Тогда
			ДокументОбъект.ВидыЗапасов.Очистить();
		КонецЕсли;
		ДокументОбъект.СерииКиЗ.Очистить();
	КонецЕсли;
	
КонецПроцедуры

// При копировании перемаркировка товаров
//
// Параметры:
//  ОбъектКопирования - см. описание параметра в синтаксис-помощнике к обработчику "ПриКопировании".
//  ДокументОбъект - ДокументОбъект.ПеремаркировкаТоваров - обрабатываемый документ.
//
Процедура ПриКопированииПеремаркировкаТоваров(ОбъектКопирования, ДокументОбъект) Экспорт
	
	ДокументОбъект.СерииКиЗ.Очистить();
	
	УчетНДСУТ.ПроверитьКорректностьДеятельностиНДСПотребления(
		ДокументОбъект.МаркировкаДляДеятельности, 
		ДокументОбъект.Организация,
		ДокументОбъект.Дата,
		Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию);
	
	ИнициализироватьДокументперемаркировкаТоваров(ДокументОбъект);
	
КонецПроцедуры

// Обработка проведения перемаркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроведенияПеремаркировкаТоваров(Отказ, РежимПроведения, ДокументОбъект) Экспорт
	
	Ссылка = ДокументОбъект.Ссылка;
	ДополнительныеСвойства = ДокументОбъект.ДополнительныеСвойства;
	Движения =  ДокументОбъект.Движения;
	
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства, РежимПроведения);
	ИнициализироватьДанныеДокументаПеремаркировкаТоваров(Ссылка, ДополнительныеСвойства);
	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ДокументОбъект);
	
	ЗапасыСервер.ОтразитьСвободныеОстатки(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьОбеспечениеЗаказов(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыНаСкладах(ДополнительныеСвойства, Движения, Отказ);
	СкладыСервер.ОтразитьДвиженияСерийТоваров(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыОрганизаций(ДополнительныеСвойства, Движения, Отказ);
	ЗапасыСервер.ОтразитьТоварыОрганизацийКПередаче(ДополнительныеСвойства, Движения, Отказ);
	ДоходыИРасходыСервер.ОтразитьСебестоимостьТоваров(ДополнительныеСвойства, Движения, Отказ);
	
	// Движения по оборотным регистрам управленческого учета
	УправленческийУчетПроведениеСервер.ОтразитьДвиженияНоменклатураДоходыРасходы(ДополнительныеСвойства, Движения, Отказ);
	
	//++ НЕ УТ
	РеглУчетПроведениеСервер.ЗарегистрироватьКОтражению(ДокументОбъект, ДополнительныеСвойства, Движения, Отказ);
	РеглУчетПроведениеСервер.ОтразитьПорядокОтраженияПрочихОпераций(ДополнительныеСвойства, Отказ);
	//-- НЕ УТ
	
	СформироватьСписокРегистровДляКонтроляМаркировкаТоваров(ДокументОбъект);
	
	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ДокументОбъект);
	//++ НЕ УТКА
	МеждународныйУчетПроведениеСервер.ЗарегистрироватьКОтражению(ДокументОбъект, ДополнительныеСвойства, Движения, Отказ);
	//-- НЕ УТКА
	ПроведениеСерверУТ.ВыполнитьКонтрольРезультатовПроведения(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.ЗаписатьПодчиненныеНаборамЗаписейДанные(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ДокументОбъект);
	
	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДополнительныеСвойства);
	
КонецПроцедуры

// Обработка удаления проведения перемаркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаУдаленияПроведенияПеремаркировкаТоваров(Отказ, ДокументОбъект) Экспорт
	
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(ДокументОбъект.Ссылка, ДокументОбъект.ДополнительныеСвойства);
	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ДокументОбъект);
	
	СформироватьСписокРегистровДляКонтроляМаркировкаТоваров(ДокументОбъект);
	
	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ДокументОбъект);
	ПроведениеСерверУТ.ВыполнитьКонтрольРезультатовПроведения(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.ЗаписатьПодчиненныеНаборамЗаписейДанные(ДокументОбъект, Отказ);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ДокументОбъект);
	
	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДокументОбъект.ДополнительныеСвойства);
	
КонецПроцедуры

#КонецОбласти

// Заполняет списки выбора реквизитов шапки.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма документа
//
Процедура ЗаполнитьСпискиВыбораРеквизитовШапкиПеремаркировкаТоваров(Форма) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМВид
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМСпособВыпускаВОборот
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМРазмер
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ";
		
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	
	ВыборкаКиЗГИСМВид = ПакетРезультатов[0].Выбрать();
	ВыборкаКиЗГИСМСпособВыпускаВОборот = ПакетРезультатов[1].Выбрать();
	ВыборкаКиЗГИСМРазмер = ПакетРезультатов[2].Выбрать();
	
	Форма.Элементы.КиЗГИСМВид.СписокВыбора.Очистить();
	Форма.Элементы.КиЗГИСМРазмер.СписокВыбора.Очистить();
	Форма.Элементы.КиЗГИСМСпособВыпускаВОборот.СписокВыбора.Очистить();
	
	Пока ВыборкаКиЗГИСМВид.Следующий() Цикл
		Форма.Элементы.КиЗГИСМВид.СписокВыбора.Добавить(ВыборкаКиЗГИСМВид.КиЗГИСМВид);
	КонецЦикла;
	Если ВыборкаКиЗГИСМВид.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМВид = ВыборкаКиЗГИСМВид.КиЗГИСМВид;
	КонецЕсли;
	
	Пока ВыборкаКиЗГИСМРазмер.Следующий() Цикл
		Форма.Элементы.КиЗГИСМРазмер.СписокВыбора.Добавить(ВыборкаКиЗГИСМРазмер.КиЗГИСМРазмер);
	КонецЦикла;
	Если ВыборкаКиЗГИСМРазмер.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМРазмер = ВыборкаКиЗГИСМРазмер.КиЗГИСМРазмер;
	КонецЕсли;
	
	Пока ВыборкаКиЗГИСМСпособВыпускаВОборот.Следующий() Цикл
		Форма.Элементы.КиЗГИСМСпособВыпускаВОборот.СписокВыбора.Добавить(ВыборкаКиЗГИСМСпособВыпускаВОборот.КиЗГИСМСпособВыпускаВОборот);
	КонецЦикла;
	Если ВыборкаКиЗГИСМСпособВыпускаВОборот.Количество() = 1 Тогда
		Форма.Объект.КиЗГИСМСпособВыпускаВОборот = ВыборкаКиЗГИСМСпособВыпускаВОборот.КиЗГИСМСпособВыпускаВОборот;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ИнициализацияИЗаполнениеМаркировкаТоваров

Процедура ЗаполнитьМаркировкуТоваровПоВозвратуТоваровОтКлиента(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВозвратТоваровОтКлиента.Ссылка КАК Ссылка,
	|	ВозвратТоваровОтКлиента.Организация КАК Организация,
	|	ВозвратТоваровОтКлиента.Склад КАК Склад,
	|	ВозвратТоваровОтКлиента.Менеджер КАК Ответственный,
	|	ВозвратТоваровОтКлиента.Подразделение КАК Подразделение,
	|	НЕ ВозвратТоваровОтКлиента.Проведен КАК ЕстьОшибкиПроведен,
	|	ВозвратТоваровОтКлиента.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВозвратТоваровОтКлиента.НалогообложениеНДС КАК МаркировкаДляДеятельности
	|ИЗ
	|	Документ.ВозвратТоваровОтКлиента КАК ВозвратТоваровОтКлиента
	|ГДЕ
	|	ВозвратТоваровОтКлиента.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВозвратТоваровОтКлиентаТовары.Номенклатура,
	|	ВозвратТоваровОтКлиентаТовары.Характеристика,
	|	ВозвратТоваровОтКлиентаТовары.Количество
	|ИЗ
	|	Документ.ВозвратТоваровОтКлиента.Товары КАК ВозвратТоваровОтКлиентаТовары
	|ГДЕ
	|	ВозвратТоваровОтКлиентаТовары.Ссылка = &Ссылка
	|	И ВозвратТоваровОтКлиентаТовары.Номенклатура.ПродукцияМаркируемаяДляГИСМ");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[0].Выбрать();
	ВыборкаШапка.Следующий();
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		,
		ВыборкаШапка.ЕстьОшибкиПроведен);
		
	Если ПакетРезультатов[1].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаТоваровВозвращенныхПокупателем;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[1].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
КонецПроцедуры

Процедура ЗаполнитьМаркировкуТоваровПоПоступлениюТоваровУслуг(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ПоступлениеТоваровУслуг.Ссылка КАК Ссылка,
	|	ПоступлениеТоваровУслуг.Организация КАК Организация,
	|	ПоступлениеТоваровУслуг.Склад КАК Склад,
	|	ПоступлениеТоваровУслуг.Менеджер КАК Ответственный,
	|	ПоступлениеТоваровУслуг.Подразделение КАК Подразделение,
	|	НЕ ПоступлениеТоваровУслуг.Проведен КАК ЕстьОшибкиПроведен,
	|	ПоступлениеТоваровУслуг.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ПоступлениеТоваровУслуг.НалогообложениеНДС КАК МаркировкаДляДеятельности
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Номенклатура,
	|	ПоступлениеТоваровУслугТовары.Характеристика,
	|	ПоступлениеТоваровУслугТовары.Количество
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
	|	И ПоступлениеТоваровУслугТовары.Номенклатура.ПродукцияМаркируемаяДляГИСМ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Склад КАК Склад
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
	|	И ПоступлениеТоваровУслугТовары.Номенклатура.ПродукцияМаркируемаяДляГИСМ");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[0].Выбрать();
	ВыборкаШапка.Следующий();
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		,
		ВыборкаШапка.ЕстьОшибкиПроведен);
		
	Если ПакетРезультатов[1].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	МассивСкладов = ПакетРезультатов[2].Выгрузить().ВыгрузитьКолонку("Склад");
	СкладДляЗаполнения = СкладШапкиПоМассиву(МассивСкладов);
	
	ДокументОбъект.Склад = СкладДляЗаполнения;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаИмпортированныхТоваров;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[1].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

Процедура ЗаполнитьМаркировкуТоваровПоУведомлениюОбИмпортеМаркированныхТоваровГИСМ(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	УведомлениеОбИмпорте.Основание.Склад КАК Склад,
	|	УведомлениеОбИмпорте.Основание.Подразделение КАК Подразделение,
	|	УведомлениеОбИмпорте.Основание.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	УведомлениеОбИмпорте.Основание.НалогообложениеНДС КАК МаркировкаДляДеятельности
	|ИЗ
	|	Документ.УведомлениеОбИмпортеМаркированныхТоваровГИСМ КАК УведомлениеОбИмпорте
	|ГДЕ
	|	УведомлениеОбИмпорте.Ссылка = &Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УведомлениеОбИмпортеТовары.Ссылка.Основание.Склад КАК Склад
	|ИЗ
	|	Документ.УведомлениеОбИмпортеМаркированныхТоваровГИСМ.Товары КАК УведомлениеОбИмпортеТовары
	|ГДЕ
	|	УведомлениеОбИмпортеТовары.Ссылка = &Ссылка
	|	И УведомлениеОбИмпортеТовары.Номенклатура.ПродукцияМаркируемаяДляГИСМ");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[0].Выбрать();
	ВыборкаШапка.Следующий();
	
	МассивСкладов = ПакетРезультатов[1].Выгрузить().ВыгрузитьКолонку("Склад");
	СкладДляЗаполнения = СкладШапкиПоМассиву(МассивСкладов);
	
	ДокументОбъект.Склад = СкладДляЗаполнения;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

//++ НЕ УТ

// Процедура - Заполнить маркировку товаров по выпуску продукции
//
// Параметры:
//  ДанныеЗаполнения - 	 - 
//  ДокументОбъект	 - 	 - 
//
Процедура ЗаполнитьМаркировкуТоваровПоВыпускуПродукции(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВыпускПродукции.Ссылка КАК Ссылка,
	|	ВыпускПродукции.Организация КАК Организация,
	|	ВыпускПродукции.Склад КАК Склад,
	|	ВыпускПродукции.Ответственный КАК Ответственный,
	|	ВыпускПродукции.Подразделение КАК Подразделение,
	|	НЕ ВыпускПродукции.Проведен КАК ЕстьОшибкиПроведен,
	|	ВыпускПродукции.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ВыпускПродукции.ВыпускПодДеятельность КАК МаркировкаДляДеятельности
	|ИЗ
	|	Документ.ВыпускПродукции КАК ВыпускПродукции
	|ГДЕ
	|	ВыпускПродукции.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВыпускПродукцииТовары.Номенклатура,
	|	ВыпускПродукцииТовары.Характеристика,
	|	ВыпускПродукцииТовары.Количество
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ВыпускПродукцииТовары
	|ГДЕ
	|	ВыпускПродукцииТовары.Ссылка = &Ссылка
	|	И ВыпускПродукцииТовары.Номенклатура.ПродукцияМаркируемаяДляГИСМ");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[0].Выбрать();
	ВыборкаШапка.Следующий();
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		,
		ВыборкаШапка.ЕстьОшибкиПроведен);
		
	Если ПакетРезультатов[1].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[1].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
КонецПроцедуры

//-- НЕ УТ

//++ НЕ УТКА

// Процедура - Заполнить маркировку товаров по маршрутному листу производства
//
// Параметры:
//  ДанныеЗаполнения - 	 - 
//  ДокументОбъект	 - 	 - 
//
Процедура ЗаполнитьМаркировкуТоваровПоМаршрутномуЛистуПроизводства(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ КАК НаправлениеВыпуска
		|ПОМЕСТИТЬ ВТНаправленияВыпуска
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ВозвратныеОтходы.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВозвратныеОтходы КАК ВозвратныеОтходы
		|ГДЕ
		|	ВозвратныеОтходы.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МАКСИМУМ(ВТНаправленияВыпуска.НаправлениеВыпуска) КАК НаправлениеВыпуска,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ВТНаправленияВыпуска.НаправлениеВыпуска) КАК КоличествоНаправленийВДокументе
		|ПОМЕСТИТЬ НаправленияВыпуска
		|ИЗ
		|	ВТНаправленияВыпуска КАК ВТНаправленияВыпуска
		|;
		|
		|ВЫБРАТЬ
		|	МаршрутныйЛистПроизводства.Ссылка КАК Ссылка,
		|	МаршрутныйЛистПроизводства.Организация КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК Ответственный,
		|	ВЫБОР
		|		КОГДА МаршрутныйЛистПроизводства.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыМаршрутныхЛистовПроизводства.Выполнен)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьОшибкиСтатус,
		|	МаршрутныйЛистПроизводства.Статус КАК СтатусДокумента,
		|	МаршрутныйЛистПроизводства.Подразделение КАК Подразделение,
		|	НЕ МаршрутныйЛистПроизводства.Проведен КАК ЕстьОшибкиПроведен,
		|	МаршрутныйЛистПроизводства.Распоряжение.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НаправленияВыпуска.НаправлениеВыпуска КАК НаправлениеВыпуска,
		|	НаправленияВыпуска.КоличествоНаправленийВДокументе КАК КоличествоНаправленийВДокументе,
		|	НЕОПРЕДЕЛЕНО КАК МаркировкаДляДеятельности
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛистПроизводства,
		|	НаправленияВыпуска КАК НаправленияВыпуска
		|ГДЕ
		|	МаршрутныйЛистПроизводства.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Номенклатура,
		|	ВыходныеИзделия.Характеристика,
		|	ВыходныеИзделия.Количество
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВозвратныеОтходы.Номенклатура,
		|	ВозвратныеОтходы.Характеристика,
		|	ВозвратныеОтходы.Количество
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВозвратныеОтходы КАК ВозвратныеОтходы
		|ГДЕ
		|	ВозвратныеОтходы.Ссылка = &Ссылка
		|	И ВозвратныеОтходы.Номенклатура.ПродукцияМаркируемаяДляГИСМ;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Получатель КАК Склад
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВозвратныеОтходы.Получатель
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства.ВозвратныеОтходы КАК ВозвратныеОтходы
		|ГДЕ
		|	ВозвратныеОтходы.Ссылка = &Ссылка
		|	И ВозвратныеОтходы.Получатель ССЫЛКА Справочник.Склады
		|	И ВозвратныеОтходы.Номенклатура.ПродукцияМаркируемаяДляГИСМ;");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[2].Выбрать();
	ВыборкаШапка.Следующий();
	
	МассивДопустимыхСтатусов = Новый Массив();
		МассивДопустимыхСтатусов.Добавить(Перечисления.СтатусыМаршрутныхЛистовПроизводства.Выполнен);
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		ВыборкаШапка.СтатусДокумента,
		ВыборкаШапка.ЕстьОшибкиПроведен,
		ВыборкаШапка.ЕстьОшибкиСтатус,
		МассивДопустимыхСтатусов);
		
	Если ПакетРезультатов[3].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Если ВыборкаШапка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад Тогда
		
		МассивСкладов = ПакетРезультатов[4].Выгрузить().ВыгрузитьКолонку("Склад");
		
		СкладДляЗаполнения = СкладШапкиПоМассиву(МассивСкладов);
		
		Если СкладДляЗаполнения = Неопределено Тогда
			ТекстОшибки = НСтр("ru='В маршрутном листе определено поступление на разные склады.
									|Ввод одного документа на основании выбранного распоряжения невозможен.'");
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		ДокументОбъект.Склад = СкладДляЗаполнения;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[3].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

// Процедура - Заполнить маркировку товаров по маршрутному листу производства
//
// Параметры:
//  ДанныеЗаполнения - 	 - 
//  ДокументОбъект	 - 	 - 
//
Процедура ЗаполнитьМаркировкуТоваровПоДвижениюПродукцииИМатериалов(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ДвижениеПродукцииИМатериалов.Ссылка КАК Ссылка,
		|	ДвижениеПродукцииИМатериалов.Организация КАК Организация,
		|	ВЫБОР
		|		КОГДА ДвижениеПродукцииИМатериалов.Получатель ССЫЛКА Справочник.Склады 
		|			ТОГДА Получатель
		|		ИНАЧЕ
		|			НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК Ответственный,
		|	ДвижениеПродукцииИМатериалов.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
		|	НЕ ДвижениеПродукцииИМатериалов.Проведен КАК ЕстьОшибкиПроведен,
		|	ДвижениеПродукцииИМатериалов.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДвижениеПродукцииИМатериалов.НалогообложениеНДС КАК МаркировкаДляДеятельности
		|ИЗ
		|	Документ.ДвижениеПродукцииИМатериалов КАК ДвижениеПродукцииИМатериалов
		|ГДЕ
		|	ДвижениеПродукцииИМатериалов.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Товары.Номенклатура,
		|	Товары.Характеристика,
		|	Товары.Количество
		|ИЗ
		|	Документ.ДвижениеПродукцииИМатериалов.Товары КАК Товары
		|ГДЕ
		|	Товары.Ссылка = &Ссылка
		|	И Товары.Номенклатура.ПродукцияМаркируемаяДляГИСМ;");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[0].Выбрать();
	ВыборкаШапка.Следующий();
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		,
		ВыборкаШапка.ЕстьОшибкиПроведен,
		,
		);
		
	Если ПакетРезультатов[1].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Если ВыборкаШапка.ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад
		И ВыборкаШапка.ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства
		И ВыборкаШапка.ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзКладовой Тогда
		
		ТекстОшибки = НСтр("ru='Создание маркировки доступно только для документа с хозяйственной операцией ""Выпуск продукции"".'");
		ВызватьИсключение ТекстОшибки;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[1].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

// Процедура - Заполнить маркировку товаров по маршрутному листу производства
//
// Параметры:
//  ДанныеЗаполнения - 	 - 
//  ДокументОбъект	 - 	 - 
//
Процедура ЗаполнитьМаркировкуТоваровПоПроизводствуБезЗаказа(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ КАК НаправлениеВыпуска
		|ПОМЕСТИТЬ ВТНаправленияВыпуска
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ПобочныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МАКСИМУМ(ВТНаправленияВыпуска.НаправлениеВыпуска) КАК НаправлениеВыпуска,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ВТНаправленияВыпуска.НаправлениеВыпуска) КАК КоличествоНаправленийВДокументе
		|ПОМЕСТИТЬ НаправленияВыпуска
		|ИЗ
		|	ВТНаправленияВыпуска КАК ВТНаправленияВыпуска
		|;
		|
		|ВЫБРАТЬ
		|	ПроизводствоБезЗаказа.Ссылка КАК Ссылка,
		|	ПроизводствоБезЗаказа.Организация КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК Ответственный,
		|	ЛОЖЬ КАК ЕстьОшибкиСтатус,
		|	НЕОПРЕДЕЛЕНО КАК СтатусДокумента,
		|	ПроизводствоБезЗаказа.ВыпускающееПодразделение КАК Подразделение,
		|	НЕ ПроизводствоБезЗаказа.Проведен КАК ЕстьОшибкиПроведен,
		|	ПроизводствоБезЗаказа.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НаправленияВыпуска.НаправлениеВыпуска КАК НаправлениеВыпуска,
		|	НаправленияВыпуска.КоличествоНаправленийВДокументе КАК КоличествоНаправленийВДокументе,
		|	НЕОПРЕДЕЛЕНО КАК МаркировкаДляДеятельности
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа КАК ПроизводствоБезЗаказа,
		|	НаправленияВыпуска КАК НаправленияВыпуска
		|ГДЕ
		|	ПроизводствоБезЗаказа.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Номенклатура,
		|	ВыходныеИзделия.Характеристика,
		|	ВыходныеИзделия.Количество
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПобочныеИзделия.Номенклатура,
		|	ПобочныеИзделия.Характеристика,
		|	ПобочныеИзделия.Количество
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|	И ПобочныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Получатель КАК Склад
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПобочныеИзделия.Получатель
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|	И ПобочныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|	И ПобочныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ;");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[2].Выбрать();
	ВыборкаШапка.Следующий();
	
	МассивДопустимыхСтатусов = Новый Массив();
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		,
		ВыборкаШапка.ЕстьОшибкиПроведен,
		,
		);
		
	Если ПакетРезультатов[3].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Если ВыборкаШапка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад Тогда
		
		МассивСкладов = ПакетРезультатов[4].Выгрузить().ВыгрузитьКолонку("Склад");
		
		СкладДляЗаполнения = СкладШапкиПоМассиву(МассивСкладов);
		
		Если СкладДляЗаполнения = Неопределено Тогда
			ТекстОшибки = НСтр("ru='В документе определено поступление на разные склады.
									|Ввод одного документа на основании выбранного распоряжения невозможен.'");
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		ДокументОбъект.Склад = СкладДляЗаполнения;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[3].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

// Процедура - Заполнить маркировку товаров по маршрутному листу производства
//
// Параметры:
//  ДанныеЗаполнения - 	 - 
//  ДокументОбъект	 - 	 - 
//
Процедура ЗаполнитьМаркировкуТоваровПоЭтапуПроизводства2_2(ДанныеЗаполнения, ДокументОбъект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ КАК НаправлениеВыпуска
		|ПОМЕСТИТЬ ВТНаправленияВыпуска
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ПобочныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииНаСклад)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускпродукцииВПодразделение)
		|	КОНЕЦ
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МАКСИМУМ(ВТНаправленияВыпуска.НаправлениеВыпуска) КАК НаправлениеВыпуска,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ВТНаправленияВыпуска.НаправлениеВыпуска) КАК КоличествоНаправленийВДокументе
		|ПОМЕСТИТЬ НаправленияВыпуска
		|ИЗ
		|	ВТНаправленияВыпуска КАК ВТНаправленияВыпуска
		|;
		|
		|ВЫБРАТЬ
		|	ЭтапПроизводства2_2.Ссылка КАК Ссылка,
		|	ЭтапПроизводства2_2.Организация КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК Ответственный,
		|	ВЫБОР
		|		КОГДА ЭтапПроизводства2_2.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьОшибкиСтатус,
		|	ЭтапПроизводства2_2.Статус КАК СтатусДокумента,
		|	ЭтапПроизводства2_2.Подразделение КАК Подразделение,
		|	НЕ ЭтапПроизводства2_2.Проведен КАК ЕстьОшибкиПроведен,
		|	ЭтапПроизводства2_2.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НаправленияВыпуска.НаправлениеВыпуска КАК НаправлениеВыпуска,
		|	НаправленияВыпуска.КоличествоНаправленийВДокументе КАК КоличествоНаправленийВДокументе,
		|	НЕОПРЕДЕЛЕНО КАК МаркировкаДляДеятельности
		|ИЗ
		|	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства2_2,
		|	НаправленияВыпуска КАК НаправленияВыпуска
		|ГДЕ
		|	ЭтапПроизводства2_2.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Номенклатура,
		|	ВыходныеИзделия.Характеристика,
		|	ВыходныеИзделия.Количество
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПобочныеИзделия.Номенклатура,
		|	ПобочныеИзделия.Характеристика,
		|	ПобочныеИзделия.Количество
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|	И ПобочныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыходныеИзделия.Получатель КАК Склад
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ВыходныеИзделия
		|ГДЕ
		|	ВыходныеИзделия.Ссылка = &Ссылка
		|	И ВыходныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|	И ВыходныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПобочныеИзделия.Получатель
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделия
		|ГДЕ
		|	ПобочныеИзделия.Ссылка = &Ссылка
		|	И ПобочныеИзделия.Получатель ССЫЛКА Справочник.Склады
		|	И ПобочныеИзделия.Номенклатура.ПродукцияМаркируемаяДляГИСМ;");
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.Ссылка);
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаШапка = ПакетРезультатов[2].Выбрать();
	ВыборкаШапка.Следующий();
	
	МассивДопустимыхСтатусов = Новый Массив();
	МассивДопустимыхСтатусов.Добавить(Перечисления.СтатусыЭтаповПроизводства2_2.Завершен);
	
	ОбщегоНазначенияУТ.ПроверитьВозможностьВводаНаОсновании(
		ВыборкаШапка.Ссылка,
		ВыборкаШапка.СтатусДокумента,
		ВыборкаШапка.ЕстьОшибкиПроведен,
		ВыборкаШапка.ЕстьОшибкиСтатус,
		МассивДопустимыхСтатусов);
		
	Если ПакетРезультатов[3].Пустой() Тогда
		ТекстОшибки = НСтр("ru='Документ %Документ% не содержит маркируемых товаров для ГИСМ. Ввод на основании такого документа запрещен.'");
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Документ%", ДанныеЗаполнения.Ссылка);
		
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	Если ВыборкаШапка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад
		Или ВыборкаШапка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства
		Или ВыборкаШапка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзКладовой Тогда
		
		МассивСкладов = ПакетРезультатов[4].Выгрузить().ВыгрузитьКолонку("Склад");
		
		СкладДляЗаполнения = СкладШапкиПоМассиву(МассивСкладов);
		
		Если СкладДляЗаполнения = Неопределено Тогда
			ТекстОшибки = НСтр("ru='В документе определено поступление на разные склады.
									|Ввод одного документа на основании выбранного распоряжения невозможен.'");
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		ДокументОбъект.Склад = СкладДляЗаполнения;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокументОбъект, ВыборкаШапка);
	ДокументОбъект.НазначениеКиЗ = НаправленияДеятельностиСервер.ТолкающееНазначение(ВыборкаШапка.НаправлениеДеятельности);
	ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	ДокументОбъект.Основание = ДанныеЗаполнения.Ссылка;
	
	ДокументОбъект.Товары.Загрузить(ПакетРезультатов[3].Выгрузить());
	ЗаполнитьGTINВСтроках(ДокументОбъект);
	
КонецПроцедуры

//-- НЕ УТКА

Функция ОперацияМаркировкиПоУмолчанию(Операция)
	
	Если ЗначениеЗаполнено(Операция) Тогда
		Возврат Операция
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМВид
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМСпособВыпускаВОборот
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Номенклатура.КиЗГИСМРазмер
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И Номенклатура.КиЗГИСМ";
		
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	ВыборкаКиЗГИСМВид = ПакетРезультатов[0].Выбрать();
	ВыборкаКиЗГИСМСпособВыпускаВОборот = ПакетРезультатов[1].Выбрать();
	ВыборкаКиЗГИСМРазмер = ПакетРезультатов[2].Выбрать();
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводство") Тогда
		Операция = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции;
	Иначе
		Операция = Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции;
	КонецЕсли;
	
	Если ВыборкаКиЗГИСМВид.Количество() = 0 И ВыборкаКиЗГИСМРазмер.Количество() = 0 И ВыборкаКиЗГИСМСпособВыпускаВОборот.Количество() = 0 Тогда
		Операция = Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции;
	КонецЕсли;
	
	Возврат Операция
	
КонецФункции

// Функция возвращает таблицу реквизитов, зависимых от хозяйственной операции документа.
//
Функция ПолучитьМассивыРеквизитовМаркировкиТоваров(ОперацияМаркировки, МассивВсехРеквизитов, МассивРеквизитовОперации)
	
	МассивВсехРеквизитов = Новый Массив;
	МассивВсехРеквизитов.Добавить("СтатьяРасходов");
	МассивВсехРеквизитов.Добавить("АналитикаРасходов");
	МассивВсехРеквизитов.Добавить("НаправлениеДеятельности");
	МассивВсехРеквизитов.Добавить("НазначениеКиЗ");
	//++ НЕ УТ
	МассивВсехРеквизитов.Добавить("МаркировкаДляДеятельности");
	//-- НЕ УТ
	
	МассивРеквизитовОперации = Новый Массив;
	Если ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаОстатковНа12082016
		ИЛИ ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаПроизведеннойПродукции
		ИЛИ ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаТоваровВозвращенныхПокупателем
		ИЛИ ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаИмпортированныхТоваров
		ИЛИ ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.МаркировкаТоваровПринятыхНаКомиссию Тогда
		
		МассивРеквизитовОперации.Добавить("СтатьяРасходов");
		МассивРеквизитовОперации.Добавить("АналитикаРасходов");
		МассивРеквизитовОперации.Добавить("НаправлениеДеятельности");
		МассивРеквизитовОперации.Добавить("НазначениеКиЗ");
	//++ НЕ УТ
		МассивРеквизитовОперации.Добавить("МаркировкаДляДеятельности");
	//-- НЕ УТ
	КонецЕсли;
	
КонецФункции

Процедура СформироватьСписокРегистровДляКонтроляМаркировкаТоваров(ДокументОбъект)

	Массив = Новый Массив;
	// Контроль при перепроведении и отмене проведения
	
	Если ДокументОбъект.ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		Массив.Добавить(ДокументОбъект.Движения.СвободныеОстатки);
		Массив.Добавить(ДокументОбъект.Движения.ОбеспечениеЗаказов);
		Если НоменклатураСервер.ПараметрыУказанияСерий(ДокументОбъект, Документы.МаркировкаТоваровГИСМ).ИспользоватьСерииНоменклатуры Тогда
			Массив.Добавить(ДокументОбъект.Движения.ТоварыНаСкладах);
		КонецЕсли;
	КонецЕсли;
	
	ДокументОбъект.ДополнительныеСвойства.ДляПроведения.Вставить("РегистрыДляКонтроля", Массив);
	
КонецПроцедуры

#Область ВидыЗапасов

Функция ВременныеТаблицыДанныхДокумента(ДокументОбъект) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	&Дата КАК Дата,
	|	&Организация КАК Организация,
	|	&Склад КАК Склад,
	|	Неопределено КАК Партнер,
	|	Неопределено КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.СоглашенияСПоставщиками.ПустаяСсылка) КАК Соглашение,
	|	ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка) КАК Договор,
	|	&Валюта КАК Валюта,
	|	&НалогообложениеНДС КАК НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
	|	Ложь КАК ЕстьСделкиВТабличнойЧасти,
	|	
	|	ВЫБОР КОГДА СтруктураПредприятия.ВариантОбособленногоУчетаТоваров = ЗНАЧЕНИЕ(Перечисление.ВариантыОбособленногоУчетаТоваров.ПоПодразделению)
	|		И &ФормироватьВидыЗапасовПоПодразделениямМенеджерам
	|	ТОГДА
	|		&Подразделение
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|
	|	ВЫБОР КОГДА СтруктураПредприятия.ВариантОбособленногоУчетаТоваров = ЗНАЧЕНИЕ(Перечисление.ВариантыОбособленногоУчетаТоваров.ПоМенеджерамПодразделения)
	|		И &ФормироватьВидыЗапасовПоПодразделениямМенеджерам
	|	ТОГДА
	|		&Менеджер
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	|	КОНЕЦ КАК Менеджер,
	|	ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка) КАК Сделка,
	|	&Назначение КАК Назначение
	|	
	|ПОМЕСТИТЬ ТаблицаДанныхДокумента
	|ИЗ
	|	Справочник.Организации КАК Организации
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Справочник.СтруктураПредприятия КАК СтруктураПредприятия
	|	ПО
	|		СтруктураПредприятия.Ссылка = &Подразделение
	|ГДЕ
	|	Организации.Ссылка = &Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваров.НоменклатураКиЗ КАК Номенклатура,
	|	ТаблицаТоваров.ХарактеристикаКиЗ КАК Характеристика,
	|	&Назначение КАК Назначение,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	ТаблицаТоваров.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.Количество КАК Количество,
	|	ТаблицаТоваров.ДокументРеализации КАК ДокументРеализации
	|	
	|ПОМЕСТИТЬ ВтТаблицаТоваров
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваров.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваров.Характеристика КАК Характеристика,
	|	ТаблицаТоваров.Серия КАК Серия,
	|	&Назначение КАК Назначение,
	|	(ВЫБОР КОГДА ТаблицаТоваров.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) ТОГДА
	|		ТаблицаТоваров.АналитикаУчетаНоменклатуры
	|	ИНАЧЕ
	|		ЕСТЬNULL(Аналитика.КлючАналитики, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка))
	|	КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.Количество КАК Количество,
	|	&Склад КАК Склад,
	|	ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка) КАК Сделка,
	|	ТаблицаТоваров.ДокументРеализации КАК ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.ПустаяСсылка) КАК СтавкаНДС,
	|	0 КАК СуммаСНДС,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаВознаграждения,
	|	0 КАК СуммаНДСВознаграждения,
	|	ИСТИНА КАК ПодбиратьВидыЗапасов
	|	
	|ПОМЕСТИТЬ ТаблицаТоваров
	|ИЗ
	|	ВтТаблицаТоваров КАК ТаблицаТоваров
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Номенклатура = ТаблицаТоваров.Номенклатура
	|		И Аналитика.Характеристика = ТаблицаТоваров.Характеристика
	|		И Аналитика.Серия = ТаблицаТоваров.Серия
	|		И Аналитика.Склад = &Склад
	|		И Аналитика.Назначение = &Назначение
	//++ НЕ УТ 
	|		И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	//-- НЕ УТ
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВидыЗапасов.НомерСтроки КАК НомерСтроки,
	|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВидыЗапасов.ДокументРеализации КАК ДокументРеализации,
	|	ТаблицаВидыЗапасов.ВидЗапасов КАК ВидЗапасов,
	|	ТаблицаВидыЗапасов.НомерГТД КАК НомерГТД,
	|	ТаблицаВидыЗапасов.Количество КАК Количество,
	|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) КАК СкладОтгрузки,
	|	&Склад КАК Склад,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	&ВидыЗапасовУказаныВручную КАК ВидыЗапасовУказаныВручную
	|	
	|ПОМЕСТИТЬ ВтВидыЗапасов
	|ИЗ
	|	&ТаблицаВидыЗапасов КАК ТаблицаВидыЗапасов
	|;
	|//////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВидыЗапасов.НомерСтроки КАК НомерСтроки,
	|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Аналитика.Серия КАК Серия,
	|	ТаблицаВидыЗапасов.ДокументРеализации КАК ДокументРеализации,
	|	ТаблицаВидыЗапасов.ВидЗапасов КАК ВидЗапасов,
	|	ТаблицаВидыЗапасов.НомерГТД КАК НомерГТД,
	|	ТаблицаВидыЗапасов.Количество КАК Количество,
	|	ТаблицаВидыЗапасов.СкладОтгрузки КАК СкладОтгрузки,
	|	ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка) КАК Сделка,
	|	ТаблицаВидыЗапасов.Склад КАК Склад,
	|	ТаблицаВидыЗапасов.ВидыЗапасовУказаныВручную КАК ВидыЗапасовУказаныВручную
	|	
	|ПОМЕСТИТЬ ТаблицаВидыЗапасов
	|ИЗ
	|	ВтВидыЗапасов КАК ТаблицаВидыЗапасов
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|	ПО ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры
	|");
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	Запрос.УстановитьПараметр("Дата", ДокументОбъект.Дата);
	Запрос.УстановитьПараметр("Организация", ДокументОбъект.Организация);
	Запрос.УстановитьПараметр("Склад", ДокументОбъект.Склад);
	Запрос.УстановитьПараметр("Валюта", Константы.ВалютаУправленческогоУчета.Получить());
	Запрос.УстановитьПараметр("Менеджер", ДокументОбъект.Ответственный);
	Запрос.УстановитьПараметр("Подразделение", ДокументОбъект.Подразделение);
	Запрос.УстановитьПараметр("НалогообложениеНДС", ДокументОбъект.МаркировкаДляДеятельности);
	Запрос.УстановитьПараметр("ВидыЗапасовУказаныВручную", ДокументОбъект.ВидыЗапасовУказаныВручную);
	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоПодразделениямМенеджерам", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоПодразделениямМенеджерам"));
	Запрос.УстановитьПараметр("ТаблицаТоваров", ЗапасыСервер.ТаблицаДополненнаяОбязательнымиКолонками(ДокументОбъект.Товары.Выгрузить()));
	Запрос.УстановитьПараметр("ТаблицаВидыЗапасов", ЗапасыСервер.ТаблицаДополненнаяОбязательнымиКолонками(ДокументОбъект.ВидыЗапасов.Выгрузить()));
	Запрос.УстановитьПараметр("Назначение", ДокументОбъект.НазначениеКиЗ);
	
	Результат = Запрос.Выполнить();
	
	Если ДокументОбъект.ВидыЗапасовУказаныВручную Тогда
		ДокументОбъект.ДополнительныеСвойства.Вставить("ИгнорироватьОперативныеОстатки", Истина);
	КонецЕсли;
	
	Возврат МенеджерВременныхТаблиц;
	
КонецФункции

Процедура СообщитьОбОшибкахЗаполненияВидовЗапасов(ТаблицаОшибок, МенеджерВременныхТаблиц, ДокументОбъект)
	
	Если ТаблицаОшибок.Количество() > 0 Тогда
		
		СтруктураАналитики = ЗапасыСервер.АналитикаОбособленноУчетаДокумента(МенеджерВременныхТаблиц);
		
		ШаблонСообщения = НСтр("ru = 'Списание превышает остаток товара организации %1 на складе %2 %3 %4'");
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонСообщения,
			ДокументОбъект.Организация,
			ДокументОбъект.Склад,
			СтруктураАналитики.СтрокаАналитики,
			СтруктураАналитики.Аналитика);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,
			ДокументОбъект);
		
		Для Каждого СтрокаТаблицы Из ТаблицаОшибок Цикл
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Номенклатура: %1, недостаточно %2 %3'"),
				НоменклатураКлиентСервер.ПредставлениеНоменклатуры(СтрокаТаблицы.Номенклатура, СтрокаТаблицы.Характеристика,, СтрокаТаблицы.Серия),
				СтрокаТаблицы.Количество,
				СтрокаТаблицы.ЕдиницаИзмерения);
			
			Если СтрокаТаблицы.НеУказанНомерГТД Тогда
				ТекстСообщения = ТекстСообщения + " " + НСтр("ru = 'с указанными номерами ГТД'");
			КонецЕсли;
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				ТекстСообщения,
				ДокументОбъект.Ссылка);
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДоступныеВидыЗапасов(МенеджерВременныхТаблиц, ДокументОбъект) Экспорт
	
	ЗапасыСервер.ВидыЗапасовСобственныеНеОбособленныеИОбособленные(
		ДокументОбъект.Организация,
		Неопределено,
		ДокументОбъект.Ответственный,
		ДокументОбъект.Подразделение,
		МенеджерВременныхТаблиц);
	
КонецПроцедуры

Функция ПроверитьИзменениеРеквизитовДокумента(МенеджерВременныхТаблиц, ДокументОбъект, ИмяДокумента)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ДанныеДокумента.Организация КАК Организация,
	|	ДанныеДокумента.Дата КАК Дата,
	|	ДанныеДокумента.Склад КАК Склад,
	|	ВЫБОР КОГДА ДанныеДокумента.Подразделение.ВариантОбособленногоУчетаТоваров = ЗНАЧЕНИЕ(Перечисление.ВариантыОбособленногоУчетаТоваров.ПоПодразделению)
	|		И &ФормироватьВидыЗапасовПоПодразделениямМенеджерам
	|	ТОГДА
	|		ДанныеДокумента.Подразделение
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|
	|	ВЫБОР КОГДА ДанныеДокумента.Подразделение.ВариантОбособленногоУчетаТоваров = ЗНАЧЕНИЕ(Перечисление.ВариантыОбособленногоУчетаТоваров.ПоМенеджерамПодразделения)
	|		И &ФормироватьВидыЗапасовПоПодразделениямМенеджерам
	|	ТОГДА
	|		ДанныеДокумента.Ответственный
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	|	КОНЕЦ КАК Менеджер,
	|	ДанныеДокумента.НазначениеКиЗ КАК Назначение
	|
	|ПОМЕСТИТЬ СохраненныеДанныеДокумента
	|ИЗ
	|	&ИмяДокумента КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА ДанныеДокумента.Организация <> СохраненныеДанные.Организация ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Дата <> СохраненныеДанные.Дата ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Склад <> СохраненныеДанные.Склад ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Подразделение <> СохраненныеДанные.Подразделение ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Менеджер <> СохраненныеДанные.Менеджер ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Назначение <> СохраненныеДанные.Назначение ТОГДА
	|		Истина
	|	ИНАЧЕ
	|		Ложь
	|	КОНЕЦ КАК РеквизитыИзменены
	|ИЗ
	|	ТаблицаДанныхДокумента КАК ДанныеДокумента
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СохраненныеДанныеДокумента КАК СохраненныеДанные
	|	ПО
	|		Истина
	|");
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ИмяДокумента", "Документ." + ИмяДокумента);
	
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);

	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоПодразделениямМенеджерам", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоПодразделениямМенеджерам"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		РеквизитыИзменены = Выборка.РеквизитыИзменены;
	Иначе
		РеквизитыИзменены = Ложь;
	КонецЕсли;
	
	Возврат РеквизитыИзменены;
	
КонецФункции

Процедура ЗаполнитьВидыЗапасов(ДокументОбъект, Отказ, ИмяДокумента)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерВременныхТаблиц = ВременныеТаблицыДанныхДокумента(ДокументОбъект);
	ПерезаполнитьВидыЗапасов = ДокументОбъект.ДополнительныеСвойства.Свойство("ПерезаполнитьВидыЗапасов");
	
	Если Не ДокументОбъект.Проведен
		Или ПерезаполнитьВидыЗапасов
		Или ПроверитьИзменениеРеквизитовДокумента(МенеджерВременныхТаблиц, ДокументОбъект, ИмяДокумента)
		Или ЗапасыСервер.ПроверитьИзменениеТоваровПоКоличеству(МенеджерВременныхТаблиц) Тогда
		
		СформироватьДоступныеВидыЗапасов(МенеджерВременныхТаблиц, ДокументОбъект);
		ЗапасыСервер.УстановитьБлокировкуОстатковТоваровОрганизаций(МенеджерВременныхТаблиц);
		ЗапасыСервер.ТаблицаОстатковТоваровОрганизаций(ДокументОбъект.Ссылка, 
			ДокументОбъект.Организация,
			ДокументОбъект.Дата, 
			ДокументОбъект.ДополнительныеСвойства, 
			МенеджерВременныхТаблиц);
		ТаблицаОшибок = ЗапасыСервер.ТаблицаОшибокЗаполненияВидовЗапасов();
		
		ЗапасыСервер.ЗаполнитьВидыЗапасовДокумента(
			МенеджерВременныхТаблиц,
			ДокументОбъект.ДополнительныеСвойства,
			ДокументОбъект.ВидыЗапасов,
			ТаблицаОшибок,
			Отказ);
		
		ДокументОбъект.ВидыЗапасов.Свернуть("АналитикаУчетаНоменклатуры, ВидЗапасов, НомерГТД", "Количество");
		СообщитьОбОшибкахЗаполненияВидовЗапасов(ТаблицаОшибок, МенеджерВременныхТаблиц, ДокументОбъект);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СерииКиЗ

Процедура ПроверитьЗаполнитьСерииКиЗ(ДокументОбъект, Отказ)
	
	МаркируемыеСерии = ДокументОбъект.Серии.Выгрузить();
	
	Если Не ДокументОбъект.Проведен
		ИЛИ ПроверитьИзменениеЗависмыхРеквизитовСерий(ДокументОбъект)
		ИЛИ ПроверитьИзменениеЗависмыхРеквизитовСерийДокумента(ДокументОбъект) Тогда
		
		ОперацияИдентификации = ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции
			ИЛИ ДокументОбъект.ОперацияМаркировки = Перечисления.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированныхПриИмпортеТоваров;
		ЗаполнитьСерииКиЗ(ДокументОбъект, МаркируемыеСерии, ОперацияИдентификации);
		СообщитьОбОшибкахЗаполненияСерииКиЗ(ДокументОбъект, Отказ);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьЗаполнитьСерииКиЗПеремаркировкаТоваров(ДокументОбъект, Отказ)
	
	МаркируемыеСерии = ДокументОбъект.Товары.Выгрузить();
	
	Если Не ДокументОбъект.Проведен
		ИЛИ ПроверитьИзменениеЗависмыхРеквизитовСерийПеремаркировкаТоваров(ДокументОбъект)
		ИЛИ ПроверитьИзменениеЗависмыхРеквизитовСерийДокументаПеремаркировкаТоваров(ДокументОбъект) Тогда
		
		ЗаполнитьСерииКиЗ(ДокументОбъект, МаркируемыеСерии, Ложь);
		СообщитьОбОшибкахЗаполненияСерииКиЗ(ДокументОбъект, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСерииКиЗ(ДокументОбъект, МаркируемыеСерии, ОперацияИдентификации)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДокументОбъект.СерииКиЗ.Очистить();
	
	Если ОперацияИдентификации Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	|	МаркируемыеСерии.Серия КАК Серия,
	|	МаркируемыеСерии.Количество КАК Количество,
	|	МаркируемыеСерии.Номенклатура КАК Номенклатура,
	|	МаркируемыеСерии.Характеристика КАК Характеристика,
	|	МаркируемыеСерии.GTIN КАК GTIN,
	|	МаркируемыеСерии.НоменклатураКиЗ КАК НоменклатураКиЗ,
	|	МаркируемыеСерии.ХарактеристикаКиЗ КАК ХарактеристикаКиЗ
	|ПОМЕСТИТЬ МаркируемыеСерии
	|ИЗ
	|	&МаркируемыеСерии КАК МаркируемыеСерии;
	|
	|ВЫБРАТЬ
	|	МаркируемыеСерии.Серия КАК Серия,
	|	ВЫРАЗИТЬ(МаркируемыеСерии.Серия КАК Справочник.СерииНоменклатуры).НомерКиЗГИСМ КАК НомерКиЗГИСМ,
	|	ВЫБОР
	|		КОГДА ВыпущенныеКиЗ.Ссылка ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК КизВыпущен,
	|	МаркируемыеСерии.Количество КАК Количество,
	|	МаркируемыеСерии.Номенклатура КАК Номенклатура,
	|	МаркируемыеСерии.Характеристика КАК Характеристика,
	|	МаркируемыеСерии.GTIN КАК GTIN,
	|	МаркируемыеСерии.НоменклатураКиЗ КАК НоменклатураКиЗ,
	|	МаркируемыеСерии.ХарактеристикаКиЗ КАК ХарактеристикаКиЗ,
	|	ЕСТЬNULL(ВЫРАЗИТЬ(МаркируемыеСерии.ХарактеристикаКиЗ КАК Справочник.ХарактеристикиНоменклатуры).КиЗГИСМGTIN, ВЫРАЗИТЬ(МаркируемыеСерии.НоменклатураКиЗ КАК Справочник.Номенклатура).КиЗГИСМGTIN) КАК GTINКИЗ,
	|	ВЫРАЗИТЬ(МаркируемыеСерии.НоменклатураКиЗ КАК Справочник.Номенклатура).ВидНоменклатуры КАК ВидНоменклатурыКиЗ
	|ПОМЕСТИТЬ ВтМаркируемыеСерии
	|ИЗ
	|	МаркируемыеСерии КАК МаркируемыеСерии
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаВыпускКиЗГИСМ.ВыпущенныеКиЗ КАК ВыпущенныеКиЗ
	|		ПО (ВыпущенныеКиЗ.НомерКиЗ = ВЫРАЗИТЬ(МаркируемыеСерии.Серия КАК Справочник.СерииНоменклатуры).НомерКиЗГИСМ)
	|			И (ВыпущенныеКиЗ.СостояниеПодтверждения = ЗНАЧЕНИЕ(Перечисление.СостоянияОтправкиПодтвержденияГИСМ.ПринятоГИСМ))
	|			И (ВыпущенныеКиЗ.Ссылка.ПометкаУдаления = ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатуры.Ссылка КАК Серия,
	|	ВтМаркируемыеСерии.Количество КАК Количество,
	|	ВтМаркируемыеСерии.НоменклатураКиЗ КАК Номенклатура,
	|	ВтМаркируемыеСерии.ХарактеристикаКиЗ КАК Характеристика,
	|	ВтМаркируемыеСерии.GTINКИЗ КАК GTIN,
	|	ВтМаркируемыеСерии.НомерКиЗГИСМ КАК НомерКиЗГИСМ
	|ПОМЕСТИТЬ ВтСерииКиЗ
	|ИЗ
	|	ВтМаркируемыеСерии КАК ВтМаркируемыеСерии
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СерииНоменклатуры КАК СерииНоменклатуры
	|		ПО (СерииНоменклатуры.ВидНоменклатуры = ВтМаркируемыеСерии.ВидНоменклатурыКиЗ.ВладелецСерий 
	|				ИЛИ СерииНоменклатуры.ВидНоменклатуры = ВтМаркируемыеСерии.ВидНоменклатурыКиЗ)
	|			И (СерииНоменклатуры.НомерКиЗГИСМ = ВтМаркируемыеСерии.НомерКиЗГИСМ)
	|			И СерииНоменклатуры.ПометкаУдаления = ЛОЖЬ
	|ГДЕ
	|	НЕ СерииНоменклатуры.Ссылка ЕСТЬ NULL
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтМаркируемыеСерии.Серия,
	|	ВЫРАЗИТЬ(ВтМаркируемыеСерии.Серия КАК Справочник.СерииНоменклатуры).ВидНоменклатуры КАК ВидНоменклатуры,
	|	ВтМаркируемыеСерии.НомерКиЗГИСМ,
	|	ВтМаркируемыеСерии.КизВыпущен,
	|	ВтМаркируемыеСерии.Количество,
	|	ВтМаркируемыеСерии.Номенклатура,
	|	ВтМаркируемыеСерии.Характеристика,
	|	ВтМаркируемыеСерии.GTIN,
	|	ВтМаркируемыеСерии.НоменклатураКиЗ,
	|	ВтМаркируемыеСерии.ХарактеристикаКиЗ,
	|	ВтМаркируемыеСерии.GTINКИЗ,
	|	ВЫБОР 
	|		КОГДА ВтМаркируемыеСерии.ВидНоменклатурыКиЗ.НастройкиСерийБерутсяИзДругогоВидаНоменклатуры Тогда
	|			ВтМаркируемыеСерии.ВидНоменклатурыКиЗ.ВладелецСерий
	|		ИНАЧЕ
	|			ВтМаркируемыеСерии.ВидНоменклатурыКиЗ
	|	КОНЕЦ КАК ВидНоменклатурыКиЗ
	|ПОМЕСТИТЬ 
	|	ГенерируемыеСерии
	|ИЗ
	|	ВтМаркируемыеСерии КАК ВтМаркируемыеСерии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСерииКиЗ КАК ВтСерииКиЗ
	|		ПО (ВтСерииКиЗ.НомерКиЗГИСМ = ВтМаркируемыеСерии.НомерКиЗГИСМ)
	|			И (ВтСерииКиЗ.GTIN = ВтМаркируемыеСерии.GTINКИЗ)
	|ГДЕ
	|	ВтСерииКиЗ.НомерКиЗГИСМ ЕСТЬ NULL;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГенерируемыеСерии.Серия,
	|	ГенерируемыеСерии.НомерКиЗГИСМ,
	|	ГенерируемыеСерии.КизВыпущен,
	|	ГенерируемыеСерии.Количество,
	|	ГенерируемыеСерии.Номенклатура,
	|	ГенерируемыеСерии.Характеристика,
	|	ГенерируемыеСерии.GTIN,
	|	ГенерируемыеСерии.НоменклатураКиЗ,
	|	ГенерируемыеСерии.ХарактеристикаКиЗ,
	|	ГенерируемыеСерии.GTINКИЗ,
	|	ГенерируемыеСерии.ВидНоменклатурыКиЗ
	|ИЗ 
	|	ГенерируемыеСерии КАК ГенерируемыеСерии;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтСерииКиЗ.Серия,
	|	ВтСерииКиЗ.Количество,
	|	ВтСерииКиЗ.Номенклатура,
	|	ВтСерииКиЗ.Характеристика,
	|	ВтСерииКиЗ.GTIN,
	|	ВтСерииКиЗ.НомерКиЗГИСМ
	|ИЗ
	|	ВтСерииКиЗ КАК ВтСерииКиЗ;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка КАК Ссылка,
	|	НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Свойство КАК Свойство,
	|	ВидыНоменклатуры.Ссылка КАК ВидНоменклатуры
	|ПОМЕСТИТЬ ДопРеквизитыИсточник
	|ИЗ
	|	Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты
	|		ПО ВидыНоменклатуры.НаборСвойствСерий = НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка
	|ГДЕ
	|	ВидыНоменклатуры.Ссылка В (ВЫБРАТЬ РАЗЛИЧНЫЕ ГенерируемыеСерии.ВидНоменклатуры ИЗ ГенерируемыеСерии)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка КАК Ссылка,
	|	НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Свойство КАК Свойство,
	|	ВидыНоменклатуры.Ссылка КАК ВидНоменклатуры
	|ПОМЕСТИТЬ ДопРеквизитыПриемник
	|ИЗ
	|	Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты
	|		ПО ВидыНоменклатуры.НаборСвойствСерий = НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка
	|ГДЕ
	|	ВидыНоменклатуры.Ссылка В (ВЫБРАТЬ РАЗЛИЧНЫЕ ГенерируемыеСерии.ВидНоменклатурыКиЗ ИЗ ГенерируемыеСерии)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДопРеквизитыИсточник.Свойство,
	|	ДопРеквизитыИсточник.ВидНоменклатуры
	|ПОМЕСТИТЬ ДопустимыеСвойства
	|ИЗ
	|	ДопРеквизитыИсточник КАК ДопРеквизитыИсточник
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДопРеквизитыПриемник КАК ДопРеквизитыПриемник
	|		ПО ДопРеквизитыИсточник.Свойство = ДопРеквизитыПриемник.Свойство
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыДополнительныеРеквизиты.Свойство КАК Свойство,
	|	СерииНоменклатурыДополнительныеРеквизиты.Значение КАК Значение,
	|	СерииНоменклатурыДополнительныеРеквизиты.Ссылка КАК Серия
	|ИЗ
	|	Справочник.СерииНоменклатуры.ДополнительныеРеквизиты КАК СерииНоменклатурыДополнительныеРеквизиты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДопустимыеСвойства КАК ДопустимыеСвойства
	|		ПО (СерииНоменклатурыДополнительныеРеквизиты.Ссылка.ВидНоменклатуры = ДопустимыеСвойства.ВидНоменклатуры)
	|			И (ДопустимыеСвойства.Свойство = СерииНоменклатурыДополнительныеРеквизиты.Свойство)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СерииНоменклатуры КАК СерииНоменклатуры
	|		ПО (СерииНоменклатуры.Ссылка = СерииНоменклатурыДополнительныеРеквизиты.Ссылка)
	|ГДЕ
	|	СерииНоменклатурыДополнительныеРеквизиты.Ссылка В (ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				ГенерируемыеСерии.Серия
	|			ИЗ
	|				ГенерируемыеСерии)
	|УПОРЯДОЧИТЬ ПО
	|	СерииНоменклатурыДополнительныеРеквизиты.Ссылка
	|";
	
	Запрос.УстановитьПараметр("МаркируемыеСерии", МаркируемыеСерии);
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ДокументОбъект.СерииКиЗ.Загрузить(РезультатыЗапроса[5].Выгрузить());
	ВыборкаГенерируемыеСерии = РезультатыЗапроса[4].Выбрать();
	ВыборкаДопРеквизиты = РезультатыЗапроса[9].Выбрать();
	Пока ВыборкаГенерируемыеСерии.Следующий() Цикл
		СтрокаСерииКиЗ = ДокументОбъект.СерииКиЗ.Добавить();
		НоваяСерия = СгенерироватьСериюКиЗ(ВыборкаГенерируемыеСерии, ВыборкаДопРеквизиты);
		Если ЗначениеЗаполнено(НоваяСерия) Тогда
			СтрокаСерииКиЗ.Серия = НоваяСерия;
		КонецЕсли;
		СтрокаСерииКиЗ.Номенклатура   = ВыборкаГенерируемыеСерии.НоменклатураКиЗ;
		СтрокаСерииКиЗ.Характеристика = ВыборкаГенерируемыеСерии.ХарактеристикаКиЗ;
		СтрокаСерииКиЗ.GTIN           = ВыборкаГенерируемыеСерии.GTINКИЗ;
		СтрокаСерииКиЗ.Количество     = ВыборкаГенерируемыеСерии.Количество;
	КонецЦикла;
	
КонецПроцедуры

Функция СгенерироватьСериюКиЗ(Данные, ВыборкаДопРеквизиты)
	
	ШаблонОшибкиЗаписать = НСтр("ru='Не удалось записать серию КиЗ. %ОписаниеОшибки%'");
	
	НоваяСерия = Справочники.СерииНоменклатуры.СоздатьЭлемент();
	НоваяСерия.НомерКиЗГИСМ = Данные.НомерКиЗГИСМ;
	НоваяСерия.ВидНоменклатуры = Данные.ВидНоменклатурыКиЗ;
	
	ВыборкаДопРеквизиты.Сбросить();
	
	Пока ВыборкаДопРеквизиты.НайтиСледующий(Данные.Серия, "Серия") Цикл
		СтрокаДопРеквизиты = НоваяСерия.ДополнительныеРеквизиты.Добавить();
		СтрокаДопРеквизиты.Значение = ВыборкаДопРеквизиты.Значение;
		СтрокаДопРеквизиты.Свойство = ВыборкаДопРеквизиты.Свойство;
	КонецЦикла;
	
	Попытка
		НоваяСерия.Записать();
	Исключение
		ТекстОшибки = СтрЗаменить(ШаблонОшибкиЗаписать, "%ОписаниеОшибки%", КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки, НоваяСерия);
	КонецПопытки;
	
	Возврат НоваяСерия.Ссылка
	
КонецФункции

Функция ПроверитьИзменениеЗависмыхРеквизитовСерий(ДокументОбъект)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	МаркировкаТоваровГИСМСерии.Серия,
	|	МаркировкаТоваровГИСМСерии.Количество,
	|	МаркировкаТоваровГИСМСерии.Номенклатура,
	|	МаркировкаТоваровГИСМСерии.Характеристика,
	|	МаркировкаТоваровГИСМСерии.GTIN,
	|	МаркировкаТоваровГИСМСерии.НоменклатураКиЗ,
	|	МаркировкаТоваровГИСМСерии.ХарактеристикаКиЗ
	|ПОМЕСТИТЬ
	|	ВтСерии
	|ИЗ
	|	&Серии КАК МаркировкаТоваровГИСМСерии;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСерий.Серия КАК Серия
	|ИЗ (
	|	ВЫБРАТЬ
	|		МаркировкаТоваровГИСМСерии.Серия,
	|		МаркировкаТоваровГИСМСерии.Количество,
	|		МаркировкаТоваровГИСМСерии.Номенклатура,
	|		МаркировкаТоваровГИСМСерии.Характеристика,
	|		МаркировкаТоваровГИСМСерии.GTIN,
	|		МаркировкаТоваровГИСМСерии.НоменклатураКиЗ,
	|		МаркировкаТоваровГИСМСерии.ХарактеристикаКиЗ
	|	ИЗ
	|		ВтСерии КАК МаркировкаТоваровГИСМСерии
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		МаркировкаТоваровГИСМСерии.Серия,
	|		-МаркировкаТоваровГИСМСерии.Количество,
	|		МаркировкаТоваровГИСМСерии.Номенклатура,
	|		МаркировкаТоваровГИСМСерии.Характеристика,
	|		МаркировкаТоваровГИСМСерии.GTIN,
	|		МаркировкаТоваровГИСМСерии.НоменклатураКиЗ,
	|		МаркировкаТоваровГИСМСерии.ХарактеристикаКиЗ
	|	ИЗ
	|		Документ.МаркировкаТоваровГИСМ.Серии КАК МаркировкаТоваровГИСМСерии
	|	ГДЕ
	|		МаркировкаТоваровГИСМСерии.Ссылка = &Маркировка
	|	) КАК ТаблицаСерий
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСерий.Серия
	|
	|ИМЕЮЩИЕ
	|	СУММА(ТаблицаСерий.Количество) <> 0
	|");
	
	Запрос.УстановитьПараметр("Серии", ДокументОбъект.Серии.Выгрузить());
	Запрос.УстановитьПараметр("Маркировка", ДокументОбъект.Ссылка);
	
	РезультатЗапрос = Запрос.Выполнить();
	
	Возврат (Не РезультатЗапрос.Пустой());
	
КонецФункции

Функция ПроверитьИзменениеЗависмыхРеквизитовСерийДокумента(ДокументОбъект)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА ДанныеДокумента.ОперацияМаркировки <> &ОперацияМаркировки ТОГДА
	|		Истина
	|	КОГДА ДанныеДокумента.Склад <> &Склад ТОГДА
	|		Истина
	|	ИНАЧЕ
	|		Ложь
	|	КОНЕЦ КАК РеквизитыИзменены
	|ИЗ
	|	Документ.МаркировкаТоваровГИСМ КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	";
	
	Запрос.УстановитьПараметр("ОперацияМаркировки", ДокументОбъект.ОперацияМаркировки);
	Запрос.УстановитьПараметр("Склад", ДокументОбъект.Склад);
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		РеквизитыИзменены = Выборка.РеквизитыИзменены;
	Иначе
		РеквизитыИзменены = Ложь;
	КонецЕсли;
	
	Возврат РеквизитыИзменены;
	
КонецФункции

Функция ПроверитьИзменениеЗависмыхРеквизитовСерийДокументаПеремаркировкаТоваров(ДокументОбъект)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА ДанныеДокумента.Склад <> &Склад ТОГДА
	|		Истина
	|	ИНАЧЕ
	|		Ложь
	|	КОНЕЦ КАК РеквизитыИзменены
	|ИЗ
	|	Документ.ПереМаркировкаТоваровГИСМ КАК ДанныеДокумента
	|ГДЕ
	|	ДанныеДокумента.Ссылка = &Ссылка
	|	";
	
	Запрос.УстановитьПараметр("Склад", ДокументОбъект.Склад);
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		РеквизитыИзменены = Выборка.РеквизитыИзменены;
	Иначе
		РеквизитыИзменены = Ложь;
	КонецЕсли;
	
	Возврат РеквизитыИзменены;
	
КонецФункции

Функция ПроверитьИзменениеЗависмыхРеквизитовСерийПеремаркировкаТоваров(ДокументОбъект)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	МаркировкаТоваровГИСМСерии.Серия,
	|	МаркировкаТоваровГИСМСерии.Количество,
	|	МаркировкаТоваровГИСМСерии.Номенклатура,
	|	МаркировкаТоваровГИСМСерии.Характеристика,
	|	МаркировкаТоваровГИСМСерии.GTIN,
	|	МаркировкаТоваровГИСМСерии.НоменклатураКиЗ,
	|	МаркировкаТоваровГИСМСерии.ХарактеристикаКиЗ
	|ПОМЕСТИТЬ
	|	ВтСерии
	|ИЗ
	|	&Серии КАК МаркировкаТоваровГИСМСерии;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСерий.Серия КАК Серия
	|ИЗ (
	|	ВЫБРАТЬ
	|		МаркировкаТоваровГИСМСерии.Серия,
	|		МаркировкаТоваровГИСМСерии.Количество,
	|		МаркировкаТоваровГИСМСерии.Номенклатура,
	|		МаркировкаТоваровГИСМСерии.Характеристика,
	|		МаркировкаТоваровГИСМСерии.GTIN,
	|		МаркировкаТоваровГИСМСерии.НоменклатураКиЗ,
	|		МаркировкаТоваровГИСМСерии.ХарактеристикаКиЗ
	|	ИЗ
	|		ВтСерии КАК МаркировкаТоваровГИСМСерии
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПеремаркировкаТоваровГИСМТовары.Серия,
	|		-ПеремаркировкаТоваровГИСМТовары.Количество,
	|		ПеремаркировкаТоваровГИСМТовары.Номенклатура,
	|		ПеремаркировкаТоваровГИСМТовары.Характеристика,
	|		ПеремаркировкаТоваровГИСМТовары.GTIN,
	|		ПеремаркировкаТоваровГИСМТовары.НоменклатураКиЗ,
	|		ПеремаркировкаТоваровГИСМТовары.ХарактеристикаКиЗ
	|	ИЗ
	|		Документ.ПеремаркировкаТоваровГИСМ.Товары КАК ПеремаркировкаТоваровГИСМТовары
	|	ГДЕ
	|		ПеремаркировкаТоваровГИСМТовары.Ссылка = &Маркировка
	|	) КАК ТаблицаСерий
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСерий.Серия
	|
	|ИМЕЮЩИЕ
	|	СУММА(ТаблицаСерий.Количество) <> 0
	|");
	
	Запрос.УстановитьПараметр("Серии", ДокументОбъект.Товары.Выгрузить());
	Запрос.УстановитьПараметр("Маркировка", ДокументОбъект.Ссылка);
	
	РезультатЗапрос = Запрос.Выполнить();
	
	Возврат (Не РезультатЗапрос.Пустой());
	
КонецФункции

Процедура СообщитьОбОшибкахЗаполненияСерииКиЗ(ДокументОбъект, Отказ)
	
	Для каждого СтрокаСерии Из ДокументОбъект.СерииКиЗ Цикл
		Если Не ЗначениеЗаполнено(СтрокаСерии.Серия) Тогда
			
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Для КиЗ %1 отсутствуют серии.'"),
				НоменклатураКлиентСервер.ПредставлениеНоменклатуры(
					СтрокаСерии.Номенклатура,
					СтрокаСерии.Характеристика));
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				ТекстСообщения,
				ДокументОбъект.Ссылка,
				,
				,
				Отказ);
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Проведение

Процедура ИнициализироватьДанныеДокумента(ДокументСсылка, ДополнительныеСвойства, Регистры = Неопределено) Экспорт
	
	Если ТипЗнч(ДокументСсылка) = Тип("ДокументСсылка.МаркировкаТоваровГИСМ") Тогда
		ИнициализироватьДанныеДокументаМаркировкаТоваров(ДокументСсылка, ДополнительныеСвойства, Регистры);
	Иначе
		ИнициализироватьДанныеДокументаПеремаркировкаТоваров(ДокументСсылка, ДополнительныеСвойства, Регистры);
	КонецЕсли;
	
КонецПроцедуры

Функция ДополнительныеИсточникиДанныхДляДвижений(ИмяРегистра) Экспорт

	ИсточникиДанных = Новый Соответствие;

	Возврат ИсточникиДанных 

КонецФункции

#Область ПроведениеМаркировкаТоваров

Процедура ИнициализироватьДанныеДокументаМаркировкаТоваров(ДокументСсылка, ДополнительныеСвойства, Регистры = Неопределено)
	
	// Создание запроса инициализации движений и заполенение его параметров.
	Запрос = Новый Запрос;
	ЗаполнитьПараметрыИнициализации(Запрос, ДокументСсылка);

	// Формирование текста запроса.
	ТекстыЗапроса = Новый СписокЗначений;
	ТекстЗапросаТаблицаСвободныеОстатки(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаОбеспечениеЗаказов(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыНаСкладах(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаДвиженияСерийТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыОрганизаций(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыОрганизацийКПередаче(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаСебестоимостьТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаДвиженияНоменклатураДоходыРасходы(Запрос, ТекстыЗапроса, Регистры);
	//++ НЕ УТ
	ТекстЗапросаТаблицаПорядокОтраженияПрочихОпераций(Запрос, ТекстыЗапроса, Регистры);
	//-- НЕ УТ

	// Исполнение запроса и выгрузка полученных таблиц для движений.
	ПроведениеСерверУТ.ИницализироватьТаблицыДляДвижений(Запрос, ТекстыЗапроса, ДополнительныеСвойства.ТаблицыДляДвижений, Истина);
	
КонецПроцедуры

Процедура ЗаполнитьПараметрыИнициализации(Запрос, ДокументСсылка)

	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);

	Запрос.Текст =
		"ВЫБРАТЬ
		|	Таблица.Ссылка                         КАК Ссылка,
		|	Таблица.Дата                           КАК Период,
		|	Таблица.Организация                    КАК Организация,
		|	Таблица.Склад                          КАК Склад,
		|	Таблица.Подразделение                  КАК Подразделение,
		|	Таблица.ОперацияМаркировки             КАК ОперацияМаркировки,
		|	Таблица.МаркировкаДляДеятельности      КАК МаркировкаДляДеятельности,
		|	Таблица.НаправлениеДеятельности        КАК НаправлениеДеятельности,
		|	Таблица.НазначениеКиЗ                  КАК НазначениеКиЗ,
		|	Таблица.СтатьяРасходов                 КАК СтатьяРасходов,
		|	Таблица.АналитикаРасходов              КАК АналитикаРасходов,
		|	ВЫБОР
		|		КОГДА
		|			Таблица.ОперацияМаркировки НЕ В (ЗНАЧЕНИЕ(Перечисление.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции), ЗНАЧЕНИЕ(Перечисление.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированныхПриИмпортеТоваров)) 
		|		ТОГДА
		|			ИСТИНА
		|		ИНАЧЕ
		|			ЛОЖЬ
		|	КОНЕЦ КАК СписаниеКиЗ
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ КАК Таблица
		|ГДЕ
		|	Таблица.Ссылка = &Ссылка";

	Реквизиты = Запрос.Выполнить().Выбрать();
	Реквизиты.Следующий();

	Запрос.УстановитьПараметр("Ссылка",                    Реквизиты.Ссылка);
	Запрос.УстановитьПараметр("Период",                    Реквизиты.Период);
	Запрос.УстановитьПараметр("Организация",               Реквизиты.Организация);
	Запрос.УстановитьПараметр("Склад",                     Реквизиты.Склад);
	Запрос.УстановитьПараметр("Подразделение",             Реквизиты.Подразделение);
	Запрос.УстановитьПараметр("ОперацияМаркировки",        Реквизиты.ОперацияМаркировки);
	Запрос.УстановитьПараметр("МаркировкаДляДеятельности", Реквизиты.МаркировкаДляДеятельности);
	Запрос.УстановитьПараметр("НаправлениеДеятельности",   Реквизиты.НаправлениеДеятельности);
	Запрос.УстановитьПараметр("НазначениеКиЗ",             Реквизиты.НазначениеКиЗ);
	Запрос.УстановитьПараметр("СтатьяРасходов",            Реквизиты.СтатьяРасходов);
	Запрос.УстановитьПараметр("АналитикаРасходов",         Реквизиты.АналитикаРасходов);
	Запрос.УстановитьПараметр("СписаниеКиЗ",               Реквизиты.СписаниеКиЗ);
	
	Запрос.УстановитьПараметр("Валюта",                Константы.ВалютаУправленческогоУчета.Получить());
	Запрос.УстановитьПараметр("КорВидЗапасов",         Справочники.ВидыЗапасов.ВидЗапасовДокумента(Реквизиты.Организация, Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию, Неопределено));
	Запрос.УстановитьПараметр("ПустойКлючСвязи",       Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000"));
	Запрос.УстановитьПараметр("ПустаяСерия",           Справочники.СерииНоменклатуры.ПустаяСсылка());
	Запрос.УстановитьПараметр("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию);
	
	Запрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоВидамЗапасов",     ПолучитьФункциональнуюОпцию("УчитыватьСебестоимостьТоваровПоВидамЗапасов"));
	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета"));
	Запрос.УстановитьПараметр("ИспользуетсяНазначение",                          ПолучитьФункциональнуюОпцию("УчитыватьСебестоимостьТоваровПоВидамЗапасов"));
	
	ИнициализироватьКлючиАналитикиНоменклатуры(Запрос.Параметры, "МаркировкаТоваровГИСМ");
КонецПроцедуры

Процедура ИнициализироватьКлючиАналитикиНоменклатуры(Реквизиты, ИмяДокумента)

	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Ключи.Склад КАК Склад,
	|	Ключи.Номенклатура КАК Номенклатура,
	|	Ключи.Характеристика КАК Характеристика,
	|	Ключи.Серия КАК Серия,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение
	|ИЗ
	|	&ИмяДокумента КАК ТаблицаВидыЗапасов
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Ключи
	|	ПО ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры = Ключи.КлючАналитики
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|	ПО
	|		Ключи.Номенклатура = Аналитика.Номенклатура
	|		И Ключи.Характеристика = Аналитика.Характеристика
	|		И Ключи.Серия = Аналитика.Серия
	|		И Ключи.Склад = Аналитика.Склад
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = Аналитика.Назначение
	|ГДЕ
	|	Аналитика.Номенклатура ЕСТЬ NULL
	|	И ТаблицаВидыЗапасов.Ссылка = &Ссылка
	|	И Не &ИспользуетсяНазначение
	|");
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ИмяДокумента", "Документ." + ИмяДокумента + ".ВидыЗапасов");
	
	Запрос.УстановитьПараметр("Ссылка", Реквизиты.Ссылка);
	Запрос.УстановитьПараметр("ИспользуетсяНазначение", Реквизиты.ИспользуетсяНазначение);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		РегистрыСведений.АналитикаУчетаНоменклатуры.СоздатьКлючАналитики(Выборка)
	КонецЦикла;

КонецПроцедуры

Функция ТекстЗапросаВтТаблицаСерииТоваров(Запрос, ТекстыЗапроса)
	
	ИмяРегистра = "ВтТаблицаСерииТоваров";

	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаСерии.Номенклатура                                   КАК Номенклатура,
		|	ТаблицаСерии.Характеристика                                 КАК Характеристика,
		|	&НазначениеКиЗ                                              КАК Назначение,
		|	ТаблицаСерии.Количество                                     КАК Количество,
		|	МАКСИМУМ(ТаблицаТовары.СтатусУказанияСерий)                 КАК СтатусУказанияСерий,
		|	ТаблицаСерии.Серия                                          КАК Серия,
		|	МИНИМУМ(ТаблицаСерии.НомерСтроки)                           КАК НомерСтроки,
		|	ЛОЖЬ                                                        КАК КонтролироватьОстатки
		|ПОМЕСТИТЬ ВтТаблицаСерииТоваров
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ.СерииКиЗ КАК ТаблицаСерии
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|		ПО ТаблицаСерии.Ссылка = ТаблицаТовары.Ссылка
		|			И ТаблицаСерии.Номенклатура = ТаблицаТовары.Номенклатура
		|			И ТаблицаСерии.Характеристика = ТаблицаТовары.Характеристика
		|ГДЕ
		|	ТаблицаСерии.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаСерии.Номенклатура,
		|	ТаблицаСерии.Характеристика,
		|	&НазначениеКиЗ,
		|	ТаблицаСерии.Серия,
		|	ТаблицаСерии.Количество
		|
		|ИМЕЮЩИЕ
		|	МАКСИМУМ(ТаблицаТовары.СтатусУказанияСерий) В (2, 4)";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса)
	
	ИмяРегистра = "ВтВидыЗапасов";
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаВидыЗапасов.НомерСтроки                КАК НомерСтроки,
		|	Справочник.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
		|	Справочник.ВидЗапасовВладельца                КАК ВидЗапасовВладельца,
		|	ТаблицаВидыЗапасов.ВидЗапасов                 КАК ВидЗапасов,
		|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	АналитикаБезНазначения.КлючАналитики          КАК АналитикаУчетаНоменклатурыБезНазначения,
		|	Аналитика.Номенклатура                        КАК Номенклатура,
		|	Аналитика.Характеристика                      КАК Характеристика,
		|	ТаблицаВидыЗапасов.НомерГТД                   КАК НомерГТД,
		|	ТаблицаВидыЗапасов.Количество                 КАК Количество,
		|	&ХозяйственнаяОперация                        КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(&СтатьяРасходов КАК ПланВидовХарактеристик.СтатьиРасходов).ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|	ИНАЧЕ
		|		&МаркировкаДляДеятельности
		|	КОНЕЦ                                         КАК НалогообложениеНДС,
		|	&СтатьяРасходов             КАК СтатьяРасходов,
		|	&АналитикаРасходов          КАК АналитикаРасходов,
		|	ТаблицаВидыЗапасов.ВидЗапасов КАК КорВидЗапасов,
		|	ТаблицаВидыЗапасов.ВидЗапасов.ТипЗапасов      КАК ТипЗапасов,
		|	ТаблицаВидыЗапасов.ИдентификаторСтроки        КАК ИдентификаторСтроки
		|ПОМЕСТИТЬ ВтВидыЗапасов
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ.ВидыЗапасов КАК ТаблицаВидыЗапасов
		|
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|	ПО
		|		ТаблицаВидыЗапасов.Ссылка = ТаблицаТовары.Ссылка И ТаблицаВидыЗапасов.ИдентификаторСтроки = ТаблицаТовары.ИдентификаторСтроки
		//-- НЕ УТ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		Справочник.ВидыЗапасов КАК Справочник
		|	ПО
		|		ТаблицаВидыЗапасов.ВидЗапасов = Справочник.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО
		|		ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|	ПО
		|		Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
		|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
		|		И Аналитика.Серия = АналитикаБезНазначения.Серия
		|		И Аналитика.Склад = АналитикаБезНазначения.Склад
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
		|	ПО
		|		&СтатьяРасходов = СтатьиРасходов.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Организация = &Организация
		|		И АналитикаРасчетов.Партнер = Справочник.Комитент
		|		И АналитикаРасчетов.Контрагент = Справочник.Контрагент
		|		И АналитикаРасчетов.Договор = Справочник.Договор
		|		И АналитикаРасчетов.НаправлениеДеятельности = &НаправлениеДеятельности
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаРасчетовИнтеркампани
		|		ПО АналитикаРасчетовИнтеркампани.Организация = &Организация
		|		И АналитикаРасчетовИнтеркампани.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
		|		И АналитикаРасчетовИнтеркампани.Контрагент = Справочник.Контрагент
		|		И АналитикаРасчетовИнтеркампани.Договор = Справочник.Договор
		|		И АналитикаРасчетов.НаправлениеДеятельности = &НаправлениеДеятельности
		|ГДЕ
		|	ТаблицаВидыЗапасов.Ссылка = &Ссылка";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаСвободныеОстатки(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "СвободныеОстатки";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период                                КАК Период,
		|	&Склад                                 КАК Склад,
		|	ТаблицаТовары.НоменклатураКиЗ          КАК Номенклатура,
		|	ТаблицаТовары.ХарактеристикаКиЗ        КАК Характеристика,
		|	ТаблицаТовары.Количество               КАК ВНаличии,
		|	
		|	ВЫБОР КОГДА &НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) ТОГДА
		|				ТаблицаТовары.Количество
		|			ИНАЧЕ
		|				0
		|		КОНЕЦ                              КАК ВРезервеПодЗаказ
		|	
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|ГДЕ
		|	ТаблицаТовары.Ссылка = &Ссылка
		|	И &СписаниеКиЗ";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаОбеспечениеЗаказов(Запрос, ТекстыЗапроса, Регистры)
	ИмяРегистра = "ОбеспечениеЗаказов";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период                                КАК Период,
		|	&Склад                                 КАК Склад,
		|	ТаблицаТовары.НоменклатураКиЗ          КАК Номенклатура,
		|	ТаблицаТовары.ХарактеристикаКиЗ        КАК Характеристика,
		|	&НазначениеКиЗ                         КАК Назначение,
		|	ТаблицаТовары.Количество               КАК Потребность,
		|	0                                      КАК КЗаказу,
		|	ТаблицаТовары.Количество               КАК НаличиеПодЗаказ
		|
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|ГДЕ
		|	ТаблицаТовары.Ссылка = &Ссылка
		|	И &НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|	И &СписаниеКиЗ";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаТоварыНаСкладах(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыНаСкладах";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтТаблицаСерииТоваров", ТекстыЗапроса) Тогда
		ТекстЗапросаВтТаблицаСерииТоваров(Запрос, ТекстыЗапроса)
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период КАК Период,
		|	&Склад КАК Склад,
		|	ТаблицаТовары.Номенклатура             КАК Номенклатура,
		|	ТаблицаТовары.Характеристика           КАК Характеристика,
		|	&НазначениеКиЗ                         КАК Назначение,
		|	ТаблицаТовары.НомерСтроки              КАК НомерСтроки,
		|	ТаблицаТовары.Серия                    КАК Серия,
		|	ТаблицаТовары.Количество               КАК ВНаличии,
		|	0                                      КАК КОтгрузке,
		|	ТаблицаТовары.КонтролироватьОстатки    КАК КонтролироватьОстатки
		|ИЗ
		|	ВтТаблицаСерииТоваров КАК ТаблицаТовары
		|ГДЕ
		|	&СписаниеКиЗ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаТаблицаДвиженияСерийТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ДвиженияСерийТоваров";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ТаблицаСерии.Номенклатура КАК Номенклатура,
	|	ТаблицаСерии.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВЫРАЗИТЬ (&НазначениеКиЗ КАК Справочник.Назначения).ДвиженияПоСкладскимРегистрам, ЛОЖЬ)
	|			ТОГДА &НазначениеКиЗ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	КОНЕЦ КАК Назначение,
	|	ТаблицаСерии.Серия КАК Серия,
	|	-ТаблицаСерии.Количество КАК Количество,
	|	&Склад КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка) КАК ПомещениеОтправителя,
	|	НЕОПРЕДЕЛЕНО КАК ПомещениеПолучателя,
	|	ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.МаркировкаПродукцииДляГИСМ) КАК СкладскаяОперация,
	|	&Ссылка КАК Документ,
	|	&Период КАК Период,
	|	ИСТИНА КАК ЭтоСкладскоеДвижение
	|ИЗ
	|	Документ.МаркировкаТоваровГИСМ.СерииКиЗ КАК ТаблицаСерии
	|ГДЕ
	|	ТаблицаСерии.Ссылка = &Ссылка
	|	И ТаблицаСерии.Количество <> 0
	|	И &СписаниеКиЗ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаСерии.Номенклатура КАК Номенклатура,
	|	ТаблицаСерии.Характеристика КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	ТаблицаСерии.Серия КАК Серия,
	|	ТаблицаСерии.Количество КАК Количество,
	|	&Склад КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка) КАК ПомещениеОтправителя,
	|	НЕОПРЕДЕЛЕНО КАК ПомещениеПолучателя,
	|	ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.МаркировкаПродукцииДляГИСМ) КАК СкладскаяОперация,
	|	&Ссылка КАК Документ,
	|	&Период КАК Период,
	|	ИСТИНА КАК ЭтоСкладскоеДвижение
	|ИЗ
	|	Документ.МаркировкаТоваровГИСМ.Серии КАК ТаблицаСерии
	|ГДЕ
	|	ТаблицаСерии.Ссылка = &Ссылка
	|	И ТаблицаСерии.Количество <> 0
	|";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаТаблицаТоварыОрганизаций(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыОрганизаций";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаВидыЗапасов.НомерСтроки КАК НомерСтроки,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период КАК Период,
		|	&Склад КАК Склад,
		|	&Организация КАК ОрганизацияОтгрузки,
		|	ВЫБОР КОГДА ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации ТОГДА
		|		ТаблицаВидыЗапасов.ВидЗапасовВладельца.Организация
		|	ИНАЧЕ
		|		&Организация
		|	КОНЕЦ КАК Организация,
		|
		|	ВЫБОР КОГДА ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации ТОГДА
		|		ТаблицаВидыЗапасов.ВидЗапасовВладельца
		|	ИНАЧЕ
		|		ТаблицаВидыЗапасов.ВидЗапасов
		|	КОНЕЦ КАК ВидЗапасов,
		|
		|	ТаблицаВидыЗапасов.Номенклатура КАК Номенклатура,
		|	ТаблицаВидыЗапасов.Характеристика КАК Характеристика,
		|	ТаблицаВидыЗапасов.НомерГТД КАК НомерГТД,
		|	ТаблицаВидыЗапасов.Количество КАК Количество,
		|	ВЫБОР 
		|		КОГДА ТаблицаВидыЗапасов.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
		|				И ТаблицаВидыЗапасов.СтатьяРасходов.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			ТОГДА
		|				ВЫБОР ТаблицаВидыЗапасов.СтатьяРасходов.ВидЦенностиНДС
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС)
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОбъектыНезавершенногоСтроительства) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС)
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставНМА)
		|				КОНЕЦ
		|		КОГДА ТаблицаВидыЗапасов.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
		|				И ТаблицаВидыЗапасов.СтатьяРасходов.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
		|		ИНАЧЕ
		|			&ХозяйственнаяОперация
		|	КОНЕЦ КАК ХозяйственнаяОперация,
		|
		|	ТаблицаВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
		|
		|	ТаблицаВидыЗапасов.СтатьяРасходов КАК СтатьяРасходов,
		|	ТаблицаВидыЗапасов.АналитикаРасходов КАК АналитикаРасходов,
		|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ИЗ
		|	ВтВидыЗапасов КАК ТаблицаВидыЗапасов
		|ГДЕ
		|	&СписаниеКиЗ
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаТоварыОрганизацийКПередаче(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыОрганизацийКПередаче";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ТаблицаВидыЗапасов.НомерСтроки                     КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	&Период                                            КАК Период,
	|	&Склад                                             КАК Склад,
	|	ТаблицаВидыЗапасов.ВидЗапасовВладельца.Организация КАК ОрганизацияВладелец,
	|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры      КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВидыЗапасов.ВидЗапасов                      КАК ВидЗапасовПродавца,
	|	ТаблицаВидыЗапасов.НомерГТД                        КАК НомерГТД,
	|	ТаблицаВидыЗапасов.Номенклатура                    КАК Номенклатура,
	|	ТаблицаВидыЗапасов.Характеристика                  КАК Характеристика,
	|	ТаблицаВидыЗапасов.Количество                      КАК Количество,
	|	&ХозяйственнаяОперация                             КАК ХозяйственнаяОперация,
	|	ТаблицаВидыЗапасов.НалогообложениеНДС              КАК НалогообложениеНДС
	|ИЗ
	|	ВтВидыЗапасов КАК ТаблицаВидыЗапасов
	|ГДЕ
	|	ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации
	|	И &СписаниеКиЗ
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаСебестоимостьТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "СебестоимостьТоваров";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Строки.НомерСтроки КАК НомерСтрокиДокумента,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	&Период КАК Период,
	|	ВЫБОР КОГДА &ИспользуетсяНазначение
	|		ТОГДА Строки.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ Строки.АналитикаУчетаНоменклатурыБезНазначения
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	&Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
	|
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		Строки.ВидЗапасов
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидЗапасов,
	|
	|	Строки.Количество КАК Количество,
	|	0 КАК СтоимостьРегл,
	|	&ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|
	|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
	|
	|	&СтатьяРасходов КАК СтатьяРасходовСписания,
	|	&АналитикаРасходов КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	//++ НЕ УТ
	|	Строки.ИдентификаторСтроки КАК ИдентификаторСтроки,
	//-- НЕ УТ
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	&Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции
	|ИЗ
	|	ВтВидыЗапасов КАК Строки
	|ГДЕ
	|	&СписаниеКиЗ
	|";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаДвиженияНоменклатураДоходыРасходы(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ДвиженияНоменклатураДоходыРасходы";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	&Период КАК Период,
	|	&ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	&Организация КАК Организация,
	|	&Подразделение КАК Подразделение,
	|
	|	&НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	|	Строки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	&Склад КАК Склад,
	|
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|			Строки.КорВидЗапасов
	|		ИНАЧЕ
	|			Строки.ВидЗапасов
	|		КОНЕЦ
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидЗапасов,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|			Строки.КорВидЗапасов.ТипЗапасов
	|		ИНАЧЕ
	|			Строки.ТипЗапасов
	|		КОНЕЦ
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ТипЗапасов,
	|
	|	&НаправлениеДеятельности КАК НаправлениеДеятельностиСтатьи,
	|	&СтатьяРасходов КАК СтатьяДоходовРасходов,
	|	&АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Строки.Количество КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА
	|				ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|					Строки.КорВидЗапасов
	|				ИНАЧЕ
	|					Строки.ВидЗапасов
	|				КОНЕЦ
	|		ИНАЧЕ Строки.Номенклатура
	|	КОНЕЦ КАК ИсточникГФУНоменклатуры
	|
	|ИЗ
	|	ВтВидыЗапасов КАК Строки
	|	
	|ГДЕ
	|	&СписаниеКиЗ";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

//++ НЕ УТ

Функция ТекстЗапросаТаблицаПорядокОтраженияПрочихОпераций(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ПорядокОтраженияПрочихОпераций";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасов(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	&Период	КАК Дата,
	|	&Организация КАК Организация,
	|	&Ссылка КАК Документ,
	|	"""" КАК ИдентификаторСтроки
	|ИЗ
	|	ВтВидыЗапасов КАК Строки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
	|		ПО Статья.Ссылка = &СтатьяРасходов
	|ГДЕ
	|	&СписаниеКиЗ
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИдентификаторСтроки";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

//-- НЕ УТ

Функция АдаптированныйТекстЗапросаДвиженийПоРегиструМаркировкаТоваров(ИмяРегистра) Экспорт

	Запрос = Новый Запрос;
	ТекстыЗапроса = Новый СписокЗначений;
	
	ПолноеИмяДокумента = "Документ.МаркировкаТоваровГИСМ";
	
	ЗначенияПараметров = Новый Структура();
	
	ПереопределениеРасчетаПараметров = Новый Структура;
	СписаниеКиЗТекст = 
	"ВЫБОР
	|		КОГДА
	|			ТаблицаСерии.Ссылка.ОперацияМаркировки НЕ В (ЗНАЧЕНИЕ(Перечисление.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированнойНаПроизводствеПродукции), ЗНАЧЕНИЕ(Перечисление.ОперацииМаркировкиГИСМ.ИдентификацияРанееМаркированныхПриИмпортеТоваров)) 
	|		ТОГДА
	|			ИСТИНА
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ";
	ПереопределениеРасчетаПараметров.Вставить("СписаниеКиЗ", СписаниеКиЗТекст);
	
	Если ИмяРегистра = "ДвиженияСерийТоваров" Тогда
		
		ТекстЗапроса = ТекстЗапросаТаблицаДвиженияСерийТоваров(Запрос, ТекстыЗапроса, ИмяРегистра);
		СинонимТаблицыДокумента = "ТаблицаСерии";
		
	Иначе
		ТекстИсключения = НСтр("ru = 'В документе %ПолноеИмяДокумента% не реализована адаптация текста запроса формирования движений по регистру %ИмяРегистра%.'");
		ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ПолноеИмяДокумента%", ПолноеИмяДокумента);
		ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ИмяРегистра%", ИмяРегистра);
		
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	Результат = ОбновлениеИнформационнойБазыУТ.РезультатАдаптацииЗапроса();
	Результат.ЗначенияПараметров = ЗначенияПараметров;
	Результат.ТекстЗапроса = ОбновлениеИнформационнойБазыУТ.АдаптироватьЗапросМеханизмаПроведения(ТекстЗапроса,
																								ПолноеИмяДокумента,
																								СинонимТаблицыДокумента,
																								ПереопределениеРасчетаПараметров);

	Возврат Результат;
	
КонецФункции

#КонецОбласти 

#Область ПроведениеПеремаркировкаТоваров

Процедура ИнициализироватьДанныеДокументаПеремаркировкаТоваров(ДокументСсылка, ДополнительныеСвойства, Регистры = Неопределено)
	
	// Создание запроса инициализации движений и заполенение его параметров.
	Запрос = Новый Запрос;
	ЗаполнитьПараметрыИнициализацииПеремаркировкаТоваров(Запрос, ДокументСсылка);

	// Формирование текста запроса.
	ТекстыЗапроса = Новый СписокЗначений;
	ТекстЗапросаТаблицаСвободныеОстаткиПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаОбеспечениеЗаказовПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыНаСкладахПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаДвиженияСерийТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыОрганизацийПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаТоварыОрганизацийКПередачеПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаТаблицаСебестоимостьТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	ТекстЗапросаДвиженияНоменклатураДоходыРасходыПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	//++ НЕ УТ
	ТекстЗапросаТаблицаПорядокОтраженияПрочихОперацийПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры);
	//-- НЕ УТ

	// Исполнение запроса и выгрузка полученных таблиц для движений.
	ПроведениеСерверУТ.ИницализироватьТаблицыДляДвижений(Запрос, ТекстыЗапроса, ДополнительныеСвойства.ТаблицыДляДвижений, Истина);
	
КонецПроцедуры

Процедура ЗаполнитьПараметрыИнициализацииПеремаркировкаТоваров(Запрос, ДокументСсылка)

	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);

	Запрос.Текст =
		"ВЫБРАТЬ
		|	Таблица.Ссылка                         КАК Ссылка,
		|	Таблица.Дата                           КАК Период,
		|	Таблица.Организация                    КАК Организация,
		|	Таблица.Склад                          КАК Склад,
		|	Таблица.Подразделение                  КАК Подразделение,
		|	Таблица.МаркировкаДляДеятельности      КАК МаркировкаДляДеятельности,
		|	Таблица.НаправлениеДеятельности        КАК НаправлениеДеятельности,
		|	Таблица.НазначениеКиЗ                  КАК НазначениеКиЗ,
		|	Таблица.СтатьяРасходов                 КАК СтатьяРасходов,
		|	Таблица.АналитикаРасходов              КАК АналитикаРасходов
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ КАК Таблица
		|ГДЕ
		|	Таблица.Ссылка = &Ссылка";

	Реквизиты = Запрос.Выполнить().Выбрать();
	Реквизиты.Следующий();
	
	Запрос.УстановитьПараметр("Ссылка",                    Реквизиты.Ссылка);
	Запрос.УстановитьПараметр("Период",                    Реквизиты.Период);
	Запрос.УстановитьПараметр("Организация",               Реквизиты.Организация);
	Запрос.УстановитьПараметр("Склад",                     Реквизиты.Склад);
	Запрос.УстановитьПараметр("Подразделение",             Реквизиты.Подразделение);
	Запрос.УстановитьПараметр("МаркировкаДляДеятельности", Реквизиты.МаркировкаДляДеятельности);
	Запрос.УстановитьПараметр("НаправлениеДеятельности",   Реквизиты.НаправлениеДеятельности);
	Запрос.УстановитьПараметр("НазначениеКиЗ",             Реквизиты.НазначениеКиЗ);
	Запрос.УстановитьПараметр("СтатьяРасходов",            Реквизиты.СтатьяРасходов);
	Запрос.УстановитьПараметр("АналитикаРасходов",         Реквизиты.АналитикаРасходов);
	
	Запрос.УстановитьПараметр("Валюта",                Константы.ВалютаУправленческогоУчета.Получить());
	Запрос.УстановитьПараметр("КорВидЗапасов",         Справочники.ВидыЗапасов.ВидЗапасовДокумента(Реквизиты.Организация, Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию, Неопределено));
	Запрос.УстановитьПараметр("ПустойКлючСвязи",       Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000"));
	Запрос.УстановитьПараметр("ПустаяСерия",           Справочники.СерииНоменклатуры.ПустаяСсылка());
	Запрос.УстановитьПараметр("ХозяйственнаяОперация", Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию);
	
	Запрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоВидамЗапасов",     ПолучитьФункциональнуюОпцию("УчитыватьСебестоимостьТоваровПоВидамЗапасов"));
	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета"));
	Запрос.УстановитьПараметр("ИспользуетсяНазначение",                          ПолучитьФункциональнуюОпцию("УчитыватьСебестоимостьТоваровПоВидамЗапасов"));
	
	ИнициализироватьКлючиАналитикиНоменклатуры(Запрос.Параметры, "ПеремаркировкаТоваровГИСМ");
	
КонецПроцедуры

Функция ТекстЗапросаВтТаблицаСерииТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса)
	
	ИмяРегистра = "ВтТаблицаСерииТоваров";

	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаСерии.Номенклатура                                   КАК Номенклатура,
		|	ТаблицаСерии.Характеристика                                 КАК Характеристика,
		|	&НазначениеКиЗ                                              КАК Назначение,
		|	ТаблицаСерии.Количество                                     КАК Количество,
		|	МАКСИМУМ(ТаблицаТовары.СтатусУказанияСерий)                 КАК СтатусУказанияСерий,
		|	ТаблицаСерии.Серия                                          КАК Серия,
		|	МИНИМУМ(ТаблицаСерии.НомерСтроки)                           КАК НомерСтроки,
		|	ЛОЖЬ                                                        КАК КонтролироватьОстатки
		|ПОМЕСТИТЬ ВтТаблицаСерииТоваров
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ.СерииКиЗ КАК ТаблицаСерии
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|		ПО ТаблицаСерии.Ссылка = ТаблицаТовары.Ссылка
		|			И ТаблицаСерии.Номенклатура = ТаблицаТовары.Номенклатура
		|			И ТаблицаСерии.Характеристика = ТаблицаТовары.Характеристика
		|ГДЕ
		|	ТаблицаСерии.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаСерии.Номенклатура,
		|	ТаблицаСерии.Характеристика,
		|	&НазначениеКиЗ,
		|	ТаблицаСерии.Серия,
		|	ТаблицаСерии.Количество
		|
		|ИМЕЮЩИЕ
		|	МАКСИМУМ(ТаблицаТовары.СтатусУказанияСерий) В (2, 4)";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса)
	
	ИмяРегистра = "ВтВидыЗапасов";
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаВидыЗапасов.НомерСтроки                КАК НомерСтроки,
		|	Справочник.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
		|	Справочник.ВидЗапасовВладельца                КАК ВидЗапасовВладельца,
		|	ТаблицаВидыЗапасов.ВидЗапасов                 КАК ВидЗапасов,
		|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	АналитикаБезНазначения.КлючАналитики          КАК АналитикаУчетаНоменклатурыБезНазначения,
		|	Аналитика.Номенклатура                        КАК Номенклатура,
		|	Аналитика.Характеристика                      КАК Характеристика,
		|	ТаблицаВидыЗапасов.НомерГТД                   КАК НомерГТД,
		|	ТаблицаВидыЗапасов.Количество                 КАК Количество,
		|	&ХозяйственнаяОперация                        КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(&СтатьяРасходов КАК ПланВидовХарактеристик.СтатьиРасходов).ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|	ИНАЧЕ
		|		&МаркировкаДляДеятельности
		|	КОНЕЦ                                         КАК НалогообложениеНДС,
		|	&СтатьяРасходов             КАК СтатьяРасходов,
		|	&АналитикаРасходов          КАК АналитикаРасходов,
		|	ТаблицаВидыЗапасов.ВидЗапасов КАК КорВидЗапасов,
		|	ТаблицаВидыЗапасов.ВидЗапасов.ТипЗапасов      КАК ТипЗапасов,
		|	ТаблицаВидыЗапасов.ИдентификаторСтроки        КАК ИдентификаторСтроки
		|ПОМЕСТИТЬ ВтВидыЗапасов
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ.ВидыЗапасов КАК ТаблицаВидыЗапасов
		|
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		Документ.МаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|	ПО
		|		ТаблицаВидыЗапасов.Ссылка = ТаблицаТовары.Ссылка И ТаблицаВидыЗапасов.ИдентификаторСтроки = ТаблицаТовары.ИдентификаторСтроки
		//-- НЕ УТ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		Справочник.ВидыЗапасов КАК Справочник
		|	ПО
		|		ТаблицаВидыЗапасов.ВидЗапасов = Справочник.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО
		|		ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|	ПО
		|		Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
		|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
		|		И Аналитика.Серия = АналитикаБезНазначения.Серия
		|		И Аналитика.Склад = АналитикаБезНазначения.Склад
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
		|	ПО
		|		&СтатьяРасходов = СтатьиРасходов.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Организация = &Организация
		|		И АналитикаРасчетов.Партнер = Справочник.Комитент
		|		И АналитикаРасчетов.Контрагент = Справочник.Контрагент
		|		И АналитикаРасчетов.Договор = Справочник.Договор
		|		И АналитикаРасчетов.НаправлениеДеятельности = &НаправлениеДеятельности
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаРасчетовИнтеркампани
		|		ПО АналитикаРасчетовИнтеркампани.Организация = &Организация
		|		И АналитикаРасчетовИнтеркампани.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
		|		И АналитикаРасчетовИнтеркампани.Контрагент = Справочник.Контрагент
		|		И АналитикаРасчетовИнтеркампани.Договор = Справочник.Договор
		|		И АналитикаРасчетов.НаправлениеДеятельности = &НаправлениеДеятельности
		|ГДЕ
		|	ТаблицаВидыЗапасов.Ссылка = &Ссылка";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаСвободныеОстаткиПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "СвободныеОстатки";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период                                КАК Период,
		|	&Склад                                 КАК Склад,
		|	ТаблицаТовары.НоменклатураКиЗ          КАК Номенклатура,
		|	ТаблицаТовары.ХарактеристикаКиЗ        КАК Характеристика,
		|	ТаблицаТовары.Количество               КАК ВНаличии,
		|	
		|	ВЫБОР КОГДА &НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) ТОГДА
		|				ТаблицаТовары.Количество
		|			ИНАЧЕ
		|				0
		|		КОНЕЦ                              КАК ВРезервеПодЗаказ
		|	
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|ГДЕ
		|	ТаблицаТовары.Ссылка = &Ссылка";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаОбеспечениеЗаказовПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	ИмяРегистра = "ОбеспечениеЗаказов";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период                                КАК Период,
		|	&Склад                                 КАК Склад,
		|	ТаблицаТовары.НоменклатураКиЗ          КАК Номенклатура,
		|	ТаблицаТовары.ХарактеристикаКиЗ        КАК Характеристика,
		|	&НазначениеКиЗ                         КАК Назначение,
		|	ТаблицаТовары.Количество               КАК Потребность,
		|	0                                      КАК КЗаказу,
		|	ТаблицаТовары.Количество               КАК НаличиеПодЗаказ
		|
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК ТаблицаТовары
		|ГДЕ
		|	ТаблицаТовары.Ссылка = &Ссылка
		|	И &НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаТоварыНаСкладахПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыНаСкладах";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтТаблицаСерииТоваров", ТекстыЗапроса) Тогда
		ТекстЗапросаВтТаблицаСерииТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса)
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период КАК Период,
		|	&Склад КАК Склад,
		|	ТаблицаТовары.Номенклатура             КАК Номенклатура,
		|	ТаблицаТовары.Характеристика           КАК Характеристика,
		|	&НазначениеКиЗ                         КАК Назначение,
		|	ТаблицаТовары.НомерСтроки              КАК НомерСтроки,
		|	ТаблицаТовары.Серия                    КАК Серия,
		|	ТаблицаТовары.Количество               КАК ВНаличии,
		|	0                                      КАК КОтгрузке,
		|	ТаблицаТовары.КонтролироватьОстатки    КАК КонтролироватьОстатки
		|ИЗ
		|	ВтТаблицаСерииТоваров КАК ТаблицаТовары
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаТаблицаДвиженияСерийТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ДвиженияСерийТоваров";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ТаблицаСерии.Номенклатура КАК Номенклатура,
	|	ТаблицаСерии.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВЫРАЗИТЬ (&НазначениеКиЗ КАК Справочник.Назначения).ДвиженияПоСкладскимРегистрам, ЛОЖЬ)
	|			ТОГДА &НазначениеКиЗ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	КОНЕЦ КАК Назначение,
	|	ТаблицаСерии.Серия КАК Серия,
	|	-ТаблицаСерии.Количество КАК Количество,
	|	&Склад КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка) КАК ПомещениеОтправителя,
	|	НЕОПРЕДЕЛЕНО КАК ПомещениеПолучателя,
	|	ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.МаркировкаПродукцииДляГИСМ) КАК СкладскаяОперация,
	|	&Ссылка КАК Документ,
	|	&Период КАК Период,
	|	ИСТИНА КАК ЭтоСкладскоеДвижение
	|ИЗ
	|	Документ.ПеремаркировкаТоваровГИСМ.СерииКиЗ КАК ТаблицаСерии
	|ГДЕ
	|	ТаблицаСерии.Ссылка = &Ссылка
	|	И ТаблицаСерии.Количество <> 0
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	ТаблицаСерии.Номенклатура КАК Номенклатура,
	|	ТаблицаСерии.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВЫРАЗИТЬ (&НазначениеКиЗ КАК Справочник.Назначения).ДвиженияПоСкладскимРегистрам, ЛОЖЬ)
	|			ТОГДА &НазначениеКиЗ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	КОНЕЦ КАК Назначение,
	|	ТаблицаСерии.Серия КАК Серия,
	|	ТаблицаСерии.Количество КАК Количество,
	|	&Склад КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка) КАК ПомещениеОтправителя,
	|	НЕОПРЕДЕЛЕНО КАК ПомещениеПолучателя,
	|	ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.МаркировкаПродукцииДляГИСМ) КАК СкладскаяОперация,
	|	&Ссылка КАК Документ,
	|	&Период КАК Период,
	|	ИСТИНА КАК ЭтоСкладскоеДвижение
	|ИЗ
	|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК ТаблицаСерии
	|ГДЕ
	|	ТаблицаСерии.Ссылка = &Ссылка
	|	И ТаблицаСерии.Количество <> 0
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	ТаблицаСерии.Номенклатура КАК Номенклатура,
	|	ТаблицаСерии.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВЫРАЗИТЬ (&НазначениеКиЗ КАК Справочник.Назначения).ДвиженияПоСкладскимРегистрам, ЛОЖЬ)
	|			ТОГДА &НазначениеКиЗ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	КОНЕЦ КАК Назначение,
	|	ТаблицаСерии.СписываемаяСерия КАК Серия,
	|	-ТаблицаСерии.Количество КАК Количество,
	|	&Склад КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка) КАК ПомещениеОтправителя,
	|	НЕОПРЕДЕЛЕНО КАК ПомещениеПолучателя,
	|	ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.МаркировкаПродукцииДляГИСМ) КАК СкладскаяОперация,
	|	&Ссылка КАК Документ,
	|	&Период КАК Период,
	|	ИСТИНА КАК ЭтоСкладскоеДвижение
	|ИЗ
	|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК ТаблицаСерии
	|ГДЕ
	|	ТаблицаСерии.Ссылка = &Ссылка
	|	И ТаблицаСерии.Количество <> 0
	|
	|";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);

	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстЗапросаТаблицаТоварыОрганизацийПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыОрганизаций";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ТаблицаВидыЗапасов.НомерСтроки КАК НомерСтроки,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&Период КАК Период,
		|	&Склад КАК Склад,
		|	&Организация КАК ОрганизацияОтгрузки,
		|	ВЫБОР КОГДА ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации ТОГДА
		|		ТаблицаВидыЗапасов.ВидЗапасовВладельца.Организация
		|	ИНАЧЕ
		|		&Организация
		|	КОНЕЦ КАК Организация,
		|
		|	ВЫБОР КОГДА ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации ТОГДА
		|		ТаблицаВидыЗапасов.ВидЗапасовВладельца
		|	ИНАЧЕ
		|		ТаблицаВидыЗапасов.ВидЗапасов
		|	КОНЕЦ КАК ВидЗапасов,
		|
		|	ТаблицаВидыЗапасов.Номенклатура КАК Номенклатура,
		|	ТаблицаВидыЗапасов.Характеристика КАК Характеристика,
		|	ТаблицаВидыЗапасов.НомерГТД КАК НомерГТД,
		|	ТаблицаВидыЗапасов.Количество КАК Количество,
		|	ВЫБОР 
		|		КОГДА ТаблицаВидыЗапасов.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
		|				И ТаблицаВидыЗапасов.СтатьяРасходов.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			ТОГДА
		|				ВЫБОР ТаблицаВидыЗапасов.СтатьяРасходов.ВидЦенностиНДС
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС)
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОбъектыНезавершенногоСтроительства) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС)
		|					КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА) ТОГДА
		|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставНМА)
		|				КОНЕЦ
		|		КОГДА ТаблицаВидыЗапасов.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
		|				И ТаблицаВидыЗапасов.СтатьяРасходов.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
		|		ИНАЧЕ
		|			&ХозяйственнаяОперация
		|	КОНЕЦ КАК ХозяйственнаяОперация,
		|
		|	ТаблицаВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
		|
		|	ТаблицаВидыЗапасов.СтатьяРасходов КАК СтатьяРасходов,
		|	ТаблицаВидыЗапасов.АналитикаРасходов КАК АналитикаРасходов,
		|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ИЗ
		|	ВтВидыЗапасов КАК ТаблицаВидыЗапасов
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаТоварыОрганизацийКПередачеПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ТоварыОрганизацийКПередаче";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ТаблицаВидыЗапасов.НомерСтроки                     КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	&Период                                            КАК Период,
	|	&Склад                                             КАК Склад,
	|	ТаблицаВидыЗапасов.ВидЗапасовВладельца.Организация КАК ОрганизацияВладелец,
	|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры      КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВидыЗапасов.ВидЗапасов                      КАК ВидЗапасовПродавца,
	|	ТаблицаВидыЗапасов.НомерГТД                        КАК НомерГТД,
	|	ТаблицаВидыЗапасов.Номенклатура                    КАК Номенклатура,
	|	ТаблицаВидыЗапасов.Характеристика                  КАК Характеристика,
	|	ТаблицаВидыЗапасов.Количество                      КАК Количество,
	|	&ХозяйственнаяОперация                             КАК ХозяйственнаяОперация,
	|	ТаблицаВидыЗапасов.НалогообложениеНДС              КАК НалогообложениеНДС
	|ИЗ
	|	ВтВидыЗапасов КАК ТаблицаВидыЗапасов
	|ГДЕ
	|	ТаблицаВидыЗапасов.РеализацияЗапасовДругойОрганизации
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаТаблицаСебестоимостьТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "СебестоимостьТоваров";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;

	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Строки.НомерСтроки КАК НомерСтрокиДокумента,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	&Период КАК Период,
	|	ВЫБОР КОГДА &ИспользуетсяНазначение
	|		ТОГДА Строки.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ Строки.АналитикаУчетаНоменклатурыБезНазначения
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	&Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
	|
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		Строки.ВидЗапасов
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидЗапасов,
	|
	|	Строки.Количество КАК Количество,
	|	0 КАК СтоимостьРегл,
	|	&ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|
	|	Неопределено КАК КорРазделУчета,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		Строки.КорВидЗапасов
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорВидЗапасов,
	|	Неопределено КАК КорАналитикаУчетаНоменклатуры,
	|
	|	&СтатьяРасходов КАК СтатьяРасходовСписания,
	|	&АналитикаРасходов КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	//++ НЕ УТ
	|	Строки.ИдентификаторСтроки КАК ИдентификаторСтроки,
	//-- НЕ УТ
	|	&Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции
	|ИЗ
	|	ВтВидыЗапасов КАК Строки
	|";
		
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаДвиженияНоменклатураДоходыРасходыПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ДвиженияНоменклатураДоходыРасходы";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	&Период КАК Период,
	|	&ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	&Организация КАК Организация,
	|	&Подразделение КАК Подразделение,
	|
	|	&НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	|	ВЫБОР КОГДА &ИспользуетсяНазначение
	|		ТОГДА Строки.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ Строки.АналитикаУчетаНоменклатурыБезНазначения
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	&Склад КАК Склад,
	|
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|			Строки.КорВидЗапасов
	|		ИНАЧЕ
	|			Строки.ВидЗапасов
	|		КОНЕЦ
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВидЗапасов,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА
	|		ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|			Строки.КорВидЗапасов.ТипЗапасов
	|		ИНАЧЕ
	|			Строки.ТипЗапасов
	|		КОНЕЦ
	|	ИНАЧЕ
	|		НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ТипЗапасов,
	|
	|	&НаправлениеДеятельности КАК НаправлениеДеятельностиСтатьи,
	|	&СтатьяРасходов КАК СтатьяДоходовРасходов,
	|	&АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Строки.Количество КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА
	|				ВЫБОР КОГДА Строки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|					Строки.КорВидЗапасов
	|				ИНАЧЕ
	|					Строки.ВидЗапасов
	|				КОНЕЦ
	|		ИНАЧЕ Строки.Номенклатура
	|	КОНЕЦ КАК ИсточникГФУНоменклатуры
	|
	|ИЗ
	|	ВтВидыЗапасов КАК Строки";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

//++ НЕ УТ

Функция ТекстЗапросаТаблицаПорядокОтраженияПрочихОперацийПеремаркировкаТоваров(Запрос, ТекстыЗапроса, Регистры)
	
	ИмяРегистра = "ПорядокОтраженияПрочихОпераций";
	
	Если НЕ ПроведениеСерверУТ.ТребуетсяТаблицаДляДвижений(ИмяРегистра, Регистры) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НЕ ПроведениеСерверУТ.ЕстьТаблицаЗапроса("ВтВидыЗапасов", ТекстыЗапроса) Тогда
		ТекстЗапросаВтВидыЗапасовПеремаркировкаТоваров(Запрос, ТекстыЗапроса);
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	&Период	КАК Дата,
	|	&Организация КАК Организация,
	|	&Ссылка КАК Документ,
	|	"""" КАК ИдентификаторСтроки
	|ИЗ
	|	ВтВидыЗапасов КАК Строки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
	|		ПО Статья.Ссылка = &СтатьяРасходов
	|УПОРЯДОЧИТЬ ПО
	|	ИдентификаторСтроки";
	
	ТекстыЗапроса.Добавить(ТекстЗапроса, ИмяРегистра);
	
	Возврат ТекстЗапроса;
	
КонецФункции

//-- НЕ УТ

Функция АдаптированныйТекстЗапросаДвиженийПоРегиструПеремаркировкаТоваров(ИмяРегистра) Экспорт

	Запрос = Новый Запрос;
	ТекстыЗапроса = Новый СписокЗначений;
	
	ПолноеИмяДокумента = "Документ.ПеремаркировкаТоваровГИСМ";
	
	ЗначенияПараметров = Новый Структура();
		
	Если ИмяРегистра = "ДвиженияСерийТоваров" Тогда
		
		ТекстЗапроса = ТекстЗапросаТаблицаДвиженияСерийТоваровПеремаркировкаТоваров(Запрос, ТекстыЗапроса, ИмяРегистра);
		СинонимТаблицыДокумента = "ТаблицаСерии";
		
	Иначе
		ТекстИсключения = НСтр("ru = 'В документе %ПолноеИмяДокумента% не реализована адаптация текста запроса формирования движений по регистру %ИмяРегистра%.'");
		ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ПолноеИмяДокумента%", ПолноеИмяДокумента);
		ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ИмяРегистра%", ИмяРегистра);
		
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	Результат = ОбновлениеИнформационнойБазыУТ.РезультатАдаптацииЗапроса();
	Результат.ЗначенияПараметров = ЗначенияПараметров;
	Результат.ТекстЗапроса = ОбновлениеИнформационнойБазыУТ.АдаптироватьЗапросМеханизмаПроведения(ТекстЗапроса,
																								ПолноеИмяДокумента,
																								СинонимТаблицыДокумента);

	Возврат Результат;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПроцедурыИФункцииФормыДокумента

Функция ПолучитьКизы(СписокНоменклатураКиЗ, GTIN)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК НоменклатураКИЗ,
	|	ХарактеристикиНоменклатуры.Ссылка КАК ХарактеристикаКиЗ,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.КиЗГИСМGTIN, Номенклатура.КиЗГИСМGTIN) КАК GTIN,
	|	ВЫБОР
	|		КОГДА Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
	|			ИЛИ Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
	|			ИЛИ Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ХарактеристикиКиЗИспользуются
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (Номенклатура.Ссылка = ХарактеристикиНоменклатуры.Владелец
	|				ИЛИ Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец)
	|ГДЕ
	|	Номенклатура.Ссылка В (&СписокНоменклатураКиЗ)
	|	И ЕСТЬNULL(ХарактеристикиНоменклатуры.КиЗГИСМGTIN, Номенклатура.КиЗГИСМGTIN) В(&GTIN)";
	
	Запрос.УстановитьПараметр("GTIN", GTIN);
	Запрос.УстановитьПараметр("СписокНоменклатураКиЗ", СписокНоменклатураКиЗ);
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат
	
КонецФункции

#КонецОбласти 

#Область Прочее

// Функция подбирает склад для заполнения шапки документа Маркировка.
//
//Параметры:
//	МассивСкладов - Массив - массив складов
//
// Возвращаемое значение:
//	СправочникСсылка.
//
Функция СкладШапкиПоМассиву(МассивСкладов)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Склады.Родитель КАК Группа,
	|	ВЫБОР
	|		КОГДА ИспользоватьСкладыВТабличнойЧастиДокументовЗакупки.Значение
	|				И Склады.Родитель.ВыборГруппы = ЗНАЧЕНИЕ(Перечисление.ВыборГруппыСкладов.РазрешитьВЗаказахИНакладных)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ГруппаДоступна,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Склады.Ссылка) КАК КоличествоСкладов,
	|	МАКСИМУМ(Склады.Ссылка) КАК Склад
	|ИЗ
	|	Справочник.Склады КАК Склады,
	|	Константа.ИспользоватьСкладыВТабличнойЧастиДокументовЗакупки КАК ИспользоватьСкладыВТабличнойЧастиДокументовЗакупки
	|ГДЕ
	|	Склады.Ссылка В(&МассивСкладов)
	|
	|СГРУППИРОВАТЬ ПО
	|	Склады.Родитель,
	|	ВЫБОР
	|		КОГДА ИспользоватьСкладыВТабличнойЧастиДокументовЗакупки.Значение
	|				И Склады.Родитель.ВыборГруппы = ЗНАЧЕНИЕ(Перечисление.ВыборГруппыСкладов.РазрешитьВЗаказахИНакладных)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ");
	
	Запрос.УстановитьПараметр("МассивСкладов", МассивСкладов);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() = 1 Тогда
		
		Выборка.Следующий();
		
		Если Выборка.КоличествоСкладов = 1 Тогда
			Возврат Выборка.Склад;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#Область ОбновлениеИнформационнойБазы 

// Обработчик обновления УТ 11.3.1,
// заполняет назначение в аналитике учета номенклатуры.
//
Процедура МаркировкаТоваровЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Товары.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.МаркировкаТоваровГИСМ.Товары КАК Товары
	|ГДЕ
	|	(Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
	|		И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И Товары.Ссылка.Проведен)
	|");
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
КонецПроцедуры

// Заполняет данные о назначении в аналитике учета номенклатуры.
//
Процедура МаркировкаТоваровОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	ПолноеИмяДокумента = "Документ.МаркировкаТоваровГИСМ";
	МетаданныеДокумента = Метаданные.Документы.МаркировкаТоваровГИСМ;
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Результат = ОбновлениеИнформационнойБазы.СоздатьВременнуюТаблицуСсылокДляОбработки(Параметры.Очередь, ПолноеИмяДокумента, МенеджерВременныхТаблиц);
	Если НЕ Результат.ЕстьДанныеДляОбработки Тогда
		Параметры.ОбработкаЗавершена = Истина;
		Возврат;
	КонецЕсли;
	Если НЕ Результат.ЕстьЗаписиВоВременнойТаблице Тогда
		Параметры.ОбработкаЗавершена = Ложь;
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КОбработке.Ссылка КАК Ссылка,
	|	КОбработке.Ссылка.ВерсияДанных КАК ВерсияДанных
	|ИЗ
	|	&ВТДокументыДляОбработки КАК КОбработке
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВТДокументыДляОбработки", Результат.ИмяВременнойТаблицы);
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		НачатьТранзакцию();
		Попытка
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяДокумента);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			Блокировка.Заблокировать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось заблокировать документ: %Ссылка% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
									УровеньЖурналаРегистрации.Предупреждение,
									МетаданныеДокумента,
									Выборка.Ссылка,
									ТекстСообщения);
			Продолжить;
		КонецПопытки;
		
		ДокОбъект = ОбновлениеИнформационнойБазыУТ.ПроверитьПолучитьОбъект(Выборка.Ссылка, Выборка.ВерсияДанных, Параметры.Очередь);
		Если ДокОбъект = Неопределено Тогда
			ЗафиксироватьТранзакцию();
			Продолжить;
		КонецЕсли;
		
		ПараметрыЗаполненияКлючей = РегистрыСведений.АналитикаУчетаНоменклатуры.ПараметрыЗаполненияКлючейАналитики();
		МестаУчета = РегистрыСведений.АналитикаУчетаНоменклатуры.МестаУчета(
			Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию,
			ДокОбъект.Склад,
			ДокОбъект.Подразделение,
			Неопределено);
			
		ИменаПолей = РегистрыСведений.АналитикаУчетаНоменклатуры.ИменаПолейКоллекцииПоУмолчанию();
		ИменаПолей.Номенклатура = "НоменклатураКиЗ";
		ИменаПолей.Характеристика = "ХарактеристикаКиЗ";
		ИменаПолей.Серия = "";
		ИменаПолей.СтатусУказанияСерий = "";
		ИменаПолей.Вставить("Назначение", Новый Структура("ТекстПоля,Значение","&Назначение",ДокОбъект.НазначениеКиЗ));
		
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокОбъект.Товары, МестаУчета, ИменаПолей, Ложь, ПараметрыЗаполненияКлючей);

		ДополнитьКлюч = Истина;
		ПараметрыЗаполненияКлючейВидовЗапасов = РегистрыСведений.АналитикаУчетаНоменклатуры.ПараметрыЗаполненияКлючейАналитики();
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокОбъект.ВидыЗапасов, МестаУчета, Неопределено, ДополнитьКлюч, ПараметрыЗаполненияКлючейВидовЗапасов);
		
		Попытка
			Если ПараметрыЗаполненияКлючей.ИзмененаАналитика ИЛИ ПараметрыЗаполненияКлючейВидовЗапасов.ИзмененаАналитика Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьОбъект(ДокОбъект);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Выборка.Ссылка);
			КонецЕсли;
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось обработать документ: %Регистратор% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Регистратор%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Предупреждение,
				Метаданные.Документы.ПорчаТоваров,
				,
				ТекстСообщения);
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяДокумента);
КонецПроцедуры

// Регистрирует данные для обработчика обновления МаркировкаТоваровСгенерироватьКлючиАналитикиНоменклатуры
//
Процедура МаркировкаТоваровЗарегистрироватьДанныеКОбновлениюКлючейАналитики(Параметры) Экспорт
	
	ТекстЗапроса = Справочники.КлючиАналитикиУчетаНоменклатуры.ТекстЗапросаГенерацииКлючейКОбработке()
	+ "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Товары.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.МаркировкаТоваровГИСМ.Товары КАК Товары
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтКлючиКГенерации КАК КлючиКГенерации
	|	ПО КлючиКГенерации.Ссылка = Товары.АналитикаУчетаНоменклатуры
	|		И КлючиКГенерации.Назначение = Товары.Ссылка.НазначениеКиЗ
	|ГДЕ
	|	Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
	|	И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	И Товары.Ссылка.Проведен
	|	И КлючиКГенерации.Ссылка ЕСТЬ NULL
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ОтборПоРегистратору", " ТИПЗНАЧЕНИЯ(ДанныеРегистра.Регистратор) = ТИП(Документ.МаркировкаТоваровГИСМ)");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "//ПоместитьВТ", "ПОМЕСТИТЬ ВтКлючиКГенерации");
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Справочники.КлючиАналитикиУчетаНоменклатуры.УстановитьПараметрыЗапросаКлючей(Запрос);
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
КонецПроцедуры

// Обработчик обновления документа, по табличным частям генерирует недостающие ключи аналитики учета номенклатуры в ИБ.
Процедура МаркировкаТоваровСгенерироватьКлючиАналитикиНоменклатуры(Параметры) Экспорт
	
	ПолноеИмяДокумента = "Документ.МаркировкаТоваровГИСМ";
	МетаданныеДокумента = Метаданные.Документы.МаркировкаТоваровГИСМ;
	
	ДополнительныеПараметрыВыборкиДанных = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыВыборкиДанныхДляОбработки();
	ДополнительныеПараметрыВыборкиДанных.ВыбиратьПорциями = Ложь;
	
	Выборка = ОбновлениеИнформационнойБазы.ВыбратьСсылкиДляОбработки(Параметры.Очередь, ПолноеИмяДокумента, ДополнительныеПараметрыВыборкиДанных);
	Пока Выборка.Следующий() Цикл
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Поля.Номенклатура,
		|	Поля.Характеристика,
		|	Поля.Серия,
		|	Поля.Склад,
		|	Товары.Ссылка.НазначениеКиЗ КАК Назначение,
		|	Поля.СтатьяКалькуляции
		|ИЗ
		|	Документ.МаркировкаТоваровГИСМ.Товары КАК Товары
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Поля
		|	ПО Поля.Ссылка = Товары.АналитикаУчетаНоменклатуры
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО Поля.Номенклатура = Аналитика.Номенклатура
		|		И Поля.Характеристика = Аналитика.Характеристика
		|		И Поля.Серия = Аналитика.Серия
		|		И Поля.Склад = Аналитика.Склад
		|		И Товары.Ссылка.НазначениеКиЗ = Аналитика.Назначение
		|		И Поля.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|ГДЕ
		|	Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
		|	И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|	И Товары.Ссылка.Проведен
		|	И Товары.Ссылка = &Ссылка
		|	И Аналитика.КлючАналитики ЕСТЬ NULL
		|");
		
		Запрос.УстановитьПараметр("Ссылка", Выборка.Ссылка);
		
		НачатьТранзакцию();
		Попытка
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяДокумента);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
			Блокировка.Заблокировать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось заблокировать документ: %Ссылка% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
									УровеньЖурналаРегистрации.Предупреждение,
									МетаданныеДокумента,
									Выборка.Ссылка,
									ТекстСообщения);
			Продолжить;
		КонецПопытки;
		
		Ключи = Запрос.Выполнить().Выбрать();
		Пока Ключи.Следующий() Цикл
			Попытка
				РегистрыСведений.АналитикаУчетаНоменклатуры.СоздатьКлючАналитики(Ключи, Истина);
			Исключение
				ТекстСообщения = НСтр("ru = 'Не удалось инициализировать ключ аналитики учета номенклатуры: %Ключ% по причине: %Причина%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ключ%", Выборка.Ссылка);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), УровеньЖурналаРегистрации.Предупреждение,
					МетаданныеДокумента, ТекстСообщения);
				КонецПопытки;
		КонецЦикла;
		ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Выборка.Ссылка);
		ЗафиксироватьТранзакцию();
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяДокумента);
КонецПроцедуры

// Обработчик обновления УТ 11.3.1,
// заполняет назначение в аналитике учета номенклатуры.
//
Процедура ПеремаркировкаТоваровЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Товары.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК Товары
	|ГДЕ
	|	(Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
	|		И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И Товары.Ссылка.Проведен)
	|");
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
КонецПроцедуры

// Заполняет данные о назначении в аналитике учета номенклатуры.
//
Процедура ПеремаркировкаТоваровОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	ПолноеИмяДокумента = "Документ.ПеремаркировкаТоваровГИСМ";
	МетаданныеДокумента = Метаданные.Документы.ПеремаркировкаТоваровГИСМ;
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Результат = ОбновлениеИнформационнойБазы.СоздатьВременнуюТаблицуСсылокДляОбработки(Параметры.Очередь, ПолноеИмяДокумента, МенеджерВременныхТаблиц);
	Если НЕ Результат.ЕстьДанныеДляОбработки Тогда
		Параметры.ОбработкаЗавершена = Истина;
		Возврат;
	КонецЕсли;
	Если НЕ Результат.ЕстьЗаписиВоВременнойТаблице Тогда
		Параметры.ОбработкаЗавершена = Ложь;
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КОбработке.Ссылка КАК Ссылка,
	|	КОбработке.Ссылка.ВерсияДанных КАК ВерсияДанных
	|ИЗ
	|	&ВТДокументыДляОбработки КАК КОбработке
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВТДокументыДляОбработки", Результат.ИмяВременнойТаблицы);
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Попытка
			НачатьТранзакцию();
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяДокумента);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			Блокировка.Заблокировать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось заблокировать документ: %Ссылка% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
									УровеньЖурналаРегистрации.Предупреждение,
									МетаданныеДокумента,
									Выборка.Ссылка,
									ТекстСообщения);
			Продолжить;
		КонецПопытки;
		
		ДокОбъект = ОбновлениеИнформационнойБазыУТ.ПроверитьПолучитьОбъект(Выборка.Ссылка, Выборка.ВерсияДанных, Параметры.Очередь);
		Если ДокОбъект = Неопределено Тогда
			ЗафиксироватьТранзакцию();
			Продолжить;
		КонецЕсли;
			
		ПараметрыЗаполненияКлючей = РегистрыСведений.АналитикаУчетаНоменклатуры.ПараметрыЗаполненияКлючейАналитики();
		МестаУчета = РегистрыСведений.АналитикаУчетаНоменклатуры.МестаУчета(
			Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию,
			ДокОбъект.Склад,
			ДокОбъект.Подразделение,
			Неопределено);
			
		ИменаПолей = РегистрыСведений.АналитикаУчетаНоменклатуры.ИменаПолейКоллекцииПоУмолчанию();
		ИменаПолей.Номенклатура = "НоменклатураКиЗ";
		ИменаПолей.Характеристика = "ХарактеристикаКиЗ";
		ИменаПолей.Серия = "";
		ИменаПолей.СтатусУказанияСерий = "";
		ИменаПолей.Вставить("Назначение", Новый Структура("ТекстПоля,Значение","&Назначение",ДокОбъект.НазначениеКиЗ));
		
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокОбъект.Товары, МестаУчета, ИменаПолей, Ложь, ПараметрыЗаполненияКлючей);

		ДополнитьКлюч = Истина;
		ПараметрыЗаполненияКлючейВидовЗапасов = РегистрыСведений.АналитикаУчетаНоменклатуры.ПараметрыЗаполненияКлючейАналитики();
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗаполнитьВКоллекции(ДокОбъект.ВидыЗапасов, МестаУчета, Неопределено, ДополнитьКлюч, ПараметрыЗаполненияКлючейВидовЗапасов);
		
		Попытка
			Если ПараметрыЗаполненияКлючей.ИзмененаАналитика ИЛИ ПараметрыЗаполненияКлючейВидовЗапасов.ИзмененаАналитика Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьОбъект(ДокОбъект);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Выборка.Ссылка);
			КонецЕсли;
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось обработать документ: %Регистратор% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Регистратор%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Предупреждение,
				Метаданные.Документы.ПорчаТоваров,
				,
				ТекстСообщения);
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяДокумента);
КонецПроцедуры

// Регистрирует данные для обработчика обновления ПеремаркировкаТоваровСгенерироватьКлючиАналитикиНоменклатуры
//
Процедура ПеремаркировкаТоваровЗарегистрироватьДанныеКОбновлениюКлючейАналитики(Параметры) Экспорт
	
	ТекстЗапроса = Справочники.КлючиАналитикиУчетаНоменклатуры.ТекстЗапросаГенерацииКлючейКОбработке()
	+ "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Товары.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК Товары
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтКлючиКГенерации КАК КлючиКГенерации
	|	ПО КлючиКГенерации.Ссылка = Товары.АналитикаУчетаНоменклатуры
	|		И КлючиКГенерации.Назначение = Товары.Ссылка.НазначениеКиЗ
	|ГДЕ
	|	Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
	|	И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	И Товары.Ссылка.Проведен
	|	И КлючиКГенерации.Ссылка ЕСТЬ NULL
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ОтборПоРегистратору", " ТИПЗНАЧЕНИЯ(ДанныеРегистра.Регистратор) = ТИП(Документ.ПеремаркировкаТоваровГИСМ)");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "//ПоместитьВТ", "ПОМЕСТИТЬ ВтКлючиКГенерации");
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Справочники.КлючиАналитикиУчетаНоменклатуры.УстановитьПараметрыЗапросаКлючей(Запрос);
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
КонецПроцедуры

// Обработчик обновления документа, по табличным частям генерирует недостающие ключи аналитики учета номенклатуры в ИБ.
Процедура ПеремаркировкаТоваровСгенерироватьКлючиАналитикиНоменклатуры(Параметры) Экспорт
	
	ПолноеИмяДокумента = "Документ.ПеремаркировкаТоваровГИСМ";
	МетаданныеДокумента = Метаданные.Документы.ПеремаркировкаТоваровГИСМ;
	
	ДополнительныеПараметрыВыборкиДанных = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыВыборкиДанныхДляОбработки();
	ДополнительныеПараметрыВыборкиДанных.ВыбиратьПорциями = Ложь;
	
	Выборка = ОбновлениеИнформационнойБазы.ВыбратьСсылкиДляОбработки(Параметры.Очередь, ПолноеИмяДокумента, ДополнительныеПараметрыВыборкиДанных);
	Пока Выборка.Следующий() Цикл
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Поля.Номенклатура,
		|	Поля.Характеристика,
		|	Поля.Серия,
		|	Поля.Склад,
		|	Товары.Ссылка.НазначениеКиЗ КАК Назначение,
		|	Поля.СтатьяКалькуляции
		|ИЗ
		|	Документ.ПеремаркировкаТоваровГИСМ.Товары КАК Товары
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Поля
		|	ПО Поля.Ссылка = Товары.АналитикаУчетаНоменклатуры
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО Поля.Номенклатура = Аналитика.Номенклатура
		|		И Поля.Характеристика = Аналитика.Характеристика
		|		И Поля.Серия = Аналитика.Серия
		|		И Поля.Склад = Аналитика.Склад
		|		И Товары.Ссылка.НазначениеКиЗ = Аналитика.Назначение
		|		И Поля.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|ГДЕ
		|	Товары.АналитикаУчетаНоменклатуры.Назначение <> Товары.Ссылка.НазначениеКиЗ
		|	И Товары.Ссылка.НазначениеКиЗ <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|	И Товары.Ссылка.Проведен
		|	И Товары.Ссылка = &Ссылка
		|	И Аналитика.КлючАналитики ЕСТЬ NULL
		|");
		
		Запрос.УстановитьПараметр("Ссылка", Выборка.Ссылка);
		
		НачатьТранзакцию();
		
		Попытка
			НачатьТранзакцию();
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяДокумента);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
			Блокировка.Заблокировать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось заблокировать документ: %Ссылка% по причине: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%", Выборка.Ссылка);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
									УровеньЖурналаРегистрации.Предупреждение,
									МетаданныеДокумента,
									Выборка.Ссылка,
									ТекстСообщения);
			Продолжить;
		КонецПопытки;
		
		Ключи = Запрос.Выполнить().Выбрать();
		Пока Ключи.Следующий() Цикл
			Попытка
				РегистрыСведений.АналитикаУчетаНоменклатуры.СоздатьКлючАналитики(Ключи, Истина);
			Исключение
				ТекстСообщения = НСтр("ru = 'Не удалось инициализировать ключ аналитики учета номенклатуры: %Ключ% по причине: %Причина%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ключ%", Выборка.Ссылка);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), УровеньЖурналаРегистрации.Предупреждение,
					МетаданныеДокумента, ТекстСообщения);
				КонецПопытки;
		КонецЦикла;
		ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Выборка.Ссылка);
		
		ЗафиксироватьТранзакцию();
		
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяДокумента);
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#КонецОбласти
