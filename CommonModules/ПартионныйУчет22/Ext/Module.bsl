/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Механизм партионного учета версии 2.2
//
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Запуск расчета партий.
//
// Параметры:
//	ПараметрыЗапуска - Структура с ключами
//		Дата - Дата - период расчета
//		МассивОрганизаций - СправочникСсылка.Организации - рассчитывать только по указанной организации;
//			также будут пересчитаны партии по организациям, связанным по схеме Интеркампани с указанной
//					- Массив - массив организаций, по которым надо рассчитать партии, другие организации не рассчитываются
//		СхемаРасчета - ТаблицаЗначений - (см. УниверсальныеМеханизмыПартийИСебестоимости.СхемаРасчетаПартий)
//			уже построенная схема расчета может быть получена из модуля ПартионныйУчет
//		МестоВызоваРасчета - Строка - откуда вызван расчет, для протокола
//	ПараметрыРасчета - Структура - параметры расчета, сформированные в вызывающем механизме.
//	ПараметрыОтладки - Структура - предназначена для переопределения одноименных свойств структуры ПараметрыРасчета.
//		Подробнее см. пояснения в коде ИнициализироватьПараметрыРасчетаПартий() к параметру ПараметрыОтладки.
//
Процедура РассчитатьВсе(ПараметрыЗапуска, ПараметрыРасчета = Неопределено, ПараметрыОтладки = Неопределено) Экспорт
	
	Если НЕ УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПартионныйУчетВерсии22() Тогда
		// Расчет будет выполнен в версии 2.1
		ПартионныйУчет.РассчитатьВсе(ПараметрыЗапуска.Дата, ПараметрыЗапуска.МассивОрганизаций);
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ПараметрыОтладки = Неопределено Тогда
		ПараметрыОтладки = Новый Структура;
	КонецЕсли;
	
	// Запомним протоколы рассчитанных периодов в этом массиве и вернем их в место вызова расчета
	ПараметрыОтладки.Вставить("ПротоколыРасчета", Новый Массив);
	
	// Перенесем это справочное свойство в ПараметрыОтладки, для последующего вывода в протокол расчета
	Если ПараметрыЗапуска.Свойство("МестоВызоваРасчета") Тогда
		ПараметрыОтладки.Вставить("МестоВызоваРасчета", ПараметрыЗапуска.МестоВызоваРасчета);
	КонецЕсли;
	
	// Проверим, закончено ли обновление ИБ
	УниверсальныеМеханизмыПартийИСебестоимости.ПроверитьБлокировкуДанныхПриОбновленииИБ(Ложь, Истина, ПараметрыОтладки);
	
	#Область СхемаРасчета

	// Определим по каким периодам и организациям требуется перерасчет
	Если ПараметрыЗапуска.Свойство("СхемаРасчета") И ПараметрыЗапуска.Свойство("ВременныеТаблицы") Тогда
		СхемаРасчета = ПараметрыЗапуска.СхемаРасчета;
		ВременныеТаблицы = ПараметрыЗапуска.ВременныеТаблицы;
	Иначе
		НомерЗаданияДоРасчета = УниверсальныеМеханизмыПартийИСебестоимости.УвеличитьНомерЗаданияКРасчетуСебестоимости() - 1;
		
		НачатьТранзакцию();
	
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаблокироватьРегистрЗаданий(НомерЗаданияДоРасчета);
		
		СхемаРасчета = УниверсальныеМеханизмыПартийИСебестоимости.СхемаРасчетаПартий(
			ПараметрыЗапуска.Дата,
			ПараметрыЗапуска.МассивОрганизаций);
			
		Если СхемаРасчета.Количество() > 0 Тогда
			ВременныеТаблицы = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьВТЗаданияДоРасчета(
				НомерЗаданияДоРасчета,
				СхемаРасчета[СхемаРасчета.Количество() - 1].Организации);
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();

	КонецЕсли;
	
	ДатаПереходаНаПартионныйУчетВерсии22 = УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ДатаПереходаНаПартионныйУчетВерсии22();
	
	Если СхемаРасчета.Количество() > 0 И НачалоМесяца(СхемаРасчета[0].Дата) < ДатаПереходаНаПартионныйУчетВерсии22 Тогда
		
		// Некоторые периоды надо рассчитать в версии 2.1
		Для Каждого СтрокаСхемыРасчета Из СхемаРасчета Цикл
			Если КонецМесяца(СтрокаСхемыРасчета.Дата) + 1 = ДатаПереходаНаПартионныйУчетВерсии22 // последний месяц до перехода на ПУ 2.2
			 ИЛИ СтрокаСхемыРасчета = СхемаРасчета[СхемаРасчета.Количество() - 1] Тогда // последняя строка схемы расчета
				Прервать; // нашли строку схемы, по которую надо рассчитать партии в версии 2.1
			КонецЕсли;
		КонецЦикла;
		
		// Вызов расчета партий в версии 2.1
		ПартионныйУчет.РассчитатьВсе(СтрокаСхемыРасчета.Дата, СтрокаСхемыРасчета.Организации);
		
		НомерЗаданияДоРасчета = УниверсальныеМеханизмыПартийИСебестоимости.УвеличитьНомерЗаданияКРасчетуСебестоимости() - 1;
	
		НачатьТранзакцию();
		
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаблокироватьРегистрЗаданий(НомерЗаданияДоРасчета);
		
		// Обновим схему расчета
		СхемаРасчета = УниверсальныеМеханизмыПартийИСебестоимости.СхемаРасчетаПартий(
			ПараметрыЗапуска.Дата,
			ПараметрыЗапуска.МассивОрганизаций);
		
		Если СхемаРасчета.Количество() > 0 Тогда
			ВременныеТаблицы = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьВТЗаданияДоРасчета(
				НомерЗаданияДоРасчета,
				СхемаРасчета[СхемаРасчета.Количество() - 1].Организации);
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	КонецЕсли;
	
	Если СхемаРасчета.Количество() = 0 Тогда
		// Расчет не требуется
		Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'За период ""%1"" по ""%2"" расчет партий версии 2.2 не требуется.'"),
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеПериодаРасчета(ПараметрыЗапуска.Дата),
			УниверсальныеМеханизмыПартийИСебестоимости.ПредставлениеОрганизаций(ПараметрыЗапуска.МассивОрганизаций, ", "));
		ЗаписьЖурналаРегистрации(
			УниверсальныеМеханизмыПартийИСебестоимости.ИмяСобытияЖурналаРегистрации(
				Новый Структура("ЗапущенРасчетПартий", Истина), НСтр("ru='Расчет не требуется'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка())),
			УровеньЖурналаРегистрации.Информация,,,
			Комментарий);
		Возврат;
	ИначеЕсли НачалоМесяца(СхемаРасчета[0].Дата) < ДатаПереходаНаПартионныйУчетВерсии22 Тогда
		// Расчет невозможен - по каким-то причинам не выполнен пересчет периодов в версии 2.1
		Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'За период ""%1"" по ""%2"" расчет партий версии 2.2 невозможен - расчет партий версии 2.1 за предыдущие периоды выполнен с ошибками.'"),
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеПериодаРасчета(ПараметрыЗапуска.Дата),
			УниверсальныеМеханизмыПартийИСебестоимости.ПредставлениеОрганизаций(ПараметрыЗапуска.МассивОрганизаций, ", "));
		ЗаписьЖурналаРегистрации(
			УниверсальныеМеханизмыПартийИСебестоимости.ИмяСобытияЖурналаРегистрации(
				Новый Структура("ЗапущенРасчетПартий", Истина), НСтр("ru='Расчет невозможен'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка())),
			УровеньЖурналаРегистрации.Ошибка,,,
			Комментарий);
		Возврат;
	КонецЕсли;
	
	#КонецОбласти
	
	// Запомним состояние активности текущих итогов у обслуживаемых регистров
	СостояниеИтоговРегистров = УниверсальныеМеханизмыПартийИСебестоимости.СостояниеТекущихИтоговРегистров();
	
	Для Каждого СтрокаСхемыРасчета Из СхемаРасчета Цикл
		
		// Инициализируем параметры расчета
		ПараметрыЗапускаРасчетаПоМесяцу = Новый Структура;
		ПараметрыЗапускаРасчетаПоМесяцу.Вставить("Дата", 			   СтрокаСхемыРасчета.Дата);
		ПараметрыЗапускаРасчетаПоМесяцу.Вставить("МассивОрганизаций",  СтрокаСхемыРасчета.Организации);
		ПараметрыЗапускаРасчетаПоМесяцу.Вставить("ИзмененоДокументов", СтрокаСхемыРасчета.ИзмененоДокументов);
		
		//++ НЕ УТ
		УчетУСНСервер.ОбновитьЗаданияКЗакрытиюМесяцаПриВыполненииРеглОперации(
			ПараметрыЗапускаРасчетаПоМесяцу.Дата, ПараметрыЗапускаРасчетаПоМесяцу.МассивОрганизаций);
		//-- НЕ УТ
		
		// Формирует временные таблицы:
		// - ВТПравилаЗаполненияПоляТипЗаписи (правила проверки первичных записей регистра себестоимости)
		// - ВТОтборАналитикаПоПартнерам (ключи аналитики партнеров с рассчитываемыми организациями)
		// - ВТСтоимостьПартийТоваров (расширенный аналог регистра сведений СтоимостьТоваров с полями партий; пока пустая)
		ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапускаРасчетаПоМесяцу, ПараметрыРасчета, ПараметрыОтладки);
		
		ПараметрыРасчета.Вставить("ИсходныеЗаданияКРасчетуСебестоимости", ВременныеТаблицы);
		
		// Этап 0 - подготовка к расчету
		// - исправляет некорректные исходные данные
		// - выполняет проверку данных
		ПодготовкаИсходныхДанныхКРасчету(ПараметрыРасчета);
		
		//++ НЕ УТ
		
		// Этап 1
		// Формирует движения по регистрам:
		// - ТрудозатратыНезавершенногоПроизводства
		РаспределениеТрудозатрат(ПараметрыРасчета);
		
		//-- НЕ УТ
		//++ НЕ УТКА
		
		// Этап 2
		// Формирует движения по регистрам:
		// - ТоварыОрганизаций (расход)
		РаспределитьТоварыОрганизацийНаПроизводство(ПараметрыРасчета);
		
		// Этап 3
		// Формирует временные таблицы:
		// - ВтПроизводственныеЗатратыСебестоимостьТоваров
		СформироватьСебестоимостьМатериаловПоЭтапам(ПараметрыРасчета);
		
		// Этап 4
		// Дополняет временные таблицы:
		// - ВтПроизводственныеЗатратыСебестоимостьТоваров
		РаспределениеНоменклатурыНаПроизводство(ПараметрыРасчета);
		
		// Этап 5
		// Дополняет временные таблицы:
		// - ВтПроизводственныеЗатратыСебестоимостьТоваров
		РаспределениеНоменклатурыНаВыпуск(ПараметрыРасчета);
		
		//-- НЕ УТКА
		//++ НЕ УТ
		
		// Этап 6
		// Формирует движения по регистрам:
		// - МатериалыИРаботыВПроизводстве
		РаспределениеМатериаловИРаботПоБазе(ПараметрыРасчета);
		
		// Этап 7
		// Формирует движения по регистрам:
		// - ПартииНезавершенногоПроизводства
		РаспределениеМатериаловМеждуОстаткомНЗПиВыходнымиИзделиями(ПараметрыРасчета);
		//-- НЕ УТ
		
		// Этап 8
		// Формирует движения по регистрам:
		// - СебестоимостьТоваров
		ЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета);
		
		// Этап 9 (расчет предварительной стоимости)
		// Заполняет временные таблицы:
		// - ВТСтоимостьПартийТоваров
		// Формирует движения по регистрам:
		// - СтоимостьТоваров
		РасчетСебестоимостиТоваров(ПараметрыРасчета, СтрокаСхемыРасчета, Истина, ПараметрыОтладки);
		
		// Этап 10
		// Формирует движения по регистрам:
		// - ПартииПрочихРасходов
		// - СебестоимостьТоваров
		// - ДвиженияНоменклатураДоходыРасходы
		РаспределениеДопРасходовМеждуПартиямиИТоварами(ПараметрыРасчета);
		
		// Этап 10а (расчет предварительной стоимости с учетом доп. расходов)
		// Заполняет временные таблицы:
		// - ВТСтоимостьПартийТоваров
		// Формирует движения по регистрам:
		// - СтоимостьТоваров
		Если УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТКэшПартииПрочихРасходов") > 0 Тогда
			РасчетСебестоимостиТоваров(ПараметрыРасчета, СтрокаСхемыРасчета, Истина, ПараметрыОтладки);
		КонецЕсли;
		
		// Этап 11
		// Формирует движения по регистрам:
		// - ДетализацияПартийТоваровДляНДСиУСН
		ПодготовкаДанныхДляУчетаНДСиУСН(ПараметрыРасчета);
		
		// Этап 12
		// Формирует движения по регистрам:
		// - ПартииПрочихРасходов
		ПодготовкаДанныхДляПартийПрочихРасходов(ПараметрыРасчета);
		
		// Этап 13
		// Формирует документы РаспределениеНДС с движениями по регистрам:
		// - ПартииПрочихРасходов
		// - ПрочиеАктивыПассивы
		// - ПрочиеРасходы
		РаспределениеНДСПоВидамНалогообложения(ПараметрыРасчета);
		
		//++ НЕ УТ
		
		// Этап 14
		// Формирует временные таблицы:
		// - ДолиПроизводственныхРасходов
		РаспределитьДолиПроизводственныхРасходов(ПараметрыРасчета);
		
		// Этап 16
		// Формирует движения по регистрам:
		// - ПрочиеРасходыНезавершенногоПроизводства
		РаспределениеПостатейныхРасходовНаВыходныеИзделия(ПараметрыРасчета);
		
		//-- НЕ УТ
		
		// Этап 17 (расчет фактической себестоимости)
		// Перезаполняет временные таблицы:
		// - ВТСтоимостьПартийТоваров
		// Формирует движения по регистрам:
		// - см. РасчетСебестоимости.ИсходящиеДанныеМеханизма()
		РасчетСебестоимостиТоваров(ПараметрыРасчета, СтрокаСхемыРасчета, Ложь, ПараметрыОтладки);
		
		// Записываем сформированные движения и завершаем расчет периода
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьСформированныеДвижения(
			ПараметрыРасчета,
			ПараметрыОтладки.ПротоколыРасчета);
		
	КонецЦикла;
	
	// Вернем признак активности текущих итогов в состояние, которое было до начала расчета
	УниверсальныеМеханизмыПартийИСебестоимости.ВернутьСостояниеТекущихИтоговРегистров(СостояниеИтоговРегистров);
	
КонецПроцедуры

// Обертка для запуска расчета - выполняет расчет в Попытке - Исключении
// Параметры аналогичны процедуре РассчитатьВсе()
//
// Возвращаемое значение - Булево - признак успешного выполнения расчета.
//
Функция РассчитатьВсеВПопыткеИсключении(ПараметрыЗапуска, ПараметрыРасчета = Неопределено, ПараметрыОтладки = Неопределено) Экспорт
	
	Отказ = Ложь;
	
	Попытка
		РассчитатьВсе(ПараметрыЗапуска,	ПараметрыРасчета, ПараметрыОтладки);
	Исключение
		
		Если НЕ ЗначениеЗаполнено(ПараметрыРасчета) Тогда
			// Все параметры расчета не нужны, заполним только необходимые свойства.
			ПараметрыРасчета = Новый Структура("ЗапущенРасчетПартий, ИдетРасчетПартий", Истина, Истина);
		КонецЕсли;
		
		УниверсальныеМеханизмыПартийИСебестоимости.ОбработатьИсключениеВызоваРассчитатьВсе(
			ПараметрыРасчета,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			Отказ);
		
	КонецПопытки;
	
	Возврат НЕ Отказ;
	
КонецФункции

//++ НЕ УТ

#Область ЗапросыДляРасшифровки_2_2

//++ НЕ УТКА

// Получает данные для построения расшифровки базы распределения материалов и работ.
//
// Параметры:
//		Период - Дата - период расчета
//		МассивОрганизаций - СправочникСсылка.Организации - массив организаций;
//		Регистратор - ДокументСсылка.РаспределениеПроизводственныхЗатрат - документ распределения, для которого строится расшифровка
//
// Возвращаемое значение:
//		МенеджерВременныхТаблиц - таблицы для построения отчета.
//
Функция ДанныеДляРасшифровкиРаспределенияНоменклатурыНаПроизводство(Период, МассивОрганизаций, Регистратор) Экспорт
	
	Перем ПараметрыРасчета;
	Перем ПараметрыОтладки;
	
	ПараметрыЗапуска = Новый Структура("Дата, МассивОрганизаций",
		Период,
		УниверсальныеМеханизмыПартийИСебестоимости.СвязиОрганизацийПоСхемеИнтеркампани(Период, МассивОрганизаций));
	
	// Инициализация параметров расчета
	ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, Неопределено);
	
	ПараметрыРасчета.Вставить("РасшифровкаРаспределения");
	ПараметрыРасчета.Вставить("Регистратор", Регистратор);
	
	РаспределениеНоменклатурыНаПроизводство(ПараметрыРасчета);
	
	Возврат ПараметрыРасчета.МенеджерВременныхТаблиц;
	
КонецФункции

//-- НЕ УТКА

// Получает данные для построения расшифровки базы распределения постатейных расходов.
//
// Параметры:
//		Период - Дата - период расчета
//		МассивОрганизаций - СправочникСсылка.Организации - массив организаций;
//		Регистратор - ДокументСсылка.РаспределениеПрочихЗатрат - документ распределения, для которого строится расшифровка
//		РасчетСебестоимостиВыполнен - Булево - принимает значение Истина, если расчет себестоимости за указанный период выполнен успешно
//
// Возвращаемое значение:
//		МенеджерВременныхТаблиц - таблицы для построения отчета.
//
Функция ДанныеДляРасшифровкиДолейПроизводственныхРасходов(Период, МассивОрганизаций, Регистратор, РасчетСебестоимостиВыполнен) Экспорт
	
	Перем ПараметрыРасчета;
	Перем ПараметрыОтладки;
	
	ПараметрыЗапуска = Новый Структура("Дата, МассивОрганизаций",
		Период,
		УниверсальныеМеханизмыПартийИСебестоимости.СвязиОрганизацийПоСхемеИнтеркампани(Период, МассивОрганизаций));
	
	ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, Неопределено);
	
	ПараметрыРасчета.Вставить("РасшифровкаРаспределения");
	
	СостояниеРасчетаСебестоимости = УниверсальныеМеханизмыПартийИСебестоимости.СостояниеРасчетаСебестоимости(Период, МассивОрганизаций, Истина);
	Если СостояниеРасчетаСебестоимости = Перечисления.СостоянияОперацийЗакрытияМесяца.ВыполненоУспешно Тогда
		ПараметрыРасчета.Вставить("РасчетСебестоимостиВыполнен");
		РасчетСебестоимостиВыполнен = Истина;
	КонецЕсли;
	
	ПараметрыРасчета.Вставить("Регистратор", Регистратор);
	
	РаспределитьДолиПроизводственныхРасходов(ПараметрыРасчета);
	
	Возврат ПараметрыРасчета.МенеджерВременныхТаблиц;
	
КонецФункции

#КонецОбласти

//-- НЕ УТ

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ЭтапыРасчета

// Этап 0 - подготовка к расчету
//
Процедура ПодготовкаИсходныхДанныхКРасчету(ПараметрыРасчета)
	
	Если ПараметрыРасчета.ФормироватьНачальныеОстаткиПартий22 Тогда
		// При расчете первого месяца на партионном учете версии 2.2
		// надо сформировать остатки себестоимости в разрезе партий на конец прошлого месяца.
		СформироватьНачальныеОстаткиПартийСебестоимостьТоваров(ПараметрыРасчета);
		// Аналогично для партий НДС и УСН.
		СформироватьНачальныеОстаткиПартийНДСиУСН(ПараметрыРасчета);
	КонецЕсли;
	
	// При необходимости заполним служебного реквизита РасчетПартий:
	// если расчет текущего периода ранее был выполнен в партионном учете версии 2.1, то этот реквизит не заполнялся.
	Если ПроверитьНеобходимостьЗаполненияРеквизитаРасчетПартий(ПараметрыРасчета) Тогда 
	
		//++ НЕ УТ
		// ТрудозатратыНезавершенногоПроизводства
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства.Имя];
		ТекстРасчетПартий   = "ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.ЗаказНаПроизводство, Т.КодСтрокиПродукция";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);

		// МатериалыИРаботыВПроизводстве
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве.Имя];
		ТекстРасчетПартий   =
			"ВЫБОР КОГДА Т.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
			|	И Т.БазаРаспределения <> ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка)
			|	ТОГДА ИСТИНА
			|	ИНАЧЕ ЛОЖЬ
			|КОНЕЦ";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.Номенклатура, Т.Характеристика, Т.Подразделение";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);
			
		// ПартииНезавершенногоПроизводства
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства.Имя];
		ТекстРасчетПартий   = "ИСТИНА";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.АналитикаУчетаНоменклатуры, Т.ЗаказНаПроизводство, Т.КодСтрокиПродукция";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);

		// ПрочиеРасходыНезавершенногоПроизводства
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя];
		ТекстРасчетПартий   = "НЕ Т.РасчетСебестоимости";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.ЗаказНаПроизводство, Т.КодСтрокиПродукция";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);
		//-- НЕ УТ
			
		// ПартииПрочихРасходов
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя];
		ТекстРасчетПартий   =
			"ВЫБОР КОГДА Т.РасчетПартий ТОГДА ИСТИНА
			|	КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|	 И ЕСТЬNULL(СтатьиРасходов.ВариантРаспределенияРасходов, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
			|		ТОГДА ИСТИНА
			|	КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 
			|	 И Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
			|	 И НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL
			|		ТОГДА ИСТИНА
			|	ИНАЧЕ ЛОЖЬ
			|КОНЕЦ";
		ТекстСоединения     =
			"ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
			|	ПО Т.СтатьяРасходов = СтатьиРасходов.Ссылка";
		ТекстУпорядочивание = "Т.Подразделение, Т.СтатьяРасходов, Т.АналитикаРасходов";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);
		
		// СебестоимостьТоваров
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя];
		ТекстРасчетПартий   =
			"ВЫБОР КОГДА Т.РасчетПартий ТОГДА ИСТИНА
			|	КОГДА НЕ Т.РасчетСебестоимости
			|		И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
			// Прочие расходы на себестоимость товаров
			|		И ((Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|			И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
			|			И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
			|			И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
			|			И (Т.Количество = 0 И Т.Стоимость = 0 И Т.СтоимостьБезНДС = 0)
			|			И (Т.СуммаДопРасходов <> 0 ИЛИ Т.СуммаДопРасходовБезНДС <> 0))
			//++ НЕ УТ
			// Себестоимость производства
			|		  ИЛИ
			|			((Т.Регистратор ССЫЛКА Документ.ВыпускПродукции
			|				ИЛИ Т.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
			//++ НЕ УТКА
			|				ИЛИ Т.Регистратор ССЫЛКА Документ.ОтчетДавальцу
			//-- НЕ УТКА
			|				ИЛИ Т.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат)
			|			И НЕ ((Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
			|		 		   ИЛИ Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|					 И Т.ХозяйственнаяОперация В (
			|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
			|						ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)))
			|		  		И Т.Количество <> 0
			|		  		И (Т.Регистратор ССЫЛКА Документ.ВыпускПродукции
			|					ИЛИ Т.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
			//++ НЕ УТКА
			|					ИЛИ Т.Регистратор ССЫЛКА Документ.ОтчетДавальцу
			//-- НЕ УТКА
			|					ИЛИ (Т.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства 
			|							И &ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ЛОЖЬ))))
			//-- НЕ УТ
			|		 )
			|	ТОГДА ИСТИНА
			|	ИНАЧЕ ЛОЖЬ
			|КОНЕЦ";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.АналитикаУчетаНоменклатуры, Т.ВидЗапасов";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);
		
		// ДвиженияНоменклатураДоходыРасходы
		ОписаниеРегистра    = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя];
		ТекстРасчетПартий   =
			"ВЫБОР КОГДА Т.РасчетПартий ТОГДА ИСТИНА
			|	КОГДА НЕ Т.РасчетСебестоимости
			|		И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
			|		И Т.ДокументДвижения <> НЕОПРЕДЕЛЕНО
			|		И Т.Количество = 0
			|	ТОГДА ИСТИНА
			|	ИНАЧЕ ЛОЖЬ
			|КОНЕЦ";
		ТекстСоединения     = "";
		ТекстУпорядочивание = "Т.АналитикаУчетаНоменклатуры, Т.ВидЗапасов";
		ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра, ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание);
		
	КонецЕсли;
	
	// Исправим проблемы в движениях и в самих документах в рассчитываемом периоде.
	ИсправитьПроблемыВДвиженияхИДокументах(ПараметрыРасчета);
	
	// Очистим данные партионного учета версии 2.1 в рассчитываемом периоде.
	ОчиститьНеиспользуемыеДанныеПартионногоУчетаВерсии21(ПараметрыРасчета);
	
	// Проверим корректность исходных данных для расчета.
	УниверсальныеМеханизмыПартийИСебестоимости.ПроверитьКорректностьИсходныхДанныхДоРасчета(ПараметрыРасчета);
	
	// Обновим кэши регистров, данные которых были изменены в этой процедуре.
	УниверсальныеМеханизмыПартийИСебестоимости.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета, Истина);
	
КонецПроцедуры

//++ НЕ УТ

// Этап 1 (Контекст: "РаспределениеТрудозатрат")
// ПУ 2.1: РассчитатьТрудозатраты(), область РасчетТрудозатратНезавершенногоПроизводства
Процедура РаспределениеТрудозатрат(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеТрудозатрат");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияТрудозатрат(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияТрудозатрат(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияТрудозатрат(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийТрудозатрат(ПараметрыРасчета));

	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияТрудозатрат(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ТрудозатратыНезавершенногоПроизводства
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

//-- НЕ УТ
//++ НЕ УТКА

// Этап 2 (Контекст: "РаспределениеТоваровОрганизацийНаПроизводство")
Процедура РаспределитьТоварыОрганизацийНаПроизводство(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьТоварыОрганизацийНаПроизводство");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийТоваровОрганизацийНаПроизводство(ПараметрыРасчета));

	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц
	// 	- формирует движения по регистру ТоварыОрганизаций
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3 (Контекст: "СебестоимостьМатериаловПоЭтапам")
Процедура СформироватьСебестоимостьМатериаловПоЭтапам(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "СформироватьСебестоимостьМатериаловПоЭтапам");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		ТаблицаДляСебестоимостиМатериаловПоЭтапам(ПараметрыРасчета),
		"",
		"ВтПроизводственныеЗатратыСебестоимостьТоваров");
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляСебестоимостиМатериаловПоЭтапам(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует временную таблицу ВтПроизводственныеЗатратыСебестоимостьТоваров
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 4 (Контекст: "РаспределениеНоменклатурыНаПроизводство")
// ПУ 2.1: РассчитатьРаспределениеМатериаловИРабот(), область РаспределениеМатериаловИРабот
Процедура РаспределениеНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеНоменклатурыНаПроизводство");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- добавляет записи во временную таблицу ВтПроизводственныеЗатратыСебестоимостьТоваров
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 5 (Контекст: "РаспределениеНоменклатурыНаВыпуск")
// ПУ 2.1: РассчитатьПартииНЗП(), область РасчетПартийНезавершенногоПроизводства
Процедура РаспределениеНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеНоменклатурыНаВыпуск");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийНоменклатурыНаВыпуск(ПараметрыРасчета));
	
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- добавляет записи во временную таблицу ВтПроизводственныеЗатратыСебестоимостьТоваров
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

//-- НЕ УТКА
//++ НЕ УТ

// Этап 6 (Контекст: "РаспределениеМатериаловИРаботПоБазе")
// ПУ 2.1: РассчитатьРаспределениеМатериаловИРабот(), область РаспределениеМатериаловИРабот
Процедура РаспределениеМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеМатериаловИРаботПоБазе");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийМатериаловИРаботПоБазе(ПараметрыРасчета));

	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру МатериалыИРаботыВПроизводстве
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 7 (Контекст: "РаспределениеМатериаловНЗП")
// ПУ 2.1: РассчитатьПартииНЗП(), область РасчетПартийНезавершенногоПроизводства
Процедура РаспределениеМатериаловМеждуОстаткомНЗПиВыходнымиИзделиями(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеМатериаловМеждуОстаткомНЗПиВыходнымиИзделиями");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияМатериаловНЗП(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияМатериаловНЗП(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияМатериаловНЗП(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийМатериаловНЗП(ПараметрыРасчета));

	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияМатериаловНЗП(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПартииНезавершенногоПроизводства
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

//-- НЕ УТ

// Этап 8 (Контекст: "ПартииСебестоимостиТоваров")
//
Процедура ЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета)
	
	// Заполним служебные параметры этого этапа (в других этапах не требуется).
	УниверсальныеМеханизмыПартийИСебестоимости.ВыполняетсяЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета, Истина);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ЗаполнениеПартийВРегистреСебестоимостьТоваров");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПартийТоваров(ПараметрыРасчета),
		ОписаниеЦепочекПартийТоваров(ПараметрыРасчета),
		ОписаниеДвиженийПартийТоваров(ПараметрыРасчета),
		ОписаниеНезаписываемыхПартийТоваров(ПараметрыРасчета));
	
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляПартийТоваров(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру СебестоимостьТоваров
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	// Заполним служебные параметры этого этапа (в других этапах не требуется).
	УниверсальныеМеханизмыПартийИСебестоимости.ВыполняетсяЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета, Ложь);
	
КонецПроцедуры

// Этап 9 и 17 (вызов механизма расчета себестоимости)
//
Процедура РасчетСебестоимостиТоваров(ПараметрыРасчета, СтрокаСхемыРасчета, ПредварительныйРасчет, ПараметрыОтладки)
	
	//++ НЕ УТ
	Если НЕ ПредварительныйРасчет Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.ВыполнитьРегламентнуюОперацию(
			ПараметрыРасчета,
			Перечисления.ТипыРегламентныхОпераций.РасчетДолейСписанияКосвенныхРасходов,
			Истина);
	КонецЕсли;
	//-- НЕ УТ
	Если ПараметрыРасчета.Отладка.НеВыполнятьРасчетСебестоимости Тогда
		
		ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РасчетСебестоимостиТоваров");
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Расчет себестоимости пропущен для целей отладки.'"));
		
		Возврат;
		
	КонецЕсли;
	
	// Протокол тут не пишем - он ведется внутри расчета себестоимости, по его этапам
	
	ПараметрыЗапускаРасчетаСебестоимости = Новый Структура;
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("Дата", 					СтрокаСхемыРасчета.Дата);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("ПредварительныйРасчет", 	ПредварительныйРасчет);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МассивОрганизаций", 		СтрокаСхемыРасчета.Организации);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("РегламентноеЗадание", 	Ложь);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МестоВызоваРасчета", 	"ПартионныйУчет22.РасчетСебестоимостиТоваров");
	
	СебестоимостьРассчитана = РасчетСебестоимости.РассчитатьВсеВПопыткеИсключении(
		ПараметрыЗапускаРасчетаСебестоимости,
		ПараметрыРасчета,
		ПараметрыОтладки);
	
	Если НЕ СебестоимостьРассчитана Тогда
		ВызватьИсключение
			НСтр("ru='При расчете себестоимости возникла ошибка.
					 |Подробности см. в Журнале регистрации.'");
	КонецЕсли;
	
КонецПроцедуры

// Этап 10 (Контекст: "ДопРасходы_ЗаказыПоставщикам", "ДопРасходы_ПартииПрочихРасходов", "ДопРасходы_ПриходПартийРасходов")
// ПУ 2.1: РассчитатьПартииПрочих(), области РасчетПриходыРасходовСебестоимость, РасчетЗаписейНоменклатураДоходыРасходы
Процедура РаспределениеДопРасходовМеждуПартиямиИТоварами(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеДопРасходовМеждуПартиямиИТоварами");
	
	ДанныеДляПартийПрочих = ПолучитьДанныеДляДопРасходов(ПараметрыРасчета);
	
	// Формирует движения по регистру ПартииПрочихРасходов
	СформироватьПартииПрочихРасходов(ПараметрыРасчета, ДанныеДляПартийПрочих);
	УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
	РасчетныеПриходыПартийРасходов = ПолучитьДанныеПриходовПартийРасходов(ПараметрыРасчета, ДанныеДляПартийПрочих);
	ДанныеДляПартийПрочих = Неопределено;
	
	// Формирует движения по регистру СебестоимостьТоваров
	СформироватьДопРасходыВСебестоимостьТоваров(ПараметрыРасчета, РасчетныеПриходыПартийРасходов);
	УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
	// Формирует движения по регистру ДвиженияНоменклатураДоходыРасходы
	СформироватьДопРасходыВДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета);
	УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 11 (Контекст: "ПартииНДСиУСН")
//
Процедура ПодготовкаДанныхДляУчетаНДСиУСН(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляУчетаНДСиУСН");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета),
		ОписаниеЦепочекПартийНДС(ПараметрыРасчета),
		ОписаниеДвиженийПартийНДС(ПараметрыРасчета),
		ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляПартийНДС(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ДетализацияПартийТоваровДляНДСиУСН
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 12 (Контекст: "ПартииПрочихРасходов")
//
Процедура ПодготовкаДанныхДляПартийПрочихРасходов(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПартийПрочихРасходов");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляПартийПрочихРасходов(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПартииПрочихРасходов
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 13 (формирование документов РаспределениеНДС)
//
Процедура РаспределениеНДСПоВидамНалогообложения(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеНДСПоВидамНалогообложения");
	
	// Вызовем "внешнюю" логику перепроведения документов РаспределениеНДС.
	// При этом будут переформированы "первичные" движения этих документов.
	РезультатРаспределенияНДС = Документы.РаспределениеНДС.РаспределитьНДС(
		ПараметрыРасчета.РасчетныйПериод.НачалоПериода,
		ПараметрыРасчета.МассивОрганизаций,
		УниверсальныеМеханизмыПартийИСебестоимости.ИмяСобытияОшибкиДляЖурналаРегистрации(ПараметрыРасчета),
		ПараметрыРасчета.МенеджерВременныхТаблиц);
	
	Если ЗначениеЗаполнено(РезультатРаспределенияНДС.ТекстОшибки) Тогда
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Операция ""Распределение НДС"" не была выполнена по причине:
				|%1'"),
			РезультатРаспределенияНДС.ТекстОшибки);
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияНДС,
			ТекстДляПротокола);
		
	КонецЕсли;
		
	// Если документ РаспределениеНДС может делать движения по регистру,
	// обслуживаемому механизмом партионного учета и себестоимости,
	// то по этому регистру надо обновить расчетные кэши остатков и оборотов.
	// Иначе получится ситуация, что данные ИБ при проведении этих документов изменились,
	// а следующие этапы расчета "не увидят" этого во временных таблицах кэшей регистров.
	Если РезультатРаспределенияНДС.МассивДокументов.Количество() > 0 Тогда
		
		ВозможныеДвиженияДокументов = Метаданные.Документы.РаспределениеНДС.Движения;
		
		Для Каждого КлючИЗначение Из ПараметрыРасчета.Движения Цикл
			
			ОписаниеРегистра = КлючИЗначение.Значение;
			
			Если ВозможныеДвиженияДокументов.Содержит(ОписаниеРегистра.МетаданныеРегистра) Тогда
				ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	УниверсальныеМеханизмыПартийИСебестоимости.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета, Истина);
	
	ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
		ПараметрыРасчета,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Обработано документов ""Распределение НДС"": %1'"),
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(
				РезультатРаспределенияНДС.МассивДокументов.Количество())));
	
КонецПроцедуры

//++ НЕ УТ

// Этап 14 (Контекст: "РаспределениеДолейПроизводственныхРасходов")
Процедура РаспределитьДолиПроизводственныхРасходов(ПараметрыРасчета)
	
	Замер = Производительность.НачатьЗамерВремени("РаспределениеЗатратИРасчетСебестоимости.РаспределениеДолейПроизводственныхРасходов");
	ПоказательКоличестваДанных = 1;
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьДолиПроизводственныхРасходов");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета),
		ОписаниеЦепочекРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета),
		ОписаниеДвиженийРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета),
		ОписаниеНезаписываемыхРаспределенийДолейПроизводственныхРасходов(ПараметрыРасчета));
	
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета, ПоказательКоличестваДанных);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует временную таблицу ДолиПроизводственныхРасходов
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	Производительность.ЗакончитьЗамерВремени(Замер, ПоказательКоличестваДанных);
	
КонецПроцедуры

// Этап 16 (Контекст: "ПрочиеРасходыНЗПНаВыходныеИзделия")
// ПУ 2.1: РассчитатьПрочиеРасходыНЗП(), область РасчетПрочихРасходовНезавершенногоПроизводства
Процедура РаспределениеПостатейныхРасходовНаВыходныеИзделия(ПараметрыРасчета)
	
	Замер = Производительность.НачатьЗамерВремени("РаспределениеЗатратИРасчетСебестоимости.РаспределениеПостатейныхРасходовНаВыходныеИзделия");
	ПоказательКоличестваДанных = 1;
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеПостатейныхРасходовНаВыходныеИзделия");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПрочихРасходовНЗП(ПараметрыРасчета),
		Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляПрочихРасходовНЗП(ПараметрыРасчета, ПоказательКоличестваДанных);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует временную таблицу ПрочиеРасходыНезавершенногоПроизводства
	ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
	Производительность.ЗакончитьЗамерВремени(Замер, ПоказательКоличестваДанных);
	
КонецПроцедуры

//-- НЕ УТ
#КонецОбласти


#Область Инициализация

// Перед началом расчета заполняет все необходимые параметры и инициализирует все структуры данных, используемые алгоритма расчета.
//
// Внимание: если какая-то сущность используется более чем в одном этапе расчета, то ее стоит занести в ПараметрыРасчета.
//
Процедура ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки)
	
	// Создадим контейнер всех параметров, используемых механизмом расчета партий
	ПараметрыИнициализации = Новый Структура;
	ПараметрыИнициализации.Вставить("Дата", 									 КонецМесяца(ПараметрыЗапуска.Дата));
	ПараметрыИнициализации.Вставить("МассивОрганизаций",   						 ПараметрыЗапуска.МассивОрганизаций);
	ПараметрыИнициализации.Вставить("ЗапущенРасчетПартий", 						 Истина);
	ПараметрыИнициализации.Вставить("ТолькоПредварительныйРасчетСебестоимости",  Ложь);
	ПараметрыИнициализации.Вставить("ЗапущеноРегламентнымЗаданием", 			 Ложь);
	
	Если ПараметрыЗапуска.Свойство("ИзмененоДокументов") Тогда
		ПараметрыИнициализации.Вставить("ИзмененоДокументов",   				 ПараметрыЗапуска.ИзмененоДокументов);
	Иначе
		ПараметрыИнициализации.Вставить("ИзмененоДокументов",   				 Неопределено);
	КонецЕсли;
	
	УниверсальныеМеханизмыПартийИСебестоимости.ИнициализироватьОбщиеПараметрыРасчета(
		ПараметрыИнициализации, ПараметрыРасчета, ПараметрыОтладки);
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа0_ПодготовкаКРасчету

// При расчете первого месяца в партионном учете версии 2.2 формирует начальные остатки партий в регистре себестоимости товаров.
//
Процедура СформироватьНачальныеОстаткиПартийСебестоимостьТоваров(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "СформироватьНачальныеОстаткиПартийСебестоимостьТоваров");
	
	ОписаниеРегистра = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя];
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("СторнироватьОстаткиСебестоимости",
		ПараметрыРасчета.НачальныеОстатки.ВзятьОстаткиСебестоимостиИзРегистровПартий);
	Запрос.УстановитьПараметр("РаспределятьРасхожденияВСуммах",
		ПараметрыРасчета.НачальныеОстатки.РаспределятьРасхожденияВСуммахПартийИСебестоимости);
	
	#Область ВыборкаОстатков
	
	// Остатки партий для организаций с "ФИФО скользящая" получим из партионных регистров.
	// По остальным организациям партий нет - просто заполним в остатках новые измерения ВидДеятельностиНДС и АналитикаФинансовогоУчета.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДокументыВводаОстатков.Ссылка КАК Регистратор,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	СУММА(Т.Знак * Т.Количество) 				КАК Количество,
	|	СУММА(Т.Знак * Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.Знак * Т.СтоимостьБезНДС) 			КАК СтоимостьБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансовая) 	КАК СтоимостьЗабалансовая,
	|	СУММА(Т.Знак * Т.СуммаДопРасходов) 			КАК СуммаДопРасходов,
	|	СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) 	КАК СуммаДопРасходовБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Т.Знак * Т.ДопРасходыРегл) 			КАК ДопРасходыРегл,
	|	СУММА(Т.Знак * Т.ПостояннаяРазница) 		КАК ПостояннаяРазница,
	|	СУММА(Т.Знак * Т.ВременнаяРазница) 			КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТОстаткиСебестоимости
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Организация КАК Организация,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		1 КАК Знак,
	|		Т.КоличествоОстаток КАК Количество,
	|		Т.СтоимостьОстаток КАК Стоимость,
	|		Т.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансоваяОстаток КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходовОстаток КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДСОстаток КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРеглОстаток КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРеглОстаток КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРеглОстаток КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		Т.ВременнаяРазницаОстаток КАК ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
	|			Организация В (&МассивОрганизаций)) КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ,
	|		Т.Количество,
	|		Т.Стоимость,
	|		Т.СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл,
	|		Т.ПостояннаяРазница,
	|		Т.ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ГДЕ
	|		Т.Период < &НачалоПериода
	|		И Т.Активность
	|		И Т.Организация В(&МассивОрганизаций)
	|		И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных)
	|	) КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
	|	ПО Т.Организация = ДокументыВводаОстатков.Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	ДокументыВводаОстатков.Ссылка
	|
	|ИМЕЮЩИЕ
	|		СУММА(Т.Знак * Т.Количество) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.Стоимость) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансовая) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходов) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ДопРасходыРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ВременнаяРазница) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровОрганизаций
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровПереданныеНаКомиссию
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.СтатьяРасходов,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.СтоимостьРеглОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииРасходовНаСебестоимостьТоваров
	|ИЗ
	|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаПродукции,
	|	Т.ДокументВыпуска,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииЗатратНаВыпуск
	|ИЗ
	|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		И АналитикаУчетаПродукции <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииПроизводственныхЗатрат
	|ИЗ
	|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	//++ НЕ УТ
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииНезавершенногоПроизводства
	|ИЗ
	|	РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	//-- НЕ УТ
	|ВЫБРАТЬ
	|	Т.РазделУчета 					КАК РазделУчета,
	|	Т.Организация 					КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 					КАК ВидЗапасов,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ							КАК Партия,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.АналитикаУчетаПартий
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ							КАК АналитикаУчетаПартий,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.ВидЦенности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|	КОНЕЦ							КАК ВидЦенности,
	|	СУММА(Т.Количество) 			КАК Количество,
	|	СУММА(Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) 		КАК СтоимостьБезНДС,
	|	СУММА(Т.ПостояннаяРазница) 		КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) 		КАК ВременнаяРазница,
	|	СУММА(Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.ДопРасходыРегл) 		КАК ДопРасходыРегл,
	|	СУММА(Т.СуммаДопРасходов) 		КАК СуммаДопРасходов,
	|	СУММА(Т.СуммаДопРасходовБезНДС) КАК СуммаДопРасходовБезНДС
	|ПОМЕСТИТЬ ВТОстаткиПартийПредварительная
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|			КОГДА Т.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|		КОНЕЦ КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.ДокументПоступления КАК ДокументПоступления,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) КАК ВидЦенности,
	|		Т.КоличествоОстаток КАК Количество,
	|		Т.СтоимостьОстаток КАК Стоимость,
	|		Т.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
	|		Т.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		Т.ВременнаяРазницаОстаток КАК ВременнаяРазница,
	|		Т.СтоимостьРеглОстаток КАК СтоимостьРегл,
	|		0 КАК ДопРасходыРегл,
	|		0 КАК СуммаДопРасходов,
	|		0 КАК СуммаДопРасходовБезНДС
	|	ИЗ
	|		ВТОстаткиПартииТоваровОрганизаций КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию),
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары),
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		(ВЫБОР
	|			КОГДА НЕ ПартииТоваров.АналитикаУчетаПартий ЕСТЬ NULL ТОГДА ПартииТоваров.АналитикаУчетаПартий
	|			КОГДА НЕ ПартииПроизводства.АналитикаУчетаПартий ЕСТЬ NULL ТОГДА ПартииПроизводства.АналитикаУчетаПартий
	//++ НЕ УТ
	|			КОГДА НЕ ПартииНЗП.АналитикаУчетаПартий ЕСТЬ NULL ТОГДА ПартииНЗП.АналитикаУчетаПартий
	//-- НЕ УТ
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КОНЕЦ) КАК АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) КАК ВидЦенности,
	|		0,
	|		0,
	|		0,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		0,
	|		Т.СтоимостьРеглОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток
	|	ИЗ
	|		ВТОстаткиПартииРасходовНаСебестоимостьТоваров КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииТоваров.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииТоваров.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииТоваров.ДокументПоступления
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииПроизводственныхЗатрат КАК ПартииПроизводства
	|			ПО Т.Организация = ПартииПроизводства.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииПроизводства.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииПроизводства.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииПроизводства.ДокументПоступления
	//++ НЕ УТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииНезавершенногоПроизводства КАК ПартииНЗП
	|			ПО Т.Организация = ПартииНЗП.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииНЗП.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииНЗП.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииНЗП.ДокументПоступления
	//-- НЕ УТ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаНоменклатуры
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаПродукции.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаПродукции.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаПродукции,
	|		ЕСТЬNULL(ПартииТоваров.ВидЗапасов, ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)),
	|		Т.ДокументВыпуска,
	|		ЕСТЬNULL(ПартииТоваров.АналитикаУчетаПартий, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
	|		ВЫБОР КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ,
	|		0 КАК КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииЗатратНаВыпуск КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|				И Т.АналитикаУчетаПродукции = ПартииТоваров.АналитикаУчетаНоменклатуры
	|				И Т.ДокументВыпуска = ПартииТоваров.ДокументПоступления
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаПродукции
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Партнеры
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		ВЫБОР КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ,
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииПроизводственныхЗатрат КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаНоменклатуры
	//++ НЕ УТ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты),
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		ВЫБОР КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ,
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииНезавершенногоПроизводства КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаНоменклатуры
	//-- НЕ УТ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.РазделУчета,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка) КАК ВидЦенности,
	|		Т.Количество,
	|		Т.Стоимость + Т.СтоимостьЗабалансовая,
	|		Т.СтоимостьБезНДС,
	|		Т.ПостояннаяРазница,
	|		Т.ВременнаяРазница,
	|		Т.СтоимостьРегл + Т.СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл,
	|		Т.СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС
	|	ИЗ
	|		ВТОстаткиСебестоимости КАК Т
	|	ГДЕ
	|		НЕ Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.ДокументПоступления
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.АналитикаУчетаПартий
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.ВидЦенности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|	КОНЕЦ
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.Количество) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПартий
	|";
	
	#КонецОбласти
	
	Запрос.Выполнить(); // формируем ВТОстаткиСебестоимости, ВТОстаткиПартийПредварительная
	
	СформироватьАналитикиПартийСВидомЦенности(ПараметрыРасчета); // формируем ВТАналитикиПартийСВидомЦенности
	
	#Область КорректировкаРасхожденийВСуммах
	
	// В силу различных причин может получиться так, что суммы остатков в регистрах партий и в регистре себестоимости
	// по некоторым сочетаниям (РазделУчета, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов) могут отличаться,
	// при том, что количество по ним будет одинаково.
	// Для того, чтобы в регистре себестоимости не остались суммы без количества (без партий),
	// надо распределить эти суммы по партиям, пропорционально количеству.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДокументыВводаОстатков.Ссылка КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Т.РазделУчета <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.РазделУчета
	|		КОГДА НЕ ОстаткиКомиссии.Организация ЕСТЬ NULL 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|	КОНЕЦ КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|		ТОГДА Т.ВидЗапасов
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ КАК ВидЗапасов,
	|	Т.Партия,
	|	ЕСТЬNULL(АналитикиПартий.АналитикаУчетаПартийСВидомЦенности, Т.АналитикаУчетаПартий) КАК АналитикаУчетаПартий,
	|	ВЫБОР
	|		КОГДА Аналитика.ГруппаПродукции ЕСТЬ NULL 
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА Аналитика.ГруппаПродукции <> ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА Аналитика.ГруппаПродукции
	|		КОГДА Аналитика.АналитикаПредназначения ССЫЛКА Справочник.Назначения
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Аналитика.АналитикаПредназначения
	|	КОНЕЦ КАК АналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаПартий.НалогообложениеНДС ЕСТЬ NULL И Т.АналитикаУчетаПартий.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС
	|		КОГДА НЕ Аналитика.НалогообложениеНДС ЕСТЬ NULL И Аналитика.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Аналитика.НалогообложениеНДС
	|		КОГДА ЕСТЬNULL(ПримененияЕНВД.РозничнаяТорговляОблагаетсяЕНВД, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|		КОГДА НЕ СпрУчетнаяПолитикаУСН.Ссылка ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	Т.Количество,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)) ТОГДА 0
	|		ИНАЧЕ Т.Стоимость КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)) ТОГДА 0
	|		ИНАЧЕ Т.СтоимостьБезНДС КОНЕЦ) КАК СтоимостьБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)) ТОГДА Т.Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	Т.СуммаДопРасходов,
	|	Т.СуммаДопРасходовБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)) ТОГДА 0
	|		ИНАЧЕ Т.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)) ТОГДА Т.СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	Т.ДопРасходыРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ПОМЕСТИТЬ ВТОстаткиПартий
	|ИЗ
	|	ВТОстаткиПартийПредварительная КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК ОстаткиКомиссии
	|		ПО (Т.РазделУчета = НЕОПРЕДЕЛЕНО)
	|			И Т.Организация = ОстаткиКомиссии.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ОстаткиКомиссии.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ОстаткиКомиссии.ВидЗапасов
	|			И Т.Партия = ОстаткиКомиссии.ДокументПоступления
	|			И Т.АналитикаУчетаПартий = ОстаткиКомиссии.АналитикаУчетаПартий
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаВидовЗапасов КАК Аналитика
	|		ПО Т.ВидЗапасов = Аналитика.КлючАналитики
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиПартийСВидомЦенности КАК АналитикиПартий
	|		ПО Т.АналитикаУчетаПартий = АналитикиПартий.АналитикаУчетаПартий
	|			И Т.ВидЦенности = АналитикиПартий.ВидЦенности
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
	|		ПО Т.Организация = ДокументыВводаОстатков.Организация
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПримененияЕНВД.СрезПоследних(&КонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК ПримененияЕНВД
	|		ПО Т.Организация = ПримененияЕНВД.Организация
	|			И Т.АналитикаУчетаНоменклатуры.Склад = ПримененияЕНВД.Склад
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаОрганизаций.СрезПоследних(&КонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК РегУчетнаяПолитика
	|		ПО Т.Организация = РегУчетнаяПолитика.Организация
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеПолитикиОрганизаций КАК СпрУчетнаяПолитикаУСН
	|			ПО РегУчетнаяПолитика.УчетнаяПолитика = СпрУчетнаяПолитикаУСН.Ссылка
	|				И СпрУчетнаяПолитикаУСН.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Упрощенная)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры,
	|	СУММА(Т.КоличествоИзПартий)					КАК КоличествоИзПартий,
	|	СУММА(Т.Знак * Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.Знак * Т.СтоимостьБезНДС) 			КАК СтоимостьБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансовая) 	КАК СтоимостьЗабалансовая,
	|	СУММА(Т.Знак * Т.СуммаДопРасходов) 			КАК СуммаДопРасходов,
	|	СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) 	КАК СуммаДопРасходовБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Т.Знак * Т.ДопРасходыРегл) 			КАК ДопРасходыРегл,
	|	СУММА(Т.Знак * Т.ПостояннаяРазница) 		КАК ПостояннаяРазница,
	|	СУММА(Т.Знак * Т.ВременнаяРазница) 			КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТОстаткиСуммБезКоличества
	|ИЗ
	|	(ВЫБРАТЬ
	|		1 КАК Знак,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.Количество 					КАК КоличествоИзСебестоимости,
	|		0 								КАК КоличествоИзПартий,
	|		Т.Стоимость 					КАК Стоимость,
	|		Т.СтоимостьБезНДС 				КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая 		КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов 				КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС 		КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл 				КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл 	КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл 				КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница 				КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиСебестоимости КАК Т
	|	ГДЕ
	|		НЕ &СторнироватьОстаткиСебестоимости И &РаспределятьРасхожденияВСуммах
	|		И Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		-1 КАК Знак,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.АналитикаУчетаНоменклатуры,
	|		0 									  КАК КоличествоИзСебестоимости,
	|		Т.Количество						  КАК КоличествоИзПартий,
	|		Т.Стоимость 						  КАК Стоимость,
	|		Т.СтоимостьБезНДС 					  КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая 			  КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов 				      КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС 			  КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл + Т.ДопРасходыРегл 	  КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл 		  КАК СтоимостьЗабалансоваяРегл,
	|		0 									  КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница 				  КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница 				  	  КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиПартий КАК Т
	|	ГДЕ
	|		НЕ &СторнироватьОстаткиСебестоимости И &РаспределятьРасхожденияВСуммах
	|		И Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоИзСебестоимости) = СУММА(Т.КоличествоИзПартий)
	|	И СУММА(Т.КоличествоИзПартий) <> 0
	|	И (СУММА(Т.Знак * Т.Стоимость) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СтоимостьБезНДС) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансовая) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходов) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СтоимостьРегл) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.ДопРасходыРегл) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.ПостояннаяРазница) <> 0
	|		ИЛИ СУММА(Т.Знак * Т.ВременнаяРазница) <> 0)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	ВЫРАЗИТЬ(Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (23,10)) 							    		 КАК Коэффициент,
	|	ВЫРАЗИТЬ(ОстаткиСумм.Стоимость * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 				 КАК Стоимость,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СтоимостьБезНДС * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 			 КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СтоимостьЗабалансовая * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 	 КАК СтоимостьЗабалансовая,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СуммаДопРасходов * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 		 КАК СуммаДопРасходов,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СуммаДопРасходовБезНДС * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 	 КАК СуммаДопРасходовБезНДС,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СтоимостьРегл * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 			 КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ(ОстаткиСумм.СтоимостьЗабалансоваяРегл * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) КАК СтоимостьЗабалансоваяРегл,
	|	ВЫРАЗИТЬ(ОстаткиСумм.ДопРасходыРегл * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 			 КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(ОстаткиСумм.ПостояннаяРазница * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 		 КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(ОстаткиСумм.ВременнаяРазница * Т.Количество / ОстаткиСумм.КоличествоИзПартий КАК ЧИСЛО (15,2)) 		 КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТКорректировкаПартий
	|ИЗ
	|	ВТОстаткиПартий КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОстаткиСуммБезКоличества КАК ОстаткиСумм
	|	ПО Т.Организация = ОстаткиСумм.Организация
	|		И Т.РазделУчета = ОстаткиСумм.РазделУчета
	|		И Т.ВидЗапасов = ОстаткиСумм.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры = ОстаткиСумм.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	НЕ &СторнироватьОстаткиСебестоимости И &РаспределятьРасхожденияВСуммах
	|	И Т.Количество <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры
	|";
	
	#КонецОбласти
	
	Запрос.Выполнить(); // формируем ВТКорректировкаПартий 
	
	#Область КорректировкаЗависшихКопеек
	
	// Для каждого сочетания (РазделУчета, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов) из ВТЗависшиеКопейки
	// найдем единственное сочетание (Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС) из ВТКорректировкаПартий,
	// на которое и спишем "копейки", образовавшиеся в результате округления при корректировке расхождений в остатках партий и себестоимости. 
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры,
	|	СУММА(Т.КоличествоИзПартий)					КАК КоличествоИзПартий,
	|	СУММА(Т.Знак * Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.Знак * Т.СтоимостьБезНДС) 			КАК СтоимостьБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансовая) 	КАК СтоимостьЗабалансовая,
	|	СУММА(Т.Знак * Т.СуммаДопРасходов) 			КАК СуммаДопРасходов,
	|	СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) 	КАК СуммаДопРасходовБезНДС,
	|	СУММА(Т.Знак * Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Т.Знак * Т.ДопРасходыРегл) 			КАК ДопРасходыРегл,
	|	СУММА(Т.Знак * Т.ПостояннаяРазница) 		КАК ПостояннаяРазница,
	|	СУММА(Т.Знак * Т.ВременнаяРазница) 			КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТЗависшиеКопейки
	|ИЗ
	|	(ВЫБРАТЬ
	|		1 КАК Знак,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.КоличествоИзПартий			КАК КоличествоИзПартий,
	|		Т.Стоимость 					КАК Стоимость,
	|		Т.СтоимостьБезНДС 				КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая 		КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов 				КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС 		КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл 				КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл 	КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл 				КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница 				КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиСуммБезКоличества КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		-1 КАК Знак,
	|		Т.Организация,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.АналитикаУчетаНоменклатуры,
	|		0								КАК КоличествоИзПартий,
	|		Т.Стоимость 					КАК Стоимость,
	|		Т.СтоимостьБезНДС 				КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая 		КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов 				КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС 		КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл 				КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл 	КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл 				КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница 				КАК ВременнаяРазница
	|	ИЗ
	|		ВТКорректировкаПартий КАК Т
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры
	|
	|ИМЕЮЩИЕ
	|		СУММА(Т.Знак * Т.Стоимость) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансовая) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходов) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ДопРасходыРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ВременнаяРазница) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор КАК Регистратор,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.Коэффициент КАК Коэффициент,
	|	ЗависшиеКопейки.Стоимость КАК Стоимость,
	|	ЗависшиеКопейки.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	ЗависшиеКопейки.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	ЗависшиеКопейки.СуммаДопРасходов КАК СуммаДопРасходов,
	|	ЗависшиеКопейки.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|	ЗависшиеКопейки.СтоимостьРегл КАК СтоимостьРегл,
	|	ЗависшиеКопейки.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	ЗависшиеКопейки.ДопРасходыРегл КАК ДопРасходыРегл,
	|	ЗависшиеКопейки.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ЗависшиеКопейки.ВременнаяРазница КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТПартииДляСписанияКопеек
	|ИЗ
	|	ВТКорректировкаПартий КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЗависшиеКопейки КАК ЗависшиеКопейки
	|	ПО Т.Организация = ЗависшиеКопейки.Организация
	|		И Т.РазделУчета = ЗависшиеКопейки.РазделУчета
	|		И Т.ВидЗапасов = ЗависшиеКопейки.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры = ЗависшиеКопейки.АналитикаУчетаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры,
	|	Коэффициент,
	|	Партия,
	|	АналитикаУчетаПартий,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.Коэффициент КАК Коэффициент,
	|	Т.Стоимость КАК Стоимость,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|	Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|	Т.СтоимостьРегл КАК СтоимостьРегл,
	|	Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТКорректировкаКопеек
	|ИЗ
	|	ВТПартииДляСписанияКопеек КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПартииДляСписанияКопеек КАК Т2
	|	ПО Т.Организация = Т2.Организация
	|		И Т.РазделУчета = Т2.РазделУчета
	|		И Т.ВидЗапасов = Т2.ВидЗапасов
	|		И Т.АналитикаУчетаНоменклатуры = Т2.АналитикаУчетаНоменклатуры
	|		И ((Т.Коэффициент < Т2.Коэффициент)
	|			ИЛИ (Т.Коэффициент = Т2.Коэффициент И Т.Партия < Т2.Партия)
	|			ИЛИ (Т.Коэффициент = Т2.Коэффициент И Т.Партия = Т2.Партия И Т.АналитикаУчетаПартий < Т2.АналитикаУчетаПартий)
	|			ИЛИ (Т.Коэффициент = Т2.Коэффициент И Т.Партия = Т2.Партия И Т.АналитикаУчетаПартий = Т2.АналитикаУчетаПартий
	|					И Т.АналитикаФинансовогоУчета < Т2.АналитикаФинансовогоУчета)
	|			ИЛИ (Т.Коэффициент = Т2.Коэффициент И Т.Партия = Т2.Партия И Т.АналитикаУчетаПартий = Т2.АналитикаУчетаПартий
	|					И Т.АналитикаФинансовогоУчета = Т2.АналитикаФинансовогоУчета И Т.ВидДеятельностиНДС < Т2.ВидДеятельностиНДС))
	|ГДЕ
	|	Т2.Регистратор ЕСТЬ NULL
	|";
	
	#КонецОбласти
	
	Запрос.Выполнить(); // формируем ВТКорректировкаКопеек
	
	#Область ФормированиеДвижений
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Регистратор 						КАК Регистратор,
	|	Т.РазделУчета 						КАК РазделУчета,
	|	Т.Организация 						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры 		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	Т.Партия 							КАК Партия,
	|	Т.АналитикаУчетаПартий 				КАК АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета 		КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС 				КАК ВидДеятельностиНДС,
	|	СУММА(Т.Количество) 				КАК Количество,
	|	СУММА(Т.Стоимость) 					КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) 			КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьЗабалансовая) 		КАК СтоимостьЗабалансовая,
	|	СУММА(Т.СуммаДопРасходов) 			КАК СуммаДопРасходов,
	|	СУММА(Т.СуммаДопРасходовБезНДС) 	КАК СуммаДопРасходовБезНДС,
	|	СУММА(Т.СтоимостьРегл) 				КАК СтоимостьРегл,
	|	СУММА(Т.СтоимостьЗабалансоваяРегл) 	КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Т.ДопРасходыРегл) 			КАК ДопРасходыРегл,
	|	СУММА(Т.ПостояннаяРазница) 			КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) 			КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТОстаткиПартийСкорректированные
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		0 КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТКорректировкаПартий КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		0 КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТКорректировкаКопеек КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиПартий КАК Т
	|) КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТИзменившиесяДокументы
	|ИЗ
	|	(ВЫБРАТЬ
	|		1 КАК Знак,
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиПартийСкорректированные КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		-1 КАК Знак,
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		Т.Количество КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл + Т.ДопРасходыРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		0 КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиПартийСкорректированные КАК Т
	|	ГДЕ
	|		НЕ &СторнироватьОстаткиСебестоимости
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		-1 КАК Знак,
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК Количество,
	|		Т.Стоимость КАК Стоимость,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов КАК СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС КАК СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл КАК СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница
	|	ИЗ
	|		ВТОстаткиСебестоимости КАК Т
	|	ГДЕ
	|		&СторнироватьОстаткиСебестоимости
	|		И Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА -1
	|			ИНАЧЕ 1
	|		КОНЕЦ КАК Знак,
	|		Т.Регистратор,
	|		Т.РазделУчета,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		Т.Количество,
	|		Т.Стоимость,
	|		Т.СтоимостьБезНДС,
	|		Т.СтоимостьЗабалансовая,
	|		Т.СуммаДопРасходов,
	|		Т.СуммаДопРасходовБезНДС,
	|		Т.СтоимостьРегл,
	|		Т.СтоимостьЗабалансоваяРегл,
	|		Т.ДопРасходыРегл,
	|		Т.ПостояннаяРазница,
	|		Т.ВременнаяРазница
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
	|			ПО Т.Регистратор = ДокументыВводаОстатков.Ссылка
	|	ГДЕ
	|		Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных)
	|		И Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|		СУММА(Т.Знак * Т.Количество) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.Стоимость) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансовая) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходов) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СуммаДопРасходовБезНДС) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.СтоимостьЗабалансоваяРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ДопРасходыРегл) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Т.Знак * Т.ВременнаяРазница) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	&КонецПредыдущегоПериода КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.Количество,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьЗабалансовая,
	|	Т.СуммаДопРасходов,
	|	Т.СуммаДопРасходовБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.СтоимостьЗабалансоваяРегл,
	|	Т.ДопРасходыРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	ЛОЖЬ 												   КАК РасчетСебестоимости,
	|	ИСТИНА 												   КАК РасчетПартий,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных) КАК ТипЗаписи,
	|	Т.Регистратор 										   КАК ДокументИсточник
	|ИЗ
	|	ВТОстаткиПартийСкорректированные КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|		ПО Т.Регистратор = ВТИзменившиесяДокументы.Регистратор
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	&КонецПредыдущегоПериода,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка),
	|	Т.Количество,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьЗабалансовая,
	|	Т.СуммаДопРасходов,
	|	Т.СуммаДопРасходовБезНДС,
	|	Т.СтоимостьРегл + Т.ДопРасходыРегл КАК СтоимостьРегл,
	|	Т.СтоимостьЗабалансоваяРегл,
	|	0 КАК ДопРасходыРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	ЛОЖЬ 												   КАК РасчетСебестоимости,
	|	ИСТИНА 												   КАК РасчетПартий,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных) КАК ТипЗаписи,
	|	Т.Регистратор 										   КАК ДокументИсточник
	|ИЗ
	|	ВТОстаткиПартийСкорректированные КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|		ПО Т.Регистратор = ВТИзменившиесяДокументы.Регистратор
	|ГДЕ
	|	НЕ &СторнироватьОстаткиСебестоимости
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	&КонецПредыдущегоПериода КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	-Т.Количество,
	|	-Т.Стоимость,
	|	-Т.СтоимостьБезНДС,
	|	-Т.СтоимостьЗабалансовая,
	|	-Т.СуммаДопРасходов,
	|	-Т.СуммаДопРасходовБезНДС,
	|	-Т.СтоимостьРегл,
	|	-Т.СтоимостьЗабалансоваяРегл,
	|	-Т.ДопРасходыРегл,
	|	-Т.ПостояннаяРазница,
	|	-Т.ВременнаяРазница,
	|	ЛОЖЬ 												   КАК РасчетСебестоимости,
	|	ИСТИНА 												   КАК РасчетПартий,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных) КАК ТипЗаписи,
	|	Т.Регистратор 										   КАК ДокументИсточник
	|ИЗ
	|	ВТОстаткиСебестоимости КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|		ПО Т.Регистратор = ВТИзменившиесяДокументы.Регистратор
	|ГДЕ
	|	&СторнироватьОстаткиСебестоимости
	|	И Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	РазделУчета,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	ВидДвижения,
	|	Партия";
	
	#КонецОбласти
	
	РезультатЗапроса = Запрос.Выполнить(); // сформированные движения по переносу остатков
	
	#Область ЗаписьДвижений
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		
		// Запишем В ИБ движения, формирующие начальные остатки партий себестоимости версии 2.2
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Сформировано движений начальных остатков партий себестоимости: %1'"),
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
	
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	ИначеЕсли УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТОстаткиПартийСкорректированные") = 0 Тогда
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Нет начальных остатков партий для переноса в регистр себестоимости.'"));
		
	Иначе
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Начальные остатки партий в регистре себестоимости корректны, изменение не требуется.'"));
		
	КонецЕсли;
	
	// Очистим движения документов, по которым раньше были, а теперь нет остатков партий себестоимости.
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТИзменившиесяДокументы.Регистратор
	|ИЗ
	|	ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|		ЛЕВОЕ СОЕДИНЕНИЕ
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				Т.Регистратор КАК Регистратор
	|			ИЗ
	|				ВТОстаткиПартийСкорректированные КАК Т
	|			
	|			ОБЪЕДИНИТЬ ВСЕ
	|			
	|			ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				Т.Регистратор
	|			ИЗ
	|				ВТОстаткиСебестоимости КАК Т
	|			ГДЕ
	|				&СторнироватьОстаткиСебестоимости
	|			) КАК ДокументыСОстатками
	|		ПО ВТИзменившиесяДокументы.Регистратор = ДокументыСОстатками.Регистратор
	|ГДЕ
	|	ДокументыСОстатками.Регистратор ЕСТЬ NULL ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
	
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ОшибкиВОстатках
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	""СебестоимостьТоваров"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиСебестоимости КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииТоваровОрганизаций"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииТоваровОрганизаций КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииТоваровПереданныеНаКомиссию"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииПроизводственныхЗатрат"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииПроизводственныхЗатрат КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииРасходовНаСебестоимостьТоваров"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииРасходовНаСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='В регистре накопления ""%1"" на начало периода %2 есть остатки по пустой аналитике учета номенклатуры.'"),
			Выборка.ИмяРегистра,
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеПериодаРасчета(ПараметрыРасчета));
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВНачальныхОстаткахПУ22,
			ТекстСообщения);
		
	КонецЦикла;
	
	#КонецОбласти
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТОстаткиПартииТоваровОрганизаций, ВТОстаткиПартииТоваровПереданныеНаКомиссию, ВТОстаткиПартииПроизводственныхЗатрат,
		|ВТОстаткиПартииЗатратНаВыпуск, ВТОстаткиПартииРасходовНаСебестоимостьТоваров,
		//++ НЕ УТ
		|ВТОстаткиПартииНезавершенногоПроизводства,
		//-- НЕ УТ
		|ВТАналитикиПартийСВидомЦенности, ВТОстаткиПартийПредварительная,
		|ВТОстаткиПартий, ВТИзменившиесяДокументы, ВТОстаткиСебестоимости,
		|ВТОстаткиСуммБезКоличества, ВТКорректировкаПартий, ВТОстаткиПартийСкорректированные, ВТЗависшиеКопейки,
		|ВТПартииДляСписанияКопеек, ВТКорректировкаКопеек");
		
КонецПроцедуры

// При расчете первого месяца в партионном учете версии 2.2 формирует начальные остатки партий НДС и УСН.
//
Процедура СформироватьНачальныеОстаткиПартийНДСиУСН(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "СформироватьНачальныеОстаткиПартийНДСиУСН");
	
	ОписаниеРегистра = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя];
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область ВыборкаОстатков
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьРеглОстаток КАК СтоимостьБезНДС,
	|	Т.НДСРеглОстаток КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровОрганизаций
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода, Организация В (&МассивОрганизаций)
	|		И НЕ ВидЗапасов.ТипЗапасов В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар),
	|			 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
	|			 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьРеглОстаток КАК СтоимостьБезНДС,
	|	Т.НДСРеглОстаток КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровПереданныеНаКомиссию
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&ГраницаКонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьРеглОстаток КАК СтоимостьБезНДС,
	|	Т.НДСРеглОстаток КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартииПроизводственныхЗатрат
	|ИЗ
	|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&ГраницаКонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.ДокументПоступленияРасходов,
	|	Т.СтатьяРасходов,
	|	0 КАК Количество,
	|	Т.СтоимостьРеглОстаток КАК СтоимостьБезНДС,
	|	Т.НДСРеглОстаток КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартииРасходовНаСебестоимостьТоваров
	|ИЗ
	|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаПродукции,
	|	Т.ДокументВыпуска,
	|	Т.ДокументПоступления,
	|	0 КАК Количество,
	|	Т.СтоимостьРеглОстаток КАК СтоимостьБезНДС,
	|	Т.НДСРеглОстаток КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартииЗатратНаВыпуск
	|ИЗ
	|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&ГраницаКонецПредыдущегоПериода,	Организация В (&МассивОрганизаций)
	|		И АналитикаУчетаПродукции <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.РазделУчета 				 КАК РазделУчета,
	|	Т.Организация 				 КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 				 КАК ВидЗапасов,
	|	Т.ДокументПоступления 		 КАК Партия,
	|	Т.АналитикаУчетаПартий 		 КАК АналитикаУчетаПартий,
	|	Т.ВидЦенности 				 КАК ВидЦенности,
	|	СУММА(Т.Количество) 		 КАК Количество,
	|	СУММА(Т.СтоимостьБезНДС) 	 КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) 				 КАК НДС
	|ПОМЕСТИТЬ ВТОстаткиПартийПредварительная
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.ДокументПоступления КАК ДокументПоступления,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) КАК ВидЦенности,
	|		Т.Количество КАК Количество,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.НДС КАК НДС
	|	ИЗ
	|		ВТОстаткиПартииТоваровОрганизаций КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию),
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары),
	|		Т.Количество,
	|		Т.СтоимостьБезНДС,
	|		Т.НДС
	|	ИЗ
	|		ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Партнеры
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		ВЫБОР КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ,
	|		Т.Количество,
	|		Т.СтоимостьБезНДС,
	|		Т.НДС
	|	ИЗ
	|		ВТОстаткиПартииПроизводственныхЗатрат КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаНоменклатуры
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.ДокументПоступленияРасходов,
	|		(ВЫБОР
	|			КОГДА НЕ ПартииТоваров.АналитикаУчетаПартий ЕСТЬ NULL ТОГДА  ПартииТоваров.АналитикаУчетаПартий
	|			КОГДА НЕ ПартииЗатрат.АналитикаУчетаПартий ЕСТЬ NULL ТОГДА ПартииЗатрат.АналитикаУчетаПартий
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КОНЕЦ) КАК АналитикаУчетаПартий,
	|		ВЫБОР 
	|			КОГДА НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL 
	|				ТОГДА СтатьиРасходов.ВидЦенностиНДС
	|			КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги)
	|		КОНЕЦ,
	|		Т.Количество,
	|		Т.СтоимостьБезНДС,
	|		Т.НДС
	|	ИЗ
	|		ВТОстаткиПартииРасходовНаСебестоимостьТоваров КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|				И Т.АналитикаУчетаНоменклатуры = ПартииТоваров.АналитикаУчетаНоменклатуры
	|				И Т.ВидЗапасов = ПартииТоваров.ВидЗапасов
	|				И Т.ДокументПоступления = ПартииТоваров.ДокументПоступления
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииПроизводственныхЗатрат КАК ПартииЗатрат
	|			ПО Т.Организация = ПартииЗатрат.Организация
	|				И Т.АналитикаУчетаНоменклатуры = ПартииЗатрат.АналитикаУчетаНоменклатуры
	|				И Т.ВидЗапасов = ПартииЗатрат.ВидЗапасов
	|				И Т.ДокументПоступления = ПартииЗатрат.ДокументПоступления
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаНоменклатуры
	|			ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|			ПО Т.СтатьяРасходов = СтатьиРасходов.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаПродукции.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаПродукции.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаПродукции,
	|		ЕСТЬNULL(ПартииТоваров.ВидЗапасов, ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)),
	|		Т.ДокументПоступления,
	|		ЕСТЬNULL(ПартииТоваров.АналитикаУчетаПартий, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
	|		ВЫБОР КОГДА АналитикаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ,
	|		Т.Количество,
	|		Т.СтоимостьБезНДС,
	|		Т.НДС
	|	ИЗ
	|		ВТОстаткиПартииЗатратНаВыпуск КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|				И Т.АналитикаУчетаПродукции = ПартииТоваров.АналитикаУчетаНоменклатуры
	|				И Т.ДокументВыпуска = ПартииТоваров.ДокументПоступления
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО АналитикаНоменклатуры.КлючАналитики = Т.АналитикаУчетаПродукции
	|	
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЦенности
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПартий";
	
	#КонецОбласти
	
	Запрос.Выполнить(); // формируем ВТОстаткиПартийПредварительная
	
	СформироватьАналитикиПартийСВидомЦенности(ПараметрыРасчета); // формируем ВТАналитикиПартийСВидомЦенности
	
	#Область ФормированиеДвижений
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДокументыВводаОстатков.Ссылка КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Т.РазделУчета <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.РазделУчета
	|		КОГДА НЕ ОстаткиКомиссии.Организация ЕСТЬ NULL 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|	КОНЕЦ КАК РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|		ТОГДА Т.ВидЗапасов
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ КАК ВидЗапасов,
	|	ВЫБОР КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|		ТОГДА Т.Партия
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Партия,
	|	Т.Партия КАК ДокументПоступления,
	|	ЕСТЬNULL(АналитикиПартий.АналитикаУчетаПартийСВидомЦенности, Т.АналитикаУчетаПартий) КАК АналитикаУчетаПартий,
	|	ВЫБОР
	|		КОГДА Аналитика.ГруппаПродукции ЕСТЬ NULL 
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА Аналитика.ГруппаПродукции <> ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА Аналитика.ГруппаПродукции
	|		КОГДА Аналитика.АналитикаПредназначения ССЫЛКА Справочник.Назначения
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Аналитика.АналитикаПредназначения
	|	КОНЕЦ КАК АналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаПартий.НалогообложениеНДС ЕСТЬ NULL И Т.АналитикаУчетаПартий.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС
	|		КОГДА НЕ Аналитика.НалогообложениеНДС ЕСТЬ NULL И Аналитика.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Аналитика.НалогообложениеНДС
	|		КОГДА ЕСТЬNULL(ПримененияЕНВД.РозничнаяТорговляОблагаетсяЕНВД, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|		КОГДА НЕ СпрУчетнаяПолитикаУСН.Ссылка ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|	КОНЕЦ КАК ВидДеятельностиНДС,
	|	Т.Количество,
	|	Т.СтоимостьБезНДС,
	|	Т.НДС,
	|	ИСТИНА КАК РасчетПартий,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных) КАК ТипЗаписи,
	|	ДокументыВводаОстатков.Ссылка КАК ДокументИсточник
	|ПОМЕСТИТЬ ВТОстаткиПартий
	|ИЗ
	|	ВТОстаткиПартийПредварительная КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК ОстаткиКомиссии
	|		ПО (Т.РазделУчета = НЕОПРЕДЕЛЕНО)
	|			И Т.Организация = ОстаткиКомиссии.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ОстаткиКомиссии.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ОстаткиКомиссии.ВидЗапасов
	|			И Т.Партия = ОстаткиКомиссии.ДокументПоступления
	|			И Т.АналитикаУчетаПартий = ОстаткиКомиссии.АналитикаУчетаПартий
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаВидовЗапасов КАК Аналитика
	|		ПО Т.ВидЗапасов = Аналитика.КлючАналитики
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиПартийСВидомЦенности КАК АналитикиПартий
	|		ПО Т.АналитикаУчетаПартий = АналитикиПартий.АналитикаУчетаПартий
	|			И Т.ВидЦенности = АналитикиПартий.ВидЦенности
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
	|		ПО Т.Организация = ДокументыВводаОстатков.Организация
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПримененияЕНВД.СрезПоследних(&КонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК ПримененияЕНВД
	|		ПО Т.Организация = ПримененияЕНВД.Организация
	|			И Т.АналитикаУчетаНоменклатуры.Склад = ПримененияЕНВД.Склад
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаОрганизаций.СрезПоследних(&КонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК РегУчетнаяПолитика
	|		ПО Т.Организация = РегУчетнаяПолитика.Организация
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеПолитикиОрганизаций КАК СпрУчетнаяПолитикаУСН
	|			ПО РегУчетнаяПолитика.УчетнаяПолитика = СпрУчетнаяПолитикаУСН.Ссылка
	|				И СпрУчетнаяПолитикаУСН.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Упрощенная)
	|ГДЕ
	|	Т.Партия <> НЕОПРЕДЕЛЕНО
	|	И ЕСТЬNULL(АналитикиПартий.АналитикаУчетаПартийСВидомЦенности, Т.АналитикаУчетаПартий) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	И ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И (Т.Количество <> 0 ИЛИ Т.НДС <> 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТИзменившиесяДокументы
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор КАК Регистратор,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.ДокументПоступления КАК ДокументПоступления,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК Количество,
	|		Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Т.НДС КАК НДС,
	|		Т.РасчетПартий КАК РасчетПартий,
	|		Т.ТипЗаписи КАК ТипЗаписи,
	|		Т.ДокументИсточник КАК ДокументИсточник
	|	ИЗ
	|		ВТОстаткиПартий КАК Т
	|	ГДЕ
	|		Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор,
	|		Т.РазделУчета,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.Партия,
	|		Т.ДокументПоступления,
	|		Т.АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		-Т.Количество,
	|		-Т.СтоимостьБезНДС,
	|		-Т.НДС,
	|		Т.РасчетПартий,
	|		Т.ТипЗаписи,
	|		Т.ДокументИсточник
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
	|			ПО Т.Регистратор = ДокументыВводаОстатков.Ссылка
	|	ГДЕ
	|		Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПереносДанных)
	|		И Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.РасчетПартий,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Т.Количество) <> 0
	|		ИЛИ СУММА(Т.СтоимостьБезНДС) <> 0
	|		ИЛИ СУММА(Т.НДС) <> 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	&КонецПредыдущегоПериода КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.РасчетПартий,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник,
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) КАК НДС
	|ИЗ
	|	ВТОстаткиПартий КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|		ПО Т.Регистратор = ВТИзменившиесяДокументы.Регистратор
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.РасчетПартий,
	|	Т.ТипЗаписи,
	|	Т.ДокументИсточник
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	ВидДвижения,
	|	РазделУчета,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	Партия";
	
	#КонецОбласти
	
	РезультатЗапроса = Запрос.Выполнить(); // сформированные движения по переносу остатков
	
	#Область ЗаписьДвижений
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		
		// Запишем В ИБ движения, формирующие начальные остатки партий НДС версии 2.2
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Сформировано движений начальных остатков партий НДС: %1'"),
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
		
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	ИначеЕсли УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТОстаткиПартий") = 0 Тогда
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Нет начальных остатков партий НДС.'"));
		
	Иначе
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Начальные остатки партий НДС корректны, изменение не требуется.'"));
		
	КонецЕсли;
	
	// Очистим движения документов, по которым раньше были, а теперь нет остатков партий НДС
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТИзменившиесяДокументы.Регистратор
	|ИЗ
	|	ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартий КАК ДокументыСОстатками
	|		ПО ВТИзменившиесяДокументы.Регистратор = ДокументыСОстатками.Регистратор
	|ГДЕ
	|	ДокументыСОстатками.Регистратор ЕСТЬ NULL ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
	
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ОшибкиВОстатках
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииТоваровОрганизаций"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииТоваровОрганизаций КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииТоваровПереданныеНаКомиссию"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииПроизводственныхЗатрат"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииПроизводственныхЗатрат КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""ПартииРасходовНаСебестоимостьТоваров"" КАК ИмяРегистра
	|ИЗ
	|	ВТОстаткиПартииРасходовНаСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='В регистре накопления ""%1"" на начало периода %2 есть остатки по пустой аналитике учета номенклатуры.'"),
			Выборка.ИмяРегистра,
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеПериодаРасчета(ПараметрыРасчета));
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВНачальныхОстаткахПУ22,
			ТекстСообщения);
		
	КонецЦикла;
	
	#КонецОбласти
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТОстаткиПартииТоваровОрганизаций, ВТОстаткиПартииТоваровПереданныеНаКомиссию, ВТОстаткиПартииПроизводственныхЗатрат,
		|ВТОстаткиПартииЗатратНаВыпуск, ВТОстаткиПартииРасходовНаСебестоимостьТоваров,
		|ВТАналитикиПартийСВидомЦенности, ВТОстаткиПартийПредварительная, ВТОстаткиПартий, ВТИзменившиесяДокументы");
	
КонецПроцедуры

// Заполняет вид ценности в ключах аналитики учета партий и создает временную таблицу ВТАналитикиПартийСВидомЦенности.
//
Процедура СформироватьАналитикиПартийСВидомЦенности(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаПартий,
	|	ЗНАЧЕНИЕ(Справочник.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаФинансовогоУчета,
	|	Ключи.Поставщик,
	|	Ключи.Контрагент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
	|	Ключи.СтавкаНДС,
	|	Т.ВидЦенности
	|ПОМЕСТИТЬ ВТРеквизитыНовыхКлючейАналитикиУчетаПартий
	|ИЗ
	|	ВТОстаткиПартийПредварительная КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК Ключи
	|		ПО Т.АналитикаУчетаПартий = Ключи.Ссылка
	|ГДЕ
	|	Ключи.ВидЦенности <> Т.ВидЦенности
	|	ИЛИ Ключи.ГруппаФинансовогоУчета <> ЗНАЧЕНИЕ(Справочник.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка)
	|	ИЛИ Ключи.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&НачалоПериода КАК Дата,
	|	Т.ГруппаФинансовогоУчета,
	|	Т.Поставщик,
	|	Т.Контрагент,
	|	Т.НалогообложениеНДС,
	|	Т.СтавкаНДС,
	|	Т.ВидЦенности
	|ИЗ
	|	ВТРеквизитыНовыхКлючейАналитикиУчетаПартий КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикаПартий
	|		ПО Т.ГруппаФинансовогоУчета = АналитикаПартий.ГруппаФинансовогоУчета
	|		 И Т.Поставщик 				= АналитикаПартий.Поставщик
	|		 И Т.Контрагент 			= АналитикаПартий.Контрагент
	|		 И Т.НалогообложениеНДС 	= АналитикаПартий.НалогообложениеНДС
	|		 И Т.СтавкаНДС 				= АналитикаПартий.СтавкаНДС
	|		 И Т.ВидЦенности 			= АналитикаПартий.ВидЦенности
	|ГДЕ
	|	ЕСТЬNULL(АналитикаПартий.КлючАналитики, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка))
	|		= ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|";
	
	Выборка = Запрос.Выполнить().Выбрать(); // получим аналитики учета партий с некорректным видом ценности
	Пока Выборка.Следующий() Цикл
		
		// Вид ценности в ключе аналитики, по которому есть остатки "старых" партий (из партионных регистров),
		// по всей видимости будет не заполнен.
		// В то же время, при формировании остатков "новых" партий (в регистре себестоимости),
		// мы знаем к какому именно виду ценности относятся эти остатки.
		// Поэтому, если вид ценности в ключе аналитики "старых" остатков не совпадает с видом ценности "новых" остатков,
		// то ключ аналитики "новых" остатков нельзя брать из "старых" остатков - его надо заменить.
		// Аналогичная ситуация и с реквизитами "ГруппаФинансовогоУчета" и "НалогообложениеНДС" - они должны быть пустыми,
		// но в "старых" ключах они скорее всего будут заполнены.
		// При этом, подходящий ключ для "новых" остатков уже может существовать в ИБ:
		// - до выполнения этого кода (при закрытии месяца) в ИБ добавлялись/изменялись документы
		// - при проведении этих документов формировались ключи аналитики с заполненным видом ценности
		// - эти ключи могут оказаться подходящими для "новых" остатков
		// Создадим только ключи, отсутствующие в ИБ на текущий момент.
		НовыйКлючАналитики = Справочники.КлючиАналитикиУчетаПартий.ПолучитьКлючАналитики(Выборка, Ложь);
		
	КонецЦикла;
	
	// Теперь в регистре (и в справочнике) ключей есть все необходимые ключи для "новых" остатков.
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидЦенности,
	|	АналитикаПартий.КлючАналитики КАК АналитикаУчетаПартийСВидомЦенности
	|ПОМЕСТИТЬ ВТАналитикиПартийСВидомЦенности
	|ИЗ
	|	ВТРеквизитыНовыхКлючейАналитикиУчетаПартий КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикаПартий
	|		ПО Т.ГруппаФинансовогоУчета = АналитикаПартий.ГруппаФинансовогоУчета
	|		 И Т.Поставщик 				= АналитикаПартий.Поставщик
	|		 И Т.Контрагент 			= АналитикаПартий.Контрагент
	|		 И Т.НалогообложениеНДС 	= АналитикаПартий.НалогообложениеНДС
	|		 И Т.СтавкаНДС 				= АналитикаПартий.СтавкаНДС
	|		 И Т.ВидЦенности 			= АналитикаПартий.ВидЦенности
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТРеквизитыНовыхКлючейАналитикиУчетаПартий
	|";
	
	Запрос.Выполнить(); // формируем ВТАналитикиПартийСВидомЦенности
	
КонецПроцедуры


// Проверяет, был ли выполнен расчет текущего периода в партионном учете версии 2.2.
// Если был выполнен, то значит выполнялись процедуры
//	- ОчиститьНеиспользуемыеДанныеПартионногоУчетаВерсии21()
//	- ИсправитьПроблемыВДвиженияхИДокументах() (в части корректировки полей партионного учета версии 2.2)
// и в регистрах нет устаревших и некорректных движений.
//
Функция ПроверитьНеобходимостьЗаполненияРеквизитаРасчетПартий(ПараметрыРасчета)
	
	// Проверим наличие движений по партионным регистрам версии 2.1
	ШаблонТекстаЗапроса =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	""%1"" КАК РегистрСоСтарымиДвижениями
	|ИЗ
	|	%1 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
	|";
	
	ТекстЗапроса = "";
	
	Для Каждого МетаданныеРегистра Из НеиспользуемыеДанныеМеханизмаВерсии21() Цикл
		ТекстЗапроса = ТекстЗапроса
			+ ?(ТекстЗапроса = "", "", ТекстОбъединениеЗапросов())
			+ СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонТекстаЗапроса, МетаданныеРегистра.Ключ.ПолноеИмя());
	КонецЦикла;
	
	// Проверим наличие первичных движений себестоимости с незаполненным типом записи
	ТекстЗапроса = ТекстЗапроса
	+ ТекстОбъединениеЗапросов() + "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	""%1"" КАК РегистрСоСтарымиДвижениями
	|ИЗ
	|	%1 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|	И НЕ Т.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|";
	
	ТекстЗапроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗапроса,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.ПолноеИмя());
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ТекстЗапроса;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат НЕ РезультатЗапроса.Пустой(); // есть "старые" движения - расчет в версии 2.2 еще не выполнялся
	
КонецФункции

// Заполняет реквизит РасчетПартий, если период был рассчитан в партионном учете версии 2.1.
//
Процедура ЗаполнитьРеквизитРасчетПартий(ПараметрыРасчета, ОписаниеРегистра,
			ТекстРасчетПартий, ТекстСоединения, ТекстУпорядочивание)
	
	// В регистре могут быть движения с некорректно незаполненным полем РасчетПартий.
	// Такие движения будут, если месяц был рассчитан ранее в партионном учете версии 2.1
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ЗаполнитьРеквизитРасчетПартий" + ОписаниеРегистра.ИмяРегистра);
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Получим перечень регистраторов с некорректными движениями
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТРегистраторыСНекорректнымиДвижениями
	|ИЗ
	|	%1 КАК Т
	|		%2
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|	И %3 <> Т.РасчетПартий";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Запрос.Текст,
	    ОписаниеРегистра.ПолноеИмяРегистра,
		ТекстСоединения,
		ТекстРасчетПартий); 
		
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "ВТРегистраторыСНекорректнымиДвижениями");
	Запрос.Выполнить();
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	Если УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТРегистраторыСНекорректнымиДвижениями") > 0 Тогда
		
		// Выберем движения, правильно заполним служебный реквизит и перезапишем эти движения в ИБ
		Запрос.Текст =
		"ВЫБРАТЬ
		|	%1
		|ИЗ
		|	%2 КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРегистраторыСНекорректнымиДвижениями КАК Регистраторы
		|		ПО Т.Регистратор = Регистраторы.Регистратор
		|		%3
		|
		|УПОРЯДОЧИТЬ ПО
		|	%4";
		
		// Подставим шаблоны в текст запроса
		ПоляОсновнойТаблицыРегистра = СтрЗаменить(ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, "%1", "Т.");
		ПоляОсновнойТаблицыРегистра = СтрЗаменить(ПоляОсновнойТаблицыРегистра, "Т.РасчетПартий", ТекстРасчетПартий + " КАК РасчетПартий");
		
		ПоляУпорядочивания = "Т.Регистратор, Т.РасчетПартий, Т.Период"
			+ ?(ОписаниеРегистра.ЕстьОрганизация, 		  ", Т.Организация", "")
			+ ?(ОписаниеРегистра.ЕстьАналитикаПартнеров,  ", Т.АналитикаУчетаПоПартнерам", "")
			+ ?(ОписаниеРегистра.ЕстьСвойствоВидДвижения, ", Т.ВидДвижения", "")
			+ ?(ПустаяСтрока(ТекстУпорядочивание), "", ", ") + ТекстУпорядочивание;
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Запрос.Текст,
			ПоляОсновнойТаблицыРегистра,
			ОписаниеРегистра.ПолноеИмяРегистра,
			ТекстСоединения,
			ПоляУпорядочивания); 
			
		// Перезапишем движения с правильно заполненным служебным реквизитом
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Запрос,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
		
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	КонецЕсли;
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТРегистраторыСНекорректнымиДвижениями");
	
КонецПроцедуры

// Исправляет проблемы в движениях документов и в самих документах в рассчитываемом периоде.
//
// Есть ошибки, которые "портят" исходные данные для расчета,
// но для исправления их последствий не пишется обработчик обновления.
// Например, из-за какой-то старой ошибки в каких-то случаях движения документа были некорректны.
// - если для исправления этой ошибки написать обработчик обновления,
// то он изменит данные прошлых, "закрытых" периодов, из-за чего эти периоды перестанут быть "закрытыми".
// Придется повторно закрывать эти периоды, из-за чего в них может измениться себестоимость и, как следствие, регламентированная отчетность.
// Это плохо, т.к. по этим периодам отчетность уже может быть сдана.
// - с другой стороны, в тех периодах, которые пользователь будет пересчитывать, эту ошибку в движениях надо бы исправить,
// чтобы в этих пересчитанных периодах себестоимость основывалась на правильных исходных данных.
//
// Для исправления таких ошибок и предназначена данная процедура.
// По сути, она является аналогом обработчика обновления, исправляющего движения документов в периоде, указанном пользователем.
//
// Также эта процедура используется для корректировки движений периода при его перерасчете в партионном учете версии 2.2.
//
Процедура ИсправитьПроблемыВДвиженияхИДокументах(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ИсправитьПроблемыВДвиженияхИДокументах");
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	//++ НЕ УТ
	
	#Область ВидЗапасовВОтчетеПереработчика
	
	Если ПараметрыРасчета.ФО.УчитыватьСебестоимостьТоваровПоВидамЗапасов Тогда
		
		// Заполнение вида запасов в табличной части документа, введенного при использовании партионного учета версии 2.1.
		// Вид запасов в этом документе используется только в партионном учете версии 2.2 - при формировании
		// движений по регистру "Себестоимость товаров".
		// Сами движения будут переформированы далее по ходу этой процедуры.
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОтчетПереработчика.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ОтчетПереработчика.Продукция КАК ТаблицаПродукция
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
		|		ПО ТаблицаПродукция.Ссылка = ОтчетПереработчика.Ссылка
		|ГДЕ
		|	ОтчетПереработчика.Проведен
		|	И ОтчетПереработчика.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ОтчетПереработчика.Организация В(&МассивОрганизаций)
		|	И ТаблицаПродукция.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|";
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			НачатьТранзакцию();
			
			Попытка
				
				Блокировка = Новый БлокировкаДанных;
				ЭлементБлокировки = Блокировка.Добавить("Документ.ОтчетПереработчика");
				ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
				Блокировка.Заблокировать();
				
				ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект();
				
				Документы.ОтчетПереработчика.ЗаполнитьВидыЗапасовПродукции(ДокументОбъект);
				
				ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				
				ОтменитьТранзакцию();
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось обработать документ ""%1"" по причине:
						|		%2'"),
					Выборка.Ссылка,
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
					ПараметрыРасчета,
					Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВосстановленияДвиженийДокументов,
					ТекстСообщения,
					ТекстСообщения);
				
			КонецПопытки;
			
		КонецЦикла;
		
		Если Выборка.Количество() > 0 Тогда
			
			ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
				ПараметрыРасчета,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru='Заполнен новый реквизит ""Вид запасов"" в документах ""Отчет переработчика"": %1'"),
					ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	//-- НЕ УТ
	
	#Область ПоляПартионногоУчетаВерсии22
	
	// Проверим в первичных движениях документов корректность заполнения полей:
	// Партия, КорПартия, ТипЗаписи, аналитика учета партий, вид деятельности НДС.
	// Если поля заполнены некорректно, то, видимо, документ был проведен до перехода на партионный учет версии 2.2 -
	// надо перепровести документ по регистру, содержащему некорректные движения.
	// Если после перепроведения документа поля все равно заполнены некорректно, значит ошибка кроется
	// в процедурах формирования движений документа или в макете описания движений (для регистра себестоимости товаров).
	
	// Подготовим вспомогательные данные.
	ОписаниеЦепочек 		= ОписаниеЦепочекПартийТоваров(ПараметрыРасчета);
	ИспользуемыеТипыЗаписей = ИспользуемыеТипыЗаписейВЦепочках(ОписаниеЦепочек);
	
	Запрос.УстановитьПараметр("ИспользуемыеТипыЗаписей", ИспользуемыеТипыЗаписей);
	
	// Подготовим запрос для формирования ВТРегистраторыСНекорректнымиДвижениями.
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ВидДвижения				 КАК ВидДвижения,
	|	Т.Регистратор 				 КАК Регистратор,
	|	Т.Организация 				 КАК Организация,
	|	Т.КорОрганизация 			 КАК КорОрганизация,
	|	Т.Партия 	  				 КАК Партия,
	|	Т.КорПартия 	  			 КАК КорПартия,
	|	Т.ХозяйственнаяОперация 	 КАК ХозяйственнаяОперация,
	|	Т.ТипЗаписи					 КАК ТипЗаписи,
	|	Т.АналитикаУчетаПартий		 КАК АналитикаУчетаПартий,
	|	Т.КорАналитикаУчетаПартий	 КАК КорАналитикаУчетаПартий,
	//++ НЕ УТ
	|	Статьи.Ссылка				 КАК СтатьяКалькуляции, 
	|	КорСтатьи.Ссылка			 КАК КорСтатьяКалькуляции, 
	//-- НЕ УТ
	|	Т.РазделУчета				 КАК РазделУчета,
	|	Т.КорРазделУчета			 КАК КорРазделУчета,
	|	ВЫБОР КОГДА Т.Количество > 0
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ 						 КАК ПоложительноеКоличество
	|ПОМЕСТИТЬ ВТДвиженияСебестоимостьТоваров
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	//++ НЕ УТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтатьиКалькуляции КАК Статьи
	|			ПО АналитикаНоменклатуры.СтатьяКалькуляции = Статьи.Ссылка
	|		ПО Т.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтатьиКалькуляции КАК КорСтатьи
	|			ПО КорАналитикаНоменклатуры.СтатьяКалькуляции = КорСтатьи.Ссылка
	|		ПО Т.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	//-- НЕ УТ
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И НЕ Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
	|	И НЕ Т.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор 			 КАК Регистратор,
	|	Т.АналитикаУчетаПартий	 КАК АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС	 КАК ВидДеятельностиНДС
	|ПОМЕСТИТЬ ВТДвиженияПартииПрочихРасходов
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ИмяРегистра КАК ИмяРегистра,
	|	Т.Ссылка 	  КАК Ссылка,
	|	Т.КодОшибки   КАК КодОшибки
	|ПОМЕСТИТЬ ВТРегистраторыСНекорректнымиДвижениями
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"" КАК ИмяРегистра,
	|		Т.Регистратор КАК Ссылка,
	|		ВЫБОР
	|			КОГДА Правила.ПустоеЗначениеРегистратора ЕСТЬ NULL 
	|				ТОГДА 1
	|			КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ВЫБОР
	|						КОГДА Т.ТипЗаписи = Правила.ТипЗаписиПриход
	|							ТОГДА 0
	|						ИНАЧЕ 2
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА Т.ТипЗаписи = Правила.ТипЗаписиРасход
	|						ТОГДА 0
	|					ИНАЧЕ 3
	|				КОНЕЦ
	|		КОНЕЦ КАК КодОшибки
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТПравилаЗаполненияПоляТипЗаписи КАК Правила
	|			ПО ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИПЗНАЧЕНИЯ(Правила.ПустоеЗначениеРегистратора)
	|				И (Правила.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
	|					ИЛИ Т.ХозяйственнаяОперация = Правила.ХозяйственнаяОперация)
	|				И (Правила.ПоложительноеКоличество = НЕОПРЕДЕЛЕНО
	|					ИЛИ Т.ПоложительноеКоличество = Правила.ПоложительноеКоличество)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"",
	|		Т.Регистратор,
	|		ВЫБОР
	|			КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящая) И Т.Партия = НЕОПРЕДЕЛЕНО
	|				ТОГДА 4
	|			КОГДА НЕ (Т.Организация В (&ОрганизацииСФИФОСкользящая)) И Т.Партия <> НЕОПРЕДЕЛЕНО
	|			  И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	//++ НЕ УТ
	|			  И НЕ (Т.РазделУчета В(ЗНАЧЕНИЕ (Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|											ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение))
	|					И НЕ Т.СтатьяКалькуляции ЕСТЬ NULL)
	//-- НЕ УТ
	|				ТОГДА 5
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|	ГДЕ
	|		Т.ТипЗаписи В (&ТипыЗаписейПервичныхПартий)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"",
	|		Т.Регистратор,
	|		ВЫБОР
	// Проверка кор. партии в расходных движениях при заполненной кор. организации (схема Интеркампани)
	|			КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящая)
	|					И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					И НЕ Правила.КорПартияВРасходе ЕСТЬ NULL
	|					И Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|					И НЕ (Т.КорОрганизация В (&ОрганизацииСФИФОСкользящая))
	|				ТОГДА
	|					ВЫБОР КОГДА Т.КорПартия = НЕОПРЕДЕЛЕНО
	//++ НЕ УТ
	|			  					ИЛИ (Т.КорРазделУчета В (ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|											ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение))
	|									И НЕ Т.КорСтатьяКалькуляции ЕСТЬ NULL)
	//-- НЕ УТ
	|						ТОГДА 0
	|						ИНАЧЕ 5
	|					КОНЕЦ
	|			КОГДА НЕ (Т.Организация В (&ОрганизацииСФИФОСкользящая))
	|					И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					И НЕ Правила.КорПартияВРасходе ЕСТЬ NULL
	|					И Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|					И Т.КорОрганизация В (&ОрганизацииСФИФОСкользящая)
	|				ТОГДА
	|					ВЫБОР КОГДА Т.КорПартия <> Т.Регистратор
	|						ТОГДА 6
	|						ИНАЧЕ 0
	|					КОНЕЦ
	// Проверка кор. партии в расходных движениях без кор. организации (изменение документа партии внутри одной организации)
	|			КОГДА Т.Организация В (&ОрганизацииСФИФОСкользящая)
	|					И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					И Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|					И НЕ Правила.КорПартияВРасходе ЕСТЬ NULL
	|					И (
	//++ НЕ УТКА
							// для этапа производства кор. партия заполняется выпускающим этапом
	|						(Т.Регистратор Ссылка Документ.ЭтапПроизводства2_2 И
	|							((Правила.КорПартияВРасходе И Т.КорПартия <> Т.Регистратор.ВыпускающийЭтап) 
	|								ИЛИ (НЕ Правила.КорПартияВРасходе И Т.КорПартия = Т.Регистратор.ВыпускающийЭтап)))
	|							ИЛИ 
	//-- НЕ УТКА
	|						(
	//++ НЕ УТКА
	|							НЕ Т.Регистратор Ссылка Документ.ЭтапПроизводства2_2 И
	//-- НЕ УТКА
	|							((Правила.КорПартияВРасходе И Т.КорПартия <> Т.Регистратор) 
	|								ИЛИ (НЕ Правила.КорПартияВРасходе И Т.КорПартия = Т.Регистратор)))
	|					)
	//++ НЕ УТ
	|			  		И НЕ (Т.КорРазделУчета В (ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|											ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение))
	|						И НЕ Т.КорСтатьяКалькуляции ЕСТЬ NULL)
	//-- НЕ УТ
	|				ТОГДА 6
	|			КОГДА НЕ (Т.Организация В (&ОрганизацииСФИФОСкользящая))
	|					И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|					И Т.КорПартия = Т.Регистратор
	|					И Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	//++ НЕ УТ
	|					И НЕ (Т.КорРазделУчета В (ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|											ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение))
	|						И НЕ Т.КорСтатьяКалькуляции ЕСТЬ NULL)
	//-- НЕ УТ
	|				ТОГДА 5
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТПравилаЗаполненияПоляТипЗаписи КАК Правила
	|			ПО ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИПЗНАЧЕНИЯ(Правила.ПустоеЗначениеРегистратора)
	|				И (Правила.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
	|					ИЛИ Т.ХозяйственнаяОперация = Правила.ХозяйственнаяОперация)
	|				И (Правила.ПоложительноеКоличество = НЕОПРЕДЕЛЕНО
	|					ИЛИ Т.ПоложительноеКоличество = Правила.ПоложительноеКоличество)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"",
	|		Т.Регистратор,
	|		7
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|	ГДЕ
	|		НЕ (Т.ТипЗаписи В (&ИспользуемыеТипыЗаписей))
	|		И НЕ (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"",
	|		Т.Регистратор,
	|		8
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК Аналитики
	|			ПО Т.АналитикаУчетаПартий = Аналитики.Ссылка
	|	ГДЕ
	|		Аналитики.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""СебестоимостьТоваров"",
	|		Т.Регистратор,
	|		9
	|	ИЗ
	|		ВТДвиженияСебестоимостьТоваров КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК Аналитики
	|			ПО Т.КорАналитикаУчетаПартий = Аналитики.Ссылка
	|	ГДЕ
	|		Аналитики.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""ПартииПрочихРасходов"",
	|		Т.Регистратор,
	|		8
	|	ИЗ
	|		ВТДвиженияПартииПрочихРасходов КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК Аналитики
	|			ПО Т.АналитикаУчетаПартий = Аналитики.Ссылка
	|	ГДЕ
	|		Аналитики.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		""ПартииПрочихРасходов"",
	|		Т.Регистратор,
	|		10
	|	ИЗ
	|		ВТДвиженияПартииПрочихРасходов КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК Аналитики
	|			ПО Т.АналитикаУчетаПартий = Аналитики.Ссылка
	|	ГДЕ
	|		Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|	) КАК Т
	|
	|ГДЕ
	|	Т.КодОшибки <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДвиженияСебестоимостьТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДвиженияПартииПрочихРасходов
	|";
	
	// Сформируем описание возможных кодов ошибок в движениях.
	РасшифровкаКодовОшибок = Новый Соответствие;
	РасшифровкаКодовОшибок.Вставить(1, НСтр("ru='Для движения не найдено соответствующее ему правило заполнения типа записи'"));
	РасшифровкаКодовОшибок.Вставить(2, НСтр("ru='Тип записи приходного движения не соответствует правилу'"));
	РасшифровкаКодовОшибок.Вставить(3, НСтр("ru='Тип записи расходного движения не соответствует правилу'"));
	РасшифровкаКодовОшибок.Вставить(4, НСтр("ru='Для организаций с методом оценки ""ФИФО (скользящая)"" не заполнена первичная партия'"));
	РасшифровкаКодовОшибок.Вставить(5, НСтр("ru='Для организаций с методом оценки, отличным от ""ФИФО (скользящая)"", заполнена первичная партия или кор. партия'"));
	РасшифровкаКодовОшибок.Вставить(6, НСтр("ru='Для организаций с методом оценки ""ФИФО (скользящая)"" некорректно заполнена кор. партия в расходном движении'"));
	РасшифровкаКодовОшибок.Вставить(7, НСтр("ru='Тип записи, указанный в движении, не используется при распределении партий'"));
	РасшифровкаКодовОшибок.Вставить(8, НСтр("ru='Аналитика учета партий не содержит вида ценности'"));
	РасшифровкаКодовОшибок.Вставить(9, НСтр("ru='Кор. аналитика учета партий не содержит вида ценности'"));
	РасшифровкаКодовОшибок.Вставить(10, НСтр("ru='Не заполнен вид деятельности НДС при заполненной аналитике учета партий'"));
	
	УниверсальныеМеханизмыПартийИСебестоимости.ПерепровестиДокументыПоОтдельнымРегистрамНакопления(
		ПараметрыРасчета,
		Запрос,
		РасшифровкаКодовОшибок,
		НСтр("ru='переход на партионный учет версии 2.2'"));
	
	#КонецОбласти
	
	#Область ВыручкаИСебестоимостьПродаж
	
	// Исправление некорректных движений в регистре "Выручка и себестоимость продаж".
	РасшифровкаКодовОшибок = Новый Соответствие;
	РасшифровкаКодовОшибок.Вставить(1, НСтр("ru='Дублирование расчетной себестоимости в первичных движениях'"));
	
	Запрос.Текст = ПартионныйУчет.ТекстЗапросаДокументыСДублямиДвиженийПоВыручкеИСебестоимостиПродаж();
	
	УниверсальныеМеханизмыПартийИСебестоимости.ПерепровестиДокументыПоОтдельнымРегистрамНакопления(
		ПараметрыРасчета,
		Запрос,
		РасшифровкаКодовОшибок,
		НСтр("ru='ошибка 00-00071689'"));
	
	#КонецОбласти
	
	#Область НекорректнаяАналитикаФинансовогоУчета
	
	// Исправление некорректной пустой аналитики финансового учета в регистре "Себестоимость товаров".
	РасшифровкаКодовОшибок = Новый Соответствие;
	РасшифровкаКодовОшибок.Вставить(1, НСтр("ru='Пустая аналитика финансового учет в первичных движениях имеет значение отличное от НЕОПРЕДЕЛЕНО'"));
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""СебестоимостьТоваров"" КАК ИмяРегистра,
	|	Т.Регистратор 			 КАК Ссылка,
	|	1 						 КАК КодОшибки
	|ПОМЕСТИТЬ ВТРегистраторыСНекорректнымиДвижениями
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.АналитикаФинансовогоУчета В
	|		(ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|		 ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка),
	|		 ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка),
	|		 ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))";
	
	УниверсальныеМеханизмыПартийИСебестоимости.ПерепровестиДокументыПоОтдельнымРегистрамНакопления(
		ПараметрыРасчета,
		Запрос,
		РасшифровкаКодовОшибок,
		НСтр("ru='ошибка 00-00098117'"));
	
	#КонецОбласти
	
	#Область ЗаполненКорВидЗапасов
	
	// Исправление заполненных реквизито "КорВидЗапасов" в регистре "Себестоимость товаров".
	РасшифровкаКодовОшибок = Новый Соответствие;
	РасшифровкаКодовОшибок.Вставить(1, НСтр("ru='Заполнен реквизит ""Кор вид запасов"" при отключенном обособленном учете себестоимости по видам запасов.'"));
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""СебестоимостьТоваров"" КАК ИмяРегистра,
	|	Т.Регистратор 			 КАК Ссылка,
	|	1 						 КАК КодОшибки
	|ПОМЕСТИТЬ ВТРегистраторыСНекорректнымиДвижениями
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|	И Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Регистратор ССЫЛКА Документ.КорректировкаРеализации
	|	И Т.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|";
	
	УниверсальныеМеханизмыПартийИСебестоимости.ПерепровестиДокументыПоОтдельнымРегистрамНакопления(
		ПараметрыРасчета,
		Запрос,
		РасшифровкаКодовОшибок,
		НСтр("ru='ошибка 00-00109617'"));
	
	#КонецОбласти
	
КонецПроцедуры

// При расчете в партионном учете версии 2.2 очищает начальные остатки и движения партионного учета версии 2.1.
//
Процедура ОчиститьНеиспользуемыеДанныеПартионногоУчетаВерсии21(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоЭтапаРасчета(ПараметрыРасчета, "ОчиститьНеиспользуемыеДанныеПартионногоУчетаВерсии21");
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Очистим остатки партионных регистров версии 2.1, которые больше не используются в партионном учете версии 2.2.
	Если ПараметрыРасчета.ФормироватьНачальныеОстаткиПартий22 Тогда
		
		ШаблонТекстаЗапроса =
		"ВЫБРАТЬ
		|	ДокументыВводаОстатков.Ссылка КАК Регистратор,
		|	%2,
		|	%5
		|ПОМЕСТИТЬ ВТОстаткиПартий
		|ИЗ
		|	РегистрНакопления.%1.Остатки(&ГраницаКонецПредыдущегоПериода, Организация В (&МассивОрганизаций)) КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
		|		ПО Т.Организация = ДокументыВводаОстатков.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор
		|ПОМЕСТИТЬ ВТИзменившиесяДокументы
		|ИЗ
		|	(ВЫБРАТЬ
		|		Т.Регистратор КАК Регистратор,
		|		%2,
		|		%3
		|	ИЗ
		|		ВТОстаткиПартий КАК Т
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Т.Регистратор,
		|		%2,
		|		%4
		|	ИЗ
		|		РегистрНакопления.%1 КАК Т
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыВводаОстатков
		|			ПО Т.Регистратор = ДокументыВводаОстатков.Ссылка
		|	ГДЕ
		|		Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров) КАК Т
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Регистратор,
		|	%2
		|
		|ИМЕЮЩИЕ
		|	%6
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	&НачалоПериода КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Т.Регистратор КАК Регистратор,
		|	%2,
		|	%3
		|ИЗ
		|	ВТОстаткиПартий КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзменившиесяДокументы КАК ВТИзменившиесяДокументы
		|		ПО Т.Регистратор = ВТИзменившиесяДокументы.Регистратор
		|
		|УПОРЯДОЧИТЬ ПО
		|	Т.Регистратор,
		|	%2
		|";
		
		Для Каждого КлючИЗначение Из НеиспользуемыеДанныеМеханизмаВерсии21() Цикл
			
			// Сформируем текст запроса для выборки остатков
			МетаданныеРегистра = КлючИЗначение.Ключ;
			ИмяРегистра = МетаданныеРегистра.Имя; // %1
			
			ТекстИзмеренияРегистра = "";
			ТекстРесурсыРегистра = "";
			ТекстРесурсыРегистраСМинусом = "";
			ТекстОстаткиРесурсовРегистра = "";
			ТекстОтборРесурсыРегистра = "";
			
			Для Каждого ПолеРегистра Из МетаданныеРегистра.Измерения Цикл
				ТекстИзмеренияРегистра = ТекстИзмеренияРегистра + ?(ТекстИзмеренияРегистра = "", "", ",
					|	") + "Т." + ПолеРегистра.Имя;
			КонецЦикла;
			
			Для Каждого ПолеРегистра Из МетаданныеРегистра.Ресурсы Цикл
				ТекстРесурсыРегистра = ТекстРесурсыРегистра + ?(ТекстРесурсыРегистра = "", "", ",
					|	") + "Т." + ПолеРегистра.Имя;
				ТекстРесурсыРегистраСМинусом = ТекстРесурсыРегистраСМинусом + ?(ТекстРесурсыРегистраСМинусом = "", "", ",
					|	") + "-Т." + ПолеРегистра.Имя;
				ТекстОстаткиРесурсовРегистра = ТекстОстаткиРесурсовРегистра + ?(ТекстОстаткиРесурсовРегистра = "", "", ",
					|	") + "Т." + ПолеРегистра.Имя + "Остаток КАК " + ПолеРегистра.Имя;
				ТекстОтборРесурсыРегистра = ТекстОтборРесурсыРегистра + ?(ТекстОтборРесурсыРегистра = "", "", "
					|	ИЛИ ") + "СУММА(Т." + ПолеРегистра.Имя + ") <> 0";
			КонецЦикла;

			Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонТекстаЗапроса,
				ИмяРегистра, // 1
				ТекстИзмеренияРегистра, // 2
				ТекстРесурсыРегистра, // 3
				ТекстРесурсыРегистраСМинусом, // 4
				ТекстОстаткиРесурсовРегистра, // 5
				ТекстОтборРесурсыРегистра); // 6
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Если НЕ РезультатЗапроса.Пустой() Тогда
				
				// Очистим остатки регистра
				Выборка = РезультатЗапроса.Выбрать();
				
				УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
					Выборка,
					РегистрыНакопления[ИмяРегистра],
					ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
				
				ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
					ПараметрыРасчета,
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru='Сформировано движений сторнирования остатков по регистру %1: %2'"),
						ИмяРегистра,
						ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
				
			КонецЕсли;
			
			УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
				"ВТОстаткиПартий, ВТИзменившиесяДокументы");
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Очистим движения партионных регистров версии 2.1, которые больше не используются в партионном учете версии 2.2.
	ШаблонТекстаЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ИЗ
	|	РегистрНакопления.%1 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И ((&НачалоПериода = &ДатаПереходаНаПартионныйУчетВерсии22
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров)
	|	  ИЛИ (&НачалоПериода > &ДатаПереходаНаПартионныйУчетВерсии22))";
	
	Для Каждого КлючИЗначение Из НеиспользуемыеДанныеМеханизмаВерсии21() Цикл
		
		ИмяРегистра = КлючИЗначение.Ключ.Имя;
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонТекстаЗапроса, ИмяРегистра);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Количество() > 0 Тогда
			
			// Очистим движения
			УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
				Выборка,
				РегистрыНакопления[ИмяРегистра],
				ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
			ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
				ПараметрыРасчета,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru='Очищено устаревших движений по регистру %1: %2'"),
					ИмяРегистра,
					ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
			
		КонецЕсли;
		
	КонецЦикла;
	
	//++ НЕ УТ
	
	// Очистим движения документа РаспределениеПрочихЗатрат по регистру ПрочиеРасходы, сформированные партионным учетом версии 2.1.
	// В партионном учете версии 2.2 все движения этого документа по этому регистру формируются механизмом расчета себестоимости.
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
	|	И НЕ Т.РасчетСебестоимости";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ОписаниеРегистра = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя];
		
		Выборка = РезультатЗапроса.Выбрать();
		
		УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ОписаниеРегистра.МенеджерРегистра,
			ПараметрыРасчета.ОграниченияВыборки.КоличествоЗаписейВНЗ);
			
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Очищено устаревших движений по регистру %1: %2'"),
				ОписаниеРегистра.ИмяРегистра,
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Количество())));
			
		ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
		
	КонецЕсли;
	
	//-- НЕ УТ
КонецПроцедуры

#КонецОбласти

//++ НЕ УТ

#Область ПроцедурыЭтапа1_РаспределениеТрудозатрат

// Инициализация данных

Функция ПоляПотребленийРаспределенияТрудозатрат(ПараметрыРасчета)
	
	Возврат "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияТрудозатрат(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийРаспределенияТрудозатрат(ПараметрыРасчета);
	
	// МаршрутныйЛист <- (Остаток, Партия, ПолуфабрикатДавальца)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.МаршрутныйЛист, 		 	ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.МаршрутныйЛист,
		Перечисления.ТипыЗаписейПартий.Остаток,				 	ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.МаршрутныйЛист,
		Перечисления.ТипыЗаписейПартий.Партия,				 	ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.МаршрутныйЛист,
		Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца, 	ПоляПотреблений);
	
	// ПолуфабрикатДавальца <- (Выпуск)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца, 	"Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца,
		Перечисления.ТипыЗаписейПартий.Выпуск, 				 	"Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	// Выпуск <- (МаршрутныйЛист)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск, 		   			"Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.МаршрутныйЛист, 			"Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
		
	// Потребление <- (ОстатокБезЗаказа, ПартияБезЗаказа)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, 	 		"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ОстатокБезЗаказа, 		"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПартияБезЗаказа,  		"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	
	// ПотреблениеАвто <- (Распределение)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,			"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Распределение, 	 		"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
		
	// Распределение <- (ПартияБезЗаказа)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение,			"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПартияБезЗаказа, 		"Организация, Подразделение, ВидРабот, ВидФондаВзносов");
		
	// Перемещение <- (Потребление, ПотреблениеАвто)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение,				"Регистратор, ПартияПроизводства, АналитикаУчетаПартийПроизводства");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.Потребление, 			"Регистратор, ПартияПроизводства, АналитикаУчетаПартийПроизводства, КорРазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,			"Регистратор, ПартияПроизводства, АналитикаУчетаПартийПроизводства, КорРазделУчета");
	
	// ВыпускБезЗаказа <- (Перемещение)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВыпускБезЗаказа,			"ДокументВыпуска, КодСтроки, ПартияПроизводства, АналитикаУчетаПартийПроизводства");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВыпускБезЗаказа,
		Перечисления.ТипыЗаписейПартий.Перемещение, 			"ДокументВыпуска, КодСтроки, ПартияПроизводства, АналитикаУчетаПартийПроизводства");
		
	// ОтчетДавальцу <- (Выпуск, ВыпускБезЗаказа)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОтчетДавальцу,			"Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОтчетДавальцу,
		Перечисления.ТипыЗаписейПартий.Выпуск, 					"Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОтчетДавальцу,
		Перечисления.ТипыЗаписейПартий.ВыпускБезЗаказа, 		"Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	// Трудозатраты <- Расчетное
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Трудозатраты, "ПартияПроизводства, АналитикаУчетаПартийПроизводства");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Трудозатраты,
		Перечисления.ТипыЗаписейПартий.Расчетное, "ПартияПроизводства, АналитикаУчетаПартийПроизводства");
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияТрудозатрат(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияТрудозатрат(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеТрудозатрат", // Контекст
		Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства.Имя, // ИмяРегистра
		ПереченьПолей(КолонкиТаблицыРаспределения), // ПоляРасчета
		ПоляПотребленийРаспределенияТрудозатрат(ПараметрыРасчета), // КлючиСравнения
		"Количество, НормативнаяСтоимость, Стоимость, СтоимостьРегл", // Показатели
		"Знаменатель", // БазисПрихода
		"Знаменатель", // БазисРасхода
		"ДокументИсточник", // КлючРасхода
		"Период", // ПолеПорядка
		"ГруппаПродукции"); // ПоляСортировки
		
	ОписаниеДвижений.Вставить("ПоляСуммирования", "Количество, НормативнаяСтоимость, Стоимость, СтоимостьРегл");
	ОписаниеДвижений.Вставить("ПоляГруппировки", ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийТрудозатрат(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток, 				Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.МаршрутныйЛист, 		Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокБезЗаказа, 	Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, 				Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПартияБезЗаказа, 		Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Распределение, 		Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Расчетное,			Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца, Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	НезаписываемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияТрудозатрат(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляТрудозатратНЗП());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияТрудозатрат(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		//++ НЕ УТКА
		+ ТекстРаспределениеПроизводственныхЗатратИнициализация()// вт Этапы, ПартииПроизводства, ПартииПроизводстваСводно, ПродолжающиесяПартии, Продукция, ДолиВыпуска
		//-- НЕ УТКА
		+ ТекстТрудозатратыНЗПИнициализация() // вт НачальныеОстаткиТрудозатратНЗП, РаботыДляДавальца, ВыпускиБезЗаказов, ВтВидыФондов, ПриходыБезЗаказов, КРаспределению, ОстаткиБезЗаказов, ТрудозатратыПоЭтапам, ОстаткиВидовРаботПоЭтапам, ПланФактТрудозатратПоЭтапам, втСписаноВПрошлыхМесяцах, втРасчетноеКоличество, Расчетное
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляТрудозатратНЗП() // вт Данные
		+ ТекстОбъединениеЗапросов() + ТекстОстаткиТрудозатратБезЗаказов()
		+ ТекстОбъединениеЗапросов() + ТекстПервичныеТрудозатратыБезЗаказов()
		//++ НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстОстаткиТрудозатратНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстПервичныеТрудозатратыНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыМаршрутныеЛисты()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыВыпускиПоЗаказам()
		//-- НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПотребление()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПотреблениеАвто()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПеремещение()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовРаспределение()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыВыпускиБезЗаказов()
		//++ НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПотребление2_2()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПотреблениеАвто2_2()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыБезЗаказовПеремещение2_2()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыВыпускиБезЗаказов2_2()
		+ ТекстОбъединениеЗапросов() + ТекстТрудозатратыКРаспределению2_2()
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеТрудозатратПоПродукции2_2()
		//-- НЕ УТКА
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Знаменатель, КоличествоПродукции, Количество, НормативнаяСтоимость, Стоимость, СтоимостьРегл", // ресурсы
		"Организация, Период, Регистратор, Приоритет"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"НачальныеОстаткиТрудозатратНЗП, РаботыДляДавальца, ВтВидыФондов, АналитикиПартийПроизводства,
		//++ НЕ УТКА
		|Этапы, ПартииПроизводства, ПартииПроизводстваСводно, ПродолжающиесяПартии, втПродукция, втДолиИтог, Продукция, ДолиВыпуска,
		|ЗаказыКРаспределению, ДолиСтоимости, ТрудозатратыПоЭтапам, ОстаткиВидовРаботПоЭтапам, ПланФактТрудозатратПоЭтапам,
		|втСписаноВПрошлыхМесяцах, втРасчетноеКоличество, Расчетное,
		//-- НЕ УТКА
		|ВыпускиБезЗаказов, ПриходыБезЗаказов, КРаспределению, ОстаткиБезЗаказов");
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляТрудозатратНЗП()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80))			  				 			 КАК ЗапросИсточник,
		|	0 													  				 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) 				 КАК ТипЗаписи,
		|	ЛОЖЬ 												  				 КАК РасчетЗавершен,
		|
		|	ДД.ВидДвижения 				  				 						 КАК ВидДвижения,
		|	ДД.Период 										 					 КАК Период,
		|	ДД.Регистратор 														 КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация 														 КАК Организация,
		|	ДД.Подразделение 													 КАК Подразделение,
		|	ДД.ПартияПроизводства												 КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства									 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство 												 КАК ЗаказНаПроизводство,
		|	0 																	 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов 													 КАК ВидФондаВзносов,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)				 КАК Спецификация,
		|	ДД.Этап 															 КАК Этап,
		|	ДД.СтатьяКалькуляции					 							 КАК СтатьяКалькуляции,
		|	ДД.ВидРабот 														 КАК ВидРабот,
		|	ДД.ГруппаПродукции 													 КАК ГруппаПродукции,
		|	0 													 				 КАК Знаменатель,
		|	ДД.КоличествоПродукции								 				 КАК КоличествоПродукции,
		|	ДД.Количество										 				 КАК Количество,
		|	ДД.НормативнаяСтоимость								 				 КАК НормативнаяСтоимость,
		|	ДД.Стоимость										 				 КАК Стоимость,
		|	ДД.СтоимостьРегл									 				 КАК СтоимостьРегл,
		|	ЛОЖЬ 													 			 КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)			 КАК ХозяйственнаяОперация,
		|	ДД.Сотрудник 												 		 КАК Сотрудник,
		|	ДД.КорАналитикаУчетаПродукции 										 КАК КорАналитикаУчетаПродукции,
		|	ДД.КорРазделУчета 												 	 КАК КорРазделУчета,
		|	ДД.КорВидЗапасовПродукции 											 КАК КорВидЗапасовПродукции,
		|	ДД.СтатьяКалькуляцииБезЗаказа 										 КАК СтатьяКалькуляцииБезЗаказа,
		|	ДД.ДокументВыпуска 												 	 КАК ДокументВыпуска,
		|	0 												 					 КАК КодСтроки,
		|	ДД.Регистратор 												 		 КАК ДокументИсточник,
		|	ДД.Продукция 												 		 КАК Продукция,
		|	ДД.ХарактеристикаПродукции 											 КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) 						 КАК Назначение
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

// вт НачальныеОстаткиТрудозатратНЗП, РаботыДляДавальца, ЗаказыКРаспределению, ВтВидыФондов, ДолиСтоимости, ВыпускиБезЗаказов, ПриходыБезЗаказов,
// КРаспределению, ОстаткиБезЗаказов, ТрудозатратыПоЭтапам, ОстаткиВидовРаботПоЭтапам, ПланФактТрудозатратПоЭтапам, втСписаноВПрошлыхМесяцах, втРасчетноеКоличество, Расчетное
// 
Функция ТекстТрудозатратыНЗПИнициализация() 
	Возврат
		"ВЫБРАТЬ
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.ПартияПроизводства,
		|	Т.ЗаказНаПроизводство,
		|	Т.КодСтрокиПродукция,
		|	Т.Этап,
		|	Т.СтатьяКалькуляции,
		|	Т.ВидРабот,
		|	Т.ГруппаПродукции,
		|	Т.ВидФондаВзносов,
		|	Т.КоличествоОстаток,
		|	Т.НормативнаяСтоимостьОстаток,
		|	Т.СтоимостьОстаток,
		|	Т.СтоимостьРеглОстаток
		|ПОМЕСТИТЬ НачальныеОстаткиТрудозатратНЗП
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(&ГраницаНачалоПериода, Организация В (&МассивОрганизаций)) КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ИСТИНА КАК РаботаДляДавальца
		|ПОМЕСТИТЬ
		|	РаботыДляДавальца
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|	И ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|	И ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|;
		|////////////////////////////////////////////////////////////////////////////
		//++ НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Распоряжение
		|ПОМЕСТИТЬ ЗаказыКРаспределениюПредварительная
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции.ОстаткиИОбороты(&НачалоПериода, &КонецПериода) КАК Т
		|ГДЕ
		|	Т.ЗаказаноПриход <> 0
		|	ИЛИ Т.ЗаказаноКонечныйОстаток <> 0
	    |
		|ИНДЕКСИРОВАТЬ ПО
		|	Т.Распоряжение
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	МаршрутныйЛист.Распоряжение КАК Заказ,
		|	МаршрутныйЛист.КодСтроки КАК КодСтроки
		|ПОМЕСТИТЬ ЗаказыКРаспределению
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределениюПредварительная КАК Т
		|		ПО МаршрутныйЛист.Ссылка = Т.Распоряжение
		|ГДЕ
		|	МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|;
		|////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ЗаказыКРаспределениюПредварительная
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК ДоляСтоимости
		|ПОМЕСТИТЬ ДолиСтоимости
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределению КАК Заказы
		|		ПО Заказы.Заказ = МаршрутныйЛист.Распоряжение
		|			И Заказы.КодСтроки = МаршрутныйЛист.КодСтроки
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец
		|;
		|////////////////////////////////////////////////////////////////////////////
		//-- НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ВидФондаВзносов КАК ВидФондаВзносов
		|ПОМЕСТИТЬ ВтВидыФондов
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КодСтрокиПродукция = 0
		|	И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Ссылка,
		|	ДД.Организация КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	СУММА(Выходы.Количество) КАК Количество,
		|	СУММА(Выходы.ДоляСтоимости) КАК ДоляСтоимости
		|ПОМЕСТИТЬ ВыпускиБезЗаказов
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	ДД.Организация
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Ссылка,
		|	ДД.Организация КАК Организация,
		|	ДД.Ссылка КАК ПартияПроизводства,
		|	Выходы.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	СУММА(Выходы.Количество) КАК Количество,
		|	СУММА(Выходы.ДоляСтоимости) КАК ДоляСтоимости
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И НЕ ДД.РаспоряжениеДляТрудозатрат
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Выходы.АналитикаУчетаПартийПроизводства
		//-- НЕ УТКА
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.КоличествоОстаток КАК Знаменатель
		|ПОМЕСТИТЬ ОстаткиБезЗаказов
		|ИЗ
		|	НачальныеОстаткиТрудозатратНЗП КАК ДД
		//++ НЕ УТКА
		|ГДЕ
		|	ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		|	И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		//-- НЕ УТКА
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыБезЗаказов
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		//++ НЕ УТКА
		|	И ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		|	И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		//-- НЕ УТКА
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Распределено) КАК Распределено
		|ПОМЕСТИТЬ КРаспределению
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.Подразделение,
		|		ДД.ВидРабот,
		|		ДД.ГруппаПродукции,
		|		ДД.Знаменатель КАК Количество,
		|		0 КАК Распределено
		|	ИЗ
		|		ОстаткиБезЗаказов КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.Подразделение,
		|		ДД.ВидРабот,
		|		ДД.ГруппаПродукции,
		|		ДД.Количество КАК Количество,
		|		0 КАК Распределено
		|	ИЗ
		|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ГДЕ
		|		ДД.СлужебноеВидДвиженияПриход
		//++ НЕ УТКА
		|		И (ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		|		ИЛИ ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО)
		|		И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ВидыРабот.Подразделение,
		|		ВидыРабот.ВидРабот,
		|		ИзделияПроизводстваБезЗаказов.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|		-ВидыРабот.Количество,
		|		ВидыРабот.Количество КАК Распределено
		|	ИЗ
		|		Документ.ПроизводствоБезЗаказа КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.Трудозатраты КАК ВидыРабот
		|			ПО ВидыРабот.Ссылка = ДД.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделияПроизводстваБезЗаказов
		|			ПО ВыходныеИзделияПроизводстваБезЗаказов.ОсновноеИзделиеГруппыЗатрат
		|			И ВидыРабот.Ссылка = ВыходныеИзделияПроизводстваБезЗаказов.Ссылка
		|			И ВидыРабот.АналитикаУчетаПартийПроизводства = ВыходныеИзделияПроизводстваБезЗаказов.АналитикаУчетаПартийПроизводства
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ИзделияПроизводстваБезЗаказов
		|			ПО ИзделияПроизводстваБезЗаказов.Ссылка = ВыходныеИзделияПроизводстваБезЗаказов.Номенклатура
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|		И НЕ ДД.РаспоряжениеДляТрудозатрат
		//-- НЕ УТКА
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ВидыРабот.Подразделение,
		|		ВидыРабот.ВидРабот,
		|		ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|		-ВидыРабот.Количество,
		|		ВидыРабот.Количество КАК Распределено
		|	ИЗ
		|		Документ.СписаниеЗатратНаВыпуск КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|			ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ВидыРабот.Подразделение,
		|		ВидыРабот.ВидРабот,
		|		ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|		-ВидыРабот.Количество,
		|		0 КАК Распределено
		|	ИЗ
		|		Документ.ИзделияИЗатратыНЗП КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ИзделияИЗатратыНЗП.Трудозатраты КАК ВидыРабот
		|			ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции
		|
		|ИМЕЮЩИЕ
		|	СУММА(ДД.Количество) > 0
		//++ НЕ УТКА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТрудозатратыПоЭтапам.Организация,
		|	ТрудозатратыПоЭтапам.Подразделение,
		|	ТрудозатратыПоЭтапам.ПартияПроизводства,
		|	ТрудозатратыПоЭтапам.АналитикаУчетаПартийПроизводства,
		|	ТрудозатратыПоЭтапам.СтатьяКалькуляции,
		|	ТрудозатратыПоЭтапам.ВидРабот,
		|	ТрудозатратыПоЭтапам.ГруппаПродукции,
		|	ТрудозатратыПоЭтапам.ВидФондаВзносов,
		|	СУММА(ТрудозатратыПоЭтапам.Количество) КАК Количество,
		|	СУММА(ТрудозатратыПоЭтапам.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ТрудозатратыПоЭтапам.Стоимость) КАК Стоимость,
		|	СУММА(ТрудозатратыПоЭтапам.СтоимостьРегл) КАК СтоимостьРегл
		|ПОМЕСТИТЬ ТрудозатратыПоЭтапам
		|ИЗ
		|	(ВЫБРАТЬ
		|		НачальныеОстаткиТрудозатратНЗП.Организация КАК Организация,
		|		НачальныеОстаткиТрудозатратНЗП.Подразделение КАК Подразделение,
		|		НачальныеОстаткиТрудозатратНЗП.ПартияПроизводства КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		НачальныеОстаткиТрудозатратНЗП.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|		НачальныеОстаткиТрудозатратНЗП.ВидРабот КАК ВидРабот,
		|		НачальныеОстаткиТрудозатратНЗП.ГруппаПродукции КАК ГруппаПродукции,
		|		НачальныеОстаткиТрудозатратНЗП.ВидФондаВзносов КАК ВидФондаВзносов,
		|		НачальныеОстаткиТрудозатратНЗП.КоличествоОстаток КАК Количество,
		|		НачальныеОстаткиТрудозатратНЗП.НормативнаяСтоимостьОстаток КАК НормативнаяСтоимость,
		|		НачальныеОстаткиТрудозатратНЗП.СтоимостьОстаток КАК Стоимость,
		|		НачальныеОстаткиТрудозатратНЗП.СтоимостьРеглОстаток КАК СтоимостьРегл
		|	ИЗ
		|		НачальныеОстаткиТрудозатратНЗП КАК НачальныеОстаткиТрудозатратНЗП
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводстваСводно КАК Партии
		|			ПО НачальныеОстаткиТрудозатратНЗП.ПартияПроизводства = Партии.ПартияПроизводства
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.Подразделение,
		|		ДД.ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства,
		|		ДД.СтатьяКалькуляции,
		|		ДД.ВидРабот,
		|		ДД.ГруппаПродукции,
		|		ДД.ВидФондаВзносов,
		|		ДД.Количество,
		|		ДД.НормативнаяСтоимость,
		|		ДД.Стоимость,
		|		ДД.СтоимостьРегл
		|	ИЗ
		|		РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводстваСводно КАК Партии
		|			ПО ДД.ПартияПроизводства = Партии.ПартияПроизводства
		|			И ДД.АналитикаУчетаПартийПроизводства = Партии.АналитикаУчетаПартийПроизводства
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.Организация В(&МассивОрганизаций)) КАК ТрудозатратыПоЭтапам
		|
		|СГРУППИРОВАТЬ ПО
		|	ТрудозатратыПоЭтапам.ПартияПроизводства,
		|	ТрудозатратыПоЭтапам.АналитикаУчетаПартийПроизводства,
		|	ТрудозатратыПоЭтапам.Организация,
		|	ТрудозатратыПоЭтапам.СтатьяКалькуляции,
		|	ТрудозатратыПоЭтапам.ВидФондаВзносов,
		|	ТрудозатратыПоЭтапам.ГруппаПродукции,
		|	ТрудозатратыПоЭтапам.ВидРабот,
		|	ТрудозатратыПоЭтапам.Подразделение
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ВидРабот,
		|	ДД.СтатьяКалькуляции,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ОстаткиВидовРаботПоЭтапам
		|ИЗ
		|	ТрудозатратыПоЭтапам КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументЭтап.Организация КАК Организация,
		|	ДокументЭтап.Подразделение КАК Подразделение,
		|	ДД.ПартияПроизводства КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	ВидыРабот.ВидРабот КАК ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|	СУММА(ВидыРабот.Количество) КАК План,
		|	СУММА(ВЫБОР
		|			КОГДА ВидыРабот.Выполнено И ВидыРабот.ДатаВыполнения < &КонецПериода
		|				ТОГДА ВидыРабот.Количество
		|			ИНАЧЕ 0
		|	КОНЕЦ) КАК Факт
		|ПОМЕСТИТЬ ПланФактТрудозатратПоЭтапам
		|ИЗ
		|	ПартииПроизводстваСводно КАК ДД
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтап
		|		ПО ДД.ПартияПроизводства = ДокументЭтап.ВыпускающийЭтап
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.Трудозатраты КАК ВидыРабот
		|		ПО ДокументЭтап.Ссылка = ВидыРабот.Ссылка
		|ГДЕ
		|	ВидыРабот.ДатаВыполнения < &КонецПериода
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДокументЭтап.Организация,
		|	ДокументЭтап.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПроизводствоБезЗаказа.Организация КАК Организация,
		|	ВидыРабот.Подразделение КАК Подразделение,
		|	ДД.ПартияПроизводства КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	ВидыРабот.ВидРабот КАК ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|	СУММА(ВидыРабот.Количество) КАК План,
		|	СУММА(ВидыРабот.Количество) КАК Факт
		|ИЗ
		|	ПартииПроизводства КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.Трудозатраты КАК ВидыРабот
		|		ПО ДД.ПартияПроизводства = ВидыРабот.Ссылка
		|		И ДД.АналитикаУчетаПартийПроизводства = ВидыРабот.АналитикаУчетаПартийПроизводства
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ПроизводствоБезЗаказа
		|		ПО ДД.ПартияПроизводства = ПроизводствоБезЗаказа.Ссылка
		|
		|ГДЕ
		|	ПроизводствоБезЗаказа.РаспоряжениеДляТрудозатрат
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ПроизводствоБезЗаказа.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Расходы.ПартияПроизводства,
		|	Расходы.Подразделение,
		|	Расходы.ВидРабот,
		|	Расходы.СтатьяКалькуляции,
		|	Расходы.КоличествоРасход
		|ПОМЕСТИТЬ втСписаноВПрошлыхМесяцахПредварительная
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Обороты(, &НачалоПериода, , ) КАК Расходы
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Расходы.ПартияПроизводства
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Расходы.ПартияПроизводства,
		|	Расходы.Подразделение,
		|	Расходы.ВидРабот,
		|	Расходы.СтатьяКалькуляции,
		|	Расходы.КоличествоРасход КАК Количество
		|ПОМЕСТИТЬ втСписаноВПрошлыхМесяцах
		|ИЗ
		|	ПартииПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втСписаноВПрошлыхМесяцахПредварительная КАК Расходы
		|		ПО ДД.ПартияПроизводства = Расходы.ПартияПроизводства
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ втСписаноВПрошлыхМесяцахПредварительная
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.СтатьяКалькуляции,
		|	ВЫБОР
		|		КОГДА ДД.План > ДД.Факт
		|			ТОГДА ДД.План
		|		ИНАЧЕ ДД.Факт
		|	КОНЕЦ * ДолиВыпуска.ДоляВыпускаВсего - ЕСТЬNULL(Списано.Количество, 0) КАК РасчетноеКоличество,
		|	ДолиВыпуска.ПроизводствоЗавершено
		|ПОМЕСТИТЬ втРасчетноеКоличество
		|ИЗ
		|	ПланФактТрудозатратПоЭтапам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиВыпуска КАК ДолиВыпуска
		|		ПО ДД.ПартияПроизводства = ДолиВыпуска.ПартияПроизводства
		|		И ДД.АналитикаУчетаПартийПроизводства = ДолиВыпуска.АналитикаУчетаПартийПроизводства
		|		ЛЕВОЕ СОЕДИНЕНИЕ втСписаноВПрошлыхМесяцах КАК Списано
		|		ПО ДД.ПартияПроизводства = Списано.ПартияПроизводства
		|			И ДД.Подразделение = Списано.Подразделение
		|			И ДД.ВидРабот = Списано.ВидРабот
		|			И ДД.СтатьяКалькуляции = Списано.СтатьяКалькуляции
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.СтатьяКалькуляции,
		|	Остатки.Количество КАК Количество,
		|	ВЫБОР
		|		КОГДА ДД.ПроизводствоЗавершено
		|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
		|		КОГДА ДД.РасчетноеКоличество > ЕСТЬNULL(Остатки.Количество, 0)
		|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
		|		ИНАЧЕ ДД.РасчетноеКоличество
		|	КОНЕЦ КАК РасчетноеКоличество
		|ПОМЕСТИТЬ Расчетное
		|ИЗ
		|	втРасчетноеКоличество КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиВидовРаботПоЭтапам КАК Остатки
		|		ПО ДД.ПартияПроизводства = Остатки.ПартияПроизводства
		|			И ДД.АналитикаУчетаПартийПроизводства = Остатки.АналитикаУчетаПартийПроизводства
		|			И ДД.Подразделение = Остатки.Подразделение
		|			И ДД.ВидРабот = Остатки.ВидРабот
		|			И ДД.СтатьяКалькуляции = Остатки.СтатьяКалькуляции
		|ГДЕ
		|	ВЫБОР
		|		КОГДА ДД.ПроизводствоЗавершено
		|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
		|		КОГДА ДД.РасчетноеКоличество > ЕСТЬNULL(Остатки.Количество, 0)
		|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
		|		ИНАЧЕ ДД.РасчетноеКоличество
		|	КОНЕЦ > 0
		//-- НЕ УТКА
		|";
КонецФункции

// ... выборки данных

Функция ТекстОстаткиТрудозатратБезЗаказов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстОстаткиТрудозатратБезЗаказов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокБезЗаказа) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Остатки.Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.НормативнаяСтоимостьОстаток КАК НормативнаяСтоимость,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	НачальныеОстаткиТрудозатратНЗП КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиБезЗаказов КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.Подразделение = ДД.Подразделение
		|		И Остатки.ВидРабот = ДД.ВидРабот
		|		И Остатки.ГруппаПродукции = ДД.ГруппаПродукции
		//++ НЕ УТКА
		|ГДЕ
		|	ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		|	И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		//-- НЕ УТКА
		|";
КонецФункции

Функция ТекстПервичныеТрудозатратыБезЗаказов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПервичныеТрудозатратыБезЗаказов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПартияБезЗаказа) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Приходы.Количество КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ДД.СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыБезЗаказов КАК Приходы
		|		ПО Приходы.Организация = ДД.Организация
		|		И Приходы.Подразделение = ДД.Подразделение
		|		И Приходы.ВидРабот = ДД.ВидРабот
		|		И Приходы.ГруппаПродукции = ДД.ГруппаПродукции
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.КодСтрокиПродукция = 0
		|	И ДД.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидФондаВзносов,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Приходы.Количество,
		|	ДД.СтатьяКалькуляцииБезЗаказа
		|";
КонецФункции

//++ НЕ УТКА
Функция ТекстОстаткиТрудозатратНЗП()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстОстаткиТрудозатратНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.НормативнаяСтоимостьОстаток КАК НормативнаяСтоимость,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	НачальныеОстаткиТрудозатратНЗП КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.КодСтрокиПродукция > 0
		|";
КонецФункции

Функция ТекстПервичныеТрудозатратыНЗП()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПервичныеТрудозатратыНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.КодСтрокиПродукция > 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.Сотрудник
		|";
КонецФункции

Функция ТекстТрудозатратыМаршрутныеЛисты()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыМаршрутныеЛисты"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.МаршрутныйЛист) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	МаршрутныйЛист.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	(ВЫБОР
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ) КАК ГруппаПродукции,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиЗаказа
		|		ПО СтрокиЗаказа.Ссылка = МаршрутныйЛист.Распоряжение
		|		И СтрокиЗаказа.КодСтроки = МаршрутныйЛист.КодСтроки
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ПродукцияЗаказа
		|		ПО ПродукцияЗаказа.Ссылка = СтрокиЗаказа.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	(ВЫБОР
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

Функция ТекстТрудозатратыВыпускиПоЗаказам()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыВыпускиПоЗаказам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	МаршрутныйЛист.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Заказано) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	(ВЫБОР КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	Аналитика.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = МаршрутныйЛист.Назначение
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Аналитика.Назначение,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	(ВЫБОР КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции
//-- НЕ УТКА

Функция ТекстТрудозатратыБезЗаказовПотребление()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПотребление"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА 1
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ДД.Номенклатура
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПотреблениеАвто()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПотреблениеАвто"" КАК ЗапросИсточник,
		|	45 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА 1
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ДД.Номенклатура
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПеремещение()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПеремещение"" КАК ЗапросИсточник,
		|	60 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО  КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО  КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ВЫБОР Выходы.ДоляСтоимости
		|			КОГДА 0
		|				ТОГДА 1
		|			ИНАЧЕ Выходы.ДоляСтоимости
		|	КОНЕЦ) КАК Знаменатель,
		|	СУММА(Выходы.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	Выходы.Распоряжение КАК ДокументВыпуска,
		|	Выходы.КодСтроки КАК КодСтроки,
		|	Выходы.Распоряжение КАК ДокументИсточник,
		|	Выходы.Номенклатура КАК Продукция,
		|	Выходы.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Выходы.Номенклатура,
		|	Выходы.Характеристика,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовРаспределение()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовРаспределение"" КАК ЗапросИсточник,
		|	50 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&КонецПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.Количество КАК Знаменатель,
		|	ДД.Распределено КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	КРаспределению КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ДД.Подразделение
		|		И ВтВидыФондов.ВидРабот = ДД.ВидРабот
		|ГДЕ
		|	ДД.Распределено <> 0
		|";
КонецФункции

Функция ТекстТрудозатратыВыпускиБезЗаказов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыВыпускиБезЗаказов"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВыпускБезЗаказа) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ЕСТЬNULL(РаботыДляДавальца.АналитикаУчетаНоменклатуры, ДД.АналитикаУчетаПродукции) КАК КорАналитикаУчетаПродукции,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК КорРазделУчета,
		|	ЕСТЬNULL(РаботыДляДавальца.ВидЗапасов, ДД.КорВидЗапасов) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.КодСтроки КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	ДД.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаСписаниеПоНормативам КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = ДД.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
		|		ПО РаботыДляДавальца.Регистратор = ДД.Регистратор
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаПродукции
		|			И РаботыДляДавальца.КорВидЗапасов = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	РаботыДляДавальца.ВидЗапасов,
		|	РаботыДляДавальца.АналитикаУчетаНоменклатуры,
		|	ДД.Назначение,
		|	ДД.КодСтроки,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ,
		|	ДД.КодСтроки,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика
		|";
КонецФункции

//++ НЕ УТКА
Функция ТекстТрудозатратыБезЗаказовПотребление2_2()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПотребление2_2"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ДД.Ссылка КАК ПартияПроизводства,
		|	ВидыРабот.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА Выпуски.Количество
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|		И Выпуски.АналитикаУчетаПартийПроизводства = ВидыРабот.АналитикаУчетаПартийПроизводства
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.АналитикаУчетаПартийПроизводства,
		|	ВидыРабот.ВидРабот,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ВидыРабот.СтатьяКалькуляции
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПотреблениеАвто2_2()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПотребление2_2"" КАК ЗапросИсточник,
		|	45 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ДД.Ссылка КАК ПартияПроизводства,
		|	ВидыРабот.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА Выпуски.Количество
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|		И Выпуски.АналитикаУчетаПартийПроизводства = ВидыРабот.АналитикаУчетаПартийПроизводства
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.АналитикаУчетаПартийПроизводства,
		|	ВидыРабот.ВидРабот,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ВидыРабот.СтатьяКалькуляции
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПеремещение2_2()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыБезЗаказовПеремещение2_2"" КАК ЗапросИсточник,
		|	50 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	Выпуски.ПартияПроизводства.Дата КАК Период,
		|	Выпуски.ПартияПроизводства КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
		|	Выпуски.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	Выпуски.ПартияПроизводства КАК ПартияПроизводства,
		|	Выпуски.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА Выпуски.Количество
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК Знаменатель,
		|	СУММА(ВЫБОР Выпуски.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА Выпуски.Количество
		|				ИНАЧЕ Выпуски.ДоляСтоимости
		|	КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	ВыпускиБезЗаказов КАК Выпуски
		|ГДЕ
		|	НЕ Выпуски.ПартияПроизводства = НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	Выпуски.ПартияПроизводства,
		|	Выпуски.ПартияПроизводства.Дата,
		|	Выпуски.Организация,
		|	Выпуски.АналитикаУчетаПартийПроизводства
		|";
КонецФункции

Функция ТекстТрудозатратыВыпускиБезЗаказов2_2()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыВыпускиБезЗаказов2_2"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВыпускБезЗаказа) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.ПартияПроизводства.Дата КАК Период,
		|	ДД.ПартияПроизводства КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ДД.ПартияПроизводства КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ВЫБОР ДД.ДоляСтоимости
		|				КОГДА 0
		|					ТОГДА ДД.КоличествоПродукции
		|				ИНАЧЕ ДД.ДоляСтоимости
		|	КОНЕЦ КАК Знаменатель,
		|	ДД.КоличествоПродукции КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ЕСТЬNULL(РаботыДляДавальца.АналитикаУчетаНоменклатуры, ДД.АналитикаУчетаНоменклатуры) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	ЕСТЬNULL(РаботыДляДавальца.ВидЗапасов, ДД.ВидЗапасов) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Продукция КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ПроизводствоБезЗаказа
		|		ПО ПроизводствоБезЗаказа.Ссылка = ДД.ПартияПроизводства
		|		ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
		|		ПО РаботыДляДавальца.Регистратор = ДД.ПартияПроизводства
		|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И РаботыДляДавальца.КорВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ТИПЗНАЧЕНИЯ(ДД.ПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
		|	И НЕ ПроизводствоБезЗаказа.РаспоряжениеДляТрудозатрат";
КонецФункции

Функция ТекстТрудозатратыКРаспределению2_2() // использует ОстаткиТрудозатрат
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТрудозатратыКРаспределению2_2"" КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&КонецПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.ПартияПроизводства КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|	ДД.ВидРабот КАК ВидРабот,
		|	ДД.ГруппаПродукции КАК ГруппаПродукции,
		|	Итог.ДоляВыпускаМесяца КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ВЫБОР
		|		КОГДА ДД.ВидФондаВзносов = ЗНАЧЕНИЕ(Перечисление.ВидыФондовВзносов.ПустаяСсылка)
		|			ТОГДА Расчетное.РасчетноеКоличество
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Количество,
		|	ДД.НормативнаяСтоимость * Расчетное.РасчетноеКоличество / Расчетное.Количество КАК НормативнаяСтоимость,
		|	ДД.Стоимость * Расчетное.РасчетноеКоличество / Расчетное.Количество КАК Стоимость,
		|	ДД.СтоимостьРегл * Расчетное.РасчетноеКоличество / Расчетное.Количество КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	ТрудозатратыПоЭтапам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиВыпуска КАК Итог
		|		ПО ДД.ПартияПроизводства = Итог.ПартияПроизводства
		|		И ДД.АналитикаУчетаПартийПроизводства = Итог.АналитикаУчетаПартийПроизводства
		|		ЛЕВОЕ СОЕДИНЕНИЕ Расчетное КАК Расчетное
		|		ПО ДД.ПартияПроизводства = Расчетное.ПартияПроизводства
		|			И ДД.АналитикаУчетаПартийПроизводства = Расчетное.АналитикаУчетаПартийПроизводства
		|			И ДД.Подразделение = Расчетное.Подразделение
		|			И ДД.ВидРабот = Расчетное.ВидРабот
		|			И ДД.СтатьяКалькуляции = Расчетное.СтатьяКалькуляции";
КонецФункции

Функция ТекстРаспределениеТрудозатратПоПродукции2_2() // использует Продукция
	
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеТрудозатратПоПродукции2_2"" КАК ЗапросИсточник,
	|	0 КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Трудозатраты) КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	&КонецПериода КАК Период,
	|	ДД.ПартияПроизводства КАК Регистратор,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
	|	ДД.Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.ПартияПроизводства КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	0 КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	ДД.ДоляНаименованияМесяца КАК Знаменатель,
	|	ДД.КоличествоПродукции КАК КоличествоПродукции,
	|	0 КАК Количество,
	|	0 КАК НормативнаяСтоимость,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьРегл,
	|	ЛОЖЬ КАК Первичное,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
	|	ЕСТЬNULL(РаботыДляДавальца.АналитикаУчетаНоменклатуры, ДД.АналитикаУчетаНоменклатуры) КАК КорАналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
	|	ЕСТЬNULL(РаботыДляДавальца.ВидЗапасов, ДД.ВидЗапасов) КАК КорВидЗапасовПродукции,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	0 КАК КодСтроки,
	|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
	|	НЕОПРЕДЕЛЕНО КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК Назначение
	|ИЗ
	|	Продукция КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ПроизводствоБезЗаказа
	|		ПО ПроизводствоБезЗаказа.Ссылка = ДД.ПартияПроизводства
	|		ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО РаботыДляДавальца.Регистратор = ДД.ПартияПроизводства
	|			И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|			И РаботыДляДавальца.КорВидЗапасов = ДД.ВидЗапасов
	|	
	|ГДЕ
	|	(ТИПЗНАЧЕНИЯ(ДД.ПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|		ИЛИ ПроизводствоБезЗаказа.РаспоряжениеДляТрудозатрат)
	|	И ДД.ДоляНаименованияМесяца > 0
	|";
	
КонецФункции
//-- НЕ УТКА

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределениеТрудозатрат(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество 			 = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
	РасчетнаяПартия.НормативнаяСтоимость = Окр(ЗнаменательСписания * Приход.НормативнаяСтоимость / Приход.Знаменатель, 2);
	РасчетнаяПартия.Стоимость 			 = Окр(ЗнаменательСписания * Приход.Стоимость / Приход.Знаменатель, 2);
	РасчетнаяПартия.СтоимостьРегл 		 = Окр(ЗнаменательСписания * Приход.СтоимостьРегл / Приход.Знаменатель, 2);
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.МаршрутныйЛист
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление 
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПотреблениеАвто Тогда
	 
		РасчетнаяПартия.Знаменатель = Расход.КоличествоПродукции;
		
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.МаршрутныйЛист Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.МаршрутныйЛист Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОтчетДавальцу
	 И (Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	  ИЛИ Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ВыпускБезЗаказа) Тогда
		
	 	РасчетнаяПартия.ДокументВыпуска 	= Приход.ДокументВыпуска;
		РасчетнаяПартия.КодСтроки 			= Приход.КодСтроки;
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
		РасчетнаяПартия.КодСтрокиПродукция 	= Приход.КодСтрокиПродукция;
		РасчетнаяПартия.Этап 				= Приход.Этап;
		РасчетнаяПартия.СтатьяКалькуляции 	= Приход.СтатьяКалькуляции;
		
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление
		ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПотреблениеАвто Тогда
	
		РасчетнаяПартия.ПартияПроизводства					= Неопределено;
		РасчетнаяПартия.АналитикаУчетаПартийПроизводства	= Неопределено;
		РасчетнаяПартия.КорРазделУчета						= Неопределено;
		
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.Количество 			= Приход.Количество - РасчетнаяПартия.Количество;
	Приход.НормативнаяСтоимость = Приход.НормативнаяСтоимость - РасчетнаяПартия.НормативнаяСтоимость;
	Приход.Стоимость 			= Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьРегл 		= Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	Приход.Знаменатель 			= Приход.Знаменатель - ЗнаменательСписания;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление
		ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПотреблениеАвто Тогда
		Расход.Знаменатель = Расход.Знаменатель - ЗнаменательСписания;
	КонецЕсли;
	
	Если Расход.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.ОтчетДавальцу
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
		
	КонецЕсли;

	// Заполняем партионную идентификацию в расчетной партии
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ЗаказНаПроизводство)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.КодСтрокиПродукция)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Этап)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		
		РасчетнаяПартия.Этап = Приход.Этап;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
		
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Регистратор) Тогда
		
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.СтатьяКалькуляцииБезЗаказа) Тогда
		
		РасчетнаяПартия.СтатьяКалькуляцииБезЗаказа = Приход.СтатьяКалькуляцииБезЗаказа;
		
	КонецЕсли;
	
	РасчетнаяПартия.Подразделение 	  = Приход.Подразделение;
	РасчетнаяПартия.ВидФондаВзносов   = Приход.ВидФондаВзносов;
	РасчетнаяПартия.ВидРабот 		  = Приход.ВидРабот;
	РасчетнаяПартия.ГруппаПродукции   = Приход.ГруппаПродукции;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
		И РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство Тогда
		РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляцииБезЗаказа;
		РасчетнаяПартия.СтатьяКалькуляцииБезЗаказа = Неопределено;
	Иначе
		РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
	КонецЕсли;
	
	РасчетнаяПартия.РасчетЗавершен 	  = Приход.РасчетЗавершен;
	
КонецПроцедуры

#КонецОбласти

//-- НЕ УТ
//++ НЕ УТКА

#Область ПроцедурыЭтапа2_РаспределениеТоваровОрганизацийНаПроизводство

// Инициализация данных

Функция ПоляПотребленийРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	Возврат "Организация, АналитикаУчетаНоменклатуры";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений = ПоляПотребленийРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета);
	
	Партия                 = Перечисления.ТипыЗаписейПартий.Партия;
	Потребление            = Перечисления.ТипыЗаписейПартий.Потребление;
	
	// Потребление <- Партия
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, Потребление, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Потребление, Партия, ПоляПотреблений);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеТоваровОрганизацийНаПроизводство",
		Метаданные.РегистрыНакопления.ТоварыОрганизаций.Имя,
		ПереченьПолей(КолонкиТаблицыРаспределения),
		ПоляПотребленийРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета),
		"",
		"Количество",
		"Количество",
		"",
		"Период");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляРаспределенияТоваровОрганизацийНаПроизводство());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстТоварыОрганизацийНаПроизводствоИнициализация() // КРаспределению, Расходы, Регистраторы
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияТоваровОрганизацийНаПроизводство()
		+ ТекстОбъединениеЗапросов() + ТекстТоварыОрганизацийКРаспределениюНаПроизводство() // использует КРаспределению
		+ ТекстОбъединениеЗапросов() + ТекстПотреблениеТоваровОрганизацийНаПроизводство() // использует Расходы
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Количество", // ресурсы
		"АналитикаУчетаНоменклатуры, Порядок"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"Расходы, Регистраторы, Остатки, КРаспределению");
		
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияТоваровОрганизацийНаПроизводство()
	
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(80))                                           КАК ЗапросИсточник,
	|	0                                                                       КАК Порядок,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)                   КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	ДД.ХозяйственнаяОперация                                                КАК ХозяйственнаяОперация,
	|	ДД.ВидДвижения                                                          КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                           КАК АналитикаУчетаНоменклатуры,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.ВидЗапасов                                                           КАК ВидЗапасов,
	|	ДД.ВидЗапасов                                                           КАК КорВидЗапасов,
	|	ДД.НомерГТД                                                             КАК НомерГТД,
	|	ДД.Количество                                                           КАК Количество,
	|	ДД.ПартияПроизводства                                                   КАК ПартияПроизводства,
	|	ДД.КорАналитикаУчетаНоменклатуры                                        КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура                                                         КАК Номенклатура,
	|	ДД.Характеристика                                                       КАК Характеристика,
	|	ДД.НалогообложениеНДС                                                   КАК НалогообложениеНДС
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДД
	|";
	
КонецФункции

// ... формирования временные таблиц

// вт Остатки, КРаспределению, Расходы, Регистраторы
Функция ТекстТоварыОрганизацийНаПроизводствоИнициализация()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Реквизиты.Организация                     КАК Организация,
	|	ДД.ДатаРасхода                            КАК Период,
	|	Реквизиты.ВыпускающийЭтап                 КАК ПартияПроизводства,
	|	Реквизиты.ВыпускающийЭтап.ВыпускПодДеятельность КАК НалогообложениеНДС,
	|	Реквизиты.Ссылка                          КАК Регистратор,
	|	Реквизиты.Назначение                      КАК Назначение,
	|	ДД.АналитикаУчетаНоменклатуры             КАК АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура                           КАК Номенклатура,
	|	ДД.Характеристика                         КАК Характеристика,
	|	Аналитика.КлючАналитики                   КАК КорАналитикаУчетаНоменклатуры,
	|	СУММА(ДД.Количество)                      КАК Количество
	|ПОМЕСТИТЬ Расходы
	|ИЗ
	|	Документ.ЭтапПроизводства2_2.РасходМатериаловИРабот КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|		ПО ДД.Ссылка = Реквизиты.Ссылка
	|
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.Номенклатура = Аналитика.Номенклатура
	|		И ДД.Характеристика = Аналитика.Характеристика
	|		И Реквизиты.Подразделение = Аналитика.Склад
	|		И ДД.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
	|		И ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) = Аналитика.Серия
	|		И Реквизиты.Назначение = Аналитика.Назначение
	|
	|ГДЕ
	|	Реквизиты.Организация В(&МассивОрганизаций)
	|	И ДД.ДатаРасхода МЕЖДУ &НачалоПериода И &КонецПериода
	|
	|СГРУППИРОВАТЬ ПО
	|	Реквизиты.Организация,
	|	Реквизиты.ВыпускающийЭтап,
	|	Реквизиты.Ссылка,
	|	Реквизиты.Назначение,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.ДатаРасхода,
	|	Аналитика.КлючАналитики
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор,
	|	ДД.Назначение
	|ПОМЕСТИТЬ Регистраторы
	|ИЗ
	|	Расходы КАК ДД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	&КонецПериода                 КАК Период,
	|	ДД.Организация                КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                 КАК ВидЗапасов,
	|	ДД.НомерГТД                   КАК НомерГТД,
	|	ДД.КоличествоОстаток          КАК Количество
	|ПОМЕСТИТЬ Остатки
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(
	|			&ГраницаКонецПредыдущегоПериода,
	|			Организация В (&МассивОрганизаций)
	|				И АналитикаУчетаНоменклатуры.Назначение В (ВЫБРАТЬ Т.Назначение ИЗ Регистраторы КАК Т)) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&КонецПериода,
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.НомерГТД,
	|	ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДД.Количество ИНАЧЕ - ДД.Количество КОНЕЦ КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДД
	|	
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|	
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО Аналитика.Назначение = Регистраторы.Назначение
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|	И НЕ ДД.РасчетПартий
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Период                     КАК Период,
	|	ВЫБОР
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)) ТОГДА 0
	|		ИНАЧЕ 1 КОНЕЦ             КАК Порядок,
	|	ДД.Организация                КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                 КАК ВидЗапасов,
	|	ДД.НомерГТД                   КАК НомерГТД,
	|	СУММА(ДД.Количество)          КАК Количество
	|ПОМЕСТИТЬ КРаспределению
	|ИЗ
	|	Остатки КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.НомерГТД
	|
	|;";
	
	Возврат ТекстЗапроса
	
КонецФункции

// ... выборки данных

Функция ТекстТоварыОрганизацийКРаспределениюНаПроизводство() // использует КРаспределению
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстТоварыОрганизацийКРаспределениюНаПроизводство""                  КАК ЗапросИсточник,
	|	ДД.Порядок                                                              КАК Порядок,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)                         КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                           КАК АналитикаУчетаНоменклатуры,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.ВидЗапасов                                                           КАК ВидЗапасов,
	|	ДД.ВидЗапасов                                                           КАК КорВидЗапасов,
	|	ДД.НомерГТД                                                             КАК НомерГТД,
	|	ДД.Количество                                                           КАК Количество,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)                          КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Характеристика,
	|	НЕОПРЕДЕЛЕНО                                                            КАК НалогообложениеНДС
	|ИЗ
	|	КРаспределению КАК ДД
	|";
КонецФункции

Функция ТекстПотреблениеТоваровОрганизацийНаПроизводство() // использует Расходы
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстПотреблениеТоваровОрганизацийНаПроизводство""                    КАК ЗапросИсточник,
	|	0                                                                       КАК Порядок,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)                    КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                           КАК АналитикаУчетаНоменклатуры,
	|	ДД.Организация                                                          КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК НомерГТД,
	|	ДД.Количество                                                           КАК Количество,
	|	ДД.ПартияПроизводства                                                   КАК ПартияПроизводства,
	|	ДД.КорАналитикаУчетаНоменклатуры                                        КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура                                                         КАК Номенклатура,
	|	ДД.Характеристика                                                       КАК Характеристика,
	|	ДД.НалогообложениеНДС                                                   КАК НалогообложениеНДС
	|ИЗ
	|	Расходы КАК ДД
	|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход.Количество = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее Количество
	КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
	РасчетнаяПартия.Количество = КоличествоСписания;
	
	// корректируем базу расчета в приходе
	Приход.Количество = Приход.Количество - КоличествоСписания;
	Расход.Количество = Расход.Количество - КоличествоСписания;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен, ВидЗапасов, КорВидЗапасов, НомерГТД");
	
	Если Не ПараметрыРасчета.ФО.УчитыватьСебестоимостьТоваровПоВидамЗапасов Тогда
		
		СтруктураАналитики = Новый Структура("Номенклатура, Характеристика, Серия, Склад, СтатьяКалькуляции");
		
		ЗаполнитьЗначенияСвойств(СтруктураАналитики, РасчетнаяПартия.АналитикаУчетаНоменклатуры);
		СтруктураАналитики.Вставить("Назначение");
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗначениеКлючаАналитики(СтруктураАналитики);
		
		ЗаполнитьЗначенияСвойств(СтруктураАналитики, РасчетнаяПартия.КорАналитикаУчетаНоменклатуры);
		СтруктураАналитики.Вставить("Назначение");
		РегистрыСведений.АналитикаУчетаНоменклатуры.ЗначениеКлючаАналитики(СтруктураАналитики);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа3_СебестоимостьМатериаловПоЭтапам

// Инициализация данных

Функция ТаблицаДляСебестоимостиМатериаловПоЭтапам(ПараметрыРасчета)
	
	// На этом этапе используется не таблица распределения самого этапа, а таблица этапа заполнения партий в себестоимости.
	// По окончании этапа она помещается во временную таблицу ВтПроизводственныеЗатратыСебестоимостьТоваров.
	// Эта же временная таблица дополняется данными на следующих этапах,
	// а затем используется как источник данных на этапе заполнения партий в себестоимости.
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляПартийТоваров());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляСебестоимостиМатериаловПоЭтапам(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляСебестоимостиМатериаловПоЭтапам()
		+ ТекстОбъединениеЗапросов() + ТекстРасходСебестоимостиМатериаловЦеха()
		+ ТекстОбъединениеЗапросов() + ТекстПриходСебестоимостиМатериаловНаПартиюПроизводства()
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк не требуется, т.к. распределение выполняться не будет.
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляСебестоимостиМатериаловПоЭтапам()
	
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(80))               							КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)                   КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ДД.ВидДвижения                                                          КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                           КАК АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета                                                          КАК РазделУчета,
	|	ДД.ВидЗапасов                                                           КАК ВидЗапасов,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Партия                                                               КАК Партия,
	|	ДД.АналитикаУчетаПартий                                                 КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета                                            КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС                                                   КАК ВидДеятельностиНДС,
	|	ДД.Количество                                                           КАК Количество,
	|	ДД.Стоимость                                                            КАК Стоимость,
	|	ДД.ХозяйственнаяОперация                                                КАК ХозяйственнаяОперация,
	|	ДД.КорРазделУчета                                                       КАК КорРазделУчета,
	|	ДД.КорАналитикаУчетаНоменклатуры                                        КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов                                                        КАК КорВидЗапасов,
	|	ДД.КорПартия                                                            КАК КорПартия,
	|	ДД.КорВидДеятельностиНДС                                                КАК КорВидДеятельностиНДС,
	|	ДД.КорАналитикаФинансовогоУчета                                         КАК КорАналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартийПроизводства                                     КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяРасходовСписания                                               КАК СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	ДД.СтатьяАктивовПассивов                                                КАК СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов                                             КАК АналитикаАктивовПассивов,
	
	|	0                                                                       КАК Знаменатель
	
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|";
	
КонецФункции

// ... формирования временные таблиц

// ... выборки данных

Функция ТекстРасходСебестоимостиМатериаловЦеха()
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходСебестоимостиМатериаловЦеха""               				КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто)                КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.АналитикаУчетаНоменклатуры
	|	ИНАЧЕ АналитикаБезНазначения.КлючАналитики КОНЕЦ                       КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	КОНЕЦ                                                                   КАК РазделУчета,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ                                                                   КАК ВидЗапасов,
	|	ДД.Организация                                                          КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Партия,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)             КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаФинансовогоУчета,
	|	ВыпускающиеЭтапы.ВыпускПодДеятельность                                  КАК ВидДеятельностиНДС,
	|	ДД.Количество                                                           КАК Количество,
	|	0                                                                       КАК Стоимость,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	КОНЕЦ                                                                   КАК КорРазделУчета,
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ КорАналитикаБезНазначения.КлючАналитики КОНЕЦ                     КАК КорАналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ                                                                   КАК КорВидЗапасов,
	|	ДД.ПартияПроизводства                                                   КАК КорПартия,
	|	ВыпускающиеЭтапы.ВыпускПодДеятельность                      			КАК КорВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И НЕ ВыпускающиеЭтапы.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА ВыпускающиеЭтапы.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                   КАК КорАналитикаФинансовогоУчета,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаАктивовПассивов,
	
	|	0                                                                       КАК Знаменатель
	
	|ИЗ
	|	ВТКэшТоварыОрганизаций КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|	ПО
	|		ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|	ПО
	|		Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
	|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
	|		И Аналитика.Серия = АналитикаБезНазначения.Серия
	|		И Аналитика.Склад = АналитикаБезНазначения.Склад
	|		И Аналитика.СтатьяКалькуляции = АналитикаБезНазначения.СтатьяКалькуляции
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|	ПО
	|		ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаБезНазначения
	|	ПО
	|		КорАналитика.Номенклатура = КорАналитикаБезНазначения.Номенклатура
	|		И КорАналитика.Характеристика = КорАналитикаБезНазначения.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = КорАналитикаБезНазначения.Назначение
	|		И КорАналитика.Серия = КорАналитикаБезНазначения.Серия
	|		И КорАналитика.Склад = КорАналитикаБезНазначения.Склад
	|		И КорАналитика.СтатьяКалькуляции = КорАналитикаБезНазначения.СтатьяКалькуляции
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ВыпускающиеЭтапы
	|	ПО ВыпускающиеЭтапы.Ссылка = ДД.ПартияПроизводства
	|";
	
КонецФункции

Функция ТекстПриходСебестоимостиМатериаловНаПартиюПроизводства()
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстПриходСебестоимостиМатериаловНаПартиюПроизводства""              КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)                КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                                  КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	
	|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ КорАналитикаБезНазначения.КлючАналитики КОНЕЦ                     КАК АналитикаУчетаНоменклатуры,

	|	ВЫБОР
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	КОНЕЦ                                                                   КАК РазделУчета,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ                                                                   КАК ВидЗапасов,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.ПартияПроизводства                                                   КАК Партия,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)             КАК АналитикаУчетаПартий,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И НЕ ВыпускающиеЭтапы.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА ВыпускающиеЭтапы.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                   КАК АналитикаФинансовогоУчета,
	|	ВыпускающиеЭтапы.ВыпускПодДеятельность                      			КАК ВидДеятельностиНДС,
	|	ДД.Количество                                                           КАК Количество,
	|	0                                                                       КАК Стоимость,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаФинансовогоУчета,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаАктивовПассивов,
	
	|	0                                                                       КАК Знаменатель
	
	|ИЗ
	|	ВТКэшТоварыОрганизаций КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|	ПО
	|		ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаБезНазначения
	|	ПО
	|		КорАналитика.Номенклатура = КорАналитикаБезНазначения.Номенклатура
	|		И КорАналитика.Характеристика = КорАналитикаБезНазначения.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = КорАналитикаБезНазначения.Назначение
	|		И КорАналитика.Серия = КорАналитикаБезНазначения.Серия
	|		И КорАналитика.Склад = КорАналитикаБезНазначения.Склад
	|		И КорАналитика.СтатьяКалькуляции = КорАналитикаБезНазначения.СтатьяКалькуляции
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ВыпускающиеЭтапы
	|	ПО ВыпускающиеЭтапы.Ссылка = ДД.ПартияПроизводства
	|";
КонецФункции

// Заполнение расчетной партии

#КонецОбласти

#Область ПроцедурыЭтапа4_РаспределениеНоменклатурыНаПроизводство

// Инициализация данных

Функция ПоляПотребленийРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	Возврат "Регистратор";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений = ПоляПотребленийРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета);
	
	Партия                  = Перечисления.ТипыЗаписейПартий.Партия;
	ПотреблениеАвто         = Перечисления.ТипыЗаписейПартий.ПотреблениеАвто;
	ПеремещениеАвто         = Перечисления.ТипыЗаписейПартий.ПеремещениеАвто;
	
	// Потребление <- (Партия)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПотреблениеАвто, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПотреблениеАвто, Партия, ПоляПотреблений);
	
	// Перемещение <- (Потребление)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПеремещениеАвто, "Регистратор, Партия, АналитикаУчетаПартийПроизводства");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПеремещениеАвто, ПотреблениеАвто, "Регистратор, КорПартия, АналитикаУчетаПартийПроизводства");
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеНоменклатурыНаПроизводство",
		"",
		ПереченьПолей(КолонкиТаблицыРаспределения),
		ПоляПотребленийРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета),
		"",
		"Знаменатель",
		"Знаменатель",
		"",
		"Период");
	
	ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", "ВтПроизводственныеЗатратыСебестоимостьТоваров");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаПроизводство());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("Регистратор",    ?(ПараметрыРасчета.Свойство("Регистратор"),ПараметрыРасчета.Регистратор, Неопределено));
	Запрос.УстановитьПараметр("ВидПлановыхЦен", Справочники.ВидыЦен.ВидЦеныПоУмолчанию(Константы.ВидЦеныПлановойСтоимостиМатериаловРабот.Получить()));
	Запрос.УстановитьПараметр("ВключатьДанныеПроизводства21", Ложь);
	Запрос.УстановитьПараметр("РасчетСебестоимостиВыполнен", Ложь);
	Запрос.УстановитьПараметр("РасшифровкаРаспределения", Ложь);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстРаспределениеПроизводственныхЗатратИнициализация() // вт Продукция
		+ ТекстРаспределенияНоменклатурыНаПроизводствоИнициализация() // вт Регистраторы, Распределить
		+ ТекстДанныеПоМатериальнымЗатратам(ПараметрыРасчета) // вт ДанныеПоМатериальнымЗатратам
		+ ТекстДанныеПоВыпущеннойПродукции() //вт ДанныеПоПродукции
		+ ТекстДанныеПоТрудозатратам() //вт ДанныеПоТрудозатратам
		+ ТекстДанныеПоНормативамМатериала() //вт ДанныеПоНормативамРасходаМатериала
		+ ТекстБазаРаспределенияНоменклатурыНаПроизводство() // вт БазаРаспределенияДетально, БазаРаспределения
		+ ТекстСуммыПоказателейРаспределенияНоменклатурыНаПроизводство() // использует БазаРаспределения, вт ОбщиеСуммы
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаПроизводство()
		+ ТекстОбъединениеЗапросов() + ТекстКРаспределениюНоменклатурыНаПроизводство() // использует Распределить, ОбщиеСуммы
		+ ТекстОбъединениеЗапросов() + ТекстРасходыСебестоимостиНаПроизводство() // использует БазаРаспределения
		+ ТекстОбъединениеЗапросов() + ТекстПриходыСебестоимостиНаПроизводство() // использует БазаРаспределения
		+ "";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Вес", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СН.ЕдиницаИзмерения", "СН"));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Объем", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СН.ЕдиницаИзмерения", "СН"));
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.УстановитьПараметр("ОтборПоМатериаламИерархия", ОтборПоМатериаламИерархия(ПараметрыРасчета));
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Количество, Знаменатель", // ресурсы
		"Период, Регистратор, ТипЗаписи"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	Если Не ПараметрыРасчета.Свойство("РасшифровкаРаспределения") Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
			"Этапы, ПартииПроизводства, ПартииПроизводстваСводно, АналитикиПартийПроизводства, ПродолжающиесяПартии, втПродукция, втДолиИтог, Продукция, ДолиВыпуска,
			|втОтборПоМатериалам, Регистраторы, Распределить,
			|ДанныеПоМатериальнымЗатратам,
			|ДанныеПоПродукции,
			|ДанныеПоТрудозатратам,
			|втКоэффициенты, ДанныеПоНормативамРасходаМатериала,
			|БазаРаспределенияДетально, БазаРаспределения,
			|ОбщиеСуммы");
	КонецЕсли;
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаПроизводство()
	
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(80))       									КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)                   КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ДД.ВидДвижения                                                          КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                           КАК АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета                                                          КАК РазделУчета,
	|	ДД.ВидЗапасов                                                           КАК ВидЗапасов,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Партия                                                               КАК Партия,
	|	ДД.АналитикаУчетаПартий                                                 КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета                                            КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС                                                   КАК ВидДеятельностиНДС,
	|	0                                                                       КАК Знаменатель,
	|	ДД.Количество                                                           КАК Количество,
	|	ДД.ХозяйственнаяОперация                                                КАК ХозяйственнаяОперация,
	|	ДД.КорРазделУчета                                                       КАК КорРазделУчета,
	|	ДД.КорАналитикаУчетаНоменклатуры                                        КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов                                                        КАК КорВидЗапасов,
	|	ДД.КорПартия                                                            КАК КорПартия,
	|	ДД.КорВидДеятельностиНДС                                                КАК КорВидДеятельностиНДС,
	|	ДД.КорАналитикаФинансовогоУчета                                         КАК КорАналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартийПроизводства                                     КАК АналитикаУчетаПартийПроизводства,
	
	|	ДД.СтатьяРасходовСписания                                               КАК СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	ДД.СтатьяАктивовПассивов                                                КАК СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов                                             КАК АналитикаАктивовПассивов,
	
	|	КК.Номенклатура                                                         КАК Номенклатура,
	|	КК.Характеристика                                                       КАК Характеристика,
	|	КК.Серия                                                                КАК Серия,
	|	КК.Склад                                                                КАК Склад,
	|	КК.Назначение                                                           КАК Назначение,
	|	КК.СтатьяКалькуляции                                                    КАК СтатьяКалькуляции
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД,
	|		Справочник.КлючиАналитикиУчетаНоменклатуры КАК КК
	|";
	
КонецФункции

// ... формирования временные таблиц

// Таблицы: втОтборПоМатериалам, Регистраторы, Распределить
Функция ТекстРаспределенияНоменклатурыНаПроизводствоИнициализация()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.Материал КАК Материал
	|ПОМЕСТИТЬ втОтборПоМатериалам
	|ИЗ
	|	&ОтборПоМатериаламИерархия КАК ДД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор
	|ПОМЕСТИТЬ Регистраторы
	|ИЗ
	|	Документ.РаспределениеПроизводственныхЗатрат КАК ДД
	|ГДЕ
	|	ДД.Проведен
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.КоличествоКРаспределениюПоПравилу <> 0
	|	И (&Регистратор = ДД.Ссылка ИЛИ &Регистратор = НЕОПРЕДЕЛЕНО)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор
	|ИЗ
	|	Документ.РаспределениеВозвратныхОтходов КАК ДД
	|ГДЕ
	|	ДД.Проведен
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.КоличествоПоПравилу <> 0
	|	И (&Регистратор = ДД.Ссылка ИЛИ &Регистратор = НЕОПРЕДЕЛЕНО)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Серия,
	|	ДД.Назначение,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.ПравилоРаспределения,
	|	ДД.БазаРаспределения,
	|	ДД.СтатьяКалькуляции,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА Запасы.ВидЗапасов
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ КАК ВидЗапасов,
	|	Запасы.Количество,
	|	ЕСТЬNULL(втОтборПоМатериалам.Материал, НЕОПРЕДЕЛЕНО) КАК Материал,
	|	ЕСТЬNULL(втОтборПоВидамРабот.ВидРабот, НЕОПРЕДЕЛЕНО) КАК ВидРабот,
	|	ЕСТЬNULL(втОтборПоГруппамПродукции.ГруппаПродукции, НЕОПРЕДЕЛЕНО) КАК ГруппаПродукции,
	|	втОтборПоГруппамПродукции.ГруппаПродукции ЕСТЬ NULL КАК ПоВсемГруппамПродукции
	|ПОМЕСТИТЬ Распределить
	|ИЗ
	|	Документ.РаспределениеПроизводственныхЗатрат КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ВидыЗапасов КАК Запасы
	|		ПО ДД.Ссылка = Запасы.Ссылка
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ втОтборПоМатериалам КАК втОтборПоМатериалам
	|		ПО втОтборПоМатериалам.Регистратор = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоГруппамПродукции КАК втОтборПоГруппамПродукции
	|		ПО втОтборПоГруппамПродукции.Ссылка = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоВидамРабот КАК втОтборПоВидамРабот
	|		ПО втОтборПоВидамРабот.Ссылка = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|	ПО
	|		Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
	|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
	|		И Аналитика.Серия = АналитикаБезНазначения.Серия
	|		И Аналитика.Склад = АналитикаБезНазначения.Склад
	|		И Аналитика.СтатьяКалькуляции = АналитикаБезНазначения.СтатьяКалькуляции
	|ГДЕ
	|	Запасы.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Серия,
	|	ДД.Назначение,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.ПравилоРаспределения,
	|	ДД.БазаРаспределения,
	|	ДД.СтатьяКалькуляции,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	КОНЕЦ КАК ВидЗапасов,
	|	-ДД.КоличествоПоПравилу КАК Количество,
	|	ЕСТЬNULL(втОтборПоМатериалам.Материал, НЕОПРЕДЕЛЕНО) КАК Материал,
	|	ЕСТЬNULL(втОтборПоВидамРабот.ВидРабот, НЕОПРЕДЕЛЕНО) КАК ВидРабот,
	|	ЕСТЬNULL(втОтборПоГруппамПродукции.ГруппаПродукции, НЕОПРЕДЕЛЕНО) КАК ГруппаПродукции,
	|	втОтборПоГруппамПродукции.ГруппаПродукции ЕСТЬ NULL КАК ПоВсемГруппамПродукции
	|ИЗ
	|	Документ.РаспределениеВозвратныхОтходов КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ втОтборПоМатериалам КАК втОтборПоМатериалам
	|		ПО втОтборПоМатериалам.Регистратор = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеВозвратныхОтходов.ОтборПоГруппамПродукции КАК втОтборПоГруппамПродукции
	|		ПО втОтборПоГруппамПродукции.Ссылка = ДД.Ссылка
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеВозвратныхОтходов.ОтборПоВидамРабот КАК втОтборПоВидамРабот
	|		ПО втОтборПоВидамРабот.Ссылка = ДД.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|	ПО
	|		Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
	|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
	|		И Аналитика.Серия = АналитикаБезНазначения.Серия
	|		И Аналитика.Склад = АналитикаБезНазначения.Склад
	|		И Аналитика.СтатьяКалькуляции = АналитикаБезНазначения.СтатьяКалькуляции
	|;
	|";
	
	Возврат ТекстЗапроса
	
КонецФункции

// Таблицы: ДанныеПоМатериальнымЗатратам
Функция ТекстДанныеПоМатериальнымЗатратам(ПараметрыРасчета)
	
	// Для расшифровки отчета исходными данными являются документы ЭтапПроизводства
	// и движения по себестоимости для производства без заказов.
	// Для закрытия месяца данными являются результаты расчета предыдущих этапов.
	Если ПараметрыРасчета.Свойство("РасшифровкаРаспределения") Тогда
		
		Возврат "
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.Материал,
		|	ДД.Назначение,
		|	ДД.ГруппаПродукции,
		|	ДД.ПартияПроизводства,
		|	ДД.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	СУММА(ЕСТЬNULL(Цены.Цена, 0) * ДД.Количество) КАК Стоимость,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Объем) КАК Объем,
		|	СУММА(ДД.Вес) КАК Вес
		|ПОМЕСТИТЬ ДанныеПоМатериальнымЗатратам
		|ИЗ
		|	(ВЫБРАТЬ
		|		Партии.Организация КАК Организация,
		|		Аналитика.Склад КАК Подразделение,
		|		Аналитика.Номенклатура КАК Материал,
		|		Аналитика.Характеристика КАК Характеристика,
		|		Партии.Назначение КАК Назначение,
		|		Партии.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|		Партии.ПартияПроизводства КАК ПартияПроизводства,
		|		Партии.ПартияПроизводства.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|		НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартийПроизводства,
		|		СУММА(ДД.Количество) КАК Количество,
		|		СУММА(&Объем * ДД.Количество) КАК Объем,
		|		СУММА(&Вес * ДД.Количество) КАК Вес
		|	ИЗ
		|		Документ.ЭтапПроизводства2_2.РасходМатериаловИРабот КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|			ПО (СН.Ссылка = ДД.Номенклатура)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК Партии
		|			ПО (Партии.Этап = ДД.Ссылка)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		Партии.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		Партии.Назначение,
		|		Партии.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета,
		|		Партии.ПартияПроизводства,
		|		Партии.ПартияПроизводства.НаправлениеДеятельности 
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.Партия,
		|		ЕСТЬNULL(ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.АналитикаУчетаПартийПроизводства,
		|		СУММА(ДД.Количество),
		|		СУММА(&Объем * ДД.Количество),
		|		СУММА(&Вес * ДД.Количество)
		|	ИЗ
		|		РегистрНакопления.СебестоимостьТоваров КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|			ПО (СН.Ссылка = Аналитика.Номенклатура)
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В(&МассивОрганизаций)
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.Количество > 0
		|		И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
		|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
		|		И (ДД.Партия Ссылка Документ.ПроизводствоБезЗаказа
		|			ИЛИ ДД.Регистратор Ссылка Документ.РаспределениеПроизводственныхЗатрат
		|			ИЛИ ДД.Регистратор Ссылка Документ.РаспределениеВозвратныхОтходов)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартийПроизводства) КАК ДД
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода) КАК Цены
		|			ПО (ДД.Материал = Цены.Номенклатура)
		|			И (ДД.Характеристика = Цены.Характеристика)
		|			И (&ВидЦеныПлановойСтоимостиМатериаловРабот = Цены.ВидЦены)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.НаправлениеДеятельности,
		|	ДД.Материал,
		|	ДД.Назначение,
		|	ДД.ГруппаПродукции,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства
		|;
		|";
		
	Иначе
		
		Возврат "
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.Материал,
		|	ДД.Назначение,
		|	ДД.ГруппаПродукции,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Объем) КАК Объем,
		|	СУММА(ДД.Вес) КАК Вес
		|ПОМЕСТИТЬ ДанныеПоМатериальнымЗатратам
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.Организация КАК Организация,
		|		Аналитика.Склад КАК Подразделение,
		|		Аналитика.Номенклатура КАК Материал,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ КАК Назначение,
		|		ДД.АналитикаФинансовогоУчета КАК ГруппаПродукции,
		|		ДД.Партия КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|		СУММА(ДД.Стоимость) КАК Стоимость,
		|		СУММА(ДД.Количество) КАК Количество,
		|		СУММА(&Объем * ДД.Количество) КАК Объем,
		|		СУММА(&Вес * ДД.Количество) КАК Вес
		|	ИЗ
		|		ВтПроизводственныеЗатратыСебестоимостьТоваров КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|			ПО (СН.Ссылка = Аналитика.Номенклатура)
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В(&МассивОрганизаций)
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.Количество <> 0
		|		И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартийПроизводства
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартийПроизводства,
		|		СУММА(ДД.Стоимость),
		|		СУММА(ДД.Количество),
		|		СУММА(&Объем * ДД.Количество),
		|		СУММА(&Вес * ДД.Количество)
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|			ПО (СН.Ссылка = Аналитика.Номенклатура)
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В(&МассивОрганизаций)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.Количество <> 0
		|		И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
		|	
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Организация,
		|		Аналитика.Склад,
		|		Аналитика.Номенклатура,
		|		ВЫБОР
		|			КОГДА Аналитика.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|				ТОГДА ДД.Партия.Назначение
		|			ИНАЧЕ Аналитика.Назначение
		|		КОНЕЦ,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартийПроизводства) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.Материал,
		|	ДД.Назначение,
		|	ДД.ГруппаПродукции,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства
		|;
		|";
	КонецЕсли;
	
КонецФункции

// Таблицы: втКоэффициенты, ДанныеПоНормативамРасходаМатериала
Функция ТекстДанныеПоНормативамМатериала()
	
	Возврат "
	|ВЫБРАТЬ
	|	ДД.ПартияПроизводства КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	ВЫБОР КОГДА РС.Количество = 0 ТОГДА 0 ИНАЧЕ ДД.КоличествоПродукции/РС.Количество КОНЕЦ КАК Коэффициент
	|ПОМЕСТИТЬ втКоэффициенты
	|ИЗ
	|	Продукция КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.ВыходныеИзделия КАК РС
	|		ПО ДД.Спецификация = РС.Ссылка
	|		И ДД.Номенклатура = РС.Номенклатура
	|
	|ГДЕ
	|	РС.НомерСтроки = 1
	|	И ДД.ДоляНаименованияМесяца > 0
	|
	|;
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация                                    КАК Организация,
	|	ДД.Подразделение                                  КАК Подразделение,
	|	РС.Номенклатура                                   КАК Материал,
	|	ДД.АналитикаФинансовогоУчета                      КАК ГруппаПродукции,
	|	ДД.ПартияПроизводства.Назначение                  КАК Назначение,
	|	ДД.ПартияПроизводства                             КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства               КАК АналитикаУчетаПартийПроизводства,
	|	РС.Количество * КФ.Коэффициент                    КАК Количество
	|ПОМЕСТИТЬ ДанныеПоНормативамРасходаМатериала
	|ИЗ
	|	Продукция КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКоэффициенты КАК КФ
	|		ПО ДД.ПартияПроизводства = КФ.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = КФ.АналитикаУчетаПартийПроизводства
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.МатериалыИУслуги КАК РС
	|		ПО ДД.Спецификация = РС.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация                                    КАК Организация,
	|	ДД.Подразделение                                  КАК Подразделение,
	|	РС.Номенклатура                                   КАК Материал,
	|	ДД.АналитикаФинансовогоУчета                      КАК ГруппаПродукции,
	|	ДД.ПартияПроизводства.Назначение                  КАК Назначение,
	|	ДД.ПартияПроизводства                             КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства               КАК АналитикаУчетаПартийПроизводства,
	|	РС.Количество * КФ.Коэффициент                    КАК Количество
	|ИЗ
	|	Продукция КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКоэффициенты КАК КФ
	|		ПО ДД.ПартияПроизводства = КФ.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = КФ.АналитикаУчетаПартийПроизводства
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.ВозвратныеОтходы КАК РС
	|		ПО ДД.Спецификация = РС.Ссылка
	|;
	|";
	
КонецФункции

// Таблицы: БазаРаспределенияДетально, БазаРаспределения
Функция ТекстБазаРаспределенияНоменклатурыНаПроизводство()
	
	Возврат "
	// по указанным материалам
	|ВЫБРАТЬ
	|	ДД.Регистратор              КАК Регистратор,
	|	ДД.БазаРаспределения        КАК БазаРаспределения,
	|	Данные.Подразделение        КАК Подразделение,
	|	Данные.ПартияПроизводства   КАК ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение           КАК Назначение,
	|	Данные.Материал             КАК Материал,
	|	НЕОПРЕДЕЛЕНО                КАК Продукция,
	|	Данные.ГруппаПродукции      КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                КАК ВидРабот,
	|	СУММА(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов) ТОГДА Данные.Количество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов) ТОГДА Данные.Объем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов) ТОГДА Данные.Вес
	|	КОНЕЦ)                      КАК Знаменатель,
	|	""Материал""                КАК ВидПоказателя
	|ПОМЕСТИТЬ БазаРаспределенияДетально
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоМатериальнымЗатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И Данные.Материал = ДД.Материал
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	// по продукции
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор              КАК Регистратор,
	|	ДД.БазаРаспределения        КАК БазаРаспределения,
	|	Данные.Подразделение        КАК Подразделение,
	|	Данные.ПартияПроизводства   КАК ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение           КАК Назначение,
	|	НЕОПРЕДЕЛЕНО                КАК Материал,
	|	Данные.Продукция            КАК Продукция,
	|	Данные.ГруппаПродукции      КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                КАК ВидРабот,
	|	СУММА(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции) ТОГДА Данные.Количество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции) ТОГДА Данные.Объем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции) ТОГДА Данные.Вес
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции) ТОГДА Данные.Стоимость
	|	КОНЕЦ)                      КАК Знаменатель,
	|	""Продукция""               КАК ВидПоказателя
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоПродукции КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение,
	|	Данные.Продукция,
	|	Данные.ГруппаПродукции
	|
	// по указанным трудозатратам
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.БазаРаспределения       КАК БазаРаспределения,
	|	Данные.Подразделение       КАК Подразделение,
	|	Данные.ПартияПроизводства  КАК ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение           КАК Назначение,
	|	НЕОПРЕДЕЛЕНО               КАК Материал,
	|	НЕОПРЕДЕЛЕНО               КАК Продукция,
	|	Данные.ГруппаПродукции     КАК ГруппаПродукции,
	|	Данные.ВидРабот            КАК ВидРабот,
	|	СУММА(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов) ТОГДА Данные.Количество
	|	КОНЕЦ)                     КАК Знаменатель,
	|	""ВидРабот""               КАК ВидПоказателя
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоТрудозатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И Данные.ВидРабот = ДД.ВидРабот
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение,
	|	Данные.ВидРабот,
	|	Данные.ГруппаПродукции
	|
	// по нормативам
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.БазаРаспределения       КАК БазаРаспределения,
	|	Данные.Подразделение       КАК Подразделение,
	|	Данные.ПартияПроизводства  КАК ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение          КАК Назначение,
	|	Данные.Материал            КАК Материал,
	|	НЕОПРЕДЕЛЕНО               КАК Продукция,
	|	Данные.ГруппаПродукции     КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО               КАК ВидРабот,
	|	СУММА(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала) ТОГДА Данные.Количество
	|	КОНЕЦ)                     КАК Знаменатель,
	|	""Материал""               КАК ВидПоказателя
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоНормативамРасходаМатериала КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И Данные.Материал = ДД.Номенклатура
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.Назначение,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.Назначение,
	|	СУММА(ДД.Знаменатель)
	|ПОМЕСТИТЬ БазаРаспределения
	|ИЗ
	|	БазаРаспределенияДетально КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.Назначение
	|;
	|";
	
КонецФункции

// Таблицы: ОбщиеСуммы
Функция ТекстСуммыПоказателейРаспределенияНоменклатурыНаПроизводство()
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор        КАК Регистратор,
	|	СУММА(ДД.Знаменатель) КАК Знаменатель
	|ПОМЕСТИТЬ
	|	ОбщиеСуммы
	|ИЗ
	|	БазаРаспределения КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор
	|;
	|";
	
КонецФункции

// ... выборки данных

Функция ТекстКРаспределениюНоменклатурыНаПроизводство() // использует Распределить, ОбщиеСуммы
	
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""ТекстКРаспределениюНоменклатурыНаПроизводство""                      КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)                        КАК ТипЗаписи,
	|	ИСТИНА                                                                 КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ВидДвижения,
	|	&КонецПериода                                                          КАК Период,
	|	ДД.Регистратор                                                         КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                          КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	КОНЕЦ                                                                  КАК РазделУчета,
	|	ДД.ВидЗапасов                                                          КАК ВидЗапасов,
	|	ДД.Организация                                                         КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Партия,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ВидДеятельностиНДС,
	|	Итог.Знаменатель                                                       КАК Знаменатель,
	|	ДД.Количество                                                          КАК Количество,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                                                          КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаФинансовогоУчета,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаАктивовПассивов,

	|	ДД.Номенклатура                                                        КАК Номенклатура,
	|	ДД.Характеристика                                                      КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)                    КАК Серия,
	|	ДД.Подразделение                                                       КАК Склад,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Назначение,
	|	ДД.СтатьяКалькуляции                                                   КАК СтатьяКалькуляции

	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбщиеСуммы КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|";
	
КонецФункции

Функция ТекстРасходыСебестоимостиНаПроизводство() // использует БазаРаспределения
	
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходыСебестоимостиНаПроизводство""                            КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто)               КАК ТипЗаписи,
	|	ЛОЖЬ                                                                   КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                 КАК ВидДвижения,
	|	&КонецПериода                                                          КАК Период,
	|	ДД.Регистратор                                                         КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Партия,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ВидДеятельностиНДС,
	|	ДД.Знаменатель                                                         КАК Знаменатель,
	|	0                                                                      КАК Количество,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорВидЗапасов,
	|	ДД.ПартияПроизводства                                                  КАК КорПартия,
	|	ДД.ПартияПроизводства.ВыпускПодДеятельность                            КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартийПроизводства                                    КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаАктивовПассивов,
	
	|	НЕОПРЕДЕЛЕНО                                                           КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)                    КАК Серия,
	|	ДД.Подразделение                                                       КАК Склад,
	|	ДД.Назначение                                                          КАК Назначение,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяКалькуляции
	
	|ИЗ
	|	БазаРаспределения КАК ДД
	|";
	
КонецФункции

Функция ТекстПриходыСебестоимостиНаПроизводство() // использует БазаРаспределения
	
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстПриходыСебестоимостиНаПроизводство""                            КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)               КАК ТипЗаписи,
	|	ЛОЖЬ                                                                   КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                                 КАК ВидДвижения,
	|	&КонецПериода                                                          КАК Период,
	|	ДД.Регистратор                                                         КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК ВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Организация,
	|	ДД.ПартияПроизводства                                                  КАК Партия,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаФинансовогоУчета,
	|	ДД.ПартияПроизводства.ВыпускПодДеятельность                            КАК ВидДеятельностиНДС,
	|	ДД.Знаменатель                                                         КАК Знаменатель,
	|	0                                                                      КАК Количество,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                           КАК КорАналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартийПроизводства                                    КАК АналитикаУчетаПартийПроизводства,
	
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                           КАК АналитикаАктивовПассивов,
	
	|	НЕОПРЕДЕЛЕНО                                                           КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО                                                           КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)                    КАК Серия,
	|	ДД.Подразделение                                                       КАК Склад,
	|	ДД.Назначение                                                          КАК Назначение,
	|	НЕОПРЕДЕЛЕНО                                                           КАК СтатьяКалькуляции
	
	|ИЗ
	|	БазаРаспределения КАК ДД
	|";
	
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПотреблениеАвто Тогда
		
		
		// расчетная партия заполняется на наибольшее общее вычитаемое
		ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
		
		// корректируем базу расчета в приходе
		Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
		Приход.Количество  = Приход.Количество - РасчетнаяПартия.Количество;
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен, РазделУчета, Организация, АналитикаУчетаНоменклатуры, Номенклатура, Характеристика, СтатьяКалькуляции, ВидЗапасов, КорВидЗапасов");
		
		Если Не ПараметрыРасчета.ФО.УчитыватьСебестоимостьТоваровПоВидамЗапасов Тогда
			РасчетнаяПартия.Назначение = Неопределено;
		КонецЕсли;
		
		Если РасчетнаяПартия.РазделУчета <> Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты Тогда
			РасчетнаяПартия.КорРазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство;
		КонецЕсли;
		
		РасчетнаяПартия.КорАналитикаУчетаНоменклатуры = РегистрыСведений.АналитикаУчетаНоменклатуры.ЗначениеКлючаАналитики(РасчетнаяПартия);
		
	Иначе
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен, Организация, Количество");
		
		РасчетнаяПартия.АналитикаУчетаНоменклатуры = Приход.КорАналитикаУчетаНоменклатуры;
		РасчетнаяПартия.ВидЗапасов                 = Приход.КорВидЗапасов;
		РасчетнаяПартия.РазделУчета                = Приход.КорРазделУчета;
		
		Приход.Знаменатель = 0;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа5_РаспределениеНоменклатурыНаВыпуск

// Инициализация данных

Функция ПоляПотребленийРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	Возврат "Организация, Партия, АналитикаУчетаПартийПроизводства, АналитикаУчетаНоменклатуры";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений = ПоляПотребленийРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета);
	
	Партия          = Перечисления.ТипыЗаписейПартий.Партия;
	Расчетное       = Перечисления.ТипыЗаписейПартий.Расчетное;
	ПеремещениеАвто = Перечисления.ТипыЗаписейПартий.ПеремещениеАвто;
	
	// Расчетное <- Партия
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, Расчетное, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Расчетное, Партия, ПоляПотреблений);
	
	// Потребление <- Расчетное
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПеремещениеАвто, "Партия, АналитикаУчетаПартийПроизводства");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПеремещениеАвто, Расчетное, "Партия, АналитикаУчетаПартийПроизводства");
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеНоменклатурыНаВыпуск",
		"",
		ПереченьПолей(КолонкиТаблицыРаспределения),
		ПоляПотребленийРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета),
		"Количество",
		"Знаменатель",
		"Знаменатель",
		"",
		"Период");
	
	ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", "ВтПроизводственныеЗатратыСебестоимостьТоваров");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Расчетное, Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаВыпуск());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияНоменклатурыНаВыпуск(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	ОтборПоАналитикеПартии = Новый Структура("Дата, ВидЦенности", Запрос.Параметры.КонецПериода, Перечисления.ВидыЦенностей.Товары);
	Запрос.УстановитьПараметр("ПустаяАналитикаУчетаПартий",
		Справочники.КлючиАналитикиУчетаПартий.ПолучитьКлючАналитики(ОтборПоАналитикеПартии));
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстРаспределениеПроизводственныхЗатратИнициализация() // вт ДолиВыпуска, Продукция
		+ ТекстРасчетноеРаспределениеНоменклатурыНаВыпуск() // ОстаткиМатериалов, Расчетное
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаВыпуск()
		+ ТекстОбъединениеЗапросов() + ТекстНоменклатураКРаспределениюНаВыпуск() // использует ОстаткиМатериалов, ДолиВыпуска
		+ ТекстОбъединениеЗапросов() + ТекстРасчетноеКоличествоКРаспределению() // использует Расчетное
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеНоменклатурыНаВыпускПоПродукции() // использует Продукция
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Знаменатель, Количество", // ресурсы
		"Организация, Партия, АналитикаУчетаНоменклатуры"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"Этапы, ПартииПроизводства, ПартииПроизводстваСводно, АналитикиПартийПроизводства, ПродолжающиесяПартии, втПродукция, втДолиИтог, Продукция, ДолиВыпуска,
		|втОстаткиМатериалов, ОстаткиМатериалов, ОстаткиМатериаловСводно, втПланФактМатериалов,
		|ПланФактМатериалов, втСписаноВПрошлыхМесяцах, втРасчетноеКоличество, Расчетное");
		
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияНоменклатурыНаВыпуск()
	
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(80))          								 КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)                КАК ТипЗаписи,
	|	ЛОЖЬ                                                                 КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.ВидДвижения                                                       КАК ВидДвижения,
	|	ДД.Период                                                            КАК Период,
	|	ДД.Регистратор                                                       КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                        КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                                                        КАК ВидЗапасов,
	|	ДД.Организация                                                       КАК Организация,
	|	ДД.Партия                                                            КАК Партия,
	|	ДД.АналитикаУчетаПартий                                              КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета                                         КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС                                                КАК ВидДеятельностиНДС,
	|	0                                                                    КАК Знаменатель,
	|	0                                                                    КАК ДоляВыпуска,
	|	0                                                                    КАК Количество,
	|	ДД.ХозяйственнаяОперация                                             КАК ХозяйственнаяОперация,
	|	ДД.КорАналитикаУчетаНоменклатуры                                     КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.КорРазделУчета                                                    КАК КорРазделУчета,
	|	ДД.КорВидЗапасов                                                     КАК КорВидЗапасов,
	|	ДД.СтатьяРасходовСписания                                            КАК СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов                                                 КАК АналитикаРасходов,
	|	ДД.СтатьяАктивовПассивов                                             КАК СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов                                          КАК АналитикаАктивовПассивов,
	|	ДД.КорПартия                                                         КАК КорПартия,
	|	ДД.КорАналитикаУчетаПартий                                           КАК КорАналитикаУчетаПартий,
	|	ДД.КорВидДеятельностиНДС                                             КАК КорВидДеятельностиНДС,
	|	ДД.КорАналитикаФинансовогоУчета                                      КАК КорАналитикаФинансовогоУчета,
	|	ДД.СтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ИдентификаторСтроки                                               КАК ИдентификаторСтроки
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|";
	
КонецФункции

// ... формирования временные таблиц

// Таблицы: втОстаткиМатериалов, ОстаткиМатериалов, ОстаткиМатериаловСводно, втПланФактМатериалов,
//          ПланФактМатериалов, втСписаноВПрошлыхМесяцах, втРасчетноеКоличество, Расчетное
Функция ТекстРасчетноеРаспределениеНоменклатурыНаВыпуск()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ДД.Организация                КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.Партия                     КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ВидЗапасов                 КАК ВидЗапасов,
	|	ДД.РазделУчета                КАК РазделУчета,
	|	ДД.АналитикаУчетаПартий       КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС         КАК ВидДеятельностиНДС,
	|	ДД.КоличествоОстаток          КАК Количество
	|ПОМЕСТИТЬ втОстаткиМатериалов
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&МассивОрганизаций)
	|			И Партия В (ВЫБРАТЬ Т.ПартияПроизводства Из ПартииПроизводства КАК Т)
	|			И АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	ДД.Партия							КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ВидЗапасов						КАК ВидЗапасов,
	|	ДД.РазделУчета						КАК РазделУчета,
	|	ДД.АналитикаУчетаПартий				КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Количество						КАК Количество
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК Партии
	|			ПО ДД.Партия = Партии.Этап
	|			И ДД.АналитикаУчетаПартийПроизводства = Партии.АналитикаУчетаПартийПроизводства
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.СлужебноеВидДвиженияПриход
	|	И ДД.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	ДД.Партия							КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ВидЗапасов						КАК ВидЗапасов,
	|	ДД.РазделУчета						КАК РазделУчета,
	|	ДД.АналитикаУчетаПартий				КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Количество						КАК Количество
	|ИЗ
	|	ВтПроизводственныеЗатратыСебестоимостьТоваров КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводства КАК Партии
	|			ПО ДД.Партия = Партии.Этап
	|			И ДД.АналитикаУчетаПартийПроизводства = Партии.АналитикаУчетаПартийПроизводства
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ВидЗапасов						КАК ВидЗапасов,
	|	ДД.РазделУчета						КАК РазделУчета,
	|	ДД.АналитикаУчетаПартий				КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	СУММА(ДД.Количество)				КАК Количество
	|ПОМЕСТИТЬ ОстаткиМатериалов
	|ИЗ
	|	втОстаткиМатериалов КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	СУММА(ДД.Количество)				КАК Количество
	|ПОМЕСТИТЬ ОстаткиМатериаловСводно
	|ИЗ
	|	втОстаткиМатериалов КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ПартияПроизводства.Организация                КАК Организация,
	|	ДД.ПартияПроизводства                            КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	Аналитика.КлючАналитики                          КАК АналитикаУчетаНоменклатуры,
	|	Обеспечение.Количество                           КАК План,
	|	0                                                КАК Факт,
	|	1                                                КАК КоэффициентПриведения
	|ПОМЕСТИТЬ втПланФактМатериалов
	|ИЗ
	|	ПартииПроизводстваСводно КАК ДД
	|
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.ОбеспечениеМатериаламиИРаботами КАК Обеспечение
	|		ПО ДД.ПартияПроизводства = Обеспечение.Ссылка.ВыпускающийЭтап
	|
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|		ПО Обеспечение.Номенклатура = Аналитика.Номенклатура
	|		И Обеспечение.Характеристика = Аналитика.Характеристика
	|		И Обеспечение.Ссылка.Подразделение = Аналитика.Склад
	|		И ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) = Аналитика.Серия
	|		И (Обеспечение.Ссылка.Назначение = Аналитика.Назначение И &УчитыватьСебестоимостьТоваровПоВидамЗапасов ИЛИ НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = Аналитика.Назначение)
	|		И Обеспечение.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Материалы.Организация,
	|	Материалы.Партия,
	|	Материалы.АналитикаУчетаПартийПроизводства,
	|	Материалы.АналитикаУчетаНоменклатуры,
	|	0,
	|	Материалы.Количество,
	|	1 КАК КоэффициентПриведения
	|ИЗ
	|	ПартииПроизводстваСводно КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Материалы
	|		ПО ДД.ПартияПроизводства = Материалы.Партия
	|ГДЕ
	|	Материалы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Материалы.Период < &НачалоПериода
	|	И Материалы.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Материалы.Организация,
	|	Материалы.Партия,
	|	Материалы.АналитикаУчетаПартийПроизводства,
	|	Материалы.АналитикаУчетаНоменклатуры,
	|	0,
	|	Материалы.Количество,
	|	1 КАК КоэффициентПриведения
	|ИЗ
	|	ПартииПроизводстваСводно КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Материалы
	|		ПО ДД.ПартияПроизводства = Материалы.Партия
	|ГДЕ
	|	Материалы.СлужебноеВидДвиженияПриход
	|	И Материалы.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Материалы.Организация,
	|	Материалы.Партия,
	|	Материалы.АналитикаУчетаПартийПроизводства,
	|	Материалы.АналитикаУчетаНоменклатуры,
	|	0,
	|	ВЫБОР
	|		КОГДА Материалы.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
	|			ТОГДА -1 * Материалы.Количество
	|		ИНАЧЕ Материалы.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Материалы.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
	|			ТОГДА -1
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК КоэффициентПриведения
	|ИЗ
	|	ПартииПроизводстваСводно КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтПроизводственныеЗатратыСебестоимостьТоваров КАК Материалы
	|			ПО ДД.ПартияПроизводства = Материалы.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК Побочные
	|			ПО ДД.ПартияПроизводства = Побочные.Ссылка
	|			И Материалы.АналитикаУчетаНоменклатуры = Побочные.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	Материалы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Материалы.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И (Побочные.Произведено
	|		И Побочные.ДатаПроизводства < &КонецПериода
	|		ИЛИ Побочные.Ссылка ЕСТЬ NULL)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КоэффициентПриведения,
	|	СУММА(ДД.План) КАК План,
	|	СУММА(ДД.Факт) КАК Факт
	|ПОМЕСТИТЬ ПланФактМатериалов
	|ИЗ
	|	втПланФактМатериалов КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КоэффициентПриведения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расходы.Партия								КАК ПартияПроизводства,
	|	Расходы.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаНоменклатуры,
	|	Расходы.КоличествоРасход					КАК Количество
	|ПОМЕСТИТЬ втСписаноВПрошлыхМесяцах
	|ИЗ
	|	ПартииПроизводстваСводно КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Обороты(, &НачалоПериода, , ) КАК Расходы
	|		ПО ДД.ПартияПроизводства = Расходы.Партия
	|	И Расходы.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.КоэффициентПриведения,
	|	ВЫБОР
	|		КОГДА ДД.План > ДД.Факт
	|			ТОГДА ДД.План
	|		ИНАЧЕ ДД.Факт
	|	КОНЕЦ * ДолиВыпуска.ДоляВыпускаВсего - ДД.КоэффициентПриведения * ЕСТЬNULL(Списано.Количество, 0) КАК РасчетноеКоличество,
	|	ДолиВыпуска.ПроизводствоЗавершено,
	// дополнительные поля для расшифровки
	|	ДД.План,
	|	ДД.Факт,
	|	ДолиВыпуска.ДоляВыпускаВсего,
	|	ДолиВыпуска.ДоляВыпускаМесяца,
	|	Списано.Количество КАК КоличествоСписаноВПрошлыхМесяцах
	|ПОМЕСТИТЬ втРасчетноеКоличество
	|ИЗ
	|	ПланФактМатериалов КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиВыпуска КАК ДолиВыпуска
	|		ПО ДД.ПартияПроизводства = ДолиВыпуска.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = ДолиВыпуска.АналитикаУчетаПартийПроизводства
	|		ЛЕВОЕ СОЕДИНЕНИЕ втСписаноВПрошлыхМесяцах КАК Списано
	|		ПО ДД.ПартияПроизводства = Списано.ПартияПроизводства
	|			И ДД.АналитикаУчетаНоменклатуры = Списано.АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Организация                      КАК Организация,
	|	ДД.ПартияПроизводства               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаУчетаНоменклатуры       КАК АналитикаУчетаНоменклатуры,
	|	Аналитика.СтатьяКалькуляции         КАК СтатьяКалькуляции,
	|	ДД.КоэффициентПриведения * ВЫБОР
	|		КОГДА ДД.ПроизводствоЗавершено
	|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
	|		КОГДА ДД.РасчетноеКоличество > ЕСТЬNULL(Остатки.Количество, 0) * ДД.КоэффициентПриведения
	|			ТОГДА ЕСТЬNULL(Остатки.Количество, 0)
	|		ИНАЧЕ ДД.РасчетноеКоличество
	|	КОНЕЦ                               КАК РасчетноеКоличество,
	// дополнительные поля для расшифровки
	|	ДД.План                             КАК КоличествоВсегоПлан,
	|	ДД.Факт                             КАК КоличествоВсегоФакт,
	|	ДД.ДоляВыпускаВсего                 КАК ДоляВыпускаВсего,
	|	ДД.ДоляВыпускаМесяца                КАК ДоляВыпускаМесяца,
	|	ДД.КоличествоСписаноВПрошлыхМесяцах КАК КоличествоСписаноВПрошлыхМесяцах
	|ПОМЕСТИТЬ Расчетное
	|ИЗ
	|	втРасчетноеКоличество КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиМатериаловСводно КАК Остатки
	|		ПО ДД.ПартияПроизводства = Остатки.ПартияПроизводства
	|			И ДД.АналитикаУчетаПартийПроизводства = Остатки.АналитикаУчетаПартийПроизводства
	|			И ДД.АналитикаУчетаНоменклатуры = Остатки.АналитикаУчетаНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|;
	|";
	
	Возврат ТекстЗапроса
	
КонецФункции

// ... выборки данных

Функция ТекстНоменклатураКРаспределениюНаВыпуск() // использует ОстаткиМатериалов, ДолиВыпуска
	
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""ТекстНоменклатураКРаспределениюНаВыпуск""                          КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)                      КАК ТипЗаписи,
	|	ИСТИНА                                                               КАК РасчетЗавершен,
	|	ДД.РазделУчета                                                       КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	&КонецПериода                                                        КАК Период,
	|	ДД.ПартияПроизводства                                                КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                        КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                                                        КАК ВидЗапасов,
	|	ДД.Организация                                                       КАК Организация,
	|	ДД.ПартияПроизводства                                                КАК Партия,
	|	ДД.АналитикаУчетаПартий                                              КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета                                         КАК АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС                                                КАК ВидДеятельностиНДС,
	|	ДД.Количество                                                        КАК Знаменатель,
	|	Итог.ДоляВыпускаМесяца                                               КАК ДоляВыпуска,
	|	ДД.Количество                                                        КАК Количество,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяКалькуляции,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	ОстаткиМатериалов КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиВыпуска КАК Итог
	|		ПО Итог.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Итог.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
	|";
	
КонецФункции

Функция ТекстРасчетноеКоличествоКРаспределению() // использует Расчетное
	
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""ТекстРасчетноеКоличествоКРаспределению""                           КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное)                   КАК ТипЗаписи,
	|	ЛОЖЬ                                                                 КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО                                                         КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	&КонецПериода                                                        КАК Период,
	|	ДД.ПартияПроизводства                                                КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                                        КАК АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ВидЗапасов,
	|	ДД.Организация                                                       КАК Организация,
	|	ДД.ПартияПроизводства                                                КАК Партия,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ВидДеятельностиНДС,
	|	ДД.РасчетноеКоличество                                               КАК Знаменатель,
	|	0                                                                    КАК ДоляВыпуска,
	|	ДД.РасчетноеКоличество                                               КАК Количество,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаФинансовогоУчета,
	|	ДД.СтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	Расчетное КАК ДД
	|";
	
КонецФункции

Функция ТекстРаспределениеНоменклатурыНаВыпускПоПродукции() // использует Продукция
	
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеНоменклатурыНаВыпускПоПродукции""                КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)             КАК ТипЗаписи,
	|	ЛОЖЬ                                                                 КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО                                                         КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	&КонецПериода                                                        КАК Период,
	|	ДД.ПартияПроизводства                                                КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ВидЗапасов,
	|	ДД.Организация                                                       КАК Организация,
	|	ДД.ПартияПроизводства                                                КАК Партия,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ВидДеятельностиНДС,
	|	ДД.ДоляНаименованияМесяца                                            КАК Знаменатель,
	|	0                                                                    КАК ДоляВыпуска,
	|	0                                                                    КАК Количество,
	|	ДД.ХозяйственнаяОперация                                             КАК ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНоменклатуры                                        КАК КорАналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета                                                       КАК КорРазделУчета,
	|	ДД.ВидЗапасов                                                        КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаАктивовПассивов,
	|	ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22
	|				И ДД.Организация В (&ОрганизацииСФИФОСкользящая)
	|			ТОГДА ДД.ПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                КАК КорПартия,
	|	ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22
	|				И ДД.Организация В (&ОрганизацииСФИФОСкользящая)
	|			ТОГДА &ПустаяАналитикаУчетаПартий
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                КАК КорАналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС                                                КАК КорВидДеятельностиНДС,
	|	ДД.АналитикаФинансовогоУчета                                         КАК КорАналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяКалькуляции,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ИдентификаторСтроки                                               КАК ИдентификаторСтроки
	|ИЗ
	|	Продукция КАК ДД
	|	
	|ГДЕ
	|	ДД.ДоляНаименованияМесяца > 0
	|";
	
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределениеНоменклатурыНаВыпуск(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Расчетное Тогда
		
		Если Приход.Знаменатель = 0 Тогда
			Возврат;
		КонецЕсли;
		
		Если Расход.Количество < 0 Тогда
			КоличествоСписания = Макс(Расход.Количество, Приход.Количество);
			Коэффициент = - 1;
		Иначе
			Коэффициент = 1;
			КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		КонецЕсли;
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Количество = КоличествоСписания;
		
		// корректируем базу расчета в расходе
		Приход.Количество = Коэффициент * (Приход.Количество - РасчетнаяПартия.Количество);
		Расход.Количество = Коэффициент * (Расход.Количество - РасчетнаяПартия.Количество);
		
		РасчетнаяПартия.Знаменатель     = Приход.ДоляВыпуска;
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен,ВидЗапасов,АналитикаУчетаПартий,
			|АналитикаФинансовогоУчета,ВидДеятельностиНДС,РазделУчета");
		
	Иначе
		
		Если Приход.Знаменатель = 0 Тогда
			Возврат;
		КонецЕсли;
		
		// расчетная партия заполняется на наибольшее общее вычитаемое
		ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
		
		// корректируем базы расчета
		Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
		Приход.Количество  = Приход.Количество - РасчетнаяПартия.Количество;
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен,СтатьяКалькуляции,ВидЗапасов,АналитикаУчетаПартий,
			|АналитикаФинансовогоУчета,ВидДеятельностиНДС,АналитикаУчетаНоменклатуры,РазделУчета");
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//-- НЕ УТКА
//++ НЕ УТ

#Область ПроцедурыЭтапа6_РаспределениеМатериаловИРаботПоБазе

// Инициализация данных

Функция ПоляПотребленийРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	Возврат "Регистратор, Серия";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета);
	
	// Потребление <- (Партия)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Партия,		ПоляПотреблений);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеМатериаловИРаботПоБазе", // Контекст
		Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве.Имя, // ИмяРегистра
		ПереченьПолей(КолонкиТаблицыРаспределения), // ПоляРасчета
		ПоляПотребленийРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета), // КлючиСравнения
		"Партия", // Показатели
		"Количество", // БазисПрихода
		"Количество", // БазисРасхода
		"", // КлючРасхода
		"Период"); // ПолеПорядка
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляРаспределенияМатериаловИРаботПоБазе());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияМатериаловИРаботПоБазе(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстРаспределениеМатериаловИРаботИнициализация() // вт ОтборПоМатериалам, Распределить 
		+ ТекстРазделениеЗапросов() + ТекстДанныеПоУказаннымМатериалам() // вт Данные_ПоУказаннымМатериалам
		+ ТекстРазделениеЗапросов() + ТекстДанныеПоПродукции() // вт ФактЭтапов_ПоПродукции, ПланЭтаповПоЗаказам_ПоПродукции, Данные_ПоПродукции
		+ ТекстРазделениеЗапросов() + ТекстДанныеПоПлановойСтоимости() // вт Данные_ПоПлановойСтоимости
		+ ТекстРазделениеЗапросов() + ТекстДанныеПоУказаннымТрудозатратам() // вт Данные_ПоУказаннымТрудозатратам
		+ ТекстРазделениеЗапросов() + ТекстДанныеПоНормативамРасходаМатериала() // вт ФактЭтапов_ПоНормативам, ПланЭтаповПоЗаказам_ПоНормативам, Данные_ПоНормативамРасходаМатериала
		+ ТекстРазделениеЗапросов()	+ ТекстБазаРаспределения() // вт БазаРаспределения
		+ ТекстРазделениеЗапросов()	+ ТекстСуммыПоказателей() // вт ОбщиеСуммы
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияМатериаловИРаботПоБазе()
		+ ТекстОбъединениеЗапросов() + ТекстКРаспределению()
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеПоБазе();
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.УстановитьПараметр("ОтборПоМатериаламИерархия", ОтборПоМатериаламИерархия(ПараметрыРасчета));
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ЗаказНаПроизводство", // разделитель
		"Количество, КРаспределению, Объем, Вес, Стоимость", // ресурсы
		"Период, Регистратор, ТипЗаписи"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ОтборПоМатериалам, Распределить, Данные_ПоУказаннымМатериалам, Данные_ПоПродукции, Данные_ПоПлановойСтоимости,
		|ФактЭтапов_ПоПродукции, ПланЭтаповПоЗаказам_ПоПродукции, ФактЭтапов_ПоПлановойСтоимости, ПланЭтаповПоЗаказам_ПоПлановойСтоимости,
		|ФактЭтапов_ПоНормативам, ПланЭтаповПоЗаказам_ПоНормативам,
		|Данные_ПоУказаннымТрудозатратам, Данные_ПоНормативамРасходаМатериала, БазаРаспределения, ОбщиеСуммы");
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияМатериаловИРаботПоБазе()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 		 								 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) 		  		 КАК ТипЗаписи,
		|	ЛОЖЬ 														  		 КАК РасчетЗавершен,
		|
		|	ДД.ВидДвижения 								 						 КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 										 КАК Период,
		|	ДД.Регистратор 														 КАК Регистратор,
		|	ДД.Организация 						 								 КАК Организация,
		|	ДД.Номенклатура 						 							 КАК Номенклатура,
		|	ДД.Характеристика 						 							 КАК Характеристика,
		|	ДД.Подразделение 						 							 КАК Подразделение,
		|	ДД.Серия 						 							 		 КАК Серия,
		|	ДД.Назначение 						 							 	 КАК Назначение,
		|	0 																	 КАК Количество,
		|	ДД.СтатьяКалькуляции 						 						 КАК СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство 												 КАК ЗаказНаПроизводство,
		|	0 																	 КАК КодСтрокиПродукция,
		|	ДД.Этап 						 							 		 КАК Этап,
		|	ДД.АналитикаУчетаПродукции 						 					 КАК АналитикаУчетаПродукции,
		|	ДД.Спецификация 						 							 КАК Спецификация,
		|	ДД.СтатьяРасходов 						 							 КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов 												 КАК АналитикаРасходов,
		|	ДД.АналитикаУчетаНоменклатуры 						 				 КАК АналитикаУчетаНоменклатуры,
		|	ДД.ПодразделениеПолучатель 						 					 КАК ПодразделениеПолучатель,
		|	ДД.БазаРаспределения 						 						 КАК БазаРаспределения,
		|	0 																	 КАК КРаспределению,
		|	0 																	 КАК Объем,
		|	0 																	 КАК Вес,
		|	0 																	 КАК Стоимость
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстРаспределениеМатериаловИРаботИнициализация() // вт ОтборПоМатериалам, Распределить
	Возврат
		"ВЫБРАТЬ
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Материал КАК Материал
		|ПОМЕСТИТЬ ОтборПоМатериалам
		|ИЗ
		|	&ОтборПоМатериаламИерархия КАК ДД
		|;
		|/////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Дата,
		|	ДД.Организация,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Серия,
		|	ДД.Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.СтатьяКалькуляции,
		|	ДД.Назначение,
		|	ДД.БазаРаспределения,
		|	ДД.КРаспределению,
		|	ЕСТЬNULL(ОтборПоМатериалам.Материал, НЕОПРЕДЕЛЕНО) КАК Материал,
		|	ЕСТЬNULL(ОтборПоВидамРабот.ВидРабот, НЕОПРЕДЕЛЕНО) КАК ВидРабот,
		|	ЕСТЬNULL(ОтборПоГруппамПродукции.ГруппаПродукции, НЕОПРЕДЕЛЕНО) КАК ГруппаПродукции,
		|	(ВЫБОР
		|		КОГДА ОтборПоГруппамПродукции.ГруппаПродукции ЕСТЬ NULL ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ПоВсемГруппамПродукции
		|ПОМЕСТИТЬ Распределить
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Ссылка КАК Регистратор,
		|		ДД.Дата,
		|		ДД.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ДД.Серия,
		|		ДД.Подразделение,
		|		Аналитика.КлючАналитики КАК АналитикаУчетаНоменклатуры,
		|		Правила.БазаРаспределения КАК БазаРаспределения,
		|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|		ДД.Назначение КАК Назначение,
		|		ДД.КоличествоКРаспределениюПоПравилу КАК КРаспределению
		|	ИЗ
		|		Документ.РаспределениеПроизводственныхЗатрат КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|			ПО Аналитика.Номенклатура = ДД.Номенклатура
		|			И Аналитика.Характеристика = ДД.Характеристика
		|			И Аналитика.Серия = ДД.Серия
		|			И Аналитика.Склад = ДД.Подразделение
		|			И Аналитика.Назначение = ДД.Назначение
		|			И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
		|			ПО ДД.ПравилоРаспределения = Правила.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|		И ДД.СтатусУказанияСерий НЕ В(9,10)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Ссылка КАК Регистратор,
		|		Т.Дата,
		|		Т.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ДД.Серия,
		|		Т.Подразделение,
		|		Аналитика.КлючАналитики КАК АналитикаУчетаНоменклатуры,
		|		Правила.БазаРаспределения КАК БазаРаспределения,
		|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|		Т.Назначение КАК Назначение,
		|		ДД.КоличествоКРаспределениюПоПравилу КАК КРаспределению
		|	ИЗ
		|		Документ.РаспределениеПроизводственныхЗатрат.Серии КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат КАК Т
		|			ПО Т.Ссылка = ДД.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|			ПО Аналитика.Номенклатура = ДД.Номенклатура
		|			И Аналитика.Характеристика = ДД.Характеристика
		|			И Аналитика.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|			И Аналитика.Склад = Т.Подразделение
		|			И Аналитика.Назначение = Т.Назначение
		|			И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
		|			ПО Т.ПравилоРаспределения = Правила.Ссылка
		|	ГДЕ
		|		Т.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И Т.Организация В (&МассивОрганизаций)
		|		И Т.Проведен
		|		И Т.СтатусУказанияСерий В (9,10)
		|	) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОтборПоМатериалам КАК ОтборПоМатериалам
		|		ПО ОтборПоМатериалам.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоГруппамПродукции КАК ОтборПоГруппамПродукции
		|		ПО ОтборПоГруппамПродукции.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоВидамРабот КАК ОтборПоВидамРабот
		|		ПО ОтборПоВидамРабот.Ссылка = ДД.Регистратор
		|";
КонецФункции

Функция ТекстДанныеПоНормативамРасходаМатериала() // вт ФактЭтапов_ПоНормативам, ПланЭтаповПоЗаказам_ПоНормативам, Данные_ПоНормативамРасходаМатериала
	Возврат
		"
		//++ НЕ УТКА
		|ВЫБРАТЬ
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.Этап.Владелец КАК Спецификация,
		|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
		|ПОМЕСТИТЬ ФактЭтапов_ПоНормативам
		|ИЗ
		|	РегистрНакопления.ЭтапыПроизводства КАК ДД
		|ГДЕ
		// Выполняющийся этап
		|	((ДД.НачалоПредварительногоБуфера <= &КонецПериода
		|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
		|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0))
		|	ИЛИ
		// Выполненный этап
		|	(ДД.ОкончаниеЗавершающегоБуфера МЕЖДУ &НачалоПериода И &КонецПериода
		|	И (ДД.Выполнено <> 0 ИЛИ ДД.Брак <> 0)))
		|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.Этап.Владелец
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Распоряжение,
		|	Т.КодСтрокиПродукция,
		|	Т.Спецификация,
		|	СУММА(ДД.ЗапланированоЗаказом) КАК ПланЭтапов
		|ПОМЕСТИТЬ ПланЭтаповПоЗаказам_ПоНормативам
		|ИЗ
		|	ФактЭтапов_ПоНормативам КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК ДД
		|		ПО Т.Распоряжение = ДД.Распоряжение
		|		И Т.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Т.Этап = ДД.Этап
		|		И ДД.ЗапланированоЗаказом <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Распоряжение,
		|	Т.КодСтрокиПродукция,
		|	Т.Спецификация
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|
		//-- НЕ УТКА
		// Данные по выпуску без распоряжений.
		|ВЫБРАТЬ
		|	Выпуск.Организация,
		|	Выпуск.Подразделение,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	ДД.Назначение,
		|	ДД.Ссылка КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.Номенклатура КАК НоменклатураВыпуска,
		|	ДД.Характеристика КАК ХарактеристикаВыпуска,
		|	ДД.Спецификация КАК Спецификация,
		|	ДД.Количество КАК ЗапланированоПродукции,
		|	1 КАК ЗапланированоЭтапов,
		|	1 КАК ВыполненоЭтапов,
		|	ДД.Количество
		|ПОМЕСТИТЬ Данные_ПоНормативамРасходаМатериала
		|ИЗ
		|	Документ.ВыпускПродукции.Товары КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
		|		ПО (Выпуск.Ссылка = ДД.Ссылка)
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|		ПО (СН.Ссылка = ДД.Номенклатура)
		|ГДЕ
		|	Выпуск.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Выпуск.Организация В (&МассивОрганизаций)
		|	И НЕ Выпуск.ВыпускПоРаспоряжениям
		|	И Выпуск.Проведен
		|
		//++ НЕ УТКА
		// Данные по выпуску по распоряжениям.
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаказНаПроизводство.Организация,
		|	Строки.Подразделение,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	Строки.Назначение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	Строки.Номенклатура,
		|	Строки.Характеристика,
		|	ДД.Спецификация,
		|	Строки.Количество,
		|	План.ПланЭтапов,
		|	ДД.ФактЭтапов,
		|	ВЫБОР
		|		КОГДА План.ПланЭтапов <> 0
		|		ТОГДА Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Количество //Это расчетный выпуск
		|
		|ИЗ ФактЭтапов_ПоНормативам КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоНормативам КАК План
		|		ПО ДД.Распоряжение = План.Распоряжение
		|		И ДД.КодСтрокиПродукция = План.КодСтрокиПродукция
		|		И ДД.Спецификация = План.Спецификация
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиПродукция
		|		ПО ДД.Распоряжение = СтрокиПродукция.Ссылка
		|		И ДД.КодСтрокиПродукция = СтрокиПродукция.КодСтроки
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.ВыходныеИзделия КАК Строки
		|		ПО СтрокиПродукция.Ссылка = Строки.Ссылка
		|		И СтрокиПродукция.КлючСвязи = Строки.КлючСвязиПродукция
		|		И ДД.Этап = Строки.Этап
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
		|		ПО ДД.Распоряжение = ЗаказНаПроизводство.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|		ПО Строки.Номенклатура = СН.Ссылка
		//-- НЕ УТКА
		|";
КонецФункции

Функция ТекстБазаРаспределения() // вт БазаРаспределения
	Возврат
		// по указанным материалам
		"ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	Данные.ЗаказНаПроизводство,
		|	Данные.КодСтрокиПродукция,
		|	Данные.Этап,
		|	Данные.Количество,
		|	Данные.Объем,
		|	Данные.Вес,
		|	0 КАК Стоимость
		|ПОМЕСТИТЬ БазаРаспределения
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымМатериалам КАК Данные
		|		ПО Данные.Организация = ДД.Организация
		|		И Данные.Подразделение = ДД.Подразделение
		|		И Данные.Материал = ДД.Материал
		|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
		|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|ГДЕ
		|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
		|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
		|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов)
		|
		// по продукции
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	Данные.ЗаказНаПроизводство,
		|	Данные.КодСтрокиПродукция,
		|	Данные.Этап,
		|	Данные.Количество,
		|	Данные.Объем,
		|	Данные.Вес,
		|	0 КАК Стоимость
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПродукции КАК Данные
		|		ПО Данные.Организация = ДД.Организация
		|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
		|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|		И Данные.Подразделение = ДД.Подразделение
		|ГДЕ
		|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
		|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
		|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции)
		|
		// по плановой стоимости
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	Данные.ЗаказНаПроизводство,
		|	Данные.КодСтрокиПродукция,
		|	Данные.Этап,
		|	Данные.Количество,
		|	0 КАК Объем,
		|	0 КАК Вес,
		|	Данные.Количество * Цены.Цена КАК Стоимость
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПлановойСтоимости КАК Данные
		|		ПО Данные.Организация = ДД.Организация
		|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
		|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|		И Данные.Подразделение = ДД.Подразделение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидЦеныПлановойСтоимостиМатериаловРабот) КАК Цены
		|		ПО Цены.Номенклатура = Данные.Номенклатура
		|		И Цены.Характеристика = Данные.Характеристика
		|ГДЕ
		|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
		|
		// по указанным трудозатратам
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	ВЫБОР
		|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
		|			И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО
		|			ТОГДА Данные.ДокументВыпуска
		|		ИНАЧЕ Данные.ЗаказНаПроизводство
		|	КОНЕЦ КАК ЗаказНаПроизводство,
		|	ВЫБОР
		|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
		|			И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО
		|			ТОГДА Данные.КодСтроки
		|		ИНАЧЕ Данные.КодСтрокиПродукция
		|	КОНЕЦ КАК КодСтрокиПродукция,
		|	Данные.Этап,
		|	Данные.Количество,
		|	0 КАК Объем,
		|	0 КАК Вес,
		|	0 КАК Стоимость
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымТрудозатратам КАК Данные
		|		ПО Данные.Организация = ДД.Организация
		|		И Данные.Подразделение = ДД.Подразделение
		|		И Данные.ВидРабот = ДД.ВидРабот
		|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
		|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|ГДЕ
		|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
		|
		// по нормативам
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	Данные.ЗаказНаПроизводство,
		|	Данные.КодСтрокиПродукция,
		|	Данные.Этап,
		|	(ВЫБОР
		|		КОГДА СУММА(Продукция.Количество) <> 0 ТОГДА СУММА(Данные.Количество) * СУММА(Материалы.Количество) / СУММА(Продукция.Количество)
		|		ИНАЧЕ 0 КОНЕЦ) КАК Количество,
		|	0 КАК Объем,
		|	0 КАК Вес,
		|	0 КАК Стоимость
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоНормативамРасходаМатериала КАК Данные
		|		ПО Данные.Организация = ДД.Организация
		|		И Данные.Подразделение = ДД.Подразделение
		|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
		|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.МатериалыИУслуги КАК Материалы
		|		ПО Материалы.Ссылка = Данные.Спецификация
		|		И Материалы.Номенклатура = Аналитика.Номенклатура
		|		И Материалы.Характеристика = Аналитика.Характеристика
		|		И (Материалы.Характеристика = Аналитика.Характеристика ИЛИ Материалы.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.ВыходныеИзделия КАК Продукция
		|		ПО Продукция.Ссылка = Данные.Спецификация
		|		И Продукция.Номенклатура = Данные.НоменклатураВыпуска
		|		И Продукция.Характеристика = Данные.ХарактеристикаВыпуска
		|		И (Продукция.Характеристика = Данные.ХарактеристикаВыпуска ИЛИ Продукция.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
		|ГДЕ
		|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Подразделение,
		|	ДД.Дата,
		|	ДД.Серия,
		|	Данные.ЗаказНаПроизводство,
		|	Данные.КодСтрокиПродукция,
		|	Данные.Этап
		|";
КонецФункции

Функция ТекстСуммыПоказателей() // вт ОбщиеСуммы
	Возврат
		"ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Серия,
		|	СУММА(ДД.Количество) КАК ОбщееКоличество,
		|	СУММА(ДД.Объем) КАК ОбщийОбъем,
		|	СУММА(ДД.Вес) КАК ОбщийВес,
		|	СУММА(ДД.Стоимость) КАК ОбщаяСтоимость
		|ПОМЕСТИТЬ ОбщиеСуммы
		|ИЗ
		|	БазаРаспределения КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Серия
		|";
КонецФункции

// ... выборки данных

Функция ТекстКРаспределению()
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	""ТекстКРаспределению"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Подразделение,
		|	ДД.Серия,
		|	ДД.Назначение КАК Назначение,
		|	Итог.ОбщееКоличество КАК Количество,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПолучатель,
		|	ДД.БазаРаспределения,
		|	ДД.КРаспределению,
		|	Итог.ОбщийОбъем КАК Объем,
		|	Итог.ОбщийВес КАК Вес,
		|	Итог.ОбщаяСтоимость КАК Стоимость
		|ИЗ
		|	Распределить КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбщиеСуммы КАК Итог
		|		ПО Итог.Регистратор = ДД.Регистратор
		|		И Итог.Серия = ДД.Серия
		|ГДЕ
		|	ДД.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|";
КонецФункции

Функция ТекстРаспределениеПоБазе()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРаспределениеПоБазе"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК Организация,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	ДД.Подразделение КАК Подразделение,
		|	ДД.Серия КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	ДД.Количество,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПолучатель,
		|	НЕОПРЕДЕЛЕНО КАК БазаРаспределения,
		|	0 КАК КРаспределению,
		|	ДД.Объем,
		|	ДД.Вес,
		|	ДД.Стоимость
		|ИЗ
		|	БазаРаспределения КАК ДД
		|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределениеМатериаловИРаботПоБазе(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход,
		"Организация, Номенклатура, Характеристика, Подразделение, Серия,
		|АналитикаУчетаНоменклатуры, БазаРаспределения, Назначение, СтатьяКалькуляции");
	
	Если Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоПродукции
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала Тогда
		
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Количество = 0, 0, Расход.Количество / Приход.Количество), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемПродукции Тогда
		
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Объем = 0, 0, Расход.Объем / Приход.Объем), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ВесПродукции Тогда
		
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Вес = 0, 0, Расход.Вес / Приход.Вес), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции Тогда
		
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Стоимость = 0, 0, Расход.Стоимость / Приход.Стоимость), 3);
		
	КонецЕсли;
	
	РасчетнаяПартия.КРаспределению = Приход.КРаспределению;
	
	// корректируем базу расчета в приходе
	Приход.КРаспределению = Приход.КРаспределению - РасчетнаяПартия.Количество;
	Приход.Количество 	  = Приход.Количество - Расход.Количество;
	Приход.Объем 		  = Приход.Объем - Расход.Объем;
	Приход.Вес 			  = Приход.Вес - Расход.Вес;
	Приход.Стоимость 	  = Приход.Стоимость - Расход.Стоимость;
	
	// корректируем базу расчета в расходе
	Расход.Количество = 0;
	Расход.Объем 	  = 0;
	Расход.Вес 		  = 0;
	Расход.Стоимость  = 0;
	
	РасчетнаяПартия.РасчетЗавершен = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа7_РаспределениеМатериаловНЗП

// Инициализация данных

Функция ПоляПотребленийРаспределенияМатериаловНЗП(ПараметрыРасчета)
	
	Возврат "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, ДокументВыпуска, НомерГруппыЗатрат";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияМатериаловНЗП(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийРаспределенияМатериаловНЗП(ПараметрыРасчета);
	
	// Распределение <- (Партия, Остаток, ПолуфабрикатДавальца)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение, 		 ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Партия,				 ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Остаток,				 ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца, ПоляПотреблений);
	
	// Выпуск <- (Распределение)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск, 		  		  "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.Распределение, 		  "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	
	// Дополнение <- (<без источников - для формирования записей по данным запроса>)
	ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
		
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияМатериаловНЗП(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияМатериаловНЗП(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеМатериаловНЗП", // Контекст
		Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства.Имя, // ИмяРегистра
		ПереченьПолей(КолонкиТаблицыРаспределения), // ПоляРасчета
		ПоляПотребленийРаспределенияМатериаловНЗП(ПараметрыРасчета), // КлючиСравнения
		"Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница", // Показатели
		"Знаменатель", // БазисПрихода
		"Знаменатель", // БазисРасхода
		"ДокументИсточник", // КлючРасхода
		"Период"); // ПолеПорядка
	
	ОписаниеДвижений.Вставить("ПоляСуммирования", "Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	ОписаниеДвижений.Вставить("ПоляГруппировки",  ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийМатериаловНЗП(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток, Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	НезаписываемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияМатериаловНЗП(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляРаспределенияМатериаловНЗП());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияМатериаловНЗП(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстПартииНЗПИнициализация() // вт ПартииНЗПНачальныйОстаток, ПрошлыеПоступленияНЗП, ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказов
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияМатериаловНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстОстаткиПартийНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстПервичныеПартииНЗП()
		//++ НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстДополнениеПартийНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстМаршрутныеЛисты()
		+ ТекстОбъединениеЗапросов() + ТекстПрошлыеМаршрутныеЛисты()
		+ ТекстОбъединениеЗапросов() + ТекстВыпускиПоЗаказам()
		//-- НЕ УТКА
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Знаменатель, КоличествоПродукции, Количество, Стоимость,
			|СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница", // ресурсы
		"Организация, ЗаказНаПроизводство, Приоритет, Период, Регистратор"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ПартииНЗПНачальныйОстаток, ПрошлыеПоступленияНЗП,
		//++ НЕ УТКА
		|ЗаказыКРаспределению,
		//-- НЕ УТКА
		|ДолиСтоимости");
		
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияМатериаловНЗП()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 											КАК ЗапросИсточник,
		|	0 																		КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) 					КАК ТипЗаписи,
		|	ЛОЖЬ 																	КАК РасчетЗавершен,
		|
		|	ДД.ВидДвижения 															КАК ВидДвижения,
		|	ДД.Период 																КАК Период,
		|	ДД.Регистратор 															КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) 	КАК РазделУчета,
		|	ДД.Организация 															КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 					КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры 											КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления 													КАК ДокументПоступления,
		|	ДД.ВидЗапасов 															КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство 													КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция 													КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) 				КАК Спецификация,
		|	ДД.Этап																	КАК Этап,
		|	ДД.СтатьяКалькуляции 													КАК СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий 												КАК АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПродукции 												КАК АналитикаУчетаПродукции,
		|	0 																		КАК Знаменатель,
		|	0 																		КАК КоличествоПродукции,
		|	0 																		КАК Количество,
		|	0 																		КАК Стоимость,
		|	0 																		КАК СтоимостьБезНДС,
		|	0 																		КАК СтоимостьРегл,
		|	0 																		КАК НДСРегл,
		|	0 																		КАК ПостояннаяРазница,
		|	0 																		КАК ВременнаяРазница,
		|	ЛОЖЬ 																	КАК Первичное,
		|	ЛОЖЬ 																	КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 				КАК ХозяйственнаяОперация,
		|	ДД.КорРазделУчета 														КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры 											КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов 														КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 											КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 				КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 				КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) 							КАК Назначение,
		|	ДД.ДокументИсточник 													КАК ДокументИсточник,
		|	ДД.ДокументВыпуска 														КАК ДокументВыпуска,
		|	0 																		КАК НомерГруппыЗатрат,
		|	ДД.Продукция 															КАК Продукция,
		|	ДД.ХарактеристикаПродукции 												КАК ХарактеристикаПродукции
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстПартииНЗПИнициализация() // вт ПартииНЗПНачальныйОстаток, ПрошлыеПоступленияНЗП, ЗаказыКРаспределению, ДолиСтоимости
	Возврат
		"ВЫБРАТЬ
		|	Т.Организация,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов,
		|	Т.ЗаказНаПроизводство,
		|	Т.КодСтрокиПродукция,
		|	Т.ДокументПоступления,
		|	Т.Этап,
		|	Т.СтатьяКалькуляции,
		|	Т.АналитикаУчетаПартий,
		|	Т.КоличествоОстаток,
		|	Т.СтоимостьОстаток,
		|	Т.СтоимостьБезНДСОстаток,
		|	Т.СтоимостьРеглОстаток,
		|	Т.НДСРеглОстаток,
		|	Т.ПостояннаяРазницаОстаток,
		|	Т.ВременнаяРазницаОстаток
		|ПОМЕСТИТЬ ПартииНЗПНачальныйОстаток
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК Т
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	МАКСИМУМ(Периодика.Период) КАК Период
		|ПОМЕСТИТЬ ПрошлыеПоступленияНЗП
		|ИЗ
		|	ПартииНЗПНачальныйОстаток КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииНезавершенногоПроизводства КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления
		|;
		|////////////////////////////////////////////////////////////////////////////
		//++ НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Распоряжение
		|ПОМЕСТИТЬ ЗаказыКРаспределениюПредварительная
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции.ОстаткиИОбороты(&НачалоПериода, &КонецПериода) КАК Т
		|ГДЕ
		|	Т.ЗаказаноПриход <> 0
		|	ИЛИ Т.ЗаказаноКонечныйОстаток <> 0
	    |
		|ИНДЕКСИРОВАТЬ ПО
		|	Т.Распоряжение
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	МаршрутныйЛист.Распоряжение КАК Заказ,
		|	МаршрутныйЛист.КодСтроки КАК КодСтроки
		|ПОМЕСТИТЬ ЗаказыКРаспределению
		|ИЗ
		|	Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределениюПредварительная КАК Т
		|		ПО МаршрутныйЛист.Ссылка = Т.Распоряжение
		|ГДЕ
		|	МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|;
		|////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ЗаказыКРаспределениюПредварительная
		|;
		|////////////////////////////////////////////////////////////////////////////
		//-- НЕ УТКА
		|ВЫБРАТЬ
		|	Строки.ЗаказПереработчику КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	Строки.НомерГруппыЗатрат,
		|	СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|ПОМЕСТИТЬ ДолиСтоимости
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	Строки.ЗаказПереработчику,
		|	Строки.НомерГруппыЗатрат
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Строки.ДокументПоступления КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	Строки.НомерГруппыЗатрат,
		|	СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	Строки.ДокументПоступления,
		|	Строки.НомерГруппыЗатрат
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	0 КАК НомерГруппыЗатрат,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК ДоляСтоимости
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределению КАК Заказы
		|		ПО Заказы.Заказ = МаршрутныйЛист.Распоряжение
		|			И Заказы.КодСтроки = МаршрутныйЛист.КодСтроки
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец
		//-- НЕ УТКА
		|";
КонецФункции

// ... выборки данных

Функция ТекстОстаткиПартийНЗП()
	// передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика
	Возврат
		"ВЫБРАТЬ
		|	""ТекстОстаткиПартийНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.Склад КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЕСТЬNULL(Этапы.Владелец, ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)) КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	Аналитика.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции
		|ИЗ
		|	ПартииНЗПНачальныйОстаток КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступленияНЗП КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|";
КонецФункции

Функция ТекстПервичныеПартииНЗП()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПервичныеПартииНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.Склад КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции
		|ИЗ
		|	ВТКэшРасчетныеОборотыМатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	Аналитика.Склад,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.Назначение
		|";
КонецФункции

//++ НЕ УТКА
Функция ТекстДополнениеПартийНЗП()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДополнениеПартийНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.Склад КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация)
		|		ИНАЧЕ ДД.ЗаказНаПроизводство
		|	КОНЕЦ КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация) КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ВЫБОР
		|		КОГДА НЕ Заказ.Номенклатура ЕСТЬ NULL ТОГДА Заказ.Номенклатура
		|		КОГДА НЕ ЗаказПереработчику.Номенклатура ЕСТЬ NULL ТОГДА ЗаказПереработчику.Номенклатура
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Номенклатура, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ КАК Продукция,
		|	ВЫБОР
		|		КОГДА НЕ Заказ.Характеристика ЕСТЬ NULL ТОГДА Заказ.Характеристика
		|		КОГДА НЕ ЗаказПереработчику.Характеристика ЕСТЬ NULL ТОГДА ЗаказПереработчику.Характеристика
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Характеристика, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ КАК ХарактеристикаПродукции
		|ИЗ
		|	ВТКэшРасчетныеОборотыМатериалыИРаботыВПроизводстве КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
		|		ПО КорАналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Заказ
		|		ПО Заказ.Ссылка = ДД.ЗаказНаПроизводство
		|		И Заказ.КодСтроки = ДД.КодСтрокиПродукция
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ЗаказПереработчику
		|		ПО ЗаказПереработчику.Ссылка = ДД.ЗаказНаПроизводство
		|		И ЗаказПереработчику.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И НЕ ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|	И (ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат)
		|	И (ДД.СтатьяРасходов = НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.Склад,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ЗаказНаПроизводство,
		|	ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация)
		|		ИНАЧЕ ДД.ЗаказНаПроизводство
		|	КОНЕЦ,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.Назначение,
		|	ВЫБОР
		|		КОГДА НЕ Заказ.Номенклатура ЕСТЬ NULL ТОГДА Заказ.Номенклатура
		|		КОГДА НЕ ЗаказПереработчику.Номенклатура ЕСТЬ NULL ТОГДА ЗаказПереработчику.Номенклатура
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Номенклатура, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ Заказ.Характеристика ЕСТЬ NULL ТОГДА Заказ.Характеристика
		|		КОГДА НЕ ЗаказПереработчику.Характеристика ЕСТЬ NULL ТОГДА ЗаказПереработчику.Характеристика
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Характеристика, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ
		|";
	КонецФункции

Функция ТекстМаршрутныеЛисты()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстМаршрутныеЛисты"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И ДД.Заказано <> 0
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Организация,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.АналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстПрошлыеМаршрутныеЛисты()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПрошлыеМаршрутныеЛисты"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	МаршрутныйЛист.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР Продукция.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Продукция.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(Продукция.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Продукция.Номенклатура КАК Продукция,
		|	Продукция.Характеристика КАК ХарактеристикаПродукции
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РаспоряженияНаВыпускПродукции КАК Приходы
		|		ПО Приходы.Регистратор = ДД.Распоряжение
		|		И Приходы.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства.ВыходныеИзделия КАК Продукция
		|		ПО Продукция.Ссылка = МаршрутныйЛист.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Приходы.Регистратор ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Организация,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	Продукция.Номенклатура,
		|	Продукция.Характеристика
		|";
КонецФункции

Функция ТекстВыпускиПоЗаказам()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстВыпускиПоЗаказам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Заказано) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Аналитика.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.Склады
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	Аналитика.Назначение
		|";
КонецФункции
//-- НЕ УТКА

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределениеМатериаловНЗП(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура("Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");

	// расчетная партия заполняется на наибольшее общее вычитаемое
	ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
	
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Если РасчетнаяПартия.Количество = Приход.Количество Тогда
			РасчетнаяПартия[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ];
		Иначе
			РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ЗнаменательСписания * Приход[ИмяРесурса.Ключ] / Приход.Знаменатель, 2);
		КонецЕсли;
	КонецЦикла;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ЗатратыБезЗаказа
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.Знаменатель = Расход.КоличествоПродукции;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 И (Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Остаток
	  ИЛИ Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца) Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
	КонецЦикла;
	
	Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
	Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;

	// Заполняем партионную идентификацию в расчетной партии
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка();	
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ЗаказНаПроизводство)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.КодСтрокиПродукция)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Этап)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Спецификация)
		ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.Спецификация = Приход.Спецификация;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ЗатратыБезЗаказа
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ВыпускБезЗаказа
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Переработка
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОтчетДавальцу
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПродукцияДавальца Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Партия
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ЗатратыБезЗаказа Тогда
		РасчетнаяПартия.ДокументВыпуска = Приход.ДокументВыпуска;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ВидЗапасов)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПолуфабрикатДавальца Тогда
		РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
	КонецЕсли;
	
	РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Период)
	 И РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.ПродукцияДавальца Тогда
		РасчетнаяПартия.Период = Приход.Период;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Регистратор)
	 И РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.ПродукцияДавальца Тогда
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.Назначение) Тогда
		РасчетнаяПартия.Назначение = Приход.Назначение;
	КонецЕсли;
	
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
	Иначе
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
	КонецЕсли;
	
	РасчетнаяПартия.АналитикаУчетаПартий  	   = Приход.АналитикаУчетаПартий;
	РасчетнаяПартия.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры;
	РасчетнаяПартия.Подразделение 			   = Приход.Подразделение;
	РасчетнаяПартия.СтатьяКалькуляции 		   = Приход.СтатьяКалькуляции;
	
	РасчетнаяПартия.РасчетЗавершен 			   = Приход.РасчетЗавершен;
	
	Если РасчетнаяПартия.Количество = 0
	 И РасчетнаяПартия.Стоимость = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.ПостояннаяРазница = 0
	 И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
		
		РасчетнаяПартия.Знаменатель = 0;
		РасчетнаяПартия.РасчетЗавершен = Ложь;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//-- НЕ УТ

#Область ПроцедурыЭтапа8_ЗаполнениеПартийВРегистреСебестоимостьТоваров

// Инициализация данных

Функция ПоляПотребленийПартииТоваров(ПараметрыРасчета)
	
	Возврат "АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета";
	
КонецФункции

Функция ОписаниеЦепочекПартийТоваров(ПараметрыРасчета)
	
	// Важно: особенности использования типов записи в движениях, формируемых именно этим этапом.
	// Если на данном этапе сформирована запись с типом записи, используемым в макете регистра себестоимости,
	// (см. УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЭтоТолькоРасчетныйТипЗаписи())
	// то считается, что это "первичная" запись, в которой просто дозаполнены поля партионной идентификации.
	//	- признак "РасчетПартий" для такой записи устанавливается в значение Ложь.
	// Если сформирована запись с любым другим типом записи, то считается что это "расчетная" запись.
	//	- признак "РасчетПартий" для такой записи устанавливается в значение Истина.
	// Также можно "принудительно" установить РасчетПартий в значение Истина - с помощью поля запроса ЭтоТочноРасчетноеДвижение.
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийПартииТоваров(ПараметрыРасчета);
	
	// Потребление <- (Остаток, Партия, Перемещение, ПеремещениеОбособленно, Сторно, ВозвратПрошлыхПериодов)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, 		ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Остаток,				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Партия,				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Сторно, 				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений);
		
	// ПотреблениеАвто <- (Остаток, Партия, Перемещение, ПеремещениеОбособленно, Сторно)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Остаток,				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Партия,				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Сторно, 				ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений);
		
	// КорректировкаПоступления <- (Остаток, Партия)	
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.КорректировкаПоступления, ПоляПотреблений + ", Партия");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПоступления,
		Перечисления.ТипыЗаписейПартий.Остаток, 				 ПоляПотреблений + ", Партия");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПоступления,
		Перечисления.ТипыЗаписейПартий.Партия, 				 	 ПоляПотреблений + ", Партия");	
		
	// ДопРасходыБезПартии <- (Импорт)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии,	ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии,
		Перечисления.ТипыЗаписейПартий.Импорт, 				ПоляПотреблений);
	
	// Сторно <- (Потребление, ПотреблениеАвто)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Сторно, 				"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Потребление, 		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
		
	// ВозвратНаДругойСклад <- (Сторно)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Сторно, 				 "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	
	// Перемещение <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, ВозвратНаДругойСклад)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.Потребление, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад, 	"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация");
		
	// ПеремещениеОбособленно <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, ВозвратНаДругойСклад)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, 		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.Потребление, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, КорОрганизация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, КорОрганизация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, КорОрганизация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад, 	"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, КорОрганизация");
		
	// ПеремещениеАвто <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, Распределение)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто, 		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Потребление, 			"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Распределение, 			"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	
	// Распределение <- (Перемещение, ПеремещениеОбособленно, Остаток, Партия)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение, 		"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Остаток,				"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Партия,				"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация");
		
	// СписанияНаВыпуск <- (Перемещение, ПеремещениеОбособленно, ПеремещениеАвто, Партия, Остаток)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, 	"АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто, 	"АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Партия,				"АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Остаток,				"АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация, ЗаказНаПроизводство");
		
	// Выпуск <- (СписанияНаВыпуск, Трудозатраты)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск, 				"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, 	"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.Трудозатраты, 		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");	
		
	// ПотреблениеПроизводство <- (Партия, Перемещение, ПеремещениеОбособленно, Остаток)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Партия, 				"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Остаток,				"АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация");
		
	// СписаниеНаРасходы <- (Партия)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		Перечисления.ТипыЗаписейПартий.Партия, 				"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
		
	// ВозвратПрошлыхПериодов <- (Прошлое)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		Перечисления.ТипыЗаписейПартий.Прошлое, 			   "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	
	// Дополнение <- (<без источников - для формирования записей по данным запроса>)
	ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийПартийТоваров(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияПартийТоваров(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"ПартииСебестоимостиТоваров", // Контекст
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя, // ИмяРегистра
		ПереченьПолей(КолонкиТаблицыРаспределения), // ПоляРасчета
		ПоляПотребленийПартииТоваров(ПараметрыРасчета), // КлючиСравнения
		"Знаменатель, Количество, Стоимость, СтоимостьБезНДС, СуммаДопРасходов, СуммаДопРасходовБезНДС,
			|СтоимостьРегл, ПостояннаяРазница, ВременнаяРазница,
			|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеСНДС, ПостатейныеБезНДС,
			|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл", // Показатели
		"Количество", // БазисПрихода
		"Количество", // БазисРасхода
		"ДокументИсточник", // КлючРасхода
		"Период", // ПолеПорядка
		"Партия, ВидДеятельностиНДС, АналитикаФинансовогоУчета", // ПоляСортировки
		Истина); // СортировкаПоУсловию
		
	ОписаниеДвижений.Вставить("ЕстьСторно", Истина);
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхПартийТоваров(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	Для Каждого ТекЭлемент Из ПараметрыРасчета.НепересчитываемыеТипыЗаписей Цикл
		НезаписываемыеТипыЗаписей.Вставить(ТекЭлемент, Истина);
	КонецЦикла;
	
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Импорт, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Трудозатраты, Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	НезаписываемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Истина, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияПартийТоваров(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПартийТоваров());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПартийТоваров(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстИнициализацияПартийТоваров() // вт АналитикаДавальца, Декларации, ПрошлыеРеализации, ПродукцияДавальца, ЕстьДекларации, Выпуски
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийТоваров() // вт Данные
		+ ТекстОбъединениеЗапросов() + ТекстНачальныеОстаткиПартийТоваров()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеОборотыПартийТоваров()
		//++ НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеОборотыПроизводственныхЗатрат()
		+ ТекстОбъединениеЗапросов() + ТекстРаспределенияНаЗаказыНаПроизводство()
		//-- НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстНачальныеОстаткиЗакупокПоИмпорту()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеЗакупкиПоИмпорту()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеДопРасходыКРаспределению() // использует Декларации
		+ ТекстОбъединениеЗапросов() + ТекстРеализацииПрошлыхМесяцев() // использует ПрошлыеРеализации 
		//++ НЕ УТ
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеПриходыПартийНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеРасходыПартийНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеСписанияЗатратНаВыпуск()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеВыпускиПродукции()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеРасходыМатериаловВПроизводстве()
		+ ТекстОбъединениеЗапросов() + ТекстТекущиеРасходыТрудозатратыНЗП()
		//-- НЕ УТ
		+ "";
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатуры", // разделитель
		"Знаменатель, Количество,
			|Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СуммаДопРасходов, СуммаДопРасходовБезНДС,
			|Трудозатраты, ПостатейныеСНДС, ПостатейныеБезНДС,
			|СтоимостьРегл, СтоимостьЗабалансоваяРегл, ПостояннаяРазница, ВременнаяРазница,
			|ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл", // ресурсы
		"Номенклатура УБЫВ, Приоритет ВОЗР, Период, Организация, ВидЗапасов,
			|Партия, АналитикаУчетаПартий, Регистратор, ВидДвижения УБЫВ"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
		
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"АналитикаДавальца, Декларации, ПрошлыеРеализации, ОстаткиИмпорт, ЕстьДекларации
		//++ НЕ УТ
		|, Выпуски
		//-- НЕ УТ
		|");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийТоваров()
	Возврат 
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 					КАК ЗапросИсточник,
		|	Т.ТипЗаписи										КАК ТипЗаписи,
		|	ЛОЖЬ											КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ											КАК Сторно,
		|	0 												КАК Приоритет,
		|	0 												КАК Знаменатель,
		|	ЛОЖЬ 											КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)  КАК Номенклатура,
		|	Т.АналитикаУчетаПартий.НалогообложениеНДС 		КАК НалогообложениеПартии,
		|	Т.ВидДеятельностиНДС 							КАК НалогообложениеНДС,
		|	Т.Период										КАК Период,
		|	Т.Период										КАК ПериодПоступления,
		|	Т.Регистратор									КАК Регистратор,
		|	Т.ВидДвижения 									КАК ВидДвижения,
		|
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета,
		|	Т.ВидЗапасов,
		|	Т.Организация,
		|	Т.Партия,
		|	Т.Партия КАК ЗаказНаПроизводство,
		|	Т.АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета,
		|	Т.ВидДеятельностиНДС,
		|
		|	Т.Количество,
		|	Т.Стоимость,
		|	Т.СтоимостьБезНДС,
		|	Т.СтоимостьЗабалансовая,
		|	Т.СуммаДопРасходов,
		|	Т.СуммаДопРасходовБезНДС,
		|	Т.Трудозатраты,
		|	Т.ПостатейныеСНДС,
		|	Т.ПостатейныеБезНДС,
		|	Т.СтоимостьРегл,
		|	Т.СтоимостьЗабалансоваяРегл,
		|	Т.ПостояннаяРазница,
		|	Т.ВременнаяРазница,
		|	Т.ДопРасходыРегл,
		|	Т.ТрудозатратыРегл,
		|	Т.ПостатейныеРегл,
		|
		|	Т.ХозяйственнаяОперация,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорРазделУчета,
		|	Т.КорВидЗапасов,
		|	Т.КорОрганизация,
		|	Т.КорСтоимость,
		|	Т.АналитикаУчетаПоПартнерам,
		|	Т.ЗаказКлиента,
		|	Т.Подразделение,
		|	Т.АналитикаРасходов,
		|	Т.СтатьяРасходовСписания,
		|	Т.СтатьяДоходов,
		|	Т.АналитикаДоходов,
		|	Т.ПериодПродажи,
		|	Т.СтатьяАктивовПассивов,
		|	Т.АналитикаАктивовПассивов,
		|	Т.ДокументДвижения,
		|	Т.ИдентификаторСтроки,
		|	Т.ГруппаПродукции,
		|	Т.КорПартия,
		|	Т.КорАналитикаУчетаПартий,
		|	Т.КорАналитикаФинансовогоУчета,
		|	Т.КорВидДеятельностиНДС,
		|	Т.НДСРегл,
		|	Т.СтатьяКалькуляции,
		|	Т.ДокументИсточник,
		|	Т.АналитикаУчетаПартийПроизводства,
		|	Т.КодСтроки
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстИнициализацияПартийТоваров() // вт АналитикаДавальца, Декларации, ПрошлыеРеализации, ПродукцияДавальца, ЕстьДекларации, Выпуски
	Возврат "
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам
		|ПОМЕСТИТЬ АналитикаДавальца
		|
		//++ НЕ УТКА
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	МАКСИМУМ(ДД.АналитикаУчетаПоПартнерам) КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|	И ДД.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|	И НЕ ДД.РасчетПартий
		|	И НЕ ДД.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор
		//-- НЕ УТКА
		|;
		|ВЫБРАТЬ
		|	ДД.Ссылка,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА Строки.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КОНЕЦ) КАК ВидЗапасов,
		|	СУММА(Строки.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	Декларации
		|ИЗ
		|	Документ.ТаможеннаяДекларацияИмпорт КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА Строки.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КОНЕЦ)
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументИсточник КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов
		|ПОМЕСТИТЬ
		|	ПрошлыеРеализации
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И ДД.Количество > 0
		|;
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов
		|ПОМЕСТИТЬ
		|	ПродукцияДавальца
		|
		//++ НЕ УТКА
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.КорВидЗапасов
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Аналитика.Назначение.Заказ
		|ГДЕ
		|	ДД.Количество <> 0
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	И &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.КорВидЗапасов
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Количество <> 0
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|	И НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		//-- НЕ УТКА
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ИСТИНА КАК ДокументПоступленияЗаполнен
		|ПОМЕСТИТЬ ВтТоварыОрганизацийКОформлению
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизацийКОформлению КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.ДокументПоступления <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка)
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Остатки.Партия КАК Партия,
		|	НАЧАЛОПЕРИОДА(Импорт.Дата, МЕСЯЦ) КАК Дата
		|ПОМЕСТИТЬ ОстаткиИмпорт
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&МассивОрганизаций)
		|	) КАК Остатки
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК Импорт
		|		ПО Импорт.Ссылка = Остатки.Партия
		|		И Импорт.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		|;
		|ВЫБРАТЬ
		|	ДД.Партия КАК Партия,
		|	МАКСИМУМ(ДД.Дата) КАК Дата
		|ПОМЕСТИТЬ ЕстьДекларации
		|ИЗ
		|	(ВЫБРАТЬ
		|		Партии.Партия КАК Партия,
		|		МАКСИМУМ(Декларации.Дата) КАК Дата
		|	ИЗ
		|		Документ.ТаможеннаяДекларацияИмпорт КАК Декларации
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Партии
		|			ПО Партии.Регистратор = Декларации.Ссылка
		|	ГДЕ
		|		Декларации.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И Декларации.Проведен
		|		И Партии.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|	СГРУППИРОВАТЬ ПО
		|		Партии.Партия
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Остатки.Партия КАК Партия,
		|		МАКСИМУМ(Декларации.Дата) КАК Дата
		|	ИЗ
		|		ОстаткиИмпорт КАК Остатки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Партии
		|			ПО Партии.Партия = Остатки.Партия
		|			И Партии.Период МЕЖДУ Остатки.Дата И &НачалоПериода
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт КАК Декларации
		|			ПО Партии.Регистратор = Декларации.Ссылка
		|	ГДЕ
		|		Партии.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|	СГРУППИРОВАТЬ ПО
		|		Остатки.Партия
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Партии.ДокументПоступления КАК Партия,
		|		МАКСИМУМ(Декларации.Дата) КАК Дата
		|	ИЗ
		|		Документ.ТаможеннаяДекларацияИмпорт КАК Декларации
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт.Товары КАК Партии
		|			ПО Партии.Ссылка = Декларации.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|			ПО Партии.Ссылка = СебестоимостьТоваров.Регистратор
		|	ГДЕ
		|		Декларации.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И СебестоимостьТоваров.Регистратор ЕСТЬ NULL
		|		И НЕ Партии.ДокументПоступления = ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка)
		|		И Декларации.Проведен
		|	СГРУППИРОВАТЬ ПО
		|		Партии.ДокументПоступления
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Остатки.Партия КАК Партия,
		|		МАКСИМУМ(Декларации.Дата) КАК Дата
		|	ИЗ
		|		ОстаткиИмпорт КАК Остатки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт.Товары КАК Партии
		|			ПО Партии.ДокументПоступления = Остатки.Партия
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт КАК Декларации
		|			ПО Партии.Ссылка = Декларации.Ссылка
		|			И Декларации.Дата МЕЖДУ Остатки.Дата И &НачалоПериода
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|			ПО Партии.Ссылка = СебестоимостьТоваров.Регистратор
		|	ГДЕ
		|		СебестоимостьТоваров.Регистратор ЕСТЬ NULL
		|		И НЕ Партии.ДокументПоступления = ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка)
		|		И Декларации.Проведен
		|	СГРУППИРОВАТЬ ПО
		|		Остатки.Партия
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Партия
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Партия
		//++ НЕ УТ
		|;
		|
		|ВЫБРАТЬ
		|	Выпуски.Ссылка					КАК ЗаказНаПроизводство,
		|	Выпуски.КодСтроки				КАК КодСтрокиПродукция,
		|	МАКСИМУМ(Выпуски.Количество)	КАК Знаменатель,
		|	ВЫБОР
		|		КОГДА ДокументыВыпуска.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|				И Выпуски.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|				И Выпуски.ВидЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА ВЫБОР
		|					КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|						ТОГДА Выпуски.АналитикаУчетаНоменклатуры
		|					ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|				КОНЕЦ
		|		КОГДА Выпуски.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|			И ДокументыВыпуска.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ВЫБОР
		|					КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|						ТОГДА АналитикаВПодразделении.КлючАналитики
		|					ИНАЧЕ КлючиПодразделенияБезНазначения.КлючАналитики
		|				КОНЕЦ
		|		ИНАЧЕ Выпуски.АналитикаУчетаНоменклатуры
		|	КОНЕЦ							КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА Выпуски.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|	КОНЕЦ							КАК ВидЗапасов
		|ПОМЕСТИТЬ Выпуски
		|ИЗ
		|	ВТКэшРасчетныеОборотыМатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.ЗаказНаПроизводство
		|		И Выпуски.КодСтроки = ДД.КодСтрокиПродукция
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК ДокументыВыпуска
		|		ПО ДокументыВыпуска.Ссылка = Выпуски.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукции
		|		ПО Выпуски.АналитикаУчетаНоменклатуры = АналитикаПродукции.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|		ПО АналитикаПродукции.Номенклатура = АналитикаБезНазначения.Номенклатура
		|		И АналитикаПродукции.Характеристика = АналитикаБезНазначения.Характеристика
		|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = АналитикаБезНазначения.СтатьяКалькуляции
		|		И АналитикаПродукции.Серия = АналитикаБезНазначения.Серия
		|		И АналитикаПродукции.Склад = АналитикаБезНазначения.Склад
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|		ПО Выпуски.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И Выпуски.Характеристика = АналитикаВПодразделении.Характеристика
		|		И Выпуски.Назначение = АналитикаВПодразделении.Назначение
		|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = АналитикаВПодразделении.СтатьяКалькуляции
		|		И (ДокументыВыпуска.Подразделение = АналитикаВПодразделении.Склад И Выпуски.СписатьНаРасходы
		|			ИЛИ Выпуски.Подразделение = АналитикаВПодразделении.Склад И НЕ Выпуски.СписатьНаРасходы)
		|		И АналитикаПродукции.Серия = АналитикаВПодразделении.Серия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиПодразделенияБезНазначения
		|		ПО АналитикаВПодразделении.Номенклатура = КлючиПодразделенияБезНазначения.Номенклатура
		|		И АналитикаВПодразделении.Характеристика = КлючиПодразделенияБезНазначения.Характеристика
		|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = КлючиПодразделенияБезНазначения.СтатьяКалькуляции
		|		И АналитикаВПодразделении.Серия = КлючиПодразделенияБезНазначения.Серия
		|		И АналитикаВПодразделении.Склад = КлючиПодразделенияБезНазначения.Склад
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)= КлючиПодразделенияБезНазначения.Назначение
		|
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И Выпуски.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА Выпуски.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|	КОНЕЦ,
		|	Выпуски.Ссылка,
		|	ВЫБОР
		|		КОГДА ДокументыВыпуска.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|				И Выпуски.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|				И Выпуски.ВидЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА ВЫБОР
		|					КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|						ТОГДА Выпуски.АналитикаУчетаНоменклатуры
		|					ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|				КОНЕЦ
		|		КОГДА Выпуски.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|				И ДокументыВыпуска.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ВЫБОР
		|					КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|						ТОГДА АналитикаВПодразделении.КлючАналитики
		|					ИНАЧЕ КлючиПодразделенияБезНазначения.КлючАналитики
		|				КОНЕЦ
		|		ИНАЧЕ Выпуски.АналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	Выпуски.КодСтроки
		//-- НЕ УТ
		|";

КонецФункции

// ... выборки данных

Функция ТекстНачальныеОстаткиПартийТоваров() // использует ЕстьДекларации
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийТоваров"" 			 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ЛОЖЬ											 КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА Т.КоличествоОстаток < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)							 КАК Сторно,
		|	0 												 КАК Приоритет,
		|	0 												 КАК Знаменатель,
		|	ИСТИНА 											 КАК РасчетЗавершен,
		|	Т.АналитикаУчетаНоменклатуры.Номенклатура 		 КАК Номенклатура,
		|	Т.АналитикаУчетаПартий.НалогообложениеНДС 		 КАК НалогообложениеПартии,
		|	Т.ВидДеятельностиНДС 							 КАК НалогообложениеНДС,
		|
		|	ЕСТЬNULL(ЕстьДекларации.Дата,
		|		ЕСТЬNULL(Периодика.ДатаРегистратора,
		|			&КонецПредыдущегоПериода))				 КАК Период,
		|	ЕСТЬNULL(ЕстьДекларации.Дата,
		|		ЕСТЬNULL(Периодика.ДатаРегистратора,
		|			&КонецПредыдущегоПериода))				 КАК ПериодПоступления,
		|	(ВЫБОР
		|		КОГДА Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА Т.Партия
		//++ НЕ УТКА
		|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|		 И Т.Партия ССЫЛКА Документ.ЗаказНаПроизводство
		|			ТОГДА НЕОПРЕДЕЛЕНО
		//-- НЕ УТКА
		|		ИНАЧЕ Т.Партия КОНЕЦ)						 КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО 			 	 					 КАК ВидДвижения,
		|	Т.АналитикаУчетаНоменклатуры 					 КАК АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета				 					 КАК РазделУчета,
		|	Т.ВидЗапасов				 					 КАК ВидЗапасов,
		|	Т.Организация				 					 КАК Организация,
		|	Т.Партия					 					 КАК Партия,
		|	ВЫБОР
		|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		//++ НЕ УТКА
		|			ИЛИ Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|				И ТИПЗНАЧЕНИЯ(Т.Партия) = ТИП(Документ.ЗаказНаПроизводство)
		//-- НЕ УТКА
		|			ТОГДА Т.Партия
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ											 КАК ЗаказНаПроизводство,
		|	Т.АналитикаУчетаПартий		 					 КАК АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета  					 КАК АналитикаФинансовогоУчета,
		|	Т.ВидДеятельностиНДС		 					 КАК ВидДеятельностиНДС,
		|
		|	Т.КоличествоОстаток 							 КАК Количество,
		|	Т.СтоимостьОстаток 								 КАК Стоимость,
		|	Т.СтоимостьБезНДСОстаток 						 КАК СтоимостьБезНДС,
		|	Т.СтоимостьЗабалансоваяОстаток 					 КАК СтоимостьЗабалансовая,
		|	Т.СуммаДопРасходовОстаток 						 КАК СуммаДопРасходов,
		|	Т.СуммаДопРасходовБезНДСОстаток 				 КАК СуммаДопРасходовБезНДС,
		|	Т.ТрудозатратыОстаток 							 КАК Трудозатраты,
		|	Т.ПостатейныеСНДСОстаток 						 КАК ПостатейныеСНДС,
		|	Т.ПостатейныеБезНДСОстаток 						 КАК ПостатейныеБезНДС,
		|	Т.СтоимостьРеглОстаток 							 КАК СтоимостьРегл,
		|	Т.СтоимостьЗабалансоваяРеглОстаток 				 КАК СтоимостьЗабалансоваяРегл,
		|	Т.ПостояннаяРазницаОстаток 						 КАК ПостояннаяРазница,
		|	Т.ВременнаяРазницаОстаток 						 КАК ВременнаяРазница,
		|	Т.ДопРасходыРеглОстаток 						 КАК ДопРасходыРегл,
		|	Т.ТрудозатратыРеглОстаток 						 КАК ТрудозатратыРегл,
		|	Т.ПостатейныеРеглОстаток 						 КАК ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 				КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) 		КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) 	КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 							КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) 							КАК КорОрганизация,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК КорСтоимость,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) 		КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО 															КАК ЗаказКлиента,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 					КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 			КАК СтатьяРасходовСписания,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) 			КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаДоходов,
		|	ДАТАВРЕМЯ(1, 1, 1) 														КАК ПериодПродажи,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) 	КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК ДокументДвижения,
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(36)) 											КАК ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО 															КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) 			КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО 															КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 				КАК КорВидДеятельностиНДС,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК НДСРегл,
		|	НЕОПРЕДЕЛЕНО															КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО															КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО															КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО															КАК КодСтроки
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,	Организация В (&МассивОрганизаций)) КАК Т
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК Импорт
		|		ПО Импорт.Ссылка = Т.Партия
		|		И Импорт.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьДекларации КАК ЕстьДекларации
		|		ПО ЕстьДекларации.Партия = Т.Партия
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК Периодика
		|		ПО Периодика.Организация = Т.Организация
		|		И Периодика.Документ = Т.Партия
		|ГДЕ
		|	НЕ (НЕ Импорт.Ссылка ЕСТЬ NULL И ЕстьДекларации.Партия ЕСТЬ NULL)
		|";
КонецФункции

Функция ТекстТекущиеОборотыПартийТоваров() // использует ЕстьДекларации
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеОборотыПартийТоваров"" 						КАК ЗапросИсточник,
		|	Т.ТипЗаписи 												КАК ТипЗаписи,
		|	ЛОЖЬ														КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА Т.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)										КАК Сторно,
		|	(ВЫБОР
		|		КОГДА НЕ Т.СлужебноеВидДвиженияПриход И Т.Регистратор ССЫЛКА Документ.КорректировкаВидаДеятельностиНДС ТОГДА 15
		|		КОГДА Т.СлужебноеВидДвиженияПриход И Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) ТОГДА 10
		|		ИНАЧЕ 90 КОНЕЦ)											КАК Приоритет,
		|	0 															КАК Знаменатель,
		|	ВЫБОР КОГДА Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей)
		|		ИЛИ Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		//++ НЕ УТ
		|				ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ 														КАК РасчетЗавершен,
		|	Аналитика.Номенклатура										КАК Номенклатура,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		//++ НЕ УТ
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|		ТОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ 														КАК НалогообложениеПартии,
		|	Т.ВидДеятельностиНДС 										КАК НалогообложениеНДС,
		|
		|	Т.Период КАК Период,
		|	ВЫБОР КОГДА Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПоступления)
		|		ТОГДА &НачалоПериода
		|		ИНАЧЕ ЕСТЬNULL(ЕстьДекларации.Дата, Т.Период)
		|	КОНЕЦ КАК ПериодПоступления,
		|	Т.Регистратор,
		|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета,
		|	Т.ВидЗапасов,
		|	Т.Организация,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей)
		|				И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|		ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПоступления)
		|		ИЛИ Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		//++ НЕ УТ
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|			ТОГДА Т.Партия
		|		КОГДА ВозвратыТоваровПоставщику.ДокументПоступления ЕСТЬ НЕ NULL
		|				И Т.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ВозвратыТоваровПоставщику.ДокументПоступления
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей)
		|				И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|		ИЛИ Т.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИЛИ Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		//++ НЕ УТ
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|		ТОГДА Т.АналитикаУчетаПартий
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК АналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей)
		|			ИЛИ Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		//++ НЕ УТ
		|			ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|			ТОГДА Т.АналитикаФинансовогоУчета
		|		КОГДА ТИПЗНАЧЕНИЯ(Т.АналитикаФинансовогоУчета) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
		|			И НЕ Т.АналитикаФинансовогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
		|			И Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И Т.СлужебноеВидДвиженияПриход
		|			ТОГДА Т.АналитикаФинансовогоУчета
		//++ НЕ УТКА
		|		КОГДА &ПартионныйУчетВерсии22
		|			И Т.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства))
		|			ТОГДА Т.ГруппаПродукции
		//-- НЕ УТКА
		|		ИНАЧЕ Т.КорАналитикаФинансовогоУчета
		|	КОНЕЦ КАК АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей)
		//++ НЕ УТ
		|		 ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|			ТОГДА Т.ВидДеятельностиНДС
		|		КОГДА НЕ КорректировкаНДС.НалогообложениеНДС ЕСТЬ NULL И НЕ Т.СлужебноеВидДвиженияПриход
		|			ТОГДА КорректировкаНДС.НалогообложениеНДС
		|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт)
		|		 И Аналитика.Номенклатура.СырьевойТовар
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|		КОГДА Т.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт)
		|		 И НЕ Аналитика.Номенклатура.СырьевойТовар
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|
		|	Т.Количество,
		|	Т.Стоимость,
		|	Т.СтоимостьБезНДС,
		|	Т.СтоимостьЗабалансовая,
		|	Т.СуммаДопРасходов,
		|	Т.СуммаДопРасходовБезНДС,
		|	Т.Трудозатраты,
		|	Т.ПостатейныеСНДС,
		|	Т.ПостатейныеБезНДС,
		|	Т.СтоимостьРегл,
		|	Т.СтоимостьЗабалансоваяРегл,
		|	Т.ПостояннаяРазница,
		|	Т.ВременнаяРазница,
		|	Т.ДопРасходыРегл,
		|	Т.ТрудозатратыРегл,
		|	Т.ПостатейныеРегл,
		|
		|	Т.ХозяйственнаяОперация,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорРазделУчета,
		|	Т.КорВидЗапасов,
		|	Т.КорОрганизация,
		|	Т.КорСтоимость,
		|	Т.АналитикаУчетаПоПартнерам,
		|	Т.ЗаказКлиента,
		|	Т.Подразделение,
		|	Т.АналитикаРасходов,
		|	Т.СтатьяРасходовСписания,
		|	Т.СтатьяДоходов,
		|	Т.АналитикаДоходов,
		|	Т.ПериодПродажи,
		|	Т.СтатьяАктивовПассивов,
		|	Т.АналитикаАктивовПассивов,
		|	Т.ДокументДвижения,
		|	Т.ИдентификаторСтроки,
		|	Т.ГруппаПродукции,
		|	ВЫБОР КОГДА Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			И Т.КорПартия <> Т.Регистратор
		//++ НЕ УТ
		|			И Т.КорАналитикаУчетаНоменклатуры.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Т.КорПартия
		|	КОНЕЦ КАК КорПартия,
		|	ВЫБОР КОГДА Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			И Т.КорПартия <> Т.Регистратор
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Т.КорАналитикаУчетаПартий
		|	КОНЕЦ КАК КорАналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(Т.АналитикаФинансовогоУчета) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
		|			И НЕ Т.АналитикаФинансовогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
		|			И Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			И НЕ Т.СлужебноеВидДвиженияПриход
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Т.КорАналитикаФинансовогоУчета
		|	КОНЕЦ КАК КорАналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА НЕ Перемещение.ПеремещениеПодДеятельность ЕСТЬ NULL И НЕ Т.СлужебноеВидДвиженияПриход
		|			ТОГДА Перемещение.ПеремещениеПодДеятельность
		|		ИНАЧЕ Т.КорВидДеятельностиНДС
		|	КОНЕЦ КАК КорВидДеятельностиНДС,
		|	Т.НДСРегл,
		|	Т.СтатьяКалькуляции,
		|	ВЫБОР
		|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|			ТОГДА Т.ДокументИсточник
		|		КОГДА НЕ Т.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Т.ДокументИсточник
		|	КОНЕЦ КАК ДокументИсточник,
		|	Т.АналитикаУчетаПартийПроизводства,
		|	Т.КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = Т.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтТоварыОрганизацийКОформлению КАК ТоварыКОформлению
		|		ПО ТоварыКОформлению.Регистратор = Т.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК Импорт
		|		ПО Импорт.Ссылка = Т.Регистратор
		|		И Импорт.Ссылка = ТоварыКОформлению.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьДекларации КАК ЕстьДекларации
		|		ПО ЕстьДекларации.Партия = Т.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаВидаДеятельностиНДС КАК КорректировкаНДС
		|		ПО КорректировкаНДС.Ссылка = Т.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров КАК Перемещение
		|		ПО Перемещение.Ссылка = Т.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику.ВидыЗапасов КАК ВозвратыТоваровПоставщику
		|		ПО ВозвратыТоваровПоставщику.Ссылка = Т.Регистратор
		|		И Т.ИдентификаторСтроки = ВозвратыТоваровПоставщику.ИдентификаторСтроки
		|ГДЕ
		|	Т.Количество <> 0
		|	И (НЕ (НЕ Импорт.Ссылка ЕСТЬ NULL
		|			И ЕстьДекларации.Партия ЕСТЬ NULL)
		|		И Т.Организация В (&ОрганизацииСФИФОСкользящая)
		|		ИЛИ НЕ Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстТекущиеОборотыПроизводственныхЗатрат()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТекущиеОборотыПроизводственныхЗатрат"" 	  			КАК ЗапросИсточник,
		|	ВЫБОР КОГДА
		|		Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ИНАЧЕ Т.ТипЗаписи
		|	КОНЕЦ														КАК ТипЗаписи,
		|	ИСТИНА														КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ														КАК Сторно,
		|	45 										  					КАК Приоритет,
		|	0 										  					КАК Знаменатель,
		|	ВЫБОР КОГДА Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ 														КАК РасчетЗавершен,
		|	Т.АналитикаУчетаНоменклатуры.Номенклатура 					КАК Номенклатура,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ТОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ 														КАК НалогообложениеПартии,
		|	Т.ВидДеятельностиНДС 										КАК НалогообложениеНДС,
		|
		|	Т.Период,
		|	Т.Период КАК ПериодПоступления,
		|	Т.Регистратор,
		|	Т.ВидДвижения,
		|	Т.АналитикаУчетаНоменклатуры,
		|	Т.РазделУчета,
		|	Т.ВидЗапасов,
		|	Т.Организация,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ТОГДА Т.Партия
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ВЫБОР КОГДА (Т.ТипЗаписи В (&НепересчитываемыеТипыЗаписей) И Т.Организация В (&ОрганизацииСФИФОСкользящая))
		|		ИЛИ Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		ТОГДА Т.АналитикаУчетаПартий
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК АналитикаУчетаПартий,
		|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	Т.Количество,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|
		|	Т.ХозяйственнаяОперация,
		|	Т.КорАналитикаУчетаНоменклатуры,
		|	Т.КорРазделУчета,
		|	Т.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	Т.АналитикаРасходов,
		|	Т.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	Т.СтатьяАктивовПассивов,
		|	Т.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО,
		|	Т.ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО,
		|	ВЫБОР КОГДА Т.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			И Т.КорПартия <> Т.Регистратор
		|		И НЕ Т.КорПартия Ссылка Документ.ЭтапПроизводства2_2 И НЕ Т.КорПартия Ссылка Документ.ПроизводствоБезЗаказа
		|		ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Т.КорПартия
		|	КОНЕЦ КАК КорПартия,
		|	Т.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	Т.КорАналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
		|	Т.КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО,
		|	Т.АналитикаУчетаПартийПроизводства,
		|	Т.КодСтроки
		|ИЗ
		|	ВтПроизводственныеЗатратыСебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Количество <> 0
		|";
КонецФункции

Функция ТекстРаспределенияНаЗаказыНаПроизводство()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстРаспределенияНаЗаказыНаПроизводство"" 	      	  КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение)	  КАК ТипЗаписи,
		|	ЛОЖЬ													  КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)									  КАК Сторно,
		|	90 										  				  КАК Приоритет,
		|	ДД.Количество							  				  КАК Знаменатель,
		|	ЛОЖЬ 													  КАК РасчетЗавершен,
		|	Аналитика.Номенклатура 									  КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КлючиАналитики.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ЗаказПроизводство.ПроизводствоПоЗаказу ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА &АналитическийУчетПоГруппамПродукции
		|			И НЕ ДД.Продукция.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.Продукция.ГруппаАналитическогоУчета
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ													 КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО											 КАК ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КлючиАналитики.КлючАналитики
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтрокиПродукция КАК КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказПроизводство
		|		ПО ЗаказПроизводство.Ссылка = ДД.ЗаказНаПроизводство
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитики
		|		ПО КлючиАналитики.Номенклатура = Аналитика.Номенклатура
		|			И КлючиАналитики.Характеристика = Аналитика.Характеристика
		|			И КлючиАналитики.Серия = Аналитика.Серия
		|			И КлючиАналитики.Склад = Аналитика.Склад
		|			И КлючиАналитики.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|			И КлючиАналитики.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|";
КонецФункции

//-- НЕ УТКА

Функция ТекстНачальныеОстаткиЗакупокПоИмпорту()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиЗакупокПоИмпорту"" 	  	КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Импорт) КАК ТипЗаписи,
		|	ЛОЖЬ											КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ											КАК Сторно,
		|	0 										  		КАК Приоритет,
		|	0								  				КАК Знаменатель,
		|	ИСТИНА 											КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 		КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 		КАК НалогообложениеПартии,
		|	ДД.ВидДеятельностиНДС 					  		КАК НалогообложениеНДС,
		|
		|	&КонецПредыдущегоПериода 	 					КАК Период,
		|	&КонецПредыдущегоПериода 	 					КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО 			 	 					КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО 			 	 					КАК ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.КоличествоОстаток КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 КАК ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 				КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) 		КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) 	КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 							КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) 							КАК КорОрганизация,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК КорСтоимость,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) 		КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО 															КАК ЗаказКлиента,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 					КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 			КАК СтатьяРасходовСписания,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) 			КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаДоходов,
		|	ДАТАВРЕМЯ(1, 1, 1) 														КАК ПериодПродажи,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) 	КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК ДокументДвижения,
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(36)) 											КАК ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО 															КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) 			КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО 															КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 				КАК КорВидДеятельностиНДС,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК НДСРегл,
		|	НЕОПРЕДЕЛЕНО															КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО 															КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,	Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Партия
		|ГДЕ
		|	Поступление.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|";
КонецФункции

Функция ТекстТекущиеЗакупкиПоИмпорту()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеЗакупкиПоИмпорту"" 	  				 		 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Импорт) 			 КАК ТипЗаписи,
		|	ЛОЖЬ														 КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ														 КАК Сторно,
		|	10 										  					 КАК Приоритет,
		|	0								  							 КАК Знаменатель,
		|	ИСТИНА 														 КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 					 КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 					 КАК НалогообложениеПартии,
		|	ДД.ВидДеятельностиНДС 					  					 КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 КАК ПостатейныеРегл,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорСтоимость,
		|	ДД.АналитикаУчетаПоПартнерам,
		|	ДД.ЗаказКлиента,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяДоходов,
		|	ДД.АналитикаДоходов,
		|	ДД.ПериодПродажи,
		|	ДД.СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ДД.ГруппаПродукции,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|";
КонецФункции

Функция ТекстТекущиеДопРасходыКРаспределению() // Использует Декларации
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеДопРасходыКРаспределению"" 	  				КАК ЗапросИсточник,
		|	ДД.ТипЗаписи 							  					КАК ТипЗаписи,
		|	ЛОЖЬ														КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ														КАК Сторно,
		|	10 										  					КАК Приоритет,
		|	МАКСИМУМ(Декларации.Количество)			  					КАК Знаменатель,
		|	ЛОЖЬ 														КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 					КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО 												КАК НалогообложениеПартии,
		|	ДД.ВидДеятельностиНДС 					  					КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьЗабалансовая) КАК СтоимостьЗабалансовая,
		|	СУММА(ДД.СуммаДопРасходов) КАК СуммаДопРасходов,
		|	СУММА(ДД.СуммаДопРасходовБезНДС) КАК СуммаДопРасходовБезНДС,
		|	СУММА(ДД.Трудозатраты) КАК Трудозатраты,
		|	СУММА(ДД.ПостатейныеСНДС) КАК ПостатейныеСНДС,
		|	СУММА(ДД.ПостатейныеБезНДС) КАК ПостатейныеБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	СУММА(ДД.ДопРасходыРегл) КАК ДопРасходыРегл,
		|	СУММА(ДД.ТрудозатратыРегл) КАК ТрудозатратыРегл,
		|	СУММА(ДД.ПостатейныеРегл) КАК ПостатейныеРегл,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорСтоимость,
		|	ДД.АналитикаУчетаПоПартнерам,
		|	ДД.ЗаказКлиента,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяДоходов,
		|	ДД.АналитикаДоходов,
		|	ДД.ПериодПродажи,
		|	ДД.СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Декларации КАК Декларации
		|		ПО Декларации.Ссылка = ДД.Регистратор
		|		И Декларации.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Декларации.ВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорСтоимость,
		|	ДД.АналитикаУчетаПоПартнерам,
		|	ДД.ЗаказКлиента,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяДоходов,
		|	ДД.АналитикаДоходов,
		|	ДД.ПериодПродажи,
		|	ДД.СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ДД.ГруппаПродукции,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	ДД.КодСтроки
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцев() // использует ПрошлыеРеализации 
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцев"" 	  			 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ											 КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ											 КАК Сторно,
		|	0 										  		 КАК Приоритет,
		|	0								  				 КАК Знаменатель,
		|	ИСТИНА 											 КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 		 КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 		 КАК НалогообложениеПартии,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ											 КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ											 КАК ВидДеятельностиНДС,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 КАК ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 				КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) 		КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) 	КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 							КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) 							КАК КорОрганизация,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК КорСтоимость,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) 		КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО 															КАК ЗаказКлиента,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 					КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 			КАК СтатьяРасходовСписания,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) 			КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаДоходов,
		|	ДАТАВРЕМЯ(1, 1, 1) 														КАК ПериодПродажи,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) 	КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО 															КАК ДокументДвижения,
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(36)) 											КАК ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО 															КАК КорПартия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) 			КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО 															КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 				КАК КорВидДеятельностиНДС,
		|	ВЫРАЗИТЬ(0 КАК ЧИСЛО(15,2)) 											КАК НДСРегл,
		|	НЕОПРЕДЕЛЕНО															КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО 															КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализации КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументРеализации
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РасчетСебестоимости
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|";
КонецФункции

//++ НЕ УТ

Функция ТекстТекущиеПриходыПартийНЗП()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеПриходыПартийНЗП"" 	      				  КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)  КАК ТипЗаписи,
		|	ЛОЖЬ													  КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)									  КАК Сторно,
		|	95 										  				  КАК Приоритет,
		|	ДД.Количество							  				  КАК Знаменатель,
		|	ЛОЖЬ 													  КАК РасчетЗавершен,
		|	Аналитика.Номенклатура 									  КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КлючиАналитики.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	ДД.ЗаказНаПроизводство КАК Партия,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтрокиПродукция КАК КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитики
		|		ПО КлючиАналитики.Номенклатура = Аналитика.Номенклатура
		|			И КлючиАналитики.Характеристика = Аналитика.Характеристика
		|			И КлючиАналитики.Серия = Аналитика.Серия
		|			И КлючиАналитики.Склад = Аналитика.Склад
		|			И КлючиАналитики.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|			И КлючиАналитики.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|";
КонецФункции

Функция ТекстТекущиеРасходыПартийНЗП()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеРасходыПартийНЗП"" 	      				  КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск) КАК ТипЗаписи,
		|	ЛОЖЬ													  КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)									  КАК Сторно,
		|	96 										  				  КАК Приоритет,
		|	МАКСИМУМ(ДД.КоличествоПродукции)		  				  КАК Знаменатель,
		|	ЛОЖЬ 													  КАК РасчетЗавершен,
		|	Аналитика.Номенклатура 									  КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КлючиАналитики.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	ДД.ЗаказНаПроизводство КАК Партия,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	(ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КОНЕЦ) КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА Поступление.Подразделение
		|		ИНАЧЕ Аналитика.Склад КОНЕЦ) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтрокиПродукция КАК КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
		|		ПО АналитикаПродукции.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
		|		ПО АналитикаПродукции.Номенклатура = АналитикаПродукцииБезНазначения.Номенклатура
		|		И АналитикаПродукции.Характеристика = АналитикаПродукцииБезНазначения.Характеристика
		|		И АналитикаПродукции.Серия = АналитикаПродукцииБезНазначения.Серия
		|		И АналитикаПродукции.Склад = АналитикаПродукцииБезНазначения.Склад
		|		И АналитикаПродукции.СтатьяКалькуляции = АналитикаПродукцииБезНазначения.СтатьяКалькуляции
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаПродукцииБезНазначения.Назначение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитики
		|		ПО КлючиАналитики.Номенклатура = Аналитика.Номенклатура
		|			И КлючиАналитики.Характеристика = Аналитика.Характеристика
		|			И КлючиАналитики.Серия = Аналитика.Серия
		|			И КлючиАналитики.Склад = Аналитика.Склад
		|			И КлючиАналитики.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|			И КлючиАналитики.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ АналитикаДавальца КАК АналитикаДавальца
		|		ПО АналитикаДавальца.Регистратор = ДД.Регистратор
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ,
		|	Аналитика.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	КлючиАналитики.КлючАналитики,
		|	ДД.Организация,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.АналитикаУчетаПродукции,
		|	АналитикаПродукцииБезНазначения.КлючАналитики,
		|	ДД.КорРазделУчета,
		|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА Поступление.Подразделение
		|		ИНАЧЕ Аналитика.Склад КОНЕЦ,
		|	ДД.КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции,
		|	ДД.Регистратор
		|";
КонецФункции

Функция ТекстТекущиеСписанияЗатратНаВыпуск()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеСписанияЗатратНаВыпуск"" 	      			  КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск) КАК ТипЗаписи,
		|	ЛОЖЬ													  КАК ЭтоТочноРасчетноеДвижение,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)									  КАК Сторно,
		|	95 										  				  КАК Приоритет,
		|	МАКСИМУМ(Выпуски.Знаменатель)			  				  КАК Знаменатель,
		|	ЛОЖЬ 													  КАК РасчетЗавершен,
		|	Аналитика.Номенклатура 									  КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				  КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА Выпуски.ВидЗапасов.ТипЗапасов = Значение(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	СУММА(ДД.Количество),
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	Выпуски.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА Выпуски.ВидЗапасов.ТипЗапасов = Значение(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК КорРазделУчета,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА Выпуски.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|	КОНЕЦ КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	Аналитика.Склад КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	ДД.КодСтрокиПродукция КАК КодСтроки
		|ИЗ
		|	ВТКэшРасчетныеОборотыМатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|		ПО Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
		|		И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
		|		И Аналитика.Серия = АналитикаБезНазначения.Серия
		|		И Аналитика.Склад = АналитикаБезНазначения.Склад
		|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
		|		И Аналитика.СтатьяКалькуляции = АналитикаБезНазначения.СтатьяКалькуляции
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
		|		ПО Выпуски.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Выпуски.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	Аналитика.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Выпуски.ВидЗапасов.ТипЗапасов = Значение(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	Выпуски.АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА Выпуски.ВидЗапасов.ТипЗапасов = Значение(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА Выпуски.ВидЗапасов
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|	КОНЕЦ,
		|	Аналитика.Склад,
		|	ДД.КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство
		|";
КонецФункции

Функция ТекстТекущиеВыпускиПродукции()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеВыпускиПродукции"" 	      				КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) 		КАК ТипЗаписи,
		|	ЛОЖЬ													КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ													КАК Сторно,
		|	99 										  				КАК Приоритет,
		|	0 										  				КАК Знаменатель,
		|	ЛОЖЬ 													КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 			КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	АналитикаДавальца.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета КАК КорАналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ АналитикаДавальца КАК АналитикаДавальца
		|		ПО АналитикаДавальца.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПроизводствоБезЗаказа
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ЭтапПроизводства2_2
		//-- НЕ УТКА
		|	)
		|";
КонецФункции

Функция ТекстТекущиеРасходыМатериаловВПроизводстве()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеРасходыМатериаловВПроизводстве"" 	      	КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение) 	КАК ТипЗаписи,
		|	ЛОЖЬ													КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ													КАК Сторно,
		|	95 										  				КАК Приоритет,
		|	0 										  				КАК Знаменатель,
		|	ЛОЖЬ 													КАК РасчетЗавершен,
		|	Аналитика.Номенклатура 									КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО                              				КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО                              				КАК НалогообложениеНДС,
		|
		|	ДД.Дата КАК Период,
		|	ДД.Дата КАК ПериодПоступления,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	0 КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	0 КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ДД.Подразделение,
		|	Строки.АналитикаРасходов КАК АналитикаРасходов,
		|	Строки.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	Строки.СтатьяРасходов КАК СтатьяАктивовПассивов,
		|	Строки.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	Строки.ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО,
		|	НЕОПРЕДЕЛЕНО
		|ИЗ
		|	Документ.РаспределениеПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ПрочиеРасходы КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	НЕ ДД.НовоеПроизводство
		|	И ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|";
КонецФункции

Функция ТекстТекущиеРасходыТрудозатратыНЗП()
	Возврат 
		"ВЫБРАТЬ
		|	""ТекстТекущиеРасходыТрудозатратыНЗП""					КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Трудозатраты)	КАК ТипЗаписи,
		|	ЛОЖЬ													КАК ЭтоТочноРасчетноеДвижение,
		|	ЛОЖЬ													КАК Сторно,
		|	45														КАК Приоритет,
		|	0														КАК Знаменатель,
		|	ИСТИНА 													КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО											КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО											КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО											КАК НалогообложениеНДС,
		|
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидДеятельностиНДС,
		|
		|	МАКСИМУМ(ДД.КоличествоПродукции) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьЗабалансовая,
		|	0 КАК СуммаДопРасходов,
		|	0 КАК СуммаДопРасходовБезНДС,
		|	СУММА(ДД.Стоимость) КАК Трудозатраты,
		|	0 КАК ПостатейныеСНДС,
		|	0 КАК ПостатейныеБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК СтоимостьЗабалансоваяРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	0 КАК ДопРасходыРегл,
		|	СУММА(ДД.СтоимостьРегл) КАК ТрудозатратыРегл,
		|	0 ПостатейныеРегл,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|		ТОГДА ДД.КорВидЗапасовПродукции
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|	КОНЕЦ КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	0 КАК НДСРегл,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	НЕОПРЕДЕЛЕНО
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.КорАналитикаУчетаПродукции
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПроизводствоБезЗаказа
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ЭтапПроизводства2_2
		//-- НЕ УТКА
		|		)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаПродукции,
		|	ДД.КорРазделУчета,
		|	(ВЫБОР КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов ТОГДА ДД.КорВидЗапасовПродукции
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.ГруппаПродукции,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартийПроизводства
		|";
КонецФункции

//-- НЕ УТ

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюСебестоимостиТоваров(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	Если (Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск
			ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение)
	 И Не ЗначениеЗаполнено(Расход.ЗаказНаПроизводство)
	 И ЗначениеЗаполнено(Расход.РазделУчета)
	 И Расход.РазделУчета <> Приход.РазделУчета Тогда
		Возврат;
		
	//++ НЕ УТКА	
	ИначеЕсли Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПеремещениеАвто
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение
	 И ТипЗнч(Расход.Партия) = Тип("ДокументСсылка.ЗаказНаПроизводство")
	 И Расход.Партия <> Приход.КорПартия Тогда
		Возврат;
	//-- НЕ УТКА
	ИначеЕсли Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.КорректировкаПоступления
	 И ТипЗнч(Приход.Регистратор) <> Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
		Возврат;
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура(
	"Стоимость, СтоимостьБезНДС, СуммаДопРасходов, СуммаДопРасходовБезНДС,
	|СтоимостьРегл, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеСНДС, ПостатейныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//	Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "Партия, АналитикаУчетаПартий, НалогообложениеПартии, АналитикаФинансовогоУчета");
	Если РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности
	 И РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	 И ПараметрыРасчета.ОрганизацииСФИФОСкользящая.Найти(РасчетнаяПартия.Организация) <> Неопределено Тогда
		РасчетнаяПартия.Партия = РасчетнаяПартия.Регистратор;
		РасчетнаяПартия.АналитикаУчетаПартий = Неопределено;
	//++ НЕ УТКА
	ИначеЕсли ТипЗнч(Расход.Партия) = Тип("ДокументСсылка.ЗаказНаПроизводство") Тогда
		РасчетнаяПартия.Партия = Расход.Партия;
	//-- НЕ УТКА
	КонецЕсли;
	Если РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
	 И РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	 И ПараметрыРасчета.ОрганизацииСФИФОСкользящая.Найти(РасчетнаяПартия.Организация) = Неопределено Тогда
		РасчетнаяПартия.Партия = Неопределено;
		РасчетнаяПартия.АналитикаУчетаПартий = Неопределено;
	КонецЕсли;
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
	Иначе
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		РасчетнаяПартия.Сторно = Ложь;
		РасчетнаяПартия.АналитикаУчетаПоПартнерам = Приход.АналитикаУчетаПоПартнерам;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		РасчетнаяПартия.ВидДвижения = Приход.ВидДвижения;
		РасчетнаяПартия.АналитикаУчетаПоПартнерам = Приход.АналитикаУчетаПоПартнерам;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.Перемещение
	 И РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно Тогда
		РасчетнаяПартия.ВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
	КонецЕсли;
	
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Расход
		И Не ЗначениеЗаполнено(РасчетнаяПартия.КорВидДеятельностиНДС) Тогда
		РасчетнаяПартия.КорВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
	КонецЕсли;
	
	//++ НЕ УТКА
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПеремещениеАвто
	 И ТипЗнч(РасчетнаяПартия.Партия) = Тип("ДокументСсылка.ЗаказНаПроизводство") Тогда
		РасчетнаяПартия.АналитикаУчетаПартий = Неопределено;	
	КонецЕсли;
	//-- НЕ УТКА
	
	Если (ЗначениеЗаполнено(РасчетнаяПартия.КорРазделУчета)
		  ИЛИ (РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
			   И РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Расход))
	 //++ НЕ УТКА
	 // дополнительное условие на тип партии
	 И ТипЗнч(РасчетнаяПартия.КорПартия) <> Тип("ДокументСсылка.ЭтапПроизводства2_2")
	 И ТипЗнч(РасчетнаяПартия.КорПартия) <> Тип("ДокументСсылка.ПроизводствоБезЗаказа")
	 //-- НЕ УТКА
	 И РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.Выпуск
	 И РасчетнаяПартия.КорПартия <> РасчетнаяПартия.Регистратор Тогда
	 
		// Сработает для расходных движений документа, удовлетворяющего следующим условиям:
		// - документ формирует движения и по приходу и по расходу
		// - его приходное движение не является "партиеобразующим"
		// Пример такого документа - перемещение товаров между складами.
		Если (ПараметрыРасчета.ОрганизацииСФИФОСкользящая.Найти(РасчетнаяПартия.Организация) = Неопределено
				И РасчетнаяПартия.КорРазделУчета <> Перечисления.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		 ИЛИ (ЗначениеЗаполнено(РасчетнаяПартия.КорОрганизация)
			  И ПараметрыРасчета.ОрганизацииСФИФОСкользящая.Найти(РасчетнаяПартия.КорОрганизация) = Неопределено) Тогда
			РасчетнаяПартия.КорПартия 				= Неопределено;
			РасчетнаяПартия.КорАналитикаУчетаПартий = Неопределено;
		//++ НЕ УТКА
		ИначеЕсли ТипЗнч(Расход.КорПартия) = Тип("ДокументСсылка.ЗаказНаПроизводство") Тогда
			РасчетнаяПартия.КорАналитикаУчетаПартий = Неопределено;
		//-- НЕ УТКА
		Иначе
			РасчетнаяПартия.КорПартия 				= Приход.Партия;
			РасчетнаяПартия.КорАналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.КорВидЗапасов) Тогда
			РасчетнаяПартия.КорВидЗапасов = Приход.ВидЗапасов;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.КорАналитикаФинансовогоУчета)
			И НЕ ЗначениеЗаполнено(РасчетнаяПартия.КорОрганизация)
			И НЕ РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратИзПроизводства
			И НЕ РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РазборкаТоваров
			И НЕ РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров
			И НЕ (ТипЗнч(Приход.АналитикаФинансовогоУчета) = Тип("СправочникСсылка.ГруппыАналитическогоУчетаНоменклатуры")
				И РасчетнаяПартия.КорРазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
			И НЕ (ЗначениеЗаполнено(РасчетнаяПартия.ГруппаПродукции)
				И РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад) // Исключаем передачу продукции из кладовой на склад
			И (РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеВПроизводстве
				ИЛИ РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства
				ИЛИ НЕ РасчетнаяПартия.КорРазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) Тогда
				РасчетнаяПартия.КорАналитикаФинансовогоУчета = Приход.АналитикаФинансовогоУчета;
		ИначеЕсли Не ЗначениеЗаполнено(РасчетнаяПартия.КорАналитикаФинансовогоУчета)
		 И РасчетнаяПартия.КорАналитикаФинансовогоУчета <> Неопределено Тогда
			РасчетнаяПартия.КорАналитикаФинансовогоУчета = Неопределено;
		КонецЕсли;
		
	КонецЕсли;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Количество);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		РасходБазис = ?(Расход.Знаменатель <> 0, КоличествоСписания / Расход.Знаменатель, 0);
	ИначеЕсли Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		КоличествоСписания = Мин(Приход.Знаменатель, Расход.Количество);
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
		РасходБазис = ?(Расход.Количество <> 0, КоличествоСписания / Расход.Количество, 0);
	Иначе
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		РасходБазис = ?(Расход.Количество <> 0, КоличествоСписания / Расход.Количество, 0);
	КонецЕсли;
	
	// Заполняем показатели расчетной партии
	Если Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Трудозатраты Тогда
		РасчетнаяПартия.Количество = 0;	
	ИначеЕсли Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		РасчетнаяПартия.Количество = Окр(ПриходБазис * Приход.Количество, 3);
	Иначе
		РасчетнаяПартия.Количество = Окр(КоличествоСписания, 3);
	КонецЕсли;
	
	Если Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Трудозатраты Тогда
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			РасчетнаяПартия[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ];
		КонецЦикла;
	Иначе
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(РасходБазис * РасчетнаяПартия[ИмяРесурса.Ключ], 2);
		КонецЦикла;
	КонецЕсли;
	
	// Корректируем базу расчета в расходе
	Если РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.Выпуск Тогда
	 
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
			Расход.Знаменатель = Расход.Знаменатель - КоличествоСписания;
		КонецЕсли;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		
	КонецЕсли;
	
	// Корректируем базу расчета в приходе
	Если НЕ (Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И Расход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет) Тогда
	 	
		Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
			Приход.Количество = Приход.Количество - КоличествоСписания;
		Иначе
	 		Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
		КонецЕсли;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
	 	
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.РазделУчета) Тогда
		РасчетнаяПартия.РазделУчета = Приход.РазделУчета;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ВидЗапасов) И ЗначениеЗаполнено(Приход.ВидЗапасов) Тогда
		РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
	КонецЕсли;
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		Если Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Трудозатраты Тогда
			РасчетнаяПартия.РазделУчета = Расход.КорРазделУчета;
			РасчетнаяПартия.ВидЗапасов = Расход.КорВидЗапасов;
			РасчетнаяПартия.АналитикаУчетаНоменклатуры = Расход.КорАналитикаУчетаНоменклатуры;
			РасчетнаяПартия.Партия = Расход.КорПартия;
			РасчетнаяПартия.АналитикаУчетаПартий = Расход.КорАналитикаУчетаПартий;
			РасчетнаяПартия.АналитикаФинансовогоУчета = Расход.КорАналитикаФинансовогоУчета;
			РасчетнаяПартия.ВидДеятельностиНДС = Расход.КорВидДеятельностиНДС;
			РасчетнаяПартия.КорВидЗапасов = Неопределено;
			РасчетнаяПартия.КорАналитикаУчетаНоменклатуры = Неопределено;
			РасчетнаяПартия.КорАналитикаФинансовогоУчета = Неопределено;
			РасчетнаяПартия.КорРазделУчета = Неопределено;
			РасчетнаяПартия.АналитикаУчетаПартийПроизводства = Неопределено;
			РасчетнаяПартия.ДокументДвижения = Приход.ДокументДвижения;
			РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
		Иначе
			РасчетнаяПартия.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры;
			РасчетнаяПартия.Партия = Приход.Партия;
			РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		КонецЕсли;
		РасчетнаяПартия.Подразделение = Приход.Подразделение;
		РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
		РасчетнаяПартия.ИдентификаторСтроки = Приход.ИдентификаторСтроки;
		РасчетнаяПартия.КодСтроки = Приход.КодСтроки;
	КонецЕсли;	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно Тогда
		Если ЗначениеЗаполнено(Приход.КорАналитикаФинансовогоУчета) Тогда
			РасчетнаяПартия.АналитикаФинансовогоУчета = Приход.КорАналитикаФинансовогоУчета;
		Иначе
			РасчетнаяПартия.АналитикаФинансовогоУчета = Расход.АналитикаФинансовогоУчета;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.АналитикаФинансовогоУчета)
		 И РасчетнаяПартия.АналитикаФинансовогоУчета <> Неопределено Тогда
			РасчетнаяПартия.АналитикаФинансовогоУчета = Неопределено;
		КонецЕсли;
		Если ЗначениеЗаполнено(Приход.КорВидДеятельностиНДС) Тогда
			РасчетнаяПартия.ВидДеятельностиНДС = Приход.КорВидДеятельностиНДС;
		Иначе
			РасчетнаяПартия.ВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
		КонецЕсли;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		Если РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство
			ИЛИ РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты Тогда
			Если Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку Тогда
				РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку;
			ИначеЕсли Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение Тогда
				РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение;
			КонецЕсли;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.КорАналитикаУчетаНоменклатуры)
			И (РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку
				ИЛИ РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение) Тогда
			РасчетнаяПартия.КорРазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка();
		ИначеЕсли ЗначениеЗаполнено(РасчетнаяПартия.КорАналитикаУчетаНоменклатуры)
			И Не РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратИзПроизводства
			И (РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку
				ИЛИ РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение) Тогда
			РасчетнаяПартия.КорРазделУчета = РасчетнаяПартия.РазделУчета;
		КонецЕсли;
	КонецЕсли;
	
	// По результатам партионной идентификации определяем завершенность расчета
	РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа10_РаспределениеДопРасходовМеждуПартиямиИТоварами

// Выборка данных и формирование движений

Функция ПолучитьДанныеДляДопРасходов(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Определяем базу распределения прочих расходов на заказы поставщикам и заказы перемещений,
	// т.е. распределяем выполненные строки заказов на поступления партий - указываем заказ в партии.
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Регистратор, Номенклатура, Характеристика, Склад, Приоритет
		|";
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстНачальныеОстаткиПартийПрочихРасходов() // вт НачальныеОстаткиРасходов
		+ ТекстРазделениеЗапросов() + ТекстАналитикиРасходовВсе() // вт АналитикиРасходовВсе
		+ ТекстРазделениеЗапросов()	+ ТекстЗаказыИзАналитикРасходов() // вт ЗаказыИзАналитикРасходов, ПоступленияИзАналитикРасходов, ПоступленияИЗаказыИзАналитикРасходов
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстПоступившиеЗаказы()
		+ ТекстОбъединениеЗапросов() + ТекстПриходыПоступленийПоЗаказамСебестоимости()
		+ ТекстСортировка;
	
	ДанныеРасчетаЗаказов = Запрос.Выполнить().Выгрузить();
	
	РасчетныеПартииПоЗаказам = Новый ТаблицаЗначений;
	ПоляРасчетаЗаказов = СкопироватьКолонки(ДанныеРасчетаЗаказов.Колонки, РасчетныеПартииПоЗаказам.Колонки);
	
	КонтекстДвижений = ОписаниеДвижений(
		"ДопРасходы_ЗаказыПоставщикам", // Контекст
		"", // ИмяРегистра
		ПоляРасчетаЗаказов, // ПоляРасчета
		"Номенклатура, Регистратор, Характеристика, Склад", // КлючиСравнения
		"Количество, Стоимость", // Показатели
		"Количество", // БазисПрихода
		"Количество", // БазисРасхода
		"Заказ", // КлючРасхода
		"Период"); // ПолеПорядка
	
	// Заполнение таблицы РасчетныеПартииПоЗаказам
	РаспределитьПриходыНаРасходы(ПараметрыРасчета, КонтекстДвижений, ДанныеРасчетаЗаказов, РасчетныеПартииПоЗаказам);
	ДанныеРасчетаЗаказов = Неопределено;
	
	// Получаем данные для расчета списания партий прочих расходов и прихода партий расходов на с/с товаров
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, Приоритет, ВидДвижения, Период, Регистратор";

	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстПартииПоЗаказам() // вт ПартииПоЗаказам
		+ ТекстРазделениеЗапросов()	+ ТекстРегистраторыПрочих() // вт РегистраторыПрочих
		+ ТекстРазделениеЗапросов()	+ ТекстПериодыПартийПрочих() // вт ПериодыПартийПрочих
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийПрочих()
		+ ТекстОбъединениеЗапросов() + ТекстОстаткиПартийПрочих()
		+ ТекстОбъединениеЗапросов() + ТекстПриходыПартийПрочих()
		+ ТекстОбъединениеЗапросов() + ТекстБазисОстаткиСебестоимость()
		+ ТекстОбъединениеЗапросов() + ТекстБазисПриходыСебестоимость()
		+ ТекстОбъединениеЗапросов() + ТекстБазисКорректировкиПоступлений()
		+ ТекстОбъединениеЗапросов() + ТекстБазисПеремещенияСебестоимость()
		+ ТекстОбъединениеЗапросов() + ТекстБазисПрошлыеПриходыТоваровСебестоимость()
		+ ТекстОбъединениеЗапросов() + ТекстБазисЗаказы()
		+ ТекстОбъединениеЗапросов() + ТекстБазисУслуги()
		+ ТекстСортировка;
		
	Запрос.УстановитьПараметр("РасчетныеПартииПоЗаказам", РасчетныеПартииПоЗаказам);
	
	ДанныеДляРасчета = Запрос.Выполнить().Выгрузить();
	РасчетныеПартииПоЗаказам = Неопределено;
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"НачальныеОстаткиРасходов, АналитикиРасходовВсе, ЗаказыИзАналитикРасходов, ПоступленияИзАналитикРасходов,,
		|ПоступленияИЗаказыИзАналитикРасходов, ПартииПоЗаказам, РегистраторыПрочих, ПериодыПартийПрочих");
	
	Возврат ДанныеДляРасчета;
	
КонецФункции

Процедура СформироватьПартииПрочихРасходов(ПараметрыРасчета, ДанныеДляРасчета)
	
	Контекст 	= "ДопРасходы_ПартииПрочихРасходов";
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя;
	
	// Кэшируем получение пустых ссылок - на множественных итерациях есть выигрыш.
	ПустыеСсылки = Новый Соответствие;
	ПропорциональноКоличеству = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноКоличеству;
	ПропорциональноСебестоимости = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноСебестоимости;
	ПропорциональноВесу = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноВесу;
	ПропорциональноОбъему = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноОбъему;
	
	// Шаг 1: Рассчитываем базу распределения для каждого прихода прочих расходов с учетом налогообложения партии распределения.
	УзлыДвижений = Новый Соответствие; // [Организация, [АналитикаРасходов, [ИндексСтроки, [НалогообложениеНДС, Базис]]]]
	Ключи = Новый Массив(4); // {Организация, АналитикаРасходов, ИндексСтроки, НалогообложениеНДС}
	
	// Расчет базы по для каждой строки прихода по налогообложению каждого расхода.
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		
		Ключи[0] = Движение.Организация;
		Ключи[1] = Неопределено;
		Ключи[2] = ДанныеДляРасчета.Индекс(Движение);
		Если Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Услуги Тогда
			Ключи[3] = Движение.СтатьяОтраженияРасходов;
		Иначе
			Ключи[3] = Движение.НалогообложениеНДС;
		КонецЕсли;
		
		// Накапливаем приход партий прочих расходов для распределения по налогообложению.
		Если ЗначениеЗаполнено(Движение.СтатьяРасходов) Тогда
			Ключи[1] = Движение.АналитикаРаспределения;
			ДобавитьУзелИндекса(УзлыДвижений, Ключи, Неопределено);
			Продолжить;
		КонецЕсли;
		
		// Возвраты добавляются как положительный базис.
		Количество = ?(Движение.Количество < 0, -Движение.Количество, Движение.Количество);
		Стоимость  = ?(Движение.Стоимость < 0, -Движение.Стоимость, Движение.Стоимость);
		Вес = ?(Движение.Вес < 0., -Движение.Вес, Движение.Вес);
		Объем = ?(Движение.Объем < 0., -Движение.Объем, Движение.Объем);
		
		// Непосредственно расчет базисов по налогообложению.
		Аналитики = УзелИндекса(УзлыДвижений, Ключи);
		Если Аналитики = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Для Каждого Значение Из АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки) Цикл
			ИндексыСтрок = Аналитики[Значение];
			Если ИндексыСтрок = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Для Каждого ИндексСтроки Из ИндексыСтрок Цикл
				Приход = ДанныеДляРасчета[ИндексСтроки.Ключ];
				Если Приход.ПравилоРаспределения = ПропорциональноКоличеству Тогда
					Базис = Количество;
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноВесу Тогда
					Базис = Вес;
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноОбъему Тогда
					Базис = Объем;	
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноСебестоимости Тогда
					Базис = Стоимость;
				Иначе
					Продолжить;
				КонецЕсли;
				Приход.Базис = Приход.Базис + Базис;
				// Увеличим базу по налогообложению (Ключи[3]).
				Налоги = ИндексСтроки.Значение;
				ОписаниеБазы = ?(Налоги[Ключи[3]] = Неопределено, Новый Структура("Базис", 0), Налоги[Ключи[3]]);
				ОписаниеБазы.Базис = ОписаниеБазы.Базис + Базис;
				Налоги.Вставить(Ключи[3], ОписаниеБазы);
			КонецЦикла;
		КонецЦикла;
		
	КонецЦикла;
	
	// Шаг 2: создаем буфер накопления рассчитанных партий.
	РасчетныеПартии = Новый ТаблицаЗначений;
	СкопироватьКолонки(ДанныеДляРасчета.Колонки, РасчетныеПартии.Колонки);
	
	// Шаг 3: Создаем расчетные партии расходов по каждому накопленному налогообложению.
	Для Каждого Организация Из УзлыДвижений Цикл
		Для Каждого Аналитика Из Организация.Значение Цикл
			Для Каждого ИндексСтроки Из Аналитика.Значение Цикл
				Движение = ДанныеДляРасчета[ИндексСтроки.Ключ];
				Если Движение.Базис = 0 Тогда
					Продолжить;
				КонецЕсли;
				Для Каждого РаспределениеБазиса Из ИндексСтроки.Значение Цикл
					Если РаспределениеБазиса.Значение = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					РасчетнаяПартия = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Контекст, РасчетнаяПартия, Движение, РаспределениеБазиса);
					Если ТипЗнч(РаспределениеБазиса.Ключ) = Тип("ПланВидовХарактеристикСсылка.СтатьиРасходов") Тогда
						НоваяСтрока = РасчетныеПартии.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, РасчетнаяПартия, 
							"Период, Регистратор, Организация, Подразделение, ДокументПоступленияРасходов, АналитикаУчетаПартий,
							|ВидДеятельностиНДС, СтоимостьРегл, НДСРегл");
						НоваяСтрока.ВидДвижения = ВидДвиженияНакопления.Приход;
						НоваяСтрока.СтатьяРасходов = РаспределениеБазиса.Ключ;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	// Шаг 4: Удаляем измененные записи ДанныеДляРасчета (партии, остатки) - они теперь лишние.
	МинимальныйИндекс = 1 - ДанныеДляРасчета.Количество();
	Для Индекс = МинимальныйИндекс По 0 Цикл
		Движение = ДанныеДляРасчета[-Индекс];
		Если УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЭтоНепересчитываемыйТипЗаписи(Движение.ТипЗаписи) Тогда
			ДанныеДляРасчета.Удалить(-Индекс);
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 5: Копируем рассчитанные партии с указанием налогообложения в ДанныеДляРасчета.
	// (эти движения понадобятся для формирования прихода в партии расходов на себестоимость)
	Для Каждого РасчетнаяПартия Из РасчетныеПартии Цикл
		
		Если УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЭтоНепересчитываемыйТипЗаписи(РасчетнаяПартия.ТипЗаписи) Тогда
			Продолжить;
		КонецЕсли;
		
		Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление Тогда
			Движение = ДанныеДляРасчета.Добавить();
			ЗаполнитьЗначенияСвойств(Движение, РасчетнаяПартия);
			
			Движение.ТипЗаписи   = Перечисления.ТипыЗаписейПартий.Остаток;
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		КонецЕсли;
		
		// Сформируем движение по регистру ПартииПрочихРасходов.
		ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, РасчетнаяПартия);
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьДанныеПриходовПартийРасходов(ПараметрыРасчета, ДанныеДляРасчета)
	
	// кэшируем получение пустых ссылок - на множественных итерациях есть выигрыш
	ПустыеСсылки = Новый Соответствие;
	ПравилаРаспределения = Новый Массив(4);
	ПравилаРаспределения[0] = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноКоличеству;
	ПравилаРаспределения[1] = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноСебестоимости;
	ПравилаРаспределения[2] = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноВесу;
	ПравилаРаспределения[3] = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноОбъему;
	
	// Шаг 1: Строим сопоставление приходов с базисом и расходов, по которым базис рассчитан
	ДанныеДляРасчета.Сортировать("Организация, НалогообложениеНДС, Приоритет, Период, Регистратор, АналитикаУчетаНоменклатуры", Новый СравнениеЗначений);
	УзлыДвижений = Новый Соответствие;
	Ключи = Новый Массив(6); // {Организация, НалогообложениеНДС, ПравилоРаспределения, АналитикаРасходов, ДокументПоступленияРасходов, НомерСтроки}
	
	// формирование упорядоченных массивов строк таблицы ДанныеДляРасчета
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		
		Ключи[0] = Движение.Организация;
		Ключи[1] = Движение.НалогообложениеНДС;
		Ключи[2] = Движение.ПравилоРаспределения;
		Ключи[3] = Неопределено;
		Ключи[4] = Неопределено;
		Ключи[5] = Неопределено;
		
		// накапливаем приход партий прочих расходов для дальнейшего сопоставления
		Если ЗначениеЗаполнено(Движение.СтатьяРасходов) Тогда
			Ключи[3] = Движение.АналитикаРаспределения;
			Ключи[4] = Движение.ДокументПоступленияРасходов;
			Ключи[5] = ДанныеДляРасчета.Индекс(Движение);
			Движения = УзелИндекса(УзлыДвижений, Ключи);
			Если Движения = Неопределено Тогда
				Движения = ДобавитьУзелИндекса(УзлыДвижений, Ключи, Новый Массив);
			КонецЕсли;
			Движения.Добавить(Движение);
			Продолжить;
		КонецЕсли;
		
		// непосредственно вставка строки расхода в сопоставления по каждой аналитике
		Для Каждого Правило Из ПравилаРаспределения Цикл
			Ключи[2] = Правило;
			Аналитики = УзелИндекса(УзлыДвижений, Ключи);
			Если Аналитики = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			// Аналитики содержат соответствие, в ключах которого значение аналитики расхода,
			// в значениях - соответствие между документом поступления расхода и движениями относящимися к этому расходу
			Для Каждого Значение Из АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки) Цикл
				ПоступленияРасходов = Аналитики[Значение];
				Если ПоступленияРасходов = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				Для Каждого ПоступлениеРасхода Из ПоступленияРасходов Цикл
					Для Каждого НомерСтроки Из  ПоступлениеРасхода.Значение Цикл
						НомерСтроки.Значение.Добавить(Движение);
					КонецЦикла
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
		
	КонецЦикла;
	
	// Шаг 2: создаем буфер накопления рассчитанных партий
	РасчетныеПартии = Новый ТаблицаЗначений;
	ПоляРасчета = СкопироватьКолонки(ДанныеДляРасчета.Колонки, РасчетныеПартии.Колонки);
	
	// Шаг 3: распределяем каждый массив строк в аналитиках
	КонтекстДвижений = ОписаниеДвижений(
		"ДопРасходы_ПриходПартийРасходов",
		"",
		ПоляРасчета,
		"Организация",
		"Базис, Количество, Вес, Объем, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Базис",
		"<БАЗИС_РАСХОДА>",
		"ДокументРеализации",
		"Период");
	
	Для Каждого Организации Из УзлыДвижений Цикл
		Для Каждого Налогообложения Из Организации.Значение Цикл
			Для Каждого Правила Из Налогообложения.Значение Цикл
				
				Если Правила.Ключ = ПравилаРаспределения[0] Тогда
					КонтекстДвижений.БазисРасхода = "Количество";
				ИначеЕсли Правила.Ключ = ПравилаРаспределения[2] Тогда
					КонтекстДвижений.БазисРасхода = "Вес";
				ИначеЕсли Правила.Ключ = ПравилаРаспределения[3] Тогда
					КонтекстДвижений.БазисРасхода = "Объем";	
				Иначе
					КонтекстДвижений.БазисРасхода = "Стоимость";
				КонецЕсли;
				
				Для Каждого Аналитики Из Правила.Значение Цикл
					Для Каждого ПоступлениеРасхода Из Аналитики.Значение Цикл
						Для Каждого НомерСтроки Из ПоступлениеРасхода.Значение Цикл
							РаспределитьПриходыНаРасходы(ПараметрыРасчета, КонтекстДвижений, НомерСтроки.Значение, РасчетныеПартии);
						КонецЦикла;
					КонецЦикла;
				КонецЦикла;
				
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	// Шаг 4: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, ВидДвижения, Период, АналитикаУчетаНоменклатуры", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
	
КонецФункции

Процедура СформироватьДопРасходыВСебестоимостьТоваров(ПараметрыРасчета, РасчетныеПриходыПартийРасходов)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	
	// Шаг 1: Получаем аналитики учета по партнерам
	АналитикиПартнеров = Новый Соответствие;
	Поступления = Новый Массив;
	
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		// аналитики учета по партнерам для дальнейшего заполнения по документам поступлений
		Если АналитикиПартнеров[Движение.ДокументПоступления] = Неопределено Тогда
			Поступления.Добавить(Движение.ДокументПоступления);
			АналитикиПартнеров.Вставить(Движение.ДокументПоступления, Неопределено);
		КонецЕсли;
	КонецЦикла;
	
	// заполняем аналитики учета по партнерам по документам поступлений товаров
	ЗапросАналитик = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(ЗапросАналитик, ПараметрыРасчета); 
	
	ЗапросАналитик.Текст = ТекстАналитикиПартнеров();
	ЗапросАналитик.УстановитьПараметр("Поступления", Поступления);
	
	ВыборкаАналитик = ЗапросАналитик.Выполнить().Выбрать();
	Пока ВыборкаАналитик.Следующий() Цикл
		АналитикиПартнеров[ВыборкаАналитик.ДокументПоступления] = ВыборкаАналитик.АналитикаУчетаПоПартнерам;
	КонецЦикла;
	
	// Шаг 2: Формируем движения по регистру СебестоимостьТоваров
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		
		Если НЕ ЗначениеЗаполнено(Движение.СтатьяРасходов) Тогда
			Продолжить;
		КонецЕсли;
		
		РасчетнаяПартия = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, Движение,
			"Период, Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, Подразделение, АналитикаРасходов,
			|Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, КорАналитикаУчетаПартий");
		
		РасчетнаяПартия.ВидДеятельностиНДС 			= Движение.НалогообложениеНДС;
		РасчетнаяПартия.КорВидДеятельностиНДС 		= Движение.ВидДеятельностиНДС;
		РасчетнаяПартия.ВидДвижения 				= ВидДвиженияНакопления.Приход;
		РасчетнаяПартия.ВидЗапасов 					= ?(ПараметрыРасчета.ФО.УчитыватьСебестоимостьТоваровПоВидамЗапасов, Движение.ВидЗапасов, Неопределено);
		
		РасчетнаяПартия.АналитикаУчетаПоПартнерам 	= АналитикиПартнеров[Движение.ДокументПоступления];
		РасчетнаяПартия.СтатьяРасходовСписания 		= Движение.СтатьяРасходов;
		РасчетнаяПартия.ХозяйственнаяОперация 		= Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика;
		РасчетнаяПартия.ТипЗаписи 					= Перечисления.ТипыЗаписейПартий.ДопРасходы;
		РасчетнаяПартия.ДокументДвижения 			= Движение.Регистратор;
		РасчетнаяПартия.ДокументИсточник 			= Движение.ДокументПоступления;
		
		РасчетнаяПартия.СуммаДопРасходов 			= Движение.Стоимость;
		РасчетнаяПартия.СуммаДопРасходовБезНДС 		= Движение.СтоимостьБезНДС;
		
		Если РасчетнаяПартия.ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД
		 ИЛИ РасчетнаяПартия.ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			РасчетнаяПартия.ДопРасходыРегл 			= Движение.СтоимостьРегл + Движение.НДСРегл;
		Иначе
			РасчетнаяПартия.ДопРасходыРегл 			= Движение.СтоимостьРегл;
		КонецЕсли;
		
		РасчетнаяПартия.НДСРегл 					= Движение.НДСРегл;
		//++ НЕ УТ
		РасчетнаяПартия.ПостояннаяРазница 			= Движение.ПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница 			= Движение.ВременнаяРазница;
		//-- НЕ УТ
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СформироватьДопРасходыВДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстРегистраторыДляНоменклатураДоходыРасходы() // вт РегистраторыДопРасходы
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляНоменклатураДоходыРасходы()
		+ ТекстОбъединениеЗапросов() + ТекстНоменклатураДоходыРасходыИзСебестоимости();
	
	УниверсальныеМеханизмыПартийИСебестоимости.СформироватьДвиженияПоРегиструПоДаннымЗапроса(
		ПараметрыРасчета,
		ИмяРегистра,
		Запрос);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "РегистраторыДопРасходы");
	
КонецПроцедуры

// Тексты запросов

// ... для таблицы РасчетныеПартииПоЗаказам в ПолучитьДанныеДляДопРасходов()

Функция ТекстНачальныеОстаткиПартийПрочихРасходов()
	Возврат
		"ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	Статьи.ПравилоРаспределенияНаСебестоимость КАК ПравилоРаспределенияНаСебестоимость,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.СтоимостьОстаток,
		|	ДД.СтоимостьБезНДСОстаток,
		|	ДД.СтоимостьРеглОстаток,
		|	ДД.НДСРеглОстаток,
		|	ДД.ПостояннаяРазницаОстаток,
		|	ДД.ВременнаяРазницаОстаток
		|ПОМЕСТИТЬ НачальныеОстаткиРасходов
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов.Остатки(&ГраницаНачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|ГДЕ
		|	Статьи.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстАналитикиРасходовВсе()
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Ключи.Организация,
		|	Ключи.СтатьяРасходов,
		|	Ключи.АналитикаРасходов,
		|	Ключи.НаправлениеДеятельности
		|ПОМЕСТИТЬ АналитикиРасходовВсе
		|ИЗ
		|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Организация,
		|		ДД.СтатьяРасходов,
		|		ДД.АналитикаРасходов,
		|		ДД.НаправлениеДеятельности
		|	ИЗ
		|		НачальныеОстаткиРасходов КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Организация,
		|		ДД.СтатьяРасходов,
		|		ДД.АналитикаРасходов,
		|		ДД.НаправлениеДеятельности
		|	ИЗ
		|		ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПоступления КАК Корректировка
		|			ПО Корректировка.Ссылка = ДД.Регистратор
		|	ГДЕ
		|		ДД.СлужебноеВидДвиженияПриход
		|		И Статьи.ВариантРаспределенияРасходов =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|		И ДД.ДокументПоступленияРасходов В (
		|			ДД.Регистратор,
		|			Корректировка.ДокументОснование)
		|	) КАК Ключи
		|";
КонецФункции

Функция ТекстЗаказыИзАналитикРасходов() // ВТ ЗаказыИзАналитикРасходов, ПоступленияИзАналитикРасходов, ПоступленияИЗаказыИзАналитикРасходов, ОстаткиПоступленийПоЗаказам 
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДатаПоступления,
		|	ДД.Поступление,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Склад,
		|	ДД.Количество
		|ПОМЕСТИТЬ ЗаказыИзАналитикРасходов
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказПоставщику КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ДД.Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыПоставщикам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказПоставщику
		|	ГДЕ
		|		ДД.Период <= &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказПоставщику КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ДД.Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыПоставщикам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		// Расходы по заказам на перемещение
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаПеремещение КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		Заказ.СкладПолучатель КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаПеремещение КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаПеремещение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказНаПеремещение
		|	ГДЕ
		|		ДД.Период <= &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаПеремещение КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		Заказ.СкладПолучатель КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаПеремещение КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаПеремещение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказНаПеремещение.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		// Расходы по заказам на сборку
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаСборку КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		Заказ.Склад КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаСборку КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаСборку
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказНаСборку
		|	ГДЕ
		|		ДД.Период <= &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И ДД.ТипСборки = ЗНАЧЕНИЕ(Перечисление.ТипыДвиженияЗапасов.Поступление)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаСборку КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		Заказ.Склад КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаСборку КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаСборку
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказНаСборку.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И ДД.ТипСборки = ЗНАЧЕНИЕ(Перечисление.ТипыДвиженияЗапасов.Поступление)
		|) КАК ДД
		|;
		|////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Заказы.ДатаПоступления,
		|	Заказы.Поступление,
		|	Заказы.Номенклатура,
		|	Заказы.Характеристика,
		|	Заказы.Склад
		|ПОМЕСТИТЬ ПоступленияИзАналитикРасходов
		|ИЗ
		|	ЗаказыИзАналитикРасходов КАК Заказы
		|ГДЕ
		|	Заказы.ДатаПоступления < &КонецПериода
		|;
		|////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Заказы.Поступление КАК Поступление,
		|	Заказы.Заказ КАК Заказ
		|ПОМЕСТИТЬ ПоступленияИЗаказыИзАналитикРасходов
		|ИЗ
		|	ЗаказыИзАналитикРасходов КАК Заказы
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Поступление,
		|	Заказ
		|;
		|////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|ПОМЕСТИТЬ ОстаткиПоступленийПоЗаказам
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаНачалоПериода, Организация В (&МассивОрганизаций)
		|		И РазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
		|		И (АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Характеристика, АналитикаУчетаНоменклатуры.Склад) В (
		|			ВЫБРАТЬ
		|				Заказы.Номенклатура,
		|				Заказы.Характеристика,
		|				Заказы.Склад
		|			ИЗ
		|				ЗаказыИзАналитикРасходов КАК Заказы
		|			ГДЕ
		|				Заказы.ДатаПоступления < &НачалоПериода
		|			)
		|	) КАК ДД
		|";
КонецФункции

Функция ТекстПоступившиеЗаказы()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПоступившиеЗаказы"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.ДатаПоступления КАК Период,
		|	ДД.Поступление КАК Регистратор,
		|	ДД.Поступление КАК ДокументПоступления,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Склад,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница
		|ИЗ
		|	ЗаказыИзАналитикРасходов КАК ДД
		|";
КонецФункции

Функция ТекстПриходыПоступленийПоЗаказамСебестоимости()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыПоступленийПоЗаказамСебестоимости"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Поступления.ДатаПоступления КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	АналитикиТоваров.Номенклатура,
		|	АналитикиТоваров.Характеристика,
		|	АналитикиТоваров.Склад,
		|	АналитикиТоваров.Серия,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоступленияИзАналитикРасходов КАК Поступления
		|		ПО Поступления.Поступление = ДД.Регистратор
		|		И Поступления.Номенклатура = АналитикиТоваров.Номенклатура
		|		И Поступления.Характеристика = АналитикиТоваров.Характеристика
		|		И Поступления.Склад = АналитикиТоваров.Склад
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПоступленийПоЗаказам КАК Остатки
		|		ПО Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Период < &НачалоПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	Поступления.ДатаПоступления,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	АналитикиТоваров.Номенклатура,
		|	АналитикиТоваров.Характеристика,
		|	АналитикиТоваров.Склад,
		|	АналитикиТоваров.Серия,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""ТекстПриходыПоступленийПоЗаказамСебестоимости"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Поступления.ДатаПоступления КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	АналитикиТоваров.Номенклатура,
		|	АналитикиТоваров.Характеристика,
		|	АналитикиТоваров.Склад,
		|	АналитикиТоваров.Серия,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоступленияИзАналитикРасходов КАК Поступления
		|		ПО Поступления.Поступление = ДД.Регистратор
		|		И Поступления.Номенклатура = АналитикиТоваров.Номенклатура
		|		И Поступления.Характеристика = АналитикиТоваров.Характеристика
		|		И Поступления.Склад = АналитикиТоваров.Склад
		|СГРУППИРОВАТЬ ПО
		|	Поступления.ДатаПоступления,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	АналитикиТоваров.Номенклатура,
		|	АналитикиТоваров.Характеристика,
		|	АналитикиТоваров.Склад,
		|	АналитикиТоваров.Серия,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

// ... для результата ПолучитьДанныеДляДопРасходов()

Функция ТекстОписаниеДанныхДляПартийПрочих()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 													КАК ЗапросИсточник,
		|	0 																				КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) 							КАК ТипЗаписи,
		|	ЛОЖЬ 																			КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 											КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 													КАК Период,
		|	НЕОПРЕДЕЛЕНО 																	КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) 									КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) 				КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 									КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) 										КАК Склад,
		|	НЕОПРЕДЕЛЕНО 																	КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 									КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) 					КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) 						КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО 																	КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 					КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 							КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО 																	КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО 																	КАК АналитикаРаспределения,
		|	0 																				КАК Базис,
		|	0 																				КАК Количество,
		|	0 																				КАК Вес,
		|	0 																				КАК Объем,
		|	0 																				КАК Стоимость,
		|	0 																				КАК СтоимостьБезНДС,
		|	0 																				КАК СтоимостьРегл,
		|	0 																				КАК НДСРегл,
		|	0 																				КАК ПостояннаяРазница,
		|	0 																				КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 						КАК ВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 						КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 						КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 							КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО 																	КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО 																	КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 					КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) 	КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) 			КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО 																	КАК Партия,
		|	НЕОПРЕДЕЛЕНО 																	КАК АналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) 					КАК КорАналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) 						КАК КорВидДеятельностиНДС,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 													КАК РасчетныйПериод
		|//ВоВременнуюТаблицу
		|";
КонецФункции

Функция ТекстПартииПоЗаказам() // вт ПартииПоЗаказам
	Возврат
		"ВЫБРАТЬ
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница
		|ПОМЕСТИТЬ ПартииПоЗаказам
		|ИЗ
		|	&РасчетныеПартииПоЗаказам КАК ДД
		|";
КонецФункции

Функция ТекстРегистраторыПрочих() // вт РегистраторыПрочих
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Ключи.Регистратор
		|ПОМЕСТИТЬ РегистраторыПрочих
		|ИЗ
		|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступленияРасходов КАК Регистратор
		|	ИЗ
		|		НачальныеОстаткиРасходов КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступленияРасходов КАК Регистратор
		|	ИЗ
		|		ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|	ГДЕ
		|		ДД.ДокументПоступленияРасходов = ДД.Регистратор
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И Статьи.ВариантРаспределенияРасходов =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|	) КАК Ключи
		|";
КонецФункции

Функция ТекстПериодыПартийПрочих() // вт ПериодыПартийПрочих
	Возврат
		"ВЫБРАТЬ
		|	ДД.Регистратор КАК ДокументПоступленияРасходов,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	МАКСИМУМ(ДД.Период) КАК Период
		|ПОМЕСТИТЬ ПериодыПартийПрочих
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|		ПО КлючиРасходов.Организация = ДД.Организация
		|		И КлючиРасходов.СтатьяРасходов = ДД.СтатьяРасходов
		|		И КлючиРасходов.АналитикаРасходов = ДД.АналитикаРасходов
		|ГДЕ
		|	ДД.Период < &НачалоПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор = ДД.ДокументПоступленияРасходов
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстОстаткиПартийПрочих()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстОстаткиПартийПрочих"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	Периоды.Период,
		|	ДД.ДокументПоступленияРасходов КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ДД.ПравилоРаспределенияНаСебестоимость КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	&НачалоПериода КАК РасчетныйПериод
		|ИЗ
		|	НачальныеОстаткиРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПериодыПартийПрочих КАК Периоды
		|		ПО Периоды.ДокументПоступленияРасходов = ДД.ДокументПоступленияРасходов
		|		И Периоды.Организация = ДД.Организация
		|		И Периоды.СтатьяРасходов = ДД.СтатьяРасходов
		|		И Периоды.АналитикаРасходов = ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстПриходыПартийПрочих()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыПартийПрочих"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ВЫБОР
		|		КОГДА ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяОтраженияРасходов,
		|	Статьи.ПравилоРаспределенияНаСебестоимость КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПоступления КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И Статьи.ВариантРаспределенияРасходов =
		|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|	И ДД.ДокументПоступленияРасходов В (
		|		ДД.Регистратор,
		|		Корректировка.ДокументОснование)
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументРеализации,
		|	ДД.СтатьяОтраженияРасходов,
		|	Статьи.ПравилоРаспределенияНаСебестоимость
		|";
КонецФункции

Функция ТекстБазисОстаткиСебестоимость()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисОстаткиСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.Склад КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.КоличествоОстаток КАК Вес,
		|	ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.КоличествоОстаток КАК Объем,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	&НачалоПериода КАК РасчетныйПериод
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаНачалоПериода, Организация В (&МассивОрганизаций)
		|		И РазделУчета В (
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах),
		|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
		|	) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	ДД.СтоимостьОстаток > 0
		|	И (ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИЛИ ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		И СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.Склад,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Партия) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.Склад,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Партия
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.Склад,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Партия
		|				)
		|	)
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисПриходыСебестоимость()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисПриходыСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.Склад КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Стоимость <> 0 ТОГДА ДД.Стоимость
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.СтоимостьБезНДС <> 0 ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.СтоимостьБезНДС, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходыБезНДС, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.СтоимостьРегл <> 0 ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.СтоимостьРегл, 0) + ЕСТЬNULL(Цены.ДопРасходыРегл, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК СпрСклады
		|		ПО СпрСклады.Ссылка = АналитикиТоваров.Склад
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Период = НАЧАЛОПЕРИОДА(ДД.Период, МЕСЯЦ)
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		//++ НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		//-- НЕ УТ
		|		)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|	И (ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИЛИ ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		И (СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|			ИЛИ ЕСТЬNULL(СпрСклады.ЦеховаяКладовая, ЛОЖЬ)))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.Склад,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.Склад,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.Склад,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Регистратор)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.СборкаТоваров.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисКорректировкиПоступлений()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисКорректировкиПоступлений"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	КорректировкиПоступления.ДокументОснование КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.Склад КАК Склад,
		|	КорректировкиПоступления.ДокументОснование КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Стоимость <> 0 ТОГДА ДД.Стоимость
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.СтоимостьБезНДС <> 0 ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.СтоимостьБезНДС, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходыБезНДС, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.СтоимостьРегл <> 0 ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество
		|			* (ЕСТЬNULL(Цены.СтоимостьРегл, 0) + ЕСТЬNULL(Цены.ДопРасходыРегл, 0)) КАК ЧИСЛО(15,2)) КОНЕЦ) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПоступления КАК КорректировкиПоступления
		|		ПО КорректировкиПоступления.Ссылка = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК СпрСклады
		|		ПО СпрСклады.Ссылка = АналитикиТоваров.Склад
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Период = НАЧАЛОПЕРИОДА(ДД.Период, МЕСЯЦ)
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И (ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИЛИ ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		И (СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|			ИЛИ ЕСТЬNULL(СпрСклады.ЦеховаяКладовая, ЛОЖЬ)))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.Склад,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		КорректировкиПоступления.ДокументОснование) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.Склад,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			КорректировкиПоступления.ДокументОснование
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.Склад,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				КорректировкиПоступления.ДокументОснование)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(КорректировкиПоступления.ДокументОснование) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.СборкаТоваров.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.Склад,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	КорректировкиПоступления.ДокументОснование
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисПеремещенияСебестоимость()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисПеремещенияСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.Стоимость, 0) КАК ЧИСЛО(15,2))) КАК Стоимость,
		|	СУММА(ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьБезНДС, 0) КАК ЧИСЛО(15,2))) КАК СтоимостьБезНДС,
		|	СУММА(ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, 0) КАК ЧИСЛО(15,2))) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Период = НАЧАЛОПЕРИОДА(ДД.Период, МЕСЯЦ)
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Период >= &ДатаПереходаНаПартионныйУчетВерсии22
		|	И ДД.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство))
		|	И (ДД.Организация,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				ДД.Регистратор,
		|				ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисПрошлыеПриходыТоваровСебестоимость()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисПрошлыеПриходыТоваровСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.Склад КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаНачалоПериода, Организация В (&МассивОрганизаций)) КАК Остатки
		|		ПО Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.Склад = Склады.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	ДД.Период < &НачалоПериода
		|	И ДД.Период >= &ДатаПереходаНаПартионныйУчетВерсии22
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.Склад,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.Склад,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Поступление
		|				ПО Поступление.Регистратор = КлючиРасходов.АналитикаРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов = ДД.Регистратор
		|			И Поступление.Период < &НачалоПериода
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисЗаказы()
	
	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	""ТекстБазисЗаказы"" КАК ЗапросИсточник,
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ВидДеятельностиНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Заказ) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	(ВЫБОР КОГДА ДД.Период < &НачалоПериода ТОГДА &НачалоПериода ИНАЧЕ ДД.Период КОНЕЦ) КАК РасчетныйПериод
		|ИЗ
		|	ПартииПоЗаказам КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоступленияИЗаказыИзАналитикРасходов КАК Заказы
		|		ПО Заказы.Поступление = ДД.Регистратор
		|		И Заказы.Заказ = ДД.Заказ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	ЕСТЬNULL(ВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) В (&СобственныеТипыЗапасов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР КОГДА ДД.Период < &НачалоПериода ТОГДА &НачалоПериода ИНАЧЕ ДД.Период КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Заказ) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ)
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстБазисУслуги()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисУслуги"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Услуги) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	1 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	СУММА(ДД.Сумма) КАК Стоимость,
		|	СУММА(ДД.Сумма) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СуммаРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС) КАК ВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяРасходов КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК Партия,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Период КАК РасчетныйПериод
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходы КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваров
		|		ПО ПоступлениеТоваров.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеУслугПрочихАктивов КАК ПоступлениеУслуг
		|		ПО ПоступлениеУслуг.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период <= &КонецПериода
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.СтатьяРасходов.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|	И (ДД.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг 
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеУслугПрочихАктивов)
		|	И (ПоступлениеТоваров.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС)
		|		ИЛИ ПоступлениеУслуг.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС))
		|	И (ДД.Организация, ДД.Регистратор) В (
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация, ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов = ДД.Регистратор
		|		)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов
		|";
КонецФункции

// ... для СформироватьДопРасходыВСебестоимостьТоваров()

Функция ТекстАналитикиПартнеров()
	Возврат
		"ВЫБРАТЬ
		|	ДД.Регистратор КАК ДокументПоступления,
		|	МИНИМУМ(ДД.АналитикаУчетаПоПартнерам) КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Количество > 0
		|	И ДД.АналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
		|	И ДД.Регистратор В (&Поступления)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор
		|";
КонецФункции

// ... для СформироватьДопРасходыВДвиженияНоменклатураДоходыРасходы()

Функция ТекстРегистраторыДляНоменклатураДоходыРасходы() // вт РегистраторыДопРасходы
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор
		|ПОМЕСТИТЬ РегистраторыДопРасходы
		|ИЗ
		|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Партии
		|		ПО Партии.Период = ДД.Период
		|		И Партии.Регистратор = ДД.Регистратор
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И Партии.СлужебноеВидДвиженияПриход
		|ИНДЕКСИРОВАТЬ ПО
		|	ДД.Регистратор
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляНоменклатураДоходыРасходы()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 			  						  КАК ЗапросИсточник,
		|	0 																  КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) 			  КАК ТипЗаписи,
		|	ЛОЖЬ 															  КАК РасчетЗавершен,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 									  КАК Период,
		|	НЕОПРЕДЕЛЕНО 													  КАК Регистратор,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 		  КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) 					  КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) 			  КАК Подразделение,
		|
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)		  КАК НаправлениеДеятельностиНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) 						  КАК Склад,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка) 				  КАК ТипЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 					  КАК ВидЗапасов,
		|
		|	НЕОПРЕДЕЛЕНО 													  КАК СтатьяДоходовРасходов,
		|	НЕОПРЕДЕЛЕНО 													  КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО 													  КАК АналитикаРасходов,
		|
		|	0 													  			  КАК Количество,
		|	0 													  			  КАК Стоимость,
		|	0 													  			  КАК СтоимостьБезНДС,
		|	0 													  			  КАК СтоимостьРегл,
		|
		|	НЕОПРЕДЕЛЕНО 													  КАК ИсточникГФУНоменклатуры,
		|	НЕОПРЕДЕЛЕНО 													  КАК ДокументДвижения
		|//ВоВременнуюТаблицу
		|";
КонецФункции

Функция ТекстНоменклатураДоходыРасходыИзСебестоимости()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНоменклатураДоходыРасходыИзСебестоимости"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Период,
		|	ДД.Регистратор,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость),
		|	ДД.Организация,
		|	ДД.Подразделение,
		|
		|	Аналитика.Назначение.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Аналитика.Склад,
		|	ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК ТипЗапасов,
		|	ДД.ВидЗапасов,
		|
		|	ДД.СтатьяРасходовСписания КАК СтатьяДоходовРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|
		|	0 								 КАК Количество,
		|	СУММА(ДД.СуммаДопРасходов) 		 КАК Стоимость,
		|	СУММА(ДД.СуммаДопРасходовБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.ДопРасходыРегл) 		 КАК СтоимостьРегл,
		|
		|	ДД.ВидЗапасов КАК ИсточникГФУНоменклатуры,
		|	ДД.Регистратор КАК ДокументДвижения
		|
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистраторыДопРасходы КАК Регистраторы
		|		ПО Регистраторы.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Количество = 0
		|	И (ДД.СуммаДопРасходов <> 0 ИЛИ ДД.СуммаДопРасходовБезНДС <> 0 ИЛИ ДД.ДопРасходыРегл <> 0)
		|	И НЕ ДД.ХозяйственнаяОперация В
		|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ДополнительныеРасходыБезПартии),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ДополнительныеРасходыСПартией))
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	Аналитика.Назначение.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Аналитика.Склад,
		|	ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюЗаказВПриходе(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	РасчетнаяПартия.РасчетЗавершен = Истина;
	
	Если Приход = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура("Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");

	// расчетная партия заполняется на наибольшее общее вычитаемое
	КоличествоСписания = Мин(Приход.Количество, Расход.Количество);
	
	// заполняем показатели расчетной партии
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(КоличествоСписания * Расход[ИмяРесурса.Ключ] / Расход.Количество, 2);
	КонецЦикла;
	РасчетнаяПартия.Количество = КоличествоСписания;
	
	// корректируем базу расчета в расходе
	Если Расход <> РасчетнаяПартия Тогда
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		Расход.Количество = Расход.Количество - КоличествоСписания;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - Окр(КоличествоСписания * Приход[ИмяРесурса.Ключ] / Приход.Количество, 2);
	КонецЦикла;
	Приход.Количество = Приход.Количество - КоличествоСписания;
	
	// Заполняем партионную идентификацию в расчетной партии
	РасчетнаяПартия.Заказ = Приход.Заказ;
	
КонецПроцедуры

Процедура ЗаполнитьРасчетнуюПартиюПрочихРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление;
	РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Расход;
	РасчетнаяПартия.Период = Макс(Расход.Период, Расход.РасчетныйПериод);
	
	Если Расход.Базис = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура("Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	БазисСписания = Мин(Приход.Значение.Базис, Расход.Базис);
	
	// заполняем показатели расчетной партии
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(БазисСписания * Расход[ИмяРесурса.Ключ] / Расход.Базис, 2);
	КонецЦикла;
	РасчетнаяПартия.Базис = БазисСписания;
	
	// корректируем базу расчета в расходе
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
	КонецЦикла;
	Расход.Базис = Расход.Базис - БазисСписания;
	
	// корректируем базу расчета в приходе
	Приход.Значение.Базис = Приход.Значение.Базис - БазисСписания;
	
	// Заполняем партионную идентификацию в расчетной партии
	Если ТипЗнч(Приход.Ключ) = Тип("ПеречислениеСсылка.ТипыНалогообложенияНДС") Тогда
		РасчетнаяПартия.НалогообложениеНДС = Приход.Ключ;
	Иначе
		РасчетнаяПартия.СтатьяОтраженияРасходов = Приход.Ключ;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРасчетнуюПартиюПриходПартииРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	Если Приход.ПравилоРаспределения = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноКоличеству Тогда
		Расход.Базис = Расход.Количество;
	ИначеЕсли Приход.ПравилоРаспределения = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноВесу Тогда
		Расход.Базис = Расход.Вес;
	ИначеЕсли Приход.ПравилоРаспределения = Перечисления.ПравилаРаспределенияНаСебестоимостьТоваров.ПропорциональноОбъему Тогда
		Расход.Базис = Расход.Объем;
	Иначе
		Расход.Базис = Расход.Стоимость;
	КонецЕсли;
	
	БазисСписания = Мин(Приход.Базис, Расход.Базис);
	
	СуммовыеРесурсы = Новый Структура("Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	
	// заполняем показатели расчетной партии
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(БазисСписания * Приход[ИмяРесурса.Ключ] / Приход.Базис, 2);
	КонецЦикла;
	
	РасчетнаяПартия.Количество = Окр(БазисСписания * Расход.Количество / Расход.Базис, 3);
	РасчетнаяПартия.Вес 	   = Окр(БазисСписания * Расход.Вес / Расход.Базис, 3);
	РасчетнаяПартия.Объем 	   = Окр(БазисСписания * Расход.Объем / Расход.Базис, 3);
	РасчетнаяПартия.Базис 	   = БазисСписания;
	
	// корректируем базу расчета в приходе
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
	КонецЦикла;
	
	Приход.Базис = Приход.Базис - БазисСписания;
	
	// корректируем базу расчета в расходе
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - Окр(БазисСписания * Расход[ИмяРесурса.Ключ] / Расход.Базис, 2);
	КонецЦикла;
	
	Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
	Расход.Вес 		  = Расход.Вес - РасчетнаяПартия.Вес;
	Расход.Объем 	  = Расход.Объем - РасчетнаяПартия.Объем;
	Расход.Базис 	  = Расход.Базис - БазисСписания;
	
	Если Расход.Базис = 0 Тогда
		Расход.Количество = 0;
		Расход.Вес = 0;
		Расход.Объем = 0;
		Расход.Стоимость = 0;	
	КонецЕсли;
	
	// Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход,
		"ВидДвижения, Период, Регистратор, ДокументПоступленияРасходов, СтатьяРасходов, ХозяйственнаяОперация,
		|Подразделение, ПравилоРаспределения");
		
	Если ЗначениеЗаполнено(Приход.АналитикаРасходов) Тогда
		РасчетнаяПартия.АналитикаРасходов = Приход.АналитикаРасходов;
	КонецЕсли;
	
	РасчетнаяПартия.ВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
	РасчетнаяПартия.КорВидДеятельностиНДС = Приход.НалогообложениеНДС;
	
	РасчетнаяПартия.КорАналитикаУчетаПартий  = Приход.АналитикаУчетаПартий;
	РасчетнаяПартия.ПодразделениеРасходов 	 = Приход.Подразделение;
	РасчетнаяПартия.ТипЗаписи 				 = Перечисления.ТипыЗаписейПартий.Партия;
	
	Если РасчетнаяПартия.Стоимость = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.ПостояннаяРазница = 0
	 И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
		РасчетнаяПартия.РасчетЗавершен = Ложь;
 	Иначе
		РасчетнаяПартия.РасчетЗавершен = Истина;
	КонецЕсли;
	
КонецПроцедуры

// Вспомогательные

Функция СкопироватьКолонки(КолонкиИсточника, КолонкиПриемника)
	
	ПоляИсточника = "";
	
	Для Каждого Колонка Из КолонкиИсточника Цикл
		КолонкиПриемника.Добавить(Колонка.Имя, Колонка.ТипЗначения);
		ПоляИсточника = ПоляИсточника + ?(ЗначениеЗаполнено(ПоляИсточника), ", ", "") + Колонка.Имя;
	КонецЦикла;
	
	Возврат ПоляИсточника;
	
КонецФункции

Функция УзелИндекса(Индекс, КлючиИндекса)
	УзелИндекса = Индекс;
	Счетчик = 0;
	Пока Счетчик <= КлючиИндекса.ВГраница() И КлючиИндекса[Счетчик] <> Неопределено Цикл
		УзелИндекса = УзелИндекса[КлючиИндекса[Счетчик]];
		Если УзелИндекса = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		Счетчик = Счетчик + 1;
	КонецЦикла;
	Возврат УзелИндекса;
КонецФункции

Функция ДобавитьУзелИндекса(Индекс, КлючиИндекса, Значение)
	ВГраница = КлючиИндекса.ВГраница();
	Если ВГраница < 0 Или КлючиИндекса[0] = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	УзелИндекса = Индекс;
	Счетчик = 0;
	Пока Счетчик < ВГраница Цикл
		ПодузелИндекса = УзелИндекса[КлючиИндекса[Счетчик]];
		Если ПодузелИндекса = Неопределено Тогда
			ПодузелИндекса = Новый Соответствие;
			УзелИндекса.Вставить(КлючиИндекса[Счетчик], ПодузелИндекса);
		КонецЕсли;
		УзелИндекса = ПодузелИндекса;
		Счетчик = Счетчик + 1;
		Если КлючиИндекса[Счетчик] = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
	КонецЦикла;
	УзелИндекса.Вставить(КлючиИндекса[Счетчик], Значение);
	Возврат Значение;
КонецФункции

Функция АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки)
	Результат = Новый Массив;
	Результат.Добавить(Движение.Номенклатура);
	Если Движение.Номенклатура <> Неопределено Тогда
		Результат.Добавить(ПустаяСсылка(Движение.Номенклатура, ПустыеСсылки));
	КонецЕсли;
	Результат.Добавить(Движение.Склад);
	Если Движение.Склад <> Неопределено Тогда
		Результат.Добавить(ПустаяСсылка(Движение.Склад, ПустыеСсылки));
	КонецЕсли;
	Результат.Добавить(Движение.Регистратор);
	Если Не ЗначениеЗаполнено(Движение.Регистратор) Тогда
		Результат.Добавить(Движение.Партия);
	КонецЕсли;
	Результат.Добавить(ПустаяСсылка(Движение.Регистратор, ПустыеСсылки));
	Возврат Результат;
КонецФункции

Функция ПустаяСсылка(Ссылка, КэшСсылок)
	Результат = КэшСсылок[ТипЗнч(Ссылка)];
	Если Результат = Неопределено Тогда
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Ссылка);
		Если МенеджерОбъекта = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		Результат = МенеджерОбъекта.ПустаяСсылка();
		КэшСсылок.Вставить(ТипЗнч(Ссылка), Результат);
	КонецЕсли;
	Возврат Результат;
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа11_РасчетПартийНДС

// Инициализация данных

Функция ПоляПотребленийПартииНДС(ПараметрыРасчета)
	
	Возврат "Партия, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС";
	
КонецФункции

Функция ОписаниеЦепочекПартийНДС(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийПартииНДС(ПараметрыРасчета);
	
	// Потребление <- (Остаток, Партия, ДопРасходы, ДопРасходыБезПартии, ДопРасходыСПартией, Перемещение, ПеремещениеОбособленно, Сторно, Выпуск)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Остаток,		ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Партия,		ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ДопРасходы,	ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии,	ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией,	ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Сторно, 		ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Выпуск, 		ПоляПотреблений + ", Регистратор");
		
	// ПотреблениеАвто <- (Остаток, Партия, Перемещение, ПеремещениеОбособленно, Сторно)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Остаток,				ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Партия,				ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, 		ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Сторно, 				ПоляПотреблений + ", Регистратор");	
		
	// КорректировкаПоступления <- (Остаток, Партия)	
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.КорректировкаПоступления, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПоступления,
		Перечисления.ТипыЗаписейПартий.Остаток, 				 ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПоступления,
		Перечисления.ТипыЗаписейПартий.Партия, 				 	 ПоляПотреблений);
		
	// Сторно <- (Потребление, ПотреблениеАвто, Прошлое)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Сторно, 		"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Партия");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Потребление, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Прошлое, 	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия");
		
	// ВозвратНаДругойСклад <- (Сторно)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, Партия, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Сторно,
		"Регистратор, Партия, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
		
	// Распределение <- (Перемещение, ПеремещениеОбособленно, Остаток, Партия, Выпуск)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Остаток,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Партия,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Партия, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");	
	
	// Перемещение <- (Потребление, ПотреблениеАвто, ПотреблениеПроизводство, ВозвратНаДругойСклад)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
		
	// ПеремещениеОбособленно <- (Потребление)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, КорОрганизация");
		
	// ПеремещениеАвто <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, Распределение)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
		
	// СписанияНаВыпуск <- (Перемещение, ПеремещениеОбособленно, ПеремещениеАвто, Партия, Остаток)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, ПоляПотреблений + ", ДокументИсточник");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Партия, ПоляПотреблений + ", Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Остаток, ПоляПотреблений + ", Регистратор");
		
	// Выпуск <- (СписанияНаВыпуск)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		"Регистратор, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, ВидДеятельностиНДС");
	// Также эта связь используется в ТекстДвиженияСебестоимостиТоваров()
		
	// ПотреблениеПроизводство <- (Перемещение, ПеремещениеОбособленно, Остаток)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "АналитикаУчетаНоменклатуры, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Остаток,				"АналитикаУчетаНоменклатуры, Организация, РазделУчета");
		
	// СписаниеНаРасходы <- (Партия)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы, ПоляПотреблений);
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		Перечисления.ТипыЗаписейПартий.Партия, ПоляПотреблений);
		
	// Дополнение <- (<без источников - для формирования записей по данным запроса>)
	ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийПартийНДС(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"ПартииНДСиУСН", // Контекст
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя, // ИмяРегистра
		ПереченьПолей(КолонкиТаблицыРаспределения), // ПоляРасчета
		ПоляПотребленийПартииТоваров(ПараметрыРасчета), // КлючиСравнения
		"Знаменатель, Количество, СтоимостьБезНДС, НДС", // Показатели
		"Знаменатель", // БазисПрихода
		"Знаменатель", // БазисРасхода
		"ДокументИсточник", // КлючРасхода
		"Период", // ПолеПорядка
		"Партия", // ПоляСортировки
		Истина); // СортировкаПоУсловию
		
	ОписаниеДвижений.Вставить("ПоляСуммирования", "Количество, СтоимостьБезНДС, НДС");
	ОписаниеДвижений.Вставить("ПоляГруппировки", ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое, Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	НезаписываемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПартийНДСиУСН());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДС(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		+ ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСиУСН() //вт Данные
		+ ТекстОбъединениеЗапросов() + ТекстНачальныеОстаткиПартийНДС() // использует ОстаткиТоваров
		+ ТекстОбъединениеЗапросов() + ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
		+ ТекстОбъединениеЗапросов() + ТекстДвиженияСебестоимостиТоваров()
		+ ТекстОбъединениеЗапросов() + ТекстДвиженияСебестоимостиТоваровСборка()
		+ ТекстОбъединениеЗапросов() + ТекстВозвратыПрошлыхПериодов()
		+ ТекстОбъединениеЗапросов() + ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации 
		+ ТекстОбъединениеЗапросов() + ТекстРеализацииПрошлыхМесяцевПартииНДС21(); // использует ПрошлыеРеализации 
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатуры", // разделитель
		"Знаменатель, Количество, СтоимостьБезНДС, НДС", // ресурсы
		"АналитикаУчетаНоменклатуры, Период, Приоритет ВОЗР, РазделУчета, Организация, АналитикаУчетаНоменклатуры, Партия, Регистратор"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ПриходыТоваров, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС");
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСиУСН()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 					КАК ЗапросИсточник,
		|	ДД.ТипЗаписи 									КАК ТипЗаписи,
		|	ЛОЖЬ											КАК Сторно,
		|	0 												КАК Приоритет,
		|	0 												КАК Знаменатель,
		|	ЛОЖЬ 											КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 		КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС
	Возврат
		"ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Количество > 0
		|	И ДД.СлужебноеВидДвиженияПриход
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ ОстаткиТоваров
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&МассивОрганизаций)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПрошлыеРеализацииПартийНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаПартий,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.ВидДеятельностиНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
		|		ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл - ДД.НДСРегл
		|		ИНАЧЕ ДД.СтоимостьРегл + ДД.ДопРасходыРегл КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДСРегл) КАК НДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ПОМЕСТИТЬ ПриходыТоваровНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Ссылка = ДД.АналитикаУчетаПоПартнерам
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
		|		ПО Договоры.Ссылка = АналитикаРасчетов.Договор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПоступления КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.СлужебноеВидДвиженияПриход
		|	И (ДД.НДСРегл <> 0
		|		ИЛИ ДД.Организация В (&ОрганизацииНаУСН)
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПорчаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|		ИЛИ ЕСТЬNULL(Договоры.УчетАгентскогоНДС, ЛОЖЬ)
		|		ИЛИ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту))
		//++ НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		//-- НЕ УТ
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ЭтапПроизводства2_2
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПроизводствоБезЗаказа
		//-- НЕ УТКА
		|		)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		//++ НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		//-- НЕ УТ
		|		)
		|	И (ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		//++ НЕ УТ
		|		 И НЕ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		//-- НЕ УТ
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	ДД.Количество КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.Количество,
		|
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		//++ НЕ УТ
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|		 И НЕ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		//-- НЕ УТ
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение))
		|	И (НЕ ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
		//++ НЕ УТ
		|	ИЛИ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|	ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|	ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		//-- НЕ УТ
		//++ НЕ УТКА
		|	ИЛИ ДД.Регистратор ССЫЛКА Документ.ЭтапПроизводства2_2
		|	ИЛИ ДД.Регистратор ССЫЛКА Документ.ПроизводствоБезЗаказа
		//-- НЕ УТКА
		|	)
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПорчаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		//++ НЕ УТ
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|		И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты))
		//-- НЕ УТ
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
КонецФункции
	
// ... выборки данных

Функция ТекстНачальныеОстаткиПартийНДС() // использует ОстаткиТоваров
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)							 КАК Сторно,
		|	0 КАК Приоритет,
		|	ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) КАК Знаменатель,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 	КАК НалогообложениеПартии,
		|	
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора,
		|		ЕСТЬNULL(ПериодикаПоступления.ДатаРегистратора,
		|			&КонецПредыдущегоПериода)) КАК Период,
		|	(ВЫБОР
		|		КОГДА ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА ДД.Партия
		//++ НЕ УТКА
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|		 И ДД.Партия ССЫЛКА Документ.ЗаказНаПроизводство
		|			ТОГДА НЕОПРЕДЕЛЕНО
		//-- НЕ УТКА
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.НДСОстаток КАК НДС,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&МассивОрганизаций)) КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПоступления
		|		ПО ПериодикаПоступления.Организация = ДД.Организация
		|		И ПериодикаПоступления.Документ = ДД.ДокументПоступления
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL ТОГДА Приходы.Количество
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL ТОГДА Остатки.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.РазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Приходы.ВидЗапасов = ДД.ВидЗапасов
		|		И Приходы.Партия = ДД.Партия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)))
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваров()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	ДД.Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ВЫБОР
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|					И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА Выпуски.Знаменатель
		|			ИНАЧЕ ДД.Знаменатель
		|		КОНЕЦ) КАК Знаменатель,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ДвиженияСебестоимостиНДС КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимостиНДС КАК Выпуски
		|		ПО ДД.Регистратор = Выпуски.Регистратор
		|			И ДД.КорПартия = Выпуски.Партия
		|			И ДД.КорАналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
		|			И ДД.КорРазделУчета = Выпуски.РазделУчета
		|			И ДД.КорВидЗапасов = Выпуски.ВидЗапасов
		|			И ДД.КорАналитикаФинансовогоУчета = Выпуски.АналитикаФинансовогоУчета
		|			И ДД.ВидДеятельностиНДС = Выпуски.ВидДеятельностиНДС
		|			И (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск))
		|			И (Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск))
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.Сторно,
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваровСборка()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваровСборка"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(Приходы.Количество) КАК Знаменатель,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.КорРазделУчета КАК РазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ДД.КорПартия КАК Партия,
		|	ДД.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.КорРазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Приходы.Партия = ДД.КорПартия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.КорАналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.КорВидДеятельностиНДС
		|ГДЕ
		|	ДД.Количество <> 0
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстВозвратыПрошлыхПериодов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстВозвратыПрошлыхПериодов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно) КАК ТипЗаписи,
		|	ИСТИНА КАК Сторно,
		|	0 КАК Приоритет,
		|	-ДД.Количество КАК Знаменатель,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	-ДД.Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	ДД.Знаменатель 								КАК Знаменатель,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.КорВидДеятельностиНДС 					КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И ДД.Партия = Прошлые.Партия
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС21() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС21"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	Прошлые.Количество							КАК Знаменатель,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура								КАК Номенклатура,
		|	ДД.НалогообложениеНДС						КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	Прошлые.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Прошлые.Партия КАК Партия,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	ДД.НалогообложениеНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДСРегл,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И (ДД.ДокументПоступления = Прошлые.Партия
		|			ИЛИ Прошлые.Партия = НЕОПРЕДЕЛЕНО)
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	СуммовыеРесурсы = Новый Структура("СтоимостьБезНДС, НДС");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//	Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ДокументПоступления, АналитикаУчетаПартий, НалогообложениеПартии");
	РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	
	КорректироватьБазуВРасходе = Ложь;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	Если (РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 	  И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров"))
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Знаменатель);
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	ИначеЕсли Приход.Количество <> 0 Тогда
		КорректироватьБазуВРасходе = Истина;
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
	Иначе
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	КонецЕсли;
	
	// Заполняем показатели расчетной партии
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		РасчетнаяПартия.Количество = Окр(ПриходБазис * Приход.Количество, 3);
	Иначе
		РасчетнаяПартия.Количество = Мин(Расход.Количество, Приход.Количество);
	КонецЕсли;
	
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ПриходБазис * Приход[ИмяРесурса.Ключ], 2);
	КонецЦикла;
	
	// Корректируем базу расчета в приходе
	Если НЕ (Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И Расход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет) Тогда
	 
	 	Если КорректироватьБазуВРасходе Тогда
			Приход.Знаменатель = Приход.Знаменатель - Мин(Расход.Знаменатель, Приход.Знаменатель);
		Иначе 
	    	Приход.Знаменатель = Приход.Знаменатель - КоличествоСписания;
		КонецЕсли;
		
		Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
	 	
	КонецЕсли;
	
	// Корректируем базу расчета в расходе
	Если КорректироватьБазуВРасходе Тогда
		
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		
	КонецЕсли;
	
	ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	
	// По результатам партионной идентификации определяем завершенность расчета
	РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	
КонецПроцедуры

Процедура ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	Период = НачалоМесяца(РасчетнаяПартия.Период);
	
	ВариантУчетаНДС = УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ВариантУчетаНДСОрганизацииПриИзмененииВидаДеятельности(
		РасчетнаяПартия.Организация, Период);
	
	Если ВариантУчетаНДС = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если УчетНДСУТ.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС)
	 ИЛИ (РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	  И УчетНДСУТ.ВозможноСписаниеНДС(Приход.ВидДеятельностиНДС, Приход.КорВидДеятельностиНДС)) Тогда
	
		Если ВариантУчетаНДС = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода Тогда
			
			Если ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) Тогда
				ДатаПартии = НачалоМесяца(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РасчетнаяПартия.ДокументПоступления, "Дата"));
			Иначе
				ДатаПартии = Дата(1,1,1);
			КонецЕсли;
			
			Если ДатаПартии = Период Тогда
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
		
		Если УчетНДСУТ.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС) Тогда
			
			ПараметрыСписанияНДС = УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПараметрыСписанияНДСОрганизации(
				РасчетнаяПартия.Организация, Период);
			
			Если РасчетнаяПартия.КорВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыСписанияНДС.СтатьяСписанияПродажаНеОблагаетсяНДС;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыСписанияНДС.АналитикаСписанияПродажаНеОблагаетсяНДС;
			Иначе
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыСписанияНДС.СтатьяСписанияПродажаОблагаетсяЕНВД;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыСписанияНДС.АналитикаСписанияПродажаОблагаетсяЕНВД;
			КонецЕсли;
			
		Иначе
			
			РасчетнаяПартия.НДС = 0;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа12_ПодготовкаДанныхДляПартийПрочихРасходов

// Выборка данных

Процедура ПолучитьДанныеДляПартийПрочихРасходов(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		+ ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС
		+ ТекстРазделениеЗапросов()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийПрочихРасходов() //вт Данные
		+ ТекстОбъединениеЗапросов() + ТекстПоступленияПартийПрочихРасходовИзПартийНДС()
		+ ТекстОбъединениеЗапросов() + ТекстПоступленияПартийПрочихРасходовИзПриходовСебестоимости(); // использует ПриходыТоваровНДС
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Нумерация строк не требуется, т.к. распределение выполняться не будет.
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ПриходыТоваров, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС");
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийПрочихРасходов()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
		|	0. КАК Стоимость,
		|	0. КАК СтоимостьБезНДС,
		|	0. КАК СтоимостьРегл,
		|	0. КАК НДСРегл,
		|	0. КАК ПостояннаяРазница,
		|	0. КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|";
КонецФункции

// ... выборки данных

Функция ТекстПоступленияПартийПрочихРасходовИзПартийНДС()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийПрочихРасходовИзПартийНДС"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.СтруктураПредприятия
		|			ТОГДА Аналитика.Склад
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ КАК Подразделение,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартий,
		|	Назначения.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьРегл,
		|	СУММА(ДД.НДС) КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК НалогообложениеНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.Склад = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериалов
		|		ПО ПередачаМатериалов.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратМатериаловИзПроизводства КАК ВозвратМатериалов
		|		ПО ВозвратМатериалов.Ссылка = ДД.Регистратор
		//-- НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовАктивов
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
		|	И ДД.НДС <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.СтруктураПредприятия
		|			ТОГДА Аналитика.Склад
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	Назначения.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходов = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстПоступленияПартийПрочихРасходовИзПриходовСебестоимости()// использует ПриходыТоваровНДС
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийПрочихРасходовИзПриходовСебестоимости"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		КОГДА НЕ СторноТоваров.Подразделение ЕСТЬ NULL
		|			ТОГДА СторноТоваров.Подразделение
		|		КОГДА Аналитика.Склад ССЫЛКА Справочник.СтруктураПредприятия
		|			ТОГДА Аналитика.Склад
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.АналитикаУчетаПартий,
		|	Назначения.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидДеятельностиНДС,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДС КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.Склад = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериалов
		|		ПО ПередачаМатериалов.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратМатериаловИзПроизводства КАК ВозвратМатериалов
		|		ПО ВозвратМатериалов.Ссылка = ДД.Регистратор
		//-- НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК СторноТоваров
		|		ПО СторноТоваров.Ссылка = ДД.Регистратор
		|
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|";
КонецФункции

#КонецОбласти

//++ НЕ УТ

#Область ПроцедурыЭтапа14_РаспределениеДолейПроизводственныхРасходов

// Инициализация данных

Функция ПоляПотребленийРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета)
	
	Возврат "Регистратор";
	
КонецФункции

Функция ОписаниеЦепочекРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета)
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений = ПоляПотребленийРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета);
	
	Партия                 = Перечисления.ТипыЗаписейПартий.Партия;
	ПодразделенияПоБазе    = Перечисления.ТипыЗаписейПартий.ПодразделенияПоБазе;
	ПоЭтапамПодразделений  = Перечисления.ТипыЗаписейПартий.ПоЭтапамПодразделений;
	ПодразделенияДокумента = Перечисления.ТипыЗаписейПартий.ПодразделенияДокумента;
	ПоВсемЭтапам           = Перечисления.ТипыЗаписейПартий.ПоВсемЭтапам;
	ПоВсемПодразделениям   = Перечисления.ТипыЗаписейПартий.ПоВсемПодразделениям;
	Распределение          = Перечисления.ТипыЗаписейПартий.Распределение;
	СписаниеНаРасходы      = Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы;
	
	// Распределение по подразделениям:
	//   - по правилам (ПоПодразделениямИЭтапамПоПравилам)
	// ПодразделенияПоБазе <- Партия
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПодразделенияПоБазе, "Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПодразделенияПоБазе, Партия, "Регистратор");
	
	// Распределение по этапам в пределах:
	//   - подразделений, рассчитанных на предыдущем шаге 
	//   - подразделений документа, из шапки или табличной части (ПоЭтапамПоПравилуВДанномПодразделении, ПоПодразделениямВручнуюПоЭтапамПоПравилу)
	// ПоЭтапамПодразделений <- (ПодразделенияПоБазе, ПодразделенияДокумента)
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПоЭтапамПодразделений, "Регистратор, КорПодразделение");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПоЭтапамПодразделений, ПодразделенияПоБазе, "Регистратор, КорПодразделение");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПоЭтапамПодразделений, ПодразделенияДокумента, "Регистратор, КорПодразделение");
	
	// Распределение по этапам всех подразделений:
	//   - для варианта распределения ПоЭтапамПоПравилуПоВсемПодразделениям
	// ПоВсемЭтапам <- ПоВсемПодразделениям
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, ПоВсемЭтапам, "Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, ПоВсемЭтапам, ПоВсемПодразделениям, "Регистратор");
	
	// Распределение на другие статьи расходов:
	// СписаниеНаРасходы <- Распределение
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, СписаниеНаРасходы, "Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, СписаниеНаРасходы, Распределение, "Регистратор");
	
	// Дополнение <- (<без источников - для формирования записей по данным запроса>)
	ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = ОписаниеДвижений(
		"РаспределениеДолейПроизводственныхРасходов",
		"",
		ПереченьПолей(КолонкиТаблицыРаспределения),
		ПоляПотребленийРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета),
		"",
		"ДоляСтоимости",
		"ДоляСтоимости",
		"",
		"Период");
		
	ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", "ДолиПроизводственныхРасходов");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхРаспределенийДолейПроизводственныхРасходов(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Партия, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПодразделенияПоБазе, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПодразделенияДокумента, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПоВсемПодразделениям, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Распределение, Истина);
	
	Возврат ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанныхДляРаспределенияДолейПроизводственныхРасходов());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета, ПоказательКоличестваДанных)
	
	Запрос = Новый Запрос;
	
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	РасчетСебестоимостиВыполнен = ПараметрыРасчета.Свойство("РасчетСебестоимостиВыполнен");
	
	Запрос.УстановитьПараметр("Регистратор", ?(ПараметрыРасчета.Свойство("Регистратор"),ПараметрыРасчета.Регистратор, Неопределено));
	Запрос.УстановитьПараметр("РасчетСебестоимостиВыполнен", РасчетСебестоимостиВыполнен);
	Запрос.УстановитьПараметр("РасшифровкаРаспределения", ПараметрыРасчета.Свойство("РасшифровкаРаспределения"));
	Запрос.УстановитьПараметр("ВидПлановыхЦен", Справочники.ВидыЦен.ВидЦеныПоУмолчанию(Константы.ВидЦеныПлановойСтоимостиМатериаловРабот.Получить()));
	Запрос.УстановитьПараметр("ВключатьДанныеПроизводства21", Истина);
	
	Запрос.Текст = ""
		// подготовка временных таблиц
		""
		//++ НЕ УТКА
		+ ТекстРаспределениеПроизводственныхЗатратИнициализация() // вт ДолиВыпуска, Продукция
		//-- НЕ УТКА
		+ ТекстДолиПроизводственныхРасходовИнициализация() //вт СписокОрганизаций, СписокПодразделений, ВТПриход, ВТПоступило,
											//Регистраторы, РаспределитьПоПодразделениям, РаспределитьПоЭтапам, РаспределитьНаДругиеСтатьи, ОтборыБаз
		+ ТекстОтборПоГруппамПродукции() //вт ОтборПоГруппамПродукции
		+ ТекстРазделениеЗапросов()
		+ ТекстДанныеПоФактическимМатериальнымЗатратам(Запрос) //вт ДанныеПоФактическимМатериальнымЗатратам
		+ ТекстДанныеПоПредварительнымМатериальнымЗатратам() //вт ВТСредняяСтоимость, ДанныеПоПредварительнымМатериальнымЗатратам
		+ ТекстДанныеПоТрудозатратам(Запрос) //вт ДанныеПоФактическимТрудозатратам
		+ ТекстДанныеПоВыпущеннойПродукции() //вт ДанныеПоПродукции
		+ ТекстПоказателиРаспределенияПоПодразделениям() // вт ЗначенияПоказателей
		+ ТекстБазаРаспределенияДолейПоЭтапам() // вт БазаПоЭтапамДетально, БазаПоЭтапам, использует Распределить, ДанныеПоФактическимМатериальнымЗатратам,
											//ДанныеПоТрудозатратам, ДанныеПоПродукции
		+ ТекстИтогиБазыПоЭтапам() // вт ИтогиБазыПоЭтапамПодразделений, ИтогиБазыПоЭтапамВсехПодразделений, использует БазаПоЭтапам
		+ ТекстБазаРаспределенияДолейПоПодразделениям() // вт БазаПоПодразделениямДетально, БазаПоПодразделениям, использует БазаПоЭтапам, 
										// РаспределитьПоПодразделениям, ДанныеПоФактическимМатериальнымЗатратам, ДанныеПоТрудозатратам, ЗначенияПоказателей
		+ ТекстИтогиБазыПоПодразделениям() // вт ИтогиБазыПоПодразделениям, использует БазаПоПодразделениям
		// выборка данных
		+ ТекстОписаниеДанныхДляРаспределенияДолейПроизводственныхРасходов()
		+ ТекстОбъединениеЗапросов() + ТекстДолиКРаспределениюПоПодразделениям() // использует РаспределитьПоПодразделениям, ИтогиБазыПоПодразделениям
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейПоПодразделениям() // использует БазаПоПодразделениям, ИтогиБазыПоЭтапамПодразделений
		+ ТекстОбъединениеЗапросов() + ТекстДолиКРаспределениюПоЭтапамПодразделений() // использует РаспределитьПоЭтапам, ИтогиБазыПоЭтапамПодразделений
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейПоЭтапамПодразделений() // использует БазаПоЭтапам
		+ ТекстОбъединениеЗапросов() + ТекстДолиКРаспределениюПоЭтапамВсехПодразделений() // использует РаспределитьПоЭтапам, ИтогиБазыПоЭтапамВсехПодразделений
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейПоЭтапамВсехПодразделений() // использует БазаПоЭтапам
		//++ НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейНаЭтапыВручную() // использует Регистраторы
		//-- НЕ УТКА
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейНаЭтапыВручную21() // использует Регистраторы
		+ ТекстОбъединениеЗапросов() + ТекстДолиКРаспределениюНаДругиеСтатьи() // использует РаспределитьНаДругиеСтатьи, ИтогиБазыПоЭтапамВсехПодразделений
		+ ТекстОбъединениеЗапросов() + ТекстРаспределениеДолейНаДругиеСтатьиРасходов() // использует РаспределитьНаДругиеСтатьи
		+ "";
		
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Вес", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СН.ЕдиницаИзмерения", "СН"));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Объем", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СН.ЕдиницаИзмерения", "СН"));
	
	УстановитьТаблицуОтбораКорПодразделений(ПараметрыРасчета); //вт ОтборПоПодразделениям
	УстановитьТаблицуОтбораПоМатериалам(ПараметрыРасчета, "РаспределениеПрочихЗатрат"); //вт втОтборПоМатериалам
	
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// Показатель количества данных рассчитывается по формуле:
	// Количество статей расходов * количество партий производства
	ПоказательКоличестваДанных = 1;
	//++ НЕ УТКА
	ПоказательКоличестваДанных = УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета.МенеджерВременныхТаблиц, "Регистраторы")
				* УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета.МенеджерВременныхТаблиц, "ПартииПроизводстваСводно");
	//-- НЕ УТКА
	
	// Нумерация строк ВТ Данные
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"Организация", // разделитель
		"Знаменатель, ЗнаменательПоЭтапам, ДоляСтоимости", // ресурсы
		"Организация, ПартияПроизводства, Период, Регистратор"); // порядок
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"Данные");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	Если Не ПараметрыРасчета.Свойство("РасшифровкаРаспределения") Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
			"
			//++ НЕ УТКА
			|Этапы, ПартииПроизводства, ПартииПроизводстваСводно, АналитикиПартийПроизводства, ПродолжающиесяПартии, втПродукция, втДолиИтог, Продукция, ДолиВыпуска,
			//-- НЕ УТКА
			|СписокОрганизаций, СписокПодразделений, ВТПриход, ВТПоступило, Регистраторы, РаспределитьПоПодразделениям, РаспределитьПоЭтапам, ОтборыБаз,
			|ОтборПоГруппамПродукции,
			|ДанныеПоФактическимМатериальнымЗатратам,
			|ВТСредняяСтоимость, ДанныеПоПредварительнымМатериальнымЗатратам,
			|ДанныеПоТрудозатратам,
			|ДанныеПоПродукции,
			|ЗначенияПоказателей,
			|БазаПоЭтапамДетально, БазаПоЭтапам,
			|ИтогиБазыПоЭтапамПодразделений, ИтогиБазыПоЭтапамВсехПодразделений,
			|БазаПоПодразделениямДетально, БазаПоПодразделениям,
			|ИтогиБазыПоПодразделениям,
			|ОтборПоПодразделениям, втОтборПоМатериалам");
	КонецЕсли;
		
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляРаспределенияДолейПроизводственныхРасходов() Экспорт
	
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	""ТекстОписаниеДанныхДляРаспределенияДолейПроизводственныхРасходов""    КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)                   КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Период                                                               КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	ДД.ХозяйственнаяОперация                                                КАК ХозяйственнаяОперация,
	|	ДД.ГруппаПродукции                                                      КАК ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)            КАК ПравилоОтнесенияНаВыпуск,
	|	0                                                                       КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	|	0                                                                       КАК ДоляСтоимости,
	|	ДД.КорСтатьяРасходов                                                    КАК КорСтатьяРасходов,
	|	ДД.КорАналитикаРасходов                                                 КАК КорАналитикаРасходов,
	|	АП.Статья                                                               КАК КорСтатьяАктивовПассивов,
	|	АП.Аналитика                                                            КАК КорАналитикаАктивовПассивов,
	|	ДД.КорПодразделение                                                     КАК КорПодразделение,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)               КАК КорНаправлениеДеятельности,
	|	НЗП.ПартияПроизводства                                                  КАК ПартияПроизводства,
	|	НЗП.ЗаказНаПроизводство                                                 КАК ЗаказНаПроизводство,
	|	НЗП.КодСтрокиПродукция                                                  КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.КорСтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	ДД.ИдентификаторСтроки                                                  КАК ИдентификаторСтроки
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК НЗП
	|		ПО ИСТИНА
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеАктивыПассивы КАК АП
	|		ПО ИСТИНА
	|";
	
КонецФункции

// ... формирования временные таблиц

// вт СписокОрганизаций, СписокПодразделений, ВТПриход, ВТПоступило, Регистраторы, РаспределитьПоПодразделениям, РаспределитьПоЭтапам, ОтборыБаз
Функция ТекстДолиПроизводственныхРасходовИнициализация()
	
	Возврат Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов() + // вт СписокОрганизаций, СписокПодразделений, ВТПриход, ВТПоступило
	"
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Ссылка КАК Регистратор,
	|	ДД.Дата КАК Дата,
	|	ДД.Организация КАК Организация,
	|	ДД.ВариантРаспределения КАК ВариантРаспределения,
	|	ДД.БазаРаспределенияПоПодразделениям КАК БазаРаспределенияПоПодразделениям,
	|	ДД.БазаРаспределенияПоЭтапам КАК БазаРаспределенияПоЭтапам,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ДД.ДоляСтоимостиВручную КАК ДоляСтоимостиВручную,
	|	ДД.ДоляСтоимостиПоПравилам КАК ДоляСтоимостиПоПравилам,
	|	ВЫБОР 
	|		КОГДА ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
	|		КОГДА ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
	|		КОГДА ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
	|		КОГДА ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции),
	|												ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)
	|	КОНЕЦ КАК ПравилоОтнесенияНаВыпуск
	|ПОМЕСТИТЬ Регистраторы
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПоступило КАК Т
	|		ПО (Т.Организация = ДД.Организация)
	|			И (Т.Подразделение = ДД.Подразделение)
	|			И (Т.СтатьяРасходов = ДД.СтатьяРасходов)
	|			И (Т.АналитикаРасходов = ДД.АналитикаРасходов)
	|			И (Т.НаправлениеДеятельности = ДД.НаправлениеДеятельности)
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Проведен
	|	И (ДД.Ссылка = &Регистратор
	|			ИЛИ &Регистратор = НЕОПРЕДЕЛЕНО)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Ссылка,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.ВариантРаспределения,
	|	ДД.БазаРаспределенияПоПодразделениям,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяКалькуляции
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ДД.ВариантРаспределения КАК ВариантРаспределения,
	|	ДД.БазаРаспределенияПоПодразделениям КАК БазаРаспределенияПоПодразделениям,
	|	ДД.ПравилоРаспределенияПоПодразделениям КАК ПравилоРаспределенияПоПодразделениям,
	|	ДД.БазаРаспределенияПоЭтапам КАК БазаРаспределенияПоЭтапам,
	|	ДД.ДоляСтоимостиПоПравилам КАК ДоляСтоимости
	|ПОМЕСТИТЬ РаспределитьПоПодразделениям
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО (Регистраторы.Регистратор = ДД.Ссылка)
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямИЭтапамПоПравилам)
	|	ИЛИ ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямВручнуюПоЭтапамПоПравилу)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.ВариантРаспределения КАК ВариантРаспределения,
	|	ДД.БазаРаспределенияПоПодразделениям КАК БазаРаспределенияПоПодразделениям,
	|	ДД.БазаРаспределенияПоЭтапам КАК БазаРаспределенияПоЭтапам,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ДД.ДоляСтоимостиПоПравилам КАК ДоляСтоимости,
	|	ДД.Подразделение КАК КорПодразделение
	|ПОМЕСТИТЬ РаспределитьПоЭтапам
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО (Регистраторы.Регистратор = ДД.Ссылка)
	|ГДЕ
	|	(ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуВДанномПодразделении)
	|			ИЛИ ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуПоВсемПодразделениям)
	|			ИЛИ ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямИЭтапамПоПравилам))
	|	И ДД.ДоляСтоимостиПоПравилам > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Ссылка,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.ВариантРаспределения,
	|	ДД.БазаРаспределенияПоПодразделениям,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	Подразделения.СтатьяКалькуляции,
	|	Подразделения.ДоляСтоимости,
	|	Подразделения.Подразделение
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО (Регистраторы.Регистратор = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ПоБазе КАК Подразделения
	|		ПО ДД.Ссылка = Подразделения.Ссылка
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямВручнуюПоЭтапамПоПравилу)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Ссылка КАК Регистратор,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределения,
	|	НЕОПРЕДЕЛЕНО КАК БазаРаспределенияПоПодразделениям,
	|	НЕОПРЕДЕЛЕНО КАК БазаРаспределенияПоЭтапам,
	// всего долей по документу
	|	ДД.ВсегоДолейСтоимости КАК ВсегоДолейСтоимости,
	// всего долей на статьи
	|	ДД.ДоляСтоимостиНаСтатьи КАК ДоляСтоимости
	|ПОМЕСТИТЬ РаспределитьНаДругиеСтатьи
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО (Регистраторы.Регистратор = ДД.Ссылка)
	|ГДЕ
	|	ДД.ДоляСтоимостиНаСтатьи > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ЕСТЬNULL(втОтборПоМатериалам.Материал, НЕОПРЕДЕЛЕНО) КАК Материал,
	|	ЕСТЬNULL(втОтборПоВидамРабот.ВидРабот, НЕОПРЕДЕЛЕНО) КАК ВидРабот,
	|	ЕСТЬNULL(втОтборПоГруппамПродукции.ГруппаПродукции, НЕОПРЕДЕЛЕНО) КАК ГруппаПродукции,
	|	втОтборПоГруппамПродукции.ГруппаПродукции ЕСТЬ NULL  КАК ПоВсемГруппамПродукции
	|ПОМЕСТИТЬ ОтборыБаз
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
	|		ПО (Регистраторы.Регистратор = ДД.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ втОтборПоМатериалам КАК втОтборПоМатериалам
	|		ПО (втОтборПоМатериалам.Регистратор = ДД.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ОтборПоГруппамПродукции КАК втОтборПоГруппамПродукции
	|		ПО (втОтборПоГруппамПродукции.Ссылка = ДД.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ОтборПоВидамРабот КАК втОтборПоВидамРабот
	|		ПО (втОтборПоВидамРабот.Ссылка = ДД.Ссылка)
	|;
	|";
КонецФункции

// Таблицы: ДанныеПоФактическимМатериальнымЗатратам
Функция ТекстДанныеПоФактическимМатериальнымЗатратам(Запрос = Неопределено)
	
	Текст = "
	|ВЫБРАТЬ
	|	ДД.Организация                      КАК Организация,
	|	ДД.Подразделение                    КАК Подразделение,
	|	ДД.Материал                         КАК Материал,
	|	ДД.Назначение                       КАК Назначение,
	|	ДД.ГруппаПродукции                  КАК ГруппаПродукции,
	|	ДД.ПартияПроизводства               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция               КАК КодСтрокиПродукция,
	|	ДД.НаправлениеДеятельности          КАК НаправлениеДеятельности,
	|	ДД.Стоимость                        КАК Стоимость,
	|	ДД.Количество                       КАК Количество,
	|	ДД.Объем                            КАК Объем,
	|	ДД.Вес                              КАК Вес
	|ПОМЕСТИТЬ ДанныеПоФактическимМатериальнымЗатратам
	|ИЗ
	|	(
	//++ НЕ УТКА
	// материалы производства версии 2.2
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		Аналитика.Склад                     КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА ДД.КорАналитикаФинансовогоУчета = НЕОПРЕДЕЛЕНО
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ ДД.КорАналитикаФинансовогоУчета
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		ДД.КорПартия                        КАК ПартияПроизводства,
	|		ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|		НЕОПРЕДЕЛЕНО                        КАК ЗаказНаПроизводство,
	|		0                                   КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(ЭтапыПроизводства.НаправлениеДеятельности, ЕСТЬNULL(ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
	|		СУММА(
	|		(ВЫБОР
	|			КОГДА (ДД.Стоимость + ДД.СуммаДопРасходов) <> 0 ИЛИ &РасчетСебестоимостиВыполнен
	|				ТОГДА (ДД.Стоимость + ДД.СуммаДопРасходов)
	|			ИНАЧЕ ДД.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))
	|		КОНЕЦ))                             КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.Партия = ДД.Партия
	|				И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|				И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|				И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|				И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|				И (НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов ИЛИ Цены.ВидЗапасов = ДД.ВидЗапасов)
	|				И Цены.РазделУчета = ДД.РазделУчета
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ЭтапыПроизводства
	|				ПО ДД.КорПартия = ЭтапыПроизводства.Ссылка
	|		ГДЕ
	|			(&РасчетСебестоимостиВыполнен ИЛИ НЕ &РасшифровкаРаспределения)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И (ДД.КорПартия Ссылка Документ.ЭтапПроизводства2_2 ИЛИ ДД.КорПартия Ссылка Документ.ПроизводствоБезЗаказа)
	|			И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			И НЕ ДД.СлужебноеВидДвиженияПриход
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ДД.КорАналитикаФинансовогоУчета,
	|		ДД.КорПартия,
	|		ЭтапыПроизводства.НаправлениеДеятельности,
	|		ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности,
	|		ДД.АналитикаУчетаПартийПроизводства
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//-- НЕ УТКА
	// материалы производства при переработке на стороне
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		ОтчетПереработчика.Подразделение    КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА ДД.КорАналитикаФинансовогоУчета = НЕОПРЕДЕЛЕНО
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ ДД.КорАналитикаФинансовогоУчета
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		ДД.Регистратор                      КАК ПартияПроизводства,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|		НЕОПРЕДЕЛЕНО                        КАК ЗаказНаПроизводство,
	|		ДД.КодСтроки                        КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(ОтчетПереработчика.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|		СУММА(
	|		(ВЫБОР
	|			КОГДА (ДД.Стоимость + ДД.СуммаДопРасходов) <> 0 ИЛИ &РасчетСебестоимостиВыполнен
	|				ТОГДА (ДД.Стоимость + ДД.СуммаДопРасходов)
	|			ИНАЧЕ ДД.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))
	|		КОНЕЦ))                             КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.Партия = ДД.Партия
	|				И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|				И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|				И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|				И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|				И (НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов ИЛИ Цены.ВидЗапасов = ДД.ВидЗапасов)
	|				И Цены.РазделУчета = ДД.РазделУчета
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|				ПО ДД.Регистратор = ОтчетПереработчика.Ссылка
	|		ГДЕ
	|			(&РасчетСебестоимостиВыполнен ИЛИ НЕ &РасшифровкаРаспределения)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции))
	|			И НЕ ДД.СлужебноеВидДвиженияПриход
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ДД.КорАналитикаФинансовогоУчета,
	|		ДД.Регистратор,
	|		ДД.КодСтроки,
	|		ОтчетПереработчика.НаправлениеДеятельности,
	|		ОтчетПереработчика.Подразделение
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//++ НЕ УТКА
	// материалы версии 2.1 собственное производство по заказу
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		Аналитика.Склад                     КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		НЕОПРЕДЕЛЕНО                        КАК ПартияПроизводства,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|		ДД.КорПартия                        КАК ЗаказНаПроизводство,
	|		ДД.КодСтроки                        КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(Продукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|		СУММА(
	|		(ВЫБОР
	|			КОГДА (ДД.Стоимость + ДД.СуммаДопРасходов) <> 0 ИЛИ &РасчетСебестоимостиВыполнен
	|				ТОГДА (ДД.Стоимость + ДД.СуммаДопРасходов)
	|			ИНАЧЕ ДД.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))
	|		КОНЕЦ))                             КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.Партия = ДД.Партия
	|				И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|				И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|				И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|				И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|				И (НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов ИЛИ Цены.ВидЗапасов = ДД.ВидЗапасов)
	|				И Цены.РазделУчета = ДД.РазделУчета
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
	|				ПО ДД.Регистратор = МаршрутныйЛист.Ссылка
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Продукция
	|				ПО МаршрутныйЛист.Распоряжение = Продукция.Ссылка
	|				И МаршрутныйЛист.КодСтроки = Продукция.КодСтроки
	|		ГДЕ
	|			(&РасчетСебестоимостиВыполнен ИЛИ НЕ &РасшифровкаРаспределения)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И НЕ ДД.СлужебноеВидДвиженияПриход
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		Продукция.Номенклатура.ГруппаАналитическогоУчета,
	|		ДД.КорПартия,
	|		ДД.КодСтроки,
	|		МаршрутныйЛист.Этап,
	|		Продукция.Назначение.НаправлениеДеятельности
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//-- НЕ УТКА
	// материалы версии 2.1 собственное производство без заказа
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		Аналитика.Склад                     КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		НЕОПРЕДЕЛЕНО                        КАК ПартияПроизводства,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|		ДД.Регистратор                      КАК ЗаказНаПроизводство,
	|		ДД.КодСтроки                        КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(Продукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|		СУММА(
	|		(ВЫБОР
	|			КОГДА (ДД.Стоимость + ДД.СуммаДопРасходов) <> 0 ИЛИ &РасчетСебестоимостиВыполнен
	|				ТОГДА (ДД.Стоимость + ДД.СуммаДопРасходов)
	|			ИНАЧЕ ДД.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))
	|		КОНЕЦ))                             КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.Партия = ДД.Партия
	|				И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
	|				И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
	|				И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
	|				И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|				И (НЕ &УчитыватьСебестоимостьТоваровПоВидамЗапасов ИЛИ Цены.ВидЗапасов = ДД.ВидЗапасов)
	|				И Цены.РазделУчета = ДД.РазделУчета
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Продукция
	|				ПО ДД.Регистратор = Продукция.Ссылка
	|				И ДД.КодСтроки = Продукция.КодСтроки
	|		ГДЕ
	|			(&РасчетСебестоимостиВыполнен ИЛИ НЕ &РасшифровкаРаспределения)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И НЕ Продукция.Ссылка.ВыпускПоРаспоряжениям
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			И НЕ ДД.СлужебноеВидДвиженияПриход
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ДД.КорАналитикаФинансовогоУчета,
	|		ДД.Регистратор,
	|		ДД.КодСтроки,
	|		Продукция.Назначение.НаправлениеДеятельности,
	|		Продукция.Номенклатура.ГруппаАналитическогоУчета
	|
	|) КАК ДД
	|
	|;
	|";
	
	Если Запрос <> Неопределено Тогда
		Если Запрос.Параметры.РасчетСебестоимостиВыполнен Тогда
			Текст = СтрЗаменить(Текст, "ВТКэшРасчетныеОборотыСебестоимостьТоваров", "РегистрНакопления.СебестоимостьТоваров");
			Текст = СтрЗаменить(Текст, "НЕ ДД.СлужебноеВидДвиженияПриход", "ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Активность");
		КонецЕсли;
	КонецЕсли;
	
	Возврат Текст;
	
КонецФункции

// Таблицы: ДанныеПоФактическимМатериальнымЗатратам
Функция ТекстДанныеПоПредварительнымМатериальнымЗатратам()
	
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Организация                      КАК Организация,
	|	Аналитика.Номенклатура              КАК Номенклатура,
	|	Аналитика.Характеристика            КАК Характеристика,
	|	Аналитика.Склад                     КАК Склад,
	|	ДД.РазделУчета                      КАК РазделУчета,
	|	СРЕДНЕЕ(ДД.Стоимость)               КАК Стоимость,
	|	СРЕДНЕЕ(ДД.СтоимостьДопРасходы)     КАК СтоимостьДопРасходы
	|ПОМЕСТИТЬ ВТСредняяСтоимость
	|ИЗ
	|	РегистрСведений.СтоимостьТоваров.СрезПоследних(&КонецПериода, ) КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|ГДЕ
	|	(&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.РазделУчета,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Склад
	|
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Организация                      КАК Организация,
	|	ДД.Подразделение                    КАК Подразделение,
	|	ДД.Материал                         КАК Материал,
	|	ДД.Назначение                       КАК Назначение,
	|	ДД.ГруппаПродукции                  КАК ГруппаПродукции,
	|	ДД.ПартияПроизводства               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция               КАК КодСтрокиПродукция,
	|	ДД.НаправлениеДеятельности          КАК НаправлениеДеятельности,
	|	ДД.Стоимость                        КАК Стоимость,
	|	ДД.Количество                       КАК Количество,
	|	ДД.Объем                            КАК Объем,
	|	ДД.Вес                              КАК Вес
	|ПОМЕСТИТЬ ДанныеПоПредварительнымМатериальнымЗатратам
	|ИЗ
	|	(
	//++ НЕ УТКА
	// производство версии 2.2, распределение материалов, производство без заказов
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		Аналитика.Склад                     КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА ДД.КорАналитикаФинансовогоУчета = НЕОПРЕДЕЛЕНО
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ ДД.КорАналитикаФинансовогоУчета
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		ДД.КорПартия                        КАК ПартияПроизводства,
	|		ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|		НЕОПРЕДЕЛЕНО                        КАК ЗаказНаПроизводство,
	|		0                                   КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(ЭтапыПроизводства.НаправлениеДеятельности, ЕСТЬNULL(ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
	|		СУММА(ДД.Количество *
	|			(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))) КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСредняяСтоимость КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.РазделУчета = ДД.РазделУчета
	|				И Цены.Номенклатура = Аналитика.Номенклатура
	|				И Цены.Характеристика = Аналитика.Характеристика
	|				И Цены.Склад = Аналитика.Склад
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ЭтапыПроизводства
	|				ПО ДД.КорПартия = ЭтапыПроизводства.Ссылка
	|		ГДЕ
	|			(&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И (ДД.Регистратор Ссылка Документ.РаспределениеПроизводственныхЗатрат ИЛИ ДД.Регистратор Ссылка Документ.ПроизводствоБезЗаказа)
	|					И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|													ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И НЕ ДД.РасчетПартий
	|			И НЕ ДД.РасчетСебестоимости
	|			И ДД.Активность
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ДД.КорАналитикаФинансовогоУчета,
	|		ДД.КорПартия,
	|		ЭтапыПроизводства.НаправлениеДеятельности,
	|		ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности,
	|		ДД.АналитикаУчетаПартийПроизводства
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//-- НЕ УТКА
	// производство версии 2.2, 2.1 переработка на стороне
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		ОтчетПереработчика.Подразделение    КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА ДД.КорАналитикаФинансовогоУчета = НЕОПРЕДЕЛЕНО
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ ДД.КорАналитикаФинансовогоУчета
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		ДД.КорПартия                        КАК ПартияПроизводства,
	|		ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|		НЕОПРЕДЕЛЕНО                        КАК ЗаказНаПроизводство,
	|		ДД.КодСтроки                        КАК КодСтрокиПродукция,
	|		ЕСТЬNULL(ОтчетПереработчика.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|		СУММА(ДД.Количество *
	|			(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))) КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = Аналитика.Номенклатура)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|				ПО ДД.Регистратор = ОтчетПереработчика.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСредняяСтоимость КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|				И Цены.Номенклатура = Аналитика.Номенклатура
	|				И Цены.Характеристика = Аналитика.Характеристика
	|				И Цены.Склад = Аналитика.Склад
	|		ГДЕ
	|			(&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции))
	|			И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И НЕ ДД.РасчетПартий
	|			И НЕ ДД.РасчетСебестоимости
	|			И ДД.Активность
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		ОтчетПереработчика.Подразделение,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ДД.КорАналитикаФинансовогоУчета,
	|		ДД.КорПартия,
	|		ДД.КодСтроки,
	|		ОтчетПереработчика.НаправлениеДеятельности,
	|		ДД.АналитикаУчетаПартийПроизводства
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//++ НЕ УТКА
	// производство версии 2.2, этапы производства
	|	ВЫБРАТЬ
	|		Реквизиты.Организация               КАК Организация,
	|		Аналитика.Склад                     КАК Подразделение,
	|		Аналитика.Номенклатура              КАК Материал,
	|		Аналитика.Назначение                КАК Назначение,
	|		ВЫБОР
	|			КОГДА ПП.АналитикаФинансовогоУчета = НЕОПРЕДЕЛЕНО
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ ПП.АналитикаФинансовогоУчета
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		ПП.ПартияПроизводства               КАК ПартияПроизводства,
	|		ПП.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|		НЕОПРЕДЕЛЕНО                        КАК ЗаказНаПроизводство,
	|		0                                   КАК КодСтрокиПродукция,
	|		ПП.НаправлениеДеятельности          КАК НаправлениеДеятельности,
	|		СУММА(ДД.Количество *
	|			(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))) КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		Документ.ЭтапПроизводства2_2.РасходМатериаловИРабот КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = ДД.Номенклатура)
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|				ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|				ПО ДД.Ссылка = Реквизиты.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ АналитикиПартийПроизводства КАК ПП
	|				ПО Реквизиты.ВыпускающийЭтап = ПП.ПартияПроизводства
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСредняяСтоимость КАК Цены
	|				ПО Цены.Организация = Реквизиты.Организация
	|				И Цены.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|				И Цены.Номенклатура = Аналитика.Номенклатура
	|				И Цены.Характеристика = Аналитика.Характеристика
	|				И Цены.Склад = Аналитика.Склад
	|		ГДЕ
	|			(&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен)
	|			И ДД.ДатаРасхода МЕЖДУ &НачалоПериода И &КонецПериода
	|			И Реквизиты.Организация В(&МассивОрганизаций)
	|			И Реквизиты.Проведен
	|
	|	СГРУППИРОВАТЬ ПО
	|		Реквизиты.Организация,
	|		Аналитика.Склад,
	|		Аналитика.Номенклатура,
	|		Аналитика.Назначение,
	|		ПП.АналитикаФинансовогоУчета,
	|		ПП.ПартияПроизводства,
	|		ПП.НаправлениеДеятельности,
	|		ПП.АналитикаУчетаПартийПроизводства
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	//-- НЕ УТКА
	// производство 2.1, по заказам, без заказов, распределения
	|	ВЫБРАТЬ
	|		ДД.Организация                      КАК Организация,
	|		ДД.Подразделение                    КАК Подразделение,
	|		ДД.Номенклатура                     КАК Материал,
	|		ДД.Назначение                       КАК Назначение,
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции ТОГДА
	|				ВЫБОР
	//++ НЕ УТКА
	|					КОГДА НЕ ПродукцияЗаказа.Номенклатура.ГруппаАналитическогоУчета ЕСТЬ NULL
	|						ТОГДА ПродукцияЗаказа.Номенклатура.ГруппаАналитическогоУчета
	//-- НЕ УТКА
	|					КОГДА НЕ ПродукцияВыпуска.Номенклатура.ГруппаАналитическогоУчета ЕСТЬ NULL
	|						ТОГДА ПродукцияВыпуска.Номенклатура.ГруппаАналитическогоУчета
	|					ИНАЧЕ
	|						ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				КОНЕЦ
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ                               КАК ГруппаПродукции,
	|		НЕОПРЕДЕЛЕНО                        КАК ПартияПроизводства,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|		ДД.ЗаказНаПроизводство              КАК ЗаказНаПроизводство,
	|		ДД.КодСтрокиПродукция               КАК КодСтрокиПродукция,
	|		ВЫБОР
	//++ НЕ УТКА
	|			КОГДА НЕ ПродукцияЗаказа.Назначение.НаправлениеДеятельности ЕСТЬ NULL
	|				ТОГДА ПродукцияЗаказа.Назначение.НаправлениеДеятельности
	//-- НЕ УТКА
	|			КОГДА НЕ ПродукцияВыпуска.Назначение.НаправлениеДеятельности ЕСТЬ NULL
	|				ТОГДА ПродукцияВыпуска.Назначение.НаправлениеДеятельности
	|			ИНАЧЕ
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		КОНЕЦ                               КАК НаправлениеДеятельности,
	|		СУММА(ДД.Количество *
	|			(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0))) КАК Стоимость,
	|		СУММА(ДД.Количество)                КАК Количество,
	|		СУММА(&Объем * ДД.Количество)       КАК Объем,
	|		СУММА(&Вес * ДД.Количество)         КАК Вес
	|	ИЗ
	|		РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|				ПО (СН.Ссылка = ДД.Номенклатура)
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТСредняяСтоимость КАК Цены
	|				ПО Цены.Организация = ДД.Организация
	|				И Цены.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|				И Цены.Номенклатура = ДД.Номенклатура
	|				И Цены.Характеристика = ДД.Характеристика
	|				И Цены.Склад = ДД.Подразделение
	//++ НЕ УТКА
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ПродукцияЗаказа
	|				ПО ДД.ЗаказНаПроизводство = ПродукцияЗаказа.Ссылка
	|				И ДД.КодСтрокиПродукция = ПродукцияЗаказа.КодСтроки
	//-- НЕ УТКА
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК ПродукцияВыпуска
	|				ПО ДД.ЗаказНаПроизводство = ПродукцияВыпуска.Ссылка
	|				И ДД.КодСтрокиПродукция = ПродукцияВыпуска.КодСтроки
	|		ГДЕ
	|			(&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен)
	|			И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|			И ДД.Организация В(&МассивОрганизаций)
	|			И (ДД.Регистратор Ссылка Документ.РаспределениеПроизводственныхЗатрат
	|				ИЛИ ДД.Регистратор Ссылка Документ.СписаниеЗатратНаВыпуск
	//++ НЕ УТКА
	|				ИЛИ ДД.Регистратор Ссылка Документ.МаршрутныйЛистПроизводства
	//-- НЕ УТКА
	|			)
	|			И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И ДД.Активность
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Организация,
	|		ДД.Подразделение,
	|		ДД.Номенклатура,
	|		ДД.Назначение,
	//++ НЕ УТКА
	|		ПродукцияЗаказа.Номенклатура.ГруппаАналитическогоУчета,
	|		ПродукцияЗаказа.Назначение.НаправлениеДеятельности,
	//-- НЕ УТКА
	|		ПродукцияВыпуска.Номенклатура.ГруппаАналитическогоУчета,
	|		ПродукцияВыпуска.Назначение.НаправлениеДеятельности,
	|		ДД.ЗаказНаПроизводство,
	|		ДД.КодСтрокиПродукция
	|
	|) КАК ДД
	|
	|;
	|";
	
КонецФункции

// вт ЗначенияПоказателей
Функция ТекстПоказателиРаспределенияПоПодразделениям() 
	Возврат "
	|ВЫБРАТЬ
	|	Показатели.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Показатели_ВводитсяПриИзменении
	|ИЗ
	|	Справочник.ПравилаРаспределенияРасходов КАК Показатели
	|ГДЕ
	|	НЕ Показатели.ПометкаУдаления
	|	И Показатели.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении)
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Показатели.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Показатели_ВводитсяЕжемесячно
	|ИЗ
	|	Справочник.ПравилаРаспределенияРасходов КАК Показатели
	|ГДЕ
	|	НЕ Показатели.ПометкаУдаления
	|	И Показатели.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно)
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.Показатель,
	|	Т.Подразделение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении) КАК БазаРаспределения,
	|	Т.ЗначениеПоказателя
	|ПОМЕСТИТЬ ЗначенияПоказателей
	|ИЗ
	|	РегистрСведений.ЗначенияПоказателейДляРаспределенияРасходов.СрезПоследних(
	|			&НачалоПериода,
	|			Показатель В
	|				(ВЫБРАТЬ
	|					Показатели.Ссылка
	|				ИЗ
	|					Показатели_ВводитсяПриИзменении КАК Показатели)) КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Показатель,
	|	Т.Подразделение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно) КАК БазаРаспределения,
	|	Т.ЗначениеПоказателя
	|ИЗ
	|	РегистрСведений.ЗначенияПоказателейДляРаспределенияРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Показатели_ВводитсяЕжемесячно КАК Показатели
	|		ПО Т.Показатель = Показатели.Ссылка
	|ГДЕ
	|	Т.Период = &НачалоПериода
	|////////////////////////////////////////////////////////////////////////////////
	|;
	|УНИЧТОЖИТЬ Показатели_ВводитсяПриИзменении
	|////////////////////////////////////////////////////////////////////////////////
	|;
	|УНИЧТОЖИТЬ Показатели_ВводитсяЕжемесячно
	|////////////////////////////////////////////////////////////////////////////////
	|;
	|";
КонецФункции

// вт БазаПоЭтапамДетально, БазаПоЭтапам,
// Использует РаспределитьПоЭтапам, ДанныеПоФактическимМатериальнымЗатратам, ДанныеПоТрудозатратам, ДанныеПоПродукции, ОтборыБаз
Функция ТекстБазаРаспределенияДолейПоЭтапам()
	
	Возврат "
	// по стоимости материалов в производстве
	|ВЫБРАТЬ
	|	ДД.Регистратор							КАК Регистратор,
	|	ДД.Дата									КАК Дата,
	|	ДД.БазаРаспределенияПоЭтапам			КАК БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения					КАК ВариантРаспределения,
	|	Данные.Подразделение					КАК Подразделение,
	|	Данные.ПартияПроизводства				КАК ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство				КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция				КАК КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	""Материал""							КАК ВидПоказателя,
	|	Данные.Материал							КАК Материал,
	|	НЕОПРЕДЕЛЕНО							КАК Продукция,
	|	Данные.ГруппаПродукции					КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск				КАК ПравилоОтнесенияНаВыпуск,
	|	НЕОПРЕДЕЛЕНО							КАК ВидРабот,
	|	СУММА(Данные.Стоимость)					КАК Знаменатель
	|ПОМЕСТИТЬ БазаПоЭтапамДетально
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоФактическимМатериальнымЗатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат),
	|									ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// по стоимости материалов при предваритальном распределении в отчете
	|ВЫБРАТЬ
	|	ДД.Регистратор							КАК Регистратор,
	|	ДД.Дата									КАК Дата,
	|	ДД.БазаРаспределенияПоЭтапам			КАК БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения					КАК ВариантРаспределения,
	|	Данные.Подразделение					КАК Подразделение,
	|	Данные.ПартияПроизводства				КАК ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство				КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция				КАК КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
	|	""Материал""							КАК ВидПоказателя,
	|	Данные.Материал							КАК Материал,
	|	НЕОПРЕДЕЛЕНО							КАК Продукция,
	|	Данные.ГруппаПродукции					КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск				КАК ПравилоОтнесенияНаВыпуск,
	|	НЕОПРЕДЕЛЕНО							КАК ВидРабот,
	|	СУММА(Данные.Стоимость)					КАК Знаменатель
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоПредварительнымМатериальнымЗатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат),
	|									ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	// по указанным материалам в производстве
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	""Материал"",
	|	Данные.Материал,
	|	НЕОПРЕДЕЛЕНО,
	|	Данные.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР ДД.БазаРаспределенияПоЭтапам
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов) ТОГДА СУММА(Данные.Количество)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов) ТОГДА СУММА(Данные.Объем)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов) ТОГДА СУММА(Данные.Вес)
	|	КОНЕЦ
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоФактическимМатериальнымЗатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Материал = Отборы.Материал
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	// по указанным материалам при предваритальном распределении в отчете
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	""Материал"",
	|	Данные.Материал,
	|	НЕОПРЕДЕЛЕНО,
	|	Данные.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР ДД.БазаРаспределенияПоЭтапам
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов) ТОГДА СУММА(Данные.Количество)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов) ТОГДА СУММА(Данные.Объем)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов) ТОГДА СУММА(Данные.Вес)
	|	КОНЕЦ
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоПредварительнымМатериальнымЗатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Материал = Отборы.Материал
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Материал,
	|	Данные.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// по нормативной и фактической стоимости трудозатрат в производстве 2.1 и 2.2
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	""ВидРабот"",
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	Данные.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.ВидРабот,
	|	ВЫБОР ДД.БазаРаспределенияПоЭтапам
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда) ТОГДА СУММА(Данные.НормативнаяСтоимость)
	|		ИНАЧЕ СУММА(Данные.Стоимость)
	|	КОНЕЦ
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоТрудозатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда),
	|									ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда),
	|									ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.ГруппаПродукции,
	|	Данные.ВидРабот
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// по указанным трудозатратам в производстве 2.1 и 2.2
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	""ВидРабот"",
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	Данные.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.ВидРабот,
	|	СУММА(Данные.Количество)
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоТрудозатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.ВидРабот = Отборы.ВидРабот
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ГруппаПродукции,
	|	Данные.ВидРабот
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// по продукции в производстве
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	""Продукция"",
	|	НЕОПРЕДЕЛЕНО,
	|	Данные.Продукция,
	|	Данные.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР ДД.БазаРаспределенияПоЭтапам
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции) ТОГДА СУММА(Данные.Количество)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции) ТОГДА СУММА(Данные.Объем)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции) ТОГДА СУММА(Данные.Вес)
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции) ТОГДА СУММА(Данные.Стоимость)
	|	КОНЕЦ
	|ИЗ
	|	Регистраторы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|		ПО ДД.Регистратор = Отборы.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоПродукции КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции)
	|	ИЛИ ДД.БазаРаспределенияПоЭтапам = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	Данные.Подразделение,
	|	Данные.ПартияПроизводства,
	|	Данные.АналитикаУчетаПартийПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Продукция,
	|	Данные.ГруппаПродукции
	|
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.Подразделение,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	|	СУММА(ДД.Знаменатель) КАК Знаменатель
	|ПОМЕСТИТЬ БазаПоЭтапам
	|ИЗ
	|	БазаПоЭтапамДетально КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.БазаРаспределенияПоЭтапам,
	|	ДД.ВариантРаспределения,
	|	ДД.Подразделение,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск
	|;
	|";
	
КонецФункции

// вт ИтогиБазыПоЭтапамПодразделений, ИтогиБазыПоЭтапамВсехПодразделений,
// использует БазаПоЭтапам
Функция ТекстИтогиБазыПоЭтапам()
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	СУММА(ДД.Знаменатель) КАК Знаменатель
	|ПОМЕСТИТЬ
	|	ИтогиБазыПоЭтапамПодразделений
	|ИЗ
	|	БазаПоЭтапам КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Подразделение
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	СУММА(ДД.Знаменатель) КАК Знаменатель
	|ПОМЕСТИТЬ
	|	ИтогиБазыПоЭтапамВсехПодразделений
	|ИЗ
	|	БазаПоЭтапам КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор
	|;
	|";
КонецФункции

// вт БазаПоПодразделениямДетально, БазаПоПодразделениям,
// Использует БазаПоЭтапам, РаспределитьПоПодразделениям, ДанныеПоФактическимМатериальнымЗатратам, ДанныеПоТрудозатратам, ЗначенияПоказателей
Функция ТекстБазаРаспределенияДолейПоПодразделениям()
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Дата                    КАК Дата,
	|	ДД.СтатьяКалькуляции       КАК СтатьяКалькуляции,
	|	Данные.Подразделение       КАК КорПодразделение,
	|	Данные.ПартияПроизводства  КАК ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция  КАК КодСтрокиПродукция,
	|	Данные.ГруппаПродукции     КАК ГруппаПродукции,
	|	Данные.Материал            КАК МатериалВидРабот,
	|	СУММА(Данные.Стоимость)    КАК Знаменатель
	|ПОМЕСТИТЬ
	|	БазаПоПодразделениямДетально
	|ИЗ
	|	РаспределитьПоПодразделениям КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|			ПО ДД.Регистратор = Отборы.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоФактическимМатериальнымЗатратам КАК Данные
	|			ПО Данные.Организация = ДД.Организация
	|			И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|			И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|
	|ГДЕ
	|	ДД.БазаРаспределенияПоПодразделениям В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.Материал,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Дата                    КАК Дата,
	|	ДД.СтатьяКалькуляции       КАК СтатьяКалькуляции,
	|	Данные.Подразделение       КАК КорПодразделение,
	|	Данные.ПартияПроизводства  КАК ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция  КАК КодСтрокиПродукция,
	|	Данные.ГруппаПродукции     КАК ГруппаПродукции,
	|	Данные.Материал            КАК МатериалВидРабот,
	|	СУММА(Данные.Стоимость)    КАК Знаменатель
	|ИЗ
	|	РаспределитьПоПодразделениям КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|			ПО ДД.Регистратор = Отборы.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоПредварительнымМатериальнымЗатратам КАК Данные
	|			ПО Данные.Организация = ДД.Организация
	|			И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|			И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|			И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|
	|ГДЕ
	|	ДД.БазаРаспределенияПоПодразделениям В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.Материал,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Дата                    КАК Дата,
	|	ДД.СтатьяКалькуляции       КАК СтатьяКалькуляции,
	|	Данные.Подразделение       КАК КорПодразделение,
	|	Данные.ПартияПроизводства  КАК ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция  КАК КодСтрокиПродукция,
	|	Данные.ГруппаПродукции     КАК ГруппаПродукции,
	|	Данные.ВидРабот            КАК МатериалВидРабот,
	|	СУММА(Данные.Стоимость)    КАК Знаменатель
	|ИЗ
	|	РаспределитьПоПодразделениям КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборыБаз КАК Отборы
	|			ПО ДД.Регистратор = Отборы.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеПоТрудозатратам КАК Данные
	|			ПО Данные.Организация = ДД.Организация
	|			И (Данные.ГруппаПродукции = Отборы.ГруппаПродукции ИЛИ Отборы.ПоВсемГруппамПродукции)
	|			И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|				И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|
	|ГДЕ
	|	ДД.БазаРаспределенияПоПодразделениям В (ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.ВидРабот,
	|	Данные.ПартияПроизводства,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор           КАК Регистратор,
	|	ДД.Дата                  КАК Дата,
	|	Данные.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Данные.Подразделение     КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО             КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО             КАК ЗаказНаПроизводство,
	|	0                        КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО             КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО             КАК МатериалВидРабот,
	|	СУММА(Данные.ДоляСтоимости) КАК Знаменатель
	|ИЗ
	|	РаспределитьПоПодразделениям КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ПоБазе КАК Данные
	|			ПО Данные.Ссылка = ДД.Регистратор
	|
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямВручнуюПоЭтапамПоПравилу)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	Данные.СтатьяКалькуляции,
	|	Данные.Подразделение
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор          КАК Регистратор,
	|	ДД.Дата                 КАК Дата,
	|	ДД.СтатьяКалькуляции    КАК СтатьяКалькуляции,
	|	Данные.Подразделение    КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО            КАК ЗаказНаПроизводство,
	|	0                       КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО            КАК МатериалВидРабот,
	|	СУММА(Данные.ЗначениеПоказателя) КАК Знаменатель
	|ИЗ
	|		РаспределитьПоПодразделениям КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗначенияПоказателей КАК Данные
	|			ПО Данные.Показатель = ДД.ПравилоРаспределенияПоПодразделениям
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = ДД.Регистратор
	|				И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|
	|ГДЕ
	|	ДД.БазаРаспределенияПоПодразделениям = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении)
	|	ИЛИ ДД.БазаРаспределенияПоПодразделениям = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение
	|
	|;
	|
	|ВЫБРАТЬ
	|	ДД.Регистратор            КАК Регистратор,
	|	ДД.Дата                   КАК Дата,
	|	ДД.КорПодразделение       КАК КорПодразделение,
	|	ДД.СтатьяКалькуляции      КАК СтатьяКалькуляции,
	|	СУММА(ДД.Знаменатель)     КАК Знаменатель
	|ПОМЕСТИТЬ
	|	БазаПоПодразделениям
	|ИЗ
	|	БазаПоПодразделениямДетально КАК ДД
	// подразделение включается в базу только если есть база для распределения по этапам этого подразделения
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамПодразделений КАК ИтогиПоЭтапам
	|			ПО ДД.Регистратор = ИтогиПоЭтапам.Регистратор
	|			И ДД.КорПодразделение = ИтогиПоЭтапам.Подразделение
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.КорПодразделение,
	|	ДД.СтатьяКалькуляции
	|
	|ИМЕЮЩИЕ
	|	СУММА(ДД.Знаменатель) > 0
	|;
	|";
КонецФункции

// вт ИтогиБазыПоПодразделениям
// Использует БазаПоПодразделениям
Функция ТекстИтогиБазыПоПодразделениям()
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	СУММА(ДД.Знаменатель) КАК Знаменатель
	|ПОМЕСТИТЬ
	|	ИтогиБазыПоПодразделениям
	|ИЗ
	|	БазаПоПодразделениям КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор
	|;
	|";
КонецФункции

// ... выборки данных

Функция ТекстДолиКРаспределениюПоПодразделениям() // использует РаспределитьПоПодразделениям, ИтогиБазыПоПодразделениям
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстДолиКРаспределениюПоПодразделениям""                             КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)                         КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	|	Итог.Знаменатель                                                        КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	// по подразделениям распределяем итоговое значение базы по этапам
	|	ИтогиПоЭтапам.Знаменатель                                               КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ИдентификаторСтроки
	|ИЗ
	|	РаспределитьПоПодразделениям КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоПодразделениям КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамВсехПодразделений КАК ИтогиПоЭтапам
	|		ПО ИтогиПоЭтапам.Регистратор = ДД.Регистратор
	|";
КонецФункции

Функция ТекстРаспределениеДолейПоПодразделениям() // использует БазаПоПодразделениям, ИтогиБазыПоЭтапамПодразделений
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейПоПодразделениям""                             КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПодразделенияПоБазе)            КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	|	ДД.Знаменатель                                                          КАК Знаменатель,
	|	Итог.Знаменатель                                                        КАК ЗнаменательПоЭтапам,
	|	0                                                                       КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаАктивовПассивов,
	|	ДД.КорПодразделение                                                     КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                    КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ИдентификаторСтроки
	|ИЗ
	|	БазаПоПодразделениям КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамПодразделений КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|		И Итог.Подразделение = ДД.КорПодразделение
	|";
КонецФункции

Функция ТекстДолиКРаспределениюПоЭтапамПодразделений() // использует РаспределитьПоЭтапам, ИтогиБазыПоЭтапамПодразделений
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстДолиКРаспределениюПоЭтапамПодразделений""                        КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПодразделенияДокумента)         КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	|	Итог.Знаменатель                                                        КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	|	Итог.Знаменатель                                                        КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаАктивовПассивов,
	|	ДД.КорПодразделение                                                     КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                    КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ИдентификаторСтроки
	|ИЗ
	|	РаспределитьПоЭтапам КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамПодразделений КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|		И Итог.Подразделение = ДД.КорПодразделение
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуВДанномПодразделении)
	|";
КонецФункции

Функция ТекстРаспределениеДолейПоЭтапамПодразделений() // использует БазаПоЭтапам
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейПоЭтапамПодразделений""                     КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПоЭтапамПодразделений)       КАК ТипЗаписи,
	|	ЛОЖЬ                                                                 КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	ДД.Дата                                                              КАК Период,
	|	ДД.Регистратор                                                       КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                         КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                         КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства)  КАК ХозяйственнаяОперация,
	|	ДД.ГруппаПродукции                                                   КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                                          КАК ПравилоОтнесенияНаВыпуск,
	|	ДД.Знаменатель                                                       КАК Знаменатель,
	|	0                                                                    КАК ЗнаменательПоЭтапам,
	|	0                                                                    КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                     КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорНаправлениеДеятельности,
	|	ДД.ПартияПроизводства                                                КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                                               КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                                                КАК КодСтрокиПродукция,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	БазаПоЭтапам КАК ДД
	|	
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуВДанномПодразделении)
	|	ИЛИ ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямВручнуюПоЭтапамПоПравилу)
	|	ИЛИ ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоПодразделениямИЭтапамПоПравилам)
	|";
КонецФункции

Функция ТекстДолиКРаспределениюПоЭтапамВсехПодразделений() // использует РаспределитьПоЭтапам, ИтогиБазыПоЭтапамВсехПодразделений
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстДолиКРаспределениюПоЭтапамВсехПодразделений""                    КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПоВсемПодразделениям)           КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	|	Итог.Знаменатель                                                        КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	|	Итог.Знаменатель                                                        КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                        КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                    КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ИдентификаторСтроки
	|ИЗ
	|	РаспределитьПоЭтапам КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамВсехПодразделений КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуПоВсемПодразделениям)
	|";
КонецФункции

Функция ТекстРаспределениеДолейПоЭтапамВсехПодразделений() // использует БазаПоЭтапам
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейПоЭтапамВсехПодразделений""                 КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПоВсемЭтапам)                КАК ТипЗаписи,
	|	ЛОЖЬ                                                                 КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	ДД.Дата                                                              КАК Период,
	|	ДД.Регистратор                                                       КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО                                                         КАК Организация,
	|	НЕОПРЕДЕЛЕНО                                                         КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства)  КАК ХозяйственнаяОперация,
	|	ДД.ГруппаПродукции                                                   КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                                          КАК ПравилоОтнесенияНаВыпуск,
	|	ДД.Знаменатель                                                       КАК Знаменатель,
	|	0                                                                    КАК ЗнаменательПоЭтапам,
	|	0                                                                    КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                     КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорНаправлениеДеятельности,
	|	ДД.ПартияПроизводства                                                КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                                               КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                                                КАК КодСтрокиПродукция,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                         КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	БазаПоЭтапам КАК ДД
	|	
	|ГДЕ
	|	ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуПоВсемПодразделениям)
	|";
КонецФункции

//++ НЕ УТКА
Функция ТекстРаспределениеДолейНаЭтапыВручную() // использует Регистраторы
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейНаЭтапыВручную""                            КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)                  КАК ТипЗаписи,
	|	ИСТИНА                                                               КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	РР.Дата                                                              КАК Период,
	|	РР.Регистратор                                                       КАК Регистратор,
	|	РР.Организация                                                       КАК Организация,
	|	РР.Подразделение                                                     КАК Подразделение,
	|	РР.НаправлениеДеятельности                                           КАК НаправлениеДеятельности,
	|	РР.СтатьяРасходов                                                    КАК СтатьяРасходов,
	|	РР.АналитикаРасходов                                                 КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства)  КАК ХозяйственнаяОперация,
	|	Аналитики.АналитикаФинансовогоУчета                                  КАК ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)          КАК ПравилоОтнесенияНаВыпуск,
	|	РР.ДоляСтоимостиВручную                                              КАК Знаменатель,
	|	0                                                                    КАК ЗнаменательПоЭтапам,
	|	ДД.ДоляСтоимости                                                     КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                     КАК КорПодразделение,
	|	Аналитики.НаправлениеДеятельности                                    КАК КорНаправлениеДеятельности,
	|	ДД.ПартияПроизводства                                                КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ЗаказНаПроизводство,
	|	0                                                                    КАК КодСтрокиПродукция,
	|	ДД.АналитикаУчетаПартийПроизводства                                  КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ПартииПроизводства КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК РР
	|		ПО ДД.Ссылка = РР.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиПартийПроизводства КАК Аналитики
	|		ПО ДД.ПартияПроизводства = Аналитики.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = Аналитики.АналитикаУчетаПартийПроизводства
	|ГДЕ
	|	РР.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамВручнуюПоВсемПодразделениям)
	|";
КонецФункции
//-- НЕ УТКА

Функция ТекстРаспределениеДолейНаЭтапыВручную21() // использует Регистраторы
	Возврат "
	//++ НЕ УТКА
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейНаЭтапыВручную21""                          КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)                  КАК ТипЗаписи,
	|	ИСТИНА                                                               КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	РР.Дата                                                              КАК Период,
	|	РР.Регистратор                                                       КАК Регистратор,
	|	РР.Организация                                                       КАК Организация,
	|	РР.Подразделение                                                     КАК Подразделение,
	|	ЕСТЬNULL(Продукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	РР.СтатьяРасходов                                                    КАК СтатьяРасходов,
	|	РР.АналитикаРасходов                                                 КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И Продукция.Номенклатура.ГруппаАналитическогоУчета <> ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                КАК ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)          КАК ПравилоОтнесенияНаВыпуск,
	|	РР.ДоляСтоимостиВручную                                              КАК Знаменатель,
	|	0                                                                    КАК ЗнаменательПоЭтапам,
	|	ДД.ДоляСтоимости                                                     КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаАктивовПассивов,
	|	ДД.Этап.Подразделение                                                КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                                               КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                                                КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.Вручную КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК РР
	|		ПО ДД.Ссылка = РР.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Продукция
	|		ПО ДД.ЗаказНаПроизводство = Продукция.Ссылка
	|		И ДД.КодСтрокиПродукция = Продукция.КодСтроки
	|ГДЕ
	|	РР.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамВручнуюПоВсемПодразделениям)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	//-- НЕ УТКА
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейНаЭтапыВручную""                            КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)                  КАК ТипЗаписи,
	|	ИСТИНА                                                               КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                               КАК ВидДвижения,
	|	РР.Дата                                                              КАК Период,
	|	РР.Регистратор                                                       КАК Регистратор,
	|	РР.Организация                                                       КАК Организация,
	|	РР.Подразделение                                                     КАК Подразделение,
	|	ЕСТЬNULL(Продукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	РР.СтатьяРасходов                                                    КАК СтатьяРасходов,
	|	РР.АналитикаРасходов                                                 КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И Продукция.Номенклатура.ГруппаАналитическогоУчета <> ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                КАК ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)          КАК ПравилоОтнесенияНаВыпуск,
	|	РР.ДоляСтоимостиВручную                                              КАК Знаменатель,
	|	0                                                                    КАК ЗнаменательПоЭтапам,
	|	ДД.ДоляСтоимости                                                     КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорАналитикаАктивовПассивов,
	|	Продукция.Ссылка.Подразделение                                       КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                         КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ПартияПроизводства,
	|	ДД.ДокументВыпуска                                                   КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки                                                         КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО                                                         КАК АналитикаУчетаПартийПроизводства,
	|	ДД.СтатьяКалькуляции                                                 КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                         КАК ИдентификаторСтроки
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ВыпускиБезРаспоряжения КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК РР
	|		ПО ДД.Ссылка = РР.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Продукция
	|		ПО ДД.ДокументВыпуска = Продукция.Ссылка
	|		И ДД.КодСтроки = Продукция.КодСтроки
	|ГДЕ
	|	РР.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамВручнуюПоВсемПодразделениям)
	|";
КонецФункции

Функция ТекстДолиКРаспределениюНаДругиеСтатьи() // использует РаспределитьНаДругиеСтатьи, ИтогиБазыПоЭтапамВсехПодразделений
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстДолиКРаспределениюНаДругиеСтатьи""                               КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение)                  КАК ТипЗаписи,
	|	ИСТИНА                                                                  КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(Итог.Знаменатель, ДД.ВсегоДолейСтоимости - ДД.ДоляСтоимости)   КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	|	ДД.ВсегоДолейСтоимости                                                  КАК ДоляСтоимости,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорСтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                        КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО                                                            КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ИдентификаторСтроки
	|ИЗ
	|	РаспределитьНаДругиеСтатьи КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИтогиБазыПоЭтапамВсехПодразделений КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|";
КонецФункции

Функция ТекстРаспределениеДолейНаДругиеСтатьиРасходов() // использует РаспределитьНаДругиеСтатьи
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРаспределениеДолейНаДругиеСтатьиРасходов""                       КАК ЗапросИсточник,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписаниеНаРасходы)              КАК ТипЗаписи,
	|	ЛОЖЬ                                                                    КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)    КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                                  КАК ВидДвижения,
	|	ДД.Дата                                                                 КАК Период,
	|	ДД.Регистратор                                                          КАК Регистратор,
	|	ДД.Организация                                                          КАК Организация,
	|	ДД.Подразделение                                                        КАК Подразделение,
	|	ДД.НаправлениеДеятельности                                              КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                                       КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                                    КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов)     КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПравилоОтнесенияНаВыпуск,
	// ВсегоДолейНаСтатьи
	|	ДД.ДоляСтоимости                                                        КАК Знаменатель,
	|	0                                                                       КАК ЗнаменательПоЭтапам,
	// ДоляСтоимостиСтатьи
	|	Строки.ДоляСтоимости                                                    КАК ДоляСтоимости,
	|	ВЫБОР
	|		КОГДА Строки.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
	|			ТОГДА Строки.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                   КАК КорСтатьяРасходов,
	|	Строки.АналитикаРасходов                                                КАК КорАналитикаРасходов,
	|	ВЫБОР
	|		КОГДА Строки.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|			ТОГДА Строки.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                   КАК КорСтатьяАктивовПассивов,
	|	Строки.АналитикаАктивовПассивов                                         КАК КорАналитикаАктивовПассивов,
	|	ДД.Подразделение                                                        КАК КорПодразделение,
	|	Строки.НаправлениеДеятельности                                          КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК ЗаказНаПроизводство,
	|	0                                                                       КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                                            КАК СтатьяКалькуляции,
	|	Строки.ИдентификаторСтроки                                              КАК ИдентификаторСтроки
	|ИЗ
	|	РаспределитьНаДругиеСтатьи КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
	|		ПО ДД.Регистратор = Строки.Ссылка
	|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы Тогда
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен, Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходов, АналитикаРасходов");
		
		Если Приход.Знаменатель = 0 Или Приход.ДоляСтоимости - Расход.Знаменатель = 0 Тогда
			// распределение только на статьи расходов
			// 100 * ДоляСтоимостиСтатьи / ВсегоДолейНаСтатьи
			РасчетнаяПартия.ДоляСтоимости = Расход.ДоляСтоимости * 100 / Расход.Знаменатель;
		Иначе
			// БазаПоЭтапам * ДоляСтоимостиСтатьи / (ВсегоДолейПоДокументу - ВсегоДолейНаСтатьи)
			РасчетнаяПартия.ДоляСтоимости = Приход.Знаменатель * Расход.ДоляСтоимости / (Приход.ДоляСтоимости - Расход.Знаменатель);
		КонецЕсли;
		
		// сохраним исходную долю стоимости для отчета
		РасчетнаяПартия.Знаменатель = Расход.ДоляСтоимости;
		
	Иначе
		
		Если Приход.Знаменатель = 0 Тогда
			Возврат;
		КонецЕсли;
		
		// расчетная партия заполняется на наибольшее общее вычитаемое
		ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.ДоляСтоимости = Окр(ЗнаменательСписания * Приход.ДоляСтоимости / Приход.Знаменатель, 3);
		
		// корректируем базу расчета в приходе
		Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
		Приход.ДоляСтоимости  = Приход.ДоляСтоимости - РасчетнаяПартия.ДоляСтоимости;
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен, Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходов, АналитикаРасходов");
		
		Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПодразделенияПоБазе Тогда
			РасчетнаяПартия.Знаменатель = Расход.ЗнаменательПоЭтапам;
		Иначе
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "СтатьяКалькуляции");
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область ПроцедурыЭтапа16_РаспределениеПрочихНаВыходныеИзделия

// Инициализация данных

Функция ТаблицаДляРаспределенияПрочихРасходовНЗП(ПараметрыРасчета)
	
	Возврат ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПрочихРасходовНЗП());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПрочихРасходовНЗП(ПараметрыРасчета, ПоказательКоличестваДанных)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ""
		+ ТекстПрочиеРасходыНЗПИнициализация() // вт МатериальныеЗатратыПроизводства, ТрудозатратыПроизводства, МатериальныеИТрудозатратыПроизводства, РаботыДляДавальца, ВыпущеннаяПродукция,
								//втОстатокПоказателя, втПартииБезДвижения, ПредыдущиеПартии, втПартииДляОтнесенияРасходов, ПартииДляОтнесенияРасходов, ОстаткиПриходыРасходы
		+ ТекстРазделениеЗапросов()
		+ ТекстОписаниеДанныхДляПрочихРасходовНЗП()
		+ ТекстОбъединениеЗапросов() + ТекстПриходыПрочихРасходовНЗП() // использует ДолиПроизводственныхРасходов, МатериальныеЗатратыПроизводства, ТрудозатратыПроизводства
		+ ТекстОбъединениеЗапросов() + ТекстРасходыПрочихРасходовНЗППоМатериалам() // использует ПартииДляОтнесенияРасходов, МатериальныеЗатратыПроизводства
		+ ТекстОбъединениеЗапросов() + ТекстРасходыПрочихРасходовНЗППоТрудозатратам() // использует ПартииДляОтнесенияРасходов, ТрудозатратыПроизводства
		+ ТекстОбъединениеЗапросов() + ТекстРасходыПрочихРасходовНЗППоМатериальнымИТрудозатратам() // использует ПартииДляОтнесенияРасходов, МатериальныеИТрудозатратыПроизводства
		+ ТекстОбъединениеЗапросов() + ТекстРасходыПрочихРасходовНЗППоПродукции() // использует ПартииДляОтнесенияРасходов, ВыпущеннаяПродукция
		+ "";
		
	ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ПартииДляОтнесенияРасходов");
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Запрос.Выполнить();
	
	// За показатель количества данных принимается количество партий производства, на которые распределяются расходы
	ПоказательКоличестваДанных = УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета.МенеджерВременныхТаблиц, "ПартииДляОтнесенияРасходов");
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"МатериальныеЗатратыПроизводства, ТрудозатратыПроизводства, РаботыДляДавальца,
		//++ НЕ УТКА
		|ИтогиДолейПоПартиямПроизводства,
		//-- НЕ УТКА
		|ВыпущеннаяПродукция, ВыпущеннаяПродукцияСводно, втОстатокПоказателя, втПартииБезДвижения,
		|ПредыдущиеПартии, втПартииДляОтнесенияРасходов, втПартииДляОтнесенияРасходовСводно, ПартииДляОтнесенияРасходовСводно,
		|СчетчикРегистраторов, ОстаткиПриходыРасходы, ПриходыПоказателя, ПогрешностьПоказателя");
	
КонецПроцедуры

// Тексты запросов

// ... описания данных

Функция ТекстОписаниеДанныхДляПрочихРасходовНЗП()
	Возврат
	"ВЫБРАТЬ ПЕРВЫЕ 0
	|	""ТекстОписаниеДанныхДляПрочихРасходовНЗП""								КАК ЗапросИсточник,
	|	0 																		КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)					КАК ТипЗаписи,
	|	ЛОЖЬ 																	КАК РасчетЗавершен,
	|	ДД.ВидДвижения 															КАК ВидДвижения,
	|	ДД.Период 																КАК Период,
	|	ДД.Регистратор 															КАК Регистратор,
	|	ДД.Организация 															КАК Организация,
	|	ДД.Подразделение 														КАК Подразделение,
	|	ДД.ПартияПроизводства													КАК ПартияПроизводства,
	|	Себестоимость.АналитикаУчетаПартийПроизводства							КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство 													КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция 													КАК КодСтрокиПродукция,
	|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) 				КАК Спецификация,
	|	ДД.Этап 												 				КАК Этап,
	|	ДД.СтатьяКалькуляции 													КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов 														КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов 													КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции 														КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск												КАК ПравилоОтнесенияНаВыпуск,
	|	ДД.АналитикаУчетаПродукции 												КАК АналитикаУчетаПродукции,
	|	0 																		КАК Знаменатель,
	|	ДД.КоличествоПродукции													КАК КоличествоПродукции,
	|	0																		КАК ДоляСтоимости,
	|	ДД.Стоимость 															КАК Стоимость,
	|	ДД.СтоимостьБезНДС 														КАК СтоимостьБезНДС,
	|	ДД.СтоимостьРегл 														КАК СтоимостьРегл,
	|	ДД.ПостояннаяРазница 													КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница 													КАК ВременнаяРазница,
	|	ДД.ПоказательОтнесенияНаВыпуск											КАК ПоказательОтнесенияНаВыпуск,
	|	ДД.ПоказательОтнесенияНаПартию											КАК ПоказательОтнесенияНаПартию,
	|	ЛОЖЬ 																	КАК Первичное,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) 				КАК ХозяйственнаяОперация,
	|	ДД.РазделУчета 															КАК РазделУчета,
	|	ДД.ВидЗапасов 															КАК ВидЗапасов,
	|	ДД.ДокументДвижения 													КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) 							КАК Назначение,
	|	ДД.ДокументИсточник 													КАК ДокументИсточник,
	|	ДД.ДокументВыпуска 														КАК ДокументВыпуска,
	|	ДД.Продукция 															КАК Продукция,
	|	ДД.ХарактеристикаПродукции 												КАК ХарактеристикаПродукции
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ ПЕРВЫЕ 0
	|						Себестоимость.АналитикаУчетаПартийПроизводства
	|					ИЗ
	|						РегистрНакопления.СебестоимостьТоваров КАК Себестоимость) КАК Себестоимость
	|	ПО ИСТИНА
	|";
КонецФункции

Функция ТекстОписаниеДанныхДляПартийОтнесенияРасходов() Экспорт
	Возврат
	"ВЫБРАТЬ ПЕРВЫЕ 0
	|	ДД.Организация                                 КАК Организация,
	|	ДД.Регистратор                                 КАК Регистратор,
	|	ДД.Подразделение                               КАК Подразделение,
	|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
	|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск,
	|	ДД.ПоказательОтнесенияНаВыпуск                 КАК ПоказательОстаток
	|//ВоВременнуюТаблицу
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|";
КонецФункции

// ... формирования временные таблиц

// вт МатериальныеЗатратыПроизводства, ТрудозатратыПроизводства, МатериальныеИТрудозатратыПроизводства, ВыпущеннаяПродукция, втОстатокПоказателя, втПартииБезДвижения, ПредыдущиеПартии,
//    втПартииДляОтнесенияРасходов, ПартииДляОтнесенияРасходов, ОстаткиПриходыРасходы
Функция ТекстПрочиеРасходыНЗПИнициализация()
	
	Возврат "
		// используется для подмены аналитики давальческой работы
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		// поля соединения
		|	ДД.Регистратор                        КАК Регистратор,
		|	ДД.КорАналитикаУчетаНоменклатуры      КАК АналитикаУчетаНоменклатуры,
		// поля замены
		|	ДД.РазделУчета                        КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры         КАК КорАналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ
		|	РаботыДляДавальца
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|									ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.СлужебноеВидДвиженияПриход            КАК СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение                         КАК Подразделение,
		|	ДД.РегистраторРасхода                    КАК РегистраторРасхода,
		|	ДД.ДатаПроизводства                      КАК ДатаПроизводства,
		|	ДД.ПартияПроизводства                    КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства      КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                   КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                    КАК КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу                    КАК РасходРавенПриходу,
		|	ДД.КорАналитикаУчетаНоменклатуры         КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета                        КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(ДД.Стоимость) КАК ЧИСЛО(23,10)) КАК Стоимость
		|ПОМЕСТИТЬ МатериальныеЗатратыПроизводства
		|ИЗ
		|	(
		//++ НЕ УТКА
		// данные производства 2.2 по этапам
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                            КАК СлужебноеВидДвиженияПриход,
		|		КлючиАналитик.Склад                                      КАК Подразделение,
		|		ДД.Партия                                                КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                    КАК ДатаПроизводства,
		|		ДД.Партия                                                КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства                      КАК АналитикаУчетаПартийПроизводства,
		|		НЕОПРЕДЕЛЕНО                                             КАК ЗаказНаПроизводство,
		|		0                                                        КАК КодСтрокиПродукция,
		|		ЛОЖЬ                                                     КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры                         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                        КАК КорРазделУчета,
		|		ДД.Количество *
		|			(ЕСТЬNULL(Цены.Стоимость, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьЗабалансовая, 0))           КАК Стоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитик
		|			ПО КлючиАналитик.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|
		|	ГДЕ
		|		КлючиАналитик.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.Партия ССЫЛКА Документ.ЭтапПроизводства2_2
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		// данные производства 2.2 без заказов
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                            КАК СлужебноеВидДвиженияПриход,
		|		КлючиАналитик.Склад                                      КАК Подразделение,
		|		ДД.Партия                                                КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                    КАК ДатаПроизводства,
		|		ДД.Партия                                                КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства                      КАК АналитикаУчетаПартийПроизводства,
		|		НЕОПРЕДЕЛЕНО                                             КАК ЗаказНаПроизводство,
		|		0                                                        КАК КодСтрокиПродукция,
		|		ИСТИНА                                                   КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры                         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                        КАК КорРазделУчета,
		|		ДД.Количество *
		|			(ЕСТЬNULL(Цены.Стоимость, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьЗабалансовая, 0))           КАК Стоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитик
		|			ПО КлючиАналитик.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|
		|	ГДЕ
		|		КлючиАналитик.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|		И ДД.Партия ССЫЛКА Документ.ПроизводствоБезЗаказа
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		//-- НЕ УТКА
		// данные производства 2.2 и 2.1 по отчетам переработчика
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                            КАК СлужебноеВидДвиженияПриход,
		|		Реквизиты.Подразделение                                  КАК Подразделение,
		|		ДД.Регистратор                                           КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                    КАК ДатаПроизводства,
		|		ДД.Регистратор                                           КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		НЕОПРЕДЕЛЕНО                                             КАК ЗаказНаПроизводство,
		|		ДД.КодСтроки                                             КАК КодСтрокиПродукция,
		|		ИСТИНА                                                   КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры                         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                        КАК КорРазделУчета,
		|		ДД.Количество *
		|			(ЕСТЬNULL(Цены.Стоимость, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьЗабалансовая, 0))           КАК Стоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК Реквизиты
		|			ПО Реквизиты.Ссылка = ДД.Регистратор
		|
		|	ГДЕ
		|		НЕ ДД.СлужебноеВидДвиженияПриход
		|		И ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		//++ НЕ УТКА
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		// данные производства 2.1 по заказам
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                            КАК СлужебноеВидДвиженияПриход,
		|		КлючиАналитик.Склад                                      КАК Подразделение,
		|		ДД.Регистратор                                           КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                    КАК ДатаПроизводства,
		|		НЕОПРЕДЕЛЕНО                                             КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		ДД.Партия                                                КАК ЗаказНаПроизводство,
		|		ДД.КодСтроки                                             КАК КодСтрокиПродукция,
		|		ЛОЖЬ                                                     КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры                         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                        КАК КорРазделУчета,
		|		ДД.Количество *
		|			(ЕСТЬNULL(Цены.Стоимость, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьЗабалансовая, 0))           КАК Стоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитик
		|			ПО КлючиАналитик.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|
		|	ГДЕ
		|		ДД.Партия ССЫЛКА Документ.ЗаказНаПроизводство
		//-- НЕ УТКА
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		// данные производства 2.1 без заказов
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                            КАК СлужебноеВидДвиженияПриход,
		|		КлючиАналитик.Склад                                      КАК Подразделение,
		|		ДД.Регистратор                                           КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                    КАК ДатаПроизводства,
		|		НЕОПРЕДЕЛЕНО                                             КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		ДД.Регистратор                                           КАК ЗаказНаПроизводство,
		|		ДД.КодСтроки                                             КАК КодСтрокиПродукция,
		|		ИСТИНА                                                   КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры                         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                        КАК КорРазделУчета,
		|		ДД.Количество *
		|			(ЕСТЬNULL(Цены.Стоимость, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)
		|			+ ЕСТЬNULL(Цены.СтоимостьЗабалансовая, 0))           КАК Стоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитик
		|			ПО КлючиАналитик.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК ВыпускПродукции
		|			ПО ДД.Регистратор = ВыпускПродукции.Ссылка
		|
		|	ГДЕ
		|		НЕ ВыпускПродукции.ВыпускПоРаспоряжениям
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|
		|) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение,
		|	ДД.РегистраторРасхода,
		|	ДД.ДатаПроизводства,
		|	ДД.ПартияПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.СлужебноеВидДвиженияПриход                           КАК СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение                                        КАК Подразделение,
		|	ДД.РегистраторРасхода                                   КАК РегистраторРасхода,
		|	ДД.ДатаПроизводства                                     КАК ДатаПроизводства,
		|	ДД.ПартияПроизводства                                   КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                     КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                                  КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                                   КАК КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу                                   КАК РасходРавенПриходу,
		|	ДД.КорАналитикаУчетаНоменклатуры                        КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета                                       КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(ВЫБОР
		|		КОГДА СУММА(ДД.Стоимость) = 0
		|			ТОГДА СУММА(ДД.НормативнаяСтоимость)
		|		ИНАЧЕ СУММА(ДД.Стоимость)
		|	КОНЕЦ КАК ЧИСЛО(23,10))                                 КАК Стоимость
		|ПОМЕСТИТЬ ТрудозатратыПроизводства
		|ИЗ
		|	(
		//++ НЕ УТКА
		// производство 2.2 по заказам
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                           КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                                        КАК Подразделение,
		|		ДД.ПартияПроизводства                                   КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                   КАК ДатаПроизводства,
		|		ДД.ПартияПроизводства                                   КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства                     КАК АналитикаУчетаПартийПроизводства,
		|		НЕОПРЕДЕЛЕНО                                            КАК ЗаказНаПроизводство,
		|		0                                                       КАК КодСтрокиПродукция,
		|		ЛОЖЬ                                                    КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаПродукции                           КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                       КАК КорРазделУчета,
		|		ДД.Стоимость                                            КАК Стоимость,
		|		ДД.НормативнаяСтоимость                                 КАК НормативнаяСтоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ГДЕ
		|		ДД.ПартияПроизводства Ссылка Документ.ЭтапПроизводства2_2
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		// производство 2.2 без заказов
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                           КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                                        КАК Подразделение,
		|		ДД.ПартияПроизводства                                   КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                   КАК ДатаПроизводства,
		|		ДД.ПартияПроизводства                                   КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства                     КАК АналитикаУчетаПартийПроизводства,
		|		НЕОПРЕДЕЛЕНО                                            КАК ЗаказНаПроизводство,
		|		0                                                       КАК КодСтрокиПродукция,
		|		ИСТИНА                                                  КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаПродукции                           КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                       КАК КорРазделУчета,
		|		ДД.Стоимость                                            КАК Стоимость,
		|		ДД.НормативнаяСтоимость                                 КАК НормативнаяСтоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ГДЕ
		|		ДД.ПартияПроизводства Ссылка Документ.ПроизводствоБезЗаказа
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		// производство 2.1 по заказам
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                           КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                                        КАК Подразделение,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Регистратор
		|		КОНЕЦ                                                   КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                   КАК ДатаПроизводства,
		|		НЕОПРЕДЕЛЕНО                                            КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		ДД.ЗаказНаПроизводство                                  КАК ЗаказНаПроизводство,
		|		ДД.КодСтрокиПродукция                                   КАК КодСтрокиПродукция,
		|		ЛОЖЬ                                                    КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаПродукции                           КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                       КАК КорРазделУчета,
		|		ДД.Стоимость                                            КАК Стоимость,
		|		ДД.НормативнаяСтоимость                                 КАК НормативнаяСтоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ГДЕ
		|		ДД.ЗаказНаПроизводство <> ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		//-- НЕ УТКА
		// производство 2.1 без заказов
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход                           КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                                        КАК Подразделение,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Регистратор
		|		КОНЕЦ                                                   КАК РегистраторРасхода,
		|		ВЫБОР
		|			КОГДА ДД.СлужебноеВидДвиженияПриход
		|				ТОГДА НЕОПРЕДЕЛЕНО
		|			ИНАЧЕ ДД.Период
		|		КОНЕЦ                                                   КАК ДатаПроизводства,
		|		НЕОПРЕДЕЛЕНО                                            КАК ПартияПроизводства,
		|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|		ДД.ДокументВыпуска                                      КАК ЗаказНаПроизводство,
		|		ДД.КодСтроки                                            КАК КодСтрокиПродукция,
		|		ИСТИНА                                                  КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаПродукции                           КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                                       КАК КорРазделУчета,
		|		ДД.Стоимость                                            КАК Стоимость,
		|		ДД.НормативнаяСтоимость                                 КАК НормативнаяСтоимость
		|	ИЗ
		|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ГДЕ
		|		ДД.ДокументВыпуска <> НЕОПРЕДЕЛЕНО
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|
		|	) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение,
		|	ДД.РегистраторРасхода,
		|	ДД.ДатаПроизводства,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		// материальные и трудозатраты производства
		|ВЫБРАТЬ
		|	ДД.СлужебноеВидДвиженияПриход            КАК СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение                         КАК Подразделение,
		|	ДД.РегистраторРасхода                    КАК РегистраторРасхода,
		|	ДД.ДатаПроизводства                      КАК ДатаПроизводства,
		|	ДД.ПартияПроизводства                    КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства      КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                   КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                    КАК КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу                    КАК РасходРавенПриходу,
		|	ДД.КорАналитикаУчетаНоменклатуры         КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета                        КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(ДД.Стоимость) КАК ЧИСЛО(23,10)) КАК Стоимость
		|ПОМЕСТИТЬ МатериальныеИТрудозатратыПроизводства
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход            КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                         КАК Подразделение,
		|		ДД.РегистраторРасхода                    КАК РегистраторРасхода,
		|		ДД.ДатаПроизводства                      КАК ДатаПроизводства,
		|		ДД.ПартияПроизводства                    КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства      КАК АналитикаУчетаПартийПроизводства,
		|		ДД.ЗаказНаПроизводство                   КАК ЗаказНаПроизводство,
		|		ДД.КодСтрокиПродукция                    КАК КодСтрокиПродукция,
		|		ДД.РасходРавенПриходу                    КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                        КАК КорРазделУчета,
		|		ДД.Стоимость                             КАК Стоимость
		|	ИЗ МатериальныеЗатратыПроизводства КАК ДД
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.СлужебноеВидДвиженияПриход            КАК СлужебноеВидДвиженияПриход,
		|		ДД.Подразделение                         КАК Подразделение,
		|		ДД.РегистраторРасхода                    КАК РегистраторРасхода,
		|		ДД.ДатаПроизводства                      КАК ДатаПроизводства,
		|		ДД.ПартияПроизводства                    КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства      КАК АналитикаУчетаПартийПроизводства,
		|		ДД.ЗаказНаПроизводство                   КАК ЗаказНаПроизводство,
		|		ДД.КодСтрокиПродукция                    КАК КодСтрокиПродукция,
		|		ДД.РасходРавенПриходу                    КАК РасходРавенПриходу,
		|		ДД.КорАналитикаУчетаНоменклатуры         КАК КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета                        КАК КорРазделУчета,
		|		ДД.Стоимость                             КАК Стоимость
		|	ИЗ ТрудозатратыПроизводства КАК ДД) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.СлужебноеВидДвиженияПриход,
		|	ДД.Подразделение,
		|	ДД.РегистраторРасхода,
		|	ДД.ДатаПроизводства,
		|	ДД.ПартияПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.РасходРавенПриходу,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета
		|;
		|
		//++ НЕ УТКА
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства КАК АналитикаУчетаПартийПроизводства,
		|	СУММА(ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|ПОМЕСТИТЬ ИтогиДолейПоПартиямПроизводства
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	ДД.АналитикаУчетаПартийПроизводства
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) > 0
		|;
		|
		//-- НЕ УТКА
		|////////////////////////////////////////////////////////////////////////////
		// выпущенная продукция без заказов 2.1
		// Для выпусков без заказа распределяется доля стоимости прихода, то есть распределяется весь приход на выпуск и код строки.
		// В связи с этим даныне по продукции выбираются в разрезе документов распределения.
		|ВЫБРАТЬ
		|	Доли.Регистратор                                        КАК Регистратор,
		|	Реквизиты.Ссылка                                        КАК РегистраторРасхода,
		|	Реквизиты.Дата                                          КАК ДатаПроизводства,
		|	НЕОПРЕДЕЛЕНО                                            КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	Реквизиты.Подразделение                                 КАК Подразделение,
		|	Реквизиты.Ссылка                                        КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки                                            КАК КодСтрокиПродукция,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаВПодразделении.КлючАналитики, ДД.АналитикаУчетаНоменклатуры)
		|		ИНАЧЕ ЕСТЬNULL(АналитикаВПодразделенииБезНазначения.КлючАналитики, АналитикаДокументаБезНазначения.КлючАналитики)
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветХранение)
		|		КОГДА Реквизиты.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ                                                   КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(Доли.ДоляСтоимости) КАК ЧИСЛО(23,10))    КАК Стоимость
		|ПОМЕСТИТЬ ВыпущеннаяПродукция
		|ИЗ
		|	Документ.ВыпускПродукции.Товары КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитикиДокумента
		|	ПО
		|		ДД.АналитикаУчетаНоменклатуры = КлючиАналитикиДокумента.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаДокументаБезНазначения
		|	ПО
		|		АналитикаДокументаБезНазначения.Номенклатура = КлючиАналитикиДокумента.Номенклатура
		|		И АналитикаДокументаБезНазначения.Характеристика = КлючиАналитикиДокумента.Характеристика
		|		И АналитикаДокументаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаДокументаБезНазначения.СтатьяКалькуляции = КлючиАналитикиДокумента.СтатьяКалькуляции
		|		И АналитикаДокументаБезНазначения.Склад = КлючиАналитикиДокумента.Склад
		|		И АналитикаДокументаБезНазначения.Серия = КлючиАналитикиДокумента.Серия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|	ПО
		|		ДД.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И ДД.Характеристика = АналитикаВПодразделении.Характеристика
		|		И ДД.Назначение = АналитикаВПодразделении.Назначение
		|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = АналитикаВПодразделении.СтатьяКалькуляции
		|		И (Реквизиты.Подразделение = АналитикаВПодразделении.Склад)
		|		И ВЫБОР
		|			КОГДА ДД.СтатусУказанияСерий = 14
		|			ТОГДА ДД.Серия = АналитикаВПодразделении.Серия
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) = АналитикаВПодразделении.Серия
		|		КОНЕЦ
		|		И ДД.СписатьНаРасходы
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделенииБезНазначения
		|	ПО
		|		АналитикаВПодразделенииБезНазначения.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И АналитикаВПодразделенииБезНазначения.Характеристика = АналитикаВПодразделении.Характеристика
		|		И АналитикаВПодразделенииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаВПодразделенииБезНазначения.СтатьяКалькуляции = АналитикаВПодразделении.СтатьяКалькуляции
		|		И АналитикаВПодразделенииБезНазначения.Склад = АналитикаВПодразделении.Склад
		|		И АналитикаВПодразделенииБезНазначения.Серия = АналитикаВПодразделении.Серия
		|		И ДД.СписатьНаРасходы
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиПроизводственныхРасходов КАК Доли
		|		ПО ДД.Ссылка = Доли.ЗаказНаПроизводство
		|		И ДД.КодСтроки = Доли.КодСтрокиПродукция
		|		И Реквизиты.Подразделение = Доли.КорПодразделение
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И НЕ Реквизиты.ВыпускПоРаспоряжениям
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|
		|СГРУППИРОВАТЬ ПО
		|	Реквизиты.Дата,
		|	Реквизиты.Ссылка,
		|	Реквизиты.Подразделение,
		|	ДД.КодСтроки,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаВПодразделении.КлючАналитики, ДД.АналитикаУчетаНоменклатуры)
		|		ИНАЧЕ ЕСТЬNULL(АналитикаВПодразделенииБезНазначения.КлючАналитики, АналитикаДокументаБезНазначения.КлючАналитики)
		|	КОНЕЦ,
		|	ДД.ПередатьДавальцу,
		|	ДД.ВидЗапасов.ТипЗапасов,
		|	Доли.Регистратор
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// выпущенная продукция по этапам 2.2
		// Данные по этапам выбираются без разреза документов распределения, т.к. в модуле расчета себестоимости обсчитывается каждая партия.
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО                                            КАК Регистратор,
		|	Реквизиты.ВыпускающийЭтап                               КАК РегистраторРасхода,
		|	ДД.ДатаПроизводства                                     КАК ДатаПроизводства,
		|	Реквизиты.ВыпускающийЭтап                               КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	Реквизиты.Подразделение                                 КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО                                            КАК ЗаказНаПроизводство,
		|	0                                                       КАК КодСтрокиПродукция,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаДокументаБезНазначения.КлючАналитики
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветХранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ                                                   КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|		КОГДА ДД.ДоляСтоимости = 0
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ ДД.ДоляСтоимости
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                                КАК Стоимость
		|ИЗ
		|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитикиДокумента
		|	ПО
		|		ДД.АналитикаУчетаНоменклатуры = КлючиАналитикиДокумента.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаДокументаБезНазначения
		|	ПО
		|		АналитикаДокументаБезНазначения.Номенклатура = КлючиАналитикиДокумента.Номенклатура
		|		И АналитикаДокументаБезНазначения.Характеристика = КлючиАналитикиДокумента.Характеристика
		|		И АналитикаДокументаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаДокументаБезНазначения.СтатьяКалькуляции = КлючиАналитикиДокумента.СтатьяКалькуляции
		|		И АналитикаДокументаБезНазначения.Склад = КлючиАналитикиДокумента.Склад
		|		И АналитикаДокументаБезНазначения.Серия = КлючиАналитикиДокумента.Серия
		|
		|ГДЕ
		|	ДД.Произведено
		|	И ДД.ДатаПроизводства МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДатаПроизводства,
		|	Реквизиты.ВыпускающийЭтап,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаДокументаБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	Реквизиты.Подразделение,
		|	ДД.ВидЗапасов
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// выпущенная продукция без заказов 2.2
		// Для производства без заказов доля прихода распределяется пропорционально долям стоимости выходных изделий.
		|ВЫБРАТЬ
		|	Доли.Регистратор                                        КАК Регистратор,
		|	ДД.Ссылка                                               КАК РегистраторРасхода,
		|	Реквизиты.Дата                                          КАК ДатаПроизводства,
		|	ДД.Ссылка                                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                     КАК АналитикаУчетаПартийПроизводства,
		|	Реквизиты.Подразделение                                 КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО                                            КАК ЗаказНаПроизводство,
		|	0                                                       КАК КодСтрокиПродукция,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаПоПолучателю.КлючАналитики, АналитикаПриСписанииНаРасходы.КлючАналитики)
		|		ИНАЧЕ
		|			ЕСТЬNULL(АналитикаПоПолучателюБезНазначения.КлючАналитики, АналитикаПриСписанииНаРасходыБезНазначения.КлючАналитики)
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветХранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ                                                   КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(
		|		ВЫРАЗИТЬ(ВЫБОР
		|			КОГДА ДД.ДоляСтоимости = 0
		|				ТОГДА ДД.Количество
		|			ИНАЧЕ ДД.ДоляСтоимости
		|		КОНЕЦ * Доли.ДоляСтоимости КАК ЧИСЛО(23,10))/ ИтогиДолейСтоимости.ДоляСтоимости) КАК ЧИСЛО(23,10)) КАК Стоимость
		|ИЗ
		|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПоПолучателю
		|		ПО АналитикаПоПолучателю.Номенклатура = ДД.Номенклатура
		|		И АналитикаПоПолучателю.Характеристика = ДД.Характеристика
		|		И АналитикаПоПолучателю.Серия = ДД.Серия
		|		И АналитикаПоПолучателю.Склад = ДД.Получатель
		|		И АналитикаПоПолучателю.Назначение = ДД.Назначение
		|		И АналитикаПоПолучателю.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И НЕ ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПоПолучателюБезНазначения
		|		ПО АналитикаПоПолучателюБезНазначения.Номенклатура = ДД.Номенклатура
		|		И АналитикаПоПолучателюБезНазначения.Характеристика = ДД.Характеристика
		|		И АналитикаПоПолучателюБезНазначения.Серия = ДД.Серия
		|		И АналитикаПоПолучателюБезНазначения.Склад = ДД.Получатель
		|		И АналитикаПоПолучателюБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПоПолучателюБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И НЕ ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПриСписанииНаРасходы
		|		ПО АналитикаПриСписанииНаРасходы.Номенклатура = ДД.Номенклатура
		|		И АналитикаПриСписанииНаРасходы.Характеристика = ДД.Характеристика
		|		И АналитикаПриСписанииНаРасходы.Серия = ДД.Серия
		|		И АналитикаПриСписанииНаРасходы.Склад = Реквизиты.Подразделение
		|		И АналитикаПриСписанииНаРасходы.Назначение = ДД.Назначение
		|		И АналитикаПриСписанииНаРасходы.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПриСписанииНаРасходыБезНазначения
		|		ПО АналитикаПриСписанииНаРасходыБезНазначения.Номенклатура = ДД.Номенклатура
		|		И АналитикаПриСписанииНаРасходыБезНазначения.Характеристика = ДД.Характеристика
		|		И АналитикаПриСписанииНаРасходыБезНазначения.Серия = ДД.Серия
		|		И АналитикаПриСписанииНаРасходыБезНазначения.Склад = Реквизиты.Подразделение
		|		И АналитикаПриСписанииНаРасходыБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПриСписанииНаРасходыБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|		И ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиПроизводственныхРасходов КАК Доли
		|		ПО ДД.Ссылка = Доли.ПартияПроизводства
		|		И ДД.АналитикаУчетаПартийПроизводства = Доли.АналитикаУчетаПартийПроизводства
		|		И Реквизиты.Подразделение = Доли.КорПодразделение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИтогиДолейПоПартиямПроизводства КАК ИтогиДолейСтоимости
		|		ПО ДД.Ссылка = ИтогиДолейСтоимости.ПартияПроизводства
		|		И ДД.АналитикаУчетаПартийПроизводства = ИтогиДолейСтоимости.АналитикаУчетаПартийПроизводства
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	Реквизиты.Дата,
		|	Реквизиты.Подразделение,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаПоПолучателю.КлючАналитики, АналитикаПриСписанииНаРасходы.КлючАналитики)
		|		ИНАЧЕ
		|			ЕСТЬNULL(АналитикаПоПолучателюБезНазначения.КлючАналитики, АналитикаПриСписанииНаРасходыБезНазначения.КлючАналитики)
		|	КОНЕЦ,
		|	Доли.Регистратор
		//-- НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// продукция по отчетам переработчика 2.2 и 2.1
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО                                            КАК Регистратор,
		|	Реквизиты.Ссылка                                        КАК РегистраторРасхода,
		|	Реквизиты.Дата                                          КАК ДатаПроизводства,
		|	Реквизиты.Ссылка                                        КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	Реквизиты.Подразделение                                 КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО                                            КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки                                            КАК КодСтрокиПродукция,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаДокументаБезНазначения.КлючАналитики
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК КорРазделУчета,
		|	СУММА(ДД.Количество)                                    КАК Стоимость
		|ИЗ
		|	Документ.ОтчетПереработчика.Продукция КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитикиДокумента
		|	ПО
		|		ДД.АналитикаУчетаНоменклатуры = КлючиАналитикиДокумента.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаДокументаБезНазначения
		|	ПО
		|		АналитикаДокументаБезНазначения.Номенклатура = КлючиАналитикиДокумента.Номенклатура
		|		И АналитикаДокументаБезНазначения.Характеристика = КлючиАналитикиДокумента.Характеристика
		|		И АналитикаДокументаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаДокументаБезНазначения.СтатьяКалькуляции = КлючиАналитикиДокумента.СтатьяКалькуляции
		|		И АналитикаДокументаБезНазначения.Склад = КлючиАналитикиДокумента.Склад
		|		И АналитикаДокументаБезНазначения.Серия = КлючиАналитикиДокумента.Серия
		|
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|
		|СГРУППИРОВАТЬ ПО
		|	Реквизиты.Дата,
		|	Реквизиты.Ссылка,
		|	Реквизиты.Подразделение,
		|	ДД.КодСтроки,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаДокументаБезНазначения.КлючАналитики
		|	КОНЕЦ
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		// выпущенная продукция по заказам 2.1
		// При производстве по заказам доля стоимости наследуется из маршрутного листа.
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО                                            КАК Регистратор,
		|	Реквизиты.Ссылка                                        КАК РегистраторРасхода,
		|	Реквизиты.Дата                                          КАК ДатаПроизводства,
		|	НЕОПРЕДЕЛЕНО                                            КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	Реквизиты.Подразделение                                 КАК Подразделение,
		|	ДД.Распоряжение.Распоряжение                            КАК ЗаказНаПроизводство,
		|	ДД.Распоряжение.КодСтроки                               КАК КодСтрокиПродукция,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаВПодразделении.КлючАналитики, ДД.АналитикаУчетаНоменклатуры)
		|		ИНАЧЕ ЕСТЬNULL(АналитикаВПодразделенииБезНазначения.КлючАналитики, АналитикаДокументаБезНазначения.КлючАналитики)
		|	КОНЕЦ                                                   КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Реквизиты.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ                                                   КАК КорРазделУчета,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА МаршрутныйЛист.ДоляСтоимости = 0 ИЛИ МаршрутныйЛист.Количество = 0
		|				ТОГДА ДД.Количество
		|			ИНАЧЕ
		|				ВЫРАЗИТЬ(ДД.Количество * МаршрутныйЛист.ДоляСтоимости КАК ЧИСЛО(23,10)) / МаршрутныйЛист.Количество
		|			КОНЕЦ) КАК ЧИСЛО(23,10))                        КАК Стоимость
		|ИЗ
		|	Документ.ВыпускПродукции.Товары КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Реквизиты
		|		ПО ДД.Ссылка = Реквизиты.Ссылка
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК КлючиАналитикиДокумента
		|	ПО
		|		ДД.АналитикаУчетаНоменклатуры = КлючиАналитикиДокумента.КлючАналитики
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаДокументаБезНазначения
		|	ПО
		|		АналитикаДокументаБезНазначения.Номенклатура = КлючиАналитикиДокумента.Номенклатура
		|		И АналитикаДокументаБезНазначения.Характеристика = КлючиАналитикиДокумента.Характеристика
		|		И АналитикаДокументаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаДокументаБезНазначения.СтатьяКалькуляции = КлючиАналитикиДокумента.СтатьяКалькуляции
		|		И АналитикаДокументаБезНазначения.Склад = КлючиАналитикиДокумента.Склад
		|		И АналитикаДокументаБезНазначения.Серия = КлючиАналитикиДокумента.Серия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|	ПО
		|		ДД.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И ДД.Характеристика = АналитикаВПодразделении.Характеристика
		|		И ДД.Назначение = АналитикаВПодразделении.Назначение
		|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = АналитикаВПодразделении.СтатьяКалькуляции
		|		И (Реквизиты.Подразделение = АналитикаВПодразделении.Склад)
		|		И ВЫБОР
		|			КОГДА ДД.СтатусУказанияСерий = 14
		|			ТОГДА ДД.Серия = АналитикаВПодразделении.Серия
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) = АналитикаВПодразделении.Серия
		|		КОНЕЦ
		|		И НЕ Реквизиты.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделенииБезНазначения
		|	ПО
		|		АналитикаВПодразделенииБезНазначения.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И АналитикаВПодразделенииБезНазначения.Характеристика = АналитикаВПодразделении.Характеристика
		|		И АналитикаВПодразделенииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаВПодразделенииБезНазначения.СтатьяКалькуляции = АналитикаВПодразделении.СтатьяКалькуляции
		|		И АналитикаВПодразделенииБезНазначения.Склад = АналитикаВПодразделении.Склад
		|		И АналитикаВПодразделенииБезНазначения.Серия = АналитикаВПодразделении.Серия
		|		И НЕ Реквизиты.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства.ВыходныеИзделия КАК МаршрутныйЛист
		|		ПО ДД.Распоряжение = МаршрутныйЛист.Ссылка
		|		И ДД.КодСтроки = МаршрутныйЛист.КодСтроки
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Реквизиты.ВыпускПоРаспоряжениям
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Реквизиты.Проведен
		|	И Реквизиты.Организация В(&МассивОрганизаций)
		|
		|СГРУППИРОВАТЬ ПО
		|	Реквизиты.Дата,
		|	Реквизиты.Ссылка,
		|	Реквизиты.Подразделение,
		|	ДД.Распоряжение.Распоряжение,
		|	ДД.Распоряжение.КодСтроки,
		|	ВЫБОР
		|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
		|			ТОГДА ЕСТЬNULL(АналитикаВПодразделении.КлючАналитики, ДД.АналитикаУчетаНоменклатуры)
		|		ИНАЧЕ ЕСТЬNULL(АналитикаВПодразделенииБезНазначения.КлючАналитики, АналитикаДокументаБезНазначения.КлючАналитики)
		|	КОНЕЦ,
		|	ДД.ПередатьДавальцу,
		|	ДД.ВидЗапасов.ТипЗапасов
		//-- НЕ УТКА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		// Данные по продукции свернуто по идентификаторам партий. Требуется для корректного расчета производства 2.1 по заказам.
		// В этом случае по одному заказу может быть несколько документов выпуска, а приходное движение должно быть одно.
		|ВЫБРАТЬ
		|	ДД.Регистратор                                        КАК Регистратор,
		|	ДД.ПартияПроизводства                                 КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                   КАК АналитикаУчетаПартийПроизводства,
		|	ДД.Подразделение                                      КАК Подразделение,
		|	ДД.ЗаказНаПроизводство                                КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                                 КАК КодСтрокиПродукция,
		|	СУММА(ДД.Стоимость)                                   КАК Стоимость
		|ПОМЕСТИТЬ ВыпущеннаяПродукцияСводно
		|ИЗ
		|	ВыпущеннаяПродукция КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Остатки.Организация                                 КАК Организация,
		|	Остатки.Подразделение                               КАК Подразделение,
		|	Остатки.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	Остатки.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	Остатки.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	Остатки.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	Остатки.СтатьяРасходов                              КАК СтатьяРасходов,
		|	Остатки.АналитикаРасходов                           КАК АналитикаРасходов,
		|	Остатки.ГруппаПродукции                             КАК ГруппаПродукции,
		|	Остатки.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск,
		|	Остатки.ПоказательОтнесенияНаВыпускОстаток          КАК ПоказательОстаток
		|ПОМЕСТИТЬ втОстатокПоказателя
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(
		|			&ГраницаКонецПредыдущегоПериода,
		|			Организация В (&МассивОрганизаций)) КАК Остатки
		|ГДЕ
		|	Остатки.ПоказательОтнесенияНаВыпускОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|ПОМЕСТИТЬ втПартииБезДвижения
		|ИЗ
		|	втОстатокПоказателя КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДолиПроизводственныхРасходов КАК Доли
		|			ПО ДД.Организация = Доли.Организация
		|			И ДД.Подразделение = Доли.КорПодразделение
		|			И ДД.ПартияПроизводства = Доли.ПартияПроизводства
		|			И ДД.АналитикаУчетаПартийПроизводства = Доли.АналитикаУчетаПартийПроизводства
		|			И ДД.ЗаказНаПроизводство = Доли.ЗаказНаПроизводство
		|			И ДД.КодСтрокиПродукция = Доли.КодСтрокиПродукция
		|			И ДД.СтатьяКалькуляции = Доли.СтатьяКалькуляции
		|			И ДД.СтатьяРасходов = Доли.СтатьяРасходов
		|			И ДД.АналитикаРасходов = Доли.АналитикаРасходов
		|			И ДД.ГруппаПродукции = Доли.ГруппаПродукции
		|			И ДД.ПравилоОтнесенияНаВыпуск = Доли.ПравилоОтнесенияНаВыпуск
		|ГДЕ
		|	Доли.Организация ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск,
		|	МАКСИМУМ(ДД.Регистратор)                       КАК Регистратор
		|ПОМЕСТИТЬ ПредыдущиеПартии
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартииБезДвижения КАК Аналитики
		|			ПО ДД.Организация = Аналитики.Организация
		|			И ДД.Подразделение = Аналитики.Подразделение
		|			И ДД.ПартияПроизводства = Аналитики.ПартияПроизводства
		|			И ДД.ЗаказНаПроизводство = Аналитики.ЗаказНаПроизводство
		|			И ДД.КодСтрокиПродукция = Аналитики.КодСтрокиПродукция
		|			И ДД.СтатьяКалькуляции = Аналитики.СтатьяКалькуляции
		|			И ДД.СтатьяРасходов = Аналитики.СтатьяРасходов
		|			И ДД.АналитикаРасходов = Аналитики.АналитикаРасходов
		|			И ДД.ГруппаПродукции = Аналитики.ГруппаПродукции
		|			И ДД.ПравилоОтнесенияНаВыпуск = Аналитики.ПравилоОтнесенияНаВыпуск
		|ГДЕ
		|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ДД.Регистратор                                 КАК Регистратор,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|ПОМЕСТИТЬ втПартииДляОтнесенияРасходов
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.Организация                                 КАК Организация,
		|		ДД.Регистратор                                 КАК Регистратор,
		|		ДД.Подразделение                               КАК Подразделение,
		|		ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|		ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|		ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|		ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|		ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|		ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|		ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|		ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|		ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|	ИЗ
		|		ПредыдущиеПартии КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		Доли.Организация                                 КАК Организация,
		|		Доли.Регистратор                                 КАК Регистратор,
		|		Доли.КорПодразделение                            КАК Подразделение,
		|		Доли.ПартияПроизводства                          КАК ПартияПроизводства,
		|		Доли.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|		Доли.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|		Доли.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|		Доли.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|		Доли.СтатьяРасходов                              КАК СтатьяРасходов,
		|		Доли.АналитикаРасходов                           КАК АналитикаРасходов,
		|		Доли.ГруппаПродукции                             КАК ГруппаПродукции,
		|		Доли.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|	ИЗ
		|		ДолиПроизводственныхРасходов КАК Доли
		|	) КАК ДД
		|
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ДД.Регистратор                                 КАК Регистратор,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|ПОМЕСТИТЬ ПартииДляОтнесенияРасходов
		|ИЗ
		|	втПартииДляОтнесенияРасходов КАК ДД
		|
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	МАКСИМУМ(ДД.Регистратор)                       КАК Регистратор,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск
		|ПОМЕСТИТЬ втПартииДляОтнесенияРасходовСводно
		|ИЗ
		|	ПартииДляОтнесенияРасходов КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск
		|
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ВЫБОР
		|		КОГДА ДД.Регистратор.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ                                          КАК УчитыватьВТекущемПериоде,
		|	ДД.Регистратор                                 КАК Регистратор,
		|	ДД.Подразделение                               КАК Подразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск,
		|	ЕСТЬNULL(Остатки.ПоказательОстаток, 0)         КАК ПоказательОстаток
		|ПОМЕСТИТЬ ПартииДляОтнесенияРасходовСводно
		|ИЗ
		|	втПартииДляОтнесенияРасходовСводно КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ втОстатокПоказателя КАК Остатки
		|		ПО ДД.Организация = Остатки.Организация
		|		И ДД.Подразделение = Остатки.Подразделение
		|		И ДД.ПартияПроизводства = Остатки.ПартияПроизводства
		|		И ДД.ЗаказНаПроизводство = Остатки.ЗаказНаПроизводство
		|		И ДД.КодСтрокиПродукция = Остатки.КодСтрокиПродукция
		|		И ДД.СтатьяКалькуляции = Остатки.СтатьяКалькуляции
		|		И ДД.СтатьяРасходов = Остатки.СтатьяРасходов
		|		И ДД.АналитикаРасходов = Остатки.АналитикаРасходов
		|		И ДД.ГруппаПродукции = Остатки.ГруппаПродукции
		|		И ДД.ПравилоОтнесенияНаВыпуск = Остатки.ПравилоОтнесенияНаВыпуск
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация                                 КАК Организация,
		|	ДД.КорПодразделение                            КАК КорПодразделение,
		|	ДД.ПартияПроизводства                          КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства            КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                         КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                          КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                           КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                              КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                             КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                    КАК ПравилоОтнесенияНаВыпуск,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.Регистратор)           КАК КоличествоРегистраторов
		|ПОМЕСТИТЬ СчетчикРегистраторов 
		|ИЗ
		|	ДолиПроизводственныхРасходов КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.КорПодразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор                                      КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.Подразделение                                    КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	ВЫРАЗИТЬ(ДД.ПоказательОстаток КАК ЧИСЛО(23,10))     КАК Остаток,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА (Материальные.СлужебноеВидДвиженияПриход ИЛИ Материальные.РасходРавенПриходу) И ДД.УчитыватьВТекущемПериоде ТОГДА
		|				ЕСТЬNULL(Материальные.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК Приход,
		// сумма для расхода выбирается полностью и будет корректироваться далее
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА НЕ Материальные.СлужебноеВидДвиженияПриход ТОГДА
		|				ЕСТЬNULL(Материальные.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК Расход
		|ПОМЕСТИТЬ ОстаткиПриходыРасходы
		|ИЗ
		|	ПартииДляОтнесенияРасходовСводно КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ МатериальныеЗатратыПроизводства КАК Материальные
		|		ПО Материальные.Подразделение = ДД.Подразделение
		|		И Материальные.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Материальные.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Материальные.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Материальные.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ПоказательОстаток
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор                                      КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.Подразделение                                    КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	ДД.ПоказательОстаток                                КАК Остаток,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА (Трудозатраты.СлужебноеВидДвиженияПриход ИЛИ Трудозатраты.РасходРавенПриходу) И ДД.УчитыватьВТекущемПериоде ТОГДА
		|				ЕСТЬNULL(Трудозатраты.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК КонечныйОстаток,
		// сумма для расхода выбирается полностью и будет корректироваться далее
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА НЕ Трудозатраты.СлужебноеВидДвиженияПриход ТОГДА
		|				ЕСТЬNULL(Трудозатраты.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК Расход
		|ИЗ
		|	ПартииДляОтнесенияРасходовСводно КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТрудозатратыПроизводства КАК Трудозатраты
		|		ПО Трудозатраты.Подразделение = ДД.Подразделение
		|		И Трудозатраты.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Трудозатраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Трудозатраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Трудозатраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ПоказательОстаток
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Регистратор                                      КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.Подразделение                                    КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	ДД.ПоказательОстаток                                КАК Остаток,
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА (Затраты.СлужебноеВидДвиженияПриход ИЛИ Затраты.РасходРавенПриходу) И ДД.УчитыватьВТекущемПериоде ТОГДА
		|				ЕСТЬNULL(Затраты.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК КонечныйОстаток,
		// сумма для расхода выбирается полностью и будет корректироваться далее
		|	ВЫРАЗИТЬ(СУММА(ВЫБОР
		|			КОГДА НЕ Затраты.СлужебноеВидДвиженияПриход ТОГДА
		|				ЕСТЬNULL(Затраты.Стоимость, 0)
		|			ИНАЧЕ
		|				0
		|	КОНЕЦ) КАК ЧИСЛО(23,10))                            КАК Расход
		|ИЗ
		|	ПартииДляОтнесенияРасходовСводно КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ МатериальныеИТрудозатратыПроизводства КАК Затраты
		|		ПО Затраты.Подразделение = ДД.Подразделение
		|		И Затраты.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Затраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Затраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Затраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ПоказательОстаток
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Период                                           КАК Период,
		|	ДД.Регистратор                                      КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.КорПодразделение                                 КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	ВЫРАЗИТЬ(СУММА(ЕСТЬNULL(МатериальныеИТрудозатраты.Стоимость, ЕСТЬNULL(Материальные.Стоимость, ЕСТЬNULL(Трудозатраты.Стоимость, Продукция.Стоимость)))) КАК ЧИСЛО(23,10)) КАК ПоказательОтнесенияНаВыпускИсходный,
		|	ВЫРАЗИТЬ(СУММА(ЕСТЬNULL(МатериальныеИТрудозатраты.Стоимость, ЕСТЬNULL(Материальные.Стоимость, ЕСТЬNULL(Трудозатраты.Стоимость, Продукция.Стоимость)))) / СчетчикРегистраторов.КоличествоРегистраторов КАК ЧИСЛО(23,10)) КАК ПоказательОтнесенияНаВыпуск,
		|	СчетчикРегистраторов.КоличествоРегистраторов        КАК КоличествоРегистраторов,
		|	ДД.ДоляСтоимости                                    КАК ПоказательОтнесенияНаПартию,
		|	ПартииСводно.Регистратор                            КАК ДокументИсточник
		|ПОМЕСТИТЬ ПриходыПоказателя 
		|ИЗ
		|	ДолиПроизводственныхРасходов КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ МатериальныеЗатратыПроизводства КАК Материальные
		|		ПО Материальные.Подразделение = ДД.КорПодразделение
		|		И Материальные.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Материальные.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Материальные.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Материальные.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И (Материальные.СлужебноеВидДвиженияПриход ИЛИ Материальные.РасходРавенПриходу)
		|		И ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ ТрудозатратыПроизводства КАК Трудозатраты
		|		ПО Трудозатраты.Подразделение = ДД.КорПодразделение
		|		И Трудозатраты.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Трудозатраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Трудозатраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Трудозатраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И (Трудозатраты.СлужебноеВидДвиженияПриход ИЛИ Трудозатраты.РасходРавенПриходу)
		|		И ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ МатериальныеИТрудозатратыПроизводства КАК МатериальныеИТрудозатраты
		|		ПО МатериальныеИТрудозатраты.Подразделение = ДД.КорПодразделение
		|		И МатериальныеИТрудозатраты.ПартияПроизводства = ДД.ПартияПроизводства
		|		И МатериальныеИТрудозатраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И МатериальныеИТрудозатраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И МатериальныеИТрудозатраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И (МатериальныеИТрудозатраты.СлужебноеВидДвиженияПриход ИЛИ МатериальныеИТрудозатраты.РасходРавенПриходу)
		|		И ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпущеннаяПродукцияСводно КАК Продукция
		|		ПО Продукция.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Продукция.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
		|		И Продукция.Подразделение = ДД.КорПодразделение
		|		И Продукция.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Продукция.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)
		|		И (Продукция.Регистратор = ДД.Регистратор ИЛИ Продукция.Регистратор = НЕОПРЕДЕЛЕНО)
		|	ЛЕВОЕ СОЕДИНЕНИЕ СчетчикРегистраторов КАК СчетчикРегистраторов
		|		ПО ДД.Организация = СчетчикРегистраторов.Организация
		|		И ДД.КорПодразделение = СчетчикРегистраторов.КорПодразделение
		|		И ДД.ПартияПроизводства = СчетчикРегистраторов.ПартияПроизводства
		|		И ДД.ЗаказНаПроизводство = СчетчикРегистраторов.ЗаказНаПроизводство
		|		И ДД.КодСтрокиПродукция = СчетчикРегистраторов.КодСтрокиПродукция
		|		И ДД.СтатьяКалькуляции = СчетчикРегистраторов.СтатьяКалькуляции
		|		И ДД.СтатьяРасходов = СчетчикРегистраторов.СтатьяРасходов
		|		И ДД.АналитикаРасходов = СчетчикРегистраторов.АналитикаРасходов
		|		И ДД.ГруппаПродукции = СчетчикРегистраторов.ГруппаПродукции
		|		И ДД.АналитикаУчетаПартийПроизводства = СчетчикРегистраторов.АналитикаУчетаПартийПроизводства
		|		И ДД.ПравилоОтнесенияНаВыпуск = СчетчикРегистраторов.ПравилоОтнесенияНаВыпуск
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПартииДляОтнесенияРасходовСводно КАК ПартииСводно
		|		ПО ПартииСводно.Организация = ДД.Организация
		|		И ПартииСводно.Подразделение = ДД.КорПодразделение
		|		И ПартииСводно.ПартияПроизводства = ДД.ПартияПроизводства
		|		И ПартииСводно.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И ПартииСводно.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И ПартииСводно.СтатьяКалькуляции = ДД.СтатьяКалькуляции
		|		И ПартииСводно.СтатьяРасходов = ДД.СтатьяРасходов
		|		И ПартииСводно.АналитикаРасходов = ДД.АналитикаРасходов
		|		И ПартииСводно.ГруппаПродукции = ДД.ГруппаПродукции
		|		И ПартииСводно.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
		|ГДЕ
		|	НЕ Материальные.ПартияПроизводства ЕСТЬ NULL
		|	ИЛИ НЕ Трудозатраты.ПартияПроизводства ЕСТЬ NULL
		|	ИЛИ НЕ МатериальныеИТрудозатраты.ПартияПроизводства ЕСТЬ NULL
		|	ИЛИ НЕ Продукция.ПартияПроизводства ЕСТЬ NULL
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорПодразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДоляСтоимости,
		|	СчетчикРегистраторов.КоличествоРегистраторов,
		|	ПартииСводно.Регистратор
		|
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Период                                           КАК Период,
		|	МАКСИМУМ(ДД.Регистратор)                            КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.Подразделение                                    КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	ДД.ПоказательОтнесенияНаВыпускИсходный - ВЫРАЗИТЬ(ДД.КоличествоРегистраторов * ДД.ПоказательОтнесенияНаВыпуск КАК ЧИСЛО(23,10)) КАК ПоказательОтнесенияНаВыпускПогрешность,
		|	ДД.ПоказательОтнесенияНаПартию                      КАК ПоказательОтнесенияНаПартию,
		|	ДД.ДокументИсточник                                 КАК ДокументИсточник
		|ПОМЕСТИТЬ ПогрешностьПоказателя 
		|ИЗ
		|	ПриходыПоказателя КАК ДД
		|
		|ГДЕ
		|	ДД.ПоказательОтнесенияНаВыпускИсходный - ДД.КоличествоРегистраторов * ДД.ПоказательОтнесенияНаВыпуск <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ПоказательОтнесенияНаПартию,
		|	ДД.КоличествоРегистраторов,
		|	ДД.ДокументИсточник,
		|	ДД.ПоказательОтнесенияНаВыпускИсходный - ВЫРАЗИТЬ(ДД.КоличествоРегистраторов * ДД.ПоказательОтнесенияНаВыпуск КАК ЧИСЛО(23,10))
		|";
КонецФункции

// ... выборки данных

Функция ТекстПриходыПрочихРасходовНЗП() // ДолиПроизводственныхРасходов, МатериальныеЗатратыПроизводства, ТрудозатратыПроизводства
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыПрочихРасходовНЗП""                   КАК ЗапросИсточник,
		|	10                                                  КАК Приоритет,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ИСТИНА                                              КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)              КАК ВидДвижения,
		|	ДД.Период                                           КАК Период,
		|	ДД.Регистратор                                      КАК Регистратор,
		|	ДД.Организация                                      КАК Организация,
		|	ДД.Подразделение                                    КАК Подразделение,
		|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
		|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
		|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО                                        КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО                                        КАК Этап,
		|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
		|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
		|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
		|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
		|	НЕОПРЕДЕЛЕНО                                        КАК АналитикаУчетаПродукции,
		|	0                                                   КАК Знаменатель,
		|	0                                                   КАК КоличествоПродукции,
		|	0                                                   КАК ДоляСтоимости,
		|	0                                                   КАК Стоимость,
		|	0                                                   КАК СтоимостьБезНДС,
		|	0                                                   КАК СтоимостьРегл,
		|	0                                                   КАК ПостояннаяРазница,
		|	0                                                   КАК ВременнаяРазница,
		|	ДД.ПоказательОтнесенияНаВыпуск + ЕСТЬNULL(Погрешность.ПоказательОтнесенияНаВыпускПогрешность, 0) КАК ПоказательОтнесенияНаВыпуск,
		|	ДД.ПоказательОтнесенияНаПартию                      КАК ПоказательОтнесенияНаПартию,
		|	ИСТИНА                                              КАК Первичное,
		|	НЕОПРЕДЕЛЕНО                                        КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО                                        КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО                                        КАК ВидЗапасов,
		|	ДД.Регистратор                                      КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО                                        КАК Назначение,
		|	ДД.ДокументИсточник                                 КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО                                        КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО                                        КАК Продукция,
		|	НЕОПРЕДЕЛЕНО                                        КАК ХарактеристикаПродукции
		|ИЗ
		|	ПриходыПоказателя КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПогрешностьПоказателя КАК Погрешность
		|		ПО Погрешность.Организация = ДД.Организация
		|		И Погрешность.Подразделение = ДД.Подразделение
		|		И Погрешность.ПартияПроизводства = ДД.ПартияПроизводства
		|		И Погрешность.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Погрешность.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Погрешность.СтатьяКалькуляции = ДД.СтатьяКалькуляции
		|		И Погрешность.СтатьяРасходов = ДД.СтатьяРасходов
		|		И Погрешность.АналитикаРасходов = ДД.АналитикаРасходов
		|		И Погрешность.ГруппаПродукции = ДД.ГруппаПродукции
		|		И Погрешность.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
		|		И Погрешность.Регистратор = ДД.Регистратор
		|";
КонецФункции

Функция ТекстРасходыПрочихРасходовНЗППоМатериалам() // использует ПартииДляОтнесенияРасходов, МатериальныеЗатратыПроизводства
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходыПрочихРасходовНЗППоМатериалам""       КАК ЗапросИсточник,
	|	10                                                  КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
	|	ИСТИНА                                              КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)              КАК ВидДвижения,
	|	Материальные.ДатаПроизводства                       КАК Период,
	|	Материальные.РегистраторРасхода                     КАК Регистратор,
	|	ДД.Организация                                      КАК Организация,
	|	ДД.Подразделение                                    КАК Подразделение,
	|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО                                        КАК Этап,
	|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(РаботыДляДавальца.КорАналитикаУчетаНоменклатуры, Материальные.КорАналитикаУчетаНоменклатуры) КАК АналитикаУчетаПродукции,
	|	0                                                   КАК Знаменатель,
	|	0                                                   КАК КоличествоПродукции,
	|	0                                                   КАК ДоляСтоимости,
	|	0                                                   КАК Стоимость,
	|	0                                                   КАК СтоимостьБезНДС,
	|	0                                                   КАК СтоимостьРегл,
	|	0                                                   КАК ПостояннаяРазница,
	|	0                                                   КАК ВременнаяРазница,
	|	ВЫБОР
			// если остаток и текущий приход показателя превышает расход, то показатель отнесения на выпуск соответствует расходу
	|		КОГДА (ОПР.Приход + ОПР.Остаток) >= ОПР.Расход ТОГДА 
	|			Материальные.Стоимость
			// если остаток и текущий приход не покрывает расход, то показатель отнесения на выпуск рассчитывается пропорционально остаткам
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(ВЫРАЗИТЬ((ОПР.Приход + ОПР.Остаток) * Материальные.Стоимость КАК ЧИСЛО(23,10)) / ОПР.Расход КАК ЧИСЛО(23,10))
	|	КОНЕЦ                                               КАК ПоказательОтнесенияНаВыпуск,
	|	0                                                   КАК ПоказательОтнесенияНаПартию,
	|	ИСТИНА                                              КАК Первичное,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(РаботыДляДавальца.КорРазделУчета, Материальные.КорРазделУчета) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                        КАК ВидЗапасов,
	|	ДД.Регистратор                                      КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО                                        КАК Назначение,
	|	ДД.Регистратор                                      КАК ДокументИсточник,
	|	Материальные.РегистраторРасхода                     КАК ДокументВыпуска,
	|	НЕОПРЕДЕЛЕНО                                        КАК Продукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХарактеристикаПродукции
	|ИЗ
	|	ПартииДляОтнесенияРасходовСводно КАК ДД
	// расход на каждую аналитику выпуска
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериальныеЗатратыПроизводства КАК Материальные
	|		ПО Материальные.Подразделение = ДД.Подразделение
	|		И Материальные.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Материальные.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
	|		И Материальные.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
	|		И Материальные.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И НЕ Материальные.СлужебноеВидДвиженияПриход
	// всего остаток и расход по каждой партии производства
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПриходыРасходы КАК ОПР
	|		ПО ДД.Регистратор = ОПР.Регистратор
	|		И ДД.Организация = ОПР.Организация
	|		И ДД.Подразделение = ОПР.Подразделение
	|		И ДД.ПартияПроизводства = ОПР.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = ОПР.АналитикаУчетаПартийПроизводства
	|		И ДД.ЗаказНаПроизводство = ОПР.ЗаказНаПроизводство
	|		И ДД.КодСтрокиПродукция = ОПР.КодСтрокиПродукция
	|		И ДД.СтатьяКалькуляции = ОПР.СтатьяКалькуляции
	|		И ДД.СтатьяРасходов = ОПР.СтатьяРасходов
	|		И ДД.АналитикаРасходов = ОПР.АналитикаРасходов
	|		И ДД.ГруппаПродукции = ОПР.ГруппаПродукции
	|		И ДД.ПравилоОтнесенияНаВыпуск = ОПР.ПравилоОтнесенияНаВыпуск
	|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО Материальные.РегистраторРасхода = РаботыДляДавальца.Регистратор
	|		И Материальные.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
	|";
КонецФункции

Функция ТекстРасходыПрочихРасходовНЗППоТрудозатратам() // использует ПартииДляОтнесенияРасходов, ТрудозатратыПроизводства
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходыПрочихРасходовНЗППоТрудозатратам""    КАК ЗапросИсточник,
	|	10                                                  КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
	|	ИСТИНА                                              КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)              КАК ВидДвижения,
	|	Трудозатраты.ДатаПроизводства                       КАК Период,
	|	Трудозатраты.РегистраторРасхода                     КАК Регистратор,
	|	ДД.Организация                                      КАК Организация,
	|	ДД.Подразделение                                    КАК Подразделение,
	|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО                                        КАК Этап,
	|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(РаботыДляДавальца.КорАналитикаУчетаНоменклатуры, Трудозатраты.КорАналитикаУчетаНоменклатуры) КАК АналитикаУчетаПродукции,
	|	0                                                   КАК Знаменатель,
	|	0                                                   КАК КоличествоПродукции,
	|	0                                                   КАК ДоляСтоимости,
	|	0                                                   КАК Стоимость,
	|	0                                                   КАК СтоимостьБезНДС,
	|	0                                                   КАК СтоимостьРегл,
	|	0                                                   КАК ПостояннаяРазница,
	|	0                                                   КАК ВременнаяРазница,
	|	ВЫБОР
			// если остаток и текущий приход показателя превышает расход, то показатель отнесения на выпуск соответствует расходу
	|		КОГДА (ОПР.Приход + ОПР.Остаток) >= ОПР.Расход ТОГДА 
	|			Трудозатраты.Стоимость
			// если остаток и текущий приход не покрывает расход, то показатель отнесения на выпуск рассчитывается пропорционально остаткам
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(ВЫРАЗИТЬ((ОПР.Приход + ОПР.Остаток) * Трудозатраты.Стоимость КАК ЧИСЛО(23,10)) / ОПР.Расход КАК ЧИСЛО(23,10))
	|	КОНЕЦ                                               КАК ПоказательОтнесенияНаВыпуск,
	|	0                                                   КАК ПоказательОтнесенияНаПартию,
	|	ИСТИНА                                              КАК Первичное,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(РаботыДляДавальца.КорРазделУчета, Трудозатраты.КорРазделУчета) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                        КАК ВидЗапасов,
	|	ДД.Регистратор                                      КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО                                        КАК Назначение,
	|	ДД.Регистратор                                      КАК ДокументИсточник,
	|	Трудозатраты.РегистраторРасхода                     КАК ДокументВыпуска,
	|	НЕОПРЕДЕЛЕНО                                        КАК Продукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХарактеристикаПродукции
	|ИЗ
	|	ПартииДляОтнесенияРасходовСводно КАК ДД
	// расход на каждую аналитику выпуска
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТрудозатратыПроизводства КАК Трудозатраты
	|		ПО Трудозатраты.Подразделение = ДД.Подразделение
	|		И Трудозатраты.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Трудозатраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
	|		И Трудозатраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
	|		И Трудозатраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И НЕ Трудозатраты.СлужебноеВидДвиженияПриход
	// всего остаток и расход по каждой партии производства
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПриходыРасходы КАК ОПР
	|		ПО ДД.Регистратор = ОПР.Регистратор
	|		И ДД.Организация = ОПР.Организация
	|		И ДД.Подразделение = ОПР.Подразделение
	|		И ДД.ПартияПроизводства = ОПР.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = ОПР.АналитикаУчетаПартийПроизводства
	|		И ДД.ЗаказНаПроизводство = ОПР.ЗаказНаПроизводство
	|		И ДД.КодСтрокиПродукция = ОПР.КодСтрокиПродукция
	|		И ДД.СтатьяКалькуляции = ОПР.СтатьяКалькуляции
	|		И ДД.СтатьяРасходов = ОПР.СтатьяРасходов
	|		И ДД.АналитикаРасходов = ОПР.АналитикаРасходов
	|		И ДД.ГруппаПродукции = ОПР.ГруппаПродукции
	|		И ДД.ПравилоОтнесенияНаВыпуск = ОПР.ПравилоОтнесенияНаВыпуск
	|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО Трудозатраты.РегистраторРасхода = РаботыДляДавальца.Регистратор
	|		И Трудозатраты.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
	|";
КонецФункции

Функция ТекстРасходыПрочихРасходовНЗППоМатериальнымИТрудозатратам() // использует ПартииДляОтнесенияРасходов, МатериальныеИТрудозатратыПроизводства
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходыПрочихРасходовНЗППоМатериальнымИТрудозатратам"" КАК ЗапросИсточник,
	|	10                                                  КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
	|	ИСТИНА                                              КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)              КАК ВидДвижения,
	|	Затраты.ДатаПроизводства                            КАК Период,
	|	Затраты.РегистраторРасхода                          КАК Регистратор,
	|	ДД.Организация                                      КАК Организация,
	|	ДД.Подразделение                                    КАК Подразделение,
	|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО                                        КАК Этап,
	|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(РаботыДляДавальца.КорАналитикаУчетаНоменклатуры, Затраты.КорАналитикаУчетаНоменклатуры) КАК АналитикаУчетаПродукции,
	|	0                                                   КАК Знаменатель,
	|	0                                                   КАК КоличествоПродукции,
	|	0                                                   КАК ДоляСтоимости,
	|	0                                                   КАК Стоимость,
	|	0                                                   КАК СтоимостьБезНДС,
	|	0                                                   КАК СтоимостьРегл,
	|	0                                                   КАК ПостояннаяРазница,
	|	0                                                   КАК ВременнаяРазница,
	|	ВЫБОР
			// если остаток и текущий приход показателя превышает расход, то показатель отнесения на выпуск соответствует расходу
	|		КОГДА (ОПР.Приход + ОПР.Остаток) >= ОПР.Расход ТОГДА 
	|			Затраты.Стоимость
			// если остаток и текущий приход не покрывает расход, то показатель отнесения на выпуск рассчитывается пропорционально остаткам
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(ВЫРАЗИТЬ((ОПР.Приход + ОПР.Остаток) * Затраты.Стоимость КАК ЧИСЛО(23,10)) / ОПР.Расход КАК ЧИСЛО(23,10))
	|	КОНЕЦ                                               КАК ПоказательОтнесенияНаВыпуск,
	|	0                                                   КАК ПоказательОтнесенияНаПартию,
	|	ИСТИНА                                              КАК Первичное,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(РаботыДляДавальца.КорРазделУчета, Затраты.КорРазделУчета) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                        КАК ВидЗапасов,
	|	ДД.Регистратор                                      КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО                                        КАК Назначение,
	|	ДД.Регистратор                                      КАК ДокументИсточник,
	|	Затраты.РегистраторРасхода                          КАК ДокументВыпуска,
	|	НЕОПРЕДЕЛЕНО                                        КАК Продукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХарактеристикаПродукции
	|ИЗ
	|	ПартииДляОтнесенияРасходовСводно КАК ДД
	// расход на каждую аналитику выпуска
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериальныеИТрудозатратыПроизводства КАК Затраты
	|		ПО Затраты.Подразделение = ДД.Подразделение
	|		И Затраты.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Затраты.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
	|		И Затраты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
	|		И Затраты.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И НЕ Затраты.СлужебноеВидДвиженияПриход
	// всего остаток и расход по каждой партии производства
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПриходыРасходы КАК ОПР
	|		ПО ДД.Регистратор = ОПР.Регистратор
	|		И ДД.Организация = ОПР.Организация
	|		И ДД.Подразделение = ОПР.Подразделение
	|		И ДД.ПартияПроизводства = ОПР.ПартияПроизводства
	|		И ДД.АналитикаУчетаПартийПроизводства = ОПР.АналитикаУчетаПартийПроизводства
	|		И ДД.ЗаказНаПроизводство = ОПР.ЗаказНаПроизводство
	|		И ДД.КодСтрокиПродукция = ОПР.КодСтрокиПродукция
	|		И ДД.СтатьяКалькуляции = ОПР.СтатьяКалькуляции
	|		И ДД.СтатьяРасходов = ОПР.СтатьяРасходов
	|		И ДД.АналитикаРасходов = ОПР.АналитикаРасходов
	|		И ДД.ГруппаПродукции = ОПР.ГруппаПродукции
	|		И ДД.ПравилоОтнесенияНаВыпуск = ОПР.ПравилоОтнесенияНаВыпуск
	|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО Затраты.РегистраторРасхода = РаботыДляДавальца.Регистратор
	|		И Затраты.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
	|";
КонецФункции

Функция ТекстРасходыПрочихРасходовНЗППоПродукции() // использует ПартииДляОтнесенияРасходов, ВыпущеннаяПродукция
	Возврат "
	|ВЫБРАТЬ
	|	""ТекстРасходыПрочихРасходовНЗППоПродукции""        КАК ЗапросИсточник,
	|	10                                                  КАК Приоритет,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
	|	ИСТИНА                                              КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)              КАК ВидДвижения,
	|	Продукция.ДатаПроизводства                          КАК Период,
	|	Продукция.РегистраторРасхода                        КАК Регистратор,
	|	ДД.Организация                                      КАК Организация,
	|	ДД.Подразделение                                    КАК Подразделение,
	|	ДД.ПартияПроизводства                               КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства                 КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство                              КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                               КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО                                        КАК Этап,
	|	ДД.СтатьяКалькуляции                                КАК СтатьяКалькуляции,
	|	ДД.СтатьяРасходов                                   КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                КАК АналитикаРасходов,
	|	ДД.ГруппаПродукции                                  КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                         КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(РаботыДляДавальца.КорАналитикаУчетаНоменклатуры, Продукция.КорАналитикаУчетаНоменклатуры) КАК АналитикаУчетаПродукции,
	|	0                                                   КАК Знаменатель,
	|	0                                                   КАК КоличествоПродукции,
	|	0                                                   КАК ДоляСтоимости,
	|	0                                                   КАК Стоимость,
	|	0                                                   КАК СтоимостьБезНДС,
	|	0                                                   КАК СтоимостьРегл,
	|	0                                                   КАК ПостояннаяРазница,
	|	0                                                   КАК ВременнаяРазница,
	|	Продукция.Стоимость                                 КАК ПоказательОтнесенияНаВыпуск,
	|	0                                                   КАК ПоказательОтнесенияНаПартию,
	|	ИСТИНА                                              КАК Первичное,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(РаботыДляДавальца.КорРазделУчета, Продукция.КорРазделУчета) КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО                                        КАК ВидЗапасов,
	|	ДД.Регистратор                                      КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО                                        КАК Назначение,
	|	ДД.Регистратор                                      КАК ДокументИсточник,
	|	Продукция.РегистраторРасхода                        КАК ДокументВыпуска,
	|	НЕОПРЕДЕЛЕНО                                        КАК Продукция,
	|	НЕОПРЕДЕЛЕНО                                        КАК ХарактеристикаПродукции
	|ИЗ
	|	ПартииДляОтнесенияРасходовСводно КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпущеннаяПродукция КАК Продукция
	|		ПО Продукция.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Продукция.АналитикаУчетаПартийПроизводства = ДД.АналитикаУчетаПартийПроизводства
	|		И Продукция.Подразделение = ДД.Подразделение
	|		И Продукция.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
	|		И Продукция.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И (Продукция.Регистратор = ДД.Регистратор ИЛИ Продукция.Регистратор = НЕОПРЕДЕЛЕНО)
	|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО Продукция.РегистраторРасхода = РаботыДляДавальца.Регистратор
	|		И Продукция.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукции)
	|";
КонецФункции

#КонецОбласти

//-- НЕ УТ

#Область ПроцедурыЭтапов_Общие

//++ НЕ УТ
#Область ПроцедурыЭтапов_1_2_3_4_5

//++ НЕ УТКА

// вт Этапы, ПартииПроизводства, ПартииПроизводстваСводно, ПродолжающиесяПартии, втПродукция, втДолиИтог, Продукция, ДолиВыпуска
Функция ТекстРаспределениеПроизводственныхЗатратИнициализация()
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.Этап								КАК Этап,
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.Спецификация						КАК Спецификация,
	|	ДД.Назначение						КАК Назначение,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Статус							КАК Статус
	|ПОМЕСТИТЬ Этапы
	|ИЗ
	|	(ВЫБРАТЬ
	|		ДокументЭтап.ВыпускающийЭтап КАК ПартияПроизводства,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				И НЕ ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК АналитикаФинансовогоУчета,
	|		ДокументЭтап.Ссылка КАК Этап,
	|		ДокументЭтап.Организация КАК Организация,
	|		ДокументЭтап.Подразделение КАК Подразделение,
	|		ДокументЭтап.Спецификация КАК Спецификация,
	|		ДокументЭтап.Назначение КАК Назначение,
	|		ДокументЭтап.ВыпускПодДеятельность КАК ВидДеятельностиНДС,
	|		ДокументЭтап.Статус КАК Статус
	|	ИЗ
	|		Документ.ЭтапПроизводства2_2.РасходМатериаловИРабот КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтап
	|			ПО ДД.Ссылка = ДокументЭтап.Ссылка
	|	ГДЕ
	|		ДД.ДатаРасхода МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДокументЭтап.Организация В(&МассивОрганизаций)
	|		И ДокументЭтап.Проведен
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДокументЭтап.ВыпускающийЭтап,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка),
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				И НЕ ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК АналитикаФинансовогоУчета,
	|		ДокументЭтап.Ссылка,
	|		ДокументЭтап.Организация,
	|		ДокументЭтап.Подразделение,
	|		ДокументЭтап.Спецификация,
	|		ДокументЭтап.Назначение,
	|		ДокументЭтап.ВыпускПодДеятельность КАК ВидДеятельностиНДС,
	|		ДокументЭтап.Статус
	|	ИЗ
	|		Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтап
	|			ПО ДД.Ссылка = ДокументЭтап.Ссылка
	|	ГДЕ
	|		ДД.ДатаПроизводства МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДокументЭтап.Организация В(&МассивОрганизаций)
	|		И ДокументЭтап.Проведен
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДокументЭтап.ВыпускающийЭтап,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка),
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				И НЕ ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК АналитикаФинансовогоУчета,
	|		ДокументЭтап.Ссылка,
	|		ДокументЭтап.Организация,
	|		ДокументЭтап.Подразделение,
	|		ДокументЭтап.Спецификация,
	|		ДокументЭтап.Назначение,
	|		ДокументЭтап.ВыпускПодДеятельность КАК ВидДеятельностиНДС,
	|		ДокументЭтап.Статус
	|	ИЗ
	|		Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтап
	|			ПО ДД.Ссылка = ДокументЭтап.Ссылка
	|	ГДЕ
	|		ДД.ДатаПроизводства МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДокументЭтап.Организация В(&МассивОрганизаций)
	|		И ДокументЭтап.Проведен
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДокументЭтап.ВыпускающийЭтап,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка),
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				И НЕ ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА ДокументЭтап.ВыпускающийЭтап.ОсновноеИзделиеНоменклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК АналитикаФинансовогоУчета,
	|		ДокументЭтап.Ссылка,
	|		ДокументЭтап.Организация,
	|		ДокументЭтап.Подразделение,
	|		ДокументЭтап.Спецификация,
	|		ДокументЭтап.Назначение,
	|		ДокументЭтап.ВыпускПодДеятельность КАК ВидДеятельностиНДС,
	|		ДокументЭтап.Статус
	|	ИЗ
	|		Документ.ЭтапПроизводства2_2.Трудозатраты КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтап
	|			ПО ДД.Ссылка = ДокументЭтап.Ссылка
	|	ГДЕ
	|		ДД.ДатаВыполнения МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДокументЭтап.Организация В(&МассивОрганизаций)
	|		И ДокументЭтап.Проведен
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Ссылка								КАК ПартияПроизводства,
	|		ДД.АналитикаУчетаПартийПроизводства		КАК АналитикаУчетаПартийПроизводства,
	|		ВЫБОР
	|			КОГДА &АналитическийУчетПоГруппамПродукции
	|				И НЕ ДД.Номенклатура.ГруппаАналитическогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|				ТОГДА ДД.Номенклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ									КАК АналитикаФинансовогоУчета,
	|		ДД.Ссылка								КАК Этап,
	|		ДокументВыпуск.Организация				КАК Организация,
	|		ДокументВыпуск.Подразделение			КАК Подразделение,
	|		ДД.АналитикаУчетаПартийПроизводства.Спецификация КАК Спецификация,
	|		ДД.Назначение							КАК Назначение,
	|		ДокументВыпуск.ВыпускПодДеятельность	КАК ВидДеятельностиНДС,
	|		НЕОПРЕДЕЛЕНО							КАК Статус
	|	ИЗ
	|		Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ДД
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ДокументВыпуск
	|			ПО ДД.Ссылка = ДокументВыпуск.Ссылка
	|	ГДЕ
	|		ДокументВыпуск.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДокументВыпуск.Организация В(&МассивОрганизаций)
	|		И ДД.ОсновноеИзделиеГруппыЗатрат
	|		И ДокументВыпуск.Проведен) КАК ДД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.ПартияПроизводства.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.ПартияПроизводства.ОсновноеИзделиеНоменклатура КАК ОсновноеИзделиеНоменклатура,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.Этап								КАК Этап,
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.Спецификация						КАК Спецификация,
	|	ДД.Назначение						КАК Назначение,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Статус							КАК Статус
	|ПОМЕСТИТЬ ПартииПроизводства
	|ИЗ
	|	Этапы КАК ДД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаУчетаПартийПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.ПартияПроизводства                 КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства   КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета          КАК АналитикаФинансовогоУчета,
	|	ДД.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности
	|ПОМЕСТИТЬ АналитикиПартийПроизводства
	|ИЗ
	|	ПартииПроизводства КАК ДД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаУчетаПартийПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства
	|ПОМЕСТИТЬ ПартииПроизводстваСводно
	|ИЗ
	|	ПартииПроизводства КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.Этап								КАК Этап,
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.Спецификация						КАК Спецификация,
	|	ДД.Назначение						КАК Назначение,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Статус							КАК Статус
	|ПОМЕСТИТЬ ПродолжающиесяПартии
	|ИЗ
	|	ПартииПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК Выход
	|		ПО ДД.Этап = Выход.Ссылка
	|ГДЕ
	|	Выход.Произведено
	|	И Выход.ДатаПроизводства > &КонецПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаУчетаПартийПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА Товары.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА Товары.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	КОНЕЦ								КАК РазделУчета,
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.Назначение						КАК Назначение,
	|	ДД.НаправлениеДеятельности			КАК НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета		КАК АналитикаФинансовогоУчета,
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.ВидДеятельностиНДС				КАК ВидДеятельностиНДС,
	|	ДД.Статус							КАК Статус,
	|	ДД.Спецификация						КАК Спецификация,
	|	Товары.Номенклатура					КАК Номенклатура,
	|	Товары.Характеристика				КАК Характеристика,
	|	Товары.Серия						КАК Серия,
	|	Товары.ИдентификаторСтроки			КАК ИдентификаторСтроки,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.Произведено
	|					И Товары.ДатаПроизводства <= &КонецПериода
	|				ТОГДА Товары.Количество
	|			ИНАЧЕ 0
	|		КОНЕЦ)							КАК Факт,
	|	СУММА(Товары.Количество)			КАК План,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.Произведено
	|					И (Товары.ДатаПроизводства МЕЖДУ &НачалоПериода И &КонецПериода)
	|				ТОГДА Товары.Количество
	|			ИНАЧЕ 0
	|		КОНЕЦ)							КАК КоличествоПродукции,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.Произведено
	|					И Товары.ДатаПроизводства <= &КонецПериода
	|				ТОГДА ВЫБОР
	|						КОГДА Товары.ДоляСтоимости = 0
	|							ТОГДА Товары.Количество
	|						ИНАЧЕ Товары.ДоляСтоимости
	|					КОНЕЦ
	|			ИНАЧЕ 0
	|		КОНЕЦ)							КАК ДоляСтоимостиФакт,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.ДоляСтоимости = 0
	|				ТОГДА Товары.Количество
	|			ИНАЧЕ Товары.ДоляСтоимости
	|		КОНЕЦ)							КАК ДоляСтоимости,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА Товары.ВидЗапасов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ								КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА Товары.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ
	|			АналитикаБезНазначения.КлючАналитики
	|	КОНЕЦ                               КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА Товары.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
	|			ТОГДА Товары.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ								КАК СтатьяРасходовСписания,
	|	ВЫБОР
	|		КОГДА Товары.СтатьяРасходов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|			ТОГДА Товары.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ								КАК СтатьяАктивовПассивов,
	|	Товары.АналитикаРасходов			КАК АналитикаРасходов,
	|	Товары.АналитикаАктивовПассивов		КАК АналитикаАктивовПассивов
	|ПОМЕСТИТЬ втПродукция
	|ИЗ
	|	ПартииПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК Товары
	|			ПО ДД.Этап = Товары.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ДокументЭтапа
	|			ПО ДокументЭтапа.Ссылка = Товары.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО Товары.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|			ПО Аналитика.Номенклатура = АналитикаБезНазначения.Номенклатура
	|			И Аналитика.Характеристика = АналитикаБезНазначения.Характеристика
	|			И Аналитика.Серия = АналитикаБезНазначения.Серия
	|			И Аналитика.Склад = АналитикаБезНазначения.Склад
	|			И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаБезНазначения.Назначение
	|			И Аналитика.СтатьяКалькуляции = АналитикаБезНазначения.СтатьяКалькуляции
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.ПартияПроизводства,
	|	ДД.Назначение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Статус,
	|	ДД.Спецификация,
	|	Товары.Номенклатура,
	|	Товары.Характеристика,
	|	Товары.Серия,
	|	Товары.ИдентификаторСтроки,
	|	Товары.ВидЗапасов,
	|	Товары.СтатьяРасходов,
	|	Товары.АналитикаРасходов,
	|	Товары.АналитикаАктивовПассивов,
	|	Товары.АналитикаУчетаНоменклатуры,
	|	АналитикаБезНазначения.КлючАналитики
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Товары.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
	|		ИНАЧЕ Товары.НаправлениеВыпуска
	|	КОНЕЦ							КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА Товары.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА Товары.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца) ТОГДА
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		ИНАЧЕ
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	КОНЕЦ								КАК РазделУчета,
	|	ДД.ПартияПроизводства			КАК ПартияПроизводства,
	|	ЕСТЬNULL(ДД.АналитикаУчетаПартийПроизводства.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
	|	ЕСТЬNULL(ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета	КАК АналитикаФинансовогоУчета,
	|	ДД.Организация					КАК Организация,
	|	ДД.Подразделение				КАК Подразделение,
	|	ДД.ВидДеятельностиНДС			КАК ВидДеятельностиНДС,
	|	ДД.Статус						КАК Статус,
	|	ДД.Спецификация					КАК Спецификация,
	|	Товары.Номенклатура				КАК Номенклатура,
	|	Товары.Характеристика			КАК Характеристика,
	|	Товары.Серия					КАК Серия,
	|	Товары.ИдентификаторСтроки		КАК ИдентификаторСтроки,
	|	СУММА(Товары.Количество)		КАК Факт,
	|	СУММА(Товары.Количество)		КАК План,
	|	СУММА(Товары.Количество)		КАК КоличествоПродукции,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.ДоляСтоимости = 0
	|				ТОГДА Товары.Количество
	|			ИНАЧЕ Товары.ДоляСтоимости
	|		КОНЕЦ)						КАК ДоляСтоимостиФакт,
	|	СУММА(ВЫБОР
	|			КОГДА Товары.ДоляСтоимости = 0
	|				ТОГДА Товары.Количество
	|			ИНАЧЕ Товары.ДоляСтоимости
	|		КОНЕЦ)						КАК ДоляСтоимости,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА Товары.ВидЗапасов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ							КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоВидамЗапасов
	|			ТОГДА ЕСТЬNULL(АналитикаПоПолучателю.КлючАналитики, АналитикаПриСписанииНаРасходы.КлючАналитики)
	|		ИНАЧЕ
	|			ЕСТЬNULL(АналитикаПоПолучателюБезНазначения.КлючАналитики, АналитикаПриСписанииНаРасходыБезНазначения.КлючАналитики)
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА Товары.Получатель ССЫЛКА ПланВидовХарактеристик.СтатьиРасходов
	|			ТОГДА Товары.Получатель
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ							КАК СтатьяРасходовСписания,
	|	ВЫБОР
	|		КОГДА Товары.Получатель ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|			ТОГДА Товары.Получатель
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ							КАК СтатьяАктивовПассивов,
	|	Товары.АналитикаРасходов		КАК АналитикаРасходов,
	|	Товары.АналитикаАктивовПассивов	КАК АналитикаАктивовПассивов
	|ИЗ
	|	ПартииПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК Товары
	|		ПО (Товары.Ссылка = ДД.ПартияПроизводства)
	|			И ДД.АналитикаУчетаПартийПроизводства = Товары.АналитикаУчетаПартийПроизводства
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ДокументЭтапа
	|			ПО ДокументЭтапа.Ссылка = Товары.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПоПолучателю
	|			ПО АналитикаПоПолучателю.Номенклатура = Товары.Номенклатура
	|			И АналитикаПоПолучателю.Характеристика = Товары.Характеристика
	|			И АналитикаПоПолучателю.Серия = Товары.Серия
	|			И АналитикаПоПолучателю.Склад = Товары.Получатель
	|			И АналитикаПоПолучателю.Назначение = Товары.Назначение
	|			И АналитикаПоПолучателю.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И НЕ Товары.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПоПолучателюБезНазначения
	|			ПО АналитикаПоПолучателюБезНазначения.Номенклатура = Товары.Номенклатура
	|			И АналитикаПоПолучателюБезНазначения.Характеристика = Товары.Характеристика
	|			И АналитикаПоПолучателюБезНазначения.Серия = Товары.Серия
	|			И АналитикаПоПолучателюБезНазначения.Склад = Товары.Получатель
	|			И АналитикаПоПолучателюБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|			И АналитикаПоПолучателюБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И НЕ Товары.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПриСписанииНаРасходы
	|			ПО АналитикаПриСписанииНаРасходы.Номенклатура = Товары.Номенклатура
	|			И АналитикаПриСписанииНаРасходы.Характеристика = Товары.Характеристика
	|			И АналитикаПриСписанииНаРасходы.Серия = Товары.Серия
	|			И АналитикаПриСписанииНаРасходы.Склад = ДокументЭтапа.Подразделение
	|			И АналитикаПриСписанииНаРасходы.Назначение = Товары.Назначение
	|			И АналитикаПриСписанииНаРасходы.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И Товары.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПриСписанииНаРасходыБезНазначения
	|			ПО АналитикаПриСписанииНаРасходыБезНазначения.Номенклатура = Товары.Номенклатура
	|			И АналитикаПриСписанииНаРасходыБезНазначения.Характеристика = Товары.Характеристика
	|			И АналитикаПриСписанииНаРасходыБезНазначения.Серия = Товары.Серия
	|			И АналитикаПриСписанииНаРасходыБезНазначения.Склад = ДокументЭтапа.Подразделение
	|			И АналитикаПриСписанииНаРасходыБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|			И АналитикаПриСписанииНаРасходыБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И Товары.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.НаправлениеВыпуска,
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства.Назначение,
	|	ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Статус,
	|	ДД.Спецификация,
	|	Товары.Номенклатура,
	|	Товары.Характеристика,
	|	Товары.Серия,
	|	Товары.ИдентификаторСтроки,
	|	Товары.ВидЗапасов,
	|	АналитикаПоПолучателю.КлючАналитики,
	|	АналитикаПриСписанииНаРасходы.КлючАналитики,
	|	АналитикаПоПолучателюБезНазначения.КлючАналитики,
	|	АналитикаПриСписанииНаРасходыБезНазначения.КлючАналитики,
	|	Товары.Получатель,
	|	Товары.АналитикаРасходов,
	|	Товары.АналитикаАктивовПассивов
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	СУММА(ДД.ДоляСтоимости)				КАК СуммаДолейПоЭтапу,
	|	ВЫБОР
	|		КОГДА СУММА(ДД.ДоляСтоимостиФакт) = СУММА(ДД.ДоляСтоимости)
	|				ИЛИ ДД.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен)
	|					И Продолжающиеся.ПартияПроизводства ЕСТЬ NULL 
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ								КАК ПроизводствоЗавершено
	|ПОМЕСТИТЬ втДолиИтог
	|ИЗ
	|	втПродукция КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПродолжающиесяПартии КАК Продолжающиеся
	|		ПО ДД.ПартияПроизводства = Продолжающиеся.ПартияПроизводства
	|			И ДД.АналитикаУчетаПартийПроизводства = Продолжающиеся.АналитикаУчетаПартийПроизводства
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.Статус,
	|	Продолжающиеся.ПартияПроизводства
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаУчетаПартийПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ХозяйственнаяОперация															КАК ХозяйственнаяОперация,
	|	ДД.РазделУчета																		КАК РазделУчета,
	|	ДД.ПартияПроизводства																КАК ПартияПроизводства,
	|	ДД.Назначение																		КАК Назначение,
	|	ДД.НаправлениеДеятельности															КАК НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства													КАК АналитикаУчетаПартийПроизводства,
	|	ДД.АналитикаФинансовогоУчета														КАК АналитикаФинансовогоУчета,
	|	ДД.Организация																		КАК Организация,
	|	ДД.ВидДеятельностиНДС																КАК ВидДеятельностиНДС,
	|	ДД.Спецификация																		КАК Спецификация,
	|	ДД.Подразделение																	КАК Подразделение,
	|	ДД.Номенклатура																		КАК Номенклатура,
	|	ДД.Характеристика																	КАК Характеристика,
	|	ДД.Серия																			КАК Серия,
	|	ДД.Факт																				КАК Факт,
	|	ДД.План																				КАК План,
	|	ДД.ДоляСтоимости																	КАК ДоляСтоимости,
	|	ВЫРАЗИТЬ(ДД.ДоляСтоимости / ДолиИтог.СуммаДолейПоЭтапу * (ДД.Факт / ДД.План) КАК ЧИСЛО(15,3))					КАК ДоляНаименованияВсего,
	|	ВЫРАЗИТЬ(ДД.ДоляСтоимости / ДолиИтог.СуммаДолейПоЭтапу * (ДД.КоличествоПродукции / ДД.План) КАК ЧИСЛО(15,3))	КАК ДоляНаименованияМесяца,
	|	ДолиИтог.ПроизводствоЗавершено														КАК ПроизводствоЗавершено,
	|	ДД.ВидЗапасов																		КАК ВидЗапасов,
	|	ДД.АналитикаУчетаНоменклатуры														КАК АналитикаУчетаНоменклатуры,
	|	ДД.КоличествоПродукции																КАК КоличествоПродукции,
	|	ДД.СтатьяРасходовСписания															КАК СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов																КАК АналитикаРасходов,
	|	ДД.СтатьяАктивовПассивов															КАК СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов															КАК АналитикаАктивовПассивов,
	|	ДД.ИдентификаторСтроки																КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ Продукция
	|ИЗ
	|	втПродукция КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втДолиИтог КАК ДолиИтог
	|		ПО ДД.ПартияПроизводства = ДолиИтог.ПартияПроизводства
	|			И ДД.АналитикаУчетаПартийПроизводства = ДолиИтог.АналитикаУчетаПартийПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ПроизводствоЗавершено			КАК ПроизводствоЗавершено,
	|	СУММА(ДД.ДоляНаименованияВсего)		КАК ДоляВыпускаВсего,
	|	СУММА(ДД.ДоляНаименованияМесяца)	КАК ДоляВыпускаМесяца
	|ПОМЕСТИТЬ ДолиВыпуска
	|ИЗ
	|	Продукция КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.ПроизводствоЗавершено
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаУчетаПартийПроизводства;
	|";
	
	Возврат ТекстЗапроса
	
КонецФункции

//-- НЕ УТКА

// Таблицы: ДанныеПоПродукции
Функция ТекстДанныеПоВыпущеннойПродукции()
	
	Возврат "
	// поступления от переработчиков
	|ВЫБРАТЬ
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.Подразделение КАК Подразделение,
	|	ДД.Номенклатура КАК Продукция,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			ТОГДА СН.ГруппаАналитическогоУчета
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК ГруппаПродукции,
	|	КлючиАналитики.Назначение КАК Назначение,
	|	Реквизиты.Ссылка КАК ПартияПроизводства,
	|	ЕСТЬNULL(Строки.Назначение.НаправлениеДеятельности, Реквизиты.НаправлениеДеятельности) КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	ДД.Количество КАК Количество,
	|	&Объем * ДД.Количество КАК Объем,
	|	&Вес * ДД.Количество КАК Вес,
	|	ЕСТЬNULL(Цены.Цена, 0) * ДД.Количество КАК Стоимость
	|ПОМЕСТИТЬ ДанныеПоПродукции
	|
	|ИЗ
	|	Документ.ОтчетПереработчика.Продукция КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК Реквизиты
	|		ПО ДД.Ссылка = Реквизиты.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО СН.Ссылка = ДД.Номенклатура
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитики
	|		ПО КлючиАналитики.Ссылка = ДД.АналитикаУчетаНоменклатуры
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК Строки
	|		ПО ДД.ЗаказПереработчику = Строки.Ссылка
	|		И ДД.КодСтроки = Строки.КодСтроки
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|		ПО Цены.Номенклатура = ДД.Номенклатура
	|		И Цены.Характеристика = ДД.Характеристика
	|ГДЕ
	|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Реквизиты.Организация В (&МассивОрганизаций)
	|	И Реквизиты.Проведен
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	//++ НЕ УТКА
	// производство по этапам и без заказа 2.2
	|ВЫБРАТЬ
	|	ДД.Организация                                    КАК Организация,
	|	ДД.Подразделение                                  КАК Подразделение,
	|	ДД.Номенклатура                                   КАК Продукция,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЕСТЬNULL(ИзделияЭтапов.ГруппаАналитическогоУчета, ИзделияПроизводстваБезЗаказов.ГруппаАналитическогоУчета)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ                                             КАК ГруппаПродукции,
	|	ДД.ПартияПроизводства.Назначение                  КАК Назначение,
	|	ДД.ПартияПроизводства                             КАК ПартияПроизводства,
	|	ДД.НаправлениеДеятельности                        КАК НаправлениеДеятельности,
	|	ДД.АналитикаУчетаПартийПроизводства               КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО                                      КАК ЗаказНаПроизводство,
	|	0                                                 КАК КодСтрокиПродукция,
	|	ДД.КоличествоПродукции                            КАК Количество,
	|	&Объем * ДД.КоличествоПродукции                   КАК Объем,
	|	&Вес * ДД.КоличествоПродукции                     КАК Вес,
	|	ЕСТЬNULL(Цены.Цена, 0) * ДД.КоличествоПродукции   КАК Стоимость
	|ИЗ
	|	Продукция КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО СН.Ссылка = ДД.Номенклатура
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|		ПО Цены.Номенклатура = ДД.Номенклатура
	|		И Цены.Характеристика = ДД.Характеристика
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ЭтапыПроизводства
	|		ПО ДД.ПартияПроизводства = ЭтапыПроизводства.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ВыходныеИзделияПроизводстваБезЗаказов
	|		ПО ВыходныеИзделияПроизводстваБезЗаказов.ОсновноеИзделиеГруппыЗатрат
	|		И ДД.ПартияПроизводства = ВыходныеИзделияПроизводстваБезЗаказов.Ссылка
	|		И ДД.АналитикаУчетаПартийПроизводства = ВыходныеИзделияПроизводстваБезЗаказов.АналитикаУчетаПартийПроизводства
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ИзделияЭтапов
	|		ПО ИзделияЭтапов.Ссылка = ЭтапыПроизводства.ОсновноеИзделиеНоменклатура
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ИзделияПроизводстваБезЗаказов
	|		ПО ИзделияПроизводстваБезЗаказов.Ссылка = ВыходныеИзделияПроизводстваБезЗаказов.Номенклатура
	|	
	|ГДЕ
	|	ДД.ДоляНаименованияМесяца > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// производство по заказам 2.1
	|ВЫБРАТЬ
	|	Реквизиты.Организация                            КАК Организация,
	|	Реквизиты.Подразделение                          КАК Подразделение,
	|	ДД.Номенклатура                                  КАК Продукция,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ                                            КАК ГруппаПродукции,
	|	Продукция.Назначение                             КАК Назначение,
	|	НЕОПРЕДЕЛЕНО                                     КАК ПартияПроизводства,
	|	ЕСТЬNULL(Продукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	МаршрутныйЛист.Распоряжение                      КАК ЗаказНаПроизводство,
	|	МаршрутныйЛист.КодСтроки                         КАК КодСтрокиПродукция,
	|	ДД.Количество                                    КАК Количество,
	|	ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество КАК Объем,
	|	ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество   КАК Вес,
	|	ЕСТЬNULL(Цены.Цена, 0) * ДД.Количество           КАК Стоимость
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Реквизиты
	|			ПО (Реквизиты.Ссылка = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|			ПО (СН.Ссылка = ДД.Номенклатура)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|			ПО Цены.Номенклатура = ДД.Номенклатура
	|			И Цены.Характеристика = ДД.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
	|			ПО ДД.Распоряжение = МаршрутныйЛист.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Продукция
	|			ПО МаршрутныйЛист.Распоряжение = Продукция.Ссылка
	|			И МаршрутныйЛист.КодСтроки = Продукция.КодСтроки
	|
	|ГДЕ
	|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Реквизиты.Организация В (&МассивОрганизаций)
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|	И Реквизиты.Проведен
	|	И Реквизиты.ВыпускПоРаспоряжениям
	|	И &ВключатьДанныеПроизводства21
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	//-- НЕ УТКА
	// производство без заказов
	|ВЫБРАТЬ
	|	Реквизиты.Организация                            КАК Организация,
	|	Реквизиты.Подразделение                          КАК Подразделение,
	|	ДД.Номенклатура                                  КАК Продукция,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			ТОГДА СН.ГруппаАналитическогоУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ                                            КАК ГруппаПродукции,
	|	ДД.Назначение                                    КАК Назначение,
	|	НЕОПРЕДЕЛЕНО                                     КАК ПартияПроизводства,
	|	ЕСТЬNULL(ДД.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.Ссылка                                        КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки                                     КАК КодСтрокиПродукция,
	|	ДД.Количество                                    КАК Количество,
	|	ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество КАК Объем,
	|	ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество   КАК Вес,
	|	ЕСТЬNULL(Цены.Цена, 0) * ДД.Количество           КАК Стоимость
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Реквизиты
	|			ПО (Реквизиты.Ссылка = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|			ПО (СН.Ссылка = ДД.Номенклатура)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|			ПО Цены.Номенклатура = ДД.Номенклатура
	|			И Цены.Характеристика = ДД.Характеристика
	|
	|ГДЕ
	|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Реквизиты.Организация В (&МассивОрганизаций)
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|	И Реквизиты.Проведен
	|	И НЕ Реквизиты.ВыпускПоРаспоряжениям
	|	И &ВключатьДанныеПроизводства21
	|;
	|";
	
КонецФункции

// Таблицы: ДанныеПоТрудозатратам
Функция ТекстДанныеПоТрудозатратам(Запрос = Неопределено)
	
	// Данные по трудозатратам выбираются в одну таблицу т.к. источники данных для плана и факта одинаковые.
	// Исключением являются выпуски без заказа 2.1, для них данные выбираются из документов производства без заказов.
	//
	Текст = "
	// собственное производство 2.1 без заказов, фактические трудозатраты
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.ВидРабот							КАК ВидРабот,
	|	ДД.ГруппаПродукции					КАК ГруппаПродукции,
	|	Товары.Назначение					КАК Назначение,
	|	НЕОПРЕДЕЛЕНО						КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ДокументВыпуска					КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки						КАК КодСтрокиПродукция,
	|	Товары.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СУММА(ДД.Количество)				КАК Количество,
	|	СУММА(ДД.НормативнаяСтоимость)		КАК НормативнаяСтоимость,
	|	СУММА(ДД.Стоимость)					КАК Стоимость
	|ПОМЕСТИТЬ ДанныеПоТрудозатратам
	|ИЗ
	|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Товары
	|			ПО ДД.ДокументВыпуска = Товары.Ссылка
	|			И ДД.КодСтроки = Товары.КодСтроки
	|
	|ГДЕ
	|	(&РасчетСебестоимостиВыполнен ИЛИ НЕ &РасшифровкаРаспределения)
	|	И &ВключатьДанныеПроизводства21
	|	И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И НЕ ДД.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.ВидРабот,
	|	Товары.Назначение,
	|	ДД.Организация,
	|	ДД.ДокументВыпуска,
	|	ДД.КодСтроки,
	|	Товары.Назначение.НаправлениеДеятельности,
	|	ДД.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// собственное производство 2.1 без заказов, плановые трудозатраты для отчета
	|ВЫБРАТЬ
	|	Трудозатраты.Ссылка.Организация		КАК Организация,
	|	Трудозатраты.Подразделение			КАК Подразделение,
	|	Трудозатраты.ВидРабот				КАК ВидРабот,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И Продукция.Номенклатура.ГруппаАналитическогоУчета <> ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА Продукция.Номенклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ								КАК ГруппаПродукции,
	|	Продукция.Назначение				КАК Назначение,
	|	НЕОПРЕДЕЛЕНО						КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.Распоряжение						КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки						КАК КодСтрокиПродукция,
	|	Продукция.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СУММА(Трудозатраты.Количество * (ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) / Итоги.Всего) КАК Количество,
	|	СУММА(ЕСТЬNULL(Расценки.Расценка, 0) * Трудозатраты.Количество * (ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) / Итоги.Всего) КАК НормативнаяСтоимость,
	|	СУММА(ЕСТЬNULL(Расценки.Расценка, 0) * Трудозатраты.Количество * (ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) / Итоги.Всего) КАК Стоимость
	|ИЗ
	|	(
	|	ВЫБРАТЬ
	|		ДД.Ссылка КАК Ссылка,
	|		СУММА(ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) КАК Всего
	|	ИЗ
	|		Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск КАК Реквизиты
	|			ПО ДД.Ссылка = Реквизиты.Ссылка
	|	ГДЕ
	|		&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен
	|		И &ВключатьДанныеПроизводства21
	|		И Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Реквизиты.Организация В (&МассивОрганизаций)
	|		И Реквизиты.Проведен
	|		
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Ссылка
	|		
	|	ИМЕЮЩИЕ
	|		СУММА(ВЫБОР КОГДА ДД.ДоляСтоимости = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ) > 0
	|		
	|	) КАК Итоги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК ДД
	|			ПО Итоги.Ссылка = ДД.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК Трудозатраты
	|			ПО Итоги.Ссылка = Трудозатраты.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Продукция
	|			ПО ДД.Распоряжение = Продукция.Ссылка
	|			И ДД.КодСтроки = Продукция.КодСтроки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РасценкиРаботСотрудников.СрезПоследних(&КонецПериода) КАК Расценки
	|			ПО Расценки.ВидРабот = Трудозатраты.ВидРабот
	|	ГДЕ
	|		&РасшифровкаРаспределения И НЕ &РасчетСебестоимостиВыполнен
	|
	|СГРУППИРОВАТЬ ПО
	|	Трудозатраты.Подразделение,
	|	Трудозатраты.ВидРабот,
	|	Продукция.Назначение,
	|	Трудозатраты.Ссылка.Организация,
	|	ДД.Распоряжение,
	|	ДД.КодСтроки,
	|	Продукция.Назначение.НаправлениеДеятельности,
	|	Продукция.Номенклатура.ГруппаАналитическогоУчета
	//++ НЕ УТКА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.ВидРабот							КАК ВидРабот,
	|	ДД.ГруппаПродукции					КАК ГруппаПродукции,
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства ССЫЛКА Документ.ЭтапПроизводства2_2
	|			ТОГДА ДД.ПартияПроизводства.Назначение
	|		ИНАЧЕ ДД.АналитикаУчетаПартийПроизводства.Назначение
	|	КОНЕЦ								КАК Назначение,
	|	ДД.ПартияПроизводства				КАК ПартияПроизводства,
	|	ДД.АналитикаУчетаПартийПроизводства	КАК АналитикаУчетаПартийПроизводства,
	|	НЕОПРЕДЕЛЕНО						КАК ЗаказНаПроизводство,
	|	0									КАК КодСтрокиПродукция,
	|	ЕСТЬNULL(ВЫБОР
	|		КОГДА ДД.ПартияПроизводства ССЫЛКА Документ.ЭтапПроизводства2_2
	|			ТОГДА ДД.ПартияПроизводства.НаправлениеДеятельности
	|		ИНАЧЕ ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности
	|	КОНЕЦ, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	СУММА(ДД.Количество)				КАК Количество,
	|	СУММА(ДД.НормативнаяСтоимость)		КАК НормативнаяСтоимость,
	|	СУММА(ДД.Стоимость)					КАК Стоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
	|
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.ПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|	И ДД.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.ВидРабот,
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства ССЫЛКА Документ.ЭтапПроизводства2_2
	|			ТОГДА ДД.ПартияПроизводства.Назначение
	|		ИНАЧЕ ДД.АналитикаУчетаПартийПроизводства.Назначение
	|	КОНЕЦ,
	|	ЕСТЬNULL(ВЫБОР
	|		КОГДА ДД.ПартияПроизводства ССЫЛКА Документ.ЭтапПроизводства2_2
	|			ТОГДА ДД.ПартияПроизводства.НаправлениеДеятельности
	|		ИНАЧЕ ДД.АналитикаУчетаПартийПроизводства.Назначение.НаправлениеДеятельности
	|	КОНЕЦ, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	ДД.Организация,
	|	ДД.АналитикаУчетаПартийПроизводства,
	|	ДД.ПартияПроизводства,
	|	ДД.ПартияПроизводства.НаправлениеДеятельности,
	|	ДД.ГруппаПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// собственное производство 2.1 по заказам
	|ВЫБРАТЬ
	|	ДД.Организация						КАК Организация,
	|	ДД.Подразделение					КАК Подразделение,
	|	ДД.ВидРабот							КАК ВидРабот,
	|	ДД.ГруппаПродукции					КАК ГруппаПродукции,
	|	ТаблицаПродукция.Назначение			КАК Назначение,
	|	НЕОПРЕДЕЛЕНО						КАК ПартияПроизводства,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка) КАК АналитикаУчетаПартийПроизводства,
	|	ДД.ЗаказНаПроизводство				КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция				КАК КодСтрокиПродукция,
	|	ТаблицаПродукция.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СУММА(ДД.Количество)				КАК Количество,
	|	СУММА(ДД.НормативнаяСтоимость)		КАК НормативнаяСтоимость,
	|	СУММА(ДД.Стоимость)					КАК Стоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ТаблицаПродукция
	|			ПО ДД.ЗаказНаПроизводство = ТаблицаПродукция.Ссылка
	|			И ДД.КодСтрокиПродукция = ТаблицаПродукция.КодСтроки
	|
	|ГДЕ
	|	&ВключатьДанныеПроизводства21
	|	И ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.ВидРабот,
	|	ТаблицаПродукция.Назначение,
	|	ДД.Организация,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ТаблицаПродукция.Назначение.НаправлениеДеятельности,
	|	ДД.ГруппаПродукции
	//-- НЕ УТКА
	|;
	|";
	
	Если Запрос <> Неопределено Тогда
		Если Запрос.Параметры.РасчетСебестоимостиВыполнен Или Запрос.Параметры.РасшифровкаРаспределения Тогда
			Текст = СтрЗаменить(Текст, "ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства", "РегистрНакопления.ТрудозатратыНезавершенногоПроизводства");
			Текст = СтрЗаменить(Текст, "ДД.СлужебноеВидДвиженияПриход", "ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И ДД.Активность");
		КонецЕсли;
	КонецЕсли;
	
	Возврат Текст;
	
КонецФункции

// Таблицы: ОтборПоПодразделениям
Процедура УстановитьТаблицуОтбораКорПодразделений(ПараметрыРасчета)
	
	НачалоПериода     = ПараметрыРасчета.РасчетныйПериод.НачалоПериода;
	КонецПериода      = ПараметрыРасчета.РасчетныйПериод.КонецПериода;
	МассивОрганизаций = ПараметрыРасчета.МассивОрганизаций;
	МВТ               = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	// Формируем таблицу регистратор-организация-подр.источник-вышестоящее подр.
	
	ЗапросДокументыРаспределения = Новый Запрос("
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Документ,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.Подразделение.Родитель КАК ВышестоящееПодразделение
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен
	|	И ДД.НаправлениеРаспределения = &НаправлениеРаспределения");
	
	ЗапросДокументыРаспределения.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	ЗапросДокументыРаспределения.УстановитьПараметр("КонецПериода",      КонецДня(КонецПериода));
	ЗапросДокументыРаспределения.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	
	ТЗРезультат = Новый ТаблицаЗначений;
	ТЗРезультат.Колонки.Добавить("Документ", Новый ОписаниеТипов("ДокументСсылка.РаспределениеПрочихЗатрат"));
	ТЗРезультат.Колонки.Добавить("Подразделение", Новый ОписаниеТипов("СправочникСсылка.СтруктураПредприятия"));
	
	// Подразделения, затраты которых распределяются на вышестоящее.
	
	ЗапросДокументыРаспределения.УстановитьПараметр("НаправлениеРаспределения", 
		Перечисления.СпособыРаспределенияСтатейРасходов.ПоПоказателюНаВышестоящееПодразделение);
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		Если Выборка.ВышестоящееПодразделение <> Справочники.СтруктураПредприятия.ПустаяСсылка() Тогда
			НовСтр = ТЗРезультат.Добавить();
			НовСтр.Документ = Выборка.Документ;
			НовСтр.Подразделение = Выборка.ВышестоящееПодразделение;
		КонецЕсли;
	КонецЦикла;
	
	// На нижестоящие.

	ЗапросНижестоящие = Новый Запрос("
		|ВЫБРАТЬ
		|	ДС.Ссылка КАК Подразделение
		|ИЗ
		|	Справочник.СтруктураПредприятия КАК ДС
		|ГДЕ
		|	ДС.Ссылка В ИЕРАРХИИ(&ПодразделениеИсточник)
		|	И ДС.Ссылка <> &ПодразделениеИсточник");

	ЗапросДокументыРаспределения.УстановитьПараметр("НаправлениеРаспределения", 
		Перечисления.СпособыРаспределенияСтатейРасходов.ПоПоказателюНаНижестоящиеПодразделения);
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		ЗапросНижестоящие.УстановитьПараметр("ПодразделениеИсточник", Выборка.Подразделение);
		ВыборкаНижестоящие = ЗапросНижестоящие.Выполнить().Выбрать();
		Пока ВыборкаНижестоящие.Следующий() Цикл 
			НовСтр = ТЗРезультат.Добавить();
			НовСтр.Документ = Выборка.Документ;
			НовСтр.Подразделение = ВыборкаНижестоящие.Подразделение;
		КонецЦикла;
	КонецЦикла;
	
	// На все подразделения.
	
	ЗапросДокументыРаспределения.УстановитьПараметр("НаправлениеРаспределения", 
		Перечисления.СпособыРаспределенияСтатейРасходов.ПоПоказателюНаВсеПодразделения);
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		НовСтр = ТЗРезультат.Добавить();
		НовСтр.Документ = Выборка.Документ;
		НовСтр.Подразделение = Справочники.СтруктураПредприятия.ПустаяСсылка();
	КонецЦикла;
	
	// Если по этапам всех подразделений, то все подразделения.
	
	ЗапросДокументыРаспределения.Текст = "
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Документ
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен
	|	И ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуПоВсемПодразделениям)";
	
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		НовСтр = ТЗРезультат.Добавить();
		НовСтр.Документ = Выборка.Документ;
		НовСтр.Подразделение = Справочники.СтруктураПредприятия.ПустаяСсылка();
	КонецЦикла;
	
	// По подразделениям, указанным в табличной части
	
	ЗапросДокументыРаспределения.Текст = "
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Документ,
	|	Строки.Подразделение КАК Подразделение
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ПоБазе КАК Строки
	|	ПО ДД.Ссылка = Строки.Ссылка
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен";
	
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		НовСтр = ТЗРезультат.Добавить();
		НовСтр.Документ = Выборка.Документ;
		НовСтр.Подразделение = Выборка.Подразделение;
	КонецЦикла;
	
	// По указанным подразделениям.
	
	ЗапросДокументыРаспределения.Текст = "
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Документ,
	|	ДД.Подразделение
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ОтборПоПодразделениям КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Т
	|	ПО ДД.Ссылка = Т.Ссылка
	|ГДЕ
	|	Т.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Проведен";
	
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		НовСтр = ТЗРезультат.Добавить();
		НовСтр.Документ = Выборка.Документ;
		НовСтр.Подразделение = Выборка.Подразделение;
	КонецЦикла;
	
	// В пределах текущего подразделения
	
	ЗапросДокументыРаспределения.Текст = "
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Документ,
	|	ДД.Подразделение
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен
	|	И ДД.ВариантРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуВДанномПодразделении)
	|";
	
	Выборка = ЗапросДокументыРаспределения.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		НовСтр = ТЗРезультат.Добавить();
		НовСтр.Документ = Выборка.Документ;
		НовСтр.Подразделение = Выборка.Подразделение;
	КонецЦикла;
	
	ЗапросРезультат = Новый Запрос("
	|ВЫБРАТЬ
	|	Т.Документ КАК Регистратор,
	|	Т.Подразделение КАК Подразделение
	|ПОМЕСТИТЬ ОтборПоПодразделениям
	|ИЗ
	|	&ТЗРезультат КАК Т");
	
	ЗапросРезультат.МенеджерВременныхТаблиц = МВТ;
	ЗапросРезультат.УстановитьПараметр("ТЗРезультат", ТЗРезультат);
	ЗапросРезультат.Выполнить();
	
КонецПроцедуры

// Таблицы: втОтборПоМатериалам
Процедура УстановитьТаблицуОтбораПоМатериалам(ПараметрыРасчета, Контекст)
	
	НачалоПериода     = ПараметрыРасчета.РасчетныйПериод.НачалоПериода;
	КонецПериода      = ПараметрыРасчета.РасчетныйПериод.КонецПериода;
	МассивОрганизаций = ПараметрыРасчета.МассивОрганизаций;
	МВТ               = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ТекстЗапроса = "";
	Если Контекст = "РаспределениеМатериаловИРабот" Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПроизводственныхЗатрат.ОтборПоМатериалам КАК ТЧ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат КАК Д
		|	ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеВозвратныхОтходов.ОтборПоМатериалам КАК ТЧ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеВозвратныхОтходов КАК Д
		|		ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен";

	ИначеЕсли Контекст = "РаспределениеПрочихЗатрат" Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат.ОтборПоМатериалам КАК ТЧ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Д
		|	ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен";
	КонецЕсли;
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НачалоПериода",      НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Материалы = Новый ТаблицаЗначений;
	Материалы.Колонки.Добавить("Регистратор", Документы.ТипВсеСсылки());
	Материалы.Колонки.Добавить("Материал", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ЗапросИерархия = Новый Запрос("
		|ВЫБРАТЬ
		|	&Док КАК Регистратор,
		|	Н.Ссылка КАК Материал
		|ИЗ
		|	Справочник.Номенклатура КАК Н
		|ГДЕ
		|	Н.Ссылка В ИЕРАРХИИ(&Ном)
		|	И НЕ Н.ЭтоГруппа");
		
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		ЗапросИерархия.УстановитьПараметр("Док", Результат.Регистратор);
		ЗапросИерархия.УстановитьПараметр("Ном", Результат.Материал);
		РезультатИерархия = ЗапросИерархия.Выполнить().Выбрать();
		Пока РезультатИерархия.Следующий() Цикл
			НоваяСтрока = Материалы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, РезультатИерархия);
		КонецЦикла;
	КонецЦикла;
	
	ЗапросРезультат = Новый Запрос("
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Материал КАК Материал
	|ПОМЕСТИТЬ втОтборПоМатериалам
	|ИЗ
	|	&ТЗРезультат КАК Т");
	
	ЗапросРезультат.МенеджерВременныхТаблиц = МВТ;
	ЗапросРезультат.УстановитьПараметр("ТЗРезультат", Материалы);
	ЗапросРезультат.Выполнить();
	
КонецПроцедуры

// Таблицы: ОтборПоГруппамПродукции
Функция ТекстОтборПоГруппамПродукции() //вт ОтборПоГруппамПродукции
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор,
		|	Т.ГруппаПродукции
		|ПОМЕСТИТЬ ОтборПоГруппамПродукции
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.Ссылка КАК Регистратор,
		|		Т.ГруппаПродукции,
		|		0
		|	ИЗ
		|		Документ.РаспределениеПрочихЗатрат.ОтборПоГруппамПродукции КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
		|		ПО Т.Ссылка = ДД.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Проведен
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.Ссылка КАК Регистратор,
		|		ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка),
		|		СУММА(ВЫБОР
		|					КОГДА Т.ГруппаПродукции ЕСТЬ NULL ТОГДА 0
		|					ИНАЧЕ 1 КОНЕЦ)
		|	ИЗ
		|		Документ.РаспределениеПрочихЗатрат КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ОтборПоГруппамПродукции КАК Т
		|		ПО ДД.Ссылка = Т.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|		И ДД.Проведен
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Ссылка
		|	ИМЕЮЩИЕ
		|		СУММА(ВЫБОР
		|					КОГДА Т.ГруппаПродукции ЕСТЬ NULL ТОГДА 0
		|					ИНАЧЕ 1 КОНЕЦ) = 0
		|	) КАК Т
		|";
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапов_6_13

Функция ТекстДанныеПоУказаннымМатериалам() // вт Данные_ПоУказаннымМатериалам
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ДД.Организация,
		|	ЕСТЬNULL(ОтчетПереработчика.Подразделение, ДД.Подразделение) КАК Подразделение,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Назначение.НаправлениеДеятельности
		|		КОГДА НЕ Выпуск.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА Выпуск.Назначение.НаправлениеДеятельности
		|		КОГДА НЕ ОтчетПереработчика.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ОтчетПереработчика.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|	КОНЕЦ КАК НаправлениеДеятельности,
		|	Аналитика.Номенклатура КАК Материал,
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура
		|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК Продукция,
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура.ГруппаАналитическогоУчета
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура.ГруппаАналитическогоУчета
		|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура.ГруппаАналитическогоУчета
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ГруппаПродукции,
		|	ДД.Назначение,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Объем,
		|	СУММА(ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество) КАК Вес
		|ПОМЕСТИТЬ Данные_ПоУказаннымМатериалам
		|ИЗ
		|	ВТКэшРасчетныеОборотыМатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.КлючАналитики = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = Аналитика.Номенклатура
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказыНаПроизводство
		|		ПО ЗаказыНаПроизводство.Ссылка = ДД.ЗаказНаПроизводство
		|		И ЗаказыНаПроизводство.КодСтроки = ДД.КодСтрокиПродукция
		//-- НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ЗаказыПереработчику
		|		ПО ЗаказыПереработчику.Ссылка = ДД.ЗаказНаПроизводство
		|		И ЗаказыПереработчику.КодСтроки = ДД.КодСтрокиПродукция
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
		|		ПО Выпуск.Ссылка = ДД.ЗаказНаПроизводство
		|		И Выпуск.КодСтроки = ДД.КодСтрокиПродукция
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
		|		ПО ОтчетПереработчика.Ссылка = ДД.Регистратор
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И (ДД.СтатьяРасходов = НЕОПРЕДЕЛЕНО ИЛИ ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
		|	И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка)
		|	И НЕ ДД.Регистратор Ссылка Документ.ВозвратМатериаловИзПроизводства
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ЕСТЬNULL(ОтчетПереработчика.Подразделение, ДД.Подразделение),
		|	Аналитика.Номенклатура,
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура
		|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура.ГруппаАналитическогоУчета
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура.ГруппаАналитическогоУчета
		|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура.ГруппаАналитическогоУчета
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.Назначение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказыПереработчику.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Назначение.НаправлениеДеятельности
		|		КОГДА НЕ Выпуск.Назначение.НаправлениеДеятельности ЕСТЬ NULL ТОГДА Выпуск.Назначение.НаправлениеДеятельности
		|		КОГДА НЕ ОтчетПереработчика.НаправлениеДеятельности ЕСТЬ NULL ТОГДА ОтчетПереработчика.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|	КОНЕЦ
		|";
		
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстДанныеПоПродукции() // вт ФактЭтапов_ПоПродукции, ПланЭтаповПоЗаказам_ПоПродукции, Данные_ПоПродукции
	
	ТекстЗапроса =
		"
		//++ НЕ УТКА
		|ВЫБРАТЬ
		|	ДД.Подразделение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.Этап.Владелец КАК Спецификация,
		|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
		|ПОМЕСТИТЬ ФактЭтапов_ПоПродукции
		|ИЗ
		|	РегистрНакопления.ЭтапыПроизводства КАК ДД
		|ГДЕ
		// Выполняющийся этап
		|	((ДД.НачалоПредварительногоБуфера <= &КонецПериода
		|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
		|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0))
		|	ИЛИ
		// Выполненный этап
		|	(ДД.ОкончаниеЗавершающегоБуфера МЕЖДУ &НачалоПериода И &КонецПериода
		|	И (ДД.Выполнено <> 0 ИЛИ ДД.Брак <> 0)))
		|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Подразделение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.Этап.Владелец
		|;
		|/////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Спецификация,
		|	СУММА(Этапы.ЗапланированоЗаказом) КАК ПланЭтапов
		|ПОМЕСТИТЬ ПланЭтаповПоЗаказам_ПоПродукции
		|ИЗ
		|	ФактЭтапов_ПоПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Распоряжение = ДД.Распоряжение
		|		И Этапы.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Этапы.Этап = ДД.Этап
		|		И Этапы.ЗапланированоЗаказом <> 0
		|		И Этапы.Активность
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Спецификация
		|;
		|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|
		//-- НЕ УТКА
		// Данные по выпуску без распоряжений
		|ВЫБРАТЬ
		|	Выпуск.Организация,
		|	Выпуск.Подразделение,
		|	ЕСТЬNULL(ДД.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))КАК НаправлениеДеятельности,
		|	ДД.Номенклатура КАК Продукция,
		|	СпрНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	ДД.Назначение,
		|	ДД.Ссылка КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.Количество КАК ЗапланированоПродукции,
		|	1 КАК ЗапланированоЭтапов,
		|	1 КАК ВыполненоЭтапов,
		|	ДД.Количество,
		|	ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * ДД.Количество КАК Объем,
		|	ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * ДД.Количество КАК Вес
		|ПОМЕСТИТЬ Данные_ПоПродукции
		|ИЗ
		|	Документ.ВыпускПродукции.Товары КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
		|		ПО (Выпуск.Ссылка = ДД.Ссылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО (СпрНоменклатура.Ссылка = ДД.Номенклатура)
		|ГДЕ
		|	Выпуск.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Выпуск.Организация В (&МассивОрганизаций)
		|	И НЕ Выпуск.ВыпускПоРаспоряжениям
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Выпуск.Проведен
		|
		//++ НЕ УТКА
		// Данные по выпуску по распоряжениям
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаказНаПроизводство.Организация,
		|	ДД.Подразделение,
		|	ЕСТЬNULL(Строки.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	Строки.Номенклатура КАК Продукция,
		|	СпрНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	Строки.Назначение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	Строки.Количество,
		|	План.ПланЭтапов,
		|	ДД.ФактЭтапов,
		|	ВЫБОР
		|		КОГДА План.ПланЭтапов <> 0
		|		ТОГДА Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Количество, //Это расчетный выпуск
		|	ВЫБОР
		|		КОГДА План.ПланЭтапов <> 0
		|		ТОГДА ВЫРАЗИТЬ(&Объем КАК ЧИСЛО(15,3)) * Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Объем,
		|	ВЫБОР
		|		КОГДА План.ПланЭтапов <> 0
		|		ТОГДА ВЫРАЗИТЬ(&Вес КАК ЧИСЛО(15,3)) * Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Вес
		|
		|ИЗ ФактЭтапов_ПоПродукции КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоПродукции КАК План
		|		ПО План.Распоряжение = ДД.Распоряжение
		|		И План.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И План.Спецификация = ДД.Спецификация
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Распоряжение
		|		И Строки.КодСтроки = ДД.КодСтрокиПродукция
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
		|		ПО ЗаказНаПроизводство.Ссылка = ДД.Распоряжение
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = Строки.Номенклатура
		|
		//-- НЕ УТКА
		// Поступление от переработчика.
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ОтчетыПереработчика.Организация,
		|	ОтчетыПереработчика.Подразделение,
		|	ЕСТЬNULL(Строки.Назначение.НаправлениеДеятельности, ОтчетыПереработчика.НаправлениеДеятельности) КАК НаправлениеДеятельности,
		|	ДД.Номенклатура,
		|	СпрНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	КлючиАналитики.Назначение,
		|	ДД.ЗаказПереработчику КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.Количество КАК ЗапланированоПродукции,
		|	1 КАК ЗапланированоЭтапов,
		|	1 КАК ВыполненоЭтапов,
		|	ДД.Количество,
		|	&Объем * ДД.Количество,
		|	&Вес * ДД.Количество
		|
		|ИЗ
		|	Документ.ОтчетПереработчика.Продукция КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетыПереработчика
		|		ПО ДД.Ссылка = ОтчетыПереработчика.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = ДД.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитики
		|		ПО КлючиАналитики.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК Строки
		|		ПО ДД.ЗаказПереработчику = Строки.Ссылка
		|		И ДД.КодСтроки = Строки.КодСтроки
		|ГДЕ
		|	ОтчетыПереработчика.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ОтчетыПереработчика.Организация В (&МассивОрганизаций)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|";
	
	Возврат ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса);
	
КонецФункции

Функция ТекстДанныеПоПлановойСтоимости() // вт ФактЭтапов_ПоПлановойСтоимости, ПланЭтаповПоЗаказам_ПоПлановойСтоимости, Данные_ПоПлановойСтоимости
	Возврат
		"
		//++ НЕ УТКА
		|ВЫБРАТЬ
		|	ДД.Подразделение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
		|ПОМЕСТИТЬ ФактЭтапов_ПоПлановойСтоимости
		|ИЗ
		|	РегистрНакопления.ЭтапыПроизводства КАК ДД
		|ГДЕ
		// Выполняющийся этап
		|	((ДД.НачалоПредварительногоБуфера <= &КонецПериода
		|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
		|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0))
		|	ИЛИ
		// Выполненный этап
		|	ДД.ОкончаниеЗавершающегоБуфера МЕЖДУ &НачалоПериода И &КонецПериода
		|	)
		|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Подразделение,
		|	ДД.Распоряжение,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.Распоряжение,
		|	Т.КодСтрокиПродукция,
		|	СУММА(ДД.ЗапланированоЗаказом) КАК ПланЭтапов
		|ПОМЕСТИТЬ ПланЭтаповПоЗаказам_ПоПлановойСтоимости
		|ИЗ
		|	ФактЭтапов_ПоПлановойСтоимости КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК ДД
		|		ПО Т.Распоряжение = ДД.Распоряжение
		|		И Т.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Т.Этап = ДД.Этап
		|		И ДД.ЗапланированоЗаказом <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.Распоряжение,
		|	Т.КодСтрокиПродукция
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|
		//-- НЕ УТКА
		// Данные по выпуску без распоряжений.
		|ВЫБРАТЬ
		|	Выпуск.Организация,
		|	Выпуск.Подразделение,
		|	ЕСТЬNULL(ДД.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	ДД.Номенклатура КАК Номенклатура,
		|	ДД.Характеристика КАК Характеристика,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	ДД.Назначение,
		|	ДД.Ссылка КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.Количество КАК ЗапланированоПродукции,
		|	1 КАК ЗапланированоЭтапов,
		|	1 КАК ВыполненоЭтапов,
		|	ДД.Количество
		|ПОМЕСТИТЬ Данные_ПоПлановойСтоимости
		|ИЗ
		|	Документ.ВыпускПродукции.Товары КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
		|		ПО (Выпуск.Ссылка = ДД.Ссылка)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|		ПО (СН.Ссылка = ДД.Номенклатура)
		|ГДЕ
		|	Выпуск.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Выпуск.Организация В (&МассивОрганизаций)
		|	И НЕ Выпуск.ВыпускПоРаспоряжениям
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Выпуск.Проведен
		//++ НЕ УТКА
		// Данные по выпуску по распоряжениям.
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Д.Организация,
		|	ФК.Подразделение,
		|	ЕСТЬNULL(П.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	П.Номенклатура КАК Номенклатура,
		|	П.Характеристика КАК Характеристика,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	П.Назначение,
		|	ФК.Распоряжение,
		|	ФК.КодСтрокиПродукция,
		|	ФК.Этап,
		|	П.Количество,
		|	ПЛ.ПланЭтапов,
		|	ФК.ФактЭтапов,
		|	ВЫБОР
		|		КОГДА ФК.ФактЭтапов <> 0 И ПЛ.ПланЭтапов <> 0
		|		ТОГДА П.Количество * ФК.ФактЭтапов / ПЛ.ПланЭтапов
		|		ИНАЧЕ П.Количество
		|	КОНЕЦ КАК Количество //Это расчетный выпуск
		|
		|ИЗ
		|	ФактЭтапов_ПоПлановойСтоимости КАК ФК
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоПлановойСтоимости КАК ПЛ
		|	ПО ФК.Распоряжение = ПЛ.Распоряжение
		|	И ФК.КодСтрокиПродукция = ПЛ.КодСтрокиПродукция
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК П
		|	ПО ФК.Распоряжение = П.Ссылка
		|	И ФК.КодСтрокиПродукция = П.КодСтроки
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК Д
		|	ПО ФК.Распоряжение = Д.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|	ПО П.Номенклатура = СН.Ссылка
		|
		//-- НЕ УТКА
		// Поступление от переработчика.
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Заказ.Организация,
		|	Заказ.Подразделение,
		|	ЕСТЬNULL(Строки.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	СпрНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	Заказ.Назначение,
		|	ДД.Распоряжение КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.Количество КАК ЗапланированоПродукции,
		|	1 КАК ЗапланированоЭтапов,
		|	1 КАК ВыполненоЭтапов,
		|	ДД.Количество
		|ИЗ
		|	РегистрНакопления.ТоварыПолученныеОтПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК Заказ
		|		ПО ДД.Распоряжение = Заказ.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО Аналитика.Номенклатура = СпрНоменклатура.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК Строки
		|		ПО ДД.Распоряжение = Строки.Ссылка
		|		И ДД.КодСтроки = Строки.КодСтроки
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Заказ.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|";
КонецФункции

Функция ТекстДанныеПоУказаннымТрудозатратам() // вт Данные_ПоУказаннымТрудозатратам
	Возврат
		"ВЫБРАТЬ
		|	ДД.Организация КАК Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Выпуски.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	ДД.ВидРабот КАК ВидРабот,
		|	Аналитика.Номенклатура КАК Продукция,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	Выпуски.Назначение КАК Назначение,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	ДД.КодСтроки КАК КодСтроки,
		|	ДД.Количество КАК Количество
		|ПОМЕСТИТЬ Данные_ПоУказаннымТрудозатратам
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО ДД.КорАналитикаУчетаПродукции = Аналитика.КлючАналитики
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|	ПО Аналитика.Номенклатура = СН.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуски
		|	ПО ДД.ДокументВыпуска = Выпуски.Ссылка
		|	И ДД.КодСтроки = Выпуски.КодСтроки
		|
		|ГДЕ
		|	ДД.КодСтрокиПродукция = 0
		|	И ДД.Количество <> 0
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		|
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Организация КАК Организация,
		|	ДД.Подразделение КАК Подразделение,
		|	ЕСТЬNULL(Строки.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	ДД.ВидРабот КАК ВидРабот,
		|	Аналитика.Номенклатура КАК Продукция,
		|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	ЕСТЬNULL(З.Назначение, НЕОПРЕДЕЛЕНО) КАК Назначение,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	ДД.Этап КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	ДД.Количество КАК Количество
		|ИЗ
		|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ДД
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
		|	ПО ДД.КорАналитикаУчетаПродукции = Аналитика.КлючАналитики
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
		|	ПО Аналитика.Номенклатура = СН.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК З
		|	ПО ДД.ЗаказНаПроизводство = З.Ссылка
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Строки
		|	ПО ДД.ЗаказНаПроизводство = Строки.Ссылка
		|	И ДД.КодСтрокиПродукция = Строки.КодСтроки
		|
		|ГДЕ
		|	ДД.Количество <> 0
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		//-- НЕ УТКА
		|";
КонецФункции

#КонецОбласти
//-- НЕ УТ

#Область ВспомогательныеПроцедуры

Функция ПереченьПолей(КоллекцияКолонок, Исключения = "")
	
	ИсключаемыеПоля = Новый Структура(Исключения);
	ПереченьПолей = "";
	
	Для Каждого Колонка Из КоллекцияКолонок Цикл
		Если НЕ ИсключаемыеПоля.Свойство(Колонка.Имя) Тогда
			ПереченьПолей = ПереченьПолей + ?(ЗначениеЗаполнено(ПереченьПолей), ", ", "") + Колонка.Имя;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ПереченьПолей;
	
КонецФункции

Процедура ВыбиратьДанныеДляРасчетаВоВременнуюТаблицу(Запрос, УсловиеОтбораДляОтладки = "")
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ВоВременнуюТаблицу", "ПОМЕСТИТЬ Данные");
	
	Если ЗначениеЗаполнено(УсловиеОтбораДляОтладки) Тогда
		
		// Иногда для упрощения отладки достаточно выбрать только часть данных.
		// Например, только данные по одной позиции номенклатуры.
		// В этом случае во второй параметр надо передать строку условий отбора "ГДЕ", например
		//   Т.АналитикаУчетаНоменклатуры.Номенклатура.Код = ""12345678""
		// Следует помнить, что рассчитанные таким образом неполные данные записывать в ИБ не следует,
		// т.к. это вызовет очистку всех остальных данных, не попавших в отбор "ГДЕ".
		
		Запрос.Текст = Запрос.Текст + "
		|
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ Данные_Временная
		|ИЗ
		|	Данные КАК Т
		|ГДЕ
		|	" + УсловиеОтбораДляОтладки + "
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	Данные_Временная КАК Т
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные_Временная";
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПодставитьШаблоныВесаИОбъемаВТекстЗапроса(ТекстЗапроса)
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Вес", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Объем", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
		
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПроцедурыЭтапов_Контекстные

// Используется для всех вызовов заполнения расчетной партии.
//
Процедура ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Контекст, РасчетнаяПартия, Расход, Приход)
	
	Если Ложь Тогда // для удобства расстановки тэгов ниже по тексту
		
	//++ НЕ УТКА
	ИначеЕсли Контекст = "РаспределениеТоваровОрганизацийНаПроизводство" Тогда
		// Этап 1
		ЗаполнитьРасчетнуюПартиюРаспределенияТоваровОрганизацийНаПроизводство(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "РаспределениеНоменклатурыНаПроизводство" Тогда
		// Этап 3
		ЗаполнитьРасчетнуюПартиюРаспределенияНоменклатурыНаПроизводство(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "РаспределениеНоменклатурыНаВыпуск" Тогда
		// Этап 4
		ЗаполнитьРасчетнуюПартиюРаспределениеНоменклатурыНаВыпуск(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	//-- НЕ УТКА
	//++ НЕ УТ
	ИначеЕсли Контекст = "РаспределениеДолейПроизводственныхРасходов" Тогда
		// Этап 8
		ЗаполнитьРасчетнуюПартиюРаспределенияДолейПроизводственныхРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "РаспределениеТрудозатрат" Тогда
		// Этап 1
		ЗаполнитьРасчетнуюПартиюРаспределениеТрудозатрат(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "РаспределениеМатериаловИРаботПоБазе" Тогда
		// Этап 2
		ЗаполнитьРасчетнуюПартиюРаспределениеМатериаловИРаботПоБазе(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "РаспределениеМатериаловНЗП" Тогда
		// Этап 3
		ЗаполнитьРасчетнуюПартиюРаспределениеМатериаловНЗП(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	//-- НЕ УТ
	ИначеЕсли Контекст = "ПартииСебестоимостиТоваров" Тогда
		// Этап 4
		ЗаполнитьРасчетнуюПартиюСебестоимостиТоваров(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "ДопРасходы_ЗаказыПоставщикам" Тогда
		// Этап 6
		ЗаполнитьРасчетнуюПартиюЗаказВПриходе(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "ДопРасходы_ПартииПрочихРасходов" Тогда
		// Этап 6
		ЗаполнитьРасчетнуюПартиюПрочихРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "ДопРасходы_ПриходПартийРасходов" Тогда
		// Этап 6
		ЗаполнитьРасчетнуюПартиюПриходПартииРасходов(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	ИначеЕсли Контекст = "ПартииНДСиУСН" Тогда
		// Этап 7
		ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	Иначе
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Для контекста %1 не предусмотрено заполнение полей расчетной партии'"),
			Контекст);
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
			ТекстДляПротокола);
		
		ВызватьИсключение ТекстДляПротокола;
		
	КонецЕсли;	
	
КонецПроцедуры

//++ НЕ УТ

Функция ОтборПоМатериаламИерархия(ПараметрыРасчета)
	
	Контекст = ПараметрыРасчета.РаспределениеПартий.ОписаниеДвижений.Контекст;
	
	Материалы = Новый ТаблицаЗначений;
	Материалы.Колонки.Добавить("Регистратор", Документы.ТипВсеСсылки());
	Материалы.Колонки.Добавить("Материал",    Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Если Контекст = "РаспределениеНоменклатурыНаПроизводство"
		ИЛИ Контекст = "РаспределениеМатериаловИРаботПоБазе" Тогда
		
		// Этап 2
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПроизводственныхЗатрат.ОтборПоМатериалам КАК ТЧ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат КАК Д
		|		ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен
		|	И Д.КоличествоКРаспределениюПоПравилу <> 0
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеВозвратныхОтходов.ОтборПоМатериалам КАК ТЧ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеВозвратныхОтходов КАК Д
		|		ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен
		|	И Д.КоличествоПоПравилу <> 0
		//-- НЕ УТКА
		|";
		
	ИначеЕсли Контекст = "ПрочиеРасходыНЗППоБазе_КРаспределению"
	 ИЛИ Контекст = "ПрочиеРасходыНЗППоБазе_ПоПодразделениям" 
	 ИЛИ Контекст = "ПрочиеРасходыНЗППоБазе_ПоЭтапам" Тогда
		
		// Этап 8
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат.ОтборПоМатериалам КАК ТЧ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Д
		|		ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен";
		
	Иначе
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Для контекста %1 не предусмотрено формирование отбора по материалам с иерархией'"),
			Контекст);
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
			ТекстДляПротокола);
			
		ВызватьИсключение ТекстДляПротокола;
		
	КонецЕсли;

	Результат = Запрос.Выполнить().Выбрать();
	
	ЗапросИерархия = Новый Запрос;
	ЗапросИерархия.Текст =
	"ВЫБРАТЬ
	|	Н.Ссылка КАК Материал,
	|	&Док КАК Регистратор
	|ИЗ
	|	Справочник.Номенклатура КАК Н
	|ГДЕ
	|	Н.Ссылка В ИЕРАРХИИ(&Ном)
	|	И НЕ Н.ЭтоГруппа";
		
	Пока Результат.Следующий() Цикл
		
		ЗапросИерархия.УстановитьПараметр("Док", Результат.Регистратор);
		ЗапросИерархия.УстановитьПараметр("Ном", Результат.Материал);
		РезультатИерархия = ЗапросИерархия.Выполнить().Выбрать();
		
		Пока РезультатИерархия.Следующий() Цикл
			НоваяСтрока = Материалы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, РезультатИерархия);
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Материалы;
	
КонецФункции

//-- НЕ УТ
#КонецОбласти


#Область РаспределениеПартийПоЦепочкам

#Область ИнициализацияИЗавершение

Процедура ИнициализироватьРаспределениеПартий(ПараметрыРасчета, ТаблицаДляРаспределенияПартий,
			ОписаниеЦепочек, ОписаниеДвижений, НезаписываемыеДанные)
	
	ПараметрыРасчета.Вставить("РаспределениеПартий", Новый Структура);
	
	ПараметрыРасчета.РаспределениеПартий.Вставить("РасчетныеПартии", 	  ТаблицаДляРаспределенияПартий);
	ПараметрыРасчета.РаспределениеПартий.Вставить("ОписаниеЦепочек", 	  ОписаниеЦепочек);
	ПараметрыРасчета.РаспределениеПартий.Вставить("ОписаниеДвижений", 	  ОписаниеДвижений);
	ПараметрыРасчета.РаспределениеПартий.Вставить("НезаписываемыеДанные", НезаписываемыеДанные);
	
КонецПроцедуры


Функция ОписаниеЦепочки(ОписаниеЦепочек, ТипЗаписи)
	
	Если ОписаниеЦепочек[ТипЗаписи] = Неопределено Тогда
		ОписаниеЦепочек.Вставить(
			ТипЗаписи,
			Новый Структура(
				"ПоляСвязи, ТипыПриемников, ТипыИсточников",
				Новый Массив, Новый Соответствие, Новый Соответствие));
	КонецЕсли;
	
	Возврат ОписаниеЦепочек[ТипЗаписи];
	
КонецФункции

Процедура ДобавитьОписаниеПриемника(ОписаниеЦепочек, Приемник, ПоляПриемника)
	
	Для Каждого ОписаниеПоля Из Новый Структура(ПоляПриемника) Цикл
		ОписаниеЦепочки(ОписаниеЦепочек, Приемник).ПоляСвязи.Добавить(ОписаниеПоля.Ключ);
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьОписаниеИсточника(ОписаниеЦепочек, Приемник, Источник, ПоляИсточника)
	
	ПоляСвязи = Новый Массив;
	Для Каждого ОписаниеПоля Из Новый Структура(ПоляИсточника) Цикл
		ПоляСвязи.Добавить(ОписаниеПоля.Ключ);
	КонецЦикла;
	
	ОписаниеЦепочки(ОписаниеЦепочек, Источник).ТипыПриемников.Вставить(Приемник, ПоляСвязи);
	ОписаниеЦепочки(ОписаниеЦепочек, Приемник).ТипыИсточников.Вставить(Источник, ПоляСвязи);
	
КонецПроцедуры

// Используется в случае, когда тип записи не имеет источников.
// Т.е. такой тип записи получается не распределением другого типа записей,
// а просто формируется по данным выборки (аналог типа записи "Дополнение" в партионном учете версии 2.1).
//
Процедура ДобавитьОписаниеДополнения(ОписаниеЦепочек, Приемник)
	
	ДобавитьОписаниеПриемника(ОписаниеЦепочек, Приемник, "Регистратор");
	ДобавитьОписаниеИсточника(ОписаниеЦепочек, Приемник, "", "Регистратор"); // псевдоисточник
	
КонецПроцедуры

Функция ОписаниеДвижений(Контекст, ИмяРегистра, ПоляРасчета, КлючиСравнения, Показатели,
						 БазисПрихода, БазисРасхода, КлючРасхода, ПолеПорядка, ПоляСортировки = "", СортировкаПоУсловию = "")
	
	Результат = Новый Структура;
	
	Результат.Вставить("Контекст", 			  		Контекст);
	Результат.Вставить("ИмяРегистра", 		  		ИмяРегистра);
	Результат.Вставить("ПоляРасчета", 		 	 	ПоляРасчета);
	Результат.Вставить("КлючиСравнения", 	  		КлючиСравнения);
	Результат.Вставить("Показатели", 		  		Показатели);
	Результат.Вставить("БазисПрихода", 		  		БазисПрихода);
	Результат.Вставить("БазисРасхода", 		  		БазисРасхода);
	Результат.Вставить("КлючРасхода", 		  		КлючРасхода);
	Результат.Вставить("ПолеПорядка", 		  		ПолеПорядка);
	Результат.Вставить("ПоляСортировки", 	  		ПоляСортировки);
	Результат.Вставить("СортировкаПоУсловию", 		СортировкаПоУсловию);
	
	Результат.Вставить("ИмяВременнойТаблицы", 		"");
	Результат.Вставить("РаспределениеНеТребуется",  Ложь);
	
	Возврат Результат;
	
КонецФункции


Функция ОписаниеНезаписываемыхДанных(ЗаписыватьНезавершенные, НезаписываемыеТипыЗаписей = Неопределено,
			НезаписываемыеРазделы = Неопределено, НезаписываемыеРегистраторы = Неопределено)
	
	НезаписываемыеДанные = Новый Структура;
	НезаписываемыеДанные.Вставить("ЗаписыватьНезавершенные", 	ЗаписыватьНезавершенные);
	НезаписываемыеДанные.Вставить("НезаписываемыеТипыЗаписей", 	?(НезаписываемыеТипыЗаписей = Неопределено, Новый Соответствие, НезаписываемыеТипыЗаписей));
	НезаписываемыеДанные.Вставить("НезаписываемыеРегистраторы", ?(НезаписываемыеРегистраторы = Неопределено, Новый Соответствие, НезаписываемыеРегистраторы));
	НезаписываемыеДанные.Вставить("НезаписываемыеРазделы", 		?(НезаписываемыеРазделы = Неопределено, Новый Соответствие, НезаписываемыеРазделы));
	
	// Движения документа корректировки регистров не изменяем
	НезаписываемыеДанные.НезаписываемыеРегистраторы.Вставить(Метаданные.Документы.КорректировкаРегистров.Имя, Истина);
	
	Возврат НезаписываемыеДанные;
	
КонецФункции


Функция ТаблицаДляРаспределенияПартий(ПараметрыРасчета, ТекстОписаниеДанных, ДобавлятьКолонкуНумерации = Истина)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = ТекстОписаниеДанных;
	
	Таблица = Запрос.Выполнить().Выгрузить().СкопироватьКолонки(); // создадим пустую таблицу
	
	// Уберем тип Null из описания типов колонок.
	Для Каждого ТекущаяКолонка Из Таблица.СкопироватьКолонки().Колонки Цикл
		
		Если ТекущаяКолонка.ТипЗначения.СодержитТип(Тип("Null")) Тогда
			
			Таблица.Колонки.Удалить(ТекущаяКолонка.Имя); // удалим колонку
			
			Таблица.Колонки.Добавить(
				ТекущаяКолонка.Имя,
				Новый ОписаниеТипов(ТекущаяКолонка.ТипЗначения,, "Null"),
				ТекущаяКолонка.Заголовок,
				ТекущаяКолонка.Ширина); // добавим аналогичную без типа значения Null
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если ДобавлятьКолонкуНумерации Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.ДобавитьКолонкуДляНумерацииСтрок(Таблица);
	КонецЕсли;
	
	Возврат Таблица;
	
КонецФункции

Процедура ЗавершитьРаспределениеПартий(ПараметрыРасчета, ОкончаниеЭтапа = Истина)
	
	Если ОкончаниеЭтапа Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	Иначе
		УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьРаспределенныеПартии(ПараметрыРасчета);
	КонецЕсли;
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"Данные, Источники, Приемники, ОписаниеПодграфов, ОписаниеУзловПодграфов");
	
КонецПроцедуры

#КонецОбласти

#Область ПостроениеЦепочек

Процедура ПостроитьЦепочкиДвижений(ПараметрыРасчета)
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "Источники");
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Проверим, что типы записей в описании цепочек соответствуют выбранным данным.
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ТипЗаписи 	 КАК ТипЗаписи,
	|	Т.ЗапросИсточник КАК ЗапросИсточник,
	|	Т.Регистратор    КАК Регистратор
	|ИЗ
	|	Данные КАК Т
	|ГДЕ
	|	НЕ Т.ТипЗаписи В (&ДопустимыеТипыЗаписей)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ТипЗаписи,
	|	ЗапросИсточник,
	|	Регистратор";
	
	ДопустимыеТипыЗаписей = ИспользуемыеТипыЗаписейВЦепочках(ПараметрыРасчета.РаспределениеПартий.ОписаниеЦепочек,,, Ложь);
	Запрос.УстановитьПараметр("ДопустимыеТипыЗаписей", ДопустимыеТипыЗаписей);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
			ПротоколРасчетаПартийИСебестоимости.СлужебныйСимвол_БезНумерации()
				+ НСтр("ru='В выбранных данных есть типы записей, отсутствующие в описании цепочек. Эти записи не будут обработаны.'"));
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Тип записи: %1, источник: ""%2"", регистратор: %3'"),
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.ТипЗаписи),
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.ЗапросИсточник),
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.Регистратор));
			
			ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
				ПараметрыРасчета,
				Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
				ТекстОшибки);
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Проверим, что непересчитываемые типы записей не являются приемниками.
	ТипыЗаписейПриемников = ИспользуемыеТипыЗаписейВЦепочках(ПараметрыРасчета.РаспределениеПартий.ОписаниеЦепочек,, Ложь, Ложь);
	ЕстьНепересчитываемыеТипыЗаписейВПриемниках = Ложь;
	
	Для Каждого ТекущийТипЗаписи Из ТипыЗаписейПриемников Цикл
		
		Если УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЭтоНепересчитываемыйТипЗаписи(ТекущийТипЗаписи) Тогда
			
			Если НЕ ЕстьНепересчитываемыеТипыЗаписейВПриемниках Тогда
				ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
					ПараметрыРасчета,
					Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
					ПротоколРасчетаПартийИСебестоимости.СлужебныйСимвол_БезНумерации()
						+ НСтр("ru='В описании цепочек в качестве приемников не могут использоваться непересчитываемые типы записей. Изменение таких записей недопустимо.'"));
			КонецЕсли;
			
			ЕстьНепересчитываемыеТипыЗаписейВПриемниках = Истина;
			
			ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
				ПараметрыРасчета,
				Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияПартий,
				ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(ТекущийТипЗаписи));
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Сформируем текст запроса для построения цепочек
	ШаблонЗапроса = "
	|ВЫБРАТЬ
	|	Приемники.К КАК Приемник,
	|	Источники.К КАК Источник
	|ПОМЕСТИТЬ %Результат
	|ИЗ
	|	Данные КАК Приемники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные КАК Источники
	|		ПО %Условия
	|ГДЕ
	|	Приемники.К <> Источники.К
	|	И Приемники.ТипЗаписи = &ТипПриемника
	|	И Источники.ТипЗаписи = &ТипИсточника
	|;
	|";
	
	ТекстЗапроса = "";
	ВременныеТаблицы = Новый Массив;
	НомерТаблицы = 0;
	
	Для Каждого Описание Из ПараметрыРасчета.РаспределениеПартий.ОписаниеЦепочек Цикл
		
		ПоляПриемника = Описание.Значение.ПоляСвязи;
		Если ПоляПриемника.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Для Каждого ОписаниеИсточника Из Описание.Значение.ТипыИсточников Цикл
			
			ПоляИсточника = ОписаниеИсточника.Значение;
			Если ПоляИсточника.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			НомерПоля = -1;
			Для Каждого ПолеПриемника Из ПоляПриемника Цикл
				НомерПоля = НомерПоля + 1;
				Если НомерПоля = 0 Тогда
					Условия = "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				Иначе
					Условия = Условия + Символы.ПС + " И " + "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				КонецЕсли;
			КонецЦикла;
			
			НомерТаблицы = НомерТаблицы + 1;
			ИмяТаблицы   = "ВТЦепочки" + Формат(НомерТаблицы, "ЧГ=");
			ВременныеТаблицы.Добавить(ИмяТаблицы);
			
			ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "%Результат", ИмяТаблицы);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,  "%Условия",   Условия);
			
			Запрос = Новый Запрос(ТекстЗапроса);
			Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
			Запрос.УстановитьПараметр("ТипПриемника", Описание.Ключ);
			Запрос.УстановитьПараметр("ТипИсточника", ОписаниеИсточника.Ключ);
			Запрос.Выполнить();
			
		КонецЦикла;
		
	КонецЦикла;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	-1 КАК Приемник,
	|	-1 КАК Источник
	|ПОМЕСТИТЬ
	|	Цепочки
	|";
	
	ШаблонЗапроса = "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Приемник,
	|	ДД.Источник
	|ИЗ
	|	%ИмяТаблицы КАК ДД
	|";
	
	Для Каждого ИмяТаблицы Из ВременныеТаблицы Цикл
		ТекстЗапроса = ТекстЗапроса + СтрЗаменить(ШаблонЗапроса, "%ИмяТаблицы", ИмяТаблицы);
	КонецЦикла;
	
	Для Каждого ИмяТаблицы Из ВременныеТаблицы Цикл
		ТекстЗапроса = ТекстЗапроса + "; УНИЧТОЖИТЬ " + ИмяТаблицы;
	КонецЦикла;
	
	// Выполним подготовленный запрос.
	Запрос.Текст = ТекстЗапроса;
	Запрос.Выполнить();
	
	// Разобьем временную таблицу Цепочки на таблицы источников и приемников для каждого узла.
	// Поля доп. упорядочивания для ФИФО (Период и Регистратор) пока не заполняются - будут заполнены при оптимизации цепочек.
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Приемник КАК Ключ,
	|	ДД.Источник КАК Источник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Источники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Источник КАК Ключ,
	|	ДД.Приемник КАК Приемник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Приемники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Цепочки
	|";
	
	Запрос.Выполнить();
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	ОптимизироватьНумерациюВЦепочках(ПараметрыРасчета);
	
КонецПроцедуры

Процедура ОптимизироватьНумерациюВЦепочках(ПараметрыРасчета)
	
	РазмерТаблицыДанных = УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "Данные");
	
	Если РазмерТаблицыДанных = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыРасчета.Отладка.НеВыполнятьОптимизациюЦепочек Тогда
		
		ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(
			ПараметрыРасчета,
			НСтр("ru='Оптимизация нумерации узлов графа перед расчетом партий по цепочкам пропущена для целей отладки.'"));
		
		Возврат;
		
	КонецЕсли;
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "ВТНовыеНомераУзлов");
	
	#Область Инициализация
	
	КолонкиТаблицыДанных = ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии.Колонки;
	
	ЕстьПериодПоступленияВДанных = (КолонкиТаблицыДанных.Найти("ПериодПоступления") <> Неопределено);
	ЕстьПериодВДанных 	   		 = (КолонкиТаблицыДанных.Найти("Период") <> Неопределено);
	ЕстьРегистраторВДанных	 	 = (КолонкиТаблицыДанных.Найти("Регистратор") <> Неопределено);
	
	ИменаКолонокТаблицыДанные = "";
	Для Каждого ТекущаяКолонка Из КолонкиТаблицыДанных Цикл
		
		ИмяКолонки = ?(ТекущаяКолонка.Имя = "К", "НовыеНомера.НовыйНомерУзла КАК К", "Т." + ТекущаяКолонка.Имя);
		
		ИменаКолонокТаблицыДанные = ИменаКолонокТаблицыДанные + ?(ИменаКолонокТаблицыДанные = "", "", ",
			|	") + ИмяКолонки;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("РазмерТаблицыДанных", РазмерТаблицыДанных);
	Запрос.УстановитьПараметр("КоличествоСтрокВТЗ",  ПараметрыРасчета.ОграниченияВыборки.КоличествоСтрокВТЗ);
	
	#КонецОбласти
	
	#Область Упорядочивание
	
	// Подготовим данные для упорядочивания записей.
	// Упорядочивание выполняется по полям ПериодПоступления, Период, Регистратор
	// Упорядочивание используется для сортировки узлов одной волны подграфа и для сортировки источников и приемников узла.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К КАК НомерУзла,
	|	%1 КАК ПериодПоступления,
	|	%2 КАК Период,
	|	%3 КАК Регистратор
	|ПОМЕСТИТЬ ВТДанныеДляУпорядочивания
	|ИЗ
	|	Данные КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПериодПоступления,
	|	Период,
	|	Регистратор";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ЕстьПериодПоступленияВДанных, "ЕСТЬNULL(Т.ПериодПоступления, ДАТАВРЕМЯ(1,1,1))", "ДАТАВРЕМЯ(1,1,1)"),
		?(ЕстьПериодВДанных, "ЕСТЬNULL(Т.Период, ДАТАВРЕМЯ(1,1,1))", "ДАТАВРЕМЯ(1,1,1)"),
		?(ЕстьРегистраторВДанных, "ЕСТЬNULL(Т.Регистратор, НЕОПРЕДЕЛЕНО)", "ДАТАВРЕМЯ(1,1,1)"));
	
	Запрос.Выполнить(); // создание ВТДанныеДляУпорядочивания
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	%1 КАК ЗначениеРазделителя,
	|	Т.ПериодПоступления КАК ПериодПоступления,
	|	Т.Период КАК Период,
	|	Т.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВТПоляУпорядочивания
	|ИЗ
	|	ВТДанныеДляУпорядочивания КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПериодПоступления,
	|	Период,
	|	Регистратор";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ЕстьПериодПоступленияВДанных,
			"НАЧАЛОПЕРИОДА(Т.ПериодПоступления, ДЕНЬ)",
			?(ЕстьПериодВДанных,
				"НАЧАЛОПЕРИОДА(Т.Период, ДЕНЬ)",
				"1")));
	
	Запрос.Выполнить(); // создание ВТПоляУпорядочивания
	
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ЗначениеРазделителя", // разделитель
		"", // ресурсы
		"ПериодПоступления, Период, Регистратор", // порядок
		"Порядок", // номер
		"ПериодПоступления, Период, Регистратор", // индекс
		"", // накопление
		Ложь); // не подбирать разделитель
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТПоляУпорядочивания");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			   КАК НомерУзла,
	|	ПоляУпорядочивания.Порядок КАК Порядок
	|ПОМЕСТИТЬ ВТПорядокУзлов
	|ИЗ
	|	ВТДанныеДляУпорядочивания КАК Т
	|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПоляУпорядочивания КАК ПоляУпорядочивания
	|		ПО Т.ПериодПоступления = ПоляУпорядочивания.ПериодПоступления
	|		 И Т.Период = ПоляУпорядочивания.Период
	|		 И Т.Регистратор = ПоляУпорядочивания.Регистратор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла";
	
	Запрос.Выполнить(); // создание ВТПорядокУзлов
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТДанныеДляУпорядочивания, ВТПоляУпорядочивания");
		
	#КонецОбласти
	
	#Область РазбиениеГрафаНаПодграфы
	
	// Выполним разбиение исходного графа данных на несвязанные между собой подграфы.
	// Каждый найденный подграф будет пронумерован от 0 до (количество подграфов - 1) в порядку убывания количества узлов в подграфе.
	// Т.е. подграф с номером 0 будет самым большим, а последние подграфы будут вырожденные (содержат по одному узлу).
	//
	// Разбиение выполняем следующим образов:
	// - для начала каждой вершине присваиваем номер подграфа, равный номеру самой вершины
	// - для каждой вершины i определяем номера подграфов всех ее источников и приемников
	// - если минимальный номер подграфов связанных вершин меньше, чем номер подграфа самой вершины i,
	//	 то присваиваем вершине i этот минимальный номер подграфа
	// - повторяем в цикле действия 2 и 3 до тех пор, пока на очередной итерации ни у одной вершины не изменится номер ее подграфа.
	// Т.е. минимальный номер вершины в каждом подграфе как-бы начинает "расползаться" по этому подграфу - от этой вершины
	// сначала "переходит" на смежные вершины, потом на их смежные вершины и т.д, пока не "займет" весь подграф.
	// В результате каждый подграф будет иметь свой уникальный номер, равный номеру минимальной вершины, входящий в него.
	// Затем сделаем сквозную нумерацию этих подграфов (как написано выше).
	// Например, есть исходный граф ((4-2-1-7) (6) (5-3)):
	// - найдем в нем три подграфа с условными номерами 1, 6 и 3
	// - затем присвоим им номера 0, 2 и 1 соответственно
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К КАК НомерУзла,
	|	Т.К КАК НомерПодграфа
	|ПОМЕСТИТЬ ВТУзлыПодграфов
	|ИЗ
	|	Данные КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Ключ КАК НомерУзла,
	|	Т.Источник КАК СвязанныйУзел,
	|	ИСТИНА КАК ЭтоИсточник
	|ПОМЕСТИТЬ ВТСвязиУзлов
	|ИЗ
	|	Источники КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Ключ,
	|	Т.Приемник,
	|	ЛОЖЬ
	|ИЗ
	|	Приемники КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СвязанныйУзел,
	|	ЭтоИсточник";
	
	Запрос.Выполнить(); // создание ВТУзлыПодграфов и ВТСвязиУзлов
	
	ЕстьИзменения 	   = Истина;
	КоличествоИтерацийПоискаПодграфов = 0;
	
	Пока ЕстьИзменения Цикл
		
		КоличествоИтерацийПоискаПодграфов = КоличествоИтерацийПоискаПодграфов + 1;
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СвязиУзлов.НомерУзла КАК НомерУзла,
		|	МИНИМУМ(Т.НомерПодграфа) КАК НомерПодграфа
		|ПОМЕСТИТЬ ВТПодграфыСвязанныхУзлов
		|ИЗ
		|	ВТУзлыПодграфов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСвязиУзлов КАК СвязиУзлов
		|		ПО Т.НомерУзла = СвязиУзлов.СвязанныйУзел
		|
		|СГРУППИРОВАТЬ ПО
		|	СвязиУзлов.НомерУзла
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.НомерУзла КАК НомерУзла,
		|	ПодграфыСвязанныхУзлов.НомерПодграфа КАК НомерПодграфа
		|ПОМЕСТИТЬ ВТИзмененныеПодграфы
		|ИЗ
		|	ВТУзлыПодграфов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфыСвязанныхУзлов КАК ПодграфыСвязанныхУзлов
		|		ПО Т.НомерУзла = ПодграфыСвязанныхУзлов.НомерУзла
		|ГДЕ
		|	ПодграфыСвязанныхУзлов.НомерПодграфа < Т.НомерПодграфа
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТПодграфыСвязанныхУзлов";
		
		Запрос.Выполнить(); // создание ВТИзмененныеПодграфы
		
		ЕстьИзменения = (УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТИзмененныеПодграфы") > 0);
		
		Если ЕстьИзменения Тогда
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	Т.НомерУзла,
			|	ВЫБОР КОГДА ИзмененныеПодграфы.НомерУзла ЕСТЬ NULL 
			|		ТОГДА Т.НомерПодграфа
			|		ИНАЧЕ ИзмененныеПодграфы.НомерПодграфа
			|	КОНЕЦ КАК НомерПодграфа
			|ПОМЕСТИТЬ ВТНовыеУзлыПодграфов
			|ИЗ
			|	ВТУзлыПодграфов КАК Т
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТИзмененныеПодграфы КАК ИзмененныеПодграфы
			|		ПО Т.НомерУзла = ИзмененныеПодграфы.НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТУзлыПодграфов
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.НомерПодграфа
			|ПОМЕСТИТЬ ВТУзлыПодграфов
			|ИЗ
			|	ВТНовыеУзлыПодграфов КАК Т
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТНовыеУзлыПодграфов";
			
			Запрос.Выполнить(); // обновление ВТУзлыПодграфов
			
		КонецЕсли;
		
		УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТИзмененныеПодграфы");
		
	КонецЦикла;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерПодграфа КАК НомерПодграфа,
	|	СУММА(1) КАК КоличествоУзлов,
	|	СУММА(1) КАК НовыйНомерПервогоУзлаПодграфа
	|ПОМЕСТИТЬ ВТПодграфы
	|ИЗ
	|	ВТУзлыПодграфов КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерПодграфа";
	
	Запрос.Выполнить(); // создание ВТПодграфы
	
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"", // разделитель
		"", // ресурсы
		"КоличествоУзлов УБЫВ, НомерПодграфа", // порядок
		"НовыйНомерПодграфа", // номер
		"НомерПодграфа", // индекс
		"НовыйНомерПервогоУзлаПодграфа"); // накопление
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТПодграфы");
	
	#КонецОбласти
	
	#Область ВолновойОбходГрафа
	
	// Для того, чтобы пронумеровать вершины графа от начальных (не имеющих входов) до конечных (не имеющих выходов),
	// необходимо для каждой вершины определить ее "удаленность" от начальной вершины.
	// Вершины с меньшей "удаленностью" от начальных должны иметь меньшие номера чем вершины с большей "удаленность".
	// Т.е. цепочки графа должен иметь вид 1->2->3->4, а не 2->4->1->3.
	// При соблюдении этого условию механизм расчета партий по цепочкам будет работать наиболее оптимальным образом.
	//
	// Для расчета удаленности вершин используем волновой метод:
	// - начальным вершинам присваиваем номер волны 1
	// - вершинам, в которые есть путь из начальных вершин - номер волны 2
	// - и т.д., пока не достигнем конечных вершин.
	// Если после этого останутся вершины, которым не присвоен номер волны,
	// значит эти вершины образуют цикл, в который нет пути из начальных вершин.
	// Обрабатываем такие циклы следующим образом:
	// - выбираем произвольную вершину, принадлежащую этому циклу
	// - присваиваем ей очередной номер волны N и от нее продолжаем обход оставшихся вершин
	// В результате всем вершинам исходного графа будет присвоен некий номер волны.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла КАК НомерУзла,
	|	Т.КоличествоПриемников КАК КоличествоПриемников,
	|	Т.КоличествоИсточников КАК КоличествоИсточников,
	|	ВЫБОР
	|		КОГДА Т.КоличествоПриемников = 0 И Т.КоличествоИсточников = 0
	|			ТОГДА &РазмерТаблицыДанных
	|		КОГДА Т.КоличествоИсточников = 0
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НомерВолны
	|ПОМЕСТИТЬ ВТОписаниеУзлов
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.НомерУзла КАК НомерУзла,
	|		СУММА(Т.КоличествоПриемников) КАК КоличествоПриемников,
	|		СУММА(Т.КоличествоИсточников) КАК КоличествоИсточников
	|	ИЗ
	|		(ВЫБРАТЬ
	|			Т.НомерУзла КАК НомерУзла,
	|			КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Приемники.Приемник) КАК КоличествоПриемников,
	|			0 КАК КоличествоИсточников
	|		ИЗ
	|			ВТУзлыПодграфов КАК Т
	|				ЛЕВОЕ СОЕДИНЕНИЕ Приемники КАК Приемники
	|				ПО Т.НомерУзла = Приемники.Ключ
	|		
	|		СГРУППИРОВАТЬ ПО
	|			Т.НомерУзла
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			Т.НомерУзла,
	|			0,
	|			КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Источники.Источник)
	|		ИЗ
	|			ВТУзлыПодграфов КАК Т
	|				ЛЕВОЕ СОЕДИНЕНИЕ Источники КАК Источники
	|				ПО Т.НомерУзла = Источники.Ключ
	|		
	|		СГРУППИРОВАТЬ ПО
	|			Т.НомерУзла) КАК Т
	|	
	|	СГРУППИРОВАТЬ ПО
	|		Т.НомерУзла) КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла";
	
	Запрос.Выполнить(); // создание ВТОписаниеУзлов
	
	ЕстьИзменения 	    = Истина;
	НомерВолны    	    = 1;
	НомерВолныДляЦиклов = 0;
	
	Пока ЕстьИзменения Цикл
		
		НомерВолны = НомерВолны + 1;
		Запрос.УстановитьПараметр("НомерВолны", НомерВолны);
		
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Приемники.Приемник КАК НомерУзла
		|ПОМЕСТИТЬ ВТИзменениеОписанияУзлов
		|ИЗ
		|	ВТОписаниеУзлов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Приемники КАК Приемники
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзловПриемников
		|			ПО Приемники.Приемник = ОписаниеУзловПриемников.НомерУзла
		|				И (ОписаниеУзловПриемников.НомерВолны = 0)
		|		ПО Т.НомерУзла = Приемники.Ключ
		|ГДЕ
		|	Т.НомерВолны = &НомерВолны - 1
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла";
		
		Запрос.Выполнить(); // создание ВТИзменениеОписанияУзлов
		
		ЕстьИзменения = (УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТИзменениеОписанияУзлов") > 0);
		
		Если НЕ ЕстьИзменения Тогда
			
			// Может получиться, что некоторые узла обойти не удалось - эти узлы могут располагаться в циклах, в которые нет пути из начальных вершин ( с номером волны = 1).
			// В этом случае из цикла берем вершину с минимальным номером и минимальным количеством исходящих дуг и продолжаем обход из нее.
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(*) КАК КоличествоУзловВЦиклах
			|ИЗ
			|	ВТОписаниеУзлов КАК Т
			|ГДЕ
			|	Т.НомерВолны = 0
			|";
			
			Выборка = Запрос.Выполнить().Выбрать();
			Выборка.Следующий();
			
			ЕстьИзменения = (Выборка.КоличествоУзловВЦиклах > 0); // если Ложь, то обход графа полностью завершен
				
			Если ЕстьИзменения Тогда
				
				НомерВолныДляЦиклов = ?(ЗначениеЗаполнено(НомерВолныДляЦиклов), НомерВолныДляЦиклов, НомерВолны);
				
				Запрос.Текст =
				"ВЫБРАТЬ
				|	Т.НомерПодграфа КАК НомерПодграфа,
				|	Т.НомерУзла,
				|	ОписаниеУзлов.КоличествоПриемников КАК КоличествоПриемников
				|ПОМЕСТИТЬ ВТУзлыДляОбхода
				|ИЗ
				|	ВТУзлыПодграфов КАК Т
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзлов
				|		ПО Т.НомерУзла = ОписаниеУзлов.НомерУзла
				|ГДЕ
				|	ОписаниеУзлов.НомерВолны = 0
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерПодграфа,
				|	КоличествоПриемников
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Т.НомерПодграфа КАК НомерПодграфа,
				|	МИНИМУМ(Т.КоличествоПриемников) КАК КоличествоПриемников
				|ПОМЕСТИТЬ ВТПодграфыДляОбхода
				|ИЗ
				|	ВТУзлыДляОбхода КАК Т
				|
				|СГРУППИРОВАТЬ ПО
				|	Т.НомерПодграфа
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерПодграфа,
				|	КоличествоПриемников
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТИзменениеОписанияУзлов
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТУзлыДляОбхода.НомерПодграфа,
				|	МИНИМУМ(ВТУзлыДляОбхода.НомерУзла) КАК НомерУзла
				|ПОМЕСТИТЬ ВТИзменениеОписанияУзлов
				|ИЗ
				|	ВТУзлыДляОбхода КАК ВТУзлыДляОбхода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфыДляОбхода КАК ВТПодграфыДляОбхода
				|		ПО ВТУзлыДляОбхода.НомерПодграфа = ВТПодграфыДляОбхода.НомерПодграфа
				|			И ВТУзлыДляОбхода.КоличествоПриемников = ВТПодграфыДляОбхода.КоличествоПриемников
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТУзлыДляОбхода.НомерПодграфа
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерУзла";
				
				Запрос.Выполнить(); // создание ВТИзменениеОписанияУзлов
				
				УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТУзлыДляОбхода, ВТПодграфыДляОбхода");
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЕстьИзменения Тогда
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.КоличествоПриемников,
			|	Т.КоличествоИсточников,
			|	ВЫБОР КОГДА ИзменениеОписанияУзлов.НомерУзла ЕСТЬ NULL 
			|		ТОГДА Т.НомерВолны
			|		ИНАЧЕ &НомерВолны
			|	КОНЕЦ КАК НомерВолны
			|ПОМЕСТИТЬ ВТНовоеОписаниеУзлов
			|ИЗ
			|	ВТОписаниеУзлов КАК Т
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТИзменениеОписанияУзлов КАК ИзменениеОписанияУзлов
			|		ПО Т.НомерУзла = ИзменениеОписанияУзлов.НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТОписаниеУзлов
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.КоличествоПриемников,
			|	Т.КоличествоИсточников,
			|	Т.НомерВолны
			|ПОМЕСТИТЬ ВТОписаниеУзлов
			|ИЗ
			|	ВТНовоеОписаниеУзлов КАК Т
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТНовоеОписаниеУзлов";
			
			Запрос.Выполнить(); // обновление ВТОписаниеУзлов
			
		КонецЕсли;
		
		УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТИзменениеОписанияУзлов");
			
	КонецЦикла;
	
	#КонецОбласти
	
	#Область РасчетНовыхНомеровУзлов
	
	// Рассчитаем новые номера вершин исходного графа:
	// - упорядочим все вершины
	// - обойдем получившийся результат и последовательно пронумеруем вершины от 0 до (количество вершин - 1)
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Подграфы.НовыйНомерПервогоУзлаПодграфа / &КоличествоСтрокВТЗ КАК ЧИСЛО(15,0)) КАК ЗначениеРазделителя,
	|	Подграфы.НомерПодграфа 			КАК НомерПодграфа,
	|	Подграфы.НовыйНомерПодграфа 	КАК НовыйНомерПодграфа,
	|	Т.НомерВолны 					КАК НомерВолны,
	|	Т.НомерУзла 					КАК НомерУзла,
	|	Т.НомерУзла 					КАК НовыйНомерУзла,
	|	ПорядокУзлов.Порядок 			КАК Порядок
	|ПОМЕСТИТЬ ВТНовыеНомераУзлов
	|ИЗ
	|	ВТОписаниеУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыПодграфов КАК УзлыПодграфов
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфы КАК Подграфы
	|			ПО УзлыПодграфов.НомерПодграфа = Подграфы.НомерПодграфа
	|		ПО Т.НомерУзла = УзлыПодграфов.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.НомерУзла = ПорядокУзлов.НомерУзла";
	
	Запрос.Выполнить(); // создание ВТНовыеНомераУзлов
	
	ПараметрыНумерации = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ЗначениеРазделителя", // разделитель
		"", // ресурсы
		"НовыйНомерПодграфа, НомерВолны, Порядок, НомерУзла", // порядок
		"НовыйНомерУзла", // номер
		"НомерУзла", // индекс
		"", // накопление
		Ложь); // не подбирать разделитель
	
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТНовыеНомераУзлов");
		
	#КонецОбласти
	
	#Область ИзменениеНумерацииВТаблицах
	
	// Заменим старые номера вершин на новые в служебных временных таблицах Данные, Источники, Приемники.
	// В таблицах Источники и Приемники заполним поле Порядок.
	// Это поле относятся к колонкам "Источник" и "Приемник" и предназначено для их сортировки по ФИФО.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			 КАК Ключ,
	|	Т.СвязанныйУзел 		 КАК Источник,
	|	ПорядокУзлов.Порядок 	 КАК Порядок
	|ПОМЕСТИТЬ Источники_Временная
	|ИЗ
	|	ВТСвязиУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.СвязанныйУзел = ПорядокУзлов.НомерУзла
	|			И Т.ЭтоИсточник = ИСТИНА
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеНомераКлючей.НовыйНомерУзла 	 КАК Ключ,
	|	НовыеНомераИсточников.НовыйНомерУзла КАК Источник,
	|	Т.Порядок 				 			 КАК Порядок
	|ПОМЕСТИТЬ Источники
	|ИЗ
	|	Источники_Временная КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераКлючей
	|		ПО Т.Ключ = НовыеНомераКлючей.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераИсточников
	|		ПО Т.Источник = НовыеНомераИсточников.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источники_Временная";
	
	Запрос.Выполнить(); // обновление Источники
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			 КАК Ключ,
	|	Т.СвязанныйУзел 		 КАК Приемник,
	|	ПорядокУзлов.Порядок 	 КАК Порядок
	|ПОМЕСТИТЬ Приемники_Временная
	|ИЗ
	|	ВТСвязиУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.СвязанныйУзел = ПорядокУзлов.НомерУзла
	|			И (Т.ЭтоИсточник = ЛОЖЬ)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Приемники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеНомераКлючей.НовыйНомерУзла 	 КАК Ключ,
	|	НовыеНомераПриемников.НовыйНомерУзла КАК Приемник,
	|	Т.Порядок 				 			 КАК Порядок
	|ПОМЕСТИТЬ Приемники
	|ИЗ
	|	Приемники_Временная КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераКлючей
	|		ПО Т.Ключ = НовыеНомераКлючей.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераПриемников
	|		ПО Т.Приемник = НовыеНомераПриемников.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Приемники_Временная";
	
	Запрос.Выполнить(); // обновление Приемники
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА КАК ЕстьРазличия
	|ИЗ
	|	ВТНовыеНомераУзлов КАК Т
	|ГДЕ
	|	Т.НомерУзла <> Т.НовыйНомерУзла";
	
	ЕстьИзменения = НЕ Запрос.Выполнить().Пустой();
	
	Если ЕстьИзменения Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ Данные_Временная
		|ИЗ
		|	Данные КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	%1
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	Данные_Временная КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомера
		|		ПО Т.К = НовыеНомера.НомерУзла
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	К
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные_Временная";
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Запрос.Текст, ИменаКолонокТаблицыДанные);
		
		Запрос.Выполнить(); // обновление Данные
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ФормированиеСтатистикиГрафа
	
	// Создадим новые служебные таблицы ОписаниеПодграфов и ОписаниеУзловПодграфов.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НовыйНомерУзла 					КАК НомерУзла,
	|	Т.НовыйНомерПодграфа 				КАК НомерПодграфа,
	|	Т.НомерВолны 						КАК НомерВолны,
	|	Т.Порядок							КАК Порядок,
	|	ОписаниеУзлов.КоличествоПриемников 	КАК КоличествоПриемников,
	|	ОписаниеУзлов.КоличествоИсточников 	КАК КоличествоИсточников
	|ПОМЕСТИТЬ ОписаниеУзловПодграфов
	|ИЗ
	|	ВТНовыеНомераУзлов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзлов
	|		ПО Т.НомерУзла = ОписаниеУзлов.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.НомерПодграфа 					КАК НомерПодграфа,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НомерВолны) 	КАК КоличествоВолн,
	|	СУММА(Т.КоличествоИсточников) 		КАК КоличествоСвязей,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НомерУзла) 	КАК КоличествоУзлов,
	|	МИНИМУМ(Т.НомерУзла) 				КАК МинимальныйНомерУзла,
	|	МАКСИМУМ(Т.НомерУзла) 				КАК МаксимальныйНомерУзла,
	|	МАКСИМУМ(Т.КоличествоПриемников) 	КАК МаксимумПриемниковУзла,
	|	МАКСИМУМ(Т.КоличествоИсточников) 	КАК МаксимумИсточниковУзла
	|ПОМЕСТИТЬ ОписаниеПодграфов
	|ИЗ
	|	ОписаниеУзловПодграфов КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерПодграфа
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерПодграфа";
	
	Запрос.Выполнить(); // создание ОписаниеУзловПодграфов и ОписаниеПодграфов
	
	// Выведем в протокол подробное описание графа.
	
	ОписаниеГрафа = НСтр("ru='Описание цепочек (графа) для расчета:
	|	узлов - %01; дуг - %02; макс. исходящих дуг - %03; макс. входящих дуг - %04;
	|	содержит несвязанных подграфов - %05, в т.ч. вырожденных (из одного узла) - %06;
	|	макс. узлов в одном подграфе - %07; макс. дуг в одном подграфе - %08;
	|	выполнено итераций поиска подграфов - %09, итераций нумерации - %10, в т.ч. из-за циклов - %11'");
	
	Запрос.УстановитьПараметр("КоличествоИтерацийПоискаПодграфов", 	   КоличествоИтерацийПоискаПодграфов);
	Запрос.УстановитьПараметр("КоличествоИтерацийНумерации", 	   	   НомерВолны - 1);
	Запрос.УстановитьПараметр("КоличествоИтерацийНумерацииИзЗаЦиклов", ?(ЗначениеЗаполнено(НомерВолныДляЦиклов), НомерВолны - НомерВолныДляЦиклов, 0));
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	1 						 КАК НомерПараметра,
	|	СУММА(Т.КоличествоУзлов) КАК ЗначениеПараметра
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	СУММА(Т.КоличествоСвязей)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	МАКСИМУМ(Т.МаксимумПриемниковУзла)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	МАКСИМУМ(Т.МаксимумИсточниковУзла)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	КОЛИЧЕСТВО(*)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	6,
	|	КОЛИЧЕСТВО(*)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|ГДЕ
	|	Т.КоличествоУзлов = 1
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	7,
	|	МАКСИМУМ(Т.КоличествоУзлов)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	8,
	|	МАКСИМУМ(Т.КоличествоСвязей)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	9,
	|	&КоличествоИтерацийПоискаПодграфов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	10,
	|	&КоличествоИтерацийНумерации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	11,
	|	&КоличествоИтерацийНумерацииИзЗаЦиклов
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерПараметра";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ОписаниеГрафа = СтрЗаменить(
			ОписаниеГрафа,
			"%" + Формат(Выборка.НомерПараметра, "ЧЦ=2; ЧВН="),
			ПротоколРасчетаПартийИСебестоимости.ПредставлениеЗначения(Выборка.ЗначениеПараметра));
	КонецЦикла;
	
	ПараметрыРасчета.РаспределениеПартий.Вставить("ОписаниеГрафа", ОписаниеГрафа);
	
	ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(ПараметрыРасчета, ОписаниеГрафа);
	
	#КонецОбласти
	
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	УниверсальныеМеханизмыПартийИСебестоимости.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТПорядокУзлов, ВТУзлыПодграфов, ВТСвязиУзлов, ВТПодграфы, ВТОписаниеУзлов, ВТНовыеНомераУзлов");
	
КонецПроцедуры

#КонецОбласти

#Область РасчетПартийПоЦепочкам

Процедура РассчитатьПартииПоЦепочкам(ПараметрыРасчета)
	
	ПараметрыРасчета.РаспределениеПартий.Вставить("КоличествоСтрокДанных",
		УниверсальныеМеханизмыПартийИСебестоимости.РазмерВременнойТаблицы(ПараметрыРасчета, "Данные"));
		
	Если ПараметрыРасчета.РаспределениеПартий.КоличествоСтрокДанных = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ОписаниеДвижений = ПараметрыРасчета.РаспределениеПартий.ОписаниеДвижений;
	ЕстьСторно = ОписаниеДвижений.Свойство("ЕстьСторно");
	
	// Разделим подграфы на группы - в одну группу целиком входит один или несколько подграфов.
	// После расчета группы подграфов вспомогательную структуру Данные можно очистить, т.к. следующие группы эти данные не используют.
	
	ПараметрыРазделения = УниверсальныеМеханизмыПартийИСебестоимости.СформироватьПараметрыРазделенияВременнойТаблицыНаПорции(
		ПараметрыРасчета.ОграниченияВыборки.ПорцияРасчетаПартий,
		"КоличествоУзлов", "МинимальныйНомерУзла");
	
	ПротоколРасчетаПартийИСебестоимости.НачалоФормированиеВременнойТаблицы(
		ПараметрыРасчета,
		"ОписаниеПодграфов",
		НСтр("ru='(разделение на порции для расчета цепочек)'"));
	
	УниверсальныеМеханизмыПартийИСебестоимости.РазделитьВременнуюТаблицуНаПорции(
		ПараметрыРасчета,
		ПараметрыРазделения,
		"ОписаниеПодграфов");
		
	ПротоколРасчетаПартийИСебестоимости.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерПорции,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НомерПодграфа) КАК КоличествоПодграфов,
	|	МИНИМУМ(Т.МинимальныйНомерУзла) КАК МинимальныйНомерУзла,
	|	МАКСИМУМ(Т.МаксимальныйНомерУзла) КАК МаксимальныйНомерУзла
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерПорции
	|
	|УПОРЯДОЧИТЬ ПО
	|	Т.НомерПорции";
	
	ВыборкаГруппаПодграфов = Запрос.Выполнить().Выбрать();
	
	// Подготовим текст запроса выборки порций данных.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ИЗ
	|	Данные КАК ДД
	|ГДЕ
	|	ДД.К >= &НачальнаяЦепочка
	|	И ДД.К <= &КонечнаяЦепочка
	|УПОРЯДОЧИТЬ ПО
	|	ДД.К";
	
	ИнициализироватьЗамерРаспределенияПартий(ПараметрыРасчета);
	
	Пока ВыборкаГруппаПодграфов.Следующий() Цикл
		
		НачалоЗамераРасчетаГруппыПодграфов(ПараметрыРасчета, ВыборкаГруппаПодграфов);
		
		Данные = Новый Структура;
		Данные.Вставить("ЦепочкиДвижений", Новый Соответствие);
		Данные.Вставить("СтрокиЦепочек",   Новый ТаблицаЗначений);
		Данные.Вставить("Приходы", 		   Новый Соответствие); // буфер копий партий для покрытия расходов
		Данные.Вставить("Расходы", 		   Новый Соответствие); // буфер не рассчитанных партий для расчета на следующих итерациях
		Данные.Вставить("СтрокиПриходов",  ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии.СкопироватьКолонки());
		Данные.Вставить("СтрокиРасходов",  Данные.СтрокиПриходов.СкопироватьКолонки());
		Данные.Вставить("ИндексыРасходов", Новый Массив);
		Данные.Вставить("ПройденныйПуть",  Новый Соответствие); // используется для прерывания циклов
		Данные.Вставить("ИндексСтроки",    Неопределено);
		
		ИндексСтроки    = ВыборкаГруппаПодграфов.МинимальныйНомерУзла - 1;
		КонечнаяЦепочка = ИндексСтроки;
		
		Пока ИндексСтроки < ВыборкаГруппаПодграфов.МаксимальныйНомерУзла Цикл
			
			ИндексСтроки = ИндексСтроки + 1;
			
			Если ИндексСтроки > КонечнаяЦепочка Тогда
				
				// Прочитаем следующую порцию данных.
				НачальнаяЦепочка = КонечнаяЦепочка + 1;
				КонечнаяЦепочка  = Мин(
					КонечнаяЦепочка + ПараметрыРасчета.ОграниченияВыборки.ПорцияРасчетаПартий,
					ВыборкаГруппаПодграфов.МаксимальныйНомерУзла);
				
				Запрос.УстановитьПараметр("НачальнаяЦепочка", НачальнаяЦепочка);
				Запрос.УстановитьПараметр("КонечнаяЦепочка",  КонечнаяЦепочка);
				
				Выборка = Запрос.Выполнить().Выбрать();
				
				ЦепочкиДвиженийПоИндексу(ПараметрыРасчета, Данные, НачальнаяЦепочка, КонечнаяЦепочка);
				
			КонецЕсли;
			
			Если НЕ Выборка.Следующий() ИЛИ Выборка.К <> ИндексСтроки Тогда
				ВызватьИсключение НСтр("ru='Ошибка в данных для расчета партий'");
			КонецЕсли;
			
			ЦепочкаДвижений = Данные.ЦепочкиДвижений[ИндексСтроки];
			
			Если ЦепочкаДвижений = Неопределено Тогда
				
				ДобавитьРасчетнуюПартию(ПараметрыРасчета, Выборка);
				
			ИначеЕсли Выборка.РасчетЗавершен Тогда
				
				РасчетнаяПартия = ДобавитьРасчетнуюПартию(ПараметрыРасчета, Выборка);
				
				Если ЦепочкаДвижений.Приемники.Количество() > 0 Тогда
					
					Приход = Данные.СтрокиПриходов.Добавить();
					ЗаполнитьЗначенияСвойств(Приход, РасчетнаяПартия);
					
					ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели,
						Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно
						ИЛИ ЕстьСторно И Приход.Сторно);
						
					Данные.Приходы.Вставить(ИндексСтроки, Новый Массив);
					Данные.Приходы[ИндексСтроки].Добавить(Приход);
					
				КонецЕсли;
				
				Данные.ЦепочкиДвижений.Удалить(ИндексСтроки);
				Данные.СтрокиЦепочек.Удалить(ЦепочкаДвижений);
				РасчетнаяПартия = Неопределено;
				
			Иначе
				
				Расход = Данные.СтрокиРасходов.Добавить();
				ЗаполнитьЗначенияСвойств(Расход, Выборка);
				
				Данные.Расходы.Вставить(ИндексСтроки, Расход);
				Данные.ИндексыРасходов.Добавить(ИндексСтроки);
				
			КонецЕсли;
			
			Если ИндексСтроки = ВыборкаГруппаПодграфов.МаксимальныйНомерУзла // последняя итерация цикла
			 ИЛИ (ИндексСтроки - ВыборкаГруппаПодграфов.МинимальныйНомерУзла > 0 // не первая итерация цикла
			 	И (ИндексСтроки - ВыборкаГруппаПодграфов.МинимальныйНомерУзла) % ПараметрыРасчета.ОграниченияВыборки.ПорцияРасчетаПартий = 0) Тогда
				
				Данные.ИндексСтроки = ИндексСтроки;
				
				Если Данные.Приходы.Количество() > 0  // есть записи по которым расчет завершен
				 ИЛИ ИндексСтроки = ВыборкаГруппаПодграфов.МаксимальныйНомерУзла Тогда
					
					Пока Данные.ИндексыРасходов.Количество() > 0 Цикл
						ИндексРасхода = Данные.ИндексыРасходов.Получить(0);
						Данные.ИндексыРасходов.Удалить(0);
						Если Данные.Расходы[ИндексРасхода] = Неопределено Тогда
							Продолжить; // строка к обсчету НЕ зарегистрирована
						КонецЕсли;
						Данные.ПройденныйПуть.Очистить();
						РассчитатьПартиюПоЦепочкеИзВыборки(ПараметрыРасчета, Данные, ИндексРасхода);
					КонецЦикла;
					
				КонецЕсли;
				
				Если ИндексСтроки < ВыборкаГруппаПодграфов.МаксимальныйНомерУзла Тогда
					
					Для Каждого Строка Из Данные.Расходы Цикл
						Данные.ИндексыРасходов.Добавить(Строка.Ключ);
					КонецЦикла;
					
					Список = Новый СписокЗначений;
					Список.ЗагрузитьЗначения(Данные.ИндексыРасходов);
					Список.СортироватьПоЗначению();
					Данные.ИндексыРасходов = Список.ВыгрузитьЗначения();
					
				Иначе
					
					Для Каждого Строка Из Данные.Расходы Цикл
						ДобавитьРасчетнуюПартию(ПараметрыРасчета, Строка.Значение);
					КонецЦикла;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Данные.Приходы.Очистить();
		Данные.Расходы.Очистить();
		Данные.ЦепочкиДвижений.Очистить();
		Данные.СтрокиПриходов.Очистить();
		Данные.СтрокиРасходов.Очистить();
		Данные.СтрокиЦепочек.Очистить();
		Данные = Неопределено;
		
	КонецЦикла;
	
	ЗавершитьЗамерРаспределенияПартий(ПараметрыРасчета);
	
КонецПроцедуры

Функция РассчитатьПартиюПоЦепочкеИзВыборки(ПараметрыРасчета, Данные, ИндексРасхода)
	
	НачалоЗамераРасчетаЦепочек(ПараметрыРасчета);
	
	ОписаниеДвижений = ПараметрыРасчета.РаспределениеПартий.ОписаниеДвижений;
	
	ЦепочкаРасхода = Данные.ЦепочкиДвижений[ИндексРасхода];
	Если ЦепочкаРасхода = Неопределено Тогда
		Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, "НеТребуется");
	КонецЕсли;
	
	Источники = ЦепочкаРасхода.Источники;
	ЕстьЗацикливание = Ложь;
	Если ИндексРасхода = Данные.ПройденныйПуть[ИндексРасхода] Или (Источники.Количество() = 0) Тогда
		ЕстьЗацикливание = Истина;
	КонецЕсли;
	
	ИндексСтроки = Данные.ИндексСтроки;
	Для Каждого ИндексПрихода Из Источники Цикл
		Если ИндексПрихода > ИндексСтроки Тогда
			Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, "НетДанных"); // еще нет всех строк для распределения
		КонецЕсли;
	КонецЦикла;
	
	Данные.ПройденныйПуть.Вставить(ИндексРасхода, ИндексРасхода);
	
	НовыеПриходы = Неопределено;
	
	Расход = Данные.Расходы[ИндексРасхода];
	ЕстьСторно = ОписаниеДвижений.Свойство("ЕстьСторно");
	ЭтоСторно = (Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно ИЛИ ЕстьСторно И Расход.Сторно);
	
	ТребуетсяСортировка = Ложь;
	Если ЗначениеЗаполнено(ОписаниеДвижений.ПоляСортировки) Тогда
		
		ЗначенияПолей = Новый Структура(ОписаниеДвижений.ПоляСортировки);
		ЗаполнитьЗначенияСвойств(ЗначенияПолей, Расход);
		
		Для Каждого ПолеСортировки Из ЗначенияПолей Цикл
			Если ЗначениеЗаполнено(ПолеСортировки.Значение) Тогда
				ТребуетсяСортировка = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	БазисПрихода = 0;
	Если ОписаниеДвижений.Свойство("ПоляГруппировки") ИЛИ ЭтоСторно ИЛИ ТребуетсяСортировка Тогда
		
		Для Каждого ИндексИсточника Из Источники Цикл
			Если НЕ ЕстьЗацикливание
			 И Данные.Приходы[ИндексИсточника] = Неопределено
			 И Данные.Расходы[ИндексИсточника] <> Неопределено Тогда // данный источник еще не рассчитан
				Результат = РассчитатьПартиюПоЦепочкеИзВыборки(ПараметрыРасчета, Данные, ИндексИсточника);
				Если Результат = "НетДанных" Тогда
					Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, Результат); // еще нет всех строк для распределения
				ИначеЕсли Результат = "Зацикливание" Тогда
					БазисПрихода = БазисПрихода + Данные.Расходы[ИндексИсточника][ОписаниеДвижений.БазисПрихода];
				КонецЕсли;
				Если Данные.Расходы[ИндексРасхода] = Неопределено Тогда
					Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, "НеТребуется");
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		Если ЭтоСторно Тогда
			СортироватьИсточники(Источники, ОписаниеДвижений.ПолеПорядка, Данные.Приходы);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ТребуетсяСортировка Тогда
		СортироватьИсточникиПоЗначениямПолей(Источники, ЗначенияПолей, Данные.Приходы);
	КонецЕсли;
	
	Счетчик = 0;
	ВГраница = Источники.ВГраница();
	
	ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели, ЭтоСторно);
	
	Пока Счетчик <= ВГраница Цикл
		
		ИндексИсточника = Источники[?(ЭтоСторно, ВГраница - Счетчик, Счетчик)];
		Счетчик = Счетчик + 1;
		
		МассивПриходов = Данные.Приходы[ИндексИсточника];
		Если МассивПриходов = Неопределено Тогда
			
			Если Данные.Расходы[ИндексИсточника] = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Источник = Данные.Расходы[ИндексИсточника];
			Если НЕ ЕстьЗацикливание И НЕ Источник.РасчетЗавершен Тогда
				Результат = РассчитатьПартиюПоЦепочкеИзВыборки(ПараметрыРасчета, Данные, ИндексИсточника);
				ВГраница = Источники.ВГраница();
				Если Данные.Расходы[ИндексРасхода] = Неопределено Тогда
					Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, "НеТребуется");
				КонецЕсли;
				МассивПриходов = Данные.Приходы[ИндексИсточника];
				Если МассивПриходов = Неопределено Тогда
					Продолжить;
				КонецЕсли;
			Иначе
				МассивПриходов = Данные.Приходы[ИндексИсточника];
				Если МассивПриходов = Неопределено Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЭтоСторно Тогда
			СортироватьПриходыПоЛИФО(ОписаниеДвижений.ПолеПорядка, МассивПриходов);
		КонецЕсли;
		
		ПриходыКУдалению = Новый Массив;
		
		Для Каждого Приход Из МассивПриходов Цикл
			
			РасчетнаяПартия = ДобавитьИЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Расход, Приход, ЭтоСторно);
			
			Если Приход[ОписаниеДвижений.БазисПрихода] <= 0 Тогда
				ПриходыКУдалению.Добавить(Приход);
			КонецЕсли;
			
			Если РасчетнаяПартия.РасчетЗавершен Тогда
				Если ЦепочкаРасхода.Приемники.Количество() > 0 Тогда
					Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
						
						Если НовыеПриходы = Неопределено Тогда
							НовыеПриходы = Данные.СтрокиПриходов.СкопироватьКолонки();
						КонецЕсли;
						НовыйПриход = НовыеПриходы.Добавить();
						ЗаполнитьЗначенияСвойств(НовыйПриход, РасчетнаяПартия);
						ИнвертироватьПоказатели(НовыйПриход, ОписаниеДвижений.Показатели,
							НовыйПриход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно
							ИЛИ ЕстьСторно И НовыйПриход.Сторно);
						
					Иначе
						
						НовыйПриход = Данные.СтрокиПриходов.Добавить();
						ЗаполнитьЗначенияСвойств(НовыйПриход, РасчетнаяПартия);
						ИнвертироватьПоказатели(НовыйПриход, ОписаниеДвижений.Показатели,
							НовыйПриход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно
							ИЛИ ЕстьСторно И НовыйПриход.Сторно);
						
						Если Данные.Приходы[ИндексРасхода] = Неопределено Тогда
							Данные.Приходы.Вставить(ИндексРасхода, Новый Массив);
						КонецЕсли;
						
						Данные.Приходы[ИндексРасхода].Добавить(НовыйПриход);
						
					КонецЕсли;
				КонецЕсли;
			Иначе
				УдалитьРасчетнуюПартию(ПараметрыРасчета, РасчетнаяПартия);
			КонецЕсли;
			
			РасчетнаяПартия = Неопределено;
			
			Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
				Если Расход.Знаменатель <= 0 Тогда
					Прервать;
				КонецЕсли;
			ИначеЕсли Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		Для Каждого Приход Из ПриходыКУдалению Цикл
			Индекс = МассивПриходов.Найти(Приход);
			Если Индекс <> Неопределено Тогда
				МассивПриходов.Удалить(Индекс);
			КонецЕсли;
			Данные.СтрокиПриходов.Удалить(Приход);
		КонецЦикла;
		
		Если МассивПриходов.Количество() = 0 Тогда
			
			Данные.Приходы.Удалить(ИндексИсточника);
			
			Если Данные.Расходы[ИндексИсточника] = Неопределено Тогда
				ЦепочкаПрихода = Данные.ЦепочкиДвижений[ИндексИсточника];
				Если ЦепочкаПрихода <> Неопределено Тогда
					Данные.ЦепочкиДвижений.Удалить(ИндексИсточника);
					Данные.СтрокиЦепочек.Удалить(ЦепочкаПрихода);
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли ПриходыКУдалению.Количество() > 0 Тогда
			Данные.Приходы.Вставить(ИндексИсточника, МассивПриходов);
		КонецЕсли;
		
		Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии Тогда
			Если Расход.Знаменатель <= 0 Тогда
				Прервать;
			КонецЕсли;
		ИначеЕсли Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ОписаниеДвижений.Свойство("ПоляГруппировки")
	 И НовыеПриходы <> Неопределено
	 И НовыеПриходы.Количество() > 0 Тогда
		
		НовыеПриходы.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
		
		Если Данные.Приходы[ИндексРасхода] = Неопределено Тогда
			Данные.Приходы.Вставить(ИндексРасхода, Новый Массив);
		КонецЕсли;
		
		Для Каждого Строка Из НовыеПриходы Цикл
			НовыйПриход = Данные.СтрокиПриходов.Добавить();
			ЗаполнитьЗначенияСвойств(НовыйПриход, Строка);
			Данные.Приходы[ИндексРасхода].Добавить(НовыйПриход);
		КонецЦикла;
		
		НовыеПриходы = Неопределено;
		
	КонецЕсли;
	
	Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
		Если Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
			ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно
			ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПеремещениеАвто Тогда
			Расход[ОписаниеДвижений.БазисРасхода] = БазисПрихода;
		 Иначе
			Расход[ОписаниеДвижений.БазисРасхода] = 0;
		КонецЕсли;
	КонецЕсли;
	
	Если Расход[ОписаниеДвижений.БазисРасхода] > 0
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии И Расход.Знаменатель > 0 Тогда
		
		ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели, ЭтоСторно);
		
	Иначе
		
		Данные.Расходы.Удалить(ИндексРасхода);
		Данные.ЦепочкиДвижений.Удалить(ИндексРасхода);
		Данные.СтрокиРасходов.Удалить(Расход);
		Данные.СтрокиЦепочек.Удалить(ЦепочкаРасхода);
		
	КонецЕсли;
	
	Возврат ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, "Выполнено");
	
КонецФункции

Процедура ЦепочкиДвиженийПоИндексу(ПараметрыРасчета, Данные, НачальныйИндекс, КонечныйИндекс)
	
	Колонки = Данные.СтрокиЦепочек.Колонки;
	Если Колонки.Количество() = 0 Тогда
		Колонки.Добавить("Источники", 	   Новый ОписаниеТипов("Массив"));
		Колонки.Добавить("Приемники", 	   Новый ОписаниеТипов("Массив"));
		Колонки.Добавить("ПройденныйПуть", Новый ОписаниеТипов("Соответствие"));
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("НачальныйИндекс", НачальныйИндекс);
	Запрос.УстановитьПараметр("КонечныйИндекс",  КонечныйИндекс);
	
	ТаблицыСвязейУзлов = Новый Структура;
	ТаблицыСвязейУзлов.Вставить("Источники", "Источник");
	ТаблицыСвязейУзлов.Вставить("Приемники", "Приемник");
	
	// Для упорядочивания источников и приемников ключа по ФИФО в соответствующих таблицах есть поля Период и Регистратор.
	ШаблонЗапроса =
	"ВЫБРАТЬ
	|	ДД.Ключ КАК Ключ,
	|	ДД.%2 КАК %2
	|ИЗ
	|	%1 КАК ДД
	|ГДЕ
	|	ДД.Ключ >= &НачальныйИндекс
	|	И ДД.Ключ <= &КонечныйИндекс
	|	И ДД.Ключ <> ДД.%2
	|	
	|УПОРЯДОЧИТЬ ПО
	|	Ключ,
	|	ДД.Порядок,
	|	%2";
	
	Для Каждого ОписаниеТаблицы Из ТаблицыСвязейУзлов Цикл
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонЗапроса,
			ОписаниеТаблицы.Ключ,
			ОписаниеТаблицы.Значение);
		
		Строка 		= Неопределено;
		ТекущийКлюч = Неопределено;
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Ключ = Выборка.Ключ;
			
			Если ТекущийКлюч <> Ключ Тогда
				
				Если ТекущийКлюч <> Неопределено Тогда
					Данные.ЦепочкиДвижений.Вставить(ТекущийКлюч, Строка);
				КонецЕсли;
				
				ТекущийКлюч = Ключ;
				
				Строка = Данные.ЦепочкиДвижений[ТекущийКлюч];
				Если Строка = Неопределено Тогда
					Строка = Данные.СтрокиЦепочек.Добавить();
				КонецЕсли;
				
			КонецЕсли;
			
			Строка[ОписаниеТаблицы.Ключ].Добавить(Выборка[ОписаниеТаблицы.Значение]);
			
		КонецЦикла;
		
		Если ТекущийКлюч <> Неопределено Тогда
			Данные.ЦепочкиДвижений.Вставить(ТекущийКлюч, Строка);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры


Процедура СортироватьИсточники(Источники, ПолеПорядка, Приходы)
	
	// Ожидаем, что источников будем менее десятка и они будут почти всегда уже упорядочены, поэтому делаем сортировку вставками
	
	Для НомерИсточника1 = 1 По Источники.ВГраница() Цикл
		
		Если Приходы[Источники[НомерИсточника1]] = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ТипЗнч(Приходы[Источники[НомерИсточника1]]) = Тип("Массив") Тогда
			Если Приходы[Источники[НомерИсточника1]].Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			ИсточникУ = Приходы[Источники[НомерИсточника1]][0];
		Иначе
			ИсточникУ = Приходы[Источники[НомерИсточника1]];
		КонецЕсли;
		
		Элемент = Новый Структура("Порядок, Источник", ИсточникУ[ПолеПорядка], Источники[НомерИсточника1]);
		
		НомерИсточника2 = НомерИсточника1 - 1;
		Пока НомерИсточника2 >= 0 Цикл
			
			Если ТипЗнч(Приходы[Источники[НомерИсточника2]]) = Тип("Массив") Тогда
				Если Приходы[Источники[НомерИсточника2]].Количество() = 0 Тогда
					НомерИсточника2 = НомерИсточника2 - 1;
					Продолжить;
				КонецЕсли;
				ИсточникХ = Приходы[Источники[НомерИсточника2]][0];
			Иначе
				ИсточникХ = Приходы[Источники[НомерИсточника2]];
			КонецЕсли;
			
			Если ИсточникХ = Неопределено Тогда
				НомерИсточника2 = НомерИсточника2 - 1;
				Продолжить;
			КонецЕсли;
			
			Если ИсточникХ[ПолеПорядка] <= Элемент.Порядок Тогда
				Прервать;
			КонецЕсли;
			
			Источники[НомерИсточника2 + 1] = Источники[НомерИсточника2];
			НомерИсточника2 = НомерИсточника2 - 1;
			
		КонецЦикла;
		
		Источники[НомерИсточника2 + 1] = Элемент.Источник;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СортироватьИсточникиПоЗначениямПолей(Источники, ЗначенияПолей, Приходы)
	
	Список = Новый СписокЗначений;
	
	ИндексЭлементаМассива = -1;
	
	Для Каждого ИндексИсточника Из Источники Цикл
		
		ИндексЭлементаМассива = ИндексЭлементаМассива + 1;
		
		МассивПриходов = Приходы[ИндексИсточника];
		
		Если МассивПриходов = Неопределено ИЛИ МассивПриходов.Количество() = 0 Тогда
			Сдвиг = 0;
		Иначе
			
			Сдвиг = ЗначенияПолей.Количество();
			
			Для Каждого ПолеСортировки Из ЗначенияПолей Цикл
				Если МассивПриходов[0][ПолеСортировки.Ключ] = ПолеСортировки.Значение Тогда
					Сдвиг = Сдвиг - 1;
				ИначеЕсли МассивПриходов[0][ПолеСортировки.Ключ] = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт
				 И (ПолеСортировки.Значение = Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров
					ИЛИ ПолеСортировки.Значение = Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг) Тогда
					Сдвиг = Сдвиг - 1;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
		Список.Добавить(ИндексИсточника, Формат(ИндексЭлементаМассива + Сдвиг * Источники.Количество(), "ЧЦ=15; ЧДЦ=; ЧВН=; ЧГ="));
		
	КонецЦикла;
	
	Если Список.Количество() > 0 Тогда
		Список.СортироватьПоПредставлению(НаправлениеСортировки.Возр);
		Источники = Список.ВыгрузитьЗначения();
	КонецЕсли;
	
КонецПроцедуры

Процедура СортироватьПриходыПоЛИФО(ПолеПорядка, МассивПриходов)
	
	Список = Новый СписокЗначений;
	
	Для Каждого Приход Из МассивПриходов Цикл
		Список.Добавить(Приход, Приход[ПолеПорядка]);
	КонецЦикла;
	
	Список.СортироватьПоПредставлению(НаправлениеСортировки.Убыв);
	МассивПриходов = Список.ВыгрузитьЗначения();
	
КонецПроцедуры


Функция ДобавитьИЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Расход, Приход, Инвертировать = Ложь)
	
	Контекст   = ПараметрыРасчета.РаспределениеПартий.ОписаниеДвижений.Контекст;
	Показатели = ПараметрыРасчета.РаспределениеПартий.ОписаниеДвижений.Показатели;
	
	РасчетнаяПартия = ДобавитьРасчетнуюПартию(ПараметрыРасчета);
	
	ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Контекст, РасчетнаяПартия, Расход, Приход);
	
	ИнвертироватьПоказатели(РасчетнаяПартия, Показатели, Инвертировать);
	
	Возврат РасчетнаяПартия;
	
КонецФункции

// Добавляет новую строку в таблицу расчетных партий и заполняет необходимые поля.
//
Функция ДобавитьРасчетнуюПартию(ПараметрыРасчета, ДанныеЗаполнения = Неопределено)
	
	РасчетныеПартии = ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии;
	
	// При необходимости кэшируем сформированную порцию партий в таблицу движений по регистру
	Если РасчетныеПартии.Количество() >= ПараметрыРасчета.ОграниченияВыборки.КоличествоСтрокВТЗ Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.КэшироватьРаспределенныеПартии(ПараметрыРасчета, Ложь);
	КонецЕсли;
	
	// Добавим строку в таблицу распределенных партий
	РасчетнаяПартия = РасчетныеПартии.Добавить();
	
	Если ДанныеЗаполнения <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, ДанныеЗаполнения);
	КонецЕсли;
	
	ЗафиксироватьВЗамереДобавлениеРасчетнойПартии(ПараметрыРасчета);
	
	Возврат РасчетнаяПартия;
	
КонецФункции

// Удаляет указанную строку из таблицы партий.
//
Процедура УдалитьРасчетнуюПартию(ПараметрыРасчета, РасчетнаяПартия)
	
	РасчетныеПартии = ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии;
	РасчетныеПартии.Удалить(РасчетнаяПартия);
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеМетоды

// Возвращает массив типов записей, используемых в описании цепочек.
//
Функция ИспользуемыеТипыЗаписейВЦепочках(ОписаниеЦепочек, ВПриемниках = Истина, ВИсточниках = Истина,
			ДобавлятьВРезультатПустойТипЗаписи = Истина)
	
	ТипыЗаписей = Новый Массив;
	
	Для Каждого КлючИЗначение Из ОписаниеЦепочек Цикл
		
		Если ВПриемниках И ВИсточниках Тогда
			ОбщегоНазначенияУТКлиентСервер.ДобавитьНовоеЗначениеВМассив(ТипыЗаписей, КлючИЗначение.Ключ);
		ИначеЕсли ВПриемниках
		 И КлючИЗначение.Значение.ТипыПриемников.Количество() = 0
		 И КлючИЗначение.Значение.ТипыИсточников.Количество() = 0 Тогда
			ОбщегоНазначенияУТКлиентСервер.ДобавитьНовоеЗначениеВМассив(ТипыЗаписей, КлючИЗначение.Ключ);
		КонецЕсли;
		
		Если ВПриемниках Тогда
			Для Каждого Приемники Из КлючИЗначение.Значение.ТипыПриемников Цикл
				ОбщегоНазначенияУТКлиентСервер.ДобавитьНовоеЗначениеВМассив(ТипыЗаписей, Приемники.Ключ);
			КонецЦикла;
		КонецЕсли;
		
		Если ВИсточниках Тогда
			Для Каждого Источники Из КлючИЗначение.Значение.ТипыИсточников Цикл
				ОбщегоНазначенияУТКлиентСервер.ДобавитьНовоеЗначениеВМассив(ТипыЗаписей, Источники.Ключ);
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ДобавлятьВРезультатПустойТипЗаписи Тогда
		ОбщегоНазначенияУТКлиентСервер.ДобавитьНовоеЗначениеВМассив(ТипыЗаписей, Перечисления.ТипыЗаписейПартий.ПустаяСсылка());
	КонецЕсли;
	
	Возврат ТипыЗаписей;
	
КонецФункции

// Используется также при распределении приходов на расходы
//
Процедура ИнвертироватьПоказатели(Запись, ПереченьПоказателей, Инвертировать)
	
	Если Не Инвертировать Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого Поле Из Новый Структура(ПереченьПоказателей) Цикл
		Запись[Поле.Ключ] = -Запись[Поле.Ключ];
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ЗамерыРасчета

Процедура ИнициализироватьЗамерРаспределенияПартий(ПараметрыРасчета)
	
	СтатистикаРасчета = Новый ТаблицаЗначений;
	
	СтатистикаРасчета.Колонки.Добавить("КоличествоПодграфов", Новый ОписаниеТипов("Число"));
	СтатистикаРасчета.Колонки.Добавить("КоличествоУзлов", 	  Новый ОписаниеТипов("Число"));
	СтатистикаРасчета.Колонки.Добавить("ТекущаяГлубина", 	  Новый ОписаниеТипов("Число"));
	СтатистикаРасчета.Колонки.Добавить("МаксимальнаяГлубина", Новый ОписаниеТипов("Число"));
	СтатистикаРасчета.Колонки.Добавить("СформированоЗаписей", Новый ОписаниеТипов("Число"));
	СтатистикаРасчета.Колонки.Добавить("РезультатыОбхода", 	  Новый ОписаниеТипов("Структура"));
	
	ПараметрыРасчета.РаспределениеПартий.Вставить("СтатистикаРасчета", СтатистикаРасчета);
	
КонецПроцедуры

Процедура НачалоЗамераРасчетаГруппыПодграфов(ПараметрыРасчета, Выборка)
	
	НоваяСтрока = ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета.Добавить();
	
	НоваяСтрока.КоличествоПодграфов = Выборка.КоличествоПодграфов;
	НоваяСтрока.КоличествоУзлов = Выборка.МаксимальныйНомерУзла - Выборка.МинимальныйНомерУзла + 1;
	
КонецПроцедуры

Процедура НачалоЗамераРасчетаЦепочек(ПараметрыРасчета)
	
	ТекущаяСтрока = ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета[ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета.Количество() - 1];
	
	ТекущаяСтрока.ТекущаяГлубина = ТекущаяСтрока.ТекущаяГлубина + 1;
	
	ТекущаяСтрока.МаксимальнаяГлубина =
		Макс(ТекущаяСтрока.МаксимальнаяГлубина, ТекущаяСтрока.ТекущаяГлубина);;
	
КонецПроцедуры

Функция ОкончаниеЗамераРасчетаЦепочек(ПараметрыРасчета, РезультатРасчета)
	Перем Количество;
	
	ТекущаяСтрока = ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета[ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета.Количество() - 1];
	
	Если НЕ ТекущаяСтрока.РезультатыОбхода.Свойство(РезультатРасчета, Количество) Тогда
		Количество = 0;
	КонецЕсли;
	
	ТекущаяСтрока.РезультатыОбхода.Вставить(РезультатРасчета, Количество + 1);
	
	ТекущаяСтрока.ТекущаяГлубина = ТекущаяСтрока.ТекущаяГлубина - 1;
	
	Возврат РезультатРасчета;
	
КонецФункции

Процедура ЗафиксироватьВЗамереДобавлениеРасчетнойПартии(ПараметрыРасчета)
	
	ТекущаяСтрока = ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета[ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета.Количество() - 1];
	
	ТекущаяСтрока.СформированоЗаписей = ТекущаяСтрока.СформированоЗаписей + 1;
	
КонецПроцедуры

Процедура ЗавершитьЗамерРаспределенияПартий(ПараметрыРасчета)
	
	// Добавим в протокол расчета партий собранную информацию о текущем расчете цепочек.
	ОписаниеРасчета = НСтр("ru='Описание результатов обхода цепочек (графа):'");
	
	ШаблонОписаниеГруппыПодграфов = НСтр("ru='
		|	%1. Подграфов: %2, узлов: %3, глубина обхода: %4, сформировано записей: %5.
		|	Результаты расчета цепочек: %6'");
	
	НомерСтроки = 0;
	
	Для Каждого ТекущаяСтрока Из ПараметрыРасчета.РаспределениеПартий.СтатистикаРасчета Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		ОписаниеРезультатов = "";
		
		Для Каждого КлючИЗначение Из ТекущаяСтрока.РезультатыОбхода Цикл
			ОписаниеРезультатов = ОписаниеРезультатов + ?(ОписаниеРезультатов = "", "", ", ")
				+ """" + КлючИЗначение.Ключ + """ - " + СокрЛП(КлючИЗначение.Значение);
		КонецЦикла;
		
		ОписаниеРасчета = ОписаниеРасчета
			+ СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонОписаниеГруппыПодграфов,
				СокрЛП(НомерСтроки),
				СокрЛП(ТекущаяСтрока.КоличествоПодграфов),
				СокрЛП(ТекущаяСтрока.КоличествоУзлов),
				СокрЛП(ТекущаяСтрока.МаксимальнаяГлубина),
				СокрЛП(ТекущаяСтрока.СформированоЗаписей),
				?(ОписаниеРезультатов = "", НСтр("ru='не выполнялся (нет цепочек)'"), ОписаниеРезультатов));
		
	КонецЦикла;
	
	ПротоколРасчетаПартийИСебестоимости.ДополнительнаяИнформация(ПараметрыРасчета, ОписаниеРасчета);
	
	ПараметрыРасчета.РаспределениеПартий.Удалить("СтатистикаРасчета");
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область РаспределениеПриходовНаРасходы

// Заполняет расчетные партии из данных для расчета
// Поля прямого обращения: ТипЗаписи, ВидДвижения, Регистратор
// Обращения к остальным полям происходит через структуру ОписаниеДвижений
//
Процедура РаспределитьПриходыНаРасходы(ПараметрыРасчета, ОписаниеДвижений, ДанныеДляРасчета, РасчетныеПартии)
	
	ПредыдущееДвижение = Неопределено;
	// Буфер партий по аналитике - очередь копий партионных движений
	Приходы = Новый Структура("Очередь, Указатель, УказательРестарта", Новый Массив, 0, -1);
	// Буфер потреблений по аналитике - очередь копий движений потребления
	Расходы = Новый Структура("Очередь, Указатель, УказательРестарта", Новый Массив, 0, -1);
	
	СтрокиПриходов = РасчетныеПартии.СкопироватьКолонки();
	СтрокиРасходов = СтрокиПриходов.СкопироватьКолонки();
	
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		
		Если НЕ ПоляЗаписейРавны(ПредыдущееДвижение, Движение, ОписаниеДвижений.КлючиСравнения) Тогда
			// Сменилась аналитика - сбрасываем оставшийся буфер потреблений (партии не подобраны) в расчетные партии
			Расходы.Указатель = ?(Расходы.УказательРестарта > 0, Расходы.УказательРестарта, Расходы.Указатель);
			Пока Расходы.Указатель < Расходы.Очередь.Количество() Цикл
				Расход = Расходы.Очередь[Расходы.Указатель];
				Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
					// перемещения, что приведет к очистке документа поступления у перемещения.
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, ОписаниеДвижений.Контекст, Распределение, Расход, Неопределено);
				КонецЕсли;
				Расходы.Указатель = Расходы.Указатель + 1;
			КонецЦикла;
			
			// инициализируемся
			ПредыдущееДвижение = Движение;
			Приходы.Очередь.Очистить();
			Приходы.Указатель = 0;
			Приходы.УказательРестарта = -1;
			Расходы.Очередь.Очистить();
			Расходы.Указатель = 0;
			Расходы.УказательРестарта = -1;
		КонецЕсли;
		
		ЭтоПриход = (Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Остаток)
			ИЛИ (Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Партия)
			ИЛИ (Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение)
			ИЛИ (Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно);
		
		ИнвертироватьПоказатели = (ЭтоПриход И Движение[ОписаниеДвижений.БазисПрихода] < 0)
			ИЛИ (НЕ ЭтоПриход И Движение[ОписаниеДвижений.БазисРасхода] < 0);
		
		Если ЭтоПриход Тогда
			Приход = СтрокиПриходов.Добавить();
			ЗаполнитьЗначенияСвойств(Приход, Движение);
			ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
			// если ранее пропустили расход, то текущий приход начинаем распределять на него
			Если Расходы.УказательРестарта >= 0 Тогда
				Расходы.Указатель = Расходы.УказательРестарта;
				Расходы.УказательРестарта = -1;
			КонецЕсли;
			// покрываем расходы из буфера расходов по очереди (FIFO)
			Пока Приход[ОписаниеДвижений.БазисПрихода] > 0 И Расходы.Указатель < Расходы.Очередь.Количество() Цикл
				Расход = Расходы.Очередь[Расходы.Указатель];
				// приход, сделанный по расходу не может быть распределен на этот расход
				Если Расход.Регистратор = Приход[ОписаниеДвижений.КлючРасхода] Тогда
					Расходы.УказательРестарта = Расходы.Указатель;
					Расходы.Указатель = Расходы.Указатель + 1;
					Продолжить;
				КонецЕсли;
				// добавляем в партии покрытую часть расхода
				Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, ОписаниеДвижений.Контекст, Распределение, Расход, Приход);
				КонецЕсли;
				// если расход покрыт, то ставим на покрытие следующий расход
				Если Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
					Расходы.Указатель = Расходы.Указатель + 1;
					СтрокиРасходов.Удалить(Расход);
				КонецЕсли;
			КонецЦикла;
			// если приход еще остался, то регистрируемся в буфере приходов
			Если Приход[ОписаниеДвижений.БазисПрихода] > 0 Тогда
				Приходы.Очередь.Добавить(Приход);
			КонецЕсли;
			// приход надо добавить в партии - код должен быть здесь для сохранения сортировки
			Если Движение.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.Остаток Тогда
				Распределение = РасчетныеПартии.Добавить();
				ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, ОписаниеДвижений.Контекст, Распределение, Движение, Неопределено);
			КонецЕсли;
		КонецЕсли;
		
		Если Движение.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление Тогда
			Расход = СтрокиРасходов.Добавить();
			ЗаполнитьЗначенияСвойств(Расход, Движение);
			ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
			// если ранее пропустили приход, то текущий расход начинаем потреблять с него
			Если Приходы.УказательРестарта >= 0 Тогда
				Приходы.Указатель = Приходы.УказательРестарта;
				Приходы.УказательРестарта = -1;
			КонецЕсли;
			// списываем приходы из буфера приходов по очереди (FIFO)
			Пока Расход[ОписаниеДвижений.БазисРасхода] > 0 И Приходы.Указатель < Приходы.Очередь.Количество() Цикл
				Приход = Приходы.Очередь[Приходы.Указатель];
				// приход, сделанный по расходу не может быть распределен на этот расход
				Если Расход.Регистратор = Приход[ОписаниеДвижений.КлючРасхода] Тогда
					Приходы.УказательРестарта = Приходы.Указатель;
					Приходы.Указатель = Приходы.Указатель + 1;
					Продолжить;
				КонецЕсли;
				// добавляем в партии покрытую часть расхода
				Если Приход[ОписаниеДвижений.БазисПрихода] > 0 Тогда
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, ОписаниеДвижений.Контекст, Распределение, Расход, Приход);
					Если Не Распределение.РасчетЗавершен Тогда
						РасчетныеПартии.Удалить(Распределение);
					КонецЕсли;
				КонецЕсли;
				// если приход потреблен, то выбираем следующий приход
				Если Приход[ОписаниеДвижений.БазисПрихода] <= 0 Тогда
					Приходы.Указатель = Приходы.Указатель + 1;
					СтрокиПриходов.Удалить(Приход);
				КонецЕсли;
			КонецЦикла;
			// если расход еще остался, то регистрируемся в буфере расходов
			Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
				Расходы.Очередь.Добавить(Расход);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	СтрокиПриходов.Очистить();
	СтрокиРасходов.Очистить();
	
КонецПроцедуры

#Область ВспомогательныеМетоды

Функция ПоляЗаписейРавны(Запись1, Запись2, ПереченьКлючей)
	
	Если Запись1 = Неопределено Или Запись2 = Неопределено Тогда
		Возврат (Запись1 = Запись2);
	КонецЕсли;
	
	Для Каждого Поле Из Новый Структура(ПереченьКлючей) Цикл
		Если Запись1[Поле.Ключ] <> Запись2[Поле.Ключ] Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ТрансляцияПартий

// Вырожденный случай распределения партий, когда непосредственно распределение выполнять не требуется,
// т.к. все выбранные данные имеют признак РасчетПартий = Истина.
// Нужно просто переместить содержимое временной таблицы Данные в таблицу-приемник.

Процедура ИнициализироватьТрансляциюПартий(ПараметрыРасчета, ТаблицаДляТрансляцииПартий = Неопределено, ИмяРегистра = "", ИмяВременнойТаблицы = "")
	
	// Подготовим структуру ОписаниеДвижений.
	ОписаниеДвижений = ОписаниеДвижений(
		"ТрансляцияПартий",
		?(ЗначениеЗаполнено(ИмяРегистра), ИмяРегистра, ""),
		"",
		"",
		"",
		"",
		"",
		"",
		"");
	
	Если НЕ ЗначениеЗаполнено(ИмяРегистра) Тогда
		ОписаниеДвижений.Вставить("ИмяВременнойТаблицы", ИмяВременнойТаблицы);
	КонецЕсли;
	
	ОписаниеДвижений.Вставить("РаспределениеНеТребуется", Истина);
	
	// Подготовим структуру РаспределениеПартий.
	ПараметрыРасчета.Вставить("РаспределениеПартий", Новый Структура);
	
	ПараметрыРасчета.РаспределениеПартий.Вставить("РасчетныеПартии", 	  ТаблицаДляТрансляцииПартий);
	ПараметрыРасчета.РаспределениеПартий.Вставить("ОписаниеДвижений", 	  ОписаниеДвижений);
	ПараметрыРасчета.РаспределениеПартий.Вставить("ОписаниеЦепочек", 	  Новый Соответствие); // не используется
	ПараметрыРасчета.РаспределениеПартий.Вставить("НезаписываемыеДанные", ОписаниеНезаписываемыхДанных(Ложь)); // не используется
	
КонецПроцедуры

#КонецОбласти


#Область УниверсальныеПроцедурыРаботыСЗапросами

// Устанавливает общие параметры запроса из параметров расчета.
// Следует использовать для идентичности имен и значений параметров во всех запросах.
//
Процедура ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета, ИспользоватьОбщийМенеджерВТ = Истина)
	
	// Общие параметры
	УниверсальныеМеханизмыПартийИСебестоимости.ИнициализироватьСвойстваЗапроса(
		Запрос,
		ПараметрыРасчета,
		ИспользоватьОбщийМенеджерВТ);
		
	// Отборы по типам запасов
	Запрос.УстановитьПараметр("СобственныеТипыЗапасов", УниверсальныеМеханизмыПартийИСебестоимости.СобственныеТипыЗапасов());
	
	// Параметры для запроса Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов()
	Запрос.УстановитьПараметр("ПоВсемОрганизациям",   Ложь);
	Запрос.УстановитьПараметр("ПоВсемПодразделениям", Истина);
	Запрос.УстановитьПараметр("СписокПодразделений",  Неопределено);
	
КонецПроцедуры

Функция ТекстОбъединениеЗапросов()
	
	ТекстОбъединение = "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|";
	
	Возврат ТекстОбъединение;
	
КонецФункции

Функция ТекстРазделениеЗапросов()
	
	ТекстРазделение = "
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|";
	
	Возврат ТекстРазделение;
	
КонецФункции

#КонецОбласти

#Область УниверсальныеПроцедурыРаботыСДвижениями

// Добавляет новую строку в таблицу движений указанного регистра и заполняет служебные поля.
// Сделана экспортной для вызова из модуля универсальных механизмов расчетов.
//
Функция ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля = Неопределено) Экспорт
	
	ОписаниеРегистра = ПараметрыРасчета.Движения[ИмяРегистра];
	ЭтоРегистрСебестоимости = (ОписаниеРегистра.ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Добавим запись универсальной процедурой, а потом дозаполним поля, относящиеся только к расчету партий
	Запись = УниверсальныеМеханизмыПартийИСебестоимости.ДобавитьЗаписьВТаблицуДвижений(
		ПараметрыРасчета,
		ОписаниеРегистра,
		ДанныеДвижения,
		КопируемыеПоля);
	
	Если ЭтоРегистрСебестоимости И ПараметрыРасчета.ЗаполняютсяПартииВСебестоимости Тогда
		
		// Заполним поле РасчетПартий для записи регистра СебестоимостьТоваров:
		// - на этапе заполнения партий себестоимости дозаполняются поля первичных движений документов
		//   для таких движений признак РасчетПартий остается равным Ложь
		// - на этом же этапе также формируются новые записи, которые являются расчетными (не первичными);
		//	 признак расчетной партии определяется следующими условиями (по ИЛИ)
		// 		= тип записи движений не используется в макете регистра себестоимости (т.е. движение точно не может быть первичным)
		// 		= для записи явно указано, что она является расчетной (установлен признак ЭтоТочноРасчетноеДвижение)
		
		Запись.РасчетПартий =
			ДанныеДвижения.ЭтоТочноРасчетноеДвижение
			ИЛИ УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЭтоТолькоРасчетныйТипЗаписи(Запись.ТипЗаписи);
		
	КонецЕсли;
	
	// Если регистратор не заполнен, то запомним информацию об ошибке
	Если НЕ ЗначениеЗаполнено(Запись.Регистратор) Тогда
		
		Если НЕ ЗначениеЗаполнено(ДанныеДвижения.Регистратор) Тогда
			// Ошибка в запросах - не заполнено обязательное поле Регистратор.
			ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не заполнено свойство Регистратор в данных для формирования движений по регистру ""%1""'"),
				ИмяРегистра);
		Иначе
			// Ошибка в метаданных - документ не является регистратором для данного регистра.
			ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Документ ""%1"" не может иметь движений по регистру ""%2""'"),
				СокрЛП(ДанныеДвижения.Регистратор),
				ИмяРегистра);
		КонецЕсли;
		
		ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаФормированияДвиженийПоРегистрам,
			ТекстДляПротокола);
		
	КонецЕсли;
	
	Возврат Запись;
	
КонецФункции

#КонецОбласти

#Область УниверсальныеПроцедурыОписанияДанныхМеханизма

// Возвращает перечень объектов метаданных, на основании данных которых выполняется расчет партий.
// В перечень не включаются объекты, которые являются одновременно и исходящими данными механизмов расчета партий и себестоимости.
//
// Параметры:
//	ВходящиеДанные - Соответствие - уже инициализированное хранилище для описания входящих данных
//	ТолькоТребующиеПерерасчета - Булево - если установлен, то будет возвращен перечень только тех данных,
//		изменение которых влечет за собой необходимость перерасчета партий и себестоимости
//		При изменении этих данных должна создаваться запись в регистре сведений ЗаданияКРасчетуСебестоимости.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных
//
Функция ВходящиеДанныеМеханизма(ВходящиеДанные = Неопределено, ТолькоТребующиеПерерасчета = Ложь) Экспорт
	
	Если ВходящиеДанные = Неопределено Тогда
		ВходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	Если ТолькоТребующиеПерерасчета Тогда
		Значение = Истина; // чтобы можно было проверить вхождение объекта метаданных в это соответствие
	Иначе
		Значение = Неопределено;
	КонецЕсли;
	
	Если НЕ ТолькоТребующиеПерерасчета Тогда 
		
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказНаПеремещение, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказНаСборку, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказПоставщику, Значение);
		
		ВходящиеДанные.Вставить(Метаданные.Документы.ВнутреннееПотреблениеТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПередачаТоваровМеждуОрганизациями, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПоступлениеТоваровУслуг, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПрочееОприходованиеТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ТаможеннаяДекларацияИмпорт, Значение);
		
		//++ НЕ УТ
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратМатериаловИзПроизводства, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВыпускПродукции, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказПереработчику, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ИзделияИЗатратыНЗП, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ОтчетПереработчика, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПередачаМатериаловВПроизводство, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПоступлениеОтПереработчика, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.СписаниеЗатратНаВыпуск, Значение);
		//-- НЕ УТ
		//++ НЕ УТКА
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказДавальца, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказНаПроизводство, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.МаршрутныйЛистПроизводства, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПроизводствоБезЗаказа, Значение);
		//-- НЕ УТКА
		
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаВидовЗапасов, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаУчетаНоменклатуры, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ЦеныНоменклатуры, Значение);
		
		//++ НЕ УТ
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ДолиСписанияКосвенныхРасходов, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ЗначенияПоказателейДляРаспределенияРасходов, Значение);
		//-- НЕ УТ
		
		ВходящиеДанные.Вставить(Метаданные.ПланыВидовХарактеристик.СтатьиАктивовПассивов, Значение);
		ВходящиеДанные.Вставить(Метаданные.ПланыВидовХарактеристик.СтатьиРасходов, Значение);
		
		ВходящиеДанные.Вставить(Метаданные.Справочники.ВидыЗапасов, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.КлючиАналитикиУчетаНоменклатуры, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.КлючиАналитикиУчетаПартий, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.Назначения, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.Номенклатура, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.Склады, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.СтруктураПредприятия, Значение);
		
		//++ НЕ УТ
		ВходящиеДанные.Вставить(Метаданные.Справочники.ПравилаРаспределенияРасходов, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.РесурсныеСпецификации, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.ЭтапыПроизводства, Значение);
		//-- НЕ УТ
		
	КонецЕсли;
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЗаказыНаПеремещение, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЗаказыНаСборку, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЗаказыПоставщикам, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизаций, Значение);
	
	//++ НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.Документы.РаспределениеПроизводственныхЗатрат, Значение);
	ВходящиеДанные.Вставить(Метаданные.Документы.РаспределениеПрочихЗатрат, Значение);
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ВыпускПродукции, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РаспоряженияНаСписаниеПоНормативам, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыПолученныеОтПереработчика, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства, Значение);
	//-- НЕ УТ
	//++ НЕ УТКА
	ВходящиеДанные.Вставить(Метаданные.Документы.ЭтапПроизводства2_2, Значение);
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РаспоряженияНаВыпускПродукции, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЭтапыПроизводства, Значение);
	//-- НЕ УТКА
	
	// Добавим регистры партионного учета версии 2.1 (используются для формирования начальных остатков для версии 2.2)
	НеиспользуемыеДанныеМеханизмаВерсии21(ВходящиеДанные, Значение);
	
	Возврат ВходящиеДанные;
	
КонецФункции

// Возвращает перечень регистров, обслуживаемых механизмом расчета партий.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных
//
Функция ИсходящиеДанныеМеханизма(ИсходящиеДанные = Неопределено) Экспорт
	
	// Перечень метаданных регистров, по которым формируются движения по партиям.
	Если ИсходящиеДанные = Неопределено Тогда
		ИсходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН, 		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы,		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве, 			Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, 					Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, 					Истина);
	
	//++ НЕ УТ
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства,		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства,  Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизаций,                       Истина);
	//-- НЕ УТ
	
	Возврат ИсходящиеДанные;
	
КонецФункции

// Возвращает перечень регистров партионного учета версии 2.1, неиспользуемых в версии 2.2
//
Функция НеиспользуемыеДанныеМеханизмаВерсии21(НеиспользуемыеДанные = Неопределено, Значение = Истина) Экспорт
	
	Если НеиспользуемыеДанные = Неопределено Тогда
		НеиспользуемыеДанные = Новый Соответствие;
	КонецЕсли;
	
	НеиспользуемыеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, 					Значение);
	НеиспользуемыеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, 			Значение);
	НеиспользуемыеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, 	Значение);
	НеиспользуемыеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, 				Значение);
	НеиспользуемыеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, 		Значение);
	
	Возврат НеиспользуемыеДанные;
	
КонецФункции

// Возвращает название данного механизма и его номер версии.
//
Функция ТекущаяВерсияМеханизма() Экспорт
	Возврат НСтр("ru='Партионный учет, версия 2.2'");
КонецФункции

#КонецОбласти


#Область Тестирование

Функция ТестТекстОписание(ИмяМетода) Экспорт
	
	Если ИмяМетода = "ТекстОписаниеСебестоимостьТоваров" Тогда
		Возврат ТекстОписаниеДанныхДляПартийТоваров();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийНДС" Тогда
		Возврат ТекстОписаниеДанныхДляПартийНДСиУСН();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийПрочих" Тогда
		Возврат ТекстОписаниеДанныхДляПартийПрочих();
		
	//++ НЕ УТ	
	ИначеЕсли ИмяМетода = "ТекстОписаниеРаспределениеМатериаловИРабот" Тогда
		Возврат ТекстОписаниеДанныхДляРаспределенияМатериаловИРаботПоБазе();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПартийНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляРаспределенияМатериаловНЗП();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляТрудозатратНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляТрудозатратНЗП();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПрочихРасходовНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляПрочихРасходовНЗП();
	//-- НЕ УТ
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

Функция ТестДанныеДляПартий(ИмяМетода, НачалоПериода, КонецПериода, Организация = Неопределено) Экспорт
	Перем ПараметрыРасчета;
	Перем ПараметрыОтладки;
	
	// Инициализация параметров запуска
	МассивОрганизаций = УниверсальныеМеханизмыПартийИСебестоимости.СвязиОрганизацийПоСхемеИнтеркампани(КонецПериода, Организация);
	ПараметрыЗапуска = Новый Структура("Дата, МассивОрганизаций", НачалоПериода, МассивОрганизаций);
	
	// Инициализация параметров отладки
	Отладка = Новый Структура("РасчетОдногоЭтапа", Ложь);
	ПараметрыОтладки = Новый Структура("Отладка", Отладка);
	
	// Инициализация параметров расчета
	ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	// Получение контекстных данных
	Если ИмяМетода = "ДанныеДляСебестоимостиТоваров"
	ИЛИ ИмяМетода = "ДанныеДляПартийНДС" Тогда
		//++ НЕ УТКА
		РаспределитьТоварыОрганизацийНаПроизводство(ПараметрыРасчета);
		СформироватьСебестоимостьМатериаловПоЭтапам(ПараметрыРасчета);
		РаспределениеНоменклатурыНаПроизводство(ПараметрыРасчета);
		РаспределениеНоменклатурыНаВыпуск(ПараметрыРасчета);
		//-- НЕ УТКА
		//++ НЕ УТ
		РаспределениеМатериаловИРаботПоБазе(ПараметрыРасчета);
		РаспределениеМатериаловМеждуОстаткомНЗПиВыходнымиИзделиями(ПараметрыРасчета);
		//-- НЕ УТ
	КонецЕсли;
	Если ИмяМетода = "ДанныеДляСебестоимостиТоваров" Тогда
		УниверсальныеМеханизмыПартийИСебестоимости.ВыполняетсяЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета, Истина);
		ПолучитьДанныеДляПартийТоваров(ПараметрыРасчета);
	ИначеЕсли ИмяМетода = "ДанныеДляПартийНДС" Тогда
		ЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета);
		РаспределениеДопРасходовМеждуПартиямиИТоварами(ПараметрыРасчета);
		
		ПолучитьДанныеДляПартийНДС(ПараметрыРасчета);
		//++ НЕ УТ
	ИначеЕсли ИмяМетода = "ДанныеДляПартийНЗП" Тогда
		ПолучитьДанныеДляРаспределенияМатериаловНЗП(ПараметрыРасчета);
	ИначеЕсли ИмяМетода = "ДанныеДляТрудозатратНЗП" Тогда
		ПолучитьДанныеДляРаспределенияТрудозатрат(ПараметрыРасчета);
		//-- НЕ УТ
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	Таблица = УниверсальныеМеханизмыПартийИСебестоимости.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, "Данные");
	
	Возврат Таблица;
	
КонецФункции

Процедура ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий, ПараметрыРасчета)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ
	|	Данные
	|ИЗ
	|	&ДанныеДляПартий КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	ДД.К
	|");
	МВТ = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ДанныеДляПартий", ДанныеДляПартий);
	Запрос.Выполнить();
КонецПроцедуры

Функция ВыгрузитьИзВременнойТаблицы(МВТ)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	Данные КАК ДД
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ТестРасчетныеПартии(ИмяМетода, НачалоПериода, КонецПериода, Организация, ДанныеДляПартий, ВнутренниеДанные = Неопределено) Экспорт
	Перем ПараметрыРасчета;
	Перем ПараметрыОтладки;
	
	// Инициализация параметров запуска
	МассивОрганизаций = УниверсальныеМеханизмыПартийИСебестоимости.СвязиОрганизацийПоСхемеИнтеркампани(КонецПериода, Организация);
	ПараметрыЗапуска = Новый Структура("Дата, МассивОрганизаций", НачалоПериода, МассивОрганизаций);
	
	// Инициализация параметров отладки
	Отладка = Новый Структура("РасчетОдногоЭтапа", Истина);
	ПараметрыОтладки = Новый Структура("Отладка", Отладка);
	
	// Инициализация параметров расчета
	ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий, ПараметрыРасчета);
	
	Если ИмяМетода = "РасчетныеПартииСебестоимостиТоваров" Тогда
		ИнициализироватьРаспределениеПартий(
			ПараметрыРасчета,
			ТаблицаДляРаспределенияПартийТоваров(ПараметрыРасчета),
			ОписаниеЦепочекПартийТоваров(ПараметрыРасчета),
			ОписаниеДвиженийПартийТоваров(ПараметрыРасчета),
			ОписаниеНезаписываемыхПартийТоваров(ПараметрыРасчета));
	ИначеЕсли ИмяМетода = "РасчетныеПартииНДС" Тогда
		ИнициализироватьРаспределениеПартий(
			ПараметрыРасчета,
			ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета),
			ОписаниеЦепочекПартийНДС(ПараметрыРасчета),
			ОписаниеДвиженийПартийНДС(ПараметрыРасчета),
			ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета));
	//++ НЕ УТ
	ИначеЕсли ИмяМетода = "РасчетныеПартииНЗП" Тогда
		ИнициализироватьРаспределениеПартий(
			ПараметрыРасчета,
			ТаблицаДляРаспределенияМатериаловНЗП(ПараметрыРасчета),
			ОписаниеЦепочекРаспределенияМатериаловНЗП(ПараметрыРасчета),
			ОписаниеДвиженийРаспределенияМатериаловНЗП(ПараметрыРасчета),
			ОписаниеНезаписываемыхРаспределенийМатериаловНЗП(ПараметрыРасчета));
	ИначеЕсли ИмяМетода = "РасчетныеТрудозатратыНЗП" Тогда
		ИнициализироватьРаспределениеПартий(
			ПараметрыРасчета,
			ТаблицаДляРаспределенияТрудозатрат(ПараметрыРасчета),
			ОписаниеЦепочекРаспределенияТрудозатрат(ПараметрыРасчета),
			ОписаниеДвиженийРаспределенияТрудозатрат(ПараметрыРасчета),
			ОписаниеНезаписываемыхРаспределенийТрудозатрат(ПараметрыРасчета));
	//-- НЕ УТ
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	ВнутренниеДанные = ПараметрыРасчета.МенеджерВременныхТаблиц;
	ДанныеДляПартий = ВыгрузитьИзВременнойТаблицы(ВнутренниеДанные);
	
	Возврат ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии;
КонецФункции

Функция ТестРассчитать(ИмяМетода, НачалоПериода, КонецПериода, Организация = Неопределено) Экспорт
	Перем ПараметрыРасчета;
	Перем ПараметрыОтладки;
	
	// Инициализация параметров запуска
	МассивОрганизаций = УниверсальныеМеханизмыПартийИСебестоимости.СвязиОрганизацийПоСхемеИнтеркампани(КонецПериода, Организация);
	ПараметрыЗапуска = Новый Структура("Дата, МассивОрганизаций", НачалоПериода, МассивОрганизаций);
	
	// Инициализация параметров отладки
	Отладка = Новый Структура("РасчетОдногоЭтапа", Истина);
	ПараметрыОтладки = Новый Структура("Отладка", Отладка);
	
	// Инициализация параметров расчета
	ИнициализироватьПараметрыРасчетаПартий(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	Если ИмяМетода = "РассчитатьСебестоимостьТоваров" Тогда
		ЗаполнениеПартийВРегистреСебестоимостьТоваров(ПараметрыРасчета);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	// Записываем сформированные движения и завершаем расчет периода
	УниверсальныеМеханизмыПартийИСебестоимости.ЗаписатьСформированныеДвижения(
		ПараметрыРасчета,
		ПараметрыОтладки.ПротоколыРасчета);
	
	Возврат Неопределено;
КонецФункции

#КонецОбласти

#КонецОбласти
