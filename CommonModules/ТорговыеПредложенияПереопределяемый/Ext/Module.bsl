////////////////////////////////////////////////////////////////////////////////
// Подсистема "Торговые предложения".
// ОбщийМодуль.ТорговыеПредложенияПереопределяемый.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Возвращает признак того, что функциональная опция использования видов номенклатуры включена.
// 
// Параметры:
//   ИмяФормы - Строка - имя формы, для которой получаются данные.
//
// Возвращаемое значение:
//  Булево - признак того, что функциональная опция включена.
//
Функция ФункциональнаяОпцияИспользуется(Знач ИмяФормы) Экспорт
	
	МассивОпций = ЗависимостьФункционалаОтФункциональныхОпций().Получить(ИмяФормы);
	Если ЗначениеЗаполнено(МассивОпций) Тогда
		Для Каждого Опция из МассивОпций Цикл
			Если Не ПолучитьФункциональнуюОпцию(Опция) Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Выдает сообщение пользователю о том, что функциональная опция использования видов номенклатуры отключена.
//
// Параметры:
//  ИмяФормы - Строка - имя формы из которой вызывается сообщение.
//  Используется - Булево - признак того, что функциональная опция включена или нет.
//  Отказ - Булево - признак того, что форму сопоставления номенклатуры открывать не нужно.
//
Процедура СообщитьОНеобходимостиИспользованияФункциональнойОпции(Знач ИмяФормы, Знач Используется, Отказ) Экспорт
	
	Если Используется Тогда
		Возврат;
	КонецЕсли;
	
	МассивОпций = ЗависимостьФункционалаОтФункциональныхОпций().Получить(ИмяФормы);
	
	Для Каждого Опция из МассивОпций Цикл
		Если Опция = "ИспользоватьНесколькоВидовНоменклатуры" Тогда
			ТекстСообщения = НСтр("ru = 'Опция использования нескольких видов номенклатуры отключена.'");
		ИначеЕсли Опция = "ИспользоватьСоглашенияСКлиентами" Тогда
			ТекстСообщения = НСтр("ru = 'Опция использования соглашений с клиентами отключена.'");
		КонецЕсли;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,,,,Отказ);
	КонецЦикла;
	
КонецПроцедуры

// Получение валюты регламентированного учета.
// 
// Возвращаемое значение:
//  СправочникСсылка.Валюта - валюта регламентированного учета.
//
Функция ВалютаРегламентированногоУчета() Экспорт
	
	Возврат Константы.ВалютаРегламентированногоУчета.Получить();
	
КонецФункции

// Создает документ заказ поставщику на основании данных торгового предложения.
//
// Параметры:
//  ДанныеЗаполнения - Структура - данные торгового предложения:
//   * КонтекстИсточника - Структура - набор данных из документа основания содержащий данные для заполнения шапки документа.
//   * СтрокиЗаказа - ТаблицаЗначений - содержит данные табличной части.
//   * Организация - СправочникСсылка.Организации - организация торгового предложения.
//   * Валюта - СправочникСсылка.Валюты - валюта торгового предложения.
//
// Возвращаемое значение:
//   ДокументОбъект - возвращается созданный, но не записанный документ.
//
Функция СоздатьДокументЗаказПоставщикуНаОснованииТорговогоПредложения(Знач ДанныеЗаполнения) Экспорт
	
	КонтекстИсточника = ДанныеЗаполнения.КонтекстИсточника;
	СтрокиЗаказа = ДанныеЗаполнения.СтрокиЗаказа;
	Организация = ДанныеЗаполнения.Организация;
	Контрагент = ДанныеЗаполнения.Контрагент;
	Валюта = ДанныеЗаполнения.Валюта;
	
	ДокументОбъект = Документы.ЗаказПоставщику.СоздатьДокумент();
	ДокументОбъект.Дата = ТекущаяДатаСеанса();
	ДокументОбъект.Автор = Пользователи.АвторизованныйПользователь();

	// Реквизиты шапки.
	ДокументОбъект.Организация = Организация;
	ДокументОбъект.Контрагент =  Контрагент;
	ДокументОбъект.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Контрагент, "Партнер");
	ДокументОбъект.Валюта = Валюта;
	ДокументОбъект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика;
	ДокументОбъект.Статус = Перечисления.СтатусыЗаказовПоставщикам.НеСогласован;
	Если КонтекстИсточника <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(ДокументОбъект, КонтекстИсточника);
	КонецЕсли;
	
	// Заполнение соглашения по статистике.
	ЗаполняемыеРеквизиты = Новый Структура("Соглашение");
	РеквизитыДляОтбора = Новый Структура;
	РеквизитыДляОтбора.Вставить("Партнер", ДокументОбъект.Партнер);
	РеквизитыДляОтбора.Вставить("Валюта", ДокументОбъект.Валюта);
	РеквизитыДляОтбора.Вставить("ЦенаВключаетНДС", ДокументОбъект.ЦенаВключаетНДС);
	ЗаполнениеСвойствПоСтатистикеСервер.ПолучитьЗначенияСвойств(
		ДокументОбъект.Ссылка, ЗаполняемыеРеквизиты, РеквизитыДляОтбора);
	Если ЗначениеЗаполнено(ЗаполняемыеРеквизиты.Соглашение) Тогда
		ДокументОбъект.Соглашение = ЗаполняемыеРеквизиты.Соглашение;
	КонецЕсли;
	
	Сегодня = НачалоДня(ТекущаяДата());
	Сутки = 60 * 60 * 24;
	
	// Товары.
	Для каждого СтрокаЗаказа Из СтрокиЗаказа Цикл
		СтрокаТовары = ДокументОбъект.Товары.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТовары, СтрокаЗаказа);
		СтрокаТовары.Характеристика = СтрокаЗаказа.ХарактеристикаНоменклатуры;
		СтрокаТовары.КоличествоУпаковок = СтрокаЗаказа.Количество;
		СтрокаТовары.ДатаПоступления = Сегодня + (СтрокаЗаказа.СрокПоставки * Сутки);
		Если ЗначениеЗаполнено(СтрокаЗаказа.КонтекстСтроки) Тогда
			ЗаполнитьЗначенияСвойств(СтрокаТовары, СтрокаЗаказа.КонтекстСтроки);
		КонецЕсли;
	КонецЦикла;
	
	ДокументОбъект.Заполнить(Неопределено); // Инициализация документа.
	ДокументОбъект.ЗаполнитьЭтапыГрафикаОплаты();
	ДокументОбъект.УстановитьНовыйНомер();
	
	ТаблицаДатПоступления = ДокументОбъект.Товары.Выгрузить(, "ДатаПоступления");
	ТаблицаДатПоступления.Свернуть("ДатаПоступления");
	ДокументОбъект.ПоступлениеОднойДатой = ТаблицаДатПоступления.Количество() = 1;
	Если ДокументОбъект.ПоступлениеОднойДатой Тогда
		ДокументОбъект.ДатаПоступления = ТаблицаДатПоступления[0].ДатаПоступления;
	КонецЕсли;
	
	Возврат ДокументОбъект;
	
КонецФункции

// Удаляет созданные заказы поставщику при переходе на шаг назад.
//
// Параметры:
//  ТаблицаДокументы - ТаблицаЗначений - таблица документов для удаления, состав:
//    * Ссылка - ДокументСсылка - ссылка на удаляемый документ.
//  Отказ - Булево - признак результата удаления документов.
//
Процедура УдалитьДокументыЗаказПоставщику(ТаблицаДокументы, Отказ) Экспорт
	
	Сообщение = Новый СообщениеПользователю();
	ТекстИмеютсяСсылки = НСтр("ru = 'Имеются ссылки на %1 - %2.'");
	ТекстПомечен = НСтр("ru = '%1 - помечен на удаление.'");
	ТекстЗаблокирован  = НСтр("ru = '%1 - заблокирован. Пометить на удаление не удалось.'");
	ТекстУдален = НСтр("ru = '%1 - удален.'");
	
	ИменаОбъектовМетаданных = "Документ.ЗаказПоставщику";
	Регистры = ОбщегоНазначенияУТПовтИсп.РегистрыСведенийПоМетаданнымИзмерений(ИменаОбъектовМетаданных, Истина);
	
	СсылкиНаУдаление = Новый Массив();
	Для Каждого Строка Из ТаблицаДокументы Цикл
		СсылкиНаУдаление.Добавить(Строка.Ссылка);
	КонецЦикла;
	
	НазначенияЗаказов = НазначенияЗаказов(СсылкиНаУдаление);
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(СсылкиНаУдаление, НазначенияЗаказов);
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТаблицаСсылок = НайтиПоСсылкам(СсылкиНаУдаление);
	
	ВсегоСтрок = ТаблицаСсылок.Количество();
	Для Счетчик = 1 По ВсегоСтрок Цикл
		Ссылка = ТаблицаСсылок[ВсегоСтрок - Счетчик];
		Если Ссылка[0] = Ссылка[1] Или ЭтоЗаписьВедомогоРегистраСведений(Ссылка[1], Регистры) Тогда
			ТаблицаСсылок.Удалить(Ссылка);
		КонецЕсли;
	КонецЦикла;
	
	ПомечатьНаУдаление = Новый Массив();
	
	ВсегоСтрок = ТаблицаСсылок.Количество();
	Для Счетчик = 1 По ВсегоСтрок Цикл
		Ссылка = ТаблицаСсылок[ВсегоСтрок - Счетчик];
		Индекс = СсылкиНаУдаление.Найти(Ссылка[1]);
		Если Индекс = Неопределено Тогда
			Если ПомечатьНаУдаление.Найти(Ссылка[0]) = Неопределено Тогда
				ПомечатьНаУдаление.Добавить(Ссылка[0]);
				Сообщение.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстИмеютсяСсылки, СокрЛП(Ссылка[0]), СокрЛП(Ссылка[1]));
				Сообщение.Сообщить();
			КонецЕсли;
			ТаблицаСсылок.Удалить(Ссылка);
		КонецЕсли;
	КонецЦикла;
	
	ОбработкаЗавершена = Ложь;
	Пока Не ОбработкаЗавершена Цикл
		ОбработкаЗавершена = Истина;
		ВсегоСтрок = ТаблицаСсылок.Количество();
		Для Счетчик = 1 По ВсегоСтрок Цикл
			Ссылка = ТаблицаСсылок[ВсегоСтрок - Счетчик];
			Если ПомечатьНаУдаление.Найти(Ссылка[0]) <> Неопределено Тогда
				Если ПомечатьНаУдаление.Найти(Ссылка[1]) = Неопределено Тогда
					ПомечатьНаУдаление.Добавить(Ссылка[1]);
				КонецЕсли;
				ТаблицаСсылок.Удалить(Ссылка);
				ОбработкаЗавершена = Ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ТаблицаДокументы.Очистить();
	
	Для Каждого Ссылка из ПомечатьНаУдаление Цикл
		Индекс = СсылкиНаУдаление.Найти(Ссылка);
		Если Индекс <> Неопределено Тогда
			СсылкиНаУдаление.Удалить(Индекс);
		КонецЕсли;
		ДокументОбъект = Ссылка.ПолучитьОбъект();
		Если Не ДокументОбъект.Заблокирован() Тогда
			ДокументОбъект.УстановитьПометкуУдаления(Истина);
			Сообщение.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстПомечен, СокрЛП(Ссылка));
		Иначе
			Сообщение.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗаблокирован, СокрЛП(Ссылка));
		КонецЕсли;
		Сообщение.Сообщить();
	КонецЦикла;
	
	Для Каждого Ссылка Из СсылкиНаУдаление Цикл
		Сообщение.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстУдален, СокрЛП(Ссылка));
		Сообщение.Сообщить();
	КонецЦикла;
	
	УдалитьОбъекты(СсылкиНаУдаление, Ложь);
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

// Получает значения контекста на основании которого будет производиться поиск предложений
// и которые будут переданы в шапку создаваемых заказов.
//
// Параметры:
//  ПараметрКоманды - Массив - ссылки на документы для заполнения таблицы поиска товаров в 1С:Бизнес-сеть.
//  КонтекстИсточника - Структура - свойства источника, используемые для формирования заказов.
//  ТаблицаТовары - ТаблицаЗначений - товары для поиска с реквизитами, состав:
//    * Номенклатура - СправочникСсылка - номенклатура.
//    * Характеристика - СправочникСсылка - характеристика номенклатуры.
//    * Упаковка - СправочникСсылка - упаковка номенклатуры.
//    * Количество - Число - количество.
//    * ЕдиницаИзмерения - СправочникСсылка - единица измерения номенклатуры.
//    * Числитель - Число - числитель упаковки.
//    * Знаменатель - число - знаменатель номенклатуры.
//    * Склад - СправочникСсылка - склад для заказа.
//    * КонтекстСтроки - Произвольный - дополнительные свойства по источнику.
//
Процедура СвойстваКонтекстаДокументовДляПоискаПредложений(Знач ПараметрКоманды, КонтекстИсточника, ТаблицаТовары) Экспорт
	
	Запрос = Новый Запрос;
	
	Если ТипЗнч(ПараметрКоманды[0]) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
		
		ДополнительныеРеквизиты = Новый Структура();
		ДополнительныеРеквизиты.Вставить("Организация");
		ДополнительныеРеквизиты.Вставить("Валюта");
		ДополнительныеРеквизиты.Вставить("Приоритет");
		ДополнительныеРеквизиты.Вставить("Проведен");
		ДополнительныеРеквизиты.Вставить("Сделка");
		ДополнительныеРеквизиты.Вставить("Статус");
		ДополнительныеРеквизиты.Вставить("Склад");
		ДополнительныеРеквизиты.Вставить("НаправлениеДеятельности");
		ДополнительныеРеквизиты.Вставить("ЗакупкаПодДеятельность");
		
		СтруктураКонтекстаСтроки = Новый Структура("КонтекстСтрокиСклад");
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаказПоставщикуТовары.Номенклатура                      КАК Номенклатура,
		|	ЗаказПоставщикуТовары.Характеристика                    КАК Характеристика,
		|	ВЫБОР
		|		КОГДА ЗаказПоставщикуТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
		|			ТОГДА ЗаказПоставщикуТовары.Номенклатура.ЕдиницаИзмерения
		|		ИНАЧЕ ЗаказПоставщикуТовары.Упаковка
		|	КОНЕЦ                                                   КАК Упаковка,
		|	ЗаказПоставщикуТовары.КоличествоУпаковок                КАК Количество,
		|	ЗаказПоставщикуТовары.Номенклатура.ЕдиницаИзмерения     КАК ЕдиницаИзмерения,
		|	ЗаказПоставщикуТовары.Номенклатура.ЕдиницаИзмерения.Код КАК ЕдиницаИзмеренияКод,
		|	ЗаказПоставщикуТовары.Упаковка.Числитель                КАК Числитель,
		|	ЗаказПоставщикуТовары.Упаковка.Знаменатель              КАК Знаменатель,
		|	ЗаказПоставщикуТовары.Склад                             КАК КонтекстСтрокиСклад
		|ИЗ
		|	Документ.ЗаказПоставщику.Товары КАК ЗаказПоставщикуТовары
		|ГДЕ
		|	ЗаказПоставщикуТовары.Ссылка В(&СписокСсылок)"
		
	ИначеЕсли ТипЗнч(ПараметрКоманды[0]) = Тип("ДокументСсылка.ПланЗакупок") Тогда
		
		ДополнительныеРеквизиты = "Валюта, Склад";
		СтруктураКонтекстаСтроки = Новый Структура("КонтекстСтрокиСклад");
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ПланЗакупокТовары.Номенклатура                      КАК Номенклатура,
		|	ПланЗакупокТовары.Характеристика                    КАК Характеристика,
		|	ВЫБОР
		|		КОГДА ПланЗакупокТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
		|			ТОГДА ПланЗакупокТовары.Номенклатура.ЕдиницаИзмерения
		|		ИНАЧЕ ПланЗакупокТовары.Упаковка
		|	КОНЕЦ                                               КАК Упаковка,
		|	ПланЗакупокТовары.КоличествоУпаковок                КАК Количество,
		|	ПланЗакупокТовары.Номенклатура.ЕдиницаИзмерения     КАК ЕдиницаИзмерения,
		|	ПланЗакупокТовары.Номенклатура.ЕдиницаИзмерения.Код КАК ЕдиницаИзмеренияКод,
		|	ПланЗакупокТовары.Упаковка.Числитель                КАК Числитель,
		|	ПланЗакупокТовары.Упаковка.Знаменатель              КАК Знаменатель,
		|	ПланЗакупокТовары.Склад                             КАК КонтекстСтрокиСклад
		|ИЗ
		|	Документ.ПланЗакупок.Товары КАК ПланЗакупокТовары
		|ГДЕ
		|	ПланЗакупокТовары.Ссылка В(&СписокСсылок)"
		
	ИначеЕсли ТипЗнч(ПараметрКоманды[0]) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
		
		ДополнительныеРеквизиты = Новый Структура();
		ДополнительныеРеквизиты.Вставить("Организация");
		ДополнительныеРеквизиты.Вставить("Валюта");
		ДополнительныеРеквизиты.Вставить("Приоритет");
		ДополнительныеРеквизиты.Вставить("Проведен");
		ДополнительныеРеквизиты.Вставить("Сделка");
		ДополнительныеРеквизиты.Вставить("Склад");
		ДополнительныеРеквизиты.Вставить("Статус");
		ДополнительныеРеквизиты.Вставить("НаправлениеДеятельности");
		ДополнительныеРеквизиты.Вставить("ДокументОснование",      "Ссылка");
		ДополнительныеРеквизиты.Вставить("ЗакупкаПодДеятельность", "НалогообложениеНДС");
		
		СтруктураКонтекстаСтроки = Новый Структура("КонтекстСтрокиСклад");
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаказКлиентаТовары.Номенклатура                      КАК Номенклатура,
		|	ЗаказКлиентаТовары.Характеристика                    КАК Характеристика,
		|	ВЫБОР
		|		КОГДА ЗаказКлиентаТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
		|			ТОГДА ЗаказКлиентаТовары.Номенклатура.ЕдиницаИзмерения
		|		ИНАЧЕ ЗаказКлиентаТовары.Упаковка
		|	КОНЕЦ                                                КАК Упаковка,
		|	ЗаказКлиентаТовары.КоличествоУпаковок                КАК Количество,
		|	ЗаказКлиентаТовары.Номенклатура.ЕдиницаИзмерения     КАК ЕдиницаИзмерения,
		|	ЗаказКлиентаТовары.Номенклатура.ЕдиницаИзмерения.Код КАК ЕдиницаИзмеренияКод,
		|	ЗаказКлиентаТовары.Упаковка.Числитель                КАК Числитель,
		|	ЗаказКлиентаТовары.Упаковка.Знаменатель              КАК Знаменатель,
		|	ЗаказКлиентаТовары.Склад                             КАК КонтекстСтрокиСклад
		|ИЗ
		|	Документ.ЗаказКлиента.Товары КАК ЗаказКлиентаТовары
		|ГДЕ
		|	ЗаказКлиентаТовары.Ссылка В(&СписокСсылок)"
		
	Иначе
		
		Возврат;
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("СписокСсылок", ПараметрКоманды);
	Товары = Запрос.Выполнить().Выгрузить();
	Товары.Колонки.Добавить("КонтекстСтроки");
	Для Каждого СтрокаТоваров Из Товары Цикл
		КонтекстСтроки = Новый Структура();
		Для Каждого Свойство из СтруктураКонтекстаСтроки Цикл
			ИмяРеквизита = СтрЗаменить(Свойство.Ключ, "КонтекстСтроки", "");
			КонтекстСтроки.Вставить(ИмяРеквизита, СтрокаТоваров[Свойство.Ключ])
		КонецЦикла;
		СтрокаТоваров.КонтекстСтроки = КонтекстСтроки;
		ЗаполнитьЗначенияСвойств(ТаблицаТовары.Добавить(), СтрокаТоваров);
	КонецЦикла;
	КонтекстИсточника = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрКоманды[0], ДополнительныеРеквизиты);
	
КонецПроцедуры

// Производит пересчет суммы для заказа товаров.
//
// Параметры:
//  СтрокаТоваровКорзины - Структура - реквизиты строки товаров для пересчета суммы при формировании заказов.
//                         См. ФормированиеЗаказов.ОписаниеСтрокиТаблицыТовары(), состав:
//    * ПроцентНДС      - Строка - значение НДС, полученное из сервиса.
//    * СтавкаНДС       - Ссылка - значение ставки НДС.
//    * Цена            - Число - цена товара для заказа.
//    * ЦенаВключаетНДС - Булево - признак включения НДС в цену.
//    * Количество      - Число - количество товара для заказа.
//    * Сумма           - Число - сумма заказа по строке.
//    * СуммаНДС        - Число - сумма НДС строки.
//    * СуммаСНДС       - Число - значение суммы с НДС.
//
Процедура ПересчитатьСуммуПоСтроке(СтрокаТоваровКорзины) Экспорт
	
	ПроцентНДС = ЦенообразованиеКлиентСервер.ПолучитьСтавкуНДСЧислом(СтрокаТоваровКорзины.СтавкаНДС);
	СтрокаТоваровКорзины.Сумма = СтрокаТоваровКорзины.Количество * СтрокаТоваровКорзины.Цена;
	СтрокаТоваровКорзины.СуммаНДС = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(СтрокаТоваровКорзины.Сумма, ПроцентНДС,
		СтрокаТоваровКорзины.ЦенаВключаетНДС);
	Если СтрокаТоваровКорзины.ЦенаВключаетНДС Тогда
		СтрокаТоваровКорзины.СуммаСНДС = СтрокаТоваровКорзины.Сумма;
	Иначе
		СтрокаТоваровКорзины.СуммаСНДС = СтрокаТоваровКорзины.Сумма + СтрокаТоваровКорзины.СуммаНДС;
	КонецЕсли;
	
КонецПроцедуры

// Устанавливаем условное оформление для единиц измерения номенклатуры.
//
// Параметры:
// 	 Форма - Форма - управляемая форму.
// 	 ИмяПоляВводаЕдиницИзмерения - Строка - наименование элемента формы, содержащего ед. измерения номенклатуры.
// 	 ПутьКПолюОтбора - Строка - полный путь к реквизиту.
//
Процедура УстановитьУсловноеОформлениеЕдиницИзмерения(Форма, Знач ИмяПоляВводаЕдиницИзмерения, Знач ПутьКПолюОтбора) Экспорт
	
	// См. процедуру НоменклатураСервер.УстановитьУсловноеОформлениеЕдиницИзмерения.
	НоменклатураСервер.УстановитьУсловноеОформлениеЕдиницИзмерения(Форма, ИмяПоляВводаЕдиницИзмерения, ПутьКПолюОтбора);
	
КонецПроцедуры

// Устанавливает значение свойства элементов формы, если находит элемент на форме.
//
// Параметры:
//  ЭлементыФормы  - ВсеЭлементыФормы - элементы формы, среди которых содержится искомый элемент.
//  ИменаЭлементов - Массив, Строка, Структура - имена искомых элементов.
//  ИмяСвойства    - Строка - имя свойства, для которого будет устанавливаться значение.
//  Значение       - Произвольный - значение, которое будет установлено.
//  УстанавливатьДляПодчиненных - Булево - установить аналогичное свойство для подчиненных элементов искомых элементов.
//
Процедура УстановитьСвойствоЭлементовФормы(ЭлементыФормы, ИменаЭлементов, ИмяСвойства, Значение, УстанавливатьДляПодчиненных = Ложь) Экспорт
	
	ОбщегоНазначенияУТКлиентСервер.УстановитьСвойствоЭлементовФормы(ЭлементыФормы, ИменаЭлементов, ИмяСвойства, Значение, УстанавливатьДляПодчиненных);
	
КонецПроцедуры

// Получение доступных типов значений свойств для сопоставления.
// 
// Возвращаемое значение:
//   СписокЗначений - доступные типы значений, например Тип("СправочникСсылка.Производители").
//
Функция ДоступныеТипыЗначенийСвойствДляСопоставления() Экспорт
	
	ДоступныеТипы = Новый СписокЗначений;
	ДоступныеТипы.Добавить(Тип("СправочникСсылка.ЗначенияСвойствОбъектов"));
	ДоступныеТипы.Добавить(Тип("СправочникСсылка.ЗначенияСвойствОбъектовИерархия"));
	ДоступныеТипы.Добавить(Тип("СправочникСсылка.Производители"));
	ДоступныеТипы.Добавить(Тип("СправочникСсылка.Марки"));
	
	Возврат ДоступныеТипы;
	
КонецФункции

// Возвращает пустую ссылку реквизита объекта для сопоставления.
// 
// Возвращаемое значение:
//  ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения - пустая ссылка для заполнения.
//
Функция ПустаяСсылкаРеквизитаОбъектаДляСопоставления() Экспорт
	
	Возврат ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПустаяСсылка();
	
КонецФункции

// Получение реквизитов номенклатуры поставщика.
//
// Параметры:
//  НоменклатураПоставщиков	- Массив - список ссылок справочника номенклатура поставщика.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - состав колонок:
//    * НоменклатураПоставщика       - СправочникСсылка - ссылка справочника номенклатура поставщика.
//    * Номенклатура                 - СправочникСсылка - ссылка справочника 
//    * ИспользованиеХарактеристик   - Булево - признак использования характеристик номенклатуры.
//    * Упаковка                     - СправочникСсылка - упаковка номенклатуры.
//    * ХарактеристикаНоменклатуры   - СправочникСсылка - характеристика номенклатуры.
//    * ЕдиницаИзмеренияНоменклатуры - СправочникСсылка - единица измерения номенклатуры.
//
Функция РеквизитыНоменклатурыПоставщика(Знач НоменклатураПоставщиков) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НоменклатураПоставщиков.Ссылка КАК НоменклатураПоставщика,
	|	НоменклатураПоставщиков.Номенклатура КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА НоменклатураПоставщиков.Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.НеИспользовать)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИспользованиеХарактеристик,
	|	НоменклатураПоставщиков.Упаковка КАК Упаковка,
	|	НоменклатураПоставщиков.Характеристика КАК ХарактеристикаНоменклатуры,
	|	НоменклатураПоставщиков.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияНоменклатуры
	|ИЗ
	|	Справочник.НоменклатураПоставщиков КАК НоменклатураПоставщиков
	|ГДЕ
	|	НоменклатураПоставщиков.Ссылка В(&НоменклатураПоставщиков)";
	
	Запрос.УстановитьПараметр("НоменклатураПоставщиков", НоменклатураПоставщиков);
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат;
	
КонецФункции

// Заполнение пакета торговых предложений.
//
// Параметры:
//  ТорговоеПредложение	 - СправочникСсылка - ссылка на элемент справочника определяющего торговые предложения,
//                                            например СправочникСсылка.Соглашения.
//  ПакетПредложений	 - Структура - свойства публикуемого торгового предложения.
//                         см. ТорговыеПредложения.ОписаниеПакетаПредложений().
//
Процедура ЗаполнитьПакетПредложений(Знач ТорговоеПредложение, ПакетПредложений) Экспорт
	
	// Заполнение общих реквизитов
	
	Реквизиты = "Статус, ДатаНачалаДействия, ДатаОкончанияДействия, Организация, Менеджер, СегментПартнеров,
		|СегментНоменклатуры, ВидЦен, ЦенаВключаетНДС, Контрагент, Партнер, Типовое, Валюта";
	
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ТорговоеПредложение, Реквизиты);
	ЗначенияРеквизитов.Вставить("Действует", ЗначенияРеквизитов.Статус = Перечисления.СтатусыСоглашенийСКлиентами.Действует);
	ЗаполнитьЗначенияСвойств(ПакетПредложений, ЗначенияРеквизитов);
	
	// Заполнение контактной информации.
	ИННКППОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗначенияРеквизитов.Организация, "ИНН, КПП");
	
	ПакетПредложений.КонтактыОрганизации.ИНН   = ИННКППОрганизации.ИНН;
	ПакетПредложений.КонтактыОрганизации.КПП   = ?(ПустаяСтрока(ИННКППОрганизации.КПП), "0", ИННКППОрганизации.КПП);
	ПакетПредложений.КонтактыОрганизации.Телефон = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ЗначенияРеквизитов.Организация,
		Справочники.ВидыКонтактнойИнформации.ТелефонОрганизации, ТекущаяДатаСеанса());
	ПакетПредложений.КонтактыОрганизации.ЭлектроннаяПочта = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ЗначенияРеквизитов.Организация,
		Справочники.ВидыКонтактнойИнформации.EmailОрганизации, ТекущаяДатаСеанса());
	
	ПакетПредложений.КонтактноеЛицо.ФИО  = Строка(ЗначенияРеквизитов.Менеджер);
	ПакетПредложений.КонтактноеЛицо.Телефон = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ЗначенияРеквизитов.Менеджер,
		Справочники.ВидыКонтактнойИнформации.ТелефонПользователя, ТекущаяДатаСеанса());
	ПакетПредложений.КонтактноеЛицо.ЭлектроннаяПочта = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ЗначенияРеквизитов.Менеджер,
		Справочники.ВидыКонтактнойИнформации.EmailПользователя, ТекущаяДатаСеанса());
		
	// Заполнение сегмента контрагентов.
	ЗаполнитьКонтрагентовПакетаПредложений(ТорговоеПредложение, ПакетПредложений.СписокКонтрагентов);
	
	// Заполнение товаров.
	ЗаполнитьТоварыПакетаПредложений(ПакетПредложений, ТорговоеПредложение, ЗначенияРеквизитов);
		
КонецПроцедуры

// Заполнение контактной информации по контактному лицу.
//
// Параметры:
//  КонтактноеЛицо    - СправочникСсылка - контактное лицо в информационной базе, например СправочникСсылка.ФизическиеЛица.
//  ЭлектроннаяПочта  - Строка - адрес электронной почты.
//  Телефон           - Строка - номер телефона.
//  УведомлятьПоПочте - Булево - признак необходимости уведомления по электронной почте.
//  Перезаполнять     - Булево - признак необходимости перезаполнения информации.
//
Процедура ЗаполнитьКонтактнуюИнформациюПоКонтактномуЛицу(Знач КонтактноеЛицо, ЭлектроннаяПочта, Телефон, УведомлятьПоПочте, Знач Перезаполнять = Ложь) Экспорт
	
	Если ТипЗнч(КонтактноеЛицо) = Тип("СправочникСсылка.ФизическиеЛица") и Не КонтактноеЛицо.Пустая() Тогда
		Если ПустаяСтрока(ЭлектроннаяПочта) или Перезаполнять Тогда
			ЭлектроннаяПочта = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(КонтактноеЛицо, Справочники.ВидыКонтактнойИнформации.EMailФизическиеЛица);
		КонецЕсли;
		Если ПустаяСтрока(Телефон) или Перезаполнять Тогда
			Телефон = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(КонтактноеЛицо, Справочники.ВидыКонтактнойИнформации.ТелефонМобильныйФизическиеЛица);
		КонецЕсли;
	КонецЕсли;
	
	УведомлятьПоПочте = Не ПустаяСтрока(ЭлектроннаяПочта);
	
КонецПроцедуры

// Заполнение реквизитов номенклатуры в процедуре формирования заказа.
// См. Обработка.ТорговыеПредложения.Форма.ФормированиеЗаказов.
//
// Параметры:
//  Номенклатура - СправочникСсылка - ссылка на справочник номенклатура.
//  Результат	 - Структура - возвращаемые реквизиты ссылки справочника, состав:
//    ИспользованиеХарактеристик - Булево - признак использования характеристик номенклатуры.
//    ЕдиницаИзмерения - СправочникСсылка - единица измерения номенклатуры.
//    НоменклатураПоставщика - СправочникСсылка - пустая ссылка номенклатура поставщика.
//
Процедура ЗаполнитьРеквизитыНоменклатурыДляФормированияЗаказа(Знач Номенклатура, Результат) Экспорт
	
	Результат.ИспользованиеХарактеристик = Ложь;
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		Результат.ИспользованиеХарактеристик = Не ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Номенклатура, "ИспользованиеХарактеристик") = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.НеИспользовать;
	КонецЕсли;
	
	Результат.ЕдиницаИзмерения = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Номенклатура, "ЕдиницаИзмерения");
	Результат.НоменклатураПоставщика = ПредопределенноеЗначение("Справочник.НоменклатураПоставщиков.ПустаяСсылка");
	
КонецПроцедуры

// Инициализация динамического списка сопоставления номенклатуры в форме сопоставления номенклатуры.
// Заполняется переопределяемый текст запроса и свойства списка.
// См. форму обработки ТорговыеПредложения.СопоставлениеНоменклатуры.
//
// Параметры:
//  Список - ДинамическийСписок - динамический список в форме.
//
Процедура ИнициализацияСпискаСопоставленияНоменклатуры(Список) Экспорт
	
	Список.ТекстЗапроса =
	"ВЫБРАТЬ
	|	СправочникВидыНоменклатуры.Ссылка КАК Ссылка,
	|	СправочникВидыНоменклатуры.Наименование КАК Наименование,
	|	СоответствиеКатегорий.ПредставлениеКатегории КАК Категория,
	|	СоответствиеКатегорий.ИдентификаторКатегории КАК ИдентификаторКатегории
	|ИЗ
	|	Справочник.ВидыНоменклатуры КАК СправочникВидыНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеВидовНоменклатуры1СБизнесСеть КАК СоответствиеКатегорий
	|		ПО СправочникВидыНоменклатуры.Ссылка = СоответствиеКатегорий.ВидНоменклатуры";
	Список.ОсновнаяТаблица = "Справочник.ВидыНоменклатуры";
	Список.ДинамическоеСчитываниеДанных = Истина;
	
КонецПроцедуры

// Добавление служебных колонок в таблицу товары.
//
// Параметры:
//  Товары - ТаблицаЗначений - исходная таблица с товарами, колонки:
//    Обязательные поля:
//    * Номенклатура   - СправочникСсылка - номенклатурная позиция.
//    * Характеристика - СправочникСсылка - характеристика номенклатуры.
//    * Упаковка       - СправочникСсылка - упаковка номенклатуры.
//    * Количество     - Число - количество.
//    Заполняемые поля:
//    * УпаковкаЕдиницаИзмеренияКод - Строка - код упаковки.
//    * ЕдиницаИзмеренияКод         - Строка - код единицы измерения.
//    * УпаковкаЧислитель           - Число - числитель упаковки номенклатуры.
//    * УпаковкаЗнаменатель         - Число - знаменатель упаковки номенклатуры.
//    * ШтрихКод                    - Массив - штрихкоды номенклатуры.
//    * Артикул                     - Строка - артикул номенклатуры.
//    * Наименование                - Строка - наименование номенклатуры.
//  ПолучатьШтрихКоды - Булево - признак необходимости заполнения штрихкодов номенклатуры.
//                               Для значения Ложь, штрихкоды не заполняются.
//
Процедура ДобавитьСлужебныеКолонкиТовары(Товары, Знач ПолучатьШтрихКоды = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Товары.Номенклатура КАК Справочник.Номенклатура)                 КАК Номенклатура,
	|	ВЫРАЗИТЬ(Товары.Характеристика КАК Справочник.ХарактеристикиНоменклатуры) КАК Характеристика,
	|	ВЫРАЗИТЬ(Товары.Упаковка КАК Справочник.УпаковкиЕдиницыИзмерения)         КАК Упаковка,
	|	ВЫРАЗИТЬ(Товары.Количество КАК ЧИСЛО(15, 3))                              КАК Количество
	|ПОМЕСТИТЬ Товары
	|ИЗ
	|	&Товары КАК Товары
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура.Артикул                          КАК Артикул,
	|	Товары.Номенклатура.Наименование                     КАК Наименование,
	|	Товары.Номенклатура                                  КАК Номенклатура,
	|	Товары.Характеристика                                КАК Характеристика,
	|	СоответствиеВидовНоменклатуры.ИдентификаторКатегории КАК ИдентификаторКатегории,
	|	Товары.Упаковка                                      КАК Упаковка,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка.Знаменатель = 0
	|			ТОГДА 1
	|		ИНАЧЕ Товары.Упаковка.Знаменатель
	|	КОНЕЦ                                                КАК УпаковкаЗнаменатель,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка.Числитель = 0
	|			ТОГДА 1
	|		ИНАЧЕ Товары.Упаковка.Числитель
	|	КОНЕЦ                                                КАК УпаковкаЧислитель,
	|	Товары.Количество                                    КАК Количество,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка.Знаменатель = 0
	|			ТОГДА ПРЕДСТАВЛЕНИЕ(Товары.Упаковка)
	|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(Товары.Упаковка.ЕдиницаИзмерения)
	|	КОНЕЦ                                                КАК ЕдиницаИзмеренияНаименование,
	|	ВЫБОР
	|		КОГДА Товары.Упаковка.Знаменатель = 0
	|			ТОГДА Товары.Упаковка.Код
	|		ИНАЧЕ Товары.Упаковка.ЕдиницаИзмерения.Код
	|	КОНЕЦ                                                КАК УпаковкаЕдиницаИзмеренияКод,
	|	Товары.Номенклатура.ЕдиницаИзмерения.Код             КАК ЕдиницаИзмеренияКод
	|ИЗ
	|	Товары КАК Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеВидовНоменклатуры1СБизнесСеть КАК СоответствиеВидовНоменклатуры
	|		ПО Товары.Номенклатура.ВидНоменклатуры = СоответствиеВидовНоменклатуры.ВидНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура            КАК Номенклатура,
	|	Товары.Характеристика          КАК Характеристика,
	|	Товары.Упаковка                КАК Упаковка,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК Штрихкод
	|ИЗ
	|	Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|		ПО Товары.Номенклатура = ШтрихкодыНоменклатуры.Номенклатура
	|			И Товары.Характеристика = ШтрихкодыНоменклатуры.Характеристика
	|			И Товары.Упаковка = ШтрихкодыНоменклатуры.Упаковка";
	
	Запрос.УстановитьПараметр("Товары", Товары);
	
	РезультатПакета = Запрос.ВыполнитьПакет();
	Выборка = РезультатПакета[1].Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СтрокаТовары = Товары.НайтиСтроки(Новый Структура("Номенклатура, Характеристика, Упаковка",
			Выборка.Номенклатура, Выборка.Характеристика, Выборка.Упаковка));
		Если СтрокаТовары <> Неопределено Тогда
			ЗаполнитьЗначенияСвойств(СтрокаТовары[0], Выборка,, "Номенклатура, Характеристика, Упаковка");
		КонецЕсли;
	КонецЦикла;
	
	Если ПолучатьШтрихКоды Тогда
		ВыборкаШтрихКоды = РезультатПакета[2].Выбрать();
		Пока ВыборкаШтрихКоды.Следующий() Цикл
			СтрокаТовары = Товары.НайтиСтроки(Новый Структура("Номенклатура, Характеристика, Упаковка",
				ВыборкаШтрихКоды.Номенклатура, ВыборкаШтрихКоды.Характеристика, ВыборкаШтрихКоды.Упаковка));
				
			Если СтрокаТовары <> Неопределено Тогда
				Если СтрокаТовары[0].ШтрихКоды = Неопределено Тогда
					МассивШтрихКодов = Новый Массив;
					МассивШтрихКодов.Добавить(ВыборкаШтрихКоды.ШтрихКод);
					СтрокаТовары[0].ШтрихКоды = МассивШтрихКодов;
				Иначе
					СтрокаТовары[0].ШтрихКоды.Добавить(ВыборкаШтрихКоды.ШтрихКод);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

// Текст запроса соответствия значений реквизитов вида номенклатуры.
// 
// Необходимо вернуть таблицу содержащее количество значений реквизита в информационной базе
// и количество сопоставленных реквизитов.
// Параметры запроса: &РеквизитОбъекта, &ВидНоменклатуры.
// Поля запроса: КоличествоЗначенийРеквизита, КоличествоСопоставленныхРеквизитов.
//
// Возвращаемое значение:
//  Строка - текст запроса.
//
Функция ТекстЗапросаСоответствияЗначенийРеквизитовВидаНоменклатуры() Экспорт
	
	ТекстЗапроса = "ВЫБРАТЬ
	|	""Номенклатура.Производитель"" КАК РеквизитОбъекта,
	|	Производители.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Справочник_Производители
	|ИЗ
	|	Справочник.Производители КАК Производители
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""Номенклатура.Марка"" КАК РеквизитОбъекта,
	|	Марки.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Справочник_Марки
	|ИЗ
	|	Справочник.Марки КАК Марки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.РеквизитОбъекта КАК РеквизитОбъекта,
	|	ВложенныйЗапрос.КоличествоЗначенийРеквизита КАК КоличествоЗначенийРеквизита,
	|	ВложенныйЗапрос.КоличествоСопоставленныхРеквизитов КАК КоличествоСопоставленныхРеквизитов
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаРеквизитов.Свойство КАК РеквизитОбъекта,
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЗначенияСвойствОбъектов.Ссылка) КАК КоличествоЗначенийРеквизита,
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение) КАК КоличествоСопоставленныхРеквизитов
	|	ИЗ
	|		Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК ТаблицаРеквизитов
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|				ПО (ЗначенияСвойствОбъектов.Владелец В (СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта, СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта.ВладелецДополнительныхЗначений))
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|				ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|			ПО ТаблицаРеквизитов.Свойство = СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта
	|				И (ТаблицаРеквизитов.Ссылка = &ВидНоменклатуры
	|					ИЛИ ТаблицаРеквизитов.Ссылка.Родитель В (ЗНАЧЕНИЕ(Справочник.НаборыДополнительныхРеквизитовИСведений.Справочник_Номенклатура), ЗНАЧЕНИЕ(Справочник.НаборыДополнительныхРеквизитовИСведений.Справочник_ХарактеристикиНоменклатуры)))
	|	ГДЕ
	|		(ВЫРАЗИТЬ(ТаблицаРеквизитов.Свойство КАК ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения)) = &РеквизитОбъекта
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаРеквизитов.Свойство
	|	
	|	ОБЪЕДИНИТЬ
	|	
	|	ВЫБРАТЬ
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта,
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Справочник_Производители.Ссылка),
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение)
	|	ИЗ
	|		РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник_Производители КАК Справочник_Производители
	|			ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = Справочник_Производители.РеквизитОбъекта
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|			ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|				И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры
	|	ГДЕ
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|		И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = ""Номенклатура.Производитель""
	|	
	|	СГРУППИРОВАТЬ ПО
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта
	|	
	|	ОБЪЕДИНИТЬ
	|	
	|	ВЫБРАТЬ
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта,
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Справочник_Марки.Ссылка),
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение)
	|	ИЗ
	|		РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник_Марки КАК Справочник_Марки
	|			ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = Справочник_Марки.РеквизитОбъекта
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|			ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|				И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры
	|	ГДЕ
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|		И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = ""Номенклатура.Марка""
	|	
	|	СГРУППИРОВАТЬ ПО
	|		СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта) КАК ВложенныйЗапрос
	|ГДЕ
	|	ВложенныйЗапрос.РеквизитОбъекта = &РеквизитОбъекта";

	
	Возврат ТекстЗапроса;
	
КонецФункции

// Получение сопоставленных значений реквизита вида номенклатуры.
//
// Параметры:
//  ВидНоменклатуры	 - СправочникСсылка - ссылка на справочник виды номенклатуры.
//  РеквизитОбъекта	 - Строка, СправочникСсылка - реквизит объекта.
//  ТипЗначения	      - ОписаниеТипов - тип значений реквизита.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - список сопоставленных реквизитов, колонки:
//   * Значение                                - СправочникСсылка, Строка, Число, Булево - сопоставленное значение.
//   * ИдентификаторЗначенияРеквизитаКатегории - Строка - идентификатор сопоставленного значения.
//   * ПредставлениеЗначенияРеквизитаКатегории - Строка - представление сопоставленного значения.
//   * Автоподстановка                         - Булево - признак автоматического сопоставления значения.
//
Функция СопоставленныеЗначенияРеквизитаВидаНоменклатуры(Знач ВидНоменклатуры, Знач РеквизитОбъекта, Знач ТипЗначения) Экспорт
	
	// Вывод в список всех реквизитов в ИБ.
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Ссылка КАК Ссылка,
	|	ЗначенияСвойствОбъектов.Владелец КАК Владелец
	|ПОМЕСТИТЬ ЗначенияСвойствОбъектов
	|ИЗ
	|	Справочник.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|ГДЕ
	|	ЗначенияСвойствОбъектов.Владелец В
	|			(ВЫБРАТЬ
	|				ВЫБОР
	|					КОГДА ДополнительныеРеквизитыИСведения.ВладелецДополнительныхЗначений = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПустаяСсылка)
	|						ТОГДА &Владелец
	|					ИНАЧЕ ДополнительныеРеквизитыИСведения.ВладелецДополнительныхЗначений
	|				КОНЕЦ КАК Поле1
	|			ИЗ
	|				ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения КАК ДополнительныеРеквизитыИСведения
	|			ГДЕ
	|				ДополнительныеРеквизитыИСведения.Ссылка = &Владелец)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗначенияСвойствОбъектовИерархия.Ссылка,
	|	ЗначенияСвойствОбъектовИерархия.Владелец
	|ИЗ
	|	Справочник.ЗначенияСвойствОбъектовИерархия КАК ЗначенияСвойствОбъектовИерархия
	|ГДЕ
	|	ЗначенияСвойствОбъектовИерархия.Владелец = &Владелец
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗначенияСвойствОбъектов.Ссылка КАК Значение,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.ИдентификаторЗначенияРеквизитаКатегории КАК ИдентификаторЗначенияРеквизитаКатегории,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.ПредставлениеЗначенияРеквизитаКатегории КАК ПредставлениеЗначенияРеквизитаКатегории,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.Автоподстановка КАК Автоподстановка
	|ИЗ
	|	ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ПО ЗначенияСвойствОбъектов.Ссылка = СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение
	|			И (СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Значение
	|АВТОУПОРЯДОЧИВАНИЕ";	
	
	Если ТипЗнч(РеквизитОбъекта) = Тип("Строка") Тогда
		
		// Модификация запроса для получения значений справочника.
		Тип = ТипЗначения.Типы()[0];
		ОбъектМетаданных = Метаданные.НайтиПоТипу(Тип);
		Если ОбъектМетаданных = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ЗначенияСвойствОбъектовИерархия", "." + ОбъектМетаданных.Имя);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ЗначенияСвойствОбъектовИерархия.Владелец = &Владелец", "ИСТИНА");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ЗначенияСвойствОбъектовИерархия.Владелец", "NULL");
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Владелец", РеквизитОбъекта);
	Запрос.УстановитьПараметр("ВидНоменклатуры", ВидНоменклатуры);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Заполнение реквизитов заказов.
//
// Параметры:
//  ТаблицаЗаказов	 - ТаблицаЗначений - таблица с ссылками и реквизитами для заполнения.
//                     см. ТорговыеПредложения.ФормированиеЗаказов.Заказы.
//
Процедура ЗаполнитьРеквизитыЗаказов(ТаблицаЗаказов) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаказПоставщику.Ссылка,
	|	ЗаказПоставщику.Контрагент,
	|	ЗаказПоставщику.Организация,
	|	ЗаказПоставщику.СуммаДокумента,
	|	ЗаказПоставщику.Валюта,
	|	ВЫБОР
	|		КОГДА ЗаказПоставщику.Проведен
	|			ТОГДА 1
	|		КОГДА ЗаказПоставщику.ПометкаУдаления
	|			ТОГДА 2
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЗначениеКартинки
	|ИЗ
	|	Документ.ЗаказПоставщику КАК ЗаказПоставщику
	|ГДЕ
	|	ЗаказПоставщику.Ссылка В(&СписокДокументов)
	|АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("СписокДокументов", ТаблицаЗаказов.ВыгрузитьКолонку("Ссылка"));
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СтрокаТаблицы = ТаблицаЗаказов.Найти(Выборка.Ссылка, "Ссылка");
		Если СтрокаТаблицы = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, Выборка);
	КонецЦикла;
	
КонецПроцедуры

// Получение значение перечисления по наименованию.
// Обратное преобразование см. ОбщегоНазначения.ИмяЗначенияПеречисления().
//
// Параметры:
//  ИмяПеречисления      - Строка - наименование метаданных перечисления, например "СтавкаНДС".
//  НаименованиеЗначения - Строка - наименование значения перечисления, например "БезНДС".
// 
// Возвращаемое значение:
//  ПеречислениеСсылка - значение перечисления.
//
Функция ЗначениеПеречисленияПоНаименованию(Знач ИмяПеречисления, Знач НаименованиеЗначения) Экспорт
	
	Результат = Неопределено;
	Если ИмяПеречисления = "СтавкаНДС" Тогда // Перечисления.СтавкиНДС.
		Если Не ПустаяСтрока(НаименованиеЗначения)
			И Метаданные.Перечисления.СтавкиНДС.ЗначенияПеречисления.Найти(НаименованиеЗначения) <> Неопределено Тогда
			Результат = Перечисления.СтавкиНДС[НаименованиеЗначения];
		Иначе
			Результат = Перечисления.СтавкиНДС.БезНДС;
		КонецЕсли;
	КонецЕсли;
	Возврат Результат;
	
КонецФункции

// Публикуемые реквизиты номенклатуры.
// 
// Возвращаемое значение:
//  Соответствие - реквизиты справочника Номенклатура, публикуемые для торговых предложений.
//    * Ключ     - Строка - наименование реквизита справочника.
//    * Значение - Структура - свойства реквизита:
//      ** Представление    - Строка - наименование для отображения.
//      ** ПсевдонимТаблицы - Строка - псевдоним для таблицы данных.
//      ** ПутьКДанным      - Строка - текст запроса для получения данных.
//      ** ТипЗначения      - ТипЗначения - тип данных.
//      ** ПустоеЗначение   - Произвольный - Значение реквизита, при котором, он считается не заполненным.
//
Функция РеквизитыНоменклатурыДоступныеДляПубликации() Экспорт
	
	Реквизиты = Новый Соответствие;
	
	// Номенклатура.Вес.
	СвойстваРеквизита = Новый Структура();
	СвойстваРеквизита.Вставить("ПсевдонимТаблицы", "Номенклатура");
	СвойстваРеквизита.Вставить("ПутьКДанным",
		"ВЫБОР КОГДА Номенклатура.ВесИспользовать И Номенклатура.ВесЗнаменатель <> 0 ТОГДА
		|	Номенклатура.ВесЧислитель/Номенклатура.ВесЗнаменатель ИНАЧЕ 0 КОНЕЦ");
	СвойстваРеквизита.Вставить("ТипЗначения", Новый ОписаниеТипов("Число"));
	СвойстваРеквизита.Вставить("ПустоеЗначение", 0);
	Реквизиты.Вставить("Номенклатура.Вес", СвойстваРеквизита);
		
	// Номенклатура.Длина.
	СвойстваРеквизита = Новый Структура();
	СвойстваРеквизита.Вставить("ПсевдонимТаблицы", "Номенклатура");
	СвойстваРеквизита.Вставить("ПутьКДанным",
		"ВЫБОР КОГДА Номенклатура.ДлинаИспользовать И Номенклатура.ДлинаЗнаменатель <> 0 ТОГДА
		|	Номенклатура.ДлинаЧислитель/Номенклатура.ДлинаЗнаменатель ИНАЧЕ 0 КОНЕЦ");
	СвойстваРеквизита.Вставить("ТипЗначения", Новый ОписаниеТипов("Число"));
	СвойстваРеквизита.Вставить("ПустоеЗначение", 0);
	Реквизиты.Вставить("Номенклатура.Длина", СвойстваРеквизита);
	
	// Номенклатура.Объем.
	СвойстваРеквизита = Новый Структура();
	СвойстваРеквизита.Вставить("ПсевдонимТаблицы", "Номенклатура");
	СвойстваРеквизита.Вставить("ПутьКДанным",
		"ВЫБОР КОГДА Номенклатура.ОбъемИспользовать И Номенклатура.ОбъемЗнаменатель <> 0 ТОГДА
		|	Номенклатура.ОбъемЧислитель/Номенклатура.ОбъемЗнаменатель ИНАЧЕ 0 КОНЕЦ");
	СвойстваРеквизита.Вставить("ТипЗначения", Новый ОписаниеТипов("Число"));
	СвойстваРеквизита.Вставить("ПустоеЗначение", 0);
	Реквизиты.Вставить("Номенклатура.Объем", СвойстваРеквизита);
	
	// Номенклатура.Производитель.
	СвойстваРеквизита = Новый Структура();
	СвойстваРеквизита.Вставить("ПсевдонимТаблицы", "Номенклатура");
	СвойстваРеквизита.Вставить("ПутьКДанным", "Номенклатура.Производитель");
	СвойстваРеквизита.Вставить("ТипЗначения", Новый ОписаниеТипов("СправочникСсылка.Производители"));
	СвойстваРеквизита.Вставить("ПустоеЗначение", Справочники.Производители.ПустаяСсылка());
	Реквизиты.Вставить("Номенклатура.Производитель", СвойстваРеквизита);
	
	// Номенклатура.Марка.
	СвойстваРеквизита = Новый Структура();
	СвойстваРеквизита.Вставить("ПсевдонимТаблицы", "Номенклатура");
	СвойстваРеквизита.Вставить("ПутьКДанным", "Номенклатура.Марка");
	СвойстваРеквизита.Вставить("ТипЗначения", Новый ОписаниеТипов("СправочникСсылка.Марки"));
	СвойстваРеквизита.Вставить("ПустоеЗначение", Справочники.Марки.ПустаяСсылка());
	Реквизиты.Вставить("Номенклатура.Марка", СвойстваРеквизита);
	
	Возврат Реквизиты;
	
КонецФункции

// Процедура, вызываемая из обработчика события формы ПриСозданииНаСервере.
//
// Параметры:
//  Форма - УправляемаяФорма - из обработчика события которой происходит вызов процедуры.
//
Процедура ПриСозданииНаСервере(Форма) Экспорт
	
	Если Найти(Форма.ИмяФормы, "ПоискПредложенийПоТоварам") Тогда
		
		ГруппЭлементов = Форма.Элементы.Найти("ГруппаКоманднойПанелиПереопределяемая");
		Если ГруппЭлементов = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		ИмяКоманды = ГруппЭлементов.Имя + "ВставкаИзБуфера";
		
		Если Форма.Команды.Найти(ИмяКоманды) <> Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		// Формирование команды вставки из буфера.
		КомандаФормы = Форма.Команды.Добавить(ИмяКоманды);
		КомандаФормы.Действие = "Подключаемый_ПереопределяемаяКоманда";
		КомандаФормы.Заголовок = "Вставка из буфера";
		КомандаФормы.ИзменяетСохраняемыеДанные = Истина;
		КомандаФормы.Отображение = ОтображениеКнопки.Картинка;
		КомандаФормы.Картинка = БиблиотекаКартинок.ВставитьИзБуфераОбмена;
		КомандаФормы.СочетаниеКлавиш = Новый СочетаниеКлавиш(Клавиша.V, , Истина, Истина);
		КомандаФормы.Подсказка = "Вставка из буфера";
		КнопкаФормы = Форма.Элементы.Добавить("ТоварыВставитьСтроки", Тип("КнопкаФормы"), ГруппЭлементов);
		КнопкаФормы.Вид = ВидКнопкиФормы.ОбычнаяКнопка;
		КнопкаФормы.ИмяКоманды = ИмяКоманды;
		
		// Формирование команды вставки из буфера.
		ИмяКоманды = ГруппЭлементов.Имя + "ПодобратьТовары";
		КомандаФормы = Форма.Команды.Добавить(ИмяКоманды);
		КомандаФормы.Действие = "Подключаемый_ПереопределяемаяКоманда";
		КомандаФормы.Заголовок = "Подобрать товары";
		КомандаФормы.ИзменяетСохраняемыеДанные = Истина;
		КомандаФормы.Отображение = ОтображениеКнопки.КартинкаИТекст;
		КомандаФормы.Картинка = БиблиотекаКартинок.ПодобратьТовары;
		КомандаФормы.Подсказка = "Открыть подбор товаров";
		КнопкаФормы = Форма.Элементы.Добавить("ПодобратьТовары", Тип("КнопкаФормы"), ГруппЭлементов);
		КнопкаФормы.Вид = ВидКнопкиФормы.ОбычнаяКнопка;
		КнопкаФормы.ИмяКоманды = ИмяКоманды;
		
		УстановитьДоступностьКомандБуфераОбмена(Форма);
		
	КонецЕсли;
	
КонецПроцедуры

// Обработка переопределяемого метода с возвратом результата.
//
// Параметры:
//  ИмяМетода				 - Строка - имя переопределяемого метода.
//  ДополнительныеПараметры	 - Структура - передаваемые параметры.
// 
// Возвращаемое значение:
//  Произвольный - возвращаемое значение исполняемого метода.
//
Функция ОбработатьПереопределяемыйМетод(ИмяМетода, ДополнительныеПараметры) Экспорт
	
	Если ИмяМетода = "ПолучитьСтрокиИзБуфераОбмена" Тогда
		
		Возврат ПолучитьСтрокиИзБуфераОбмена(ДополнительныеПараметры);
		
	КонецЕсли;
	
КонецФункции

// Обработка выбора формы (переопределяемое события).
// Вызов производится на сервере. См. описание метода ОбработкаВыбора.
//
// Параметры:
//  Форма				 - УправляемаяФорма - форма источник события.
//  ВыбранноеЗначение	 - Произвольный - выбранное событие.
//  ИсточникВыбора		 - Произвольный - форма, где осуществлен выбор.
//
Процедура ОбработатьВыбор(Форма, Знач ВыбранноеЗначение, Знач ИсточникВыбора) Экспорт
	
	Если ИсточникВыбора.ИмяФормы = "Обработка.ПодборТоваровПоОтбору.Форма.Форма"
		И Форма.ИмяФормы = "Обработка.ТорговыеПредложения.Форма.ПоискПредложенийПоТоварам" Тогда
		
		ТаблицаТоваров = ПолучитьИзВременногоХранилища(ВыбранноеЗначение.АдресТоваровВХранилище);
		
		ЕдиницыИзмеренияНоменклатуры = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(
			ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура"),
			"ЕдиницаИзмерения");
		
		Для Каждого СтрокаТовара Из ТаблицаТоваров Цикл
			
			ТекущаяСтрока = Форма.Список.Добавить();
			ЗаполнитьЗначенияСвойств(ТекущаяСтрока, СтрокаТовара);
			
			ТекущаяСтрока.Упаковка = ЕдиницыИзмеренияНоменклатуры.Получить(СтрокаТовара.Номенклатура);
			ТекущаяСтрока.Количество = 1;
			
		КонецЦикла;
		
	КонецЕсли;
		
КонецПроцедуры

// Обработка оповещения формы (переопределяемое событие).
// Вызывается на сервере. См. метод ОбработкаОповещения.
//
// Параметры:
//  Форма      - УправляемаяФорма - форма источник события.
//  ИмяСобытия - Строка - имя оповещения.
//
Процедура ОбработатьОповещение(Форма, Знач ИмяСобытия) Экспорт
	
	Если ИмяСобытия = "КопированиеСтрокВБуферОбмена"
		И Форма.ИмяФормы = "Обработка.ТорговыеПредложения.Форма.ПоискПредложенийПоТоварам" Тогда
		
		УстановитьДоступностьКомандБуфераОбмена(Форма);
		
	КонецЕсли;
	
КонецПроцедуры

// Получение данных для сопоставления реквизитов и значений реквизитов информационной базы и сервиса.
//
// Параметры:
//  ВидНоменклатуры			 - СправочникСсылка - ссылка на справочник виды номенклатуры.
//  СопоставленныеРеквизиты	 - ТаблицаЗначений - сопоставленные реквизиты в ИБ.
//    * РеквизитОбъекта                 - Произвольный - реквизит.
//    * ИдентификаторРеквизитаКатегории - Строка - идентификатор реквизита категории в сервисе.
//  ДополнительныеРеквизиты	            - ТаблицаЗначений - дополнительные реквизиты номенклатуры.
//    * РеквизитОбъекта - Произвольный - реквизит.
//    * ТипЗначения      - ОписаниеТипов - тип реквизита.
//  РасчетСоответствий		 - ТаблицаЗначений - таблица количества соответствий значений реквизитов.
//    * РеквизитОбъекта                    - Произвольный - реквизит.
//    * КоличествоЗначенийРеквизита        - Число - количество значений реквизита в ИБ.
//    * КоличествоСопоставленныхРеквизитов - Число - количество сопоставленных значений реквизитов.
//
Процедура ПолучитьДанныеСопоставленияРеквизитов(ВидНоменклатуры, СопоставленныеРеквизиты, ДополнительныеРеквизиты, РасчетСоответствий) Экспорт
	
	// Заполнение списка набора реквизитов.
	Запрос = Новый Запрос;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДоступныеРеквизиты.РеквизитОбъекта КАК РеквизитОбъекта
	|ПОМЕСТИТЬ ДоступныеРеквизиты
	|ИЗ
	|	&ДоступныеРеквизиты КАК ДоступныеРеквизиты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДополнительныеРеквизиты.Свойство КАК РеквизитОбъекта,
	|	ДополнительныеРеквизиты.Свойство.ТипЗначения КАК ТипЗначения
	|ПОМЕСТИТЬ ТаблицаРеквизитов
	|ИЗ
	|	Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК ДополнительныеРеквизиты
	|ГДЕ
	|	ДополнительныеРеквизиты.Ссылка В
	|			(ВЫБРАТЬ
	|				ВидыНоменклатуры.НаборСвойств
	|			ИЗ
	|				Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
	|			ГДЕ
	|				ВидыНоменклатуры.Ссылка = &ВидНоменклатуры
	|		
	|			ОБЪЕДИНИТЬ ВСЕ
	|		
	|			ВЫБРАТЬ
	|				ВидыНоменклатуры.НаборСвойствХарактеристик
	|			ИЗ
	|				Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
	|			ГДЕ
	|				ВидыНоменклатуры.Ссылка = &ВидНоменклатуры
	|		
	|			ОБЪЕДИНИТЬ ВСЕ
	|		
	|			ВЫБРАТЬ
	|				&ОбщийРеквизитНоменклатура)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаРеквизитов.РеквизитОбъекта КАК РеквизитОбъекта,
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ИЗ
	|	ТаблицаРеквизитов КАК ТаблицаРеквизитов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|		ПО ТаблицаРеквизитов.РеквизитОбъекта = СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта
	|			И (СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ДоступныеРеквизиты.РеквизитОбъекта КАК СТРОКА(50)),
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ИдентификаторРеквизитаКатегории
	|ИЗ
	|	ДоступныеРеквизиты КАК ДоступныеРеквизиты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|		ПО ((ВЫРАЗИТЬ(ДоступныеРеквизиты.РеквизитОбъекта КАК СТРОКА(50))) = СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта)
	|			И (СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДоступныеРеквизиты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""Номенклатура.Производитель"" КАК РеквизитОбъекта,
	|	Производители.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Справочник_Производители
	|ИЗ
	|	Справочник.Производители КАК Производители
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""Номенклатура.Марка"" КАК РеквизитОбъекта,
	|	Марки.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ Справочник_Марки
	|ИЗ
	|	Справочник.Марки КАК Марки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаРеквизитов.РеквизитОбъекта КАК РеквизитОбъекта,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЗначенияСвойствОбъектов.Ссылка) КАК КоличествоЗначенийРеквизита,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение) КАК КоличествоСопоставленныхРеквизитов
	|ИЗ
	|	ТаблицаРеквизитов КАК ТаблицаРеквизитов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|			ПО (ЗначенияСвойствОбъектов.Владелец В (СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта, СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта.ВладелецДополнительныхЗначений))
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|			ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|		ПО ТаблицаРеквизитов.РеквизитОбъекта = СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаРеквизитов.РеквизитОбъекта
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Справочник_Производители.Ссылка),
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение)
	|ИЗ
	|	РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник_Производители КАК Справочник_Производители
	|		ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = Справочник_Производители.РеквизитОбъекта
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|			И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры
	|ГДЕ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|	И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = ""Номенклатура.Производитель""
	|
	|СГРУППИРОВАТЬ ПО
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Справочник_Марки.Ссылка),
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение)
	|ИЗ
	|	РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник_Марки КАК Справочник_Марки
	|		ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = Справочник_Марки.РеквизитОбъекта
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ПО СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта
	|			И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры
	|ГДЕ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|	И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта = ""Номенклатура.Марка""
	|
	|СГРУППИРОВАТЬ ПО
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта";
	
	СоответствиеРеквизитов = РеквизитыНоменклатурыДоступныеДляПубликации();
	Для Каждого Реквизит из СоответствиеРеквизитов Цикл
		НоваяСтрока = ДополнительныеРеквизиты.Добавить();
		НоваяСтрока.РеквизитОбъекта = Реквизит.Ключ;
		НоваяСтрока.ТипЗначения = Реквизит.Значение.ТипЗначения;
	КонецЦикла;
	Запрос.УстановитьПараметр("ВидНоменклатуры",           ВидНоменклатуры);
	Запрос.УстановитьПараметр("ДоступныеРеквизиты",        ДополнительныеРеквизиты);
	Запрос.УстановитьПараметр("ОбщийРеквизитНоменклатура", Справочники.НаборыДополнительныхРеквизитовИСведений.Справочник_Номенклатура_Общие);
	
	ПакетЗапросов = Запрос.ВыполнитьПакет();
	Выборка = ПакетЗапросов[2].Выбрать();
	Пока Выборка.Следующий() Цикл
		ЗаполнитьЗначенияСвойств(СопоставленныеРеквизиты.Добавить(), Выборка);
	КонецЦикла;
	
	ВременныйМассив = Новый Массив;
	Выборка = ПакетЗапросов[6].Выбрать();
	Пока Выборка.Следующий() Цикл
		ЗаполнитьЗначенияСвойств(РасчетСоответствий.Добавить(), Выборка);
	КонецЦикла;
	
КонецПроцедуры

// Получение свойств торгового предложения.
//
// Параметры:
//  Источник        - СправочникСсылка - источник торгового соглашения, например СправочникСсылка.Соглашения.
//  ЗначенияСвойств - Структура - возвращаемое значение заполнения.
//
Процедура ПолучитьСвойстваТорговогоПредложения(Знач Источник, ЗначенияСвойств) Экспорт
	
	ЗаполнитьЗначенияСвойств(ЗначенияСвойств,
		ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Источник, "Организация, Валюта"));
	
КонецПроцедуры

#КонецОбласти

#Область ПрограммныйИнтерфейсУП

// Добавление команды поиска торговых предложений в формах.
//
// Параметры:
//  КомандыСоздатьНаОсновании - ТаблицаЗначений - состав полей см. в функции ВводНаОсновании.СоздатьКоллекциюКомандСоздатьНаОсновании.
//
Процедура ДобавитьКомандуПоискаТорговыхПредложений(КомандыСоздатьНаОсновании) Экспорт
	
	Если ПравоДоступа("Просмотр", Метаданные.Обработки.ТорговыеПредложения) Тогда
		КомандаСоздатьНаОсновании =  КомандыСоздатьНаОсновании.Добавить();
		КомандаСоздатьНаОсновании.Обработчик = "ТорговыеПредложенияКлиентПереопределяемый.ОткрытьПоискТоваровПоСписку";
		КомандаСоздатьНаОсновании.Идентификатор = "ПоискТоваровПоСписку";
		КомандаСоздатьНаОсновании.Представление = НСтр("ru = 'Заказы поставщикам в 1С:Бизнес-сеть'");
		КомандаСоздатьНаОсновании.ПроверкаПроведенияПередСозданиемНаОсновании = Ложь;
		КомандаСоздатьНаОсновании.ФункциональныеОпции = "ИспользоватьОбменБизнесСеть";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Получение значений предопределенных реквизитов номенклатуры.
//
// Параметры:
//  Номенклатура							 - СправочникСсылка.Номенклатура - ссылка на справочник номенклатура.
//  ПредопределенныеРеквизитыНоменклатуры	 - Массив - список предопределенных реквизитов.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - таблица свойств и значений.
//
Функция ЗначенияПредопределенныхРеквизитовНоменклатуры(Номенклатура, ПредопределенныеРеквизитыНоменклатуры)
	
	Если ПредопределенныеРеквизитыНоменклатуры.Количество() Тогда
		
		ДоступныеДляПубликацииРеквизиты = РеквизитыНоменклатурыДоступныеДляПубликации();
		
		Запрос = Новый Запрос;
		ТекстыЗапроса = Новый Массив;
		СчетчикРеквизитов = 0;
		Для Каждого ПредопределенныйРеквизит из ПредопределенныеРеквизитыНоменклатуры Цикл
			СвойстваРеквизита = ДоступныеДляПубликацииРеквизиты.Получить(ПредопределенныйРеквизит.РеквизитОбъекта);
			Если СвойстваРеквизита <> Неопределено Тогда
				СчетчикРеквизитов = СчетчикРеквизитов + 1;
				ТекстыЗапроса.Добавить("ВЫБРАТЬ
				|	""" + ПредопределенныйРеквизит.РеквизитОбъекта + """ КАК Свойство,
				|	" + СвойстваРеквизита.ПутьКДанным + " КАК Значение
				|ИЗ
				|	Справочник.Номенклатура КАК "+ СвойстваРеквизита.ПсевдонимТаблицы +"
				|ГДЕ
				|	" + СвойстваРеквизита.ПсевдонимТаблицы + ".Ссылка = &Номенклатура
				|	" + ?(СвойстваРеквизита.Свойство("ПустоеЗначение"),
					"И Не "+ СвойстваРеквизита.ПутьКДанным + " = &ПустоеЗначение" + Формат(СчетчикРеквизитов,"ЧГ=") , ""));
					
				Если СвойстваРеквизита.Свойство("ПустоеЗначение") Тогда
					Запрос.УстановитьПараметр("ПустоеЗначение" + Формат(СчетчикРеквизитов,"ЧГ="),
						СвойстваРеквизита.ПустоеЗначение);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		Разделитель =
		"
		|ОБЪЕДИНИТЬ ВСЕ
		|";
		Запрос.Текст = СтрСоединить(ТекстыЗапроса, Разделитель);
		
		Если Не ПустаяСтрока(Запрос.Текст) Тогда
			Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
			Возврат Запрос.Выполнить().Выгрузить();
		КонецЕсли;
		
	КонецЕсли;
	
	ЗначенияПредопределенныхРеквизитов = Новый ТаблицаЗначений;
	ЗначенияПредопределенныхРеквизитов.Колонки.Добавить("Свойство", Новый ОписаниеТипов("Строка",,
																	Новый КвалификаторыСтроки(1, ДопустимаяДлина.Переменная)));
	ЗначенияПредопределенныхРеквизитов.Колонки.Добавить("Значение", Новый ОписаниеТипов("Строка",,
																	Новый КвалификаторыСтроки(1, ДопустимаяДлина.Переменная)));
	Возврат ЗначенияПредопределенныхРеквизитов;
	
КонецФункции

// Получение признака записи ведомого регистра сведений.
//
// Параметры:
//  Ссылка	 - Произвольный - ссылка на объект информационной базы.
//  Регистры - Массив - список регистров сведений.
// 
// Возвращаемое значение:
//  Булево - признак записи ведомого регистра.
//
Функция ЭтоЗаписьВедомогоРегистраСведений(Ссылка, Регистры)
	
	Для Каждого Элемент Из Регистры Цикл
		Если ТипЗнч(Ссылка) = Тип("РегистрСведенийКлючЗаписи." + Элемент.Имя) Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

// Получение дополнительных ссылок назначения заказов.
//
// Параметры:
//  УдалямыеСсылки	 - Массив - ссылки документов Заказ поставщику для удаления.
// 
// Возвращаемое значение:
//  СписокЗначений - дополнительные ссылки для удаления, тип СправочникСсылка.Назначения.
//
Функция НазначенияЗаказов(УдалямыеСсылки)
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Таблица.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Назначения КАК Таблица
	|ГДЕ
	|	Таблица.Заказ В(&УдалямыеСсылки)";
	Запрос.УстановитьПараметр("УдалямыеСсылки", УдалямыеСсылки);
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

// Получение соответствия для определения функциональных опция по имени объектов.
// 
// Возвращаемое значение:
//  Соответствие - значение зависимостей, где Ключ - имя формы, Значение - функциональная опция.
//
Функция ЗависимостьФункционалаОтФункциональныхОпций()
	
	Зависимость = Новый Соответствие;
	Зависимость.Вставить("Обработка.ТорговыеПредложения.Форма.СопоставлениеНоменклатуры",
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве("ИспользоватьНесколькоВидовНоменклатуры"));
	Зависимость.Вставить("Обработка.ТорговыеПредложения.Форма.ФормаСписка",
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве("ИспользоватьСоглашенияСКлиентами"));
		
	Возврат Зависимость;
	
КонецФункции

// Заполнение сегмента контрагентов торгового предложения
//
// Параметры:
//  Соглашение			 - СправочникСсылка - ссылка справочника соглашения с контрагентами.
//  СегментКонтрагентов	 - Массив - контрагенты для органичения доступа к торговым предложениям.
//
Процедура ЗаполнитьКонтрагентовПакетаПредложений(ТорговоеПредложение, СписокКонтрагентов)

	Реквизиты = "СегментПартнеров, Контрагент, Партнер, Типовое";
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ТорговоеПредложение, Реквизиты);

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Типовое",          ЗначенияРеквизитов.Типовое);
	Запрос.УстановитьПараметр("Контрагент",       ЗначенияРеквизитов.Контрагент);
	Запрос.УстановитьПараметр("Партнер",          ЗначенияРеквизитов.Партнер);
	Запрос.УстановитьПараметр("СегментПартнеров", ЗначенияРеквизитов.СегментПартнеров);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Контрагенты.ИНН    КАК ИНН,
	|	Контрагенты.КПП    КАК КПП,
	|	Контрагенты.Ссылка КАК Контрагент
	|ИЗ
	|	РегистрСведений.ПартнерыСегмента КАК ПартнерыСегмента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО ПартнерыСегмента.Партнер = Контрагенты.Партнер
	|ГДЕ
	|	ПартнерыСегмента.Сегмент = &СегментПартнеров
	|	И НЕ Контрагенты.ИНН = """"
	|	И &Типовое = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	Контрагенты.ИНН,
	|	Контрагенты.КПП,
	|	Контрагенты.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.ИНН,
	|	Контрагенты.КПП,
	|	Контрагенты.Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	НЕ Контрагенты.ИНН = """"
	|	И &Типовое = ЛОЖЬ
	|	И Контрагенты.Партнер = &Партнер
	|	И &Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Контрагенты.ИНН,
	|	Контрагенты.КПП,
	|	Контрагенты.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.ИНН,
	|	Контрагенты.КПП,
	|	Контрагенты.Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	НЕ Контрагенты.ИНН = """"
	|	И &Типовое = ЛОЖЬ
	|	И Контрагенты.Ссылка = &Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Контрагенты.ИНН,
	|	Контрагенты.КПП,
	|	Контрагенты.Ссылка";
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТаблицаКонтрагентов = Запрос.Выполнить().Выгрузить();
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Если ТаблицаКонтрагентов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ВидыКонтактнойИнформации = Новый Массив;
	ВидыКонтактнойИнформации.Добавить(Справочники.ВидыКонтактнойИнформации.ТелефонКонтрагента);
	ВидыКонтактнойИнформации.Добавить(Справочники.ВидыКонтактнойИнформации.EmailКонтрагента);
	
	Для Каждого СтрокаКонтрагентов из ТаблицаКонтрагентов Цикл
		
		НоваяСтрока = СписокКонтрагентов.Добавить();
		НоваяСтрока.ИНН = СтрокаКонтрагентов.ИНН;
		НоваяСтрока.КПП = СтрокаКонтрагентов.КПП;
		
	КонецЦикла;
	
КонецПроцедуры

// Заполнение таблицы товары пакета предложений.
//
// Параметры:
//  ПакетПредложений	 - Структура - формируемый для публикации пакет торговых предложений.
//  ТорговоеПредложение	 - СправочникСсылка.СоглашенияСКлиентами - ссылка на справочник определяющий торговые предложения.
//  ЗначенияРеквизитов   - Структура - свойства справочника торговые предложения, состав:
//    * СегментНоменклатуры  - СправочникСсылка.СегментыНоменклатуры - сегмент номенклатуры для публикации.
//    * ВидЦен               - СправочникСсылка.СегментыНоменклатуры.ВидыЦен - вид цены.
//    * Валюта               - СправочникСсылка.СегментыНоменклатуры.Валюты - валюта торгового предложения.
//    * Организация          - СправочникСсылка.Организации - ссылка на организацию публикации.
//
Процедура ЗаполнитьТоварыПакетаПредложений(ПакетПредложений, ТорговоеПредложение, ЗначенияРеквизитов)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТорговоеПредложение", ТорговоеПредложение);
	Запрос.УстановитьПараметр("СегментНоменклатуры", ЗначенияРеквизитов.СегментНоменклатуры);
	Запрос.УстановитьПараметр("ВидЦены",             ЗначенияРеквизитов.ВидЦен);
	Запрос.УстановитьПараметр("Дата",                ТекущаяДата());
	Запрос.УстановитьПараметр("Валюта",              ЗначенияРеквизитов.Валюта);
	Запрос.УстановитьПараметр("Организация",         ЗначенияРеквизитов.Организация);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НоменклатураСегмента.Номенклатура      КАК Ссылка,
	|	НоменклатураСегмента.Характеристика    КАК Характеристика,
	|	ЦеныНоменклатурыСрезПоследних.Цена     КАК Цена,
	|	ЦеныНоменклатурыСрезПоследних.Упаковка КАК Упаковка,
	|	ЦеныНоменклатурыСрезПоследних.Валюта   КАК Валюта
	|ПОМЕСТИТЬ НоменклатураПоСегменту
	|ИЗ
	|	РегистрСведений.НоменклатураСегмента КАК НоменклатураСегмента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних КАК ЦеныНоменклатурыСрезПоследних
	|		ПО НоменклатураСегмента.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И НоменклатураСегмента.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|			И (&ВидЦены = ЦеныНоменклатурыСрезПоследних.ВидЦены)
	|ГДЕ
	|	НоменклатураСегмента.Сегмент = &СегментНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СоглашенияСКлиентамиТовары.НомерСтроки            КАК НомерСтроки,
	|	ВЫБОР
	|		КОГДА СоглашенияСКлиентамиТовары.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА СоглашенияСКлиентамиТовары.Номенклатура.ЕдиницаИзмерения
	|		ИНАЧЕ СоглашенияСКлиентамиТовары.Упаковка
	|	КОНЕЦ                                             КАК Упаковка,
	|	СоглашенияСКлиентамиТовары.Характеристика         КАК Характеристика,
	|	СоглашенияСКлиентамиТовары.СрокПоставки           КАК СрокПоставки,
	|	СоглашенияСКлиентамиТовары.Номенклатура           КАК Номенклатура,
	|	СоглашенияСКлиентамиТовары.Номенклатура.СтавкаНДС КАК НоменклатураСтавкаНДС,
	|	СоглашенияСКлиентамиТовары.ВидЦены                КАК ВидЦены,
	|	СоглашенияСКлиентамиТовары.Ссылка.Валюта.Код      КАК ВалютаКод
	|ПОМЕСТИТЬ УточненияНоменклатуры
	|ИЗ
	|	Справочник.СоглашенияСКлиентами.Товары КАК СоглашенияСКлиентамиТовары
	|ГДЕ
	|	СоглашенияСКлиентамиТовары.Ссылка = &ТорговоеПредложение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВременнаяТаблицаТовары.НомерСтроки    КАК НомерСтроки,
	|	ВременнаяТаблицаТовары.Номенклатура   КАК Номенклатура,
	|	ВременнаяТаблицаТовары.Характеристика КАК Характеристика,
	|	ВременнаяТаблицаТовары.Упаковка       КАК Упаковка,
	|	ВЫБОР
	|		КОГДА СоглашениеШапка.ВозвращатьМногооборотнуюТару
	|				И ВременнаяТаблицаТовары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|		КОГДА СоглашениеШапка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|				ИЛИ СоглашениеШапка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|					И РегУчетнаяПолитика.УчетнаяПолитика.СистемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СистемыНалогообложения.Общая)
	|			ТОГДА ВременнаяТаблицаТовары.Номенклатура.СтавкаНДС
	|		КОГДА СоглашениеШапка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|	КОНЕЦ                                 КАК СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СоглашениеТовары.Цена, 0) > 0
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|		КОГДА СоглашениеТовары.ВидЦены <> ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|				И СоглашениеТовары.ВидЦены ЕСТЬ НЕ NULL
	|			ТОГДА СоглашениеТовары.ВидЦены
	|		КОГДА (СоглашениеТовары.ВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|				ИЛИ СоглашениеТовары.ВидЦены ЕСТЬ NULL)
	|				И СоглашениеЦеновыеГруппы.ВидЦен ЕСТЬ НЕ NULL
	|				И СоглашениеЦеновыеГруппы.ВидЦен <> ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|			ТОГДА СоглашениеЦеновыеГруппы.ВидЦен
	|		КОГДА (СоглашениеТовары.ВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|				ИЛИ СоглашениеТовары.ВидЦены ЕСТЬ NULL)
	|				И (СоглашениеЦеновыеГруппы.ВидЦен ЕСТЬ NULL
	|					ИЛИ СоглашениеЦеновыеГруппы.ВидЦен = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка))
	|				И СоглашениеШапка.ВидЦен <> ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	|			ТОГДА СоглашениеШапка.ВидЦен
	|	КОНЕЦ                                 КАК ВидЦены,
	|	ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки1, 1) *
	|		ЕСТЬNULL(СоглашениеТовары.Цена, 0) / ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки3, 1) * ВЫБОР
	|		КОГДА &Валюта <> СоглашениеШапка.Валюта
	|			ТОГДА ВЫБОР
	|					КОГДА ЕСТЬNULL(КурсыСрезПоследнихВалютаСоглашения.Кратность, 0) > 0
	|							И ЕСТЬNULL(КурсыСрезПоследнихВалютаСоглашения.Курс, 0) > 0
	|							И ЕСТЬNULL(КурсыСрезПоследнихВалютаДокумента.Кратность, 0) > 0
	|							И ЕСТЬNULL(КурсыСрезПоследнихВалютаДокумента.Курс, 0) > 0
	|						ТОГДА КурсыСрезПоследнихВалютаСоглашения.Курс *
	|								КурсыСрезПоследнихВалютаДокумента.Кратность / (КурсыСрезПоследнихВалютаДокумента.Курс *
	|								КурсыСрезПоследнихВалютаСоглашения.Кратность)
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ 1
	|	КОНЕЦ                                 КАК Цена,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СоглашениеТовары.СрокПоставки, 0) > 0
	|			ТОГДА СоглашениеТовары.СрокПоставки
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ЕСТЬNULL(СоглашениеЦеновыеГруппы.СрокПоставки, 0) > 0
	|					ТОГДА СоглашениеЦеновыеГруппы.СрокПоставки
	|				ИНАЧЕ СоглашениеШапка.СрокПоставки
	|			КОНЕЦ
	|	КОНЕЦ                                 КАК СрокПоставки
	|ПОМЕСТИТЬ ЦеныПоСоглашению
	|ИЗ
	|	УточненияНоменклатуры КАК ВременнаяТаблицаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СоглашенияСКлиентами.Товары КАК СоглашениеТовары
	|		ПО (СоглашениеТовары.Ссылка = &ТорговоеПредложение)
	|			И ВременнаяТаблицаТовары.Номенклатура = СоглашениеТовары.Номенклатура
	|			И ВременнаяТаблицаТовары.Характеристика = СоглашениеТовары.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СоглашенияСКлиентами КАК СоглашениеШапка
	|		ПО (СоглашениеШапка.Ссылка = &ТорговоеПредложение)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СправочникНоменклатура
	|		ПО (СправочникНоменклатура.Ссылка = ВременнаяТаблицаТовары.Номенклатура)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СоглашенияСКлиентами.ЦеновыеГруппы КАК СоглашениеЦеновыеГруппы
	|		ПО (СоглашениеШапка.Ссылка = СоглашениеЦеновыеГруппы.Ссылка)
	|			И (СправочникНоменклатура.Ссылка.ЦеноваяГруппа = СоглашениеЦеновыеГруппы.ЦеноваяГруппа)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&Дата, Валюта = &Валюта) КАК КурсыСрезПоследнихВалютаДокумента
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&Дата, ) КАК КурсыСрезПоследнихВалютаСоглашения
	|		ПО (КурсыСрезПоследнихВалютаСоглашения.Валюта = СоглашениеШапка.Валюта)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаОрганизаций.СрезПоследних(&Дата, Организация = &Организация) КАК РегУчетнаяПолитика
	|		ПО (ИСТИНА)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВременнаяТаблицаТовары.НомерСтроки    КАК НомерСтроки,
	|	ЦеныНоменклатурыСрезПоследних.ВидЦены КАК ВидЦены,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаТовары.Упаковка <> ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА &ТекстЗапросаКоэффициентУпаковки1
	|		ИНАЧЕ 1
	|	КОНЕЦ * ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки2, 1) КАК Цена
	|ПОМЕСТИТЬ ЦеныПоВиду
	|ИЗ
	|	УточненияНоменклатуры КАК ВременнаяТаблицаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|				КОНЕЦПЕРИОДА(&Дата, ДЕНЬ),
	|				(Номенклатура, Характеристика, ВидЦены) В
	|					(ВЫБРАТЬ
	|						ВременнаяТаблицаТовары.Номенклатура,
	|						ВременнаяТаблицаТовары.Характеристика,
	|						ВременнаяТаблицаТовары.ВидЦены
	|					ИЗ
	|						УточненияНоменклатуры КАК ВременнаяТаблицаТовары)) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ВременнаяТаблицаТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ВременнаяТаблицаТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|			И ВременнаяТаблицаТовары.ВидЦены = ЦеныНоменклатурыСрезПоследних.ВидЦены
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&Дата, ) КАК КурсыВалютыЦены
	|		ПО (ЦеныНоменклатурыСрезПоследних.Валюта = КурсыВалютыЦены.Валюта)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&Дата, Валюта = &Валюта) КАК КурсыВалюты
	|		ПО (ИСТИНА)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЦеныПоСоглашению.НомерСтроки  КАК НомерСтроки,
	|	ЦеныПоСоглашению.ВидЦены      КАК ВидЦены,
	|	ЦеныПоСоглашению.СтавкаНДС    КАК СтавкаНДС,
	|	ЦеныПоСоглашению.СрокПоставки КАК СрокПоставки,
	|	ВЫБОР
	|		КОГДА ЦеныПоСоглашению.Цена = 0
	|			ТОГДА ЦеныПоВиду.Цена
	|		ИНАЧЕ ЦеныПоСоглашению.Цена
	|	КОНЕЦ                         КАК Цена
	|ПОМЕСТИТЬ ЦеныУточненнойНоменклатуры
	|ИЗ
	|	ЦеныПоСоглашению КАК ЦеныПоСоглашению
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЦеныПоВиду КАК ЦеныПоВиду
	|		ПО (ЦеныПоВиду.НомерСтроки = ЦеныПоСоглашению.НомерСтроки)
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ЦеныПоСоглашению.Цена = 0
	|				ТОГДА ЦеныПоВиду.Цена
	|			ИНАЧЕ ЦеныПоСоглашению.Цена
	|		КОНЕЦ > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УточненияНоменклатуры.Упаковка                  КАК Упаковка,
	|	УточненияНоменклатуры.Характеристика            КАК Характеристика,
	|	УточненияНоменклатуры.Номенклатура              КАК Номенклатура,
	|	УточненияНоменклатуры.Номенклатура.Наименование КАК НоменклатураНаименование,
	|	УточненияНоменклатуры.Номенклатура.Артикул      КАК НоменклатураАртикул,
	|	УточненияНоменклатуры.НоменклатураСтавкаНДС     КАК НоменклатураСтавкаНДС,
	|	УточненияНоменклатуры.ВалютаКод                 КАК ВалютаКод,
	|	ЦеныУточненнойНоменклатуры.ВидЦены              КАК ВидЦены,
	|	ЦеныУточненнойНоменклатуры.СтавкаНДС            КАК СтавкаНДС,
	|	ЦеныУточненнойНоменклатуры.СрокПоставки         КАК СрокПоставки,
	|	ЦеныУточненнойНоменклатуры.Цена                 КАК Цена,
	|	СоответствиеВидовНоменклатуры1СБизнесСеть.ИдентификаторКатегории КАК ИдентификаторКатегории
	|ПОМЕСТИТЬ ВыборкаУточненийНоменклатуры
	|ИЗ
	|	УточненияНоменклатуры КАК УточненияНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеВидовНоменклатуры1СБизнесСеть КАК СоответствиеВидовНоменклатуры1СБизнесСеть
	|		ПО УточненияНоменклатуры.Номенклатура.ВидНоменклатуры = СоответствиеВидовНоменклатуры1СБизнесСеть.ВидНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЦеныУточненнойНоменклатуры КАК ЦеныУточненнойНоменклатуры
	|		ПО УточненияНоменклатуры.НомерСтроки = ЦеныУточненнойНоменклатуры.НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ УточненияНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЦеныПоСоглашению
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЦеныПоВиду
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЦеныУточненнойНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НоменклатураПоСегменту.Цена       КАК Цена,
	|	ВЫБОР
	|		КОГДА НоменклатураПоСегменту.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА Товар.ЕдиницаИзмерения
	|		ИНАЧЕ НоменклатураПоСегменту.Упаковка
	|	КОНЕЦ                             КАК Упаковка,
	|	НоменклатураПоСегменту.Валюта.Код КАК ВалютаКод,
	|	НоменклатураПоСегменту.Характеристика КАК Характеристика,
	|	Товар.Наименование                КАК Наименование,
	|	Товар.Артикул                     КАК Артикул,
	|	СоответствиеВидовНоменклатуры1СБизнесСеть.ИдентификаторКатегории КАК ИдентификаторКатегории,
	|	СоглашенияСКлиентами.СрокПоставки КАК СрокПоставки,
	|	Товар.Ссылка                      КАК Номенклатура,
	|	Товар.СтавкаНДС                   КАК СтавкаНДС
	|ПОМЕСТИТЬ ВыборкаНоменклатуры
	|ИЗ
	|	Справочник.СоглашенияСКлиентами КАК СоглашенияСКлиентами,
	|	Справочник.Номенклатура КАК Товар
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеВидовНоменклатуры1СБизнесСеть КАК СоответствиеВидовНоменклатуры1СБизнесСеть
	|		ПО Товар.ВидНоменклатуры = СоответствиеВидовНоменклатуры1СБизнесСеть.ВидНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НоменклатураПоСегменту КАК НоменклатураПоСегменту
	|		ПО Товар.Ссылка = НоменклатураПоСегменту.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыборкаУточненийНоменклатуры КАК ВыборкаУточненийНоменклатуры
	|		ПО Товар.Ссылка = ВыборкаУточненийНоменклатуры.Номенклатура
	|ГДЕ
	|	СоглашенияСКлиентами.Ссылка = &ТорговоеПредложение
	|	И ВыборкаУточненийНоменклатуры.Номенклатура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЦеныНоменклатурыСрезПоследних.Цена,
	|	ВЫБОР
	|		КОГДА ЦеныНоменклатурыСрезПоследних.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|			ТОГДА Товар.ЕдиницаИзмерения
	|		ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка
	|	КОНЕЦ,
	|	ЦеныНоменклатурыСрезПоследних.Валюта.Код,
	|	ЦеныНоменклатурыСрезПоследних.Характеристика,
	|	Товар.Наименование,
	|	Товар.Артикул,
	|	СоответствиеВидовНоменклатуры1СБизнесСеть.ИдентификаторКатегории,
	|	СоглашенияСКлиентами.СрокПоставки,
	|	Товар.Ссылка,
	|	Товар.СтавкаНДС
	|ИЗ
	|	Справочник.СоглашенияСКлиентами КАК СоглашенияСКлиентами,
	|	Справочник.Номенклатура КАК Товар
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеВидовНоменклатуры1СБизнесСеть КАК СоответствиеВидовНоменклатуры1СБизнесСеть
	|		ПО Товар.ВидНоменклатуры = СоответствиеВидовНоменклатуры1СБизнесСеть.ВидНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|				,
	|				Цена > 0
	|					И &СегментНоменклатуры = ЗНАЧЕНИЕ(Справочник.СегментыНоменклатуры.ПустаяСсылка)) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО Товар.Ссылка = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И (ЦеныНоменклатурыСрезПоследних.ВидЦены = &ВидЦены)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыборкаУточненийНоменклатуры КАК ВыборкаУточненийНоменклатуры
	|		ПО Товар.Ссылка = ВыборкаУточненийНоменклатуры.Номенклатура
	|			И (ЦеныНоменклатурыСрезПоследних.Характеристика = ВыборкаУточненийНоменклатуры.Характеристика)
	|ГДЕ
	|	СоглашенияСКлиентами.Ссылка = &ТорговоеПредложение
	|	И ВыборкаУточненийНоменклатуры.Номенклатура ЕСТЬ NULL
	|	И &СегментНоменклатуры = ЗНАЧЕНИЕ(Справочник.СегментыНоменклатуры.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВыборкаУточненийНоменклатуры.Цена,
	|	ВыборкаУточненийНоменклатуры.Упаковка,
	|	ВыборкаУточненийНоменклатуры.ВалютаКод,
	|	ВыборкаУточненийНоменклатуры.Характеристика,
	|	ВыборкаУточненийНоменклатуры.НоменклатураНаименование,
	|	ВыборкаУточненийНоменклатуры.НоменклатураАртикул,
	|	ВыборкаУточненийНоменклатуры.ИдентификаторКатегории,
	|	ВыборкаУточненийНоменклатуры.СрокПоставки,
	|	ВыборкаУточненийНоменклатуры.Номенклатура,
	|	ВыборкаУточненийНоменклатуры.НоменклатураСтавкаНДС
	|ИЗ
	|	ВыборкаУточненийНоменклатуры КАК ВыборкаУточненийНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВыборкаНоменклатуры.Наименование   КАК Наименование,
	|	ВыборкаНоменклатуры.Цена           КАК Цена,
	|	ВыборкаНоменклатуры.ВалютаКод      КАК ВалютаКод,
	|	ВыборкаНоменклатуры.Характеристика КАК Характеристика,
	|	ВыборкаНоменклатуры.Артикул        КАК Артикул,
	|	ВыборкаНоменклатуры.ИдентификаторКатегории КАК ИдентификаторКатегории,
	|	ВыборкаНоменклатуры.СрокПоставки   КАК СрокПоставки,
	|	ВыборкаНоменклатуры.Номенклатура   КАК Номенклатура,
	|	ВыборкаНоменклатуры.Упаковка       КАК Упаковка,
	|	ВЫБОР
	|		КОГДА НЕ ВыборкаНоменклатуры.Упаковка.Владелец В (НЕОПРЕДЕЛЕНО,
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|			ТОГДА ВыборкаНоменклатуры.Упаковка.Владелец.ЕдиницаИзмерения.Код
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Код
	|	КОНЕЦ                              КАК УпаковкаКод,
	|	ВыборкаНоменклатуры.Упаковка.Наименование КАК УпаковкаНаименование,
	|	ВЫБОР
	|		КОГДА ВыборкаНоменклатуры.Упаковка.Числитель = 0
	|			ТОГДА 1
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Числитель
	|	КОНЕЦ                              КАК УпаковкаЧислитель,
	|	ВЫБОР
	|		КОГДА ВыборкаНоменклатуры.Упаковка.Знаменатель = 0
	|			ТОГДА 1
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Знаменатель
	|	КОНЕЦ                              КАК УпаковкаЗнаменатель,
	|	ЕСТЬNULL(ВыборкаНоменклатуры.Характеристика.Наименование, """")            КАК ХарактеристикаНаименование,
	|	ВыборкаНоменклатуры.Номенклатура.ВидНоменклатуры                           КАК ВидНоменклатуры,
	|	ВЫБОР
	|		КОГДА НЕ ВыборкаНоменклатуры.Упаковка.Владелец В (НЕОПРЕДЕЛЕНО,
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|			ТОГДА ВыборкаНоменклатуры.Упаковка.Владелец.ЕдиницаИзмерения
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка
	|	КОНЕЦ                              КАК БазоваяЕдиницаИзмерения,
	|	ВыборкаНоменклатуры.СтавкаНДС      КАК СтавкаНДС
	|ПОМЕСТИТЬ СобранныеДанныеНоменклатуры
	|ИЗ
	|	ВыборкаНоменклатуры КАК ВыборкаНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СвободныеОстатки.Остатки(, ) КАК СвободныеОстаткиОстатки
	|		ПО ВыборкаНоменклатуры.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ВыборкаНоменклатуры.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|			И (СвободныеОстаткиОстатки.ВНаличииОстаток > 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыборкаНоменклатуры.Наименование,
	|	ВыборкаНоменклатуры.ИдентификаторКатегории,
	|	ВыборкаНоменклатуры.Характеристика,
	|	ВыборкаНоменклатуры.Номенклатура,
	|	ВыборкаНоменклатуры.ВалютаКод,
	|	ВыборкаНоменклатуры.Артикул,
	|	ВыборкаНоменклатуры.Цена,
	|	ВыборкаНоменклатуры.СрокПоставки,
	|	ВыборкаНоменклатуры.Цена,
	|	ВыборкаНоменклатуры.Упаковка,
	|	ВыборкаНоменклатуры.Упаковка.Наименование,
	|	ВЫБОР
	|		КОГДА НЕ ВыборкаНоменклатуры.Упаковка.Владелец В (НЕОПРЕДЕЛЕНО,
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|			ТОГДА ВыборкаНоменклатуры.Упаковка.Владелец.ЕдиницаИзмерения.Код
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Код
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ВыборкаНоменклатуры.Упаковка.Числитель = 0
	|			ТОГДА 1
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Числитель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ВыборкаНоменклатуры.Упаковка.Знаменатель = 0
	|			ТОГДА 1
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка.Знаменатель
	|	КОНЕЦ,
	|	ЕСТЬNULL(ВыборкаНоменклатуры.Характеристика.Наименование, """"),
	|	ВыборкаНоменклатуры.Номенклатура.ВидНоменклатуры,
	|	ВыборкаНоменклатуры.Номенклатура.ВидНоменклатуры.НаборСвойств,
	|	ВыборкаНоменклатуры.Номенклатура.ВидНоменклатуры.НаборСвойствХарактеристик,
	|	ВЫБОР
	|		КОГДА НЕ ВыборкаНоменклатуры.Упаковка.Владелец В (НЕОПРЕДЕЛЕНО,
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|				ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|			ТОГДА ВыборкаНоменклатуры.Упаковка.Владелец.ЕдиницаИзмерения
	|		ИНАЧЕ ВыборкаНоменклатуры.Упаковка
	|	КОНЕЦ,
	|	ВыборкаНоменклатуры.СтавкаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	БазоваяЕдиницаИзмерения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НоменклатураПоСегменту
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВыборкаУточненийНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВыборкаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СобранныеДанныеНоменклатуры.Наименование,
	|	СобранныеДанныеНоменклатуры.Цена,
	|	СобранныеДанныеНоменклатуры.ВалютаКод,
	|	СобранныеДанныеНоменклатуры.Характеристика,
	|	СобранныеДанныеНоменклатуры.Артикул,
	|	СобранныеДанныеНоменклатуры.ИдентификаторКатегории,
	|	СобранныеДанныеНоменклатуры.СрокПоставки,
	|	СобранныеДанныеНоменклатуры.Номенклатура,
	|	СобранныеДанныеНоменклатуры.Упаковка,
	|	СобранныеДанныеНоменклатуры.УпаковкаКод,
	|	СобранныеДанныеНоменклатуры.УпаковкаНаименование,
	|	СобранныеДанныеНоменклатуры.УпаковкаЧислитель,
	|	СобранныеДанныеНоменклатуры.УпаковкаЗнаменатель,
	|	СобранныеДанныеНоменклатуры.ХарактеристикаНаименование,
	|	СобранныеДанныеНоменклатуры.ВидНоменклатуры,
	|	СобранныеДанныеНоменклатуры.БазоваяЕдиницаИзмерения,
	|	СобранныеДанныеНоменклатуры.СтавкаНДС
	|ИЗ
	|	СобранныеДанныеНоменклатуры КАК СобранныеДанныеНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СобранныеДанныеНоменклатуры.Номенклатура            КАК Номенклатура,
	|	СобранныеДанныеНоменклатуры.Характеристика          КАК Характеристика,
	|	СобранныеДанныеНоменклатуры.БазоваяЕдиницаИзмерения КАК БазоваяЕдиницаИзмерения,
	|	ЕСТЬNULL(ШтрихкодыНоменклатуры.Штрихкод, """")      КАК Значение
	|ИЗ
	|	СобранныеДанныеНоменклатуры КАК СобранныеДанныеНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|		ПО СобранныеДанныеНоменклатуры.Номенклатура = ШтрихкодыНоменклатуры.Номенклатура
	|			И СобранныеДанныеНоменклатуры.Характеристика = ШтрихкодыНоменклатуры.Характеристика
	|			И (СобранныеДанныеНоменклатуры.БазоваяЕдиницаИзмерения = ВЫБОР
	|				КОГДА НЕ ШтрихкодыНоменклатуры.Упаковка.Владелец В (НЕОПРЕДЕЛЕНО,
	|						ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|						ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|					ТОГДА ШтрихкодыНоменклатуры.Упаковка.Владелец.ЕдиницаИзмерения
	|				КОГДА ШтрихкодыНоменклатуры.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
	|					ТОГДА ВЫБОР
	|							КОГДА НЕ ШтрихкодыНоменклатуры.Номенклатура.ЕдиницаИзмерения.Владелец В (НЕОПРЕДЕЛЕНО,
	|									ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения),
	|									ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры))
	|								ТОГДА ШтрихкодыНоменклатуры.Номенклатура.ЕдиницаИзмерения.Владелец.ЕдиницаИзмерения
	|							ИНАЧЕ СобранныеДанныеНоменклатуры.БазоваяЕдиницаИзмерения
	|						КОНЕЦ
	|				ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка
	|			КОНЕЦ)
	|
	|СГРУППИРОВАТЬ ПО
	|	СобранныеДанныеНоменклатуры.Номенклатура,
	|	СобранныеДанныеНоменклатуры.Характеристика,
	|	СобранныеДанныеНоменклатуры.БазоваяЕдиницаИзмерения,
	|	ЕСТЬNULL(ШтрихкодыНоменклатуры.Штрихкод, """")";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст,
		"&ТекстЗапросаКоэффициентУпаковки1",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
		"ВременнаяТаблицаТовары.Упаковка",
		"ВременнаяТаблицаТовары.Номенклатура"));
			
	Запрос.Текст = СтрЗаменить(Запрос.Текст,
		"&ТекстЗапросаКоэффициентУпаковки2",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
		"ЦеныНоменклатурыСрезПоследних.Упаковка",
		"ЦеныНоменклатурыСрезПоследних.Номенклатура"));
			
	Запрос.Текст = СтрЗаменить(Запрос.Текст,
		"&ТекстЗапросаКоэффициентУпаковки3",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
		"СоглашениеТовары.Упаковка",
		"СоглашениеТовары.Номенклатура"));
	
	РезультатаЗапроса = Запрос.ВыполнитьПакет();
	
	Выборка = РезультатаЗапроса[РезультатаЗапроса.Количество()-2].Выбрать();
	ШтрихКоды = РезультатаЗапроса[РезультатаЗапроса.Количество()-1].Выбрать();
	
	Пока ШтрихКоды.Следующий() Цикл
		СтрокаШтрихкоды = ПакетПредложений.ШтрихКоды.Добавить();
		СтрокаШтрихкоды.Номенклатура = ШтрихКоды.Номенклатура;
		СтрокаШтрихкоды.Характеристика = ШтрихКоды.Характеристика;
		СтрокаШтрихкоды.ЕдиницаИзмерения = ШтрихКоды.БазоваяЕдиницаИзмерения;
		СтрокаШтрихкоды.Значение = ШтрихКоды.Значение;
	КонецЦикла;
	
	Пока Выборка.Следующий() Цикл
		СтрокаТовары = ПакетПредложений.Товары.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТовары, Выборка);
		ТаблицаРеквизитов = ПакетПредложений.Атрибуты.Скопировать();
		ЗаполнитьЗначенияДополнительныхРеквизитовТовара(
			Выборка.ВидНоменклатуры, Выборка.Номенклатура, Выборка.Характеристика, ТаблицаРеквизитов);
		СтрокаТовары.Атрибуты = ТаблицаРеквизитов;
	КонецЦикла;
	
КонецПроцедуры

// Заполнение таблицы дополнительных реквизитов товара.
//
// Параметры:
//  ВидНоменклатуры   - СправочникСсылка.ВидыНоменклатуры - вид номенклатуры для добавления атирибутов.
//  Номенклатура      - СправочникСсылка.Номенклатура - номенклатура реквизитов.
//  Характеристика    - СправочникСсылка.Характеристики - характеристика номенклатуры (при использовании).
//  ТаблицаРеквизитов - ТаблицаЗначений - таблица для заполнения реквизитов,
//                                        см. ТорговыеПредложения.СтруктураПакетаПредложений().
//
Процедура ЗаполнитьЗначенияДополнительныхРеквизитовТовара(ВидНоменклатуры, Номенклатура, Характеристика, ТаблицаРеквизитов)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВидНоменклатуры", ВидНоменклатуры);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ИЗ
	|	РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть         // Доп. реквизиты номенклатуры
	|ГДЕ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|	И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта В
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Свойство
	|			ИЗ
	|				Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты
	|			ГДЕ
	|				НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка.Родитель = ЗНАЧЕНИЕ(Справочник.НаборыДополнительныхРеквизитовИСведений.Справочник_Номенклатура))
	|;
	|
	|ВЫБРАТЬ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ИЗ
	|	РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть          // Доп. реквизиты характеристик
	|ГДЕ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|	И СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта В
	|		(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|			НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Свойство
	|		ИЗ
	|			Справочник.НаборыДополнительныхРеквизитовИСведений.ДополнительныеРеквизиты КАК НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты
	|		ГДЕ
	|			НаборыДополнительныхРеквизитовИСведенийДополнительныеРеквизиты.Ссылка.Родитель = ЗНАЧЕНИЕ(Справочник.НаборыДополнительныхРеквизитовИСведений.Справочник_ХарактеристикиНоменклатуры))
	|;
	|
	|ВЫБРАТЬ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ИЗ
	|	РегистрСведений.СоответствиеРеквизитовНоменклатуры1СБизнесСеть КАК СоответствиеРеквизитовНоменклатуры1СБизнесСеть         // Предопределенные реквизиты номенклатуры
	|ГДЕ
	|	СоответствиеРеквизитовНоменклатуры1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|	И ТИПЗНАЧЕНИЯ(СоответствиеРеквизитовНоменклатуры1СБизнесСеть.РеквизитОбъекта) = ТИП(СТРОКА)";
	
	Результат = Запрос.ВыполнитьПакет();
	ДопРеквизитыНоменклатуры = Результат[0].Выгрузить();                  // Доп. реквизиты номенклатуры
	ЗначенияРеквизитовНоменклатуры = УправлениеСвойствами.ПолучитьЗначенияСвойств(Номенклатура,,
		Ложь, ДопРеквизитыНоменклатуры.ВыгрузитьКолонку("РеквизитОбъекта"));
	
	ЗначенияРеквизитовХарактеристики = Новый ТаблицаЗначений;
	ДопРеквизитыХарактеристки = Результат[1].Выгрузить();                 // Доп. реквизиты характеристик
	ЗначенияРеквизитовХарактеристики = УправлениеСвойствами.ПолучитьЗначенияСвойств(Характеристика,,
		Ложь, ДопРеквизитыХарактеристки.ВыгрузитьКолонку("РеквизитОбъекта"));
	
	ЗначенияПредопределенныхРеквизитовНоменклатуры = Новый ТаблицаЗначений;
	ПредопределенныеРеквизитыНоменклатуры = Результат[2].Выгрузить();     // Предопределенные реквизиты номенклатуры
	ЗначенияПредопределенныхРеквизитов = ЗначенияПредопределенныхРеквизитовНоменклатуры(Номенклатура,
		ПредопределенныеРеквизитыНоменклатуры);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ДопРеквизитыНоменклатуры",              ДопРеквизитыНоменклатуры);
	Запрос.УстановитьПараметр("ДопРеквизитыХарактеристки",             ДопРеквизитыХарактеристки);
	Запрос.УстановитьПараметр("ПредопределенныеРеквизитыНоменклатуры", ПредопределенныеРеквизитыНоменклатуры);
	Запрос.УстановитьПараметр("ЗначенияРеквизитовНоменклатуры",        ЗначенияРеквизитовНоменклатуры);
	Запрос.УстановитьПараметр("ЗначенияРеквизитовХарактеристики",      ЗначенияРеквизитовХарактеристики);
	Запрос.УстановитьПараметр("ЗначенияПредопределенныхРеквизитов",    ЗначенияПредопределенныхРеквизитов);
	Запрос.УстановитьПараметр("ВидНоменклатуры",                       ВидНоменклатуры);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗначенияРеквизитовНоменклатуры.Значение КАК Значение,
	|	ЗначенияРеквизитовНоменклатуры.Свойство КАК Свойство
	|ПОМЕСТИТЬ ЗначенияДопРеквизитовНоменклатуры
	|ИЗ
	|	&ЗначенияРеквизитовНоменклатуры КАК ЗначенияРеквизитовНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗначенияРеквизитовХарактеристики.Значение КАК Значение,
	|	ЗначенияРеквизитовХарактеристики.Свойство КАК Свойство
	|ПОМЕСТИТЬ ЗначенияДопРеквизитовХарактеристики
	|ИЗ
	|	&ЗначенияРеквизитовХарактеристики КАК ЗначенияРеквизитовХарактеристики
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗначенияПредопределенныхРеквизитов.Значение КАК Значение,
	|	ЗначенияПредопределенныхРеквизитов.Свойство КАК Свойство
	|ПОМЕСТИТЬ ЗначенияПредопределенныхРеквизитовНоменклатуры
	|ИЗ
	|	&ЗначенияПредопределенныхРеквизитов КАК ЗначенияПредопределенныхРеквизитов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДопРеквизитыНоменклатуры.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	ДопРеквизитыНоменклатуры.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ПОМЕСТИТЬ НаборДопРеквизитовНоменклатуры
	|ИЗ
	|	&ДопРеквизитыНоменклатуры КАК ДопРеквизитыНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДопРеквизитыХарактеристки.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	ДопРеквизитыХарактеристки.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ПОМЕСТИТЬ НаборДопРеквизитовХарактеристики
	|ИЗ
	|	&ДопРеквизитыХарактеристки КАК ДопРеквизитыХарактеристки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПредопределенныеРеквизитыНоменклатуры.РеквизитОбъекта                 КАК РеквизитОбъекта,
	|	ПредопределенныеРеквизитыНоменклатуры.ИдентификаторРеквизитаКатегории КАК ИдентификаторРеквизитаКатегории
	|ПОМЕСТИТЬ НаборПредопределенныхРеквизитовНоменклатуры
	|ИЗ
	|	&ПредопределенныеРеквизитыНоменклатуры КАК ПредопределенныеРеквизитыНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.ИдентификаторЗначенияРеквизитаКатегории КАК ИдентификаторЗначения,
	|	НаборДопРеквизитовНоменклатуры.ИдентификаторРеквизитаКатегории                     КАК ИдентификаторРеквизитаКатегории,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение                                КАК Значение,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта.Наименование            КАК Наименование,
	|	ЗначенияДопРеквизитовНоменклатуры.Свойство                                         КАК Свойство,
	|	НаборДопРеквизитовНоменклатуры.РеквизитОбъекта                                     КАК РеквизитОбъекта,
	|	&ВидНоменклатуры                                                                   КАК ВидНоменклатуры
	|ПОМЕСТИТЬ СопоставленныеЗначения
	|ИЗ
	|	РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗначенияДопРеквизитовНоменклатуры КАК ЗначенияДопРеквизитовНоменклатуры
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборДопРеквизитовНоменклатуры КАК НаборДопРеквизитовНоменклатуры
	|			ПО ЗначенияДопРеквизитовНоменклатуры.Свойство = НаборДопРеквизитовНоменклатуры.РеквизитОбъекта
	|		ПО СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта = ЗначенияДопРеквизитовНоменклатуры.Свойство
	|			И СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|			И СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение = ЗначенияДопРеквизитовНоменклатуры.Значение
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.ИдентификаторЗначенияРеквизитаКатегории,
	|	НаборДопРеквизитовХарактеристики.ИдентификаторРеквизитаКатегории,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта.Наименование,
	|	ЗначенияДопРеквизитовХарактеристики.Свойство,
	|	НаборДопРеквизитовХарактеристики.РеквизитОбъекта,
	|	&ВидНоменклатуры
	|ИЗ
	|	РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗначенияДопРеквизитовХарактеристики КАК ЗначенияДопРеквизитовХарактеристики
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборДопРеквизитовХарактеристики КАК НаборДопРеквизитовХарактеристики
	|			ПО ЗначенияДопРеквизитовХарактеристики.Свойство = НаборДопРеквизитовХарактеристики.РеквизитОбъекта
	|		ПО СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта = ЗначенияДопРеквизитовХарактеристики.Свойство
	|			И СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры
	|			И СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение = ЗначенияДопРеквизитовХарактеристики.Значение
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.ИдентификаторЗначенияРеквизитаКатегории,
	|	НаборПредопределенныхРеквизитовНоменклатуры.ИдентификаторРеквизитаКатегории,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение,
	|	СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта,
	|	ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство,
	|	НаборПредопределенныхРеквизитовНоменклатуры.РеквизитОбъекта,
	|	&ВидНоменклатуры
	|ИЗ
	|	РегистрСведений.СоответствиеЗначенийРеквизитов1СБизнесСеть КАК СоответствиеЗначенийРеквизитов1СБизнесСеть
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗначенияПредопределенныхРеквизитовНоменклатуры КАК ЗначенияПредопределенныхРеквизитовНоменклатуры
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборПредопределенныхРеквизитовНоменклатуры КАК НаборПредопределенныхРеквизитовНоменклатуры
	|			ПО ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство = НаборПредопределенныхРеквизитовНоменклатуры.РеквизитОбъекта
	|		ПО СоответствиеЗначенийРеквизитов1СБизнесСеть.РеквизитОбъекта = ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство
	|			И (СоответствиеЗначенийРеквизитов1СБизнесСеть.ВидНоменклатуры = &ВидНоменклатуры)
	|			И СоответствиеЗначенийРеквизитов1СБизнесСеть.Значение = ЗначенияПредопределенныхРеквизитовНоменклатуры.Значение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НаборДопРеквизитовНоменклатуры.ИдентификаторРеквизитаКатегории                                                                  КАК ИдентификаторРеквизитаКатегории,
	|	ЗначенияДопРеквизитовНоменклатуры.Значение                                                                                      КАК Значение,
	|	ПРЕДСТАВЛЕНИЕ(ВЫРАЗИТЬ(ЗначенияДопРеквизитовНоменклатуры.Свойство КАК ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения)) КАК Наименование,
	|	""""                                                                                                                            КАК ИдентификаторЗначения,
	|	НаборДопРеквизитовНоменклатуры.РеквизитОбъекта                                                                                  КАК РеквизитОбъекта,
	|	&ВидНоменклатуры                                                                                                                КАК ВидНоменклатуры
	|ИЗ
	|	ЗначенияДопРеквизитовНоменклатуры КАК ЗначенияДопРеквизитовНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ СопоставленныеЗначения КАК СопоставленныеЗначения
	|		ПО ЗначенияДопРеквизитовНоменклатуры.Значение = СопоставленныеЗначения.Значение
	|			И ЗначенияДопРеквизитовНоменклатуры.Свойство = СопоставленныеЗначения.Свойство
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборДопРеквизитовНоменклатуры КАК НаборДопРеквизитовНоменклатуры
	|		ПО ЗначенияДопРеквизитовНоменклатуры.Свойство = НаборДопРеквизитовНоменклатуры.РеквизитОбъекта
	|ГДЕ
	|	СопоставленныеЗначения.Значение ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НаборДопРеквизитовХарактеристики.ИдентификаторРеквизитаКатегории,
	|	ЗначенияДопРеквизитовХарактеристики.Значение,
	|	ПРЕДСТАВЛЕНИЕ(ВЫРАЗИТЬ(ЗначенияДопРеквизитовХарактеристики.Свойство КАК ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения)),
	|	"""",
	|	НаборДопРеквизитовХарактеристики.РеквизитОбъекта,
	|	&ВидНоменклатуры
	|ИЗ
	|	ЗначенияДопРеквизитовХарактеристики КАК ЗначенияДопРеквизитовХарактеристики
	|		ЛЕВОЕ СОЕДИНЕНИЕ СопоставленныеЗначения КАК СопоставленныеЗначения
	|		ПО ЗначенияДопРеквизитовХарактеристики.Значение = СопоставленныеЗначения.Значение
	|			И ЗначенияДопРеквизитовХарактеристики.Свойство = СопоставленныеЗначения.Свойство
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборДопРеквизитовХарактеристики КАК НаборДопРеквизитовХарактеристики
	|		ПО ЗначенияДопРеквизитовХарактеристики.Свойство = НаборДопРеквизитовХарактеристики.РеквизитОбъекта
	|ГДЕ
	|	СопоставленныеЗначения.Значение ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СопоставленныеЗначения.ИдентификаторРеквизитаКатегории,
	|	СопоставленныеЗначения.Значение,
	|	СопоставленныеЗначения.Наименование,
	|	СопоставленныеЗначения.ИдентификаторЗначения,
	|	СопоставленныеЗначения.РеквизитОбъекта,
	|	СопоставленныеЗначения.ВидНоменклатуры
	|ИЗ
	|	СопоставленныеЗначения КАК СопоставленныеЗначения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НаборПредопределенныхРеквизитовНоменклатуры.ИдентификаторРеквизитаКатегории,
	|	ЗначенияПредопределенныхРеквизитовНоменклатуры.Значение,
	|	ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство,
	|	"""",
	|	НаборПредопределенныхРеквизитовНоменклатуры.РеквизитОбъекта,
	|	&ВидНоменклатуры
	|ИЗ
	|	ЗначенияПредопределенныхРеквизитовНоменклатуры КАК ЗначенияПредопределенныхРеквизитовНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ СопоставленныеЗначения КАК СопоставленныеЗначения
	|		ПО ЗначенияПредопределенныхРеквизитовНоменклатуры.Значение = СопоставленныеЗначения.Значение
	|			И ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство = СопоставленныеЗначения.Свойство
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НаборПредопределенныхРеквизитовНоменклатуры КАК НаборПредопределенныхРеквизитовНоменклатуры
	|		ПО ЗначенияПредопределенныхРеквизитовНоменклатуры.Свойство = НаборПредопределенныхРеквизитовНоменклатуры.РеквизитОбъекта
	|ГДЕ
	|	СопоставленныеЗначения.Значение ЕСТЬ NULL";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		СтрокаАтрибута = ТаблицаРеквизитов.Добавить();
		СтрокаАтрибута.Наименование = Выборка.Наименование;
		СтрокаАтрибута.ИдентификаторРеквизитаКатегории = Выборка.ИдентификаторРеквизитаКатегории;
		СтрокаАтрибута.ИдентификаторЗначения = Выборка.ИдентификаторЗначения;
		Если ТипЗнч(Выборка.Значение) = Тип("Число") Тогда
			СтрокаАтрибута.Значение = XMLСтрока(Выборка.Значение); // Конвертация в строку.
		Иначе
			СтрокаАтрибута.Значение = Строка(Выборка.Значение);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Установка доступность команд буфера обмена в форме.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма установки доступности команд.
//
Процедура УстановитьДоступностьКомандБуфераОбмена(Форма)
	
	// Наименование элементов формы.
	МассивЭлементов = Новый Массив();
	МассивЭлементов.Добавить("ТоварыВставитьСтроки");
	МассивЭлементов.Добавить("ТоварыКонтекстноеМенюВставитьСтроки");
	
	ПустойБуферОбмена = ОбщегоНазначения.ПустойБуферОбмена("Строки");
	
	УстановитьСвойствоЭлементовФормы(Форма.Элементы, МассивЭлементов, "Доступность",
		НЕ ПустойБуферОбмена);
		
КонецПроцедуры

// Получение строк таблицы из буфера обмена.
//
// Параметры:
//   ДополнительныеПараметры - Структура - параметры для получения, состав:
//     * УникальныйИдентификатор - УникальныйИдентификатор - идентификатор формы.
//
// Возвращаемое значение:
//   ТаблицаЗначений - строки, полученные из буфера обмена.
//
Функция ПолучитьСтрокиИзБуфераОбмена(ДополнительныеПараметры)

	ТаблицаТоваров = КопированиеСтрокСервер.ПолучитьСтрокиИзБуфераОбмена();
	
	МассивДляПолученияЕдиницИзмерения = Новый Массив;
	Для Каждого СтрокаТовара Из ТаблицаТоваров Цикл
		Если Не ЗначениеЗаполнено(СтрокаТовара.Упаковка) Тогда
			МассивДляПолученияЕдиницИзмерения.Добавить(СтрокаТовара.Номенклатура);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивДляПолученияЕдиницИзмерения.Количество() Тогда
		ЕдиницыИзмеренияНоменклатуры = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(МассивДляПолученияЕдиницИзмерения,
			"ЕдиницаИзмерения");
		Для Каждого ЭлементСоответствия Из ЕдиницыИзмеренияНоменклатуры Цикл
			СтрокиТоваров = ТаблицаТоваров.НайтиСтроки(Новый Структура("Номенклатура, Упаковка",
				ЭлементСоответствия.Ключ, Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка()));
			Для Каждого СтрокаТоваров Из СтрокиТоваров Цикл
				СтрокаТоваров.Упаковка = ЭлементСоответствия.Значение;
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(ТаблицаТоваров);
	
КонецФункции

#КонецОбласти
