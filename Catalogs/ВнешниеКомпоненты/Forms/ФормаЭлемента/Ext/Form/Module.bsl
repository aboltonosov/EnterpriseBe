#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьИзФайла(Команда)
	
	#Если ВебКлиент Тогда
		ОписаниеОповещенияОЗавершении = Новый ОписаниеОповещения("ПослеВыбораФайлаВКИзВеб", ЭтотОбъект);
		НачатьПомещениеФайла(ОписаниеОповещенияОЗавершении, , "*.zip", , УникальныйИдентификатор);
	#Иначе
		Режим = РежимДиалогаВыбораФайла.Открытие;
		ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
		Фильтр = НСтр("ru = 'Файл внешней компоненты'") + "(*.zip)|*.zip";
		ДиалогОткрытияФайла.Фильтр = Фильтр;
		ДиалогОткрытияФайла.МножественныйВыбор = Ложь;
		ДиалогОткрытияФайла.Заголовок = Нстр("ru = 'Выберите файл внешней компоненты'");
		ОписаниеОповещения = Новый ОписаниеОповещения("ПослеВыбораФайлаВКИзТонкогоКлиента", ЭтотОбъект);
		ДиалогОткрытияФайла.Показать(ОписаниеОповещения);
	#КонецЕсли
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьЧерезИнтернет(Команда)
	
	Результат = Неопределено;
	ОбновитьВнешнююКомпоненту(Объект.Идентификатор, УникальныйИдентификатор, Результат);
	
	Если Результат.Статус = "Выполняется" Тогда
		ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
		ПараметрыОжидания.ВыводитьСообщения = Истина;
		Оповещение = Новый ОписаниеОповещения("ПослеОбновленияВнешнейКомпоненты", ЭтотОбъект);
		ДлительныеОперацииКлиент.ОжидатьЗавершение(Результат, Оповещение, ПараметрыОжидания);
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		ВидОперации = НСтр("ru = 'Обновление внешней компоненты.'");
		ДополнительныеВнешниеКомпонентыВызовСервера.ОбработатьОшибку(
			ВидОперации, Результат.ПодробноеПредставлениеОшибки, Результат.КраткоеПредставлениеОшибки);
		Прочитать();
	Иначе
		Прочитать();
		ОповеститьОбИзменении(Объект.Ссылка);
	КонецЕсли;
	
	УдалитьВнешнююКомпонентуИзКэша();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ПослеОбновленияВнешнейКомпоненты(Результат, ДополнительныеПараметры) Экспорт

	Прочитать();
	ОповеститьОбИзменении(Объект.Ссылка);

КонецПроцедуры

&НаКлиенте
Процедура УдалитьВнешнююКомпонентуИзКэша()
	
	ПараметрыПодсистемыВнешниеКомпоненты = ПараметрыПриложения["ВнешниеКомпоненты"];
	Если ТипЗнч(ПараметрыПодсистемыВнешниеКомпоненты) = Тип("Структура") Тогда
		ПараметрыПодсистемыВнешниеКомпоненты.Удалить(Объект.Идентификатор);
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ОбновитьВнешнююКомпоненту(Знач ИмяМодуля, Знач УникальныйИдентификатор, Результат)
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = Нстр("ru = 'Обновление внешней компоненты.'");
	
	Результат = ДлительныеОперации.ВыполнитьВФоне(
		"Справочники.ВнешниеКомпоненты.ОбновитьВнешниеКомпоненты", Новый Структура(ИмяМодуля), ПараметрыВыполнения);

КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайлаВКИзВеб(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	
	Если Результат = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	ОбновитьДанныеВнешнейКомпоненты(Адрес);

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьДанныеВнешнейКомпоненты(Адрес)
	
	ИнформацияОВК = ИнформацияОВК(Адрес);
	
	Если ИнформацияОВК = Неопределено Тогда
		Возврат;
	ИначеЕсли ИнформацияОВК.ИмяМодуля <> Объект.Идентификатор Тогда
		ТекстСообщения = НСтр("ru = 'Файл содержит данные другой внешней компоненты:  %1.
									|Необходимо указать файл внешней компоненты: %2.'");
		ТекстСообщения = СтрШаблон(ТекстСообщения, ИнформацияОВК.Название, Объект.Наименование);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	СохранитьВнешнююКомпонентуВИнформационнойБазе(Адрес);
	
	УдалитьВнешнююКомпонентуИзКэша();

	ОповеститьОбИзменении(Объект.Ссылка);
	
	Прочитать();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ИнформацияОВК(Знач АдресВнешнейКомпоненты) Экспорт
	
	Возврат Справочники.ВнешниеКомпоненты.ИнформацияОВК(АдресВнешнейКомпоненты);
	
КонецФункции

&НаКлиенте
Процедура ПослеВыбораФайлаВКИзТонкогоКлиента(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы = Неопределено ИЛИ НЕ ВыбранныеФайлы.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	ПутьКФайлу = ВыбранныеФайлы[0];
	
	ДвоичныеДанныеФайла = Новый ДвоичныеДанные(ПутьКФайлу);
	АдресФайла = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);

	ОбновитьДанныеВнешнейКомпоненты(АдресФайла);
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура СохранитьВнешнююКомпонентуВИнформационнойБазе(Знач Адрес)
	
	Справочники.ВнешниеКомпоненты.СохранитьВнешнююКомпонентуВИнформационнойБазе(Адрес);
	
КонецПроцедуры

#КонецОбласти