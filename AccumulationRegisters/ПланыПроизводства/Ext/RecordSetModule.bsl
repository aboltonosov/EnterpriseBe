#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, Замещение)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ЭтотОбъект);
	
	Регистратор = Отбор.Регистратор.Значение;
	
	ОтменаПроведения = ?(ДополнительныеСвойства.Свойство("РежимЗаписи"),
		ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения,
		Ложь);
	
	Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.ПланПроизводства")
		И НЕ ОтменаПроведения Тогда
		
		РассчитатьПоребности = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
			Регистратор, "Сценарий.ИспользоватьДляПланированияМатериалов");
		
		Если РассчитатьПоребности Тогда
		
			МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц();
			
			ПрочитатьСтарыеИНовыеДвижения(МенеджерВременныхТаблиц, Регистратор);
			
			ДополнительныеСвойства.Вставить("МенеджерВременныхТаблиц", МенеджерВременныхТаблиц);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ, Замещение)
	
	Если ОбменДанными.Загрузка 
		ИЛИ НЕ ДополнительныеСвойства.Свойство("МенеджерВременныхТаблиц") Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = ДополнительныеСвойства.МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОчередьРасчета.ДатаВыпуска КАК ДатаВыпуска,
	|	ОчередьРасчета.ПланПроизводства КАК ПланПроизводства,
	|	ОчередьРасчета.Подразделение КАК Подразделение,
	|	ОчередьРасчета.Спецификация КАК Спецификация,
	|	ОчередьРасчета.Назначение КАК Назначение,
	|	ОчередьРасчета.Сценарий КАК Сценарий,
	|	ЛОЖЬ КАК ВыпускПолуфабрикатов
	|ИЗ
	|	(ВЫБРАТЬ
	|		НовыеДвижения.ПланПроизводства КАК ПланПроизводства,
	|		НовыеДвижения.Номенклатура КАК Номенклатура,
	|		НовыеДвижения.Характеристика КАК Характеристика,
	|		НовыеДвижения.Спецификация КАК Спецификация,
	|		НовыеДвижения.Количество КАК КоличествоРазность,
	|		НовыеДвижения.ДатаВыпуска КАК ДатаВыпуска,
	|		НовыеДвижения.Сценарий КАК Сценарий,
	|		НовыеДвижения.Подразделение КАК Подразделение,
	|		НовыеДвижения.Назначение КАК Назначение
	|	ИЗ
	|		НовыеДвижения КАК НовыеДвижения
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		СтарыеДвижения.ПланПроизводства,
	|		СтарыеДвижения.Номенклатура,
	|		СтарыеДвижения.Характеристика,
	|		СтарыеДвижения.Спецификация,
	|		-СтарыеДвижения.Количество,
	|		СтарыеДвижения.ДатаВыпуска,
	|		СтарыеДвижения.Сценарий,
	|		СтарыеДвижения.Подразделение,
	|		СтарыеДвижения.Назначение
	|	ИЗ
	|		СтарыеДвижения КАК СтарыеДвижения) КАК ОчередьРасчета
	|
	|СГРУППИРОВАТЬ ПО
	|	ОчередьРасчета.ДатаВыпуска,
	|	ОчередьРасчета.ПланПроизводства,
	|	ОчередьРасчета.Подразделение,
	|	ОчередьРасчета.Спецификация,
	|	ОчередьРасчета.Назначение,
	|	ОчередьРасчета.Сценарий,
	|	ОчередьРасчета.Номенклатура,
	|	ОчередьРасчета.Характеристика
	|
	|ИМЕЮЩИЕ
	|	СУММА(ОчередьРасчета.КоличествоРазность) <> 0";
		
	ПланПроизводства = Отбор.Регистратор.Значение;
	
	ТаблицаОчередь = Запрос.Выполнить().Выгрузить();
	
	Если ТаблицаОчередь.Количество() > 0 Тогда
		
		РегистрыСведений.ОчередьРасчетаПланаПроизводства.ЗаписатьОчередь(ТаблицаОчередь, ПланПроизводства);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ПрочитатьСтарыеИНовыеДвижения(МенеджерВременныхТаблиц, ПланПроизводства)
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПланПроизводства", ПланПроизводства);
	Запрос.УстановитьПараметр("НовыеДвиженияПланыПроизводства", ЭтотОбъект);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтарыеДвижения.Сценарий КАК Сценарий,
	|	СтарыеДвижения.Назначение КАК Назначение,
	|	СтарыеДвижения.ПланПроизводства КАК ПланПроизводства,
	|	СтарыеДвижения.Номенклатура КАК Номенклатура,
	|	СтарыеДвижения.Характеристика КАК Характеристика,
	|	СтарыеДвижения.Спецификация КАК Спецификация,
	|	СтарыеДвижения.Количество КАК Количество,
	|	СтарыеДвижения.Период КАК ДатаВыпуска,
	|	СтарыеДвижения.Подразделение КАК Подразделение
	|ПОМЕСТИТЬ СтарыеДвижения
	|ИЗ
	|	РегистрНакопления.ПланыПроизводства КАК СтарыеДвижения
	|ГДЕ
	|	СтарыеДвижения.Регистратор = &ПланПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеДвижения.Сценарий КАК Сценарий,
	|	НовыеДвижения.Назначение КАК Назначение,
	|	НовыеДвижения.ПланПроизводства КАК ПланПроизводства,
	|	НовыеДвижения.Номенклатура КАК Номенклатура,
	|	НовыеДвижения.Характеристика КАК Характеристика,
	|	НовыеДвижения.Спецификация КАК Спецификация,
	|	НовыеДвижения.Количество КАК Количество,
	|	НовыеДвижения.Период КАК ДатаВыпуска,
	|	НовыеДвижения.Подразделение КАК Подразделение
	|ПОМЕСТИТЬ НовыеДвижения
	|ИЗ
	|	&НовыеДвиженияПланыПроизводства КАК НовыеДвижения";
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
