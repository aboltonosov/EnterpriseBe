#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Функция получает элемент справочника - ключ аналитики учета партий производства.
//
// Параметры:
//	ПараметрыАналитики - Выборка, Структура - содержит структуры со свойствами:
//		* Номенклатура - СправочникСсылка.Номенклатура - Номенклатура
//		* Характеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика номенклатуры
//		* Спецификация - СправочникСсылка.РесурсныеСпецификации - Спецификация
//		* Назначение - СправочникСсылка.Назначения - Назначение
//
// Возвращаемое значение:
//	СправочникСсылка.КлючиАналитикиУчетаПартийПроизводства - Созданный элемент справочника
//
Функция ЗначениеКлючаАналитики(ПараметрыАналитики) Экспорт

	НаборЗаписей = ПолучитьНаборЗаписей(ПараметрыАналитики);
	
	Если НаборЗаписей <> Неопределено Тогда
		НаборЗаписей.Прочитать();
		
		Если НаборЗаписей.Количество() > 0
			И Не ЗначениеЗаполнено(НаборЗаписей[0].КлючАналитики) Тогда
			НаборЗаписей.Очистить();
			НаборЗаписей.Записать();
		КонецЕсли;

		Если НаборЗаписей.Количество() > 0
			И ЗначениеЗаполнено(НаборЗаписей[0].КлючАналитики) Тогда
			Результат = НаборЗаписей[0].КлючАналитики;
		Иначе
			Результат = СоздатьКлючАналитики(ПараметрыАналитики);
		КонецЕсли;

		Возврат Результат;
	КонецЕсли;

КонецФункции

// Функция получает элемент справочника - ключ аналитики учета партий производства.
//
// Параметры:
//	ПараметрыАналитики (обязательный) - Выборка, Структура - содержит структуры со свойствами:
//		* Номенклатура - СправочникСсылка.Номенклатура - Номенклатура
//		* Характеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика номенклатуры
//		* Спецификация - СправочникСсылка.РесурсныеСпецификации - Спецификация
//		* Назначение - СправочникСсылка.Назначения - Назначение
//
// Возвращаемое значение:
//	СправочникСсылка.КлючиАналитикиУчетаПартийПроизводства - Созданный элемент справочника
//
Функция СоздатьКлючАналитики(ПараметрыАналитики, ЗаписьПриОбновленииИБ = Ложь) Экспорт
	
	НаборЗаписей = ПолучитьНаборЗаписей(ПараметрыАналитики);
	
	Если НаборЗаписей <> Неопределено Тогда
		
		НачатьТранзакцию();
		// Создание нового ключа аналитики.
		
		СтрокаНабора = НаборЗаписей[0];
		
		СправочникОбъект = Справочники.КлючиАналитикиУчетаПартийПроизводства.СоздатьЭлемент();
		СправочникОбъект.Наименование = ПолучитьПолноеНаименованиеКлючаАналитики(СтрокаНабора);
		ЗаполнитьЗначенияСвойств(СправочникОбъект, СтрокаНабора, "Номенклатура, Характеристика, Спецификация, Назначение");
		Если ЗаписьПриОбновленииИБ Тогда
			ОбновлениеИнформационнойБазы.ЗаписатьОбъект(СправочникОбъект);
		Иначе
			СправочникОбъект.Записать();
		КонецЕсли;

		Результат = СправочникОбъект.Ссылка;

		СтрокаНабора.КлючАналитики = Результат;
		Попытка
			Если ЗаписьПриОбновленииИБ Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписей, Ложь, Истина);
			Иначе
				НаборЗаписей.Записать(Ложь);
			КонецЕсли;
			ЗафиксироватьТранзакцию();
		Исключение
			// во время инициализации ключа, данный ключ уже был создан в ИБ другим сеансом.
			НаборЗаписей.Прочитать();
			Если Не НаборЗаписей.Количество() = 0 Тогда // запись не создана из-за ошибки заполнения полей.
				ОтменитьТранзакцию();
				ВызватьИсключение;
			Иначе
				ОтменитьТранзакцию();
				Результат = НаборЗаписей[0].КлючАналитики;
			КонецЕсли;
		КонецПопытки;

		Возврат Результат;
		
	КонецЕсли;
	
КонецФункции

// Заполняет поле АналитикаУчетаПартийПроизводства в коллекции, содержащей "Номенклатура, Характеристика, Спецификация, Назначение".
// Параметры:
//
//	Коллекция (обязательный) - ТаблицаЗначений - обязательные поля:
//		* АналитикаУчетаПартийПроизводства - СправочникСсылка.КлючиАналитикиУчетаПартийПроизводства - АналитикаУчетаПартийПроизводства
//
//	ИменаПолей (необязательный) - Структура - содержит реальные имена полей коллекции для получения и формирования аналитики.
//		Имеет структуру {АналитикаУчетаПартийПроизводства [, Номенклатура, Характеристика, Спецификация, Назначение]},
//			все ключи определения полей, за исключением поля самой аналитики - необязательны.
//		по умолчанию заполняется методом ИменаПолейКоллекцииПоУмолчанию(...)
//			("АналитикаУчетаПартийПроизводства, Номенклатура, Характеристика, Спецификация, Назначение",
//			"АналитикаУчетаПартийПроизводства", "", "", "", "")
//
Процедура ЗаполнитьВКоллекции(Коллекция, ИменаПолей = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ИменаПолей = Неопределено Тогда
		ИменаПолей = ИменаПолейКоллекцииПоУмолчанию();
	КонецЕсли;

	Запрос = Новый Запрос(ТекстЗначенияКлючейАналитикиВКоллекции(ИменаПолей));
	Запрос.УстановитьПараметр("Коллекция", Коллекция);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(Выборка.АналитикаУчетаПартийПроизводства) Тогда
			КлючАналитики = ЗначениеКлючаАналитики(Выборка)
		Иначе
			КлючАналитики = Выборка.АналитикаУчетаПартийПроизводства;
		КонецЕсли;
		
		Коллекция[Выборка.Индекс][ИменаПолей.АналитикаУчетаПартийПроизводства] = КлючАналитики;
		
	КонецЦикла;
	
КонецПроцедуры

// Возвращает структуру полей выбора информации из коллекции для формирования аналитики учета партий производства.
//
// Возвращаемое значение:
//	Структура - содержит реальные имена полей коллекции для получения и формирования аналитики.
//		Имеет структуру {АналитикаУчетаПартийПроизводства [, Номенклатура, Характеристика, Спецификация, Назначение]},
//			все ключи определения полей, за исключением поля самой аналитики - необязательны.
//		по умолчанию заполняется методом ИменаПолейКоллекцииПоУмолчанию(...)
//			("АналитикаУчетаПартийПроизводства, Номенклатура, Характеристика, Спецификация, Назначение",
//			"АналитикаУчетаПартийПроизводства", "", "", "", "")
//
Функция ИменаПолейКоллекцииПоУмолчанию() Экспорт
	
	ИменаПолей = Новый Структура();
	ИменаПолей.Вставить("АналитикаУчетаПартийПроизводства", "АналитикаУчетаПартийПроизводства");
	ИменаПолей.Вставить("Номенклатура", "");
	ИменаПолей.Вставить("Характеристика", "");
	ИменаПолей.Вставить("Спецификация", "");
	ИменаПолей.Вставить("Назначение", "");
	
	Возврат ИменаПолей;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Прочее

Функция ПолучитьНаборЗаписей(ПараметрыАналитики)
	
	// В параметрах аналитики могут быть не все свойства
	СтруктураАналитики = Новый Структура("Номенклатура, Характеристика, Спецификация, Назначение");
	ЗаполнитьЗначенияСвойств(СтруктураАналитики, ПараметрыАналитики);
	Если НЕ ЗначениеЗаполнено(СтруктураАналитики.Номенклатура)
		И НЕ ЗначениеЗаполнено(СтруктураАналитики.Характеристика)
		И НЕ ЗначениеЗаполнено(СтруктураАналитики.Спецификация)
		И НЕ ЗначениеЗаполнено(СтруктураАналитики.Назначение) Тогда
		Возврат Неопределено
	Иначе
		НаборЗаписей = РегистрыСведений.АналитикаУчетаПартийПроизводства.СоздатьНаборЗаписей();
		
		Для Каждого КлючЗначение из СтруктураАналитики Цикл
			НаборЗаписей.Отбор[КлючЗначение.Ключ].Установить(КлючЗначение.Значение);
		КонецЦикла;
		
		НоваяСтрока = НаборЗаписей.Добавить();
		
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураАналитики, "Номенклатура, Характеристика, Спецификация, Назначение");
		Возврат НаборЗаписей;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПолноеНаименованиеКлючаАналитики(МенеджерЗаписи)

	ПолноеНаименование =
		?(ЗначениеЗаполнено(МенеджерЗаписи.Номенклатура), СокрЛП(МенеджерЗаписи.Номенклатура) + "; ", "")
		+ ?(ЗначениеЗаполнено(МенеджерЗаписи.Характеристика), СокрЛП(МенеджерЗаписи.Характеристика) + "; ", "")
		+ ?(ЗначениеЗаполнено(МенеджерЗаписи.Спецификация), СокрЛП(МенеджерЗаписи.Спецификация) + "; ", "")
		+ ?(ЗначениеЗаполнено(МенеджерЗаписи.Назначение), СокрЛП(МенеджерЗаписи.Назначение) + "; ", "");
	
	ПустоеНаименование = НСтр("ru = '<Запись с пустыми ключами>'");
	ПолноеНаименование = ?(ЗначениеЗаполнено(ПолноеНаименование), ПолноеНаименование, ПустоеНаименование);
	
	Возврат ПолноеНаименование;

КонецФункции

#КонецОбласти

#Область ЗаполнениеКлючейАналитикиВКоллекции

Функция ТекстЗначенияКлючейАналитикиВКоллекции(ИменаПолей)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	Коллекция.НомерСтроки - 1 КАК Индекс,
		|	&ПолеАналитика КАК АналитикаУчетаПартийПроизводства,
		|	&ПолеНоменклатура КАК Номенклатура,
		|	&ПолеХарактеристика КАК Характеристика,
		|	&ПолеСпецификация КАК Спецификация,
		|	&ПолеНазначение КАК Назначение
		|ПОМЕСТИТЬ Коллекция
		|ИЗ
		|	&Коллекция КАК Коллекция
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура,
		|	Характеристика,
		|	Спецификация,
		|	Назначение
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Коллекция.Индекс,
		|	Аналитика.КлючАналитики КАК АналитикаУчетаПартийПроизводства,
		|	Коллекция.Номенклатура,
		|	Коллекция.Характеристика,
		|	Коллекция.Спецификация,
		|	Коллекция.Назначение
		|ПОМЕСТИТЬ втАналитики
		|ИЗ
		|	Коллекция КАК Коллекция
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартийПроизводства КАК Аналитика
		|		ПО (Аналитика.Номенклатура = Коллекция.Номенклатура)
		|			И (Аналитика.Характеристика = Коллекция.Характеристика)
		|			И (Аналитика.Спецификация = Коллекция.Спецификация)
		|			И (Аналитика.Назначение = Коллекция.Назначение)
		|ГДЕ
		|	Аналитика.КлючАналитики ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Коллекция.Индекс,
		|	Аналитика.КлючАналитики,
		|	Коллекция.Номенклатура,
		|	Коллекция.Характеристика,
		|	Коллекция.Спецификация,
		|	Коллекция.Назначение
		|ИЗ
		|	Коллекция КАК Коллекция
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартийПроизводства КАК Аналитика
		|		ПО (Аналитика.Номенклатура = Коллекция.Номенклатура)
		|			И (Аналитика.Характеристика = Коллекция.Характеристика)
		|			И (Аналитика.Спецификация = Коллекция.Спецификация)
		|			И (Аналитика.Назначение = Коллекция.Назначение)
		|ГДЕ
		|	НЕ Аналитика.КлючАналитики = Коллекция.АналитикаУчетаПартийПроизводства
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Коллекция.Индекс,
		|	Аналитика.КлючАналитики,
		|	Коллекция.Номенклатура,
		|	Коллекция.Характеристика,
		|	Коллекция.Спецификация,
		|	Коллекция.Назначение
		|ИЗ
		|	Коллекция КАК Коллекция
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартийПроизводства КАК Аналитика
		|		ПО (Аналитика.Номенклатура = Коллекция.Номенклатура)
		|			И (Аналитика.Характеристика = Коллекция.Характеристика)
		|			И (Аналитика.Спецификация = Коллекция.Спецификация)
		|			И (Аналитика.Назначение = Коллекция.Назначение)
		|ГДЕ
		|	Аналитика.КлючАналитики = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартийПроизводства.ПустаяСсылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втАналитики.Индекс,
		|	втАналитики.АналитикаУчетаПартийПроизводства,
		|	втАналитики.Номенклатура,
		|	втАналитики.Характеристика,
		|	втАналитики.Спецификация,
		|	втАналитики.Назначение
		|ИЗ
		|	втАналитики КАК втАналитики
		|
		|СГРУППИРОВАТЬ ПО
		|	втАналитики.Индекс,
		|	втАналитики.Спецификация,
		|	втАналитики.АналитикаУчетаПартийПроизводства,
		|	втАналитики.Характеристика,
		|	втАналитики.Назначение,
		|	втАналитики.Номенклатура";
	
	// заменим в тексте запроса подставляемые поля из структуры ИменаПолей
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПолеАналитика", "Коллекция." + ИменаПолей.АналитикаУчетаПартийПроизводства);
	
	// Поля могут быть не заданы
	
	ПолеУказывается = ИменаПолей.Свойство("Номенклатура") И ЗначениеЗаполнено(ИменаПолей.Номенклатура);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПолеНоменклатура",
								?(ПолеУказывается,
									"Коллекция." + ИменаПолей.Номенклатура,
									"ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)"));
	
	ПолеУказывается = ИменаПолей.Свойство("Характеристика") И ЗначениеЗаполнено(ИменаПолей.Характеристика);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПолеХарактеристика",
								?(ПолеУказывается,
									"Коллекция." + ИменаПолей.Характеристика,
									"ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)"));
	
	ПолеУказывается = ИменаПолей.Свойство("Спецификация") И ЗначениеЗаполнено(ИменаПолей.Спецификация);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПолеСпецификация",
								?(ПолеУказывается,
									"Коллекция." + ИменаПолей.Спецификация,
									"ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)"));
	
	ПолеУказывается = ИменаПолей.Свойство("Назначение") И ЗначениеЗаполнено(ИменаПолей.Назначение);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ПолеНазначение",
								?(ПолеУказывается,
									"Коллекция." + ИменаПолей.Назначение,
									"ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)"));
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли